<?php
$intervalmins = INTERVAL_SECONDS; // Added By HJ On 13-03-2020 Which is Defined In configuration_variables.php
$PHOTO_UPLOAD_SERVICE_ENABLE = "Yes";
$host_arr = array();
$host_arr = explode(".", $_SERVER["HTTP_HOST"]);
$host_system = $host_arr[0];
require_once($tconfig["tpanel_path"] . "send_invoice_receipt.php");
require_once($tconfig["tpanel_path"] . "send_invoice_receipt_multi.php");
if ($MODULES_OBJ->isEnableBiddingServices()) {
    require_once($tconfig["tpanel_path"] . "send_bidding_service_receipt.php");
}
if ($host_system == "beautician") {
    $PHOTO_UPLOAD_SERVICE_ENABLE = "Yes";
}
if ($host_system == "tutors") {
    $PHOTO_UPLOAD_SERVICE_ENABLE = "No";
}
$uuid = "fg5k3i7i7l5ghgk1jcv43w0j41";
if (isset($_REQUEST['APP_TYPE']) && $_REQUEST['APP_TYPE'] != "") {
    $APP_TYPE = $_REQUEST['APP_TYPE'];
}

// $REQUEST_DATA_DEBUG = 'No';
if (!empty($REQUEST_DATA_DEBUG) && $REQUEST_DATA_DEBUG == 'Yes') {
    $Data_request['tType'] = $type;
    $Data_request['tRequestParam'] = http_build_query($_REQUEST);
    $request_data_debug_id = $obj->MySQLQueryPerform('request_data_debug', $Data_request, 'insert');
}
/* creating objects */
$thumb = new thumbnail;
/* Get variables */
/* Paypal supported Currency Codes */
$currency_supported_paypal = array('AUD', 'BRL', 'CAD', 'CZK', 'DKK', 'EUR', 'HKD', 'HUF', 'ILS', 'JPY', 'MYR', 'MXN', 'TWD', 'NZD', 'NOK', 'PHP', 'PLN', 'GBP', 'RUB', 'SGD', 'SEK', 'CHF', 'THB', 'TRY', 'USD');
$demo_site_msg = "Edit / Delete Record Feature has been disabled on the Demo Application. This feature will be enabled on the main script we will provide you.";
if ($type == '') {
    $type = isset($_REQUEST['function']) ? trim($_REQUEST['function']) : '';
}
$lang_label = array();
$lang_code = '';
$GeneralDeviceType = isset($_REQUEST['GeneralDeviceType']) ? trim($_REQUEST['GeneralDeviceType']) : '';
if ($_SERVER["HTTP_HOST"] == "192.168.1.131" || $_SERVER["HTTP_HOST"] == "www.mobileappsdemo.com" || $_SERVER["HTTP_HOST"] == "192.168.1.141") {
    if ($APPSTORE_MODE_IOS == "Review" /* && $GeneralDeviceType == "Ios" */) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "Configuration name 'APPSTORE_MODE_IOS' must be set to Development mode for 131 and MobileProjectsDemo";
        setDataResponse($returnArr);
    }
}

/* To Check App Version */
$appVersion = isset($_REQUEST['AppVersion']) ? trim($_REQUEST['AppVersion']) : '';
if(empty($appVersion)) {
    $appVersion = isset($_REQUEST['GeneralAppVersion']) ? trim($_REQUEST['GeneralAppVersion']) : '';
}
$Platform = isset($_REQUEST['Platform']) ? trim($_REQUEST['Platform']) : '';
if(empty($Platform)) {
    $Platform = isset($_REQUEST['GeneralDeviceType']) ? trim($_REQUEST['GeneralDeviceType']) : '';
}
$vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
$vUserDeviceCountry = isset($_REQUEST["vUserDeviceCountry"]) ? $_REQUEST["vUserDeviceCountry"] : '';
// for hotel web
$isFromHotelPanel = isset($_REQUEST["isFromHotelPanel"]) ? $_REQUEST["isFromHotelPanel"] : 'No';
if ($appVersion != "") {
    if(strtoupper($MAINTENANCE_APPS) == "YES") {
        $returnArr['Action'] = "0";
        $returnArr['RESTRICT_APP'] = "Yes";
        $returnArr['isAppMaintenance'] = "Yes";
        $returnArr['message'] = "LBL_MAINTENANCE_CONTENT_MSG";
        $returnArr['message_title'] = "LBL_MAINTENANCE_HEADER_MSG";
        setDataResponse($returnArr);
    }

    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    if ($UserType == "Passenger") {
        $newAppVersion = strtoupper($Platform) == "IOS" ? $PASSENGER_IOS_APP_VERSION : $PASSENGER_ANDROID_APP_VERSION;
        $HMS_DEVICE = isset($_REQUEST["HMS_DEVICE"]) ? $_REQUEST["HMS_DEVICE"] : 'No';
        $HUAWEI_DEVICE = isset($_REQUEST["HUAWEI_DEVICE"]) ? $_REQUEST["HUAWEI_DEVICE"] : 'No';
        if(strtoupper($HMS_DEVICE) == "YES" || strtoupper($HUAWEI_DEVICE) == "YES") {
            $newAppVersion = $PASSENGER_HMS_APP_VERSION;
        }
    } else if (strtolower($UserType) == "hotel" || strtolower($UserType) == "kiosk") {
        $newAppVersion = strtoupper($Platform) == "IOS" ? $KIOSK_IOS_APP_VERSION : $KIOSK_ANDROID_APP_VERSION;
    } else if (strtolower($UserType) == "tracking") {
        $newAppVersion = strtoupper($Platform) == "IOS" ? $TRACKING_IOS_APP_VERSION : $TRACKING_ANDROID_APP_VERSION;
    } else {
        $newAppVersion = strtoupper($Platform) == "IOS" ? $DRIVER_IOS_APP_VERSION : $DRIVER_ANDROID_APP_VERSION;
    }
    $appVersion = round($appVersion, 2);
    if ($newAppVersion != $appVersion && $newAppVersion > $appVersion) {
        $returnArr['Action'] = "0";
        $returnArr['RESTRICT_APP'] = "Yes";
        $returnArr['isAppUpdate'] = "Yes";
        $returnArr['message'] = "LBL_NEW_UPDATE_MSG";
        $returnArr['message_title'] = "LBL_NEW_UPDATE_TITLE";
        setDataResponse($returnArr);
    }
}
/* To Check App Version End */

/* general fucntions */
if ($type != "generalConfigData" && $type != "signIn" && $type != "isUserExist" && $type != "signup" && $type != "LoginWithFB" && $type != "sendVerificationSMS" && $type != "countryList" && $type != "changelanguagelabel" && $type != "requestResetPassword" && $type != "UpdateLanguageLabelsValue" && $type != "staticPage" && $type != "sendContactQuery" && $type != "generateReviewModeLogin" && $type != "signup_kiosk_passanger" && $type != "getAdvertisementBanners" && $type != "insertBannereImpressionCount" && $type != "getNewsNotification" && $type != "getNearestFlyStations_booking" && $type != "getNearestFlyStationsSectionBooking" && $type != "getNearestFlyStations" && $type != "getFAQ" && $type != "getUserLanguagesAsPerServiceType" && $type != "uploadcompanydocument" && $type != "getAdvertisementBanners" && $type != "insertBannereImpressionCount" && $type != "getNewsNotification" && $type != "CheckPrescriptionRequired" && $type != "getPrescriptionImages" && $type != "CheckAppTerminate" && isAllowFetchAPIDetails() == false && $type != "LoginWithAppleID" && $type != "sendAuthOtp" && $type != "AuthenticateMember" && $type != "CheckMemberAccount" && $type != "loadStaticInfo" && $type != "loadStaticPages" && $type != "SetFaqs" && $type != "SetCancelReasons" && $type != "loadAppImages") {
    $tSessionId = isset($_REQUEST['tSessionId']) ? trim($_REQUEST['tSessionId']) : '';
    $GeneralMemberId = isset($_REQUEST['GeneralMemberId']) ? trim($_REQUEST['GeneralMemberId']) : '';
    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? trim($_REQUEST['GeneralUserType']) : '';
    if ($tSessionId == "" || $GeneralMemberId == "" || $GeneralUserType == "") {
        $returnArr['Action'] = "0";
        $returnArr['RESTRICT_APP'] = "Yes";
        $returnArr['isSessionExpired'] = "Yes";
        $returnArr['message'] = "LBL_SESSION_TIME_OUT";
        $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
        setDataResponse($returnArr);
    } else {
        if (strtolower($GeneralUserType) == "hotel" || strtolower($GeneralUserType) == "kiosk") {
            $tableName = "hotel";
            $userData = get_value($tableName, "iHotelId as iMemberId,tSessionId", "iHotelId", $GeneralMemberId);
        } else {
            $tableName = "register_user";
            $tblField = "iUserId";
            if (strtoupper($GeneralUserType) == "DRIVER") {
                $tableName = "register_driver";
                $tblField = "iDriverId";
            }
            if(strtoupper($GeneralUserType) != "TRACKING") {
                $userData = get_value($tableName, $GeneralUserType == "Driver" ? "*,iDriverId as iMemberId" : "*,iUserId as iMemberId", $tblField, $GeneralMemberId);    
            } else {
                $userData = get_value("track_service_users", "*, iTrackServiceUserId as iMemberId", "iTrackServiceUserId", $GeneralMemberId);
            }
        }
        $userDetailsArr[$tableName . "_" . $GeneralMemberId] = $userData;
        if ($userData[0]['iMemberId'] != $GeneralMemberId || $userData[0]['tSessionId'] != $tSessionId) {
            $returnArr['Action'] = "0";
            $returnArr['RESTRICT_APP'] = "Yes";
            $returnArr['isSessionExpired'] = "Yes";
            $returnArr['message'] = "LBL_SESSION_TIME_OUT";
            $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
            setDataResponse($returnArr);
        } elseif (strtolower($userData[0]['eStatus']) != "active" && strtoupper($GeneralUserType) == "PASSENGER") {
            $returnArr['Action'] = "0";
            $returnArr['RESTRICT_APP'] = "Yes";
            $returnArr['message'] = "LBL_ACC_DELETE_TXT";
            $returnArr['message_title'] = "LBL_ACC_DELETE_TITLE";
            if ($userData[0]['eStatus'] != "Deleted") {
                $returnArr['isAccountInactive'] = "Yes";
                $returnArr['message'] = "LBL_CONTACT_US_STATUS_NOTACTIVE_PASSENGER";
                if(SITE_TYPE == "Demo") {
                    $returnArr['message'] = "Your Account has been Inactivated. Please contact the Sales Team to re-activate it and to continue testing the System.";
                }
                $returnArr['message_title'] = "LBL_ACC_INACTIVE_TITLE";
            } else {
                $returnArr['isAccountDeleted'] = "Yes";
            }
            setDataResponse($returnArr);
        }
    }
}

 
/* If no type found */
if ($type == '') {
    $result['result'] = 0;
    $result['message'] = 'Required parameter missing.';
    setDataResponse($result);
}
// new added

include_once('include/include_common_function.php');

if (strtoupper(PACKAGE_TYPE) != "STANDARD") {
    include_once('include/include_webservice_enterprisefeatures.php'); // other 5 feature
}
if (strtoupper(PACKAGE_TYPE) == "SHARK") {
    include_once('include/include_webservice_sharkfeatures.php'); // for 22 feature
}
if (strtoupper(APP_TYPE) == "RIDE" || strtoupper(APP_TYPE) == "RIDE-DELIVERY" || strtoupper(APP_TYPE) == "RIDE-DELIVERY-UBERX") {
    include_once('include/ride/include_webservice_ride.php');
}
if (strtoupper(APP_TYPE) == "UBERX" || strtoupper(APP_TYPE) == "RIDE-DELIVERY-UBERX") {
    //$isAvailable = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
    $isAvailable = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
    if ($isAvailable == "Yes") {
        include_once('include/uberx/include_webservice_uberx.php');
    }
}
if (strtoupper(APP_TYPE) == "DELIVERY" || strtoupper(APP_TYPE) == "RIDE-DELIVERY" || strtoupper(APP_TYPE) == "RIDE-DELIVERY-UBERX") {
    include_once('include/delivery/include_webservice_delivery.php');
}
if ($MODULES_OBJ->checkFavDriverModule()) {
    include_once('include/features/include_fav_driver.php');
}
if ($MODULES_OBJ->checkStopOverPointModule()) {
    include_once('include/features/include_stop_over_point.php');
}
if ($MODULES_OBJ->checkDriverDestinationModule()) {
    include_once('include/features/include_destinations_driver.php');
}
/* For Gojek-gopay added by SP start */
if ($MODULES_OBJ->isGojekGopayModuleAvailable()) {
    include_once('include/features/include_gojek_gopay.php');
}
/* For Gojek-gopay added by SP end */
/* For DriverSubscription added by SP start */
if ($MODULES_OBJ->isDriverSubscriptionModuleAvailable()) {
    include_once('include/features/include_driver_subscription.php');
}
/* For DriverSubscription added by SP end */
/* For Donation  start  */
if ($MODULES_OBJ->isDonationFeatureAvailable()) {
    include_once('include/features/include_donation.php');
}
/* For Donation  start  */
/* added by SP for fly stations on 13-08-2019 start */
if ($MODULES_OBJ->isAirFlightModuleAvailable()) {
    include_once('include/features/include_fly_stations.php');
}
/* added by SP for fly stations on 13-08-2019 end */
/* added by PM for Auto credit wallet driver on 25-01-2020 start */
if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()) {
    include_once('include/features/include_auto_credit_driver.php');
}
/* added by PM for Auto credit wallet driver on 25-01-2020 end */
/* Added By HJ On 29-09-2020 For Fare Time and Distance Base On Fare Strategy Model Start */
if ($MODULES_OBJ->isEnableRideFareModelStrategy()) {
    include_once('include/features/include_fare_strategy_model.php');
}
/* Added By HJ On 29-09-2020 For Fare Time and Distance Base On Fare Strategy Model End */

include_once('include/include_webservice_general.php');
/* -------------- For Luggage Lable default and as per user's Prefered language ----------------------- */
######################################## General types For all App Type ######################################
if ($type == 'language_label') {
    $lCode = isset($_REQUEST['vCode']) ? clean(strtoupper($_REQUEST['vCode'])) : ''; // User's prefered language
    /* find default language of website set by admin */
    if ($lCode == '') {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $lCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
        //$default_label = $obj->MySQLSelect("SELECT  `vCode` FROM  `language_master` WHERE eStatus = 'Active' AND `eDefault` = 'Yes' ");
        //$lCode = (isset($default_label[0]['vCode']) && $default_label[0]['vCode']) ? $default_label[0]['vCode'] : 'EN';
    }
    $all_label = $obj->MySQLSelect("SELECT  `vLabel` , `vValue`  FROM  `language_label`  WHERE  `vCode` = '" . $lCode . "' ");
    $x = array();
    for ($i = 0; $i < count($all_label); $i++) {
        $vLabel = $all_label[$i]['vLabel'];
        $vValue = $all_label[$i]['vValue'];
        $x[$vLabel] = $vValue;
    }
    $x['vCode'] = $lCode; // to check in which languge code it is loading
    setDataResponse($x);
}
##########################################################################
if ($type == 'generalConfigData') {
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $GeneralMemberId = isset($_REQUEST['GeneralMemberId']) ? trim($_REQUEST['GeneralMemberId']) : '';
    $vLang = isset($_REQUEST["vLang"]) ? $_REQUEST["vLang"] : '';
    $vCurrency = isset($_REQUEST["vCurrency"]) ? $_REQUEST["vCurrency"] : '';
    $GeneralAppVersion = isset($_REQUEST['GeneralAppVersion']) ? $_REQUEST['GeneralAppVersion'] : "";
    validateApiRequest();
    $check_label = $default_label = $defLangValues = array();
    if (count($Data_ALL_langArr) > 0) {
        for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
            if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE") {
                $check_label[] = $Data_ALL_langArr[$g];
                $defLangValues[] = $Data_ALL_langArr[$g];
            }
            if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE" && strtoupper($Data_ALL_langArr[$g]['eDefault']) == "YES") {
                $default_label[] = $Data_ALL_langArr[$g];
            }
        }
    }
    if ($vLang != '') {
        $vLangCode = $defaultLangCode = $vLang;
        if (count($check_label) > 0) {
            //Data Found
        } else {
            $check_label = $obj->MySQLSelect("SELECT `eDefault`,`vCode` FROM  `language_master` WHERE eStatus = 'Active'");
        }
        for ($k = 0; $k < count($check_label); $k++) {
            if (strtoupper($vLang) == strtoupper($check_label[$k]['vCode'])) {
                $vLangCode = $vLang = $check_label[$k]['vCode'];
            }
            if (strtoupper($check_label[$k]['eDefault']) == "YES") {
                //$defaultLangCode = $vLang = $check_label[$k]['vCode'];
                $defaultLangCode = $check_label[$k]['vCode'];
            }
        }
    } else {
        if (count($default_label) > 0) {
            //Data Found here
        } else {
            $default_label = $obj->MySQLSelect("SELECT  `vCode` FROM  `language_master` WHERE eStatus = 'Active' AND `eDefault` = 'Yes'");
        }
        $vLang = "EN";
        if (count($default_label) > 0) {
            $vLang = $default_label[0]['vCode'];
        }
    }

    if(strtoupper($UserType) != "TRACKING") {
        $storeCatArr = json_decode(serviceCategories, true);
        //it is done bc when in table in desc field insert like [] then null value is shown so app crash so put the following code
        foreach ($storeCatArr as $key => $value) {
            if (is_null($value['tDescription']) || $value['tDescription'] == '' || $value['tDescription'] == 'null' || empty($value['tDescription'])) {
                $storeCatArr[$key]['tDescription'] = '';
            }
            $eShowTerms = "No";
            $eProofUpload = "No";
            $tProofNote = "";
            $scsql = "select iServiceId,eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $vLang . "')) as tProofNote from service_categories WHERE iServiceId = " . $storeCatArr[$key]['iServiceId'];
            $scsqlData = $obj->MySQLSelect($scsql);
            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                $eShowTerms = $scsqlData[0]['eShowTerms'];
            }
            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                $eProofUpload = $scsqlData[0]['eProofUpload'];
                if (is_null($scsqlData[0]['tProofNote']) || $scsqlData[0]['tProofNote'] == "null") {
                    $scsqlData[0]['tProofNote'] = "";
                }
                $tProofNote = $scsqlData[0]['tProofNote'];
            }
            $storeCatArr[$key]['eShowTerms'] = ($eShowTerms != "") ? $eShowTerms : "";
            $storeCatArr[$key]['eProofUpload'] = ($eProofUpload != "") ? $eProofUpload : "";
            $storeCatArr[$key]['tProofNote'] = (!empty($tProofNote) && $tProofNote != NULL) ? $tProofNote : "";
        }
        $iserviceidstore = 0;
        if (count($storeCatArr) == 1) $iserviceidstore = $storeCatArr[0]['iServiceId'];
        $systemStoreEnable = $MODULES_OBJ->isSingleStoreSelection();
        if ($systemStoreEnable > 0) {
            for ($g = 0; $g < count($storeCatArr); $g++) {
                $storeData = getStoreDataForSystemStoreSelection($storeCatArr[$g]['iServiceId']);
                $iCompanyId = $storeData['iCompanyId'];
                $storeData['ispriceshow'] = $storeCatArr[$g]['iServiceId'];
                $storeCatArr[$g]['iCompanyId'] = $iCompanyId;
                $storeCatArr[$g]['STORE_DATA'] = $storeData;
                $storeCatArr[$g]['STORE_ID'] = $iCompanyId;
            }
            $companyData = getStoreDataForSystemStoreSelection($iserviceidstore);
            if (!empty($companyData[0]['iCompanyId'])) {
                $DataArr['STORE_ID'] = $companyData[0]['iCompanyId'];
            } else {
                $DataArr['STORE_ID'] = $companyData['iCompanyId'];
            }
        }
        $DataArr['ServiceCategories'] = $storeCatArr;
    }
    
    //Added By HJ On 16-07-2019 For Check Multiple Country Exists Or Not Start
    //$getCountryData = $obj->MySQLSelect("SELECT iCountryId FROM country WHERE eStatus='Active'"); // Commented By HJ On 04-06-2020 For Optimized Query
    // Added By HJ On 04-06-2020 For Optimized Country Table Query Start
    if (count($country_data_retrieve) > 0) {
        $getCountryData = array();
        for ($h = 0; $h < count($country_data_retrieve); $h++) {
            if (strtoupper($country_data_retrieve[$h]['eStatus']) == "ACTIVE") {
                $getCountryData[] = $country_data_retrieve[$h]['iCountryId'];
            }
        }
    } else {
        $getCountryData = $obj->MySQLSelect("SELECT iCountryId FROM country WHERE eStatus='Active'");
    }
    // Added By HJ On 04-06-2020 For Optimized Country Table Query End
    $multiCountry = "No";
    if (count($getCountryData) > 1) {
        $multiCountry = "Yes";
    }
    $DataArr['showCountryList'] = $multiCountry;

    //Added By HJ On 04-08-2020 For Store language_label Data into Cache Start
    $langLabelApcKey = md5($cacheKeysArr['language_label_global_config_'] . $iServiceId . "_" . $vLang);
    $getLabelCacheData = $oCache->getData($langLabelApcKey);
    if (!empty($getLabelCacheData) && count($getLabelCacheData) > 0) {
        $languageLabelsArr = $getLabelCacheData;
    } else {
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $setLabelCacheData = $oCache->setData($langLabelApcKey, $languageLabelsArr);
    }
    //Added By HJ On 04-08-2020 For Store language_label Data into Cache End
    $DataArr['LanguageLabels'] = $languageLabelsArr;
    $DataArr['Action'] = "1";
    if (count($defLangValues) > 0) {
        //Data Found
    } else {
        $defLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle_EN, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active'  ORDER BY iDispOrder ASC");
    }
    $DataArr['LIST_LANGUAGES'] = $defLangValues;
    for ($i = 0; $i < count($defLangValues); $i++) {
        if ($defLangValues[$i]['eDefault'] == "Yes") {
            $DataArr['DefaultLanguageValues'] = ($defLangValues[$i] != "") ? $defLangValues[$i] : "";
        }

        if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){
         $DataArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";  // $DataArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
        } else {
            $DataArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
        }

        $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
        $DataArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $DataArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
    }
    if ($vLang != "") {
        if (count($Data_ALL_langArr) > 0) {
            $requireLangValues = array();
            for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
                if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE" && strtoupper($Data_ALL_langArr[$g]['vCode']) == strtoupper($vLang)) {
                    $requireLangValues[] = $Data_ALL_langArr[$g];
                }
            }
        } else {
            $requireLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE `vCode` = '" . $vLang . "'");
        }
        $DataArr['DefaultLanguageValues'] = ($requireLangValues[0] != "") ? $requireLangValues[0] : "";
    }
    
    if(strtoupper($UserType) != "TRACKING") {
        //Added By HJ On 09-07-2020 For Optimize currency Table Query Start
        if (count($Data_ALL_currency_Arr) > 0) {
            $defCurrencyValues = array();
            for ($c = 0; $c < count($Data_ALL_currency_Arr); $c++) {
                if (strtoupper($Data_ALL_currency_Arr[$c]['eStatus']) == "ACTIVE") {
                    $defCurrencyValues[] = $Data_ALL_currency_Arr[$c];
                }
            }
        } else {
            $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM `currency` WHERE  `eStatus` = 'Active' ORDER BY `iDispOrder` ASC");
        }
        //Added By HJ On 09-07-2020 For Optimize currency Table Query End
        //$defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
        $DataArr['LIST_CURRENCY'] = $defCurrencyValues;
        for ($i = 0; $i < count($defCurrencyValues); $i++) {
            if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                $DataArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                $DataArr['DEFAULT_CURRENCY_TITLE'] = $defCurrencyValues[$i]['vName']; //added by SP bc in live app dhruvin's app crash so given by KS for temporary put until new app will be released..
            }
            
            $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
            $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
            $DataArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
            $DataArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
        }
        $DataArr['UPDATE_TO_DEFAULT'] = 'No';
        //$vCurrency = "USD"; //added by SP bc in live app dhruvin's app crash,UPDATE_TO_DEFAULT would be yes and bc of this it will be set to no.
        if (!empty($vCurrency)) {
            //Added By HJ On 09-07-2020 For Optimize currency Table Query Start
            if (isset($currencyAssociateArr[$vCurrency])) {
                $check_currency = array();
                $check_currency[]['iCurrencyId'] = $currencyAssociateArr[$vCurrency]['iCurrencyId'];
            } else {
                $check_currency = $obj->MySQLSelect("SELECT iCurrencyId FROM  `currency` WHERE eStatus = 'Active' AND `vName` = '" . $vCurrency . "'");
            }
            //Added By HJ On 09-07-2020 For Optimize currency Table Query End
            if (count($check_currency) == 0) {
                $DataArr['UPDATE_TO_DEFAULT'] = 'Yes';
            }
        }
        if (empty($vCurrency)) {
            $DataArr['UPDATE_TO_DEFAULT'] = 'Yes';
        }

        //Added By HJ On 16-07-2019 For Check Multiple Country Exists Or Not End
        $DataArr['GOOGLE_ANALYTICS'] = $DataArr['FACEBOOK_IFRAME'] = "";
        if ($UserType == "Passenger") {
            $DataArr['LINK_FORGET_PASS_PAGE_PASSENGER'] = $tconfig["tsite_url"] . $LINK_FORGET_PASS_PAGE_PASSENGER;
            $DataArr['CONFIG_CLIENT_ID'] = $CONFIG_CLIENT_ID;
            $DataArr['FACEBOOK_LOGIN'] = $PASSENGER_FACEBOOK_LOGIN;
            $DataArr['GOOGLE_LOGIN'] = $PASSENGER_GOOGLE_LOGIN;
            $DataArr['TWITTER_LOGIN'] = $PASSENGER_TWITTER_LOGIN;
            $DataArr['LINKEDIN_LOGIN'] = $PASSENGER_LINKEDIN_LOGIN;
            $DataArr['APPLE_LOGIN'] = $ENABLE_APPLE_LOGIN_FOR_USER;
        } else {
            $DataArr['LINK_FORGET_PASS_PAGE_DRIVER'] = $tconfig["tsite_url"] . $LINK_FORGET_PASS_PAGE_DRIVER;
            $DataArr['LINK_SIGN_UP_PAGE_DRIVER'] = $tconfig["tsite_url"] . $LINK_SIGN_UP_PAGE_DRIVER;
            $DataArr['FACEBOOK_LOGIN'] = $DRIVER_FACEBOOK_LOGIN;
            $DataArr['GOOGLE_LOGIN'] = $DRIVER_GOOGLE_LOGIN;
            $DataArr['TWITTER_LOGIN'] = $DRIVER_TWITTER_LOGIN;
            $DataArr['LINKEDIN_LOGIN'] = $DRIVER_LINKEDIN_LOGIN;
            $DataArr['APPLE_LOGIN'] = $ENABLE_APPLE_LOGIN_FOR_PROVIDER;
        }

        //Added By HJ On 16-07-2019 For Check Empty and # Value Of Configuration Start
        if (isset($DataArr['LIVE_CHAT_LICENCE_NUMBER']) && ($DataArr['LIVE_CHAT_LICENCE_NUMBER'] == "" || strpos($DataArr['LIVE_CHAT_LICENCE_NUMBER'], '#') !== false)) {
            $DataArr['ENABLE_LIVE_CHAT'] = "No";
        }

        $DataArr['DELIVERALL'] = DELIVERALL;
        $DataArr['ONLYDELIVERALL'] = ONLYDELIVERALL;
        //if($iserviceidstore > 0){
        //    $DataArr['ONLYDELIVERALL'] = "Yes";
        //}
        $DataArr['ENABLE_MULTI_DELIVERY'] = ENABLE_MULTI_DELIVERY;
        $DataArr['ENABLE_CATEGORY_WISE_STORES'] = ($MODULES_OBJ->isStoreClassificationEnable() == 1) ? "Yes" : "No";
        $DataArr = getCustomeNotificationSound($DataArr); // Added By HJ On 06-08-2019 For Get Custome Sound Notification File Name
        $DataArr['ENABLE_ADD_PROVIDER_FROM_STORE'] = $MODULES_OBJ->isStorePersonalDriverAvailable() ? 'Yes' : 'No';
        $DataArr['CHECK_SYSTEM_STORE_SELECTION'] = ($systemStoreEnable > 0) ? "Yes" : "No";

         /*added by SP on 18-09-2020 */
        $DataArr['IS_RIDE_MODULE_AVAIL'] = ($MODULES_OBJ->isRideFeatureAvailable() == 1) ? "Yes" : "No";
        $DataArr['IS_DELIVERY_MODULE_AVAIL'] = ($MODULES_OBJ->isDeliveryFeatureAvailable() == 1) ? "Yes" : "No";
        $DataArr['IS_UFX_MODULE_AVAIL'] = ($MODULES_OBJ->isUberXFeatureAvailable() == 1) ? "Yes" : "No";
        $DataArr['IS_DELIVERALL_MODULE_AVAIL'] = ($MODULES_OBJ->isDeliverAllFeatureAvailable() == 1) ? "Yes" : "No";
        $DataArr['RIDE_ENABLED'] = RIDE_ENABLED;
        $DataArr['DELIVERY_ENABLED'] = DELIVERY_ENABLED;
        $DataArr['UFX_ENABLED'] = UFX_ENABLED;
        $DataArr['DELIVERALL_ENABLED'] = DELIVERALL_ENABLED;
        $DataArr['GENIE_ENABLED'] = GENIE_ENABLED;
        $DataArr['RUNNER_ENABLED'] = RUNNER_ENABLED;
        $DataArr['BIDDING_ENABLED'] = BIDDING_ENABLED;
        $DataArr['VC_ENABLED'] = VC_ENABLED;
        $DataArr['MED_UFX_ENABLED'] = MED_UFX_ENABLED;
        $DataArr['RENT_ITEM_ENABLED'] = RENT_ITEM_ENABLED;
        $DataArr['RENT_ESTATE_ENABLED'] = RENT_ESTATE_ENABLED;
        $DataArr['RENT_CARS_ENABLED'] = RENT_CARS_ENABLED;
        $DataArr['NEARBY_ENABLED'] = NEARBY_ENABLED;
        $DataArr['TRACK_SERVICE_ENABLED'] = TRACK_SERVICE_ENABLED;
        $DataArr['RIDE_SHARE_ENABLED'] = RIDE_SHARE_ENABLED;
        $DataArr['TRACK_ANY_SERVICE_ENABLED'] = TRACK_ANY_SERVICE_ENABLED;        

        $DataArr['isSmartLoginEnable'] = $MODULES_OBJ->isEnableSmartLogin() ? "Yes" : "No";
        $DataArr['isOtherSignInOptionsAvailable'] = "No";
        if ($MODULES_OBJ->isEnableSmartLogin() || $DataArr['FACEBOOK_LOGIN'] == "Yes" || $DataArr['GOOGLE_LOGIN'] == "Yes" || $DataArr['LINKEDIN_LOGIN'] == "Yes") {
            $DataArr['isOtherSignInOptionsAvailable'] = "Yes";
        }
    }

    $DataArr = array_merge($DataArr, $generalSystemConfigDataArr); // Added By HJ On 18-03-2020 For Optimized Function
    $DataArr['SERVER_MAINTENANCE_ENABLE'] = $MAINTENANCE_APPS;
    
    if (isset($DataArr['AUDIO_CALLING_METHOD']) && strtoupper($DataArr['AUDIO_CALLING_METHOD']) == "SINCH") {
        if (isset($DataArr['SINCH_APP_ENVIRONMENT_HOST']) && ($DataArr['SINCH_APP_ENVIRONMENT_HOST'] == "" || strpos($DataArr['SINCH_APP_ENVIRONMENT_HOST'], '#') !== false)) {
            $DataArr['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
        }
        if (isset($DataArr['SINCH_APP_KEY']) && ($DataArr['SINCH_APP_KEY'] == "" || strpos($DataArr['SINCH_APP_KEY'], '#') !== false)) {
            $DataArr['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
        }
        if (isset($DataArr['SINCH_APP_SECRET_KEY']) && ($DataArr['SINCH_APP_SECRET_KEY'] == "" || strpos($DataArr['SINCH_APP_SECRET_KEY'], '#') !== false)) {
            $DataArr['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
        }
    }

    if(strtoupper($UserType) == "TRACKING") {
        $DataArr['REFERRAL_SCHEME_ENABLE'] = 'No';
        $DataArr['MULTI_LEVEL_REFERRAL_SCHEME_ENABLE'] = 'No';
    }
    //Added By HJ On 16-07-2019 For Check Empty and # Value Of Configuration End
    $DataArr['SITE_TYPE'] = SITE_TYPE;
    $usercountrydetailbytimezone = FetchMemberCountryData($GeneralMemberId, $UserType, $vTimeZone, $vUserDeviceCountry);
    $DataArr['vDefaultCountry'] = $usercountrydetailbytimezone['vDefaultCountry'];
    $DataArr['vDefaultCountryCode'] = $usercountrydetailbytimezone['vDefaultCountryCode'];
    $DataArr['vDefaultPhoneCode'] = $usercountrydetailbytimezone['vDefaultPhoneCode'];
    //$DataArr['vRCountryImage'] = $usercountrydetailbytimezone['vRImage']; //added by SP for country image related changes on 05-08-2019
    //$DataArr['vSCountryImage'] = $usercountrydetailbytimezone['vSImage']; //added by SP for country image related changes on 05-08-2019
    $DataArr['vRCountryImage'] = $usercountrydetailbytimezone['vRImageMember']; //added by SP for country image related changes on 06-09-2019
    $DataArr['vSCountryImage'] = $usercountrydetailbytimezone['vSImageMember']; //added by SP for country image related changes on 06-09-2019
    $DataArr['vDefaultCountryImage'] = empty($DataArr['vSCountryImage']) ? $usercountrydetailbytimezone['vDefaultCountryImage'] : $DataArr['vSCountryImage']; //added by SP for country image related changes on 06-08-2019
    $DataArr['OPEN_SETTINGS_URL_SCHEMA'] = "A###p####!!!!!###p####!!!!###@@@@#######-Pr###@@@!!!!###ef####s:r##@@@@#oo###t=Se####tt###i@@@##n##@@g#s";
    $DataArr['OPEN_LOCATION_SETTINGS_URL_SCHEMA'] = "A##@@@##p#!!!!##p###-#P###!!!##r##!!!!#ef#!!!##@@##s:###@@@####ro##@@###!!!!###o###@@@#t=P####riv####!!!###ac####y&###!!!##p###a##!!!#t##h=L###O##CA#@@#TI##O#@#N";
    $DataArr['SC_CONNECT_URL'] = getSocketURL();
    $DataArr['SERVICE_CATEGORIES_ARR'] = SERVICE_CATEGORIES_ARR;
    /* added by SP on 10-08-2020 for page active or not */
    $getPageData = $obj->MySQLSelect("SELECT iPageId,eStatus FROM pages WHERE iPageId IN(4,33,52)");
    foreach ($getPageData as $kPage => $vPage) {
        if ($vPage['iPageId'] == 4) $pagename = "showTermsCondition";
        if ($vPage['iPageId'] == 33) $pagename = "showPrivacyPolicy";
        if ($vPage['iPageId'] == 52) $pagename = "showAboutUs";
        $DataArr[$pagename] = $vPage['eStatus'] == 'Active' ? 'Yes' : 'No';
    }
   
    // Added by HV on 04-03-2021 for App launch images
    $DataArr['APP_LAUNCH_IMAGES'] = "";
    if (!empty(getAppLaunchImages($vLang, $UserType))) {
        $DataArr['APP_LAUNCH_IMAGES'] = getAppLaunchImages($vLang, $UserType);
    }
    
    $DataArr['WEBRTC_ICE_SERVER_LIST'] = WEBRTC_ICE_SERVER_LIST;
    $DataArr['WEBRTC_SOCKET_URL'] = WEBRTC_SOCKET_URL;
    $DataArr['WEBRTC_STUN_URL'] = WEBRTC_STUN_URL;
    $DataArr['WEBRTC_TURN_URL'] = WEBRTC_TURN_URL;
    $DataArr['WEBRTC_USERNAME'] = $tconfig["tsite_webrtc_username"];
    $DataArr['WEBRTC_PASS'] = $tconfig["tsite_webrtc_pass"];

    $ADD_CARD_STATUS = strtoupper($APP_PAYMENT_METHOD) . '_ADD_CARD_ENABLE';
    $DataArr['CARD_SAVE_ENABLE'] = $$ADD_CARD_STATUS;
    setDataResponse($DataArr);
}

###########################################################################
if ($type == "signup") {
    $fbid = isset($_REQUEST["vFbId"]) ? $_REQUEST["vFbId"] : '';
    $vAppleId = isset($_REQUEST["vAppleId"]) ? $_REQUEST["vAppleId"] : '';
    $Fname = isset($_REQUEST["vFirstName"]) ? $_REQUEST["vFirstName"] : '';
    $Lname = isset($_REQUEST["vLastName"]) ? $_REQUEST["vLastName"] : '';
    $email = isset($_REQUEST["vEmail"]) ? $_REQUEST["vEmail"] : '';
    $email = strtolower($email);
    $phone_mobile = isset($_REQUEST["vPhone"]) ? $_REQUEST["vPhone"] : '';
    $password = isset($_REQUEST["vPassword"]) ? $_REQUEST["vPassword"] : '';
    $iGcmRegId = isset($_REQUEST["vDeviceToken"]) ? $_REQUEST["vDeviceToken"] : '';
    $phoneCode = isset($_REQUEST["PhoneCode"]) ? $_REQUEST["PhoneCode"] : '';
    $CountryCode = isset($_REQUEST["CountryCode"]) ? $_REQUEST["CountryCode"] : '';
    $vInviteCode = isset($_REQUEST["vInviteCode"]) ? $_REQUEST["vInviteCode"] : '';
    $deviceType = isset($_REQUEST["vDeviceType"]) ? $_REQUEST["vDeviceType"] : 'Android';
    $vCurrency = isset($_REQUEST["vCurrency"]) ? $_REQUEST["vCurrency"] : '';
    $vLang = isset($_REQUEST["vLang"]) ? $_REQUEST["vLang"] : '';
    $user_type = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $eSignUpType = isset($_REQUEST["eSignUpType"]) ? $_REQUEST["eSignUpType"] : 'Normal';
    $vFirebaseDeviceToken = isset($_REQUEST["vFirebaseDeviceToken"]) ? $_REQUEST["vFirebaseDeviceToken"] : '';
    $vImageURL = isset($_REQUEST["vImageURL"]) ? $_REQUEST["vImageURL"] : '';
    //Added By HJ On 22-10-2020 For Prevent Demo Site Validation As Per Discuss with KS sir Start
    $GeneralAppVersion = isset($_REQUEST["GeneralAppVersion"]) ? $_REQUEST["GeneralAppVersion"] : '';
    $GeneralDeviceType = isset($_REQUEST["GeneralDeviceType"]) ? $_REQUEST["GeneralDeviceType"] : '';
    $demoTypeConfig = $RESTRICT_SIGNUP_ON_DEMO_ANDROID_VERSION_DRIVER_APP;
    if ($user_type == "Passenger") {
        $demoTypeConfig = $RESTRICT_SIGNUP_ON_DEMO_ANDROID_VERSION;
    }
    if (strtoupper($GeneralDeviceType) == "IOS") {
        $demoTypeConfig = $RESTRICT_SIGNUP_ON_DEMO_IOS_VERSION_DRIVER_APP;
        if ($user_type == "Passenger") {
            $demoTypeConfig = $RESTRICT_SIGNUP_ON_DEMO_IOS_VERSION;
        }
    }
    $displayAlert = 1;
    if ($demoTypeConfig == "-1" || $demoTypeConfig == $GeneralAppVersion) {
        $displayAlert = 0;
    }
    //Added By HJ On 22-10-2020 For Prevent Demo Site Validation As Per Discuss with KS sir End
    if (SITE_TYPE == 'Demo' && $displayAlert > 0) {
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $returnArr['Action'] = "0";
        $returnArr['message'] = strip_tags($languageLabelsArr["LBL_SIGNUP_DEMO_CONTENT"]);
        setDataResponse($returnArr);
    }
    if ($email == "" && $phone_mobile == "" && $fbid == "" && $vAppleId == "") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        setDataResponse($returnArr);
    }
    if (!empty($vAppleId) && empty($email) && empty($phone_mobile)) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_APPLE_LOGIN_ERROR_MSG";
        setDataResponse($returnArr);
    }
    if (isset($Fname) && !empty($Fname)) {
        $Fname = validName($Fname);
    }
    if (isset($Lname) && !empty($Lname)) {
        $Lname = validName($Lname);
    }
    if ($vCurrency == '') {
        //Added By HJ On 24-07-2020 For Optimize currency Table Query Start
        if (!empty($vSystemDefaultCurrencyName)) {
            $vCurrency = $vSystemDefaultCurrencyName;
        } else {
            $vCurrency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        }
        //Added By HJ On 24-07-2020 For Optimize currency Table Query End
    }
    if ($vLang == '') {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    //Added By HJ On 24-07-2020 For Optimize country Table Query Start
    if (count($country_data_retrieve) > 0) {
        for ($g = 0; $g < count($country_data_retrieve); $g++) {
            if ($country_data_retrieve[$g]['vPhoneCode'] == $phoneCode) {
                $CountryData = array();
                $CountryData[] = $country_data_retrieve[$g];
            }
        }
    } else {
        $CountryData = $obj->MySQLSelect("SELECT eZeroAllowed,vCountryCode FROM `country` WHERE vPhoneCode = '" . $phoneCode . "'");
    }
    //Added By HJ On 24-07-2020 For Optimize country Table Query End
    $eZeroAllowed = $CountryData[0]['eZeroAllowed'];
    if ($eZeroAllowed == 'Yes') {
        $phone_mobile = $phone_mobile;
    } else {
        $first = substr($phone_mobile, 0, 1);
        if ($first == "0") {
            $phone_mobile = substr($phone_mobile, 1);
        }
    }
    if ($fbid != "" || $vAppleId != "") {
        if ($Lname == "" || $Lname == NULL) {
            $username = explode(" ", $Fname);
            if ($username[1] != "") {
                $Fname = $username[0];
                $Lname = $username[1];
            }
        }
    }
    if ($user_type == "Passenger") {
        $tblname = "register_user";
        $eRefType = "Rider";
        $Data_passenger['vPhoneCode'] = $phoneCode;
        $Data_passenger['vCurrencyPassenger'] = $vCurrency;
        $vImage = 'vImgName';
        $iMemberId = 'iUserId';
    } elseif ($user_type == "Tracking") {
        $tblname = "track_service_users";
        $Data_passenger['vPhoneCode'] = $phoneCode;
        $vImage = 'vImage';
        $iMemberId = 'iTrackServiceUserId';
    } else {
        $tblname = "register_driver";
        $eRefType = "Driver";
        $Data_passenger['eDestinationMode'] = 'No';
        $Data_passenger['iDestinationCount'] = 0;
        $Data_passenger['tDestinationModifiedDate'] = date('Y-m-d H:i:s');
        $Data_passenger['vCode'] = $phoneCode;
        $Data_passenger['vCurrencyDriver'] = $vCurrency;
        $Data_passenger['iCompanyId'] = 1;
        $vImage = 'vImage';
        $iMemberId = 'iDriverId';
    }

    if($user_type != "Tracking") {
        $check_passenger = $obj->MySQLSelect("SELECT * FROM $tblname WHERE 1=1 AND (IF('$email'!='',vEmail = '$email',0) OR IF('$fbid'!='',vFbId = '$fbid',0) OR IF('$vAppleId'!='',vAppleId = '$vAppleId',0)) AND eStatus != 'Deleted'");    
    } else {
        $check_passenger = $obj->MySQLSelect("SELECT * FROM $tblname WHERE 1=1 AND (IF('$email'!='',vEmail = '$email',0)) AND eStatus != 'Deleted'");
    }    

    if (count($check_passenger) > 0) {
        $returnArr['Action'] = "0";
        if ($check_passenger[0]['eStatus'] == "Deleted") {
            $returnArr['message'] = "LBL_ACCOUNT_STATUS_DELETED_TXT";
            setDataResponse($returnArr);
        }
        if ($email == strtolower($check_passenger[0]['vEmail'])) {
            $returnArr['message'] = "LBL_ALREADY_REGISTERED_TXT";
            setDataResponse($returnArr);
        }
    }
    $Password_passenger = "";
    if ($password != "") {
        $Password_passenger = encrypt_bycrypt($password);
    }
    //Added By HJ On 31-12-2018 For Get LinkedIn Picture Data Start
    $socialData = array();
    if (isset($_REQUEST["socialData"])) {
        $socialData = (array)json_decode($_REQUEST["socialData"]);
    }
    if (isset($socialData['pictureUrls']) && $eSignUpType == 'LinkedIn') {
        $pictureUrls = $socialData['pictureUrls']->_total;
        if ($pictureUrls > 0) {
            $vImageURL = $socialData['pictureUrls']->values[0];
        } else {
            $vImageURL = $socialData['pictureUrl'];
        }
    }
    //Added By HJ On 31-12-2018 For Get LinkedIn Picture Data End
    $eSystem = "";
    if ($phone_mobile != "") {
        $checPhoneExist = checkMemberDataInfo($phone_mobile, "", $user_type, $CountryCode, "", $eSystem); //Added By HJ On 09-09-2019 For Chekc User Country and Mobile Number When Register
    }
    if (isset($checPhoneExist['status']) && $checPhoneExist['status'] == 0) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_MOBILE_EXIST";
        setDataResponse($returnArr);
    } else if (isset($checPhoneExist['status']) && $checPhoneExist['status'] == 2) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_INVALID_MEMBER_USER_COUNTRY_EMAIL_TXT";
        setDataResponse($returnArr);
    }
    $check_inviteCode = "";
    $inviteSuccess = false;
    if ($vInviteCode != "") {
        $check_inviteCode = $REFERRAL_OBJ->ValidateReferralCode($vInviteCode);
        if ($check_inviteCode == "" || $check_inviteCode == "0" || $check_inviteCode == 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_INVITE_CODE_INVALID";
            setDataResponse($returnArr);
        } else {
            $inviteRes = explode("|", $check_inviteCode);
            $Data_passenger['iRefUserId'] = $inviteRes[0];
            $Data_passenger['eRefType'] = $inviteRes[1];
            $inviteSuccess = true;
        }
    }

    $Data_passenger['vName'] = $Fname;
    $Data_passenger['vLastName'] = $Lname;
    $Data_passenger['vEmail'] = $email;
    $Data_passenger['vPhone'] = $phone_mobile;
    $Data_passenger['vPassword'] = $Password_passenger;
    $Data_passenger['iGcmRegId'] = $iGcmRegId;
    $Data_passenger['vFirebaseDeviceToken'] = $vFirebaseDeviceToken;
    $Data_passenger['vLang'] = $vLang;
    $Data_passenger['vCountry'] = $CountryCode;
    $Data_passenger['eDeviceType'] = $deviceType;
    $Data_passenger['tRegistrationDate'] = @date('Y-m-d H:i:s');
    $random = substr(md5(rand()), 0, 7);
    $Data_passenger['tDeviceSessionId'] = session_id() . time() . $random;
    $Data_passenger['tSessionId'] = session_id() . time();

    if(strtoupper($user_type) != "TRACKING") {
        $Data_passenger['vFbId'] = $fbid;
        $Data_passenger['vAppleId'] = $vAppleId;
        $Data_passenger['vRefCode'] = $REFERRAL_OBJ->GenerateReferralCode($eRefType);
        $Data_passenger['dRefDate'] = @date('Y-m-d H:i:s');
        $Data_passenger['eSignUpType'] = $eSignUpType;
        if ($eSignUpType == "Facebook" || $eSignUpType == "Google") {
            $Data_passenger['eEmailVerified'] = "Yes";
        }
    } else {
        $Data_passenger['eLocationTracking'] = "Yes";
    }
    
    if (SITE_TYPE == 'Demo') {
        $Data_passenger['eStatus'] = 'Active';
        //$Data_passenger['eEmailVerified'] = $Data_passenger['ePhoneVerified'] = 'Yes';
        //Added By HJ On 31-07-2019 For Enable Service At Location Feature Start
        if (strtolower($user_type) == 'driver') {
            $Data_passenger['eEnableServiceAtLocation'] = 'Yes';
        }
        //Added By HJ On 31-07-2019 For Enable Service At Location Feature End
    }
    $id = $obj->MySQLQueryPerform($tblname, $Data_passenger, 'insert');

    if ($user_type == "Passenger") {
        createUserLog('Passenger', 'No', $id, $GeneralDeviceType,'AppLogin','SignUp');
    } elseif ($user_type == "Tracking") {
        createUserLog('TrackServiceUser', 'No', $id, $GeneralDeviceType,'AppLogin','SignUp');
    } else {
        createUserLog('Driver', 'No', $id, $GeneralDeviceType,'AppLogin','SignUp');
    }

    /* Multi Level Referral */
    if ($vInviteCode != "") {
        $refData = $obj->MySQLSelect("SELECT * FROM user_referrer_transaction WHERE iMemberId = " . $inviteRes[0] . " AND eUserType = '" . $inviteRes[1] . "'");
        if ($refData[0]['tReferrerInfo'] == "") {
            $referrerInfo[] = array('Position of Referrer' => 1, 'iMemberId' => $inviteRes[0], 'eUserType' => $inviteRes[1]);
        } else {
            $referrerInfo = json_decode($refData[0]['tReferrerInfo'], true);
            $referrerInfo[] = array('Position of Referrer' => (count($referrerInfo) + 1), 'iMemberId' => $inviteRes[0], 'eUserType' => $inviteRes[1]);
        }
        $Data_Referrer['tReferrerInfo'] = json_encode($referrerInfo);
        $Data_Referrer['iMemberId'] = $id;
        $Data_Referrer['eUserType'] = ($user_type == "Passenger") ? 'Rider' : 'Driver';
        $obj->MySQLQueryPerform("user_referrer_transaction", $Data_Referrer, 'insert');
    }
    /* Multi Level Referral End */
    //Added By HJ On 31-07-2019 For Insert Default Corporate User When Add New User/Rider In Demo Copy Start
    if (strtolower($user_type) == "passenger" && SITE_TYPE == 'Demo') {
        insertCorporateUserProfile($id, $email); // Added By HJ On 31-07-2018 As Per Discuss With BM QA and CD Sir
    }
    //Added By HJ On 31-07-2019 For Insert Default Corporate User When Add New User/Rider In Demo Copy End
    ## Upload Image of Member if SignUp from Google, Facebook Or Twitter ##
    if ($fbid != 0 || $fbid != "") {
        $UserImage = UploadUserImage($id, $user_type, $eSignUpType, $fbid, $vImageURL);
        if ($UserImage != "") {
            $where = " $iMemberId = '$id' ";
            $Data_update_image_member[$vImage] = $UserImage;
            $imageuploadid = $obj->MySQLQueryPerform($tblname, $Data_update_image_member, 'update', $where);
        }
    }
    ## Upload Image of Member if SignUp from Google, Facebook Or Twitter ##
    $returnArr['changeLangCode'] = "Yes";
    $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
    $returnArr['vLanguageCode'] = $vLang;
    //Added By HJ On 24-07-2020 For Optimization language_master Table Query Start
    if (isset($languageAssociateArr[$vLang])) {
        $Data_checkLangCode = array();
        $Data_checkLangCode[] = $languageAssociateArr[$vLang];
    } else {
        $Data_checkLangCode = $obj->MySQLSelect("SELECT * FROM language_master WHERE `vCode` = '" . $vLang . "' ");
    }
    //Added By HJ On 24-07-2020 For Optimization language_master Table Query End
    $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
    $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
    //Added By HJ On 24-07-2020 For Optimization language_master Table Query Start
    if (count($Data_ALL_langArr) > 0) {
        $defLangValues = array();
        for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
            if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE") {
                $defLangValues[] = $Data_ALL_langArr[$g];
            }
        }
    } else {
        $defLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
    }
    //Added By HJ On 24-07-2020 For Optimization language_master Table Query End
    $returnArr['LIST_LANGUAGES'] = $defLangValues;
    for ($i = 0; $i < count($defLangValues); $i++) {
        if ($defLangValues[$i]['eDefault'] == "Yes") {
            $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
        }

        if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
            $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
           // $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
        } else {
            $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
        }
        $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
        $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
    }
    $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
    $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
    for ($i = 0; $i < count($defCurrencyValues); $i++) {
        if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
            $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
        }
        $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
        $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
    }
    if (strtolower($user_type) == 'driver' && SITE_TYPE == 'Live') {
        if ($APP_TYPE == 'UberX' || $APP_TYPE == 'Ride-Delivery-UberX') {
            $result = $obj->MySQLSelect("SELECT GROUP_CONCAT(iVehicleTypeId)as countId FROM `vehicle_type` AND eType = 'UberX'");
            $Drive_vehicle['iDriverId'] = $id;
            $Drive_vehicle['iCompanyId'] = "1";
            $Drive_vehicle['iMakeId'] = "3";
            $Drive_vehicle['iModelId'] = "1";
            $Drive_vehicle['iYear'] = Date('Y');
            $Drive_vehicle['vLicencePlate'] = "My Services";
            $Drive_vehicle['eStatus'] = "Active";
            $Drive_vehicle['eCarX'] = "Yes";
            $Drive_vehicle['eCarGo'] = "Yes";
            $Drive_vehicle['eType'] = "UberX";
            $Drive_vehicle['vCarType'] = "";
            $iDriver_VehicleId = $obj->MySQLQueryPerform('driver_vehicle', $Drive_vehicle, 'insert');
            if ($APP_TYPE == 'UberX') {
                $sql = "UPDATE register_driver set iDriverVehicleId='" . $iDriver_VehicleId . "' WHERE iDriverId='" . $id . "'";
                $obj->sql_query($sql);
            }
        }
    }
    if (strtolower($user_type) == 'driver' && SITE_TYPE == 'Demo') {
        //Added By HJ On 27-07-2019 For Add Money Into Wallet When Register Driver In Demo Mode Start - Discuss With CD and KS Sir
        $tDescription = '#LBL_AMOUNT_CREDIT_BY_USER#';
        $ePaymentStatus = 'Settelled';
        $dDate = Date('Y-m-d H:i:s');
        $WALLET_OBJ->PerformWalletTransaction($id, "Driver", 500, 'Credit', 0, "Deposit", $tDescription, $ePaymentStatus, $dDate);
        //Added By HJ On 27-07-2019 For Add Money Into Wallet When Register Driver In Demo Mode End - Discuss With CD and KS Sir
        $Drive_vehicle['iDriverId'] = $id;
        $Drive_vehicle['iCompanyId'] = "1";
        $Drive_vehicle['iMakeId'] = "3";
        $Drive_vehicle['iModelId'] = "1";
        $Drive_vehicle['iYear'] = Date('Y');
        $Drive_vehicle['eStatus'] = "Active";
        $Drive_vehicle['eCarX'] = "Yes";
        $Drive_vehicle['eCarGo'] = "Yes";
        if ($APP_TYPE == 'Ride-Delivery-UberX' || $APP_TYPE == 'UberX') {
            $Drive_vehicle['vLicencePlate'] = "My Services";
            $Drive_vehicle['eType'] = "UberX";
            $query = "SELECT GROUP_CONCAT(iVehicleTypeId)as countId FROM `vehicle_type` WHERE eType = 'UberX'";
            $result = $obj->MySQLSelect($query);
            $Drive_vehicle['vCarType'] = $result[0]['countId'];
            $Drive_vehicle['vRentalCarType'] = $result[0]['countId'];
            $iDriver_VehicleId = $obj->MySQLQueryPerform('driver_vehicle', $Drive_vehicle, 'insert');
            if ($APP_TYPE == 'UberX') {
                $sql = "UPDATE register_driver set iDriverVehicleId='" . $iDriver_VehicleId . "' WHERE iDriverId='" . $id . "'";
                $obj->sql_query($sql);
            }
            $days = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            foreach ($days as $value) {
                $data_avilability['iDriverId'] = $id;
                $data_avilability['vDay'] = $value;
                $data_avilability['vAvailableTimes'] = '08-09,09-10,10-11,11-12,12-13,13-14,14-15,15-16,16-17,17-18,18-19,19-20,20-21,21-22';
                $data_avilability['dAddedDate'] = @date('Y-m-d H:i:s');
                $data_avilability['eStatus'] = 'Active';
                $data_avilability_add = $obj->MySQLQueryPerform('driver_manage_timing', $data_avilability, 'insert');
            }
            if ($APP_TYPE == 'Ride-Delivery-UberX') {
                $query = "SELECT GROUP_CONCAT(iVehicleTypeId)as countId FROM `vehicle_type` WHERE eType = 'Ride' OR eType = 'Deliver'";
                //Added By HJ On 13-08-2019 For Get Deliverall Vehicle Id Start Discuss With KS Sir
                $getDeliverAll = $obj->MySQLSelect("SELECT iVehicleTypeId FROM `vehicle_type` WHERE eType = 'DeliverAll' ORDER BY iVehicleTypeId ASC LIMIT 0,1");
                //Added By HJ On 13-08-2019 For Get Deliverall Vehicle Id End Discuss With KS Sir
                $result_ride = $obj->MySQLSelect($query);
                if (isset($getDeliverAll[0]['iVehicleTypeId']) && $getDeliverAll[0]['iVehicleTypeId'] > 0) {
                    $deliverAll = $getDeliverAll[0]['iVehicleTypeId'];
                    $result_ride[0]['countId'] .= "," . $deliverAll;
                }
                $Drive_vehicle_ride['iDriverId'] = $id;
                $Drive_vehicle_ride['iCompanyId'] = "1";
                $Drive_vehicle_ride['iYear'] = "2014";
                $Drive_vehicle_ride['vLicencePlate'] = "CK201";
                $Drive_vehicle_ride['eStatus'] = "Active";
                $Drive_vehicle_ride['eCarX'] = "Yes";
                $Drive_vehicle_ride['eCarGo'] = "Yes";
                $Drive_vehicle_ride['eType'] = "Ride";
                $Drive_vehicle_delivery = $Drive_vehicle_ride;
                $Drive_vehicle_ride['iMakeId'] = "1";
                $Drive_vehicle_ride['iModelId'] = "1";
                $Drive_vehicle_ride['vCarType'] = $result_ride[0]['countId'];
                $Drive_vehicle_ride['vRentalCarType'] = $result_ride[0]['countId'];
                $iDriver_Ride_VehicleId = $obj->MySQLQueryPerform('driver_vehicle', $Drive_vehicle_ride, 'insert');
                $sql = "UPDATE register_driver set iDriverVehicleId='" . $iDriver_Ride_VehicleId . "' WHERE iDriverId='" . $id . "'";
                $obj->sql_query($sql);
                $query = "SELECT GROUP_CONCAT(iVehicleTypeId)as countId FROM `vehicle_type` WHERE eType = 'Ride' OR eType = 'Deliver'";
                $result_delivery = $obj->MySQLSelect($query);
                //Added By HJ On 13-08-2019 For Get Deliverall Vehicle Id Start Discuss With KS Sir
                //$getDeliverAll = $obj->MySQLSelect("SELECT iVehicleTypeId FROM `vehicle_type` WHERE eType = 'DeliverAll' ORDER BY iVehicleTypeId ASC LIMIT 0,1");
                if (isset($getDeliverAll[0]['iVehicleTypeId']) && $getDeliverAll[0]['iVehicleTypeId'] > 0) {
                    $deliverAll = $getDeliverAll[0]['iVehicleTypeId'];
                    $result_delivery[0]['countId'] .= "," . $deliverAll;
                }
                //Added By HJ On 13-08-2019 For Get Deliverall Vehicle Id End Discuss With KS Sir
                $Drive_vehicle_delivery['iMakeId'] = "5";
                $Drive_vehicle_delivery['iModelId'] = "18";
                $Drive_vehicle_delivery['eType'] = "Delivery";
                $Drive_vehicle_delivery['vCarType'] = $result_delivery[0]['countId'];
                $Drive_vehicle_delivery['vRentalCarType'] = $result_delivery[0]['countId'];
                $iDriver_Delivery_VehicleId = $obj->MySQLQueryPerform('driver_vehicle', $Drive_vehicle_delivery, 'insert');
            }
        } else {
            $query = "SELECT GROUP_CONCAT(iVehicleTypeId)as countId FROM `vehicle_type` WHERE eType != 'DeliverAll'";
            $result = $obj->MySQLSelect($query);
            //Added By HJ On 13-08-2019 For Get Deliverall Vehicle Id Start Discuss With KS Sir
            $getDeliverAll = $obj->MySQLSelect("SELECT iVehicleTypeId FROM `vehicle_type` WHERE eType = 'DeliverAll' ORDER BY iVehicleTypeId ASC LIMIT 0,1");
            if (isset($getDeliverAll[0]['iVehicleTypeId']) && $getDeliverAll[0]['iVehicleTypeId'] > 0) {
                $deliverAll = $getDeliverAll[0]['iVehicleTypeId'];
                $result[0]['countId'] .= "," . $deliverAll;
            }
            //Added By HJ On 13-08-2019 For Get Deliverall Vehicle Id End Discuss With KS Sir
            $Drive_vehicle['iDriverId'] = $id;
            $Drive_vehicle['iCompanyId'] = "1";
            $Drive_vehicle['iMakeId'] = "5";
            $Drive_vehicle['iModelId'] = "18";
            $Drive_vehicle['iYear'] = "2014";
            $Drive_vehicle['vLicencePlate'] = "CK201";
            $Drive_vehicle['eStatus'] = "Active";
            $Drive_vehicle['eCarX'] = "Yes";
            $Drive_vehicle['eCarGo'] = "Yes";
            //$Drive_vehicle['eAddedDeliverVehicle'] = "Yes";
            $Drive_vehicle['vCarType'] = $result[0]['countId'];
            $Drive_vehicle['vRentalCarType'] = $result[0]['countId'];
            $iDriver_VehicleId = $obj->MySQLQueryPerform('driver_vehicle', $Drive_vehicle, 'insert');
            $sql = "UPDATE register_driver set iDriverVehicleId='" . $iDriver_VehicleId . "' WHERE iDriverId='" . $id . "'";
            $obj->sql_query($sql);
        }
    }
    if ($id > 0) {
        if ($inviteSuccess == true) {
            $eFor = "Referrer";
            $tDescription = "Referral amount credited";
            $dDate = Date('Y-m-d H:i:s');
            $ePaymentStatus = "Unsettelled";
        }

        $maildata['EMAIL'] = $email;
        $maildata['NAME'] = $Fname;
        //$maildata['PASSWORD'] = "Password: " . $password; //Commented By HJ On 11-01-2019 For Hide Password As Per Discuss With QA BM
        $maildata['SOCIALNOTES'] = '';

        /* new added */
        $returnArr['Action'] = "1";
        if ($user_type == "Passenger") {
            $returnArr['message'] = getPassengerDetailInfo($id, "", "");
            $returnArr['message'] = getCustomeNotificationSound($returnArr['message']);

            $COMM_MEDIA_OBJ->SendMailToMember("MEMBER_REGISTRATION_USER", $maildata);
        } elseif ($user_type == "Tracking") {
            $returnArr['message'] = $TRACK_ANY_SERVICE_OBJ->getTrackingMemberDetailInfo($id);
            $COMM_MEDIA_OBJ->SendMailToMember("MEMBER_REGISTRATION_USER", $maildata);
        } else {
            $returnArr['message'] = getDriverDetailInfo($id);
            $returnArr['message'] = getCustomeNotificationSound($returnArr['message']);

            $COMM_MEDIA_OBJ->SendMailToMember("DRIVER_REGISTRATION_USER", $maildata);
            $COMM_MEDIA_OBJ->SendMailToMember("DRIVER_REGISTRATION_ADMIN", $maildata);
        }

        setDataResponse($returnArr);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        setDataResponse($returnArr);
    }
}

if ($type == "signIn") {
    $Emid = isset($_REQUEST["vEmail"]) ? $_REQUEST["vEmail"] : '';
    $Emid = strtolower($Emid);
    $PhoneCode = isset($_REQUEST["PhoneCode"]) ? $_REQUEST["PhoneCode"] : '';
    $CountryCode = isset($_REQUEST["CountryCode"]) ? $_REQUEST["CountryCode"] : '';
    $Password_user = $userPassword = isset($_REQUEST["vPassword"]) ? $_REQUEST["vPassword"] : '';
    $GCMID = isset($_REQUEST["vDeviceToken"]) ? $_REQUEST["vDeviceToken"] : '';
    $DeviceType = isset($_REQUEST["vDeviceType"]) ? $_REQUEST["vDeviceType"] : 'Android';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $vCurrency = isset($_REQUEST["vCurrency"]) ? $_REQUEST["vCurrency"] : '';
    $vLang = isset($_REQUEST["vLang"]) ? $_REQUEST["vLang"] : '';
    $vFirebaseDeviceToken = isset($_REQUEST["vFirebaseDeviceToken"]) ? $_REQUEST["vFirebaseDeviceToken"] : '';
    $vCountry = isset($_REQUEST["vUserDeviceCountry"]) ? $_REQUEST["vUserDeviceCountry"] : '';
    $GeneralMemberId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $tSessionId = isset($_REQUEST["tSessionId"]) ? $_REQUEST["tSessionId"] : '';
    if (SITE_TYPE == "Demo") {
        $tablename = ($UserType == 'Passenger') ? "register_user" : "register_driver";
        $iMemberId = ($UserType == 'Passenger') ? "iUserId" : "iDriverId";
        $iUserId = ($UserType == 'Passenger') ? "36" : "31";
        $Member_Currency = ($UserType == 'Passenger') ? "vCurrencyPassenger" : "vCurrencyDriver";
        $Member_Image = ($UserType == 'Passenger') ? "vImgName" : "vImage";
        $Data_Update_Member['vName'] = ($UserType == 'Passenger') ? "MAC" : "Mark";
        $Data_Update_Member['vLastName'] = ($UserType == 'Passenger') ? "ANDREW" : "Bruno";
        $Data_Update_Member['vEmail'] = ($UserType == 'Passenger') ? "rider@gmail.com" : "driver@gmail.com";
        $Password_User = encrypt_bycrypt("123456");
        $Data_Update_Member['vPassword'] = $Password_User;
        $Data_Update_Member['vCountry'] = ($UserType == 'Passenger') ? "US" : "US";
        $Data_Update_Member['vLang'] = ($UserType == 'Passenger') ? "EN" : "EN";
        $Data_Update_Member['eStatus'] = ($UserType == 'Passenger') ? "Active" : "active";
        $Data_Update_Member[$Member_Currency] = ($UserType == 'Passenger') ? "USD" : "USD";
        $Data_Update_Member[$Member_Image] = ($UserType == 'Passenger') ? "1504878922_81109.jpg" : "1505208397_54463.jpg";
        $where = " $iMemberId = '" . $iUserId . "'";
        $Update_Member_id = $obj->MySQLQueryPerform($tablename, $Data_Update_Member, 'update', $where);
    }
    $passUserType = $UserType;
    if (strtoupper($UserType) == "KIOSK" || strtoupper($UserType) == "HOTEL") {
        $passUserType = "ADMIN";
    }
    $eSystem = "";
    $checkValid = checkMemberDataInfo($Emid, $userPassword, $passUserType, $CountryCode, "", $eSystem);
    $isBiometricLogin = "No";
    if (empty($Emid) && empty($userPassword)) {
        $isBiometricLogin = "Yes";
        $login_session = $obj->MySQLSelect("SELECT * FROM member_login_session_log WHERE iMemberId = '$GeneralMemberId' AND eUserType = '$UserType' AND tSessionId = '$tSessionId'");
        if (!empty($login_session) && count($login_session) > 0) {
            $tSessionId = $login_session[0]['tSessionId'];
        } else {
            $login_session_data = array();
            $login_session_data['iMemberId'] = $GeneralMemberId;
            $login_session_data['eUserType'] = $UserType;
            $login_session_data['tSessionId'] = $tSessionId;
            $login_session_data['eDeviceType'] = $DeviceType;
            $login_session_data['iGcmRegId'] = $GCMID;
            $obj->MySQLQueryPerform("member_login_session_log", $login_session_data, 'insert');
        }
    } else if (isset($checkValid['status']) && $checkValid['status'] == 0) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_WRONG_DETAIL";
        setDataResponse($returnArr);
    } else if (isset($checkValid['status']) && $checkValid['status'] == 2) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_INVALID_MEMBER_USER_COUNTRY_EMAIL_TXT";
        setDataResponse($returnArr);
    }
    $primaryField = "iHotelId";
    $primaryField1 = "h.iHotelId";
    if ($UserType == "Passenger") {
        $primaryField = "iUserId";
        $primaryField1 = "iUserId";
    } else if ($UserType == "Driver") {
        $primaryField = "iDriverId";
        $primaryField1 = "rd.iDriverId";
    }
    $whereCondition = "";
    if (isset($checkValid['USER_DATA'][$primaryField]) && $checkValid['USER_DATA'][$primaryField] > 0 && $isBiometricLogin == "No") {
        $whereCondition = " AND $primaryField1='" . $checkValid['USER_DATA'][$primaryField] . "'";
    }
    if ($UserType == "Passenger") {
        if ($isBiometricLogin == "No") {
            $sql = "SELECT iUserId,eStatus,vLang,vTripStatus,vLang,vPassword FROM `register_user` WHERE (vEmail='$Emid' OR vPhone = '$Emid') $whereCondition AND eStatus != 'Deleted'";
        } else {
            $sql = "SELECT iUserId,eStatus,vLang,vTripStatus,vLang,vPassword FROM `register_user` WHERE iUserId='$GeneralMemberId'";
        }
        $Data = $obj->MySQLSelect($sql);
        $sql_cabrequest = "SELECT iCabRequestId,eStatus FROM `cab_request_now` WHERE iUserId='" . $Data[0]['iUserId'] . "' ORDER BY iCabRequestId DESC LIMIT 0,1";
        $Data_cabrequest = $obj->MySQLSelect($sql_cabrequest);
        $iCabRequestId = $Data_cabrequest[0]['iCabRequestId'];
        $eStatus_cab = $Data_cabrequest[0]['eStatus'];
        if (count($Data) > 0) {
            # Check For Valid password #
            $hash = $Data[0]['vPassword'];
            $checkValidPass = $AUTH_OBJ->VerifyPassword($Password_user, $hash);
            if ($checkValidPass == 0 && $isBiometricLogin == "No") {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_WRONG_DETAIL";
                setDataResponse($returnArr);
            }
            # Check For Valid password #
            if ($Data[0]['eStatus'] == "Active") {
                $iUserId_passenger = $Data[0]['iUserId'];
                $where = " iUserId = '$iUserId_passenger' ";
                if ($Data[0]['vLang'] == "" && $vLang == "") {
                    //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                    $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                    //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
                    $Data_update_passenger['vLang'] = $vLang;
                }
                if ($vLang != "") {
                    $Data_update_passenger['vLang'] = $vLang;
                    $Data[0]['vLang'] = $vLang;
                }
                if ($vCurrency != "") {
                    $Data_update_passenger['vCurrencyPassenger'] = $vCurrency;
                }
                if ($GCMID != '') {
                    $Data_update_passenger['iGcmRegId'] = $GCMID;
                    $Data_update_passenger['eDeviceType'] = $DeviceType;
                    if ($isBiometricLogin == "No") {
                        $Data_update_passenger['tSessionId'] = session_id() . time();
                    } else {
                        $Data_update_passenger['tSessionId'] = $tSessionId;
                    }
                    $Data_update_passenger['vFirebaseDeviceToken'] = $vFirebaseDeviceToken;
                    if (SITE_TYPE == "Demo") {
                        $Data_update_passenger['tRegistrationDate'] = date('Y-m-d H:i:s');
                    }
                    $id = $obj->MySQLQueryPerform("register_user", $Data_update_passenger, 'update', $where);
                }
                if ($eStatus_cab == "Requesting") {
                    $where1 = " iCabRequestId = '$iCabRequestId' ";
                    $Data_update_cab_now['eStatus'] = "Cancelled";
                    $id = $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_now, 'update', $where1);
                }
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1", $iServiceId);
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                $sql_LangCode = "SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "' ";
                $Data_checkLangCode = $obj->MySQLSelect($sql_LangCode);
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $sql = "SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ";
                $defLangValues = $obj->MySQLSelect($sql);
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }

                    if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
                     //   $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                    } else {
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                    }

                    $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                $sql = "SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active'  ORDER BY iDispOrder ASC ";
                $defCurrencyValues = $obj->MySQLSelect($sql);
                $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
                for ($i = 0; $i < count($defCurrencyValues); $i++) {
                    if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                    }
                    $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                $returnArr['Action'] = "1";
                $returnArr['message'] = getPassengerDetailInfo($Data[0]['iUserId'], '', "");
                $returnArr['message'] = getCustomeNotificationSound($returnArr['message']);
                $returnArr['message']['LIST_CURRENCY'] = $defCurrencyValues; //put bc naresh wants it in message..
                createUserLog($UserType, "No", $Data[0]['iUserId'], $DeviceType);
                setDataResponse($returnArr);
            } else {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                if ($Data[0]['eStatus'] != "Deleted") {
                    $returnArr['message'] = "LBL_CONTACT_US_STATUS_NOTACTIVE_PASSENGER";
                    $returnArr['message_title'] = "LBL_ACC_INACTIVE_TITLE";
                    $returnArr['eStatus'] = $Data[0]['eStatus'];
                    $returnArr['isAccountInactive'] = "Yes";
                } else {
                    $returnArr['message'] = "LBL_ACC_DELETE_TXT";
                    $returnArr['message_title'] = "LBL_ACC_DELETE_TITLE";
                    $returnArr['eStatus'] = $Data[0]['eStatus'];
                    $returnArr['isAccountDeleted'] = "Yes";
                }
                setDataResponse($returnArr);
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_WRONG_DETAIL";
            setDataResponse($returnArr);
        }
    } else if ($UserType == "Driver") {
        if ($isBiometricLogin == "No") {
            $sql = "SELECT rd.iDriverId,rd.eStatus,rd.vLang,rd.vPassword,cmp.eStatus as cmpEStatus FROM `register_driver` as rd,`company` as cmp WHERE ( rd.vEmail='$Emid' OR rd.vPhone = '$Emid' ) AND cmp.iCompanyId=rd.iCompanyId $whereCondition AND rd.eStatus != 'Deleted'";
        } else {
            $sql = "SELECT rd.iDriverId,rd.eStatus,rd.vLang,rd.vPassword,cmp.eStatus as cmpEStatus FROM `register_driver` as rd,`company` as cmp WHERE rd.iDriverId = '$GeneralMemberId' AND cmp.iCompanyId=rd.iCompanyId";
        }
        $Data = $obj->MySQLSelect($sql);
        if (count($Data) > 0) {
            # Check For Valid password #
            $hash = $Data[0]['vPassword'];
            $checkValidPass = $AUTH_OBJ->VerifyPassword($Password_user, $hash);
            if ($checkValidPass == 0 && $isBiometricLogin == "No") {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_WRONG_DETAIL";
                setDataResponse($returnArr);
            }
            # Check For Valid password #
            if ($Data[0]['eStatus'] != "Deleted") {
                if ($GCMID != '') {
                    $iDriverId_driver = $Data[0]['iDriverId'];
                    $where = " iDriverId = '$iDriverId_driver' ";
                    if ($Data[0]['vLang'] == "" && $vLang == "") {
                        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                        $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
                        $Data_update_driver['vLang'] = $vLang;
                    }
                    if ($vLang != "") {
                        $Data_update_driver['vLang'] = $vLang;
                        $Data[0]['vLang'] = $vLang;
                    }
                    if ($vCurrency != "") {
                        $Data_update_driver['vCurrencyDriver'] = $vCurrency;
                    }
                    $Data_update_driver['vFirebaseDeviceToken'] = $vFirebaseDeviceToken;
                    if ($isBiometricLogin == "No") {
                        $Data_update_driver['tSessionId'] = session_id() . time();
                    } else {
                        $Data_update_driver['tSessionId'] = $tSessionId;
                    }
                    $Data_update_driver['iGcmRegId'] = $GCMID;
                    $Data_update_driver['eDeviceType'] = $DeviceType;
                    $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
                }
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1", $iServiceId);
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                $sql_LangCode = "SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "' ";
                $Data_checkLangCode = $obj->MySQLSelect($sql_LangCode);
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $sql = "SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ";
                $defLangValues = $obj->MySQLSelect($sql);
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }

                    if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
                      //  $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                    } else {
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                    }

                    $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
                $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
                for ($i = 0; $i < count($defCurrencyValues); $i++) {
                    if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                    }
                    $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                $returnArr['Action'] = "1";
                $returnArr['message'] = getDriverDetailInfo($Data[0]['iDriverId'], 1);
                $returnArr['message'] = getCustomeNotificationSound($returnArr['message']);
                $returnArr['message']['LIST_CURRENCY'] = $defCurrencyValues; //put bc naresh wants it in message..
                createUserLog($UserType, "No", $Data[0]['iDriverId'], $DeviceType);
                setDataResponse($returnArr);
            } else {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                if ($Data[0]['eStatus'] != "Deleted") {
                    $returnArr['message'] = "LBL_CONTACT_US_STATUS_NOTACTIVE_PASSENGER";
                    $returnArr['message_title'] = "LBL_ACC_INACTIVE_TITLE";
                    $returnArr['eStatus'] = $Data[0]['eStatus'];
                    $returnArr['isAccountInactive'] = "Yes";
                } else {
                    $returnArr['message'] = "LBL_ACC_DELETE_TXT";
                    $returnArr['message_title'] = "LBL_ACC_DELETE_TITLE";
                    $returnArr['eStatus'] = $Data[0]['eStatus'];
                    $returnArr['isAccountDeleted'] = "Yes";
                }

                setDataResponse($returnArr);
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_WRONG_DETAIL";
            setDataResponse($returnArr);
        }
    } else {
        // kiosk changes
        $Data = $obj->MySQLSelect("SELECT h.iHotelId,a.eStatus,h.vLang,h.vImgName,a.vPassword FROM `hotel` as h LEFT JOIN administrators as a on a.iAdminId = h.iAdminId WHERE a.vEmail='$Emid' OR a.vContactNo = '$Emid' $whereCondition");
        if (count($Data) > 0) {
            # Check For Valid password #
            $hash = $Data[0]['vPassword'];
            $checkValidPass = $AUTH_OBJ->VerifyPassword($Password_user, $hash);
            if ($checkValidPass == 0) {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_WRONG_DETAIL";
                setDataResponse($returnArr);
            }
            # Check For Valid password #
            if ($Data[0]['eStatus'] == "Active") {
                $iUserId_passenger = $Data[0]['iHotelId'];
                $where = " iHotelId = '$iUserId_passenger' ";
                if ($Data[0]['vLang'] == "" && $vLang == "") {
                    //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                    $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                    //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
                    $Data_update_passenger['vLang'] = $vLang;
                }
                if ($vLang != "") {
                    $Data_update_passenger['vLang'] = $vLang;
                    $Data[0]['vLang'] = $vLang;
                }
                if ($vCurrency != "") {
                    $Data_update_passenger['vCurrencyPassenger'] = $vCurrency;
                }
                if ($GCMID != '') {
                    $Data_update_passenger['iGcmRegId'] = $GCMID;
                    $Data_update_passenger['eDeviceType'] = $DeviceType;
                    $Data_update_passenger['tSessionId'] = session_id() . time();
                    $Data_update_passenger['vFirebaseDeviceToken'] = $vFirebaseDeviceToken;
                    if (SITE_TYPE == "Demo") {
                        $Data_update_passenger['tRegistrationDate'] = date('Y-m-d H:i:s');
                    }
                    $id = $obj->MySQLQueryPerform("hotel", $Data_update_passenger, 'update', $where);
                }
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1");
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                $sql_LangCode = "SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "' ";
                $Data_checkLangCode = $obj->MySQLSelect($sql_LangCode);
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $sql = "SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ";
                $defLangValues = $obj->MySQLSelect($sql);
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }

                        if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
                            $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
                          //  $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                        } else {
                            $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                        }

                    $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
                $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
                for ($i = 0; $i < count($defCurrencyValues); $i++) {
                    if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                    }
                    $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
                    $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                $returnArr['Action'] = "1";
                $returnArr['message'] = getHotelDetailInfo($Data[0]['iHotelId'], '');
                $returnArr['message'] = getCustomeNotificationSound($returnArr['message']);
                $returnArr['message']['LIST_CURRENCY'] = $defCurrencyValues; //put bc naresh wants it in message..
                createUserLog($UserType, "No", $Data[0]['iUserId'], $DeviceType);
                setDataResponse($returnArr);
            } else {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                if ($Data[0]['eStatus'] != "Deleted") {
                    $returnArr['message'] = "LBL_CONTACT_US_STATUS_NOTACTIVE_PASSENGER";
                    $returnArr['message_title'] = "LBL_ACC_INACTIVE_TITLE";
                    $returnArr['eStatus'] = $Data[0]['eStatus'];
                    $returnArr['isAccountInactive'] = "Yes";
                } else {
                    $returnArr['message'] = "LBL_ACC_DELETE_TXT";
                    $returnArr['message_title'] = "LBL_ACC_DELETE_TITLE";
                    $returnArr['eStatus'] = $Data[0]['eStatus'];
                    $returnArr['isAccountDeleted'] = "Yes";
                }
                setDataResponse($returnArr);
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_WRONG_DETAIL";
            setDataResponse($returnArr);
        }
    }
}
###########################################################################
if ($type == "getDetail") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $GCMID = isset($_REQUEST["vDeviceToken"]) ? $_REQUEST["vDeviceToken"] : '';
    $deviceType = isset($_REQUEST["vDeviceType"]) ? $_REQUEST["vDeviceType"] : 'Android';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $vLangCode = isset($_REQUEST["vLang"]) ? $_REQUEST["vLang"] : '';
    $LiveTripId = isset($_REQUEST["LiveTripId"]) ? $_REQUEST["LiveTripId"] : '';
    $OLD_PROFILE_RESPONSE = isset($_REQUEST["OLD_PROFILE_RESPONSE"]) ? $_REQUEST["OLD_PROFILE_RESPONSE"] : '';
    $liveTrackingUrl = "";
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $liveTrackingUrl = getTrackingUrl($LiveTripId);
    }

    if ($UserType == "Passenger") {
        $obj->sql_query("UPDATE trip_status_messages SET eReceived ='Yes' WHERE iUserId='" . $iUserId . "'");
        //Added By HJ On 09-06-2020 For Optimization register_user Table Query Start
        $tblName = "register_user";
        if (isset($userDetailsArr[$tblName . "_" . $iUserId]) && count($userDetailsArr[$tblName . "_" . $iUserId]) > 0) {
            $Data = $userDetailsArr[$tblName . "_" . $iUserId];
        } else {
            $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
            $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
        }
        //Added By HJ On 09-06-2020 For Optimization register_user Table Query End
        $Data_cab = $obj->MySQLSelect("SELECT iCabRequestId,eStatus FROM cab_request_now WHERE iUserId = '" . $iUserId . "' ORDER BY iCabRequestId DESC LIMIT 0,1");
        $iCabRequestId = $Data_cab[0]['iCabRequestId'];
        $eStatus_cab = $Data_cab[0]['eStatus'];
        if (count($Data) > 0) {
            $iGCMregID = $Data[0]['iGcmRegId'];
            $vTripStatus = $Data[0]['vTripStatus'];
            $currencttripid = $Data[0]['iTripId'];
            // added by SK on 06-01-2020  For solve 662 (issue to be fixed sheet)
            if (strtoupper(PACKAGE_TYPE) == "SHARK" && empty($LiveTripId)) {
                $liveTrackingUrl = getTrackingUrl($currencttripid);
            }

            if ($GCMID != "" && $GCMID != $iGCMregID) {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                $returnArr['isSessionExpired'] = "Yes";
                $returnArr['message'] = "LBL_SESSION_TIME_OUT";
                $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
                $returnArr['eStatus'] = "";
                setDataResponse($returnArr);
            }
            if ($Data[0]['vLang'] == "") {
                $where = " iUserId = '$iUserId' ";
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $Data_update_passenger['vLang'] = $vLang;
                $updateid = $obj->MySQLQueryPerform($tblName, $Data_update_passenger, 'update', $where);
                $Data[0]['vLang'] = $vLang;
            }
            if ($eStatus_cab == "Requesting") {
                $where = " iCabRequestId = '$iCabRequestId' ";
                $Data_update_cab_now['eStatus'] = "Cancelled";
                $id = $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_now, 'update', $where);
            }
            $returnArr['changeLangCode'] = "No";
            if (($vLangCode != $Data[0]['vLang']) || $Data[0]['eChangeLang'] == "Yes") {
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1", $iServiceId);
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                if (isset($languageAssociateArr[$Data[0]['vLang']])) {
                    $Data_checkLangCode = array();
                    $Data_checkLangCode[] = $languageAssociateArr[$Data[0]['vLang']];
                } else {
                    $Data_checkLangCode = $obj->MySQLSelect("SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "' ");
                }
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $where = " iUserId = '$iUserId' ";
                $Data_update_passenger_lang['eChangeLang'] = "No";
                $updateLangid = $obj->MySQLQueryPerform($tblName, $Data_update_passenger_lang, 'update', $where);
                $Data[0]['eChangeLang'] = "No";
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                if (count($Data_ALL_langArr) > 0) {
                    $defLangValues = array();
                    for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
                        if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE") {
                            $defLangValues[] = $Data_ALL_langArr[$g];
                        }
                    }
                } else {
                    $defLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC");
                }
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }

                    if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
                      //  $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                    } else {
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                    }

                    $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
            }
            //Added By HJ On 17-06-2020 For Optimize currency Table Query Start
            if (count($Data_ALL_currency_Arr) > 0) {
                $defCurrencyValues = array();
                for ($c = 0; $c < count($Data_ALL_currency_Arr); $c++) {
                    if (strtoupper($Data_ALL_currency_Arr[$c]['eStatus']) == "ACTIVE") {
                        unset($Data_ALL_currency_Arr[$c]['eReverseSymbolEnable']);
                        unset($Data_ALL_currency_Arr[$c]['eReverseformattingEnable']);
                        unset($Data_ALL_currency_Arr[$c]['eRoundingOffEnable']);
                        unset($Data_ALL_currency_Arr[$c]['fFirstRangeValue']);
                        unset($Data_ALL_currency_Arr[$c]['fMiddleRangeValue']);
                        unset($Data_ALL_currency_Arr[$c]['fSecRangeValue']);
                        $defCurrencyValues[] = $Data_ALL_currency_Arr[$c];
                    }
                }
            } else {
                $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
            }
            //Added By HJ On 17-06-2020 For Optimize currency Table Query End
            $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
            for ($i = 0; $i < count($defCurrencyValues); $i++) {
                if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                    $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                }
                $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
            }
            //added by SP on 12-09-2019 for ufx service available or not start
            //$UFX_SERVICE_AVAILABLE = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
            $UFX_SERVICE_AVAILABLE = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
            $returnArr['UFX_SERVICE_AVAILABLE'] = $UFX_SERVICE_AVAILABLE;
            //added by SP on 12-09-2019 for ufx service available or not end
            $returnArr['Action'] = "1";
            $returnArr['message'] = getPassengerDetailInfo($iUserId, '', $LiveTripId);
            $returnArr['message']['UFX_SERVICE_AVAILABLE'] = $UFX_SERVICE_AVAILABLE; // Added By HJ On 17-02-2020 As Per Discussion Between GP and KS Sir
            //Added By HJ On 09-11-2020 For Set App Type Wise Safety Feature As Per Discuss With KS Sir Start
            $returnArr['message']['ENABLE_SAFETY_FEATURE_RIDE'] = $ENABLE_SAFETY_FEATURE_RIDE;
            $returnArr['message']['ENABLE_SAFETY_FEATURE_DELIVERY'] = $ENABLE_SAFETY_FEATURE_DELIVERY;
            $returnArr['message']['ENABLE_SAFETY_FEATURE_UFX'] = $ENABLE_SAFETY_FEATURE_UFX;
            //Added By HJ On 09-11-2020 For Set App Type Wise Safety Feature As Per Discuss With KS Sir End
            // $returnArr['message'] = getCustomeNotificationSound($returnArr['message']); // Added By HJ On 06-08-2019 For Get Custome Sound Notification File Name
            $returnArr['message']['LIST_CURRENCY'] = $defCurrencyValues;
            // Tracking Url
            if (strtoupper(PACKAGE_TYPE) == "SHARK") {
                $returnArr['message']['liveTrackingUrl'] = $liveTrackingUrl; // Added By HJ On 01-01-2019 For Live Tracking URL Share
            } else {
                $returnArr['message']['liveTrackingUrl'] = '';
            }
            createUserLog($UserType, "Yes", $iUserId, $deviceType);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['RESTRICT_APP'] = "Yes";
            $returnArr['isSessionExpired'] = "Yes";
            $returnArr['message'] = "LBL_SESSION_TIME_OUT";
            $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
            $returnArr['eStatus'] = "";
            setDataResponse($returnArr);
        }
        if (!empty($OLD_PROFILE_RESPONSE)) {
            $OLD_PROFILE_RESPONSE = json_decode($OLD_PROFILE_RESPONSE, true);
            unset($OLD_PROFILE_RESPONSE['FETCH_TRIP_STATUS_TIME_INTERVAL']);
            unset($OLD_PROFILE_RESPONSE['FETCH_TRIP_STATUS_TIME_INTERVAL_POOL']);
            unset($OLD_PROFILE_RESPONSE['liveTrackingUrl']);
            unset($OLD_PROFILE_RESPONSE['INVITE_SHARE_CONTENT']);
            unset($OLD_PROFILE_RESPONSE['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tSwitchOnline']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tOnline']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['vAvailability']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tSwitchOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['vAvailability']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['eDriverPaymentStatus']);
            sortNestedArrayAssoc($OLD_PROFILE_RESPONSE);
            $OLD_PROFILE_RESPONSE = getDataResponse($OLD_PROFILE_RESPONSE);
            
            $returnArrTmp = $returnArr;
            unset($returnArrTmp['message']['FETCH_TRIP_STATUS_TIME_INTERVAL']);
            unset($returnArrTmp['message']['FETCH_TRIP_STATUS_TIME_INTERVAL_POOL']);
            unset($returnArrTmp['message']['liveTrackingUrl']);
            unset($returnArrTmp['message']['INVITE_SHARE_CONTENT']);
            unset($returnArrTmp['message']['tDeviceData']);
            unset($returnArrTmp['message']['eAppTerminate']);
            unset($returnArrTmp['message']['PassengerDetails']['vLatitude']);
            unset($returnArrTmp['message']['PassengerDetails']['vLongitude']);
            unset($returnArrTmp['message']['PassengerDetails']['tLastOnline']);
            unset($returnArrTmp['message']['PassengerDetails']['tDeviceData']);
            unset($returnArrTmp['message']['PassengerDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['PassengerDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['DriverDetails']['vLatitude']);
            unset($returnArrTmp['message']['DriverDetails']['vLongitude']);
            unset($returnArrTmp['message']['DriverDetails']['tLastOnline']);
            unset($returnArrTmp['message']['DriverDetails']['tOnline']);
            unset($returnArrTmp['message']['DriverDetails']['tSwitchOnline']);
            unset($returnArrTmp['message']['DriverDetails']['vAvailability']);
            unset($returnArrTmp['message']['DriverDetails']['tDeviceData']);
            unset($returnArrTmp['message']['DriverDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['DriverDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['vLatitude']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['vLongitude']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['tLastOnline']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['tDeviceData']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['vLatitude']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['vLongitude']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tLastOnline']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tOnline']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tSwitchOnline']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['vAvailability']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tDeviceData']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['TripDetails']['eDriverPaymentStatus']);
            sortNestedArrayAssoc($returnArrTmp['message']);
            $typeResponse = getDataResponse($returnArrTmp['message']);
            
            if ($OLD_PROFILE_RESPONSE == $typeResponse) {
                $returnArr['UPDATE_USER_DATA'] = "No";
            } else {
                $returnArr['UPDATE_USER_DATA'] = "Yes";
            }
        }
        setDataResponse($returnArr);
    } else if ($UserType == "Driver") {
        $obj->sql_query("UPDATE trip_status_messages SET eReceived = 'Yes' WHERE iDriverId='" . $iUserId . "'");
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            getDriverPoolTrips($iUserId);
        }
        //Added By HJ On 17-06-2020 For Optimization register_driver Table Query Start
        $tblName = "register_driver";
        if (isset($userDetailsArr[$tblName . "_" . $iUserId]) && count($userDetailsArr[$tblName . "_" . $iUserId]) > 0) {
            $Data = $userDetailsArr[$tblName . "_" . $iUserId];
        } else {
            $Data = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='" . $iUserId . "'");
            $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
        }
        //Added By HJ On 17-06-2020 For Optimization register_driver Table Query End
        //$Data = $obj->MySQLSelect("SELECT iGcmRegId,vLang,eChangeLang,iTripId FROM `register_driver` WHERE iDriverId='$iUserId'"); //Commented By HJ On 17-06-2020 For Optimize register_driver Table Query
        if (count($Data) > 0) {
            $iGCMregID = $Data[0]['iGcmRegId'];
            $currencttripid = $Data[0]['iTripId'];
            $currencttripserviceid = "";
            $currencttriptype = "General";
            if ($currencttripid > 0) {
                //Added By HJ On 17-06-2020 For Optimize trips Table Query Start
                if (isset($tripDetailsArr["trips_" . $currencttripid])) {
                    $TripData = $tripDetailsArr["trips_" . $currencttripid];
                } else {
                    $TripData = get_value("trips", '*', 'iTripId', $currencttripid);
                    $tripDetailsArr["trips_" . $currencttripid] = $TripData;
                }
                //Added By HJ On 17-06-2020 For Optimize trips Table Query End
                $currencttripserviceid = $TripData[0]['iServiceId'];
                $currencttriptype = $TripData[0]['eSystem'];
            }
            if (strtoupper(PACKAGE_TYPE) == "SHARK") {
                $liveTrackingUrl = getTrackingUrl($currencttripid);
            }
            if ($Data[0]['vLang'] == "") {
                $where = " iDriverId = '$iUserId' ";
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $Data_update_driver['vLang'] = $vLang;
                $updateid = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
            }
            if ($GCMID != "" && $GCMID != $iGCMregID) {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                $returnArr['isSessionExpired'] = "Yes";
                $returnArr['message'] = "LBL_SESSION_TIME_OUT";
                $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
                $returnArr['eStatus'] = "";
                setDataResponse($returnArr);
            }
            $returnArr['changeLangCode'] = "No";
            if (($vLangCode != $Data[0]['vLang']) || $Data[0]['eChangeLang'] == "Yes" || $currencttriptype == "DeliverAll") {
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1", $currencttripserviceid, $iServiceId);
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                if (isset($languageAssociateArr[$Data[0]['vLang']])) {
                    $Data_checkLangCode = array();
                    $Data_checkLangCode[] = $languageAssociateArr[$Data[0]['vLang']];
                } else {
                    $Data_checkLangCode = $obj->MySQLSelect("SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "' ");
                }
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $where = " iDriverId = '$iUserId' ";
                $Data_update_passenger_lang['eChangeLang'] = "No";
                $updateLangid = $obj->MySQLQueryPerform("register_driver", $Data_update_passenger_lang, 'update', $where);
                $Data[0]['eChangeLang'] = "No";
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                if (count($Data_ALL_langArr) > 0) {
                    $defLangValues = array();
                    for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
                        if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE") {
                            $defLangValues[] = $Data_ALL_langArr[$g];
                        }
                    }
                } else {
                    $defLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC");
                }
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }

                    if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
					$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
					//$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                    } else {
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                    }

                    $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
            }
            //Added By HJ On 11-07-2020 For Optimize currency Table Query Start
            if (count($Data_ALL_currency_Arr) > 0) {
                $defCurrencyValues = array();
                for ($c = 0; $c < count($Data_ALL_currency_Arr); $c++) {
                    if (strtoupper($Data_ALL_currency_Arr[$c]['eStatus']) == "ACTIVE") {
                        unset($Data_ALL_currency_Arr[$c]['eReverseSymbolEnable']);
                        unset($Data_ALL_currency_Arr[$c]['eReverseformattingEnable']);
                        unset($Data_ALL_currency_Arr[$c]['eRoundingOffEnable']);
                        unset($Data_ALL_currency_Arr[$c]['fFirstRangeValue']);
                        unset($Data_ALL_currency_Arr[$c]['fMiddleRangeValue']);
                        unset($Data_ALL_currency_Arr[$c]['fSecRangeValue']);
                        $defCurrencyValues[] = $Data_ALL_currency_Arr[$c];
                    }
                }
            } else {
                $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
            }
            //Added By HJ On 11-07-2020 For Optimize currency Table Query End
            $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
            for ($i = 0; $i < count($defCurrencyValues); $i++) {
                if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                    $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                }
                $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
            }
            $returnArr['Action'] = "1";
            // $returnArr['message'] = getDriverDetailInfo($iUserId);
            //added by SP on 12-09-2019 for ufx service available or not start
            //$UFX_SERVICE_AVAILABLE = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
            $UFX_SERVICE_AVAILABLE = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
            $returnArr['UFX_SERVICE_AVAILABLE'] = $UFX_SERVICE_AVAILABLE;
            //added by SP on 12-09-2019 for ufx service available or not end
            $returnArr['message'] = getDriverDetailInfo($iUserId);
            $returnArr['message']['UFX_SERVICE_AVAILABLE'] = $UFX_SERVICE_AVAILABLE; // Added By HJ On 17-02-2020 As Per Discussion Between GP and KS Sir
            //Added By HJ On 09-11-2020 For Set App Type Wise Safety Feature As Per Discuss With KS Sir Start
            $returnArr['message']['ENABLE_SAFETY_FEATURE_RIDE'] = $ENABLE_SAFETY_FEATURE_RIDE;
            $returnArr['message']['ENABLE_SAFETY_FEATURE_DELIVERY'] = $ENABLE_SAFETY_FEATURE_DELIVERY;
            $returnArr['message']['ENABLE_SAFETY_FEATURE_UFX'] = $ENABLE_SAFETY_FEATURE_UFX;
            //Added By HJ On 09-11-2020 For Set App Type Wise Safety Feature As Per Discuss With KS Sir End
            $returnArr['message'] = getCustomeNotificationSound($returnArr['message']); // Added By HJ On 06-08-2019 For Get Custome Sound Notification File Name
            $returnArr['message']['LIST_CURRENCY'] = $defCurrencyValues; // dont remove this code..i will put it 3rd time...problem in webservice
            if (strtoupper(PACKAGE_TYPE) == "SHARK") {
                $returnArr['message']['liveTrackingUrl'] = $liveTrackingUrl; // Added By HJ On 01-01-2019 For Live Tracking URL Share
            } else {
                $returnArr['message']['liveTrackingUrl'] = "";
            }
            createUserLog($UserType, "Yes", $iUserId, $deviceType);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['RESTRICT_APP'] = "Yes";
            $returnArr['isSessionExpired'] = "Yes";
            $returnArr['message'] = "LBL_SESSION_TIME_OUT";
            $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
            $returnArr['eStatus'] = "";
            setDataResponse($returnArr);
        }
        if (!empty($OLD_PROFILE_RESPONSE)) {
            $OLD_PROFILE_RESPONSE = json_decode($OLD_PROFILE_RESPONSE, true);
            unset($OLD_PROFILE_RESPONSE['FETCH_TRIP_STATUS_TIME_INTERVAL']);
            unset($OLD_PROFILE_RESPONSE['FETCH_TRIP_STATUS_TIME_INTERVAL_POOL']);
            unset($OLD_PROFILE_RESPONSE['REWARD_SUBTITLE_DESC']);
            unset($OLD_PROFILE_RESPONSE['liveTrackingUrl']);
            unset($OLD_PROFILE_RESPONSE['LIST_CURRENCY']);
            unset($OLD_PROFILE_RESPONSE['USER_NOTIFICATION']);
            unset($OLD_PROFILE_RESPONSE['PROVIDER_NOTIFICATION']);
            unset($OLD_PROFILE_RESPONSE['DIAL_NOTIFICATION']);
            unset($OLD_PROFILE_RESPONSE['STORE_NOTIFICATION']);
            unset($OLD_PROFILE_RESPONSE['VOIP_NOTIFICATION']);
            unset($OLD_PROFILE_RESPONSE['tOnline']);
            unset($OLD_PROFILE_RESPONSE['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['tSwitchOnline']);
            unset($OLD_PROFILE_RESPONSE['vAvailability']);
            unset($OLD_PROFILE_RESPONSE['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['PassengerDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tOnline']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tSwitchOnline']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['DriverDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['PassengerDetails']['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['vLatitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['vLongitude']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tLastOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tSwitchOnline']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tLocationUpdateDate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['eAppTerminate']);
            unset($OLD_PROFILE_RESPONSE['TripDetails']['DriverDetails']['tDeviceData']);
            sortNestedArrayAssoc($OLD_PROFILE_RESPONSE);
            $OLD_PROFILE_RESPONSE = getDataResponse($OLD_PROFILE_RESPONSE);
            
            $returnArrTmp = $returnArr;
            unset($returnArrTmp['message']['FETCH_TRIP_STATUS_TIME_INTERVAL']);
            unset($returnArrTmp['message']['FETCH_TRIP_STATUS_TIME_INTERVAL_POOL']);
            unset($returnArrTmp['message']['REWARD_SUBTITLE_DESC']);
            unset($returnArrTmp['message']['liveTrackingUrl']);
            unset($returnArrTmp['message']['LIST_CURRENCY']);
            unset($returnArrTmp['message']['USER_NOTIFICATION']);
            unset($returnArrTmp['message']['PROVIDER_NOTIFICATION']);
            unset($returnArrTmp['message']['DIAL_NOTIFICATION']);
            unset($returnArrTmp['message']['STORE_NOTIFICATION']);
            unset($returnArrTmp['message']['VOIP_NOTIFICATION']);
            unset($returnArrTmp['message']['tOnline']);
            unset($returnArrTmp['message']['tLastOnline']);
            unset($returnArrTmp['message']['tSwitchOnline']);
            unset($returnArrTmp['message']['vAvailability']);
            unset($returnArrTmp['message']['eAppTerminate']);
            unset($returnArrTmp['message']['tDeviceData']);
            unset($returnArrTmp['message']['vLatitude']);
            unset($returnArrTmp['message']['vLongitude']);
            unset($returnArrTmp['message']['PassengerDetails']['vLatitude']);
            unset($returnArrTmp['message']['PassengerDetails']['vLongitude']);
            unset($returnArrTmp['message']['PassengerDetails']['tLastOnline']);
            unset($returnArrTmp['message']['PassengerDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['PassengerDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['PassengerDetails']['tDeviceData']);
            unset($returnArrTmp['message']['DriverDetails']['vLatitude']);
            unset($returnArrTmp['message']['DriverDetails']['vLongitude']);
            unset($returnArrTmp['message']['DriverDetails']['tOnline']);
            unset($returnArrTmp['message']['DriverDetails']['tLastOnline']);
            unset($returnArrTmp['message']['DriverDetails']['tSwitchOnline']);
            unset($returnArrTmp['message']['DriverDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['DriverDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['DriverDetails']['tDeviceData']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['vLatitude']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['vLongitude']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tOnline']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tLastOnline']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tSwitchOnline']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['TripDetails']['DriverDetails']['tDeviceData']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['vLatitude']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['vLongitude']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['tLastOnline']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['tLocationUpdateDate']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['eAppTerminate']);
            unset($returnArrTmp['message']['TripDetails']['PassengerDetails']['tDeviceData']);
            sortNestedArrayAssoc($returnArrTmp['message']);
            $typeResponse = getDataResponse($returnArrTmp['message']);

            if ($OLD_PROFILE_RESPONSE == $typeResponse) {
                $returnArr['UPDATE_USER_DATA'] = "No";
            } else {
                $returnArr['UPDATE_USER_DATA'] = "Yes";
            }
        }
        setDataResponse($returnArr);
    } if ($UserType == "Tracking") {
        $tblName = "track_service_users";
        if (isset($userDetailsArr[$tblName . "_" . $iUserId]) && count($userDetailsArr[$tblName . "_" . $iUserId]) > 0) {
            $Data = $userDetailsArr[$tblName . "_" . $iUserId];
        } else {
            $Data = $obj->MySQLSelect("SELECT *,iTrackServiceUserId as iMemberId FROM " . $tblName . " WHERE iTrackServiceUserId='" . $iUserId . "'");
            $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
        }
        
        if (count($Data) > 0) {
            $iGCMregID = $Data[0]['iGcmRegId'];

            if ($GCMID != "" && $GCMID != $iGCMregID) {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                $returnArr['isSessionExpired'] = "Yes";
                $returnArr['message'] = "LBL_SESSION_TIME_OUT";
                $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
                $returnArr['eStatus'] = "";
                setDataResponse($returnArr);
            }
            if ($Data[0]['vLang'] == "") {
                $where = " iTrackServiceUserId = '$iUserId' ";
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                $Data_update_passenger['vLang'] = $vLang;
                $updateid = $obj->MySQLQueryPerform($tblName, $Data_update_passenger, 'update', $where);
                $Data[0]['vLang'] = $vLang;
            }
            
            $returnArr['changeLangCode'] = "No";
            if (($vLangCode != $Data[0]['vLang']) || $Data[0]['eChangeLang'] == "Yes") {
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1", $iServiceId);
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                if (isset($languageAssociateArr[$Data[0]['vLang']])) {
                    $Data_checkLangCode = array();
                    $Data_checkLangCode[] = $languageAssociateArr[$Data[0]['vLang']];
                } else {
                    $Data_checkLangCode = $obj->MySQLSelect("SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "' ");
                }
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $where = " iTrackServiceUserId = '$iUserId' ";
                $Data_update_passenger_lang['eChangeLang'] = "No";
                $updateLangid = $obj->MySQLQueryPerform($tblName, $Data_update_passenger_lang, 'update', $where);
                $Data[0]['eChangeLang'] = "No";
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                if (count($Data_ALL_langArr) > 0) {
                    $defLangValues = array();
                    for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
                        if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE") {
                            $defLangValues[] = $Data_ALL_langArr[$g];
                        }
                    }
                } else {
                    $defLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC");
                }
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }
                    if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
						$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
                        //$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                    } else {
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                    }
                    $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
            }
           
            $returnArr['Action'] = "1";
            $returnArr['message'] = $TRACK_ANY_SERVICE_OBJ->getTrackingMemberDetailInfo($iUserId);
            
            createUserLog("TrackServiceUser", "Yes", $iUserId, $deviceType);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['RESTRICT_APP'] = "Yes";
            $returnArr['isSessionExpired'] = "Yes";
            $returnArr['message'] = "LBL_SESSION_TIME_OUT";
            $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
            $returnArr['eStatus'] = "";
            setDataResponse($returnArr);
        }
        if (!empty($OLD_PROFILE_RESPONSE)) {
            $OLD_PROFILE_RESPONSE = json_decode($OLD_PROFILE_RESPONSE, true);
            unset($OLD_PROFILE_RESPONSE['tDeviceData']);
            unset($OLD_PROFILE_RESPONSE['eAppTerminate']);
            sortNestedArrayAssoc($OLD_PROFILE_RESPONSE);
            $OLD_PROFILE_RESPONSE = getDataResponse($OLD_PROFILE_RESPONSE);

            $returnArrTmp = $returnArr;
            unset($returnArrTmp['message']['tDeviceData']);
            unset($returnArrTmp['message']['eAppTerminate']);
            sortNestedArrayAssoc($returnArrTmp['message']);
            $typeResponse = getDataResponse($returnArrTmp['message']);
            // echo $OLD_PROFILE_RESPONSE . '<br><br> ============= <br><br>' . $typeResponse; exit;
            if ($OLD_PROFILE_RESPONSE == $typeResponse) {
                $returnArr['UPDATE_USER_DATA'] = "No";
            } else {
                $returnArr['UPDATE_USER_DATA'] = "Yes";
            }
        }
        setDataResponse($returnArr);
    } else {
        // kiosk changes
        $Data = $obj->MySQLSelect("SELECT iGcmRegId,vImgName,vLang,eChangeLang,vVehicleTypeImg FROM `hotel` WHERE iHotelId='" . $iUserId . "'");
        if (count($Data) > 0) {
            $iGCMregID = $Data[0]['iGcmRegId'];
            $vTripStatus = $Data[0]['vTripStatus'];
            if ($GCMID != "" && $GCMID != $iGCMregID) {
                $returnArr['Action'] = "0";
                $returnArr['RESTRICT_APP'] = "Yes";
                $returnArr['isSessionExpired'] = "Yes";
                $returnArr['message'] = "LBL_SESSION_TIME_OUT";
                $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
                $returnArr['eStatus'] = "";
                setDataResponse($returnArr);
            }
            if ($Data[0]['vLang'] == "") {
                $where = " iHotelId = '$iUserId' ";
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
                //$vLang = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
                $Data_update_passenger['vLang'] = $vLang;
                $updateid = $obj->MySQLQueryPerform("hotel", $Data_update_passenger, 'update', $where);
                $Data[0]['vLang'] = $vLang;
            }
            $returnArr['changeLangCode'] = "No";
            if (($vLangCode != $Data[0]['vLang']) || $Data[0]['eChangeLang'] == "Yes") {
                $returnArr['changeLangCode'] = "Yes";
                $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($Data[0]['vLang'], "1");
                $returnArr['vLanguageCode'] = $Data[0]['vLang'];
                //Added By HJ On 09-07-2020 For Optimize language_master Table Query Start
                if (isset($languageAssociateArr[$Data[0]['vLang']])) {
                    $Data_checkLangCode = array();
                    $Data_checkLangCode[] = $languageAssociateArr[$Data[0]['vLang']];
                } else {
                    $Data_checkLangCode = $obj->MySQLSelect("SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $Data[0]['vLang'] . "'");
                }
                //Added By HJ On 09-07-2020 For Optimize language_master Table Query End
                $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
                $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
                $where = " iHotelId = '$iUserId' ";
                $Data_update_passenger_lang['eChangeLang'] = "No";
                $updateLangid = $obj->MySQLQueryPerform("hotel", $Data_update_passenger_lang, 'update', $where);
                $Data[0]['eChangeLang'] = "No";
                //Added By HJ On 09-07-2020 For Optimize language_master Table Query Start
                if (count($Data_ALL_langArr) > 0) {
                    $defLangValues = array();
                    for ($g = 0; $g < count($Data_ALL_langArr); $g++) {
                        if (strtoupper($Data_ALL_langArr[$g]['eStatus']) == "ACTIVE") {
                            $defLangValues[] = $Data_ALL_langArr[$g];
                        }
                    }
                } else {
                    $defLangValues = $obj->MySQLSelect("SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ");
                }
                //Added By HJ On 09-07-2020 For Optimize language_master Table Query End
                $returnArr['LIST_LANGUAGES'] = $defLangValues;
                for ($i = 0; $i < count($defLangValues); $i++) {
                    if ($defLangValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
                    }

                    if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
						$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
					//	$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
                    } else {
                        $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
                    }

                    $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
                //Added By HJ On 09-07-2020 For Optimize currency Table Query Start
                if (count($Data_ALL_currency_Arr) > 0) {
                    $defCurrencyValues = array();
                    for ($c = 0; $c < count($Data_ALL_currency_Arr); $c++) {
                        if (strtoupper($Data_ALL_currency_Arr[$c]['eStatus']) == "ACTIVE") {
                            $defCurrencyValues[] = $Data_ALL_currency_Arr[$c];
                        }
                    }
                } else {
                    $defCurrencyValues = $obj->MySQLSelect("SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC");
                }
                //Added By HJ On 09-07-2020 For Optimize currency Table Query End
                $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
                for ($i = 0; $i < count($defCurrencyValues); $i++) {
                    if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                        $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
                    }
                    $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
                    $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
                    $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
                }
            }
            $returnArr['Action'] = "1";
            $returnArr['message'] = getHotelDetailInfo($iUserId, '');
            //Added By HJ On 09-11-2020 For Set App Type Wise Safety Feature As Per Discuss With KS Sir Start
            $returnArr['message']['ENABLE_SAFETY_FEATURE_RIDE'] = $ENABLE_SAFETY_FEATURE_RIDE;
            $returnArr['message']['ENABLE_SAFETY_FEATURE_DELIVERY'] = $ENABLE_SAFETY_FEATURE_DELIVERY;
            $returnArr['message']['ENABLE_SAFETY_FEATURE_UFX'] = $ENABLE_SAFETY_FEATURE_UFX;
            //Added By HJ On 09-11-2020 For Set App Type Wise Safety Feature As Per Discuss With KS Sir End
            $returnArr['message'] = getCustomeNotificationSound($returnArr['message']); // Added By HJ On 06-08-2019 For Get Custome Sound Notification File Name
            $returnArr['message']['LIST_CURRENCY'] = $defCurrencyValues;

            if (strtoupper(PACKAGE_TYPE) == "SHARK") {
                $returnArr['message']['liveTrackingUrl'] = $liveTrackingUrl; // Added By HJ On 01-01-2019 For Live Tracking URL Share
            } else {
                $returnArr['message']['liveTrackingUrl'] = "";
            }
            createUserLog($UserType, "Yes", $iUserId, $deviceType);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['RESTRICT_APP'] = "Yes";
            $returnArr['isSessionExpired'] = "Yes";
            $returnArr['message'] = "LBL_SESSION_TIME_OUT";
            $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
            $returnArr['eStatus'] = "";
            setDataResponse($returnArr);
        }
        setDataResponse($returnArr);
    }
}

###########################################################################
if ($type == 'getReceipt') {
    $iTripId = isset($_REQUEST['iTripId']) ? clean($_REQUEST['iTripId']) : '';
    $UserType = isset($_REQUEST['UserType']) ? clean($_REQUEST['UserType']) : ''; //Passenger OR Driver
    $iBiddingPostId = isset($_REQUEST['iBiddingPostId']) ? clean($_REQUEST['iBiddingPostId']) : '';
    if (!empty($iBiddingPostId)) {
        $value = sendBiddingServiceReceipt($iBiddingPostId);
    } else {
        $eType = get_value('trips', 'eType', 'iTripId', $iTripId, '', 'true');
        if ($eType == "Multi-Delivery") {
            $value = sendTripReceipt_Multi($iTripId,$UserType);
        } else {
            $value = sendTripReceipt($iTripId,$UserType);
        }
    }
    if ($value == "true" || $value == "1" || $value == 1) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_CHECK_INBOX_TXT";
    } else if ($value == 3 || $value == '3') {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_NO_EMAIL_ADDED";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_FAILED_SEND_RECEIPT_EMAIL_TXT";
    }
    setDataResponse($returnArr);
}
########################### Get Available Taxi ##############################
if ($type == "loadAvailableCab") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $passengerLat = isset($_REQUEST["PassengerLat"]) ? $_REQUEST["PassengerLat"] : '';
    $passengerLon = isset($_REQUEST["PassengerLon"]) ? $_REQUEST["PassengerLon"] : '';
    $passengerDestLat = isset($_REQUEST["DestLat"]) ? $_REQUEST["DestLat"] : '';
    $passengerDestLon = isset($_REQUEST["DestLong"]) ? $_REQUEST["DestLong"] : '';
    $iVehicleTypeId = isset($_REQUEST["iVehicleTypeId"]) ? $_REQUEST["iVehicleTypeId"] : '';
    $PickUpAddress = isset($_REQUEST["PickUpAddress"]) ? $_REQUEST["PickUpAddress"] : '';
    $geoCodeResult = isset($_REQUEST["currentGeoCodeResult"]) ? $_REQUEST["currentGeoCodeResult"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $scheduleDate = isset($_REQUEST["scheduleDate"]) ? $_REQUEST["scheduleDate"] : '';
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations","APP_TYPE");
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';
    $eRental = isset($_REQUEST["eRental"]) ? $_REQUEST["eRental"] : 'No'; // Yes Or No
    $eShowOnlyMoto = isset($_REQUEST["eShowOnlyMoto"]) ? $_REQUEST["eShowOnlyMoto"] : 'No'; // Yes Or No
    // addon changes
    $sortby = isset($_REQUEST["sortby"]) ? $_REQUEST["sortby"] : 'eIsFeatured'; // nearby , rating, featured
    // for hotel web
    $isFromHotelPanel = isset($_REQUEST["isFromHotelPanel"]) ? $_REQUEST["isFromHotelPanel"] : 'No';
    $SelectedCabType = isset($_REQUEST["SelectedCabType"]) ? $_REQUEST["SelectedCabType"] : '';
    // for admin web, is for getting driver list
    $isFromAdminPanel = isset($_REQUEST["isFromAdminPanel"]) ? $_REQUEST["isFromAdminPanel"] : 'No';
    $eFemaleDriverRequestWeb = isset($_REQUEST["eFemaleDriverRequest"]) ? $_REQUEST["eFemaleDriverRequest"] : '';
    $eHandiCapAccessibilityWeb = isset($_REQUEST["eHandiCapAccessibility"]) ? $_REQUEST["eHandiCapAccessibility"] : '';
    //$eChildSeatAvailableWeb = isset($_REQUEST["eChildSeatAvailable"]) ? $_REQUEST["eChildSeatAvailable"] : 'No';
    $iCompanyId = isset($_REQUEST["iCompanyId"]) ? $_REQUEST["iCompanyId"] : '';
    $vCountryCode = isset($_REQUEST["vUserDeviceCountry"]) ? strtoupper($_REQUEST['vUserDeviceCountry']) : 'US';
    //added by SP for fly stations on 19-08-2019
    $eFly = isset($_REQUEST["eFly"]) ? $_REQUEST['eFly'] : 'No';
    $iFromLocationId = isset($_REQUEST["iFromStationId"]) ? $_REQUEST['iFromStationId'] : '';
    $iToLocationId = isset($_REQUEST["iToStationId"]) ? $_REQUEST['iToStationId'] : '';
    $bookingFrom = isset($_REQUEST["bookingFrom"]) ? $_REQUEST['bookingFrom'] : 'App';//bcoz pool vehicle is not shown to the website.is called when vehicles are fetched
    $eForVideoConsultation = isset($_REQUEST["eForVideoConsultation"]) ? $_REQUEST['eForVideoConsultation'] : 'No';
    $isRidePool = isset($_REQUEST["isRidePool"]) ? $_REQUEST['isRidePool'] : 'No';
    $eForMedicalService = isset($_REQUEST["eForMedicalService"]) ? $_REQUEST['eForMedicalService'] : 'No';
    $page = isset($_REQUEST['page']) ? trim($_REQUEST['page']) : 1;
    $per_page = 10;
    if ($eType == "" || $eType == NULL) {
        $eType = $SelectedCabType;
    }
    if ($eRental == "" || $eRental == NULL) {
        $eRental = "No";
    }
    if ($eShowOnlyMoto == "" || $eShowOnlyMoto == NULL) {
        $eShowOnlyMoto = "No";
    }
    if ($eType == "UberX" && $scheduleDate != "") {
        $Check_Driver_UFX = "Yes";
        $sdate = explode(" ", $scheduleDate);
        $shour = explode("-", $sdate[1]);
        $shour1 = $shour[0];
        $Check_Date_Time = $sdate[0] . " " . $shour1 . ":00:00";
    } else if ($eType == "UberX" && $SERVICE_PROVIDER_FLOW == "Provider") {
        $Check_Driver_UFX = "Yes";
        $Check_Date_Time = "";
    } else {
        $Check_Driver_UFX = "No";
        $Check_Date_Time = "";
    }
    /* For New Payment Flow */
    $params = array("iMemberId" => $iUserId, "eUserType" => "Passenger", "eType" => $eType, "GET_DATA" => "Yes");
    $payment_mode_data = GetPaymentModeDetails($params);
    $PaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
    /* For New Payment Flow End */
    $address_data['PickUpAddress'] = $PickUpAddress;
    $DataArr = FetchAvailableDrivers($passengerLat, $passengerLon, $address_data, "No", "No", $Check_Driver_UFX, $Check_Date_Time, $passengerDestLat, $passengerDestLon, $eType, $eFemaleDriverRequestWeb);
    $Data_DriverList = $DataArr['DriverList'];
    foreach ($Data_DriverList as $k => $driverList) {
        if (strtoupper($driverList['ACCEPT_CASH_TRIPS']) == "NO" && strtoupper($PaymentMode) == "CASH") {
            unset($Data_DriverList[$k]);
        }
    }
    $Data = array_values($Data_DriverList);
    // addon changes
    ### Sorting Of Providers by  nearby , rating, featured ###
    if (strtoupper($eType) == "UBERX") {
        if ($sortby == "" || $sortby == NULL) {
            $sortby = "eIsFeatured";
        }
        if ($sortby == "vAvgRating") {
            $sortfield = "vAvgRating";
            $sortorder = SORT_DESC;
        } else if ($sortby == "distance") {
            $sortfield = "distance";
            $sortorder = SORT_ASC;
        } else if ($sortby == 'IS_PROVIDER_ONLINE') {
            $sortfield = "IS_PROVIDER_ONLINE";
            $sortorder = SORT_DESC;
        } else if ($sortby == 'eFavDriver') {
            $sortfield = "eFavDriver";
            $sortorder = SORT_DESC;
        } else {
            $sortfield = "eIsFeatured";
            $sortorder = SORT_DESC;
        }
        foreach ($Data as $k => $v) {
            $Data_name[$sortfield][$k] = $v[$sortfield];
            $Data_name['vAvailability'][$k] = $v['vAvailability'];
        }
        array_multisort($Data_name[$sortfield], $sortorder, $Data);
    }
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    //array_multisort($Data_name['vAvailability'],SORT_DESC,$Data_name[$sortfield], $sortorder,$Data);
    ### Sorting Of Restaurants by relevance , rating, time, costlth, costhtl ###
    //$ALLOW_SERVICE_PROVIDER_AMOUNT = $CONFIG_OBJ->getConfigurations("configurations","ALLOW_SERVICE_PROVIDER_AMOUNT");
    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query Start
    $iVehicleCategoryId = 0;
    $vehicleTypeData = $vehicleCatDataArr = array();
    if ($iVehicleTypeId > 0) {
        $vehicleTypeData = $obj->MySQLSelect("SELECT iVehicleCategoryId,eFareType,fPricePerHour,fFixedFare,fMinHour FROM `vehicle_type` WHERE iVehicleTypeId='" . $iVehicleTypeId . "'");
        if (count($vehicleTypeData) > 0) {
            $iVehicleCategoryId = $vehicleTypeData[0]['iVehicleCategoryId'];
        }
    }

    if ($iVehicleTypeId > 0 && strtoupper($eType) == "UBERX") {
        $vehicleTypeData = $obj->MySQLSelect("SELECT iVehicleTypeId, iVehicleCategoryId,eFareType,fPricePerHour,fFixedFare,fMinHour FROM `vehicle_type` WHERE iVehicleCategoryId = '" . $iVehicleTypeId . "'");
        $vehicleTypeIds = array_column($vehicleTypeData, 'iVehicleTypeId');
        $vehicleTypeIds = implode(",", $vehicleTypeIds);
    }
    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
    //$iVehicleCategoryId = get_value('vehicle_type', 'iVehicleCategoryId', 'iVehicleTypeId', $iVehicleTypeId, '', 'true');
    //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query Start
    if (isset($vehicleCategoryDataArr[$sql_vehicle_category_table_name])) {
        $getVehicleCatData = $vehicleCategoryDataArr[$sql_vehicle_category_table_name];
    } else {
        $getVehicleCatData = $obj->MySQLSelect("SELECT * FROM " . $sql_vehicle_category_table_name);
        $vehicleCategoryDataArr[$sql_vehicle_category_table_name] = $getVehicleCatData;
    }
    for ($h = 0; $h < count($getVehicleCatData); $h++) {
        $vehicleCatDataArr[$getVehicleCatData[$h]['iVehicleCategoryId']] = $getVehicleCatData[$h];
    }
    //$iParentId = get_value($sql_vehicle_category_table_name, 'iParentId', 'iVehicleCategoryId', $iVehicleCategoryId, '', 'true');
    $iParentId = 0;
    $ePriceType = "";
    if (isset($vehicleCatDataArr[$iVehicleCategoryId])) {
        $iParentId = $vehicleCatDataArr[$iVehicleCategoryId]['iParentId'];
    }
    if ($iParentId > 0) {
        if (isset($vehicleCatDataArr[$iParentId])) {
            $ePriceType = $vehicleCatDataArr[$iParentId]['ePriceType'];
        }
        //$ePriceType = get_value($sql_vehicle_category_table_name, 'ePriceType', 'iVehicleCategoryId', $iParentId, '', 'true');
    } else {
        //$ePriceType = get_value($sql_vehicle_category_table_name, 'ePriceType', 'iVehicleCategoryId', $iVehicleCategoryId, '', 'true');
        if (isset($vehicleCatDataArr[$iVehicleCategoryId]) && $iVehicleCategoryId > 0) {
            $ePriceType = $vehicleCatDataArr[$iVehicleCategoryId]['ePriceType'];
        }
    }
    //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
    $ALLOW_SERVICE_PROVIDER_AMOUNT = $ePriceType == "Provider" ? "Yes" : "No";
    //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr['register_user_' . $iUserId])) {
        $passengerData = $userDetailsArr['register_user_' . $iUserId];
    } else {
        $passengerData = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr['register_user_' . $iUserId] = $passengerData;
    }
    //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
    //Added By HJ On 07-07-2020 For Optimize currency Table Query Start
    $vCurrencyPassenger = $passengerData[0]['vCurrencyPassenger'];
    if (isset($currencyAssociateArr[$vCurrencyPassenger])) {
        $userCurrencyData = $currencyAssociateArr[$vCurrencyPassenger];
        $passengerData[0]['Ratio'] = $userCurrencyData['Ratio'];
        $passengerData[0]['vSymbol'] = $userCurrencyData['vSymbol'];
    }
    //Added By HJ On 07-07-2020 For Optimize currency Table Query End
    $vLang = $passengerData[0]['vLang'];
    $vCurrencyPassenger = $passengerData[0]['vCurrencyPassenger'];
    $vCurrencySymbol = $passengerData[0]['vSymbol'];
    $priceRatio = $passengerData[0]['Ratio'];
    if ($vLang == '') {
        //Added By HJ On 07-07-2020 For Optimize language_master Table Query Start
        $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 07-07-2020 For Optimize language_master Table Query End
    }
    $i = 0;
    // for hotel panel web
    $Removal_drivers_Positions = "";
    //Added By HJ On 07-07-2020 For Optimize driver_vehicle Table Query Start
    $data_driver = $driverIdArr = $driverVehicleArr = $serviceProAmtArr = array();
    for ($f = 0; $f < count($Data); $f++) {
        $driverIdArr[] = $Data[$f]['iDriverId'];
    }
    if (count($driverIdArr) > 0 && strtoupper($eType) == "UBERX") {
        $driverIds = implode(",", $driverIdArr);
        $driverVehicleData = $obj->MySQLSelect("SELECT iDriverVehicleId,iDriverId FROM `driver_vehicle` WHERE iDriverId IN ($driverIds) AND eType = 'UberX'");
        for ($j = 0; $j < count($driverVehicleData); $j++) {
            $driverVehicleArr[$driverVehicleData[$j]['iDriverId']][] = $driverVehicleData[$j];
        }
    }
    if ($iVehicleTypeId > 0) {
        $serviceProData = $obj->MySQLSelect("SELECT * FROM `service_pro_amount` WHERE iVehicleTypeId='" . $iVehicleTypeId . "'");
        for ($n = 0; $n < count($serviceProData); $n++) {
            $serviceProAmtArr[$serviceProData[$n]['iDriverVehicleId']][] = $serviceProData[$n];
        }
    }

    if ($MODULES_OBJ->isEnableVideoConsultingService() && $eType == "UberX" && $eForVideoConsultation == "Yes") {
        $service_data = $obj->MySQLSelect("SELECT iDriverId, eVideoConsultServiceCharge, eVideoConsultEnableProvider, eVideoServiceDescription, eStatus FROM driver_services_video_consult_charges WHERE iVehicleCategoryId = '$iVehicleTypeId'");

        $driver_services_vc = array();
        for ($n = 0; $n < count($service_data); $n++) {
            $driver_services_vc['PROVIDER_' . $service_data[$n]['iDriverId']] = $service_data[$n];
        }
    }
    //Added By HJ On 07-07-2020 For Optimize driver_vehicle Table Query End
    $count = count($Data);
    while ($count > $i) {
        if ($Data[$i]['vImage'] != "" && $Data[$i]['vImage'] != "NONE") {
            $Data[$i]['vImage'] = "3_" . $Data[$i]['vImage'];
        }
        $driverVehicleID = $Data[$i]['iDriverVehicleId'];
        if (strtoupper($eType) == "UBERX") {
            //$query = "SELECT iDriverVehicleId FROM `driver_vehicle` WHERE iDriverId = '" . $Data[$i]['iDriverId'] . "' AND eType = 'UberX'";
            //$result = $obj->MySQLSelect($query);
            $result = array();
            if (isset($driverVehicleArr[$Data[$i]['iDriverId']])) {
                $result = $driverVehicleArr[$Data[$i]['iDriverId']];
            }
            if (count($result) > 0) {
                $driverVehicleID = $result[0]['iDriverVehicleId'];
            }
        } else {
            $driverVehicleID = $Data[$i]['iDriverVehicleId'];
        }
        $Data[$i]['iDriverVehicleId'] = $driverVehicleID;
        $ssql1 = "";
        if ($eHandiCapAccessibilityWeb == 'Yes') {
            $ssql1 .= " AND eHandiCapAccessibility='Yes'";
        }
        $sql = "SELECT dv.iDriverVehicleId, dv.iDriverId, dv.iCompanyId, dv.iMakeId, dv.iModelId, dv.iYear, dv.vLicencePlate, dv.vColour, dv.eStatus, dv.vInsurance, dv.vRegisteration, dv.vPermit, dv.eCarX, dv.eCarGo, dv.vCarType, dv.vRentalCarType, dv.eHandiCapAccessibility, dv.eType, dv.eAddedDeliverVehicle, dv.eWheelChairAvailable, make.vMake AS make_title, model.vTitle AS model_title FROM `driver_vehicle` dv, make, model WHERE dv.iMakeId = make.iMakeId AND dv.iModelId = model.iModelId AND iDriverVehicleId='$driverVehicleID' $ssql1";
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            ChildSheetAvailability();
        }

        $rows_driver_vehicle = array();
        if ($eForVideoConsultation != "Yes") {
            $rows_driver_vehicle = $obj->MySQLSelect($sql);
        }
        $fAmount = "";
        if ($ALLOW_SERVICE_PROVIDER_AMOUNT == "Yes" && $SERVICE_PROVIDER_FLOW != "Provider") {
            //$sqlServicePro = "SELECT * FROM `service_pro_amount` WHERE iDriverVehicleId='" . $rows_driver_vehicle[0]['iDriverVehicleId'] . "' AND iVehicleTypeId='" . $iVehicleTypeId . "'";
            //$serviceProData = $obj->MySQLSelect($sqlServicePro);
            $serviceProData = array();
            if (isset($serviceProAmtArr[$rows_driver_vehicle[0]['iDriverVehicleId']])) {
                $serviceProData = $serviceProAmtArr[$rows_driver_vehicle[0]['iDriverVehicleId']];
            }
            //$vehicleTypeData = get_value('vehicle_type', 'eFareType,fPricePerHour,fFixedFare,fMinHour', 'iVehicleTypeId', $iVehicleTypeId);
            if ($vehicleTypeData[0]['eFareType'] == "Fixed") {
                $fAmount = formateNumAsPerCurrency(($vehicleTypeData[0]['fFixedFare'] * $priceRatio), $vCurrencyPassenger);
            } else if ($vehicleTypeData[0]['eFareType'] == "Hourly") {
                $fAmount = formateNumAsPerCurrency(($vehicleTypeData[0]['fPricePerHour'] * $priceRatio), $vCurrencyPassenger) . "/hour";
            }
            if (count($serviceProData) > 0) {
                $fAmount = formatNum($serviceProData[0]['fAmount'] * $priceRatio);
                if ($vehicleTypeData[0]['eFareType'] == "Fixed") {
                    $fAmount = formateNumAsPerCurrency($fAmount, $vCurrencyPassenger);
                } else if ($vehicleTypeData[0]['eFareType'] == "Hourly") {
                    $fAmount = formateNumAsPerCurrency($fAmount, $vCurrencyPassenger) . "/hour";
                }
            }
            $rows_driver_vehicle[0]['fAmount'] = $fAmount;
            $rows_driver_vehicle[0]['eFareType'] = $vehicleTypeData[0]['eFareType'];
            $rows_driver_vehicle[0]['fMinHour'] = $vehicleTypeData[0]['fMinHour'];
            $rows_driver_vehicle[0]['vCurrencySymbol'] = $vCurrencySymbol;
        }
        $unsetArr = 0;
        $addVideoConsultProvider = "No";
        if ($MODULES_OBJ->isEnableVideoConsultingService() && $eType == "UberX" && $eForVideoConsultation == "Yes") {
            // $video_consult_data = $VIDEO_CONSULT_OBJ->getServiceDetails($Data[$i]['iDriverId'], $iVehicleTypeId);
            $video_consult_data = array();
            $video_consult_data['eVideoConsultServiceCharge'] = 0;
            $video_consult_data['eVideoConsultEnableProvider'] = "No";
            $video_consult_data['eVideoConsultStatus'] = "Inactive";
            if(isset($driver_services_vc['PROVIDER_' . $Data[$i]['iDriverId']])) {
                $video_consult_data = $driver_services_vc['PROVIDER_' . $Data[$i]['iDriverId']];
                $video_consult_data['eVideoConsultStatus'] = $driver_services_vc['PROVIDER_' . $Data[$i]['iDriverId']]['eStatus'];
            }
            $Data[$i]['eVideoConsultEnable'] = $vehicleCatDataArr[$iVehicleTypeId]['eVideoConsultEnable'];
            $rows_driver_vehicle[0]['fAmount'] = formateNumAsPerCurrency($vehicleCatDataArr[$iVehicleTypeId]['eVideoConsultServiceCharge'] * $priceRatio, $vCurrencyPassenger);
            if ($video_consult_data['eVideoConsultEnableProvider'] == 'Yes' && $video_consult_data['eVideoConsultStatus'] == "Active") {
                $rows_driver_vehicle[0]['fAmount'] = formateNumAsPerCurrency($video_consult_data['eVideoConsultServiceCharge'] * $priceRatio, $vCurrencyPassenger);
                $addVideoConsultProvider = "Yes";
            } else {
                $unsetArr = 1;
            }
        }
        $Data[$i]['DriverCarDetails'] = array();
        if (isset($rows_driver_vehicle[0])) {
            $Data[$i]['DriverCarDetails'] = $rows_driver_vehicle[0];
        }
        // for hotel panel web
        if ($isFromHotelPanel == 'Yes' || ($isFromAdminPanel == 'Yes' && strtoupper($eType) != "UBERX")) { //added by SP on 09-01-2021 put uberx condition becoz for uberx if any cartype not match it will be removed and it is not needed.
            $isRemoveDriverIntoList = "No";
            $DriverVehicleTypeArrNew = explode(",", $rows_driver_vehicle[0]['vCarType']);
            if (!in_array($iVehicleTypeId, $DriverVehicleTypeArrNew)) {
                $isRemoveDriverIntoList = "Yes";
            }
            if ($isRemoveDriverIntoList == "Yes") {
                unset($Data[$i]);
                $unsetArr = 1;
                //$Data = array_values(array_filter($Data));
            }
        }
        /* For DriverSubscription added by SP start for solving issue#1838, in driver list if driver not subscribed then not shown in later booking. */
        if ($MODULES_OBJ->isDriverSubscriptionModuleAvailable()) {
            $returnSubStatus = 0;
            $returnSubStatus = checkDriverSubscribed($Data[$i]['iDriverId']);
            if ($returnSubStatus == 1) {
                unset($Data[$i]);
                $unsetArr = 1;
            } else if ($returnSubStatus == 2) {
                unset($Data[$i]);
                $unsetArr = 1;
            }
        }
        //Added By HJ On 24-01-2019 For Check Driver Vehicle Service Available Or Not Start
        if ($SERVICE_PROVIDER_FLOW == "Provider" && $eType == "UberX") {
            if (!empty($rows_driver_vehicle) || $addVideoConsultProvider == "Yes") {
                $serviceStatus = getServiceProviderVehicleData($rows_driver_vehicle, $vehicleTypeIds);
                if (($serviceStatus == "Success" || $addVideoConsultProvider == "Yes") && $unsetArr == 0) {
                    $data_driver[] = $Data[$i];
                }
            }
        } else if ($unsetArr == 0) {
            $data_driver[] = $Data[$i];
        }
        //Added By HJ On 24-01-2019 For Check Driver Vehicle Service Available Or Not End
        $i++;
    }
    $where = " iUserId='" . $iUserId . "'";
    $data['vLatitude'] = $passengerLat;
    $data['vLongitude'] = $passengerLon;
    $data['vRideCountry'] = $vCountryCode;
    $data['tLastOnline'] = @date("Y-m-d H:i:s");
    $obj->MySQLQueryPerform("register_user", $data, 'update', $where);
    # Update User Location Date #
    Updateuserlocationdatetime($iUserId, "Passenger", $vTimeZone);
    # Update User Location Date #
    $returnArr['NextPage'] = 0;
    $returnArr['page'] = $page;
    $returnArr['AvailableCabList'] = $data_driver;
    $returnArr['PassengerLat'] = $passengerLat;
    $returnArr['PassengerLon'] = $passengerLon;
    // kiosk changes
    $ssql = "";
    if (strtolower($_REQUEST['GeneralUserType']) == 'hotel' || strtolower($_REQUEST['GeneralUserType']) == 'kiosk') {
        $ssql .= " AND eType = 'Ride' AND ePoolStatus = 'No'";
    } else {
        if (!empty($eType)) {
            if ($eType == "Delivery" || $eType == "Deliver") {
                $ssql .= " AND eType = 'Deliver'";
            } else {
                $ssql .= " AND eType = '" . $eType . "'";
            }
        } else {
            if ($APP_TYPE == "Delivery") {
                $ssql .= " AND eType = 'Deliver'";
            } else if ($APP_TYPE == "Ride-Delivery") {
                $ssql .= " AND ( eType = 'Deliver' OR eType = 'Ride')";
            } else if ($APP_TYPE == "Ride-Delivery-UberX") {
                $ssql .= " AND ( eType = 'Deliver' OR eType = 'Ride')";
            } else {
                $ssql .= " AND eType = '" . $APP_TYPE . "'";
            }
        }
    }
    $alldeliveryvehicleshowninWEB = "No";
    if ($eType == 'Deliver' && isset($_REQUEST['bookingFrom']) && $_REQUEST['bookingFrom'] == "Web") {
        $alldeliveryvehicleshowninWEB = "Yes";
        if ($MODULES_OBJ->isEnableMultiDeliveryInBooking()) {
            $alldeliveryvehicleshowninWEB = "No";
        }
    }
    if (($APP_TYPE == "Ride-Delivery-UberX" || $APP_TYPE == "Ride-Delivery" || $APP_TYPE == "Ride" || $APP_TYPE == "Delivery") && ($alldeliveryvehicleshowninWEB == "No")) {
        if (strtoupper($eForMedicalService) == "YES") {
            $ssql .= " AND eIconType = 'Ambulance' ";
        } else {
            $CheckRideDelivery = CheckRideDeliveryFeatureDisable();
            if ($eShowOnlyMoto == "Yes") {
                $ssql .= " AND (eIconType = 'Bike' OR eIconType = 'Cycle')";
            } else {
                if ($eRental == "No") {
                    if (($eType == 'Ride' && $CheckRideDelivery['eMotoRideEnable'] == "No") || ($eRental == "Yes" && $CheckRideDelivery['eMotoRentalEnable'] == "No") || ($eType == 'Deliver' && $CheckRideDelivery['eMotoDeliveryEnable'] == "No")) {
                        $ssql .= " AND eIconType != 'Ambulance'";
                    } else {
                        $ssql .= " AND eIconType != 'Bike' AND eIconType != 'Cycle' AND eIconType != 'Ambulance'";
                    }
                } else {
                    if ($CheckRideDelivery['eRentalEnable'] == "No" && $CheckRideDelivery['eMotoRentalEnable'] == "No") {
                        $ssql .= " AND eIconType != 'Ambulance'";
                    } else {
                        $ssql .= " AND eIconType != 'Bike' AND eIconType != 'Cycle' AND eIconType != 'Ambulance'";
                    }
                }
            }
        }
    }
    //added by SP for fly stations on 19-08-2019
    if ($eFly == 'Yes') {
        $ssql .= " AND eFly = '1'";
    } else {
        $ssql .= " AND eFly = '0'";
    }
    $pickuplocationarr = array($passengerLat, $passengerLon);
    $GetVehicleIdfromGeoLocation = FetchVehicleTypeFromGeoLocation($pickuplocationarr);
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $ssql = LoadAvailableCabVehicleQuery($ssql);
    }
    //Added By HJ On 30-12-2018 For Check POOL Status End
    if ($bookingFrom == 'Web') {
        $ssql .= " AND ePoolStatus = 'No'";
    }
    if (strtoupper($isRidePool) == "YES") {
        $ssql .= " AND ePoolStatus = 'Yes'";
    }
    $vehicleTypes = $obj->MySQLSelect("SELECT * FROM `vehicle_type` WHERE iLocationid IN ($GetVehicleIdfromGeoLocation) $ssql AND eStatus = 'Active' ORDER BY iDisplayOrder ASC");
    //added by SP for fly stations on 19-08-2019, its bc fly vehicles are shown only if price in location wise fare is entered
    if ($eFly == 'Yes') {
        //fly_location_wise_fare.iFromLocationId
        if (!empty($iFromLocationId)) $ssql .= " AND fly_location_wise_fare.iFromLocationId = $iFromLocationId AND fly_location_wise_fare.iToLocationId = $iToLocationId"; //becoz vehicles are shown of source location only..if enter iscon then show vehicles which have from station iscon, and also add for it destination
        $sql1 = "SELECT tCentroidLattitude,tCentroidLongitude FROM  `location_master` WHERE 1=1 AND eStatus = 'Active' AND iLocationId = " . $iFromLocationId . " AND eFor = 'FlyStation'";
        $db_data_vehicle = $obj->MySQLSelect($sql1);
        $latlong = array($db_data_vehicle[0]['tCentroidLattitude'], $db_data_vehicle[0]['tCentroidLongitude']);
        $vtype = FetchVehicleTypeFromGeoLocation($latlong);
        $vtypeArr = explode(',', $vtype);
        $sql1to = "SELECT tCentroidLattitude,tCentroidLongitude FROM  `location_master` WHERE 1=1 AND eStatus = 'Active' AND iLocationId = $iToLocationId AND eFor = 'FlyStation'";
        $db_data_vehicleto = $obj->MySQLSelect($sql1to);
        $latlongto = array($db_data_vehicleto[0]['tCentroidLattitude'], $db_data_vehicleto[0]['tCentroidLongitude']);
        $vtypeto = FetchVehicleTypeFromGeoLocation($latlongto);
        $vtypeArrto = explode(',', $vtypeto);
        $result = array_intersect($vtypeArr, $vtypeArrto);
        if (!empty($result)) {
            $ilocation_id = implode("','", $result);
        }
        $vehicleTypes = $obj->MySQLSelect("SELECT DISTINCT(vehicle_type.iVehicleTypeId),vehicle_type.* FROM vehicle_type RIGHT JOIN fly_location_wise_fare ON vehicle_type.iVehicleTypeId = fly_location_wise_fare.iVehicleTypeId WHERE vehicle_type.iLocationid IN ('$ilocation_id') $ssql AND vehicle_type.eStatus = 'Active' AND fly_location_wise_fare.eStatus = 'Active'");
    }

    $db_label = $obj->MySQLSelect("SELECT vValue FROM `language_label` WHERE vLabel = 'LBL_CURRENT_PERSON_LIMIT' AND vCode = '" . $vLang . "'");
    for ($i = 0; $i < count($vehicleTypes); $i++) {
        $Photo_Gallery_folder = $tconfig["tsite_upload_images_vehicle_type_path"] . '/' . $vehicleTypes[$i]['iVehicleTypeId'] . '/android/' . $vehicleTypes[$i]['vLogo'];
        if ($vehicleTypes[$i]['vLogo'] != "" && file_exists($Photo_Gallery_folder)) {
            $vehicleTypes[$i]['vLogo'] = $vehicleTypes[$i]['vLogo'];
        } else {
            $vehicleTypes[$i]['vLogo'] = "";
        }
        $vehicleTypes[$i]['fPricePerKM'] = setTwoDecimalPoint($vehicleTypes[$i]['fPricePerKM'] * $priceRatio);
        $vehicleTypes[$i]['fPricePerMin'] = setTwoDecimalPoint($vehicleTypes[$i]['fPricePerMin'] * $priceRatio);
        $vehicleTypes[$i]['iBaseFare'] = setTwoDecimalPoint($vehicleTypes[$i]['iBaseFare'] * $priceRatio);
        $vehicleTypes[$i]['fCommision'] = setTwoDecimalPoint($vehicleTypes[$i]['fCommision'] * $priceRatio);
        $vehicleTypes[$i]['iMinFare'] = setTwoDecimalPoint($vehicleTypes[$i]['iMinFare'] * $priceRatio);
        $vehicleTypes[$i]['FareValue'] = setTwoDecimalPoint($vehicleTypes[$i]['fFixedFare'] * $priceRatio);
        $vehicleTypes[$i]['vVehicleType'] = $vehicleTypes[$i]["vVehicleType_" . $vLang];
        /* Added For Rental */
        $vehicleTypes[$i]['eRental'] = 'No';
        if ($eType == "Ride" && strtoupper(PACKAGE_TYPE) != "STANDARD" && ENABLE_RENTAL_OPTION == "Yes") {
            $vehicleTypes[$i]['vRentalVehicleTypeName'] = $vehicleTypes[$i]["vRentalAlias_" . $vLang] != '' ? $vehicleTypes[$i]["vRentalAlias_" . $vLang] : $vehicleTypes[$i]["vVehicleType_" . $vLang];
            $vehicleTypes[$i]['eRental'] = isRentalEnable($vehicleTypes[$i]['iVehicleTypeId']);
        }
        /* End Added For Rental */
        $person_limit = $vehicleTypes[$i]['iPersonSize'];
        
        $vehicleTypes[$i]['RESTRICT_PASSENGER_LIMIT_NOTE'] = str_replace('#PERSON_LIMIT#', $person_limit, $db_label[0]['vValue']);
        if (!$MODULES_OBJ->isEnableDeliveryHelper()) {
            $vehicleTypes[$i]['eDeliveryHelper'] = "No";
        }
        if (!empty($vehicleTypes[$i]['tDeliveryHelperNoteUser'])) {
            $tDeliveryHelperNoteUser = json_decode($vehicleTypes[$i]['tDeliveryHelperNoteUser'], true);
            $vehicleTypes[$i]['tDeliveryHelperNoteUser'] = $tDeliveryHelperNoteUser['tDeliveryHelperNoteUser_' . $vLang];
        }
        if (!empty($vehicleTypes[$i]['tInfoText'])) {
            $tInfoText = json_decode($vehicleTypes[$i]['tInfoText'], true);
            $vehicleTypes[$i]['tInfoText'] = $tInfoText['tInfoText_' . $vLang];
        }
    }
    if (strtoupper(PACKAGE_TYPE) != "STANDARD") {
        $vehicleTypes = validateVehicleTypes($vehicleTypes);
    }
    if (strtoupper($isRidePool) == "YES") {
        $ePoolStatus = array_column($vehicleTypes, 'ePoolStatus');
        array_multisort($ePoolStatus, SORT_DESC, $vehicleTypes);
    }
    if ($eType == "UberX") {
        $returnArr['VehicleTypes'] = array();
    } else {
        $returnArr['VehicleTypes'] = $vehicleTypes;
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "getDriverStates") {


    $driverId = isset($_REQUEST['iDriverId']) ? clean($_REQUEST['iDriverId']) : '';
    $userType = isset($_REQUEST['UserType']) ? clean($_REQUEST['UserType']) : 'Driver';
    $ssql = "";
    $docUpload = $driverVehicleUpload = $driverStateActive = $driverVehicleDocumentUpload = 'Yes';
    $driverData = $obj->MySQLSelect("SELECT vLang, vCountry FROM register_driver WHERE iDriverId = '$driverId'");
    $vCountry = $driverData[0]['vCountry'];
    $vLang = $driverData[0]['vLang'];
    // $sql1 = "SELECT dm.doc_masterid masterid, dm.doc_usertype , dm.doc_name ,dm.ex_status,dm.status,dm.eType, COALESCE(dl.doc_id,  '' ) as doc_id,COALESCE(dl.doc_masterid, '') as masterid_list ,COALESCE(dl.ex_date, '') as ex_date,COALESCE(dl.doc_file, '') as doc_file, COALESCE(dl.status, '') as docstatus FROM document_master dm left join (SELECT * FROM `document_list` where doc_userid='" . $driverId . "' ) dl on dl.doc_masterid=dm.doc_masterid where dm.doc_usertype='driver' and (dm.country='" . $vCountry . "' OR dm.country='All') and dm.status='Active' $ssql";
    $ufxDocCondition = " AND dm.eDocServiceType!='ServiceSpecific' AND dm.eType!='UberX'";
    if ($MODULES_OBJ->isUfxFeatureAvailable() == 'Yes') {
        $ufxDocCondition = "";
    }
    $sql1 = "SELECT IF(dm.iVehicleCategoryId > 0,vc.vCategory_" . $vLang . ", '') as eServiceTypeWiseDoc  ,dm.doc_masterid masterid, dm.doc_usertype , dm.doc_name ,dm.ex_status,dm.status, dl.doc_masterid masterid_list ,dl.ex_date,dl.doc_file ,dl.req_date,dl.doc_id,dl.req_file, dl.status,dm.eType,dm.iVehicleCategoryId,vc.vCategory_" . $vLang . " as vCategory,dm.eDocServiceType, COALESCE(dl.status, '') as docstatus FROM document_master dm left join (SELECT * FROM `document_list` where doc_userid='" . $driverId . "' ) dl on dl.doc_masterid=dm.doc_masterid LEFT JOIN vehicle_category vc on vc.iVehicleCategoryId = dm.iVehicleCategoryId where dm.doc_usertype='driver' and dm.status='Active' $ufxDocCondition and (dm.country ='" . $vCountry . "' OR dm.country ='All')";
    $db_document = $obj->MySQLSelect($sql1);
    if ($MODULES_OBJ->isEnableAppHomePageListView()) {
        $providerDocumentServiceCategoryArray = getProviderDocumentServiceWise($iMemberId, $db_document);
        $db_document = $providerDocumentServiceCategoryArray;
    }
    $docUpload = 'No';
    if (count($db_document) > 0) {
        if ($APP_TYPE == "Ride-Delivery-UberX") {
            $ride_document_array = array();
            $delivery_document_array = array();
            $uberx_document_array = array();
            for ($i = 0; $i < count($db_document); $i++) {
                if ($db_document[$i]['eType'] == "Ride") {
                    array_push($ride_document_array, $db_document[$i]);
                }
                if ($db_document[$i]['eType'] == "Delivery") {
                    array_push($delivery_document_array, $db_document[$i]);
                }
                if ($db_document[$i]['eType'] == "UberX") {
                    array_push($uberx_document_array, $db_document[$i]);
                }
            }
            $isAllDocumentUpload = false;
            for ($i = 0; $i < count($ride_document_array); $i++) {
                $isAllDocumentUpload = ($ride_document_array[$i]['doc_file'] != "") ? true : false;
            }
            if ($isAllDocumentUpload == false) {
                for ($i = 0; $i < count($delivery_document_array); $i++) {
                    $isAllDocumentUpload = ($delivery_document_array[$i]['doc_file'] != "") ? true : false;
                }
            }
            if ($isAllDocumentUpload == false) {
                for ($i = 0; $i < count($uberx_document_array); $i++) {
                    $isAllDocumentUpload = ($uberx_document_array[$i]['doc_file'] != "") ? true : false;
                }
            }
            $docUpload = ($isAllDocumentUpload == true) ? "Yes" : "No";
        } elseif ($APP_TYPE == "Ride-Delivery") {
            $ride_document_array = array();
            $delivery_document_array = array();
            for ($i = 0; $i < count($db_document); $i++) {
                if ($db_document[$i]['eType'] == "Ride") {
                    array_push($ride_document_array, $db_document[$i]);
                }
                if ($db_document[$i]['eType'] == "Delivery") {
                    array_push($delivery_document_array, $db_document[$i]);
                }
            }
            $isAllDocumentUpload = false;
            for ($i = 0; $i < count($ride_document_array); $i++) {
                $isAllDocumentUpload = ($ride_document_array[$i]['doc_file'] != "") ? true : false;
            }
            if ($isAllDocumentUpload == false) {
                for ($i = 0; $i < count($delivery_document_array); $i++) {
                    $isAllDocumentUpload = ($delivery_document_array[$i]['doc_file'] != "") ? true : false;
                }
            }
            $docUpload = ($isAllDocumentUpload == true) ? "Yes" : "No";
        } else {
            for ($i = 0; $i < count($db_document); $i++) {
                if ($db_document[$i]['doc_file'] == "") {
                    $docUpload = 'No';
                    break;
                } else {
                    $docUpload = 'Yes';
                }
            }
        }
    } else {
        $docUpload = 'No';
    }
    if ($APP_TYPE != 'UberX') {
        ## Count Driver Vehicle ##
        $db_Total_vehicle = $obj->MySQLSelect("SELECT count(iDriverVehicleId) as TotalVehicles from driver_vehicle WHERE iDriverId = '" . $driverId . "' AND eStatus != 'Deleted'");
        $TotalVehicles = $db_Total_vehicle[0]['TotalVehicles'];
        $returnArr['TotalVehicles'] = strval($TotalVehicles);
        ## Count Driver Vehicle ##
        $db_drv_vehicle = $obj->MySQLSelect("SELECT iDriverVehicleId from driver_vehicle WHERE iDriverId = '" . $driverId . "' AND eStatus != 'Deleted'");
        if (count($db_drv_vehicle) == 0) {
            $driverVehicleUpload = 'No';
        } else if ($driverVehicleUpload != 'No') {
            $test = array();
            # Check For Driver's selected vehicle's document are upload or not #
            $db_selected_vehicle = $obj->MySQLSelect("SELECT dl.*,dv.iDriverVehicleId FROM `driver_vehicle` AS dv LEFT JOIN document_list as dl ON dl.doc_userid=dv.iDriverVehicleId WHERE dv.iDriverId='$driverId' AND dl.doc_usertype = 'car' AND dv.eStatus != 'Deleted' ");
            if (count($db_selected_vehicle) > 0) {
                for ($i = 0; $i < count($db_selected_vehicle); $i++) {
                    if ($db_selected_vehicle[$i]['doc_file'] == "") {
                        $test[] = '1';
                    }
                }
            }
            if (count($test) == count($db_selected_vehicle)) {
                $driverVehicleUpload = 'No';
            }
        }
    } else {
        $db_drv_vehicle = $obj->MySQLSelect("SELECT vCarType from driver_vehicle WHERE iDriverId = '" . $driverId . "'");
        $driverVehicleUpload = 'Yes';
        if ($db_drv_vehicle[0]['vCarType'] == "") {
            $driverVehicleUpload = 'No';
        }
    }
    $Data = $obj->MySQLSelect("SELECT rd.eStatus as driverstatus,cmp.eStatus as cmpEStatus FROM `register_driver` as rd,`company` as cmp WHERE rd.iDriverId='" . $driverId . "' AND cmp.iCompanyId=rd.iCompanyId");
    if (strtolower($Data[0]['driverstatus']) != "active" || strtolower($Data[0]['cmpEStatus']) != "active") {
        $driverStateActive = 'No';
    }
    if ($APP_TYPE == "UberX" || $APP_TYPE == "Ride-Delivery-UberX") {
        $sql = "select * from `driver_manage_timing` where iDriverId = '" . $driverId . "'";
        $db_driver_timing = $obj->MySQLSelect($sql);
        if (count($db_driver_timing) > 0) {
            $returnArr['IS_DRIVER_MANAGE_TIME_AVAILABLE'] = "Yes";
        } else {
            $returnArr['IS_DRIVER_MANAGE_TIME_AVAILABLE'] = "No";
        }
    }
    if ($driverStateActive == "Yes") {
        $docUpload = "Yes";
        $driverVehicleUpload = "Yes";
        $driverVehicleDocumentUpload = "Yes";
        $returnArr['IS_DRIVER_MANAGE_TIME_AVAILABLE'] = "Yes";
    }
    $returnArr['Action'] = "1";
    $returnArr['IS_VEHICLE_PROCESS_COMPLETED'] = $driverVehicleUpload;
    $returnArr['IS_DOCUMENT_PROCESS_COMPLETED'] = $docUpload;
    $returnArr['IS_VEHICLE_DOCUMENT_PROCESS_COMPLETED'] = $driverVehicleDocumentUpload;
    $returnArr['IS_DRIVER_STATE_ACTIVATED'] = $driverStateActive;
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "CheckPromoCode") {
    $eType = isset($_REQUEST['eType']) ? $_REQUEST['eType'] : '';
    $vSourceLatitude = isset($_REQUEST['vSourceLatitude']) ? $_REQUEST['vSourceLatitude'] : '';
    $vSourceLongitude = isset($_REQUEST['vSourceLongitude']) ? $_REQUEST['vSourceLongitude'] : '';
    $vDestLatitude = isset($_REQUEST['vDestLatitude']) ? $_REQUEST['vDestLatitude'] : '';
    $vDestLongitude = isset($_REQUEST['vDestLongitude']) ? $_REQUEST['vDestLongitude'] : '';
    $tDeliveryLocations = isset($_REQUEST['tDeliveryLocations']) ? $_REQUEST['tDeliveryLocations'] : '';
    $eForVideoConsultation = isset($_REQUEST["eForVideoConsultation"]) ? $_REQUEST["eForVideoConsultation"] : 'No';
    $GeneralMemberId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $GeneralUserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : '';
    $isRemovePromocode = isset($_REQUEST["isRemovePromocode"]) ? $_REQUEST["isRemovePromocode"] : 'No';
    if ($eType == "Ride" && strtoupper($isRemovePromocode) == "YES") {
        $payment_mode_user_data = $obj->MySQLSelect("SELECT * FROM payment_mode_user_log WHERE iMemberId = '$GeneralMemberId' AND eUserType = '$GeneralUserType' AND eType = 'Ride' ORDER BY dDateTime DESC LIMIT 1");
        if (!empty($payment_mode_user_data) && count($payment_mode_user_data) > 0) {
            $obj->sql_query("UPDATE payment_mode_user_log SET vPromocode = '' WHERE iMemberId = '$GeneralMemberId' AND eUserType = '$GeneralUserType' AND eType = 'Ride'");
        }
        $returnArr['Action'] = "1";
        $returnArr["message"] = "LBL_PROMO_REMOVED";
        setDataResponse($returnArr);
    }
    $validPromoCodesArr = getValidPromoCodes();
    if (!empty($validPromoCodesArr) && !empty($validPromoCodesArr['CouponList']) && count($validPromoCodesArr['CouponList']) > 0) {
        $returnArr['Action'] = "1"; // code is valid
        $returnArr["message"] = "LBL_SUCCESS_COUPON_CODE";
        if ($MODULES_OBJ->isEnableLocationWisePromoCode() && $validPromoCodesArr['CouponList'][0]['iLocationId'] > 0) {
            $Source_Address_Array = array($vSourceLatitude, $vSourceLongitude);
            $Dest_Address_Array = array($vDestLatitude, $vDestLongitude);
            $iLocationIdSource = GetUserGeoLocationIdPromoCode($Source_Address_Array);
            $iLocationIdDest = GetUserGeoLocationIdPromoCode($Dest_Address_Array);
            if ((($eType == "Ride" || $eType == "Deliver") && (!in_array($validPromoCodesArr['CouponList'][0]['iLocationId'], $iLocationIdSource) || !in_array($validPromoCodesArr['CouponList'][0]['iLocationId'], $iLocationIdDest))) || ($eType == "UberX" && !in_array($validPromoCodesArr['CouponList'][0]['iLocationId'], $iLocationIdDest)) || $eForVideoConsultation == "Yes") {
                $returnArr['Action'] = "0"; // code is invalid
                $returnArr["message"] = "LBL_INVALID_COUPON_CODE";
                setDataResponse($returnArr);
            } elseif ($eType == "Multi-Delivery" && $validPromoCodesArr['CouponList'][0]['iLocationId'] > 0) {
                // $tDeliveryLocations = json_decode(str_replace("\\", "", $tDeliveryLocations), true);
                $tDeliveryLocations = json_decode($tDeliveryLocations, true);
                $tDeliveryLocationsArr = array();
                $tDeliveryLocationsArr[] = array('latitude' => $vSourceLatitude, 'longitude' => $vSourceLongitude,);
                foreach ($tDeliveryLocations as $location) {
                    if (isset($location['vReceiverLatitude'])) {
                        $tDeliveryLocationsArr[] = array('latitude' => $location['vReceiverLatitude'], 'longitude' => $location['vReceiverLongitude'],);
                    }
                }
                foreach ($tDeliveryLocationsArr as $loc) {
                    $Address_Array = array($loc['latitude'], $loc['longitude']);
                    $iLocationIdArr = GetUserGeoLocationIdPromoCode($Address_Array);
                    if (!in_array($validPromoCodesArr['CouponList'][0]['iLocationId'], $iLocationIdArr)) {
						$returnArr['Action'] = "0"; // code is invalid
                        $returnArr["message"] = "LBL_INVALID_COUPON_CODE";
                        setDataResponse($returnArr);
                    }
                }
            }
        }
        if ($returnArr['Action'] == "1" && $eType == "Ride") {
            $payment_mode_user_data = $obj->MySQLSelect("SELECT * FROM payment_mode_user_log WHERE iMemberId = '$GeneralMemberId' AND eUserType = '$GeneralUserType' AND eType = 'Ride' ORDER BY dDateTime DESC LIMIT 1");
            if (!empty($payment_mode_user_data) && count($payment_mode_user_data) > 0) {
                $obj->sql_query("UPDATE payment_mode_user_log SET vPromocode = '" . $_REQUEST['PromoCode'] . "' WHERE iMemberId = '$GeneralMemberId' AND eUserType = '$GeneralUserType' AND eType = 'Ride'");
            } else {
                $Data_insert['iMemberId'] = $GeneralMemberId;
                $Data_insert['eUserType'] = $GeneralUserType;
                $Data_insert['vPromocode'] = $_REQUEST['PromoCode'];
                $Data_insert['eType'] = 'Ride';
                $obj->MySQLQueryPerform('payment_mode_user_log', $Data_insert, 'insert');
            }
        }
        setDataResponse($returnArr);
    } else {
		 
        $returnArr['Action'] = "0"; // code is invalid
        $returnArr["message"] = "LBL_INVALID_COUPON_CODE";
        setDataResponse($returnArr);
    }
}
###########################################################################
if ($type == 'estimateFare') {
    $sourceLocation = isset($_REQUEST["sourceLocation"]) ? $_REQUEST["sourceLocation"] : '';
    $destinationLocation = isset($_REQUEST["destinationLocation"]) ? $_REQUEST["destinationLocation"] : '';
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $distance = isset($_REQUEST["distance"]) ? $_REQUEST["distance"] : '';
    $time = isset($_REQUEST["time"]) ? $_REQUEST["time"] : '';
    $SelectedCar = isset($_REQUEST["SelectedCar"]) ? $_REQUEST["SelectedCar"] : '';
    $sourceLocationArr = explode(",", $sourceLocation);
    $destinationLocationArr = explode(",", $destinationLocation);
    // changes for flattrip 29-01-2019
    $eType_vehicle = get_value('vehicle_type', 'eType', 'iVehicleTypeId', $SelectedCar, '', 'true');
    $passengerData = $obj->MySQLSelect("SELECT ru.vCurrencyPassenger,cu.Ratio FROM register_user as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE iUserId = '" . $iUserId . "'");
    $vCurrencyPassenger = $passengerData[0]['vCurrencyPassenger'];
    $priceRatio = $passengerData[0]['Ratio'];
    // changes for flattrip 29-01-2019
    $eFlatTrip = "No";
    $fFlatTripPrice = 0;
    if ($eType_vehicle == 'Ride' && strtoupper(PACKAGE_TYPE) != "STANDARD") {
        $data_flattrip = checkFlatTripnew($sourceLocationArr, $destinationLocationArr, $SelectedCar);
        $eFlatTrip = $data_flattrip['eFlatTrip'];
        $fFlatTripPrice = $data_flattrip['Flatfare'];
    }
    if ($eFlatTrip == "No") {
        $Fare_data = calculateApproximateFare($time, $distance, $SelectedCar, $iUserId, 1);
        $Fare_data[0]['Distance'] = $distance == NULL ? "0" : strval(round($distance, 2));
        $Fare_data[0]['Time'] = $time == NULL ? "0" : strval(round($time, 2));
        $Fare_data[0]['total_fare'] = number_format(round($Fare_data[0]['total_fare'] * $priceRatio, 1), 2);
        $Fare_data[0]['iBaseFare'] = number_format(round($Fare_data[0]['iBaseFare'] * $priceRatio, 1), 2);
        $Fare_data[0]['fPricePerMin'] = number_format(round($Fare_data[0]['fPricePerMin'] * $priceRatio, 1), 2);
        $Fare_data[0]['fPricePerKM'] = number_format(round($Fare_data[0]['fPricePerKM'] * $priceRatio, 1), 2);
        $Fare_data[0]['fCommision'] = number_format(round($Fare_data[0]['fCommision'] * $priceRatio, 1), 2);
        $Fare_data[0]['eFlatTrip'] = "No";
        if ($Fare_data[0]['MinFareDiff'] > 0) {
            $Fare_data[0]['MinFareDiff'] = number_format(round($Fare_data[0]['MinFareDiff'] * $priceRatio, 1), 2);
        } else {
            $Fare_data[0]['MinFareDiff'] = "0";
        }
        $Fare_data[0]['MinFareDiff'] = "0";
    } else {
        $Fare_data[0]['Distance'] = "0.00";
        $Fare_data[0]['Time'] = "0.00";
        $Fare_data[0]['total_fare'] = $fFlatTripPrice; //number_format(round($fFlatTripPrice * $priceRatio,1),2);
        $Fare_data[0]['iBaseFare'] = number_format(round($fFlatTripPrice * $priceRatio, 1), 2);
        $Fare_data[0]['fPricePerMin'] = "0.00";
        $Fare_data[0]['fPricePerKM'] = "0.00";
        $Fare_data[0]['fCommision'] = number_format(round($fFlatTripPrice * $priceRatio, 1), 2);
        $Fare_data[0]['eFlatTrip'] = "Yes";
        $Fare_data[0]['MinFareDiff'] = "0.00";
        $Fare_data[0]['Flatfare'] = $fFlatTripPrice;
    }
    $Fare_data[0]['Action'] = "1";
    setDataResponse($Fare_data[0]);
}
###########################################################################
if ($type == 'estimateFareNew') {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $distance = isset($_REQUEST["distance"]) ? $_REQUEST["distance"] : '';
    $time = isset($_REQUEST["time"]) ? $_REQUEST["time"] : '';
    $SelectedCar = isset($_REQUEST["SelectedCar"]) ? $_REQUEST["SelectedCar"] : '';
    $StartLatitude = isset($_REQUEST["StartLatitude"]) ? $_REQUEST["StartLatitude"] : '0.0';
    $EndLongitude = isset($_REQUEST["EndLongitude"]) ? $_REQUEST["EndLongitude"] : '0.0';
    $DestLatitude = isset($_REQUEST["DestLatitude"]) ? $_REQUEST["DestLatitude"] : '';
    $DestLongitude = isset($_REQUEST["DestLongitude"]) ? $_REQUEST["DestLongitude"] : '';
    $iQty = isset($_REQUEST["iQty"]) ? $_REQUEST["iQty"] : '1';
    $PromoCode = isset($_REQUEST["PromoCode"]) ? $_REQUEST["PromoCode"] : '';
    $SelectedCarTypeID = isset($_REQUEST["SelectedCarTypeID"]) ? $_REQUEST["SelectedCarTypeID"] : '';
    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? trim($_REQUEST['GeneralUserType']) : '';
    //added by SP for fly stations on 19-08-2019
    $eFly = isset($_REQUEST['eFly']) ? trim($_REQUEST['eFly']) : '';
    $iFromStationId = isset($_REQUEST['iFromStationId']) ? trim($_REQUEST['iFromStationId']) : '';
    $iToStationId = isset($_REQUEST['iToStationId']) ? trim($_REQUEST['iToStationId']) : '';
    $ePaymentModerounding = isset($_REQUEST['ePaymentMode']) ? trim($_REQUEST['ePaymentMode']) : 'cash';
    if(empty($time)) {
        $time = 0;
    }
    if(empty($distance)) {
        $distance = 0;
    }
    $time = setTwoDecimalPoint($time / 60);
    $distance = setTwoDecimalPoint($distance / 1000);
    $isDestinationAdded = "No";
    if ($DestLatitude != "" && $DestLongitude != "") {
        $isDestinationAdded = "Yes";
    }
    $sourceLocationArr = array($StartLatitude, $EndLongitude);
    $destinationLocationArr = array($DestLatitude, $DestLongitude);
    $eFlatTrip = "No";
    $fFlatTripPrice = 0;
    // kiosk changes
    if (strtolower($GeneralUserType) == 'hotel' || strtolower($GeneralUserType) == 'kiosk') {
        $iMemberId = isset($_REQUEST['iMemberId']) ? $_REQUEST['iMemberId'] : '';
        $iUserId = $iMemberId;
    }
    /* For New Payment Flow */
    $params = array("iMemberId" => $iUserId, "eUserType" => "Passenger", "eType" => "Ride", "GET_DATA" => "Yes");
    $payment_mode_data = GetPaymentModeDetails($params);
    $ePaymentModerounding = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
    $PromoCode = !empty($PromoCode) ? $PromoCode : $payment_mode_data['PromoCode'];
    /* For New Payment Flow End */
    $Fare_data = calculateApproximateFareGeneral($time, $distance, $SelectedCar, $iUserId, 1, "", "", $PromoCode, 1, 0, 0, 0, "", "Passenger", $iQty, $SelectedCarTypeID, $isDestinationAdded, $eFlatTrip, $fFlatTripPrice, $sourceLocationArr, $destinationLocationArr, '', '', '', $eFly, $iFromStationId, $iToStationId); //added by SP for fly stations on 19-08-2019 add 3 parameter
    $returnArr["Action"] = "1";
    $returnArr["message"] = $Fare_data;
    setDataResponse($returnArr);
}
###########################################################################
if ($type == 'getEstimateFareDetailsArr') {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $distance = isset($_REQUEST["distance"]) ? $_REQUEST["distance"] : '';
    $time = isset($_REQUEST["time"]) ? $_REQUEST["time"] : '';
    $SelectedCar = isset($_REQUEST["SelectedCar"]) ? $_REQUEST["SelectedCar"] : '';
    $StartLatitude = isset($_REQUEST["StartLatitude"]) ? $_REQUEST["StartLatitude"] : '0.0';
    $EndLongitude = isset($_REQUEST["EndLongitude"]) ? $_REQUEST["EndLongitude"] : '0.0';
    $DestLatitude = isset($_REQUEST["DestLatitude"]) ? $_REQUEST["DestLatitude"] : '';
    $DestLongitude = isset($_REQUEST["DestLongitude"]) ? $_REQUEST["DestLongitude"] : '';
    $promoCode = isset($_REQUEST['PromoCode']) ? clean($_REQUEST['PromoCode']) : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST['UserType'] : '';
    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? trim($_REQUEST['GeneralUserType']) : '';
    $isDestinationAdded = isset($_REQUEST['isDestinationAdded']) ? trim($_REQUEST['isDestinationAdded']) : 'Yes'; // Yes , No
    //added by SP for fly stations on 20-08-2019
    $eFly = isset($_REQUEST['eFly']) ? trim($_REQUEST['eFly']) : '';
    $iFromStationId = isset($_REQUEST['iFromStationId']) ? trim($_REQUEST['iFromStationId']) : '';
    $iToStationId = isset($_REQUEST['iToStationId']) ? trim($_REQUEST['iToStationId']) : '';
    $ePaymentModerounding = isset($_REQUEST['ePaymentMode']) ? trim($_REQUEST['ePaymentMode']) : 'cash';
    $bookingFrom = isset($_REQUEST['bookingFrom']) ? trim($_REQUEST['bookingFrom']) : 'App';//this parameter is to know this type is called from web so no need to call getpassengerDetails added by SP on 29-10-2020
    $UserTypeWeb = isset($_REQUEST["UserTypeWeb"]) ? $_REQUEST['UserTypeWeb'] : '';

    if ($bookingFrom == 'Web') {
        $userType = $UserTypeWeb;
    }
    if ($userType == "" || $userType == NULL) {
        $userType = $GeneralUserType;
    }
    if ($isDestinationAdded == "" || $isDestinationAdded == NULL) {
        $isDestinationAdded = "Yes";
    }
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST['eType'] : 'Ride';
    $details_arr = isset($_REQUEST["details_arr"]) ? $_REQUEST['details_arr'] : '';
    $totNoRecipient = isset($_REQUEST['totNoRecipient']) ? trim($_REQUEST['totNoRecipient']) : '1';
    $PassengerData = get_value('register_user', 'vCurrencyPassenger,vLang', 'iUserId', $iUserId);
    $vCurrencyPassenger = $PassengerData[0]['vCurrencyPassenger'];
    $vLang = $PassengerData[0]['vLang'];
    $vSymbol = get_value('currency', 'vSymbol', 'vName', $vCurrencyPassenger, '', 'true');
    $sourceLocationArr = array($StartLatitude, $EndLongitude);
    $destinationLocationArr = array($DestLatitude, $DestLongitude);
    /* For New Payment Flow */
    if($UserTypeWeb != "Company"){
        $params = array("iMemberId" => $iUserId, "eUserType" => "Passenger", "GET_DATA" => "Yes");
        $payment_mode_data = GetPaymentModeDetails($params);
        $ePaymentMode = $ePaymentModerounding = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
        $cashPayment = $ePaymentMode == "cash" ? "Yes" : "No";
        $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
        $isRestrictToWallet = $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
        $promoCode = !empty($promoCode) ? $promoCode : $payment_mode_data['PromoCode'];
    }
    /* For New Payment Flow End */
    ######### Checking For Flattrip #########
    $eFlatTrip = "No";
    $fFlatTripPrice = 0;
    if ($isDestinationAdded == "Yes" && $eType == "Ride" && strtoupper(PACKAGE_TYPE) != "STANDARD") {
        $data_flattrip = checkFlatTripnew($sourceLocationArr, $destinationLocationArr, $SelectedCar);
        $eFlatTrip = $data_flattrip['eFlatTrip'];
        $fFlatTripPrice = $data_flattrip['Flatfare'];
    }
    ######### Checking For Flattrip #########
    $delivery_arr = json_decode($details_arr, true);
    if (!empty($delivery_arr)) {
        $distance = $time = 0;
        for ($i = 0; $i < count($delivery_arr); $i++) {
            $distance1 = $delivery_arr[$i]['distance'];
            $time1 = $delivery_arr[$i]['time'];
            $distance += $distance1;
            $time += $time1;
        }
    }
    // kiosk changes
    if (strtolower($GeneralUserType) == 'hotel' || strtolower($GeneralUserType) == 'kiosk') {
        $iMemberId = isset($_REQUEST['iMemberId']) ? $_REQUEST['iMemberId'] : '';
        $iUserId = $iMemberId;
        $userType = 'Passenger';
    }
    $curr_date = @date("Y-m-d");
    $time = round(($time / 60), 2);
    //$time = round($time / 60);
    $distance = round(($distance / 1000), 2);
    $IS_RETURN_ARR_WITH_ORIG_AMT = "Yes"; //Added By HJ On 12-03-2020 For Get Origional Fare Amount For Use In app As Per Discuss with KS Sir
    $Fare_data = calculateApproximateFareGeneral($time, $distance, $SelectedCar, $iUserId, 1, "", "", $promoCode, 1, 0, 0, 0, "DisplySingleVehicleFare", $userType, 1, "", $isDestinationAdded, $eFlatTrip, $fFlatTripPrice, $sourceLocationArr, $destinationLocationArr, "", $eType, "", $eFly, $iFromStationId, $iToStationId); //added by SP for fly stations on 20-08-2019 add 3 parameter
    $IS_RETURN_ARR_WITH_ORIG_AMT = "No"; //Added By HJ On 12-03-2020 For Get Origional Fare Amount For Use In app As Per Discuss with KS Sir
    //Added By HJ On 12-03-2020 For Get Origional Fare Amount For Use In app As Per Discuss with KS Sir Start
    $total_fare_amount = str_replace(",", "", $Fare_data['org_fare_amount']);
    $Fare_data = $Fare_data['fare_data'];
    //Added By HJ On 12-03-2020 For Get Origional Fare Amount For Use In app As Per Discuss with KS Sir End
    array_pop($Fare_data);
    /*to solve issue when rouding is enable remove key total_fare_amount from array*/
    foreach ($Fare_data as $fkey => $fvalue) {
        foreach ($fvalue as $fk => $fval) {
            if ($fk == "total_fare_amount") {
                unset($Fare_data[$fkey]);
            }
        }
    }
    $Fare_data = array_values($Fare_data);
    /*to solve issue when rouding is enable*/
    $fOutStandingAmount = GetPassengerOutstandingAmount($iUserId);
    $returnArr["Action"] = "1";
    $returnArr["message"] = $Fare_data;
    $returnArr["distance_multi"] = $distance;
    $returnArr["time_multi"] = $time;
    $returnArr["vSymbol"] = $vSymbol;
    if (isset($details_arr)) {
        $sqlp = "SELECT cu.vName, cu.iCurrencyId, cu.eRoundingOffEnable FROM register_user AS ru LEFT JOIN currency AS cu ON ru.vCurrencyPassenger = cu.vName WHERE ru.iUserId = '" . $iUserId . "'";
        $currData = $obj->MySQLSelect($sqlp);
        //$amount = explode(" ", $total_fare_amount);
        $returnArr["total_fare_amount"] = $total_fare_amount;
        $EachRecipeintAmount = $total_fare_amount / $totNoRecipient;
        if ($currData[0]['eRoundingOffEnable'] == "Yes" && $ePaymentModerounding == 'cash' && $MODULES_OBJ->isEnableRoundingMethod()) {
            $roundingdata = getRoundingOffAmount($EachRecipeintAmount, $vCurrencyPassenger);
            //$returnArr["EachRecipeintAmount"] =  $roundingdata['finalFareValue']; // old // uncomment this again becoz in multi delivery after 2 delivery complete third one can not start issue#1919
            $returnArr["EachRecipeintAmount"] = formateNumAsPerCurrency($roundingdata['finalFareValue'], $vCurrencyPassenger);
            $returnArr["EachRecipeintAmount"] = setTwoDecimalPoint($roundingdata['finalFareValue']);
        } else {
            $returnArr["EachRecipeintAmount"] = setTwoDecimalPoint($EachRecipeintAmount);
        }
        //}
    } else {
        $returnArr["total_fare_amount"] = $total_fare_amount;
    }
    $returnArr['fOutStandingAmount'] = $fOutStandingAmount;
    // $returnArr['fOutStandingAmountWithSymbol'] = $vSymbol . " " . $fOutStandingAmount;
    $returnArr['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($fOutStandingAmount, $vCurrencyPassenger);
    //$getVehicleData = $obj->MySQLSelect("SELECT vLogo FROM vehicle_type WHERE iVehicleTypeId='" . $SelectedCar . "'");
    if ($vLang == "" || $vLang == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
    $getVehicleTypeData = get_value('vehicle_type', 'vLogo,tInfoText,eFly,eFareType', 'iVehicleTypeId', $SelectedCar);
    $getVehicleImage = $getVehicleTypeData[0]['vLogo'];
    $getVehicletInfoText = json_decode($getVehicleTypeData[0]['tInfoText'], true);
    $langlabelinfo = ($getVehicleTypeData[0]['eFly'] == 1 || $getVehicleTypeData[0]['eFareType'] == 'Fixed') ? $languageLabelsArr['LBL_GENERAL_NOTE_FLAT_FARE_EST'] : $languageLabelsArr['LBL_GENERAL_NOTE_FARE_EST'];
    $returnArr['tInfoText'] = !empty($getVehicletInfoText['tInfoText_' . $vLang]) ? $getVehicletInfoText['tInfoText_' . $vLang] : $langlabelinfo;
    //added by SP for new design on 10-9-2019
    $Photo_Gallery_folder = $tconfig["tsite_upload_images_vehicle_type_path"] . '/' . $SelectedCar . "/" . strtolower($_REQUEST['GeneralDeviceType']) . "/" . $getVehicleImage;
    if ($getVehicleImage != "" && file_exists($Photo_Gallery_folder)) {
        $returnArr['vehicleImage'] = $tconfig['tsite_upload_images_vehicle_type'] . "/" . $SelectedCar . "/" . strtolower($_REQUEST['GeneralDeviceType']) . "/" . $getVehicleImage;
    } else {
        $returnArr['vehicleImage'] = "";
    }
    //added by SP on 25-03-2021 for outstanding restriction start...
    $returnArr['ShowAdjustTripBtn'] = $returnArr['ShowPayNow'] = "Yes";
    $returnArr['ShowContactUsBtn'] = "No";
    if ($MODULES_OBJ->isEnableOutstandingRestriction()) {
        if ($userType == "Passenger" && $eType == "Multi-Delivery") {
            // if ($APP_PAYMENT_MODE == "Cash") {
            if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                $data['ShowPayNow'] = "No";
                $data['ShowAdjustTripBtn'] = "No";
                $data['ShowContactUsBtn'] = "Yes";
            }
            // if ($APP_PAYMENT_MODE == "Card" || $APP_PAYMENT_MODE == "Wallet") {
            if (strtoupper($CARD_AVAILABLE) == "YES" || strtoupper($WALLET_AVAILABLE) == "YES") {
                $data['ShowPayNow'] = "Yes";
                $data['ShowAdjustTripBtn'] = "No";
            }
            $iMemberId = $iUserId;
            // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
            if (strtoupper($ePayWallet) == "YES") {
                $outStandingSql = " AND eAuthoriseIdName='No' AND iAuthoriseId ='0'";
            }
            $sql = "SELECT count(iTripOutstandId) as counttrip FROM trip_outstanding_amount WHERE iUserId='" . $iMemberId . "' AND iUserId > 0 AND ePaidByPassenger = 'No' $outStandingSql";
            $counttripData = $obj->MySQLSelect($sql);
            if ($counttripData[0]['counttrip'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                // if ($APP_PAYMENT_MODE == "Cash") {
                if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                    $returnArr['outstanding_restriction_label'] = str_replace("##", $returnArr['fOutStandingAmountWithSymbol'], $languageLabelsArr["LBL_OUTSTANDING_RESTRICTION_MSG"]);
                    $returnArr['ShowAdjustTripBtn'] = "No";
                }
                // if ($APP_PAYMENT_MODE == "Card" || $APP_PAYMENT_MODE == "Wallet") {
                if (strtoupper($CARD_AVAILABLE) == "YES" || strtoupper($WALLET_AVAILABLE) == "YES") {
                    $returnArr['outstanding_restriction_label'] = str_replace("##", $returnArr['fOutStandingAmountWithSymbol'], $languageLabelsArr["LBL_OUTSTANDING_RESTRICTION_MSG"]);
                    //$returnArr['ShowAdjustTripBtn'] = $returnArr['ShowPayNow'] = "Yes";
                    $returnArr['ShowAdjustTripBtn'] = "No";
                    $returnArr['ShowPayNow'] = "Yes";
                }
                //if($counttripData[0]['counttrip'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                //    $returnArr['ShowAdjustTripBtn'] = "No";
                //}
                $returnArr['OutstandingTrips'] = $counttripData[0]['counttrip'];
            }
            if ($data['OutstandingTrips'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                $data['ShowAdjustTripBtn'] = "No";
            }
            if ($data['ShowPayNow'] == "Yes") {
                $data['ShowContactUsBtn'] = "No";
            }
        }
    }
    //added by SP on 25-03-2021 for outstanding restriction end...
    if ($bookingFrom != 'Web') {
        if ($userType != "Driver") {
            $returnArr['message1'] = getPassengerDetailInfo($iUserId, "", "");
        } else {
            $returnArr['message1'] = getDriverDetailInfo($iUserId);
        }
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "updateUserProfileDetail") {
    $vName = isset($_REQUEST["vName"]) ? $_REQUEST["vName"] : '';
    $vLastName = isset($_REQUEST["vLastName"]) ? stripslashes($_REQUEST["vLastName"]) : '';
    $vPhone = isset($_REQUEST["vPhone"]) ? $_REQUEST["vPhone"] : '';
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST['iMemberId'] : '';
    $phoneCode = isset($_REQUEST["vPhoneCode"]) ? $_REQUEST['vPhoneCode'] : '';
    $vCountry = isset($_REQUEST["vCountry"]) ? $_REQUEST['vCountry'] : '';
    $currencyCode = isset($_REQUEST["CurrencyCode"]) ? $_REQUEST['CurrencyCode'] : '';
    $languageCode = isset($_REQUEST["LanguageCode"]) ? $_REQUEST['LanguageCode'] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST['UserType'] : 'Passenger';
    $vEmail = isset($_REQUEST["vEmail"]) ? $_REQUEST['vEmail'] : '';
    $tProfileDescription = isset($_REQUEST["tProfileDescription"]) ? $_REQUEST['tProfileDescription'] : '';
    $eSelectWorkLocation = isset($_REQUEST["eSelectWorkLocation"]) ? $_REQUEST['eSelectWorkLocation'] : 'Dynamic';
    $vInviteCode = isset($_REQUEST["vInviteCode"]) ? $_REQUEST['vInviteCode'] : '';
    //Added By HJ On 13-11-2019 For Check Provider Profile Edit Permission Start
    if (isset($vName) && !empty($vName)) {
        $vName = validName($vName);
    }
    if (isset($vLastName) && !empty($vLastName)) {
        $vLastName = validName($vLastName);
    }
    $driverData = array();
    if ($userType == "Driver") {
        $driverData = $obj->MySQLSelect("SELECT vLang,vCode,vPhone,vEmail,vInviteCode,eStatus,vName,vLastName FROM register_driver WHERE iDriverId = '" . $iMemberId . "'");
        $message = "LBL_EDIT_PROFILE_DISABLED";
        if (count($driverData) > 0) {
            $driverFname = $driverData[0]['vName'];
            $driverLname = $driverData[0]['vLastName'];
            $checkEditProfileStatus = getEditDriverProfileStatus($driverData[0]['eStatus']); // Added By HJ On 13-11-2019 For Check Driver Profile Edit Status As Per Discuss With KS Sir
            if (($driverFname != $vName || $driverLname != $vLastName) && $checkEditProfileStatus == "No") {
                $message = "LBL_PROFILE_EDIT_BLOCK_TXT";
                //$checkEditProfileStatus = "No";
                $returnArr['Action'] = "0";
                $returnArr['message'] = $message;
                setDataResponse($returnArr);
            }
        } else if ($ENABLE_EDIT_DRIVER_PROFILE == "No") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = $message;
            setDataResponse($returnArr);
        }
    }
    //Added By HJ On 13-11-2019 For Check Provider Profile Edit Permission End
    if ($vInviteCode != "") {
        $check_inviteCode = $REFERRAL_OBJ->ValidateReferralCode($vInviteCode);
        if ($check_inviteCode == "" || $check_inviteCode == "0" || $check_inviteCode == 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_INVITE_CODE_INVALID";
            setDataResponse($returnArr);
        } else {
            $inviteRes = explode("|", $check_inviteCode);
            $iRefUserId = $inviteRes[0];
            $eRefType = $inviteRes[1];
        }
    }
    /* Multi Level Referral */
    if ($vInviteCode != "") {
        $refData = $obj->MySQLSelect("SELECT * FROM user_referrer_transaction WHERE iMemberId = " . $inviteRes[0] . " AND eUserType = '" . $inviteRes[1] . "'");
        if ($refData[0]['tReferrerInfo'] == "") {
            $referrerInfo[] = array('Position of Referrer' => 1, 'iMemberId' => $inviteRes[0], 'eUserType' => $inviteRes[1]);
        } else {
            $referrerInfo = json_decode($refData[0]['tReferrerInfo'], true);
            $referrerInfo[] = array('Position of Referrer' => (count($referrerInfo) + 1), 'iMemberId' => $inviteRes[0], 'eUserType' => $inviteRes[1]);
        }
        $Data_Referrer['tReferrerInfo'] = json_encode($referrerInfo);
        $Data_Referrer['iMemberId'] = $iMemberId;
        $Data_Referrer['eUserType'] = ($userType == "Passenger") ? 'Rider' : 'Driver';
        $obj->MySQLQueryPerform("user_referrer_transaction", $Data_Referrer, 'insert');
    }
    /* Multi Level Referral End */
    $csql = "SELECT eZeroAllowed,vCountryCode FROM `country` WHERE vPhoneCode = '" . $phoneCode . "'";
    $CountryData = $obj->MySQLSelect($csql);
    $eZeroAllowed = $CountryData[0]['eZeroAllowed'];
    if ($eZeroAllowed == 'Yes') {
        $vPhone = $vPhone;
    } else {
        $first = substr($vPhone, 0, 1);
        if ($first == "0") {
            $vPhone = substr($vPhone, 1);
        }
    }
    $eSystem = "";
    if ($vPhone != "") {
        // $checPhoneExist = checkMemberDataInfo($vPhone, "", $userType, $vCountry, $iMemberId, $eSystem); //Added By HJ On 09-09-2019 For Check User Country and Mobile Number When Register
        $checPhoneExist = checkMemberDataInfo($vPhone, "", $userType, $vCountry, $iMemberId, $eSystem);
    }
    if (isset($checPhoneExist['status']) && $checPhoneExist['status'] == 0) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_MOBILE_EXIST";
        setDataResponse($returnArr);
    } else if (isset($checPhoneExist['status']) && $checPhoneExist['status'] == 2) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_INVALID_MEMBER_USER_COUNTRY_EMAIL_TXT";
        setDataResponse($returnArr);
    }
    if ($userType != "Driver") {
        if($userType == "Tracking") {
            $vEmail_sql = $obj->MySQLSelect("SELECT iTrackServiceUserId FROM track_service_users WHERE vEmail = '$vEmail' AND eStatus != 'Deleted' ");
            $vEmail_userId_check = $vEmail_sql[0]['iTrackServiceUserId'];
            
            $where = " iTrackServiceUserId = '$iMemberId'";
            $tableName = "track_service_users";
            $Data_update_User['vPhoneCode'] = $phoneCode;
            $currentLanguageCode = get_value($tableName, 'vLang', 'iTrackServiceUserId', $iMemberId, '', 'true');
            $sqlp = "SELECT vPhoneCode,vPhone,vEmail FROM $tableName WHERE iTrackServiceUserId = '" . $iMemberId . "'";
            $passengerData = $obj->MySQLSelect($sqlp);
            $vPhoneCode_orig = $passengerData[0]['vPhoneCode'];
            $vPhone_orig = $passengerData[0]['vPhone'];
            $vEmail_orig = $passengerData[0]['vEmail'];
        } else {
            // $vEmail_userId_check = get_value('register_user', 'iUserId', 'vEmail', $vEmail, '', 'true');
            $vEmail_sql = $obj->MySQLSelect("SELECT iUserId FROM register_user WHERE vEmail = '$vEmail' AND eStatus != 'Deleted' ");
            $vEmail_userId_check = $vEmail_sql[0]['iUserId'];
            //$vPhone_userId_check = get_value('register_user', 'iUserId', 'vPhone', $vPhone, '', 'true');
            $where = " iUserId = '$iMemberId'";
            $tableName = "register_user";
            $Data_update_User['vPhoneCode'] = $phoneCode;
            $Data_update_User['vCurrencyPassenger'] = $currencyCode;
            $currentLanguageCode = get_value('register_user', 'vLang', 'iUserId', $iMemberId, '', 'true');
            $sqlp = "SELECT vPhoneCode,vPhone,vEmail,vInviteCode FROM register_user WHERE iUserId = '" . $iMemberId . "'";
            $passengerData = $obj->MySQLSelect($sqlp);
            $vPhoneCode_orig = $passengerData[0]['vPhoneCode'];
            $vPhone_orig = $passengerData[0]['vPhone'];
            $vEmail_orig = $passengerData[0]['vEmail'];
            $UservInviteCode = $passengerData[0]['vInviteCode'];
        }
        
    } else {
        $vEmail_sql = $obj->MySQLSelect("SELECT iDriverId FROM register_driver WHERE vEmail = '$vEmail' AND eStatus != 'Deleted' ");
        $vEmail_userId_check = $vEmail_sql[0]['iDriverId'];
        
        $where = " iDriverId = '$iMemberId'";
        $tableName = "register_driver";
        $Data_update_User['vCode'] = $phoneCode;
        $Data_update_User['vCurrencyDriver'] = $currencyCode;
        $Data_update_User['tProfileDescription'] = $tProfileDescription;
        //$Data_update_User['eSelectWorkLocation']=$eSelectWorkLocation;
        if (empty($driverData) || count($driverData) == 0) {
            $sqlp = "SELECT vLang,vCode,vPhone,vEmail,vInviteCode FROM register_driver WHERE iDriverId = '" . $iMemberId . "'";
            $driverData = $obj->MySQLSelect($sqlp);
        }
        $currentLanguageCode = $driverData[0]['vLang'];
        $vPhoneCode_orig = $driverData[0]['vCode'];
        $vPhone_orig = $driverData[0]['vPhone'];
        $vEmail_orig = $driverData[0]['vEmail'];
        $UservInviteCode = $driverData[0]['vInviteCode'];
    }

    /*Email optional*/
    if ($ENABLE_EMAIL_OPTIONAL == "Yes") {
        if (!empty($vEmail) && $vEmail_userId_check != "" && $vEmail_userId_check != $iMemberId) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_ALREADY_REGISTERED_TXT";
            setDataResponse($returnArr);
        }
    } else {
        if ($vEmail_userId_check != "" && $vEmail_userId_check != $iMemberId) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_ALREADY_REGISTERED_TXT";
            setDataResponse($returnArr);
        }
    }

    if($userType != "Tracking") {
        if ($vPhone_orig != $vPhone || $vPhoneCode_orig != $phoneCode) {
            $Data_update_User['ePhoneVerified'] = "No";
        }
        if ($vEmail_orig != $vEmail) {
            $Data_update_User['eEmailVerified'] = "No";
        }

        if (($UservInviteCode != "" && $vInviteCode != "") || $vInviteCode != "") {
            $Data_update_User['iRefUserId'] = $iRefUserId;
            $Data_update_User['eRefType'] = $eRefType;
        }
    }
    $Data_update_User['vName'] = $vName;
    $Data_update_User['vLastName'] = $vLastName;
    $Data_update_User['vPhone'] = $vPhone;
    $Data_update_User['vCountry'] = $vCountry;
    $Data_update_User['vLang'] = $languageCode;
    if ($vEmail != "") {
        $Data_update_User['vEmail'] = $vEmail;
    } else {
        if ($ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == 'Yes') { // else condition added by NM ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD passing blank email that is not updated with existing email.
            $Data_update_User['vEmail'] = $vEmail;
        }
    }
    
    $id = $obj->MySQLQueryPerform($tableName, $Data_update_User, 'update', $where);
    $returnArr['changeLangCode'] = "No";
    if ($currentLanguageCode != $languageCode) {
        $returnArr['changeLangCode'] = "Yes";
        $returnArr['UpdatedLanguageLabels'] = $LANG_OBJ->FetchLanguageLabels($languageCode, "1", $iServiceId);
        $returnArr['vLanguageCode'] = $languageCode;
        $sql_LangCode = "SELECT eDirectionCode,vGMapLangCode FROM language_master WHERE `vCode` = '" . $languageCode . "' ";
        $Data_checkLangCode = $obj->MySQLSelect($sql_LangCode);
        $returnArr['langType'] = $Data_checkLangCode[0]['eDirectionCode'];
        $returnArr['vGMapLangCode'] = $Data_checkLangCode[0]['vGMapLangCode'];
        $sql = "SELECT vCode, vGMapLangCode, eDirectionCode as eType, vTitle,vCurrencyCode,vCurrencySymbol,eDefault  FROM  `language_master` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ";
        $defLangValues = $obj->MySQLSelect($sql);
        $returnArr['LIST_LANGUAGES'] = $defLangValues;
        for ($i = 0; $i < count($defLangValues); $i++) {
            if ($defLangValues[$i]['eDefault'] == "Yes") {
                $returnArr['DefaultLanguageValues'] = $defLangValues[$i];
            }

            if($defLangValues[$i]['vTitle'] != $defLangValues[$i]['vTitle_EN']){ 
						$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".mb_convert_case($defLangValues[$i]['vTitle'], MB_CASE_TITLE, 'UTF-8').")";
					//	$returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN']." (".ucfirst(strtolower($defLangValues[$i]['vTitle'])).")";
            } else {
                $returnArr['LIST_LANGUAGES'][$i]['vTitle'] = $defLangValues[$i]['vTitle_EN'];
            }

            $defLangValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
            $defLangValues[$i]['vService_TEXT_color'] = "#FFFFFF";
            $returnArr['LIST_LANGUAGES'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
            $returnArr['LIST_LANGUAGES'][$i]['vService_TEXT_color'] = "#FFFFFF";
        }
        $sql = "SELECT iCurrencyId,vName, vSymbol,iDispOrder, eDefault,Ratio,fThresholdAmount,eStatus  FROM  `currency` WHERE  `eStatus` = 'Active' ORDER BY iDispOrder ASC ";
        $defCurrencyValues = $obj->MySQLSelect($sql);
        $returnArr['LIST_CURRENCY'] = $defCurrencyValues;
        for ($i = 0; $i < count($defCurrencyValues); $i++) {
            if ($defCurrencyValues[$i]['eDefault'] == "Yes") {
                $returnArr['DefaultCurrencyValues'] = $defCurrencyValues[$i];
            }
            $defCurrencyValues[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
            $defCurrencyValues[$i]['vService_TEXT_color'] = "#FFFFFF";
            $returnArr['LIST_CURRENCY'][$i]['vService_BG_color'] = RANDOM_COLORS_ARR[$i];
            $returnArr['LIST_CURRENCY'][$i]['vService_TEXT_color'] = "#FFFFFF";
        }
    }
    if ($userType != "Driver") {
        if($userType == "Tracking") {
            $returnArr['message'] = $TRACK_ANY_SERVICE_OBJ->getTrackingMemberDetailInfo($iMemberId);
        } else {
            $returnArr['message'] = getPassengerDetailInfo($iMemberId, "", "");
        }
    } else {
        $returnArr['message'] = getDriverDetailInfo($iMemberId);
    }
    if ($id > 0) {
        $returnArr['Action'] = "1";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}

//Added By HJ On 26-09-2019 For Merged checkBookings & getRideHistory & getOngoingUserTrips Type also With Driver and Passanger Side Start
if ($type == "getMemberBookings") {
    $vSubFilterParam = "";
    RetrieveMemberBookingDetails($vSubFilterParam);
}
//Added By HJ On 26-09-2019 For Merged checkBookings & getRideHistory & getOngoingUserTrips Type also With Driver and Passanger Side End
####################### getRideHistory #############################
if ($type == "getRideHistory") {
    $page = isset($_REQUEST['page']) ? trim($_REQUEST['page']) : 1;
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : 'Ride';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $vFilterParam = isset($_REQUEST["vFilterParam"]) ? $_REQUEST["vFilterParam"] : ''; // Ride , Deliver Or UberX
    $vLanguage = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
    if ($vLanguage == "" || $vLanguage == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    if ($vFilterParam == "" || $vFilterParam == NULL) {
        $vFilterParam = "";
    }
    $ssql = "";
    ##  App Type Filtering ##
    if ($vFilterParam != "") {
        if ($vFilterParam == "Deliver") {
            $ssql .= " AND tr.eType IN ('Deliver','Multi-Delivery') ";
        } else if ($vFilterParam == "eFly") {
            $ssql .= " AND tr.iFromStationId != '' AND tr.iToStationId != ''";
        } else {
            $ssql .= " AND tr.eType IN ('" . $vFilterParam . "') ";
        }
        if ($MODULES_OBJ->isAirFlightModuleAvailable() && $vFilterParam == 'Ride') {
            $ssql .= " AND tr.iFromStationId = '' AND tr.iToStationId = ''";
        }
    }
    ##  App Type Filtering ##
    if ($iTripId != "" && $iTripId > 0) {
        $ssql = " and tr.iTripId='" . $iTripId . "'";
    }
    $ssql_fav_q = "";
    if ($MODULES_OBJ->checkFavDriverModule() && $UserType == "Passenger") {
        $ssql_fav_q = getFavSelectQuery($iUserId);
    }
    $per_page = 10;
    $sql_all = "SELECT COUNT(tr.iTripId) As TotalIds FROM trips tr WHERE  tr.iUserId='$iUserId' AND (tr.iActive='Canceled' || tr.iActive='Finished') AND tr.eSystem = 'General' $ssql";
    $data_count_all = $obj->MySQLSelect($sql_all);
    $TotalPages = ceil($data_count_all[0]['TotalIds'] / $per_page);
    $start_limit = ($page - 1) * $per_page;
    $limit = " LIMIT " . $start_limit . ", " . $per_page;
    $sql = "SELECT tr.* " . $ssql_fav_q . " FROM `trips` as tr WHERE tr.iUserId='$iUserId' AND (tr.iActive='Canceled' || tr.iActive='Finished') AND tr.eSystem = 'General' $ssql ORDER BY tr.iTripId DESC" . $limit;
    $Data = $obj->MySQLSelect($sql);
    $totalNum = count($Data);
    $i = 0;
    if (count($Data) > 0) {
        while (count($Data) > $i) {
            $returnArr = FetchTripFareDetails($Data[$i]['iTripId'], $iUserId, "Passenger");
            $sql = "SELECT count(iRatingId) AS Total FROM `ratings_user_driver` WHERE iTripId = '" . $Data[$i]['iTripId'] . "' and eUserType = '$UserType'";
            $rating_check = $obj->MySQLSelect($sql);
            $returnArr['is_rating'] = 'No';
            if ($rating_check[0]['Total'] > 0) {
                $returnArr['is_rating'] = 'Yes';
            }
            $Data[$i] = array_merge($Data[$i], $returnArr);
            if ($Data[$i]["eType"] == 'UberX' && $Data[$i]["eFareType"] != "Regular") {
                $Data[$i]['tDaddress'] = "";
            }
            /* Added For Rental */
            if ($Data[$i]['iRentalPackageId'] > 0) {
                $rentalData = getRentalData($Data[$i]['iRentalPackageId']);
                $Data[$i]['vPackageName'] = $rentalData[0]['vPackageName_' . $vLanguage];
            } else {
                $Data[$i]['vPackageName'] = "";
            }
            if ($Data[$i]['eType'] == 'Ride' && $Data[$i]['eFly'] == 'Yes') {
                $Data[$i]['eType'] = 'Fly'; //it is given direct bc from app side compare this and label is shown from there so in other lang not an issue
            }
            /* End Added For Rental */
            $i++;
        }
        $returnData['message'] = $Data;
        $returnData['AppTypeFilterArr'] = AppTypeFilterArr($iUserId, $UserType, $vLanguage);
        if ($TotalPages > $page) {
            $returnData['NextPage'] = "" . ($page + 1);
        } else {
            $returnData['NextPage'] = "0";
        }
        $returnData['Action'] = "1";
        setDataResponse($returnData);
    } else {
        $returnData['Action'] = "0";
        $returnData['message'] = "LBL_NO_DATA_AVAIL";
        $returnData['AppTypeFilterArr'] = AppTypeFilterArr($iUserId, $UserType, $vLanguage);
        setDataResponse($returnData);
    }
}
###########################################################################
if ($type == "submitRating") {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : ''; // for both driver or passenger
    $tripID = isset($_REQUEST["tripID"]) ? $_REQUEST["tripID"] : '';
    $rating = isset($_REQUEST["rating"]) ? $_REQUEST["rating"] : '';
    $message = isset($_REQUEST["message"]) ? $_REQUEST["message"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger'; // Passenger or Driver
    $fAmount = isset($_REQUEST["fAmount"]) ? $_REQUEST["fAmount"] : '';
    $isCollectTip = isset($_REQUEST["isCollectTip"]) ? $_REQUEST["isCollectTip"] : '';
    $safetyRating = isset($_REQUEST["safetyRating"]) ? $_REQUEST["safetyRating"] : '';
    $isSkipRating = isset($_REQUEST["isSkipRating"]) ? $_REQUEST["isSkipRating"] : 'No';
    if (!$MODULES_OBJ->isEnableSkipRatingRide()) {
        $isSkipRating = "No";
    }
    if ($isCollectTip == "" || $isCollectTip == NULL) {
        $isCollectTip = "No";
    }
    if (isset($tripDetailsArr['trips_' . $tripID])) {
        $getTripData = $tripDetailsArr['trips_' . $tripID];
    } else {
        $getTripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $tripID . "'");
        $tripDetailsArr['trips_' . $tripID] = $getTripData;
    }

    $eIconType = "";
    if ($getTripData[0]['eType'] == "Ride") {
        $iVehicleTypeId = $getTripData[0]['iVehicleTypeId'];
        $vt_data = $obj->MySQLSelect("SELECT eIconType FROM vehicle_type WHERE iVehicleTypeId = '$iVehicleTypeId' ");
        $eIconType = $vt_data[0]['eIconType'];
    }
    if (strtoupper($isCollectTip) == "YES" && $userType == "Passenger" && $fAmount > 0) {
        $userData = $obj->MySQLSelect("SELECT cu.Ratio FROM `register_user` as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE ru.iUserId='" . $iMemberId . "'");
        $Ratio = $userData[0]['Ratio'];
        $currencySymbol = $userData[0]['vSymbol'];
        $vLang = $userData[0]['vLang'];
        $currencyratio = get_value('currency', 'Ratio', 'eDefault', 'Yes', '', 'true');
        $price_new = $fAmount / $Ratio;
        $price_new = $price_new * $currencyratio;
        $UserType1 = $userType == "Driver" ? "Driver" : "Rider";
        $iUserId = $iMemberId;
        $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iUserId, $UserType1, true);
        if ($user_available_balance >= $price_new && $price_new > 0) {
            $iTripId = $tripID;
            $where = " iTripId = '$iTripId'";
            $data['fTipPrice'] = $price_new;
            $id = $obj->MySQLQueryPerform("trips", $data, 'update', $where);
            $vRideNo = get_value('trips', 'vRideNo', 'iTripId', $iTripId, '', 'true');
            $wallet_description = "#LBL_DEBITED_BOOKING#" . $vRideNo;
            $data_wallet['iUserId'] = $iUserId;
            $data_wallet['eUserType'] = $UserType1;
            $data_wallet['iBalance'] = $price_new;
            $data_wallet['eType'] = "Debit";
            $data_wallet['dDate'] = date("Y-m-d H:i:s");
            $data_wallet['iTripId'] = $iTripId;
            $data_wallet['eFor'] = "Charges";
            $data_wallet['ePaymentStatus'] = "Unsettelled";
            $data_wallet['tDescription'] = $wallet_description;
            $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], $data_wallet['iTripId'], $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate'], $data_wallet['iOrderId']);
            if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()) {
                $DataTip['price'] = $price_new;
                $DataTip['iTripId'] = $iTripId;
                autoCreditDriverEarning($DataTip, "TripCollectTip");
            }
            // $returnArr['Action'] = "1";
            // $returnArr['message'] = "LBL_RIDE_TIP_SUCCESS_TXT";
            // setDataResponse($returnArr);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['isCollectTip'] = "Yes";
            $description = "Tip received for trip number: " . $getTripData[0]['vRideNo'];
            $CheckUserWallet = (isset($getTripData[0]['eWalletDebitAllow'])) ? $getTripData[0]['eWalletDebitAllow'] : "No";
            $extraParams = "iTripId=" . $tripID . "&GeneralMemberId=" . $_REQUEST['GeneralMemberId'] . "&GeneralUserType=" . $_REQUEST['GeneralUserType'] . "&iUserId=" . $_REQUEST['GeneralMemberId'] . "&UserType=" . $_REQUEST['GeneralUserType'] . "&tSessionId=" . $_REQUEST['tSessionId'] . "&PAGE_TYPE=RIDE_TIP_COLLECT&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes&CheckUserWallet=" . $CheckUserWallet . "&eForTip=Yes&description=" . urlencode($description) . '&AMOUNT=' . $fAmount;
            $returnArr['message'] = $tconfig['tsite_url'] . 'assets/libraries/webview/system_payment.php?' . $extraParams;
            setDataResponse($returnArr);
        }
    }
    //$eType = get_value('trips', 'eType', 'iTripId', $tripID, '', 'true');
    $message = stripslashes($message);
    $row_check = $obj->MySQLSelect("SELECT * FROM `ratings_user_driver` WHERE iTripId = '$tripID' and eUserType = '$userType' AND vRating1 != '' ");
    $row_check_safety = $obj->MySQLSelect("SELECT * FROM `ratings_user_driver` WHERE iTripId = '$tripID' and eUserType = 'Passenger' AND vSafetyRating != ''");
    if ($rating != "" || $safetyRating != "") {
               
        if (count($row_check) > 0 || (count($row_check_safety) > 0 && $userType == "Passenger")) {
            if ($userType == "Passenger") {
                $tableName = "register_user";
                $where = "iUserId='" . $getTripData[0]['iUserId'] . "'";
            } else {
                $tableName = "register_driver";
                $where = "iDriverId='" . $getTripData[0]['iDriverId'] . "'";
            }
            $Data_update['vTripStatus'] = "Not Active";
            $Data_update['iTripId'] = $tripID;
            $obj->MySQLQueryPerform($tableName, $Data_update, 'update', $where);

            if ($userType == "Passenger") {
                $returnArr['USER_DATA'] = getPassengerDetailInfo($getTripData[0]['iUserId']);
            } else {
                $returnArr['USER_DATA'] = getDriverDetailInfo($getTripData[0]['iDriverId']);
            }

            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_TRIP_FINISHED_TXT";
            $returnArr['isMedicalServiceTrip'] = "No";
            if ($eIconType == "Ambulance") {
                $returnArr['isMedicalServiceTrip'] = "Yes";
            }
            setDataResponse($returnArr);
        } else {
  
            if ($rating != "" && $isSkipRating == "No") {
                $eType = $getTripData[0]['eType'];
                $iDriverId = $getTripData[0]['iDriverId'];
                $iUserId = $getTripData[0]['iUserId'];
                $vTripPaymentMode = $getTripData[0]['vTripPaymentMode'];
                # Code For Tip Charge #
                // if ($isCollectTip == "Yes" && $userType == "Passenger" && $eType == "Ride" && $fAmount > 0) {
                //     TripCollectTip($iMemberId, $tripID, $fAmount);
                // }
                # Code For Tip Charge #
                if ($userType == "Passenger") {
                    //$iDriverId = get_value('trips', 'iDriverId', 'iTripId', $tripID, '', 'true');
                    $tableName = "register_driver";
                    $where = "iDriverId='" . $iDriverId . "'";
                    $iMemberId = $iDriverId;
                    $eToUserType = "Driver";
                    $eFromUserType = "Passenger";
                    if ($MODULES_OBJ->checkFavDriverModule()) {
                        addUpdateFavDriver();
                    }
                    $tableNameMember = "register_user";
                    $where_member = " iUserId = '$iUserId'";
                } else {
                    $where_trip = " iTripId = '$tripID'";
                    $Data_update_trips['eVerified'] = "Verified";
                    $id = $obj->MySQLQueryPerform("trips", $Data_update_trips, 'update', $where_trip);
                    $tableName = "register_user";
                    $where = "iUserId='" . $iUserId . "'";
                    $iMemberId = $iUserId;
                    $eToUserType = "Passenger";
                    $eFromUserType = "Driver";
                    $tableNameMember = "register_driver";
                    $where_member = " iDriverId = '$iDriverId'";
                }
                /* Insert records into ratings table */
                $Data_update_ratings['iTripId'] = $tripID;
                $Data_update_ratings['vRating1'] = $rating;
                $Data_update_ratings['vMessage'] = $message;
                $Data_update_ratings['eUserType'] = $userType;
                $Data_update_ratings['eFromUserType'] = $eFromUserType;
                $Data_update_ratings['eToUserType'] = $eToUserType;
                
                $id = $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert'); // Remove Comment
                
                /* Set average rating for passenger OR Driver */
                // Driver gives rating to passenger and passenger gives rating to driver
                $Data_update['vAvgRating'] = FetchUserAvgRating($iMemberId, $userType);
                $id = $obj->MySQLQueryPerform($tableName, $Data_update, 'update', $where);
                $Data_update_member['vTripStatus'] = "Not Active";
                $Data_update_member['iTripId'] = $tripID;
                $obj->MySQLQueryPerform($tableNameMember, $Data_update_member, 'update', $where_member);
            }
            if ($safetyRating != "" && $isSkipRating == "No") {
                $eType = $getTripData[0]['eType'];
                $iDriverId = $getTripData[0]['iDriverId'];
                $iUserId = $getTripData[0]['iUserId'];
                $vTripPaymentMode = $getTripData[0]['vTripPaymentMode'];
                $tableName = "register_driver";
                $where = "iDriverId='" . $iDriverId . "'";
                $iMemberId = $iDriverId;
                $eToUserType = "Driver";
                $eFromUserType = "Passenger";
                /* Insert records into ratings table */
                $Data_update_ratings_safety['iTripId'] = $tripID;
                $Data_update_ratings_safety['vSafetyRating'] = $safetyRating;
                $Data_update_ratings_safety['vMessage'] = $message;
                $Data_update_ratings_safety['eUserType'] = $userType;
                $Data_update_ratings_safety['eFromUserType'] = $eFromUserType;
                $Data_update_ratings_safety['eToUserType'] = $eToUserType;
                $id = $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings_safety, 'insert'); // Remove Comment
                /* Set average rating for passenger OR Driver */
                // Driver gives rating to passenger and passenger gives rating to driver
                $Data_update['vAvgSafetyRating'] = FetchUserAvgSafetyRating($iMemberId, $eToUserType);
                $id = $obj->MySQLQueryPerform($tableName, $Data_update, 'update', $where);
            }
            if ($userType == "Passenger") {
                if ($eType == "Multi-Delivery") {
                    sendTripReceipt_Multi($tripID);
                } else {
                    sendTripReceipt($tripID);
                }
            } else {
                if ($eType == "Multi-Delivery") {
                    sendTripReceiptAdmin_Multi($tripID);
                } else {
                    sendTripReceiptAdmin($tripID);
                }
            }
            if ($isSkipRating == "Yes") {
                $eType = $getTripData[0]['eType'];
                $iUserId = $getTripData[0]['iUserId'];
                $trip_where = "iTripId='" . $tripID . "'";
                $trip_data_update['isSkipRating'] = 'Yes';
                $id = $obj->MySQLQueryPerform('trips', $trip_data_update, 'update', $trip_where);
            }

            if ($id) {

     
                if($eType == "Ride"){
                    if ($MODULES_OBJ->isEnableDriverRewardModule() && $userType == "Passenger") {
                        $DRIVER_REWARD_OBJ->assignDriverReward($iDriverId);
                    }
                   
                    /*if ($MODULES_OBJ->isEnableRiderRewardModule() && $userType == "Passenger") {
                        $RIDER_REWARD_OBJ->GiveRiderReward($iUserId,$tripID);
                    }*/
                }

                if ($MODULES_OBJ->isSendRequestToDriverBeforFinishTripModule() && $userType == "Driver") {
                    sendRequestToDriverNextTrip($iDriverId);
                }
                $returnArr['Action'] = "1";
                $returnArr['message'] = "LBL_TRIP_FINISHED_TXT";
                $returnArr['eType'] = $eType;
                $returnArr['isMedicalServiceTrip'] = "No";
                if ($eIconType == "Ambulance") {
                    $returnArr['isMedicalServiceTrip'] = "Yes";
                }
                if ($userType == "Passenger") {
                    $returnArr['USER_DATA'] = getPassengerDetailInfo($iUserId);
                } else {
                    $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId);
                }
                setDataResponse($returnArr);
            } else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
                setDataResponse($returnArr);
            }
        }
    }
}

###########################################################################
if ($type == "loadDriverFeedBack") {
    $page = isset($_REQUEST['page']) ? trim($_REQUEST['page']) : 1;
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $UserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : '';
    if ($UserType == "") {
        $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : '';
    }
    $SelectedCabType = isset($_REQUEST["SelectedCabType"]) ? $_REQUEST["SelectedCabType"] : '';
    $whereUberXTrip = "";
    if ($SERVICE_PROVIDER_FLOW == "Provider" && $SelectedCabType = "UberX") {
        $whereUberXTrip = " AND tr.eType='" . $SelectedCabType . "'";
    }
    $vAvgRating = get_value('register_driver', 'vAvgRating', 'iDriverId', $iDriverId, '', 'true');
    $per_page = 10;
    if (DELIVERALL == "Yes") {
        $sql_all = "SELECT COUNT(rate.iRatingId) As TotalIds FROM ratings_user_driver as rate LEFT JOIN trips as tr ON tr.iTripId = rate.iTripId LEFT JOIN orders as o ON o.iOrderId = rate.iOrderId  LEFT JOIN register_user as ru ON ru.iUserId = tr.iUserId WHERE tr.iDriverId='$iDriverId' AND tr.iActive='Finished' AND tr.eHailTrip='No' AND rate.eToUserType = '" . $UserType . "' AND rate.vRating1 != ''";
    } else {
        $sql_all = "SELECT COUNT(iTripId) As TotalIds FROM trips WHERE  iDriverId='$iDriverId' AND iActive='Finished' AND eHailTrip='No'";
    }
    $data_count_all = $obj->MySQLSelect($sql_all);
    $TotalPages = ceil($data_count_all[0]['TotalIds'] / $per_page);
    $start_limit = ($page - 1) * $per_page;
    $limit = " LIMIT " . $start_limit . ", " . $per_page;
    if (DELIVERALL == "Yes") {
        /*$sql = "(SELECT rate.*,CONCAT(ru.vName,' ',ru.vLastName) as vName,ru.iUserId as passengerid,ru.vImgName FROM ratings_user_driver as rate LEFT JOIN trips as tr ON tr.iTripId = rate.iTripId  LEFT JOIN register_user as ru ON ru.iUserId = tr.iUserId WHERE tr.iDriverId='$iDriverId' AND tr.iActive='Finished' AND tr.eHailTrip='No' AND rate.eToUserType = '" . $UserType . "' AND rate.vRating1 != '' ORDER BY tr.iTripId DESC)

        UNION

        ( SELECT rate.*,CONCAT(ru.vName,' ',ru.vLastName) as vName,ru.iUserId as passengerid,ru.vImgName FROM ratings_user_driver as rate LEFT JOIN orders as o ON o.iOrderId = rate.iOrderId  LEFT JOIN register_user as ru ON ru.iUserId = o.iUserId WHERE o.iDriverId='$iDriverId' AND o.iStatusCode='6' AND rate.eToUserType = '" . $UserType . "' ORDER BY o.iOrderId DESC) " . $limit;*/
        $sql = "SELECT rate.*,CONCAT(ru.vName,' ',ru.vLastName) as vName,ru.iUserId as passengerid,ru.vImgName FROM ratings_user_driver as rate LEFT JOIN trips as tr ON tr.iTripId = rate.iTripId LEFT JOIN orders as o ON o.iOrderId = rate.iOrderId  LEFT JOIN register_user as ru ON ru.iUserId = tr.iUserId WHERE tr.iDriverId='$iDriverId' AND tr.iActive='Finished' AND tr.eHailTrip='No' AND rate.eToUserType = '" . $UserType . "' AND rate.vRating1 != '' ORDER BY rate.tDate DESC $limit";
        if ($UserType == "Passenger") {
            $sql = "SELECT rate.*,CONCAT(ru.vName,' ',ru.vLastName) as vName,ru.iUserId as passengerid,ru.vImgName FROM ratings_user_driver as rate LEFT JOIN trips as tr ON tr.iTripId = rate.iTripId LEFT JOIN orders as o ON o.iOrderId = rate.iOrderId  LEFT JOIN register_user as ru ON ru.iUserId = tr.iUserId WHERE tr.iDriverId='$iDriverId' AND tr.iActive='Finished' AND tr.eHailTrip='No' AND rate.eToUserType = 'Driver' AND rate.vRating1 != '' ORDER BY rate.tDate DESC $limit";
        }

    } else {
        $sql = "SELECT rate.*,CONCAT(ru.vName,' ',ru.vLastName) as vName,ru.iUserId as passengerid,ru.vImgName FROM ratings_user_driver as rate LEFT JOIN trips as tr ON tr.iTripId = rate.iTripId  LEFT JOIN register_user as ru ON ru.iUserId = tr.iUserId WHERE tr.iDriverId='$iDriverId' AND tr.iActive='Finished' AND tr.eHailTrip='No' AND rate.eUserType='Passenger' AND rate.vRating1 != '' ORDER BY tr.iTripId DESC" . $limit;
    }
    $Data = $obj->MySQLSelect($sql);
    for ($i = 0; $i < count($Data); $i++) {
        $Data[$i]['vImage'] = $tconfig["tsite_upload_images_passenger"] . '/' . $Data[$i]['passengerid'] . '/3_' . $Data[$i]['vImgName'];
        $Data[$i]['tDateOrig'] = $Data[$i]['tDate'];
        $Data[$i]['tDate'] = DateTime($Data[$i]['tDate'], 14);
    }
    $totalNum = count($Data);
    ### Load Ratings for Food Trips ###
    if (count($Data) > 0) {
        $returnData['message'] = $Data;
        if ($TotalPages > $page) {
            $returnData['NextPage'] = $page + 1;
        } else {
            $returnData['NextPage'] = "0";
        }
        $returnData['vAvgRating'] = strval($vAvgRating);
        $returnData['Action'] = "1";
        setDataResponse($returnData);
    } else {
        $returnData['Action'] = "0";
        $returnData['message'] = "LBL_NO_FEEDBACK";
        setDataResponse($returnData);
    }
}
###########################################################################
if ($type == "loadEmergencyContacts") {
    // // Commented By HJ On 15-07-2020 Bcoz Not Required
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '0';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : '';
    $GeneralUserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : 'Passenger';
    if ($UserType == "") {
        $UserType = $GeneralUserType;
    }
    $data = $obj->MySQLSelect("SELECT * FROM user_emergency_contact WHERE iUserId='" . $iUserId . "' AND eUserType = '" . $UserType . "'");
    if (count($data) > 0) {
        $returnData['Action'] = "1";
        $returnData['message'] = $data;
    } else {
        $returnData['Action'] = "0";
    }
    setDataResponse($returnData);
}
###########################################################################
if ($type == "addEmergencyContacts") {
    // // Commented By HJ On 15-07-2020 Bcoz Not Required
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '0';
    $Phone = isset($_REQUEST["Phone"]) ? $_REQUEST["Phone"] : '0';
    $vName = isset($_REQUEST["vName"]) ? $_REQUEST["vName"] : '0';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $sql = "SELECT vPhone FROM user_emergency_contact WHERE iUserId = '" . $iUserId . "' AND vPhone='" . $Phone . "' AND eUserType='" . $UserType . "'";
    $Data_Exist = $obj->MySQLSelect($sql);
    if (count($Data_Exist) > 0) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_EME_CONTACT_EXIST";
    } else {
        $Data['vName'] = $vName;
        $Data['vPhone'] = $Phone;
        $Data['iUserId'] = $iUserId;
        $Data['eUserType'] = $UserType;
        $id = $obj->MySQLQueryPerform("user_emergency_contact", $Data, 'insert');
        if ($id > 0) {
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_EME_CONTACT_LIST_UPDATE";
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "deleteEmergencyContacts") {
    // // Commented By HJ On 15-07-2020 Bcoz Not Required
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '0';
    $iEmergencyId = isset($_REQUEST["iEmergencyId"]) ? $_REQUEST["iEmergencyId"] : '0';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $id = $obj->sql_query("DELETE FROM user_emergency_contact WHERE `iEmergencyId`='" . $iEmergencyId . "' AND `iUserId`='" . $iUserId . "' AND eUserType = '" . $UserType . "'");
    if ($id > 0) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_EME_CONTACT_LIST_UPDATE";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "sendAlertToEmergencyContacts") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '0';
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '0';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    CheckUserSmsLimitForEmergency($iUserId, $UserType);
    $sql = "SELECT * FROM user_emergency_contact WHERE iUserId = '" . $iUserId . "' AND eUserType='" . $UserType . "'";
    $dataArr = $obj->MySQLSelect($sql);
    if ($iTripId == "" || $iTripId == "0") {
        $tableName = $UserType != "Driver" ? "register_user" : "register_driver";
        $iMemberId_KEY = $UserType != "Driver" ? "iUserId" : "iDriverId";
        $iTripId = get_value($tableName, 'iTripId', $iMemberId_KEY, $iUserId, '', 'true');
    }
    if (count($dataArr) > 0) {
        $sql = "SELECT tr.*,dv.vLicencePlate,CONCAT(rd.vName,' ',rd.vLastName) as vDriverName,rd.vPhone as DriverPhone,CONCAT(ru.vName,' ',ru.vLastName) as vPassengerName,ru.vPhone as PassengerPhone FROM trips as tr, register_driver as rd, register_user as ru, driver_vehicle as dv WHERE tr.iTripId = '" . $iTripId . "' AND rd.iDriverId = tr.iDriverId AND ru.iUserId = tr.iUserId AND dv.iDriverVehicleId = tr.iDriverVehicleId";
        $tripData = $obj->MySQLSelect($sql);
        //$tripData[0]['tStartDate'] = ($tripData[0]['tStartDate'] == '0000-00-00 00:00:00')? $tripData[0]['tTripRequestDate'] : $tripData[0]['tStartDate'];
        $tStartDate = ($tripData[0]['tStartDate'] == '0000-00-00 00:00:00') ? $tripData[0]['tTripRequestDate'] : $tripData[0]['tStartDate'];
        $systemTimeZone = date_default_timezone_get();
        $vTimeZone = $tripData[0]['vTimeZone'];
        $iDriverId = $tripData[0]['iDriverId'];
        $tStartDate = converToTz($tStartDate, $vTimeZone, $systemTimeZone);
        $tripData[0]['tStartDate'] = $tStartDate;
        $tTripRequestDate = $tripData[0]['tTripRequestDate'];
        $tTripRequestDate = converToTz($tTripRequestDate, $vTimeZone, $systemTimeZone);
        $tripData[0]['tTripRequestDate'] = $tTripRequestDate;
        $eType = $tripData[0]['eType'];
        $isdCode = $SITE_ISD_CODE;
        $dataArraySMS = array();
        $dataArraySMS['PassengerName'] = $tripData[0]['vPassengerName'];
        $dataArraySMS['PassengerPhone'] = $tripData[0]['PassengerPhone'];
        $dataArraySMS['SITE_NAME'] = $SITE_NAME;
        $dataArraySMS['TripRequestDate'] = date('dS M \a\t h:i a', strtotime($tripData[0]['tTripRequestDate']));
        $dataArraySMS['Saddress'] = $tripData[0]['tSaddress'];
        $dataArraySMS['DriverName'] = $tripData[0]['vDriverName'];
        $dataArraySMS['DriverPhone'] = $tripData[0]['DriverPhone'];
        $trackingURL = getGooglelocatiotionTrackingURL($iTripId, $iDriverId);
        $trackingFinalMessage = "." . $trackingURL;
        if (isset($trackingURL) && !empty($trackingURL)) {
            if ($UserType == "Passenger") {
                $vLangCode = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
            } else {
                $vLangCode = get_value('register_driver', 'vLang', 'iDriverId', $iDriverId, '', 'true');
            }
            //$vLangCode = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
            if ($vLangCode == "" || $vLangCode == NULL) {
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
            $trackingMessage = $languageLabelsArr['LBL_PLEASE_CHECK_LAST_LOCATION_TRACKING_MESSAGE'];
            //$trackingFinalMessage = ".".$trackingMessage.' '.$trackingURL;
            $trackingFinalMessage = $trackingURL;
        }
        $dataArraySMSNew['SITE_NAME'] = $SITE_NAME;
        $dataArraySMSNew['vDriverName'] = $tripData[0]['vDriverName'];
        $dataArraySMSNew['DriverPhone'] = $tripData[0]['DriverPhone'];
        $dataArraySMSNew['tStartDate'] = date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate']));
        $dataArraySMSNew['tSaddress'] = $tripData[0]['tSaddress'];
        $dataArraySMSNew['vPassengerName'] = $tripData[0]['vPassengerName'];
        $dataArraySMSNew['PassengerPhone'] = $tripData[0]['PassengerPhone'];
        $dataArraySMSNew['vLicencePlate'] = $tripData[0]['vLicencePlate'];
        $dataArraySMSNew['trackingURL'] = $trackingFinalMessage;
        //Added By HJ On 23-09-2020 For Get Emergency SMS Data Start
        $dataArraySMSNew['PassengerName'] = $tripData[0]['vPassengerName'];
        $dataArraySMSNew['StartDate'] = date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate']));
        $dataArraySMSNew['Saddress'] = $tripData[0]['tSaddress'];
        $dataArraySMSNew['DriverName'] = $tripData[0]['vDriverName'];
        $dataArraySMSNew['LicencePlate'] = $tripData[0]['vLicencePlate'];
        //Added By HJ On 23-09-2020 For Get Emergency SMS Data End
        if ($eType == "UberX") {
            if ($UserType == "Passenger") {
                $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_USER_SP', $dataArraySMSNew, "", $vLangCode);
                // $message = "Important: " . $tripData[0]['vPassengerName'] . ' (' . $tripData[0]['PassengerPhone'] . ') has reached out to you via ' . $SITE_NAME . ' SOS. Please reach out to him/her urgently. The details of the Job are: Job start time: ' . date('dS M \a\t h:i a', strtotime($tripData[0]['tTripRequestDate'])) . '. Job Address: ' . $tripData[0]['tSaddress'] . '. Service Provider name: ' . $tripData[0]['vDriverName'] . '. Service Provider number:(' . $tripData[0]['DriverPhone'] . ")".$trackingFinalMessage;
            } else {
                //$message = "Important: " . $tripData[0]['vDriverName'] . ' (' . $tripData[0]['DriverPhone'] . ') has reached out to you via ' . $SITE_NAME . ' SOS. Please reach out to him/her urgently. The details of the Job are: Job start time: ' . date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate'])) . '. Job Address: ' . $tripData[0]['tSaddress'] . '. User name: ' . $tripData[0]['vPassengerName'] . $tripData[0]['vPassengerName'];
                $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_DRIVER_SP', $dataArraySMSNew, "", $vLangCode);
            }
        } else if ($eType == "Deliver") {
            if ($UserType == "Passenger") {
                //$message = "Important: " . $tripData[0]['vPassengerName'] . ' (' . $tripData[0]['PassengerPhone'] . ') has reached out to you via ' . $SITE_NAME . ' SOS. Please reach out to him/her urgently. The details of the delivery are: Delivery start time: ' . date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate'])) . '. Pick up from: ' . $tripData[0]['tSaddress'] . '. Delivery Driver name: ' . $tripData[0]['vDriverName'] . '. Delivery Driver number:(' . $tripData[0]['DriverPhone'] . "). Delivery Driver's car number: " . $tripData[0]['vLicencePlate'].$trackingFinalMessage;
                $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_USER_SP_DELIVER', $dataArraySMSNew, "", $vLangCode);
            } else {
                //$message = "Important: " . $tripData[0]['vDriverName'] . ' (' . $tripData[0]['DriverPhone'] . ') has reached out to you via ' . $SITE_NAME . ' SOS. Please reach out to him/her urgently. The details of the delivery are: Delivery start time: ' . date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate'])) . '. Pick up from: ' . $tripData[0]['tSaddress'] . '. Sender name: ' . $tripData[0]['vPassengerName'] . '. Sender number:(' . $tripData[0]['PassengerPhone'] . "). Delivery Driver's car number: " . $tripData[0]['vLicencePlate'].$trackingFinalMessage;
                $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_DRIVER_SP_DELIVER', $dataArraySMSNew, "", $vLangCode);
            }
        } else {
            if ($UserType == "Passenger") {
                //$message = "Important: " . $tripData[0]['vPassengerName'] . ' (' . $tripData[0]['PassengerPhone'] . ') has reached out to you via ' . $SITE_NAME . ' SOS. Please reach out to him/her urgently. The details of the ride are: Trip start time: ' . date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate'])) . '. Pick up from: ' . $tripData[0]['tSaddress'] . '. Driver name: ' . $tripData[0]['vDriverName'] . '. Driver number:(' . $tripData[0]['DriverPhone'] . "). Driver's car number: " . $tripData[0]['vLicencePlate'].$trackingFinalMessage;
                $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_USER_RIDE', $dataArraySMSNew, "", $vLangCode);
            } else {
                //$message = "Important: " . $tripData[0]['vDriverName'] . ' (' . $tripData[0]['DriverPhone'] . ') has reached out to you via ' . $SITE_NAME . ' SOS. Please reach out to him/her urgently. The details of the ride are: Trip start time: ' . date('dS M Y \a\t h:i a', strtotime($tripData[0]['tStartDate'])) . '. Pick up from: ' . $tripData[0]['tSaddress'] . '. Passenger name: ' . $tripData[0]['vPassengerName'] . '. Passenger number:(' . $tripData[0]['PassengerPhone'] . "). Driver's car number: " . $tripData[0]['vLicencePlate'].$trackingFinalMessage;
                $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_DRIVER_RIDE', $dataArraySMSNew, "", $vLangCode);
            }
        }
        for ($i = 0; $i < count($dataArr); $i++) {
            $phone = preg_replace("/[^0-9]/", "", $dataArr[$i]['vPhone']);
            $toMobileNum = "+" . $phone;
            //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019 start
            if ($UserType == "Passenger") {
                $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM  `register_user` AS r, `country` AS c WHERE r.iUserId = $iUserId AND r.vCountry = c.vCountryCode");
            } else {
                $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM  `register_driver` AS r, `country` AS c WHERE r.iDriverId = $iUserId AND r.vCountry = c.vCountryCode");
            }
            $PhoneCode = $passengerData[0]['vPhoneCode'];
            $result = $COMM_MEDIA_OBJ->SendSystemSMS($toMobileNum, $PhoneCode, $message);
            //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019 end
            //added by SP on 23-01-2021 to save data of emergency data
            $datainsert = array();
            $datainsert['iEmergencyId'] = $dataArr[$i]['iEmergencyId'];
            $datainsert['vContactName'] = $dataArr[$i]['vName'];
            $datainsert['vContactPhone'] = $phone;
            $datainsert['iDriverId'] = $tripData[0]['iDriverId'];;
            $datainsert['iUserId'] = $tripData[0]['iUserId'];;
            $datainsert['iTripId'] = $iTripId;
            $datainsert['vFromUserType'] = $UserType;
            $datainsert['tMessage'] = $message;
            $datainsert["tRequestDate"] = @date("Y-m-d H:i:s");
            $id = $obj->MySQLQueryPerform("emergency_contact_data", $datainsert, 'insert');
        }
        UpdateUserSmsLimitForEmergency($iUserId, $UserType);
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_EME_CONTACT_ALERT_SENT";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_ADD_EME_CONTACTS";
        $returnArr['message1'] = "ContactError";
    }
    setDataResponse($returnArr);
}

###########################displayDocList##########################################################
if ($type == "displayDocList") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $memberType = isset($_REQUEST['MemberType']) ? clean($_REQUEST['MemberType']) : 'Driver';
    $iDriverVehicleId = isset($_REQUEST['iDriverVehicleId']) ? clean($_REQUEST['iDriverVehicleId']) : '';
    $doc_usertype = isset($_REQUEST['doc_usertype']) ? clean(strtolower($_REQUEST['doc_usertype'])) : 'driver';
    $eType = isset($_REQUEST['eType']) ? clean($_REQUEST['eType']) : ''; //  Ride, Delivery OR UberX only for APP_TYPE Ride-Delivery-UberX , and it is blank for another APP_TYPE
    $sql_1 = $ssql = "";
    if ($ENABLE_BIDDING_WISE_PROVIDER_DOC == 'Yes') {
        $sql_1 = "OR dm.eDocServiceType = 'BiddingSpecific'";
    }
    if ($APP_TYPE == "Ride-Delivery-UberX" || $APP_TYPE == "UberX") {
        $ssql .= " AND ( dm.eDocServiceType = 'General' OR dm.eDocServiceType = 'ServiceSpecific' " . $sql_1 . ")";
    } else {
        $ssql .= " AND dm.eDocServiceType = 'General' OR dm.eDocServiceType=''";
    }
    if ($doc_usertype == "vehicle") {
        $doc_usertype = "car";
    }
    $doc_userid = ($doc_usertype == 'car') ? $iDriverVehicleId : $iMemberId;
    $UserData = get_value('register_driver', 'vCountry,vLang', 'iDriverId', $iMemberId);
    $vCountry = $UserData[0]['vCountry'];
    $vLang = $UserData[0]['vLang'];
    $vDefaultLang = $LANG_OBJ->FetchDefaultLangData("vCode");
    if ($vLang == '' || $vLang == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLang = $vDefaultLang;
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    //dm.doc_name_" . $vLang . " as doc_name
    if (strtoupper(APP_TYPE) == "RIDE" || strtoupper(APP_TYPE) == "DELIVERY" || strtoupper(APP_TYPE) == "UBERX") {
        //$ssql .= " AND eType='" . $eType . "'"; //its not needed now bc different table
    }
    $sql1 = "SELECT dm.iBiddingId iBiddingId, dm.doc_masterid masterid, dm.doc_usertype , dm.ex_status ,dm.eType, IF(dm.doc_name_" . $vLang . "!='',dm.doc_name_" . $vLang . ",dm.doc_name_" . $vDefaultLang . ") doc_name,  dm.ex_status,dm.status, COALESCE(dl.doc_id,  '' ) as doc_id,COALESCE(dl.doc_masterid, '') as masterid_list ,COALESCE(dl.ex_date, '') as ex_date,COALESCE(dl.doc_file, '') as doc_file, COALESCE(dl.status, '') as status,dm.iVehicleCategoryId,vc.vCategory_" . $vLang . " as vCategory,dm.eDocServiceType FROM document_master dm left join (SELECT * FROM `document_list` where doc_userid='" . $doc_userid . "' AND status != 'Deleted') dl on dl.doc_masterid=dm.doc_masterid LEFT JOIN vehicle_category vc on vc.iVehicleCategoryId = dm.iVehicleCategoryId where dm.doc_usertype='" . $doc_usertype . "' AND (dm.country='" . $vCountry . "' OR dm.country='All') and dm.status='Active' $ssql ORDER BY dm.iDisplayOrder ASC";
    $db_vehicle = $obj->MySQLSelect($sql1);
    if ($MODULES_OBJ->isEnableBiddingWiseProviderDoc()) {
        $db_vehicle_bidding = $BIDDING_OBJ->getBiddingDocument($iMemberId, $db_vehicle);
    }
    if ($MODULES_OBJ->isEnableAppHomePageListView()) {
        $providerDocumentServiceCategoryArray = getProviderDocumentServiceWise($iMemberId, $db_vehicle);
        $db_vehicle = $providerDocumentServiceCategoryArray;
    }
    if ($MODULES_OBJ->isEnableBiddingWiseProviderDoc()) {
        $db_vehicle = array_merge($db_vehicle_bidding, $db_vehicle);
    }
    if (count($db_vehicle) > 0) {
        if ($doc_usertype == "driver") {
            $Photo_Gallery_folder = $tconfig['tsite_upload_driver_doc'] . "/" . $iMemberId . "/";
        } else {
            $Photo_Gallery_folder = $tconfig['tsite_upload_vehicle_doc_panel'] . "/" . $iDriverVehicleId . "/";
        }
        for ($i = 0; $i < count($db_vehicle); $i++) {
            $db_vehicle[$i]['vimage'] = "";
            if ($db_vehicle[$i]['doc_file'] != "") {
                $db_vehicle[$i]['vimage'] = $Photo_Gallery_folder . $db_vehicle[$i]['doc_file'];
            }
            ## Checking for expire date of document ##
            $ex_date = $db_vehicle[$i]['ex_date'];
            $todaydate = date('Y-m-d');
            if ($ex_date == "" || $ex_date == "0000-00-00" || $db_vehicle[$i]['ex_date'] == "0000-00-00" || $db_vehicle[$i]['ex_date'] <= "1970-01-01") {
                $expire_document = "No";
            } else {
                if (strtotime($ex_date) < strtotime($todaydate)) {
                    $expire_document = "Yes";
                } else {
                    $expire_document = "No";
                }
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
            $exDocConfig = $MODULES_OBJ->isDocumentExpiredFeatureEnable();
            if ($exDocConfig == true) {
                $db_vehicle[$i]['ex_date'] = ($db_vehicle[$i]['ex_date'] != "") ? $db_vehicle[$i]['ex_date'] : $todaydate;
                $db_vehicle[$i]['ex_date'] = date("d M, Y", strtotime($db_vehicle[$i]['ex_date']));
                $db_vehicle[$i]['exp_date'] = "";
                if ($ex_date != "0000-00-00") {
                    $expireLabel = $languageLabelsArr['LBL_EXPIRE_TXT'];
                    $newFormat = date("d M, Y (D)", strtotime($db_vehicle[$i]['ex_date']));
                    $db_vehicle[$i]['exp_date'] = $expireLabel . ": " . $newFormat;
                }
                $allowDate = date('Y-m-d', strtotime($db_vehicle[$i]['ex_date'] . ' - ' . $BEFORE_DAYS_ALLLOW_UPDATE_DOCS . ' days'));
                if (($db_vehicle[$i]['ex_date'] == '' || $todaydate >= $allowDate) || $SET_DRIVER_OFFLINE_AS_DOC_EXPIRED == 'No') {
                    $db_vehicle[$i]['allow_date_change'] = 'Yes';
                    $db_vehicle[$i]['doc_update_disable'] = '';
                } else {
                    $db_vehicle[$i]['allow_date_change'] = 'No';
                    $db_vehicle[$i]['doc_update_disable'] = $languageLabelsArr['LBL_DOC_UPDATE_DISABLE'];
                }
                $db_vehicle[$i]['EXPIRE_DOCUMENT'] = $expire_document;
            } else {
                $expireLabel = $languageLabelsArr['LBL_EXPIRE_TXT'];
                $newFormat = date("jS F Y", strtotime($db_vehicle[$i]['ex_date']));
                $db_vehicle[$i]['exp_date'] = $expireLabel . ": " . $newFormat;
                $db_vehicle[$i]['EXPIRE_DOCUMENT'] = $expire_document;
            }
            ## Checking for expire date of document ##
            //$db_vehicle[$i]['vCategory'] = ($db_vehicle[$i]['vCategory'] !="" ) ? $db_vehicle[$i]['vCategory'] : $db_vehicle[$i]['eType'];
            $db_vehicle[$i]['vCategory'] = ($db_vehicle[$i]['vCategory'] != "") ? $db_vehicle[$i]['vCategory'] : "";
            $db_vehicle[$i]['eDocServiceType'] = ($db_vehicle[$i]['iVehicleCategoryId'] != 0) ? $db_vehicle[$i]['vCategory'] : $db_vehicle[$i]['eDocServiceType'];
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = $db_vehicle;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DOC_AVAIL";
    }
    setDataResponse($returnArr);
}
###########################Add/Update Driver's Document and Vehilcle Document ##########################################################
if ($type == "uploaddrivedocument") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iDriverVehicleId = isset($_REQUEST['iDriverVehicleId']) ? clean($_REQUEST['iDriverVehicleId']) : '';
    //$doc_userid = isset($_REQUEST['doc_userid']) ? clean($_REQUEST['doc_userid']) : '';
    $memberType = isset($_REQUEST['MemberType']) ? clean($_REQUEST['MemberType']) : 'Driver';
    $doc_usertype = isset($_REQUEST['doc_usertype']) ? clean(strtolower($_REQUEST['doc_usertype'])) : 'driver'; // vehicle OR driver
    $doc_masterid = isset($_REQUEST['doc_masterid']) ? clean($_REQUEST['doc_masterid']) : '';
    $doc_name = isset($_REQUEST['doc_name']) ? clean($_REQUEST['doc_name']) : '';
    $doc_id = isset($_REQUEST['doc_id']) ? clean($_REQUEST['doc_id']) : '';
    $doc_file = isset($_REQUEST['doc_file']) ? clean($_REQUEST['doc_file']) : '';
    $ex_date = isset($_REQUEST['ex_date']) ? clean($_REQUEST['ex_date']) : date("Y-m-d H:i:s");
    $ex_status = isset($_REQUEST['ex_status']) ? clean($_REQUEST['ex_status']) : '';
    $ex_date = date("Y-m-d", strtotime($ex_date));
    $Today = Date('Y-m-d');
    if ($doc_usertype == "vehicle") {
        $doc_usertype = "car";
    }
    $doc_userid = ($doc_usertype == 'car') ? $iDriverVehicleId : $iMemberId;
    $status = ($doc_usertype == 'car' || $doc_usertype == 'driver') ? "Active" : "Inactive";
    $image_name = $vImage = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    //$image_name = "123.jpg";
    $action = ($doc_id != '') ? 'Edit' : 'Add';
    $addupdatemode = ($action == 'Add') ? 'insert' : 'update';
    if ($doc_file != "") {
        $vImageName = $doc_file;
    } else {
        if ($doc_usertype == "driver") {
            $Photo_Gallery_folder = $tconfig['tsite_upload_driver_doc_path'] . "/" . $iMemberId . "/";
        } else {
            $Photo_Gallery_folder = $tconfig['tsite_upload_vehicle_doc'] . "/" . $iDriverVehicleId . "/";
        }
        if (!is_dir($Photo_Gallery_folder)) {
            mkdir($Photo_Gallery_folder, 0777);
        }
        $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $image_name, $prefix = '', $tconfig['tsite_upload_docs_file_extensions']);
        $vImageName = $vFile[0];
    }
    if ($vImageName != '') {
        $Data_Update["doc_masterid"] = $doc_masterid;
        $Data_Update["doc_usertype"] = $doc_usertype;
        $Data_Update["doc_userid"] = $doc_userid;
        $Data_Update["edate"] = @date("Y-m-d H:i:s");
        $returnArr['doc_under_review'] = '';
        $exDocConfig = $MODULES_OBJ->isDocumentExpiredFeatureEnable();
        if ($exDocConfig == true) {
            $exitingExpDate = 'SELECT dm.ex_status,dl.ex_date,dl.req_date FROM document_list AS dl LEFT JOIN document_master as dm ON dm.doc_masterid = dl.doc_masterid  WHERE doc_id = ' . $doc_id;
            $db_data1 = $obj->MySQLSelect($exitingExpDate);
            $allowDate = date('Y-m-d', strtotime($db_data1[0]['ex_date'] . ' - ' . $BEFORE_DAYS_ALLLOW_UPDATE_DOCS . ' days'));
            if ($Today >= $allowDate && $SET_DRIVER_OFFLINE_AS_DOC_EXPIRED == 'Yes' && $action != "Add" && $db_data1[0]['ex_status'] == 'yes') {
                $ex_date = $ex_date == $db_data1[0]['ex_date'] ? $db_data1[0]['req_date'] : $ex_date;
                $Data_Update["req_date"] = $ex_date;
                $Data_Update["req_file"] = $vImageName;
                $returnArr['doc_under_review'] = 'LBL_FOR_DOCS_UNDER_REVIEW';
            } else {
                $Data_Update["ex_date"] = $ex_date;
                $Data_Update["doc_file"] = $vImageName;
            }
        } else {
            $Data_Update["ex_date"] = $ex_date;
            $Data_Update["doc_file"] = $vImageName;
        }
        if ($action == "Add") {
            $Data_Update["status"] = $status;
            $id = $obj->MySQLQueryPerform("document_list", $Data_Update, 'insert');
        } else {
            $where = " doc_id = '" . $doc_id . "'";
            $id = $obj->MySQLQueryPerform("document_list", $Data_Update, 'update', $where);
        }
        save_log_data('0', $iMemberId, 'driver', $doc_name, $vImageName);
        if ($id > 0) {
            $sql_user = "SELECT rd.iDriverId,rd.vName,rd.vLastName,rd.vEmail as rdemail,c.vCompany,c.vEmail as cemail  FROM `register_driver` as rd join company as c on c.iCompanyId =rd.iCompanyId WHERE rd.iDriverId='" . $iMemberId . "'";
            $userdetails = $obj->MySQLSelect($sql_user);
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
            if ($doc_usertype == "driver") {
                $maildata['NAME'] = $userdetails[0]['vName'] . " " . $userdetails[0]['vLastName'] . " (" . $languageLabelsArr['LBL_DOCUMNET_UPLOAD_BY_DRIVER'] . ")";
                $maildata['DOCUMENTFOR'] = $languageLabelsArr['LBL_DOCUMNET_UPLOAD_BY_DRIVER'];
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
                $maildata['EMAIL'] = $userdetails[0]['rdemail'];
                $docname_SQL = "SELECT doc_name_" . $vLang . " as docname FROM document_master WHERE doc_masterid = '" . $doc_masterid . "'";
                $docname_data = $obj->MySQLSelect($docname_SQL);
                $maildata['DOCUMENTTYPE'] = $docname_data[0]['docname'];
                $COMM_MEDIA_OBJ->SendMailToMember("DOCCUMENT_UPLOAD_WEB", $maildata);
                $maildata['COMPANYEMAIL'] = $userdetails[0]['cemail'];
                $maildata['COMPANYNAME'] = $userdetails[0]['vCompany'];
                $COMM_MEDIA_OBJ->SendMailToMember("DOCCUMENT_UPLOAD_WEB_COMPANY", $maildata);
            }
            $returnArr['Action'] = "1";
            //$returnArr['message'] = getDriverDetailInfo($iMemberId);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################Add/Update Driver's Document and Vehilcle Document 

#######################################################################
if ($type == "callOnLogout") {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $vPassword = isset($_REQUEST["vPassword"]) ? $_REQUEST["vPassword"] : '';
    $Data_logout = array();
    if ($userType == "Passenger") {
        $Data_logout['eLogout'] = 'Yes';
        $tableName = "register_user";
        $where = " iUserId='" . $iMemberId . "'";
        $id = $obj->MySQLQueryPerform($tableName, $Data_logout, 'update', $where);
    } elseif ($userType == "Tracking") {
        $Data_logout['eLogout'] = 'Yes';
        $Data_logout['eLocationTracking'] = 'No';
        $tableName = "track_service_users";
        $where = " iTrackServiceUserId='" . $iMemberId . "'";
        $id = $obj->MySQLQueryPerform($tableName, $Data_logout, 'update', $where);
    } else if ($userType == "Driver") {
        /** As a part of socket cluster */
        $COUNT_PUBLISH_CHANNEL = isset($_REQUEST["COUNT_PUBLISH_CHANNEL"]) ? $_REQUEST["COUNT_PUBLISH_CHANNEL"] : '0';
        $IS_DRIVER_ONLINE = isset($_REQUEST["IS_DRIVER_ONLINE"]) ? $_REQUEST["IS_DRIVER_ONLINE"] : '0';
        /** As a part of socket cluster */
        /** As a part of socket cluster */
        if ($PUBNUB_DISABLED == "Yes" && $IS_DRIVER_ONLINE == "Yes") {
            $DRIVER_CURRENT_TIME = isset($_REQUEST["DRIVER_CURRENT_TIME"]) ? $_REQUEST["DRIVER_CURRENT_TIME"] : '';
            $Latitude = isset($_REQUEST["Latitude"]) ? $_REQUEST["Latitude"] : '';
            $Longitude = isset($_REQUEST["Longitude"]) ? $_REQUEST["Longitude"] : '';
            for ($i = 0; $i < $COUNT_PUBLISH_CHANNEL; $i++) {
                $PUBLISH_CHANNEL_tmp = isset($_REQUEST["PUBLISH_CHANNEL_" . $i]) ? $_REQUEST["PUBLISH_CHANNEL_" . $i] : '';
                if ($PUBLISH_CHANNEL_tmp != "") {
                    $pubMsgArr['iDriverId'] = $iMemberId;
                    $pubMsgArr['MessageType'] = "DriverStatusLocation";
                    $pubMsgArr['Latitude'] = $Latitude;
                    $pubMsgArr['Longitude'] = $Longitude;
                    $pubMsgArr['Time'] = $DRIVER_CURRENT_TIME;
                    $pubMsgArr['IsDriverOnline'] = "No";
                    $pubMsgArr['isForceLoad'] = "No";
                    $message_pub_sub = json_encode($pubMsgArr, JSON_UNESCAPED_UNICODE);
                    //  publishEventMessage($PUBLISH_CHANNEL_tmp, $message_pub_sub);
                }
            }
        }
        /** As a part of socket cluster */
        $Data_logout['vAvailability'] = 'Not Available';
        $Data_logout['eLogout'] = 'Yes';
        $tableName = "register_driver";
        $where = " iDriverId='" . $iMemberId . "'";
        $id = $obj->MySQLQueryPerform($tableName, $Data_logout, 'update', $where);
        $curr_date = date('Y-m-d H:i:s');
        $get_data_log = $obj->sql_query("select * from driver_log_report WHERE iDriverId = '" . $iMemberId . "' AND dLogoutDateTime = '0000-00-00 00:00:00' order by `iDriverLogId` desc limit 0,1");
        if (count($get_data_log) > 0) {
            $result = $obj->sql_query("UPDATE driver_log_report set dLogoutDateTime = '" . $curr_date . "' WHERE iDriverLogId ='" . $get_data_log[0]['iDriverLogId'] . "'");
        }
    } else {
        $result2 = $obj->MySQLSelect("SELECT h.iHotelId,a.vPassword FROM `hotel` as h LEFT JOIN  administrators as a on a.iAdminId=h.iAdminId WHERE h.iHotelId='" . $iMemberId . "'");
        $hash = $result2[0]['vPassword'];
        $checkValid = $AUTH_OBJ->VerifyPassword($vPassword, $hash);
        if ($checkValid == 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_WRONG_DETAIL";
            setDataResponse($returnArr);
        }
        //Added BY HJ On 08-01-2020 For Solved 141 Mantis Bud #2850 Start
        $Data_logout = array();
        $Data_logout['eLogout'] = 'Yes';
        $tableName = "hotel";
        $where = " iHotelId='" . $iMemberId . "'";
        $id = $obj->MySQLQueryPerform($tableName, $Data_logout, 'update', $where);
        //Added BY HJ On 08-01-2020 For Solved 141 Mantis Bud #2850 End
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    }
    if ($id) {
        $returnArr['Action'] = "1";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
##############################################################################
if ($type == "getCabRequestAddress") {
    //global $obj; // Commented By HJ On 15-07-2020 Bcoz Not Required
    $iCabRequestId = isset($_REQUEST["iCabRequestId"]) ? $_REQUEST["iCabRequestId"] : '';
    $iDriverId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    //$fields = "iCabRequestId,iVehicleTypeId,eType,tSourceAddress,tDestAddress,tUserComment,iRentalPackageId,ePayType,ePayWallet,fDistance,fTripGenerateFare,fDuration,iFare,fDiscount,fWalletDebit,eServiceLocation,tVehicleTypeData, iHotelBookingId,vSourceLatitude AS sourceLatitude,vSourceLongitude AS sourceLongitude,vDestLatitude AS destLatitude,vDestLongitude AS destLongitude";
    $fields = "iCabRequestId,iVehicleTypeId,eType,tSourceAddress,tDestAddress,tUserComment,iRentalPackageId,ePayType,ePayWallet,fDistance,fTripGenerateFare,fDuration,iFare,fDiscount,fWalletDebit,eServiceLocation,tVehicleTypeData, iHotelBookingId,vSourceLatitude AS sourceLatitude,vSourceLongitude AS sourceLongitude,vDestLatitude AS destLatitude,vDestLongitude AS destLongitude,iFromStationId,iToStationId,isVideoCall"; //added by SP for fly stations on 27-09-2019
    $Data_cab_request = get_value('cab_request_now', $fields, 'iCabRequestId', $iCabRequestId, '', '');
    //added by SP for fly stations on 27-09-2019 start
    //if($Data_cab_request[0]['iFromStationId']!='' && $Data_cab_request[0]['iToStationId']!='') {
    if (!empty($Data_cab_request[0]['iFromStationId']) && !empty($Data_cab_request[0]['iToStationId'])) {
        $Data_cab_request[0]['eFly'] = "Yes";
    } else {
        $Data_cab_request[0]['eFly'] = "No";
    }
    //added by SP for fly stations on 27-09-2019 end
    $eType = $Data_cab_request[0]['eType'];
    // changed for rental
    if ($Data_cab_request[0]['iRentalPackageId'] == 0) {
        $Data_cab_request[0]['iRentalPackageId'] = "";
    }
    $iRentalPackageId = $Data_cab_request[0]['iRentalPackageId'];
    // end changed for rental
    //if($eType == "UberX"){
    if(empty($vGeneralLang)) {
        $vLang = get_value('register_driver', 'vLang', 'iDriverId', $iDriverId, '', 'true');
        if ($vLang == "" || $vLang == NULL) {
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
        }
    } else {
        $vLang = $vGeneralLang;
    }
    
    $eServiceLocation = $Data_cab_request[0]['eServiceLocation'];
    //$k = preg_replace('/\r|\n/','\n',trim($Data_cab_request[0]['tVehicleTypeData']));
    $replacedata = preg_replace('/[[:cntrl:]]/', '\r\n', $Data_cab_request[0]['tVehicleTypeData']); //apply this when from app enter key is used in special instruction
    $tVehicleTypeData = (array)(json_decode($replacedata));
    $Data_cab_request[0]['moreServices'] = "No";
    if (count($tVehicleTypeData) > 1) {
        $Data_cab_request[0]['moreServices'] = "Yes";
    } else if (!empty($tVehicleTypeData)) {
        $Data_cab_request[0]['moreServices'] = "Yes";
    }

    $langLabelApcKey = md5($cacheKeysArr['language_label_global_config_'] . $iServiceId . "_" . $vLang);
    $getLabelCacheData = $oCache->getData($langLabelApcKey);
    if (!empty($getLabelCacheData) && count($getLabelCacheData) > 0) {
        $languageLabelsArr = $getLabelCacheData;
    } else {
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $setLabelCacheData = $oCache->setData($langLabelApcKey, $languageLabelsArr);
    }

    if ($eServiceLocation == "Driver") {
        $Data_cab_request[0]['tSourceAddress'] = $languageLabelsArr['LBL_AT_YOUR_LOCATION'];
    }
    if ($Data_cab_request[0]['isVideoCall'] == "Yes") {
        $Data_cab_request[0]['tSourceAddress'] = $languageLabelsArr['LBL_VIDEO_CONSULT_AT_YOUR_LOC'];
    }
    // changed for rental
    if ($iRentalPackageId != '') {
        $fields = "iRentalPackageId,fPrice,vPackageName_" . $vLang . "";
        $Data_Rental = get_value('rental_package', $fields, 'iRentalPackageId', $iRentalPackageId, '', '');
        //$fPrice = $Data_Rental[0]['fPrice'];
        $PackageName = $Data_Rental[0]['vPackageName_' . $vLang];
        //$Data_cab_request[0]['fPrice'] = $fPrice;
        $Data_cab_request[0]['PackageName'] = $PackageName;
    }
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    // end changed for rental
    $iVehicleTypeId = $Data_cab_request[0]['iVehicleTypeId'];
    if ($iVehicleTypeId > 0) {
        $sqlv = "SELECT iVehicleCategoryId,vVehicleType_" . $vLang . " as vVehicleTypeName from vehicle_type WHERE iVehicleTypeId = '" . $iVehicleTypeId . "'";
        $tripVehicleData = $obj->MySQLSelect($sqlv);
        $iVehicleCategoryId = $tripVehicleData[0]['iVehicleCategoryId'];
        $vVehicleTypeName = $tripVehicleData[0]['vVehicleTypeName'];
        if ($iVehicleCategoryId != 0) {
            $vVehicleCategoryName = get_value($sql_vehicle_category_table_name, 'vCategory_' . $vLang, 'iVehicleCategoryId', $iVehicleCategoryId, '', 'true');
            $vVehicleTypeName = $vVehicleCategoryName . "-" . $vVehicleTypeName;
        }
    }
    if (count($tVehicleTypeData) > 0) {
        $getMainCat = $obj->MySQLSelect("SELECT VC.vCategory_" . $vLang . " AS vVehicleCategory,VT.iVehicleCategoryId,if(VC.iParentId >0,(SELECT vCategory_" . $vLang . " FROM " . $sql_vehicle_category_table_name . " VC1 WHERE VC.iParentId=VC1.iVehicleCategoryId),'') AS vVehicleCategory FROM vehicle_type VT INNER JOIN " . $sql_vehicle_category_table_name . " VC ON VT.iVehicleCategoryId=VC.iVehicleCategoryId WHERE iVehicleTypeId='" . $tVehicleTypeData[0]->iVehicleTypeId . "'");
        if (count($getMainCat) > 0) {
            $vVehicleTypeName = $getMainCat[0]['vVehicleCategory'];
        }
    }
    if ($eType == "UberX") {
        $Data_cab_request[0]['SelectedTypeName'] = $vVehicleTypeName;
    }
    $Data_cab_request[0]['VehicleTypeName'] = $vVehicleTypeName;
    /* -------------------------------for multi delivery----------------------------------------- */
    if ($eType == "Multi-Delivery") {
        $db_trip_fields = $obj->MySQLSelect("select iTripDeliveryLocationId from trip_delivery_fields where iCabRequestId = '$iCabRequestId' group by iTripDeliveryLocationId");
        $vCurrencyDriver = get_value('register_driver', 'vCurrencyDriver', 'iDriverId', $iDriverId, '', 'true');
        //$vCurrencyDriver = $data[0]['vCurrencyDriver'];
        if ($vCurrencyDriver == '' || $vCurrencyDriver == NULL) {
            $vCurrencyDriver = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        }
        $sql = "SELECT Ratio,vSymbol from currency WHERE vName= '" . $vCurrencyDriver . "'";
        $currencydata = $obj->MySQLSelect($sql);
        $priceRatio = $currencydata[0]['Ratio'];
        $vSymbol = $currencydata[0]['vSymbol'];
        $eUnit = getMemberCountryUnit($iDriverId, "Driver");
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $DisplayDistanceTxt = $languageLabelsArr['LBL_MILE_DISTANCE_TXT'];
        if ($eUnit == "Miles") {
            $tripDistanceDisplay = $Data_cab_request[0]['fDistance'] * 0.621371;
            $tripDistanceDisplay = round($tripDistanceDisplay, 2);
            $DisplayDistanceTxt = $languageLabelsArr['LBL_MILE_DISTANCE_TXT'];
        } else {
            $tripDistanceDisplay = $Data_cab_request[0]['fDistance'];
            $DisplayDistanceTxt = $languageLabelsArr['LBL_KM_DISTANCE_TXT'];
        }
        $tripDistanceDisplay = $tripDistanceDisplay . " " . $DisplayDistanceTxt;
        $hours = floor($Data_cab_request[0]['fDuration'] / 60); // No. of mins/60 to get the hours and round down
        $mins = $Data_cab_request[0]['fDuration'] % 60; // No. of mins/60 - remainder (modulus) is the minutes
        if ($hours >= 1) {
            $tripDurationDisplay = $hours . " " . $languageLabelsArr['LBL_HOURS_TXT'] . ", " . $mins . " " . $languageLabelsArr['LBL_MINUTES_TXT'];
        } else {
            $tripDurationDisplay = $Data_cab_request[0]['fDuration'] . " " . $languageLabelsArr['LBL_MINUTES_TXT'];
        }
        $Data_cab_request[0]['Total_Delivery'] = count($db_trip_fields);
        $fTripGenerateFare = (($Data_cab_request[0]['fTripGenerateFare'] - $Data_cab_request[0]['fDiscount'] - $Data_cab_request[0]['fWalletDebit']) * $priceRatio);
        $fTripGenerateFare = round($fTripGenerateFare, 2);
        //$fTripGenerateFare = $vSymbol . " " . formatNum($fTripGenerateFare);
        $fTripGenerateFare = formateNumAsPerCurrency($fTripGenerateFare, $vCurrencyDriver);
        $Data_cab_request[0]['fDuration'] = $tripDurationDisplay;
        $Data_cab_request[0]['fDistance'] = $tripDistanceDisplay;
        $Data_cab_request[0]['fTripGenerateFare'] = $fTripGenerateFare;
    }
    $Data_delivery = $Data_cab_request[0];
    /* -------------------------------for multi delivery----------------------------------------- */
    if (!empty($Data_cab_request)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $Data_cab_request[0];
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}

############################# Start submitTripHelpDetail ############################################################
if ($type == "submitTripHelpDetail") {
    //global $obj; // Commented By HJ On 15-07-2020 Bcoz Not Required
    $TripId = isset($_REQUEST['TripId']) ? clean($_REQUEST['TripId']) : '';
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iHelpDetailId = isset($_REQUEST['iHelpDetailId']) ? clean($_REQUEST['iHelpDetailId']) : '';
    $vComment = isset($_REQUEST['vComment']) ? clean($_REQUEST['vComment']) : '';
    $appType = isset($_REQUEST['appType']) ? clean($_REQUEST['appType']) : '';
    $current_date = date('Y-m-d H:i:s');
    if ($appType == "Driver") {
        $sql = "SELECT CONCAT(vName,' ',vLastName) as Name FROM `register_driver` WHERE iDriverId='" . $iMemberId . "'";
    } else {
        $sql = "SELECT CONCAT(vName,' ',vLastName) as Name FROM `register_user` WHERE iUserId='" . $iMemberId . "'";
    }
    $Data = $obj->MySQLSelect($sql);
    $Data_trip_help_detail['iTripId'] = $TripId;
    $Data_trip_help_detail['iUserId'] = $iMemberId;
    $Data_trip_help_detail['iHelpDetailId'] = $iHelpDetailId;
    $Data_trip_help_detail['vComment'] = $vComment;
    $Data_trip_help_detail['tDate'] = $current_date;
    $id = $obj->MySQLQueryPerform('trip_help_detail', $Data_trip_help_detail, 'insert');
    if ($id > 0) {
        $vRideNo = get_value('trips', 'vRideNo', 'iTripId', $TripId, '', 'true');
        $maildata['iTripId'] = $vRideNo;
        $maildata['NAME'] = $Data[0]['Name'];
        $maildata['vComment'] = $vComment;
        $maildata['Ddate'] = $current_date;
        $COMM_MEDIA_OBJ->SendMailToMember("RIDER_TRIP_HELP_DETAIL", $maildata);
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_COMMENT_ADDED_TXT";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
############################# End submitTripHelpDetail ############################################################
################################## Get Cancel Reason #############################################################################
if ($type == "GetCancelReasons") {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : "";
    $eUserType = isset($_REQUEST["eUserType"]) ? $_REQUEST["eUserType"] : "";
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : "";
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : "";
    $GeneralUserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : "";
    $iBiddingPostId = isset($_REQUEST["iBiddingPostId"]) ? $_REQUEST["iBiddingPostId"] : "";
    $iPublishedRideId = isset($_REQUEST["iPublishedRideId"]) ? $_REQUEST["iPublishedRideId"] : "";
    if ($eUserType == "Passenger") {
        $UserDetailsArr = getUserCurrencyLanguageDetails($iMemberId);
    } else {
        $UserDetailsArr = getDriverCurrencyLanguageDetails($iMemberId);
    }
    $vLang = $UserDetailsArr['vLang'];
    if ($iTripId != '') {
        //Added By HJ On 04-07-2020 For Optimize trips Table Query Start
        if (isset($tripDetailsArr['trips_' . $iTripId])) {
            $getTripData = $tripDetailsArr['trips_' . $iTripId];
        } else {
            $getTripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $iTripId . "'");
        }
        $eType = $getTripData[0]['eType'];
        //Added By HJ On 04-07-2020 For Optimize trips Table Query End
        //$eType = get_value('trips', 'eType', 'iTripId', $iTripId, '', 'true');
    } else {
        $eType = get_value('cab_booking', 'eType', 'iCabBookingId', $iCabBookingId, '', 'true');
    }
    if ($eType != 'Multi-Delivery' && $iTripId != '') {
        $sql1 = "SELECT count(`iTripId`) AS Total FROM trips WHERE iTripId='" . $iTripId . "' AND iActive = 'Finished'";
        $totalRunning = $obj->MySQLSelect($sql1);
        if ($totalRunning[0]['Total'] > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "DO_RESTART";
            setDataResponse($returnArr);
        }
    }
    if ($eType != 'Multi-Delivery') {
        if ($iTripId != "") {
            $sql = "SELECT cr.vTitle_" . $vLang . " as vTitle,cr.iCancelReasonId FROM cancel_reason as cr LEFT JOIN trips as tr ON cr.eType=tr.eType WHERE cr.eStatus = 'Active' AND tr.iTripId = '" . $iTripId . "' AND (cr.eFor = '" . $GeneralUserType . "' OR cr.eFor='General')";
        } else {
            $sql = "SELECT cr.vTitle_" . $vLang . " as vTitle,cr.iCancelReasonId FROM cancel_reason as cr LEFT JOIN cab_booking as cb ON cr.eType=cb.eType WHERE cr.eStatus = 'Active' AND cb.iCabBookingId = '" . $iCabBookingId . "' AND (cr.eFor = '" . $GeneralUserType . "' OR cr.eFor='General')";
        }
    } else {
        $sql = "SELECT cr.vTitle_" . $vLang . " as vTitle,cr.iCancelReasonId FROM cancel_reason as cr WHERE cr.eType = 'Deliver' AND cr.eStatus = 'Active' AND (cr.eFor = '" . $GeneralUserType . "' OR cr.eFor='General')";
    }
    if (isset($iBiddingPostId) && !empty($iBiddingPostId)) {
        $sql = "SELECT cr.vTitle_" . $vLang . " as vTitle,cr.iCancelReasonId FROM cancel_reason as cr WHERE cr.eType = 'Bidding' AND cr.eStatus = 'Active'";
        $eType = "Bidding";
    }
    if (isset($iPublishedRideId) && !empty($iPublishedRideId)) {
        $sql = "SELECT cr.vTitle_" . $vLang . " as vTitle,cr.iCancelReasonId FROM cancel_reason as cr WHERE cr.eType = 'RideSharing' AND cr.eStatus = 'Active'";
        $eType = "RideSharing";
    }

    $CancelReasonData = $obj->MySQLSelect($sql);

    if (!empty($CancelReasonData)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $CancelReasonData;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}
################################## Get Cancel Reason #############################################################################

###########################Call Masking##########################################################
if ($type == "getCallMaskNumber") {
    //global $tconfig; // Commented By HJ On 15-07-2020 Bcoz Not Required
    $returnArr = array();
    $iTripId = isset($_REQUEST['iTripid']) ? $_REQUEST['iTripid'] : '';
    $UserType = isset($_REQUEST['UserType']) ? $_REQUEST['UserType'] : '';
    if (!empty($iTripId)) {
        if (strtoupper(PACKAGE_TYPE) != "STANDARD") {
            $returnArr = getCallMaskConfigNumber();
        } else {
            $sql = "SELECT rd.vCode as DriverPhoneCode, rd.vPhone as DriverPhone, ru.vPhoneCode as UserPhoneCode, ru.vPhone as RiderPhone FROM `trips` as t LEFT JOIN `register_user` as ru on ru.iUserId = t.iUserId LEFT JOIN `register_driver` as rd on rd.iDriverId= t.iDriverId  WHERE t.iTripId = " . $iTripId . " AND (t.iActive != 'Canceled' && t.iActive != 'Finished')";
            $getTripDetails = $obj->MySQLSelect($sql);
            if ($UserType == "Driver") {
                $phonNum = '+' . $getTripDetails[0]['UserPhoneCode'] . $getTripDetails[0]['RiderPhone'];
            } else {
                $phonNum = '+' . $getTripDetails[0]['DriverPhoneCode'] . $getTripDetails[0]['DriverPhone'];
            }
            $returnArr['Action'] = "1";
            $returnArr['message'] = $phonNum;
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
############################call masking Ends##########################################################
#####################################Update User Wallet Adjustment Setting ###########################################################
if ($type == "UpdateUserWalletAdjustment") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $userType = isset($_REQUEST['UserType']) ? clean($_REQUEST['UserType']) : 'Passenger';
    $eWalletAdjustment = isset($_REQUEST['eWalletAdjustment']) ? $_REQUEST['eWalletAdjustment'] : 'Yes'; // Yes Or No
    if ($userType == "Passenger") {
        $tblname = "register_user";
        $fields = 'iUserId, vPhone,vPhoneCode as vPhoneCode, vEmail, vName, vLastName';
        $condfield = 'iUserId';
    } else {
        $tblname = "register_driver";
        $fields = 'iDriverId, vPhone,vCode as vPhoneCode, vEmail, vName, vLastName';
        $condfield = 'iDriverId';
    }
    $where = " " . $condfield . " = '" . $iMemberId . "'";
    $Data['eWalletAdjustment'] = $eWalletAdjustment;
    $id = $obj->MySQLQueryPerform($tblname, $Data, 'update', $where);
    if ($id) {
        $returnArr['Action'] = "1";
        if ($userType != "Driver") {
            $returnArr['message'] = getPassengerDetailInfo($iMemberId, "", "");
        } else {
            $returnArr['message'] = getDriverDetailInfo($iMemberId);
        }
        //$returnArr['message']  = "LBL_INFO_UPDATED_TXT_MY_PROFILE";
        setDataResponse($returnArr);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_EMAIl_VERIFIED_ERROR";
        setDataResponse($returnArr);
    }
}
#####################################Update User Wallet Adjustment Setting ###########################################################
#####################################DisplayCouponList ###########################################################
if ($type == "DisplayCouponList") {
    $eType = isset($_REQUEST['eType']) ? $_REQUEST['eType'] : '';
    $vSourceLatitude = isset($_REQUEST['vSourceLatitude']) ? $_REQUEST['vSourceLatitude'] : '';
    $vSourceLongitude = isset($_REQUEST['vSourceLongitude']) ? $_REQUEST['vSourceLongitude'] : '';
    $vDestLatitude = isset($_REQUEST['vDestLatitude']) ? $_REQUEST['vDestLatitude'] : '';
    $vDestLongitude = isset($_REQUEST['vDestLongitude']) ? $_REQUEST['vDestLongitude'] : '';
    $tDeliveryLocations = isset($_REQUEST['tDeliveryLocations']) ? $_REQUEST['tDeliveryLocations'] : '';
    $eForVideoConsultation = isset($_REQUEST["eForVideoConsultation"]) ? $_REQUEST["eForVideoConsultation"] : 'No';
    $validPromoCodesArr = getValidPromoCodes();
    if (!empty($validPromoCodesArr) && !empty($validPromoCodesArr['CouponList']) && count($validPromoCodesArr['CouponList']) > 0) {
        if ($MODULES_OBJ->isEnableLocationWisePromoCode()) {
            $validPromoCodesArrTmp = $validPromoCodesArr['CouponList'];
            foreach ($validPromoCodesArrTmp as $key => $promoCodeData) {
                $Source_Address_Array = array($vSourceLatitude, $vSourceLongitude);
                $Dest_Address_Array = array($vDestLatitude, $vDestLongitude);
                $iLocationIdSource = GetUserGeoLocationIdPromoCode($Source_Address_Array);
                $iLocationIdDest = GetUserGeoLocationIdPromoCode($Dest_Address_Array);
                if (((($eType == "Ride" || $eType == "Delivery") && (!in_array($promoCodeData['iLocationId'], $iLocationIdSource) || !in_array($promoCodeData['iLocationId'], $iLocationIdDest))) || ($eType == "UberX" && !in_array($promoCodeData['iLocationId'], $iLocationIdDest)) || $eForVideoConsultation == "Yes") && $promoCodeData['iLocationId'] > 0) {
                    unset($validPromoCodesArr['CouponList'][$key]);
                } elseif ($eType == "Multi-Delivery" && $promoCodeData['iLocationId'] > 0) {
                    // $tDeliveryLocations = json_decode(str_replace("\\", "", $tDeliveryLocations), true);
                    $tDeliveryLocations = json_decode($tDeliveryLocations, true);
                    $tDeliveryLocationsArr = array();
                    $tDeliveryLocationsArr[] = array('latitude' => $vSourceLatitude, 'longitude' => $vSourceLongitude,);
                    foreach ($tDeliveryLocations as $location) {
                        if (isset($location['vReceiverLatitude'])) {
                            $tDeliveryLocationsArr[] = array('latitude' => $location['vReceiverLatitude'], 'longitude' => $location['vReceiverLongitude'],);
                        }
                    }
                    foreach ($tDeliveryLocationsArr as $loc) {
                        $Address_Array = array($loc['latitude'], $loc['longitude']);
                        $iLocationIdArr = GetUserGeoLocationIdPromoCode($Address_Array);
                        if (!in_array($promoCodeData['iLocationId'], $iLocationIdArr)) {
                            unset($validPromoCodesArr['CouponList'][$key]);
                        }
                    }
                }
            }
            $validPromoCodesArr['CouponList'] = array_values($validPromoCodesArr['CouponList']);
        }
    }
    ## Filter Of Coupon Data ##
    if (count($validPromoCodesArr['CouponList']) > 0) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $validPromoCodesArr['CouponList'];
        $returnArr['vCurrency'] = $validPromoCodesArr['vCurrency'];
        $returnArr['vSymbol'] = $validPromoCodesArr['vSymbol'];
        setDataResponse($returnArr);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_RECORDS_FOUND1";
        $returnArr['vCurrency'] = $validPromoCodesArr['vCurrency'];
        $returnArr['vSymbol'] = $validPromoCodesArr['vSymbol'];
        setDataResponse($returnArr);
    }
}
#####################################DisplayCouponList ###########################################################

if ($type == "getYearTotalEarnings") {
    $iDriverId = isset($_REQUEST['iDriverId']) ? clean($_REQUEST['iDriverId']) : '';
    $year = isset($_REQUEST["year"]) ? $_REQUEST["year"] : @date('Y');
    if ($year == "") {
        $year = @date('Y');
    }
    $vCurrencyDriver = get_value('register_driver', 'vCurrencyDriver', 'iDriverId', $iDriverId, '', 'true');
    $vCurrencySymbol = get_value('currency', 'vSymbol', 'vName', $vCurrencyDriver, '', 'true');
    $vLangCode = get_value("register_driver", "vLang", "iDriverId", $iDriverId, '', 'true');
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $lngLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $start = @date('Y');
    $end = '1970';
    $year_arr = array();
    for ($j = $start; $j >= $end; $j--) {
        $year_arr[] = strval($j);
    }
    $Month_Array = array('01' => $lngLabelsArr['LBL_JANUARY'], '02' => $lngLabelsArr['LBL_FEBRUARY'], '03' => $lngLabelsArr['LBL_MARCH'], '04' => $lngLabelsArr['LBL_APRIL'], '05' => $lngLabelsArr['LBL_MAY'], '06' => $lngLabelsArr['LBL_JUNE'], '07' => $lngLabelsArr['LBL_JULY'], '08' => $lngLabelsArr['LBL_AUGUST'], '09' => $lngLabelsArr['LBL_SEPTEMBER'], '10' => $lngLabelsArr['LBL_OCTOBER'], '11' => $lngLabelsArr['LBL_NOVEMBER'], '12' => $lngLabelsArr['LBL_DECEMBER']);
    $sql = "SELECT iTripId,iActive,fCancellationFare,fWalletDebit, fTripGenerateFare, fTipPrice, fCommision, fTax1, fTax2, fOutStandingAmount, fAddedOutstandingamt FROM trips WHERE iDriverId='" . $iDriverId . "' AND tTripRequestDate LIKE '" . $year . "%' AND (iActive = 'Finished' OR iActive = 'Canceled') AND  eSystem = 'General'";
    $tripData = $obj->MySQLSelect($sql);
    $totalEarnings = 0;
    $totalEarnings = 0;
    for ($t = 0; $t < count($tripData); $t++) {
        $iTripId = $tripData[$t]['iTripId'];
        $iActive = $tripData[$t]['iActive'];
        $fCancellationFare = $fWalletDebit = 0;
        if (isset($tripData[$t]['fCancellationFare'])) {
            $fCancellationFare = $tripData[$t]['fCancellationFare'];
        }
        if (isset($tripData[$t]['fWalletDebit'])) {
            $fWalletDebit = $tripData[$t]['fWalletDebit'];
        }
        $tripData_ratingArr[$tripData[$t]['iTripId']] = "0.00";
        if ($iActive == "Finished" || ($iActive == "Canceled" && ($fCancellationFare > 0 || $fWalletDebit > 0))) {
            $memberType = "Driver";
            // $tripPriceDetails = FetchTripFareDetails($iTripId, $iDriverId, $memberType, 'DISPLAY');
            // $iFare = $tripPriceDetails['iFare'];
            // $iFareSum = str_replace(',', '', $iFare);
            $iFareSum = $tripData[$t]['fTripGenerateFare'] + $tripData[$t]['fTipPrice'] - $tripData[$t]['fCommision'] - $tripData[$t]['fTax1'] - $tripData[$t]['fTax2'] - $tripData[$t]['fOutStandingAmount'] - $tripData[$t]['fAddedOutstandingamt'];
            $totalEarnings += $iFareSum;
        }
    }
    $yearmontharr = array();
    $yearmontearningharr_Max = array();
    foreach ($Month_Array as $key => $value) {
        $tripyearmonthdate = $year . "-" . $key;
        $sql_Month = "SELECT iTripId, iActive, fCancellationFare, fWalletDebit, fTripGenerateFare, fTipPrice, fCommision, fTax1, fTax2, fOutStandingAmount, fAddedOutstandingamt FROM trips WHERE iDriverId='" . $iDriverId . "' AND tTripRequestDate LIKE '" . $tripyearmonthdate . "%' AND eSystem = 'General'";
        $tripyearmonthData = $obj->MySQLSelect($sql_Month);
        $tripData_M = strval(count($tripyearmonthData));
        $yearmontearningharr = array();
        $totalEarnings_M = 0;
        for ($t = 0; $t < count($tripyearmonthData); $t++) {
            $iTripId = $tripyearmonthData[$t]['iTripId'];
            $iActive = $tripyearmonthData[$t]['iActive'];
            $fCancellationFare = $fWalletDebit = 0;
            if (isset($tripyearmonthData[$t]['fCancellationFare'])) {
                $fCancellationFare = $tripyearmonthData[$t]['fCancellationFare'];
            }
            if (isset($tripyearmonthData[$t]['fWalletDebit'])) {
                $fWalletDebit = $tripyearmonthData[$t]['fWalletDebit'];
            }
            $tripData_ratingArr[$tripyearmonthData[$t]['iTripId']] = "0.00";
            if ($iActive == "Finished" || ($iActive == "Canceled" && ($fCancellationFare > 0 || $fWalletDebit > 0))) {
                $memberType = "Driver";
                // $tripPriceDetails = FetchTripFareDetails($iTripId, $iDriverId, $memberType, 'DISPLAY');
                // $iFare = $tripPriceDetails['iFare'];
                // $iFareSum = str_replace(',', '', $iFare);
                $iFareSum = $tripyearmonthData[$t]['fTripGenerateFare'] + $tripyearmonthData[$t]['fTipPrice'] - $tripyearmonthData[$t]['fCommision'] - $tripyearmonthData[$t]['fTax1'] - $tripyearmonthData[$t]['fTax2'] - $tripyearmonthData[$t]['fOutStandingAmount'] - $tripyearmonthData[$t]['fAddedOutstandingamt'];
                $totalEarnings_M += $iFareSum;
            }
        }
        $yearmontearningharr_Max[] = $totalEarnings_M;
        $yearmontearningharr["CurrentMonth"] = $value;
        $yearmontearningharr["TotalEarnings"] = strval(round($totalEarnings_M < 0 ? 0 : $totalEarnings_M, 1));
        $yearmontearningharr["TripCount"] = strval(round($tripData_M, 1));
        array_push($yearmontharr, $yearmontearningharr);
    }
    foreach ($yearmontearningharr_Max as $key => $value) {
        if ($value >= $max) $max = $value;
    }
    $returnArr['Action'] = "1";
    $returnArr['TotalEarning'] = formateNumAsPerCurrency(round($totalEarnings, 1), $vCurrencyDriver);
    $returnArr['TripCount'] = strval(count($tripData));
    $returnArr["CurrentYear"] = $year;
    $returnArr['MaxEarning'] = strval($max);
    $returnArr['YearMonthArr'] = $yearmontharr;
    $returnArr['YearArr'] = $year_arr;
    setDataResponse($returnArr);
}
####################################################################################
if ($type == 'requestResetPassword') {
    global $obj, $tconfig, $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD; // Commented By HJ On 15-07-2020 Bcoz Not Required
    $Emid = isset($_REQUEST["vEmail"]) ? $_REQUEST["vEmail"] : '';
    /*for email optional*/
    $isEmail = isset($_REQUEST["isEmail"]) ? $_REQUEST["isEmail"] : 'Yes';
    $phoneCode = isset($_REQUEST["PhoneCode"]) ? $_REQUEST["PhoneCode"] : '';
    $userType = isset($_REQUEST["UserType"]) ? clean($_REQUEST["UserType"]) : ''; // UserType = Driver/Passenger
    if ($userType == "" || $userType == NULL) {
        $userType = "Passenger";
    }
    if ($userType == "Passenger") {
        $tblname = "register_user";
        $fields = 'h.iUserId as iMemberId, h.vPhone,h.vPhoneCode as vPhoneCode, h.vEmail, h.vName, h.vLastName, h.vPassword, h.vLang';
        $condfield = 'iUserId';
        $EncMembertype = base64_encode(base64_encode('rider'));
        /*for email optional*/
        $ssql_digits = "";
        if (isOnlyDigitsStrSGF($Emid) && !empty($phoneCode) && $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == "Yes") {
            $ssql_digits = " AND  h.vPhoneCode = '" . $phoneCode . "'";
        }
        $sql = "select $fields from $tblname as h where (h.vEmail = '" . $Emid . "' OR  h.vPhone = '" . $Emid . "') " . $ssql_digits;
    } elseif ($userType == "Tracking") {
        $tblname = "track_service_users";
        $fields = 'h.iTrackServiceUserId as iMemberId, h.vPhone,h.vPhoneCode as vPhoneCode, h.vEmail, h.vName, h.vLastName, h.vPassword, h.vLang';
        $condfield = 'iTrackServiceUserId';
        $EncMembertype = base64_encode(base64_encode('tracking'));
        /*for email optional*/
        $ssql_digits = "";
        if (isOnlyDigitsStrSGF($Emid) && !empty($phoneCode) && $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == "Yes") {
            $ssql_digits = " AND  h.vPhoneCode = '" . $phoneCode . "'";
        }
        $sql = "select $fields from $tblname as h where (h.vEmail = '" . $Emid . "' OR  h.vPhone = '" . $Emid . "') " . $ssql_digits;
    } else if ($userType == "Driver") {
        $tblname = "register_driver";
        $fields = 'h.iDriverId  as iMemberId, h.vPhone,h.vCode as vPhoneCode, h.vEmail, h.vName, h.vLastName,h.vPassword, h.vLang';
        $condfield = 'iDriverId';
        $EncMembertype = base64_encode(base64_encode('driver'));
        /*for email optional*/
        $ssql_digits = "";
        if (isOnlyDigitsStrSGF($Emid) && !empty($phoneCode) && $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == "Yes") {
            $ssql_digits = " AND  h.vCode = '" . $phoneCode . "'";
        }
        $sql = "select $fields from $tblname as h where (h.vEmail = '" . $Emid . "') OR (h.vPhone = '" . $Emid . "' " . $ssql_digits . " )";
    } else {
        $tblname = "hotel";
        $fields = 'h.iHotelId  as iMemberId, a.vContactNo,a.vCode as vPhoneCode, a.vEmail, a.vFirstName, a.vLastName, a.vPassword, h.vLang';
        $condfield = 'iHotelId';
        $EncMembertype = base64_encode(base64_encode('hotel'));
        // if(isset($_REQUEST["isEmail"])){
        // $sql = "select $fields from $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId where a.vEmail = '" . $Emid . "'";
        $ssql_digits = "";
        if (isOnlyDigitsStrSGF($Emid) && !empty($phoneCode) && $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == "Yes") {
            $ssql_digits = " AND  a.vCode = '" . $phoneCode . "'";
        }
        $sql = "select $fields from $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId where (a.vEmail = '" . $Emid . "') OR (a.vContactNo = '" . $Emid . "' " . $ssql_digits . " )";
        // if($isEmail == "Yes"){
        //     $sql = "select $fields from $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId where a.vEmail = '" . $Emid . "'";
        // } else {
        //     $sql = "select $fields from $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId where a.vContactNo = '" . $Emid . "' AND vCode='".$phoneCode."'";
        // }
        // }else{
        //     $sql = "select $fields from $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId where a.vEmail = '" . $Emid . "'";
        // }
    }
    //$sql = "select $fields from $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId where a.vEmail = '" . $Emid . "'"; // Commented By HJ On 02-01-2019 For Query Issue
    $db_member = $obj->MySQLSelect($sql);
    if (count($db_member) > 0) {
        $vLangCode = $db_member[0]['vLang'];
        if ($vLangCode == "" || $vLangCode == NULL) {
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
        $clickherelabel = $languageLabelsArr['LBL_CLICKHERE_SIGNUP'];
        $milliseconds = time();
        $tempGenrateCode = substr($milliseconds, 1);
        $Today = Date('Y-m-d H:i:s');
        $today = base64_encode(base64_encode($Today));
        $type = $EncMembertype;
        $id = encrypt($db_member[0]["iMemberId"]);
        $newToken = RandomString(32);
        $url = $tconfig["tsite_url"] . 'reset_password.php?type=' . $type . '&id=' . $id . '&_token=' . $newToken;
        $link = get_tiny_url($url);
        $activation_text = '<a href="' . $url . '" target="_blank"> ' . $clickherelabel . ' </a>';
        $maildata['EMAIL'] = $db_member[0]["vEmail"];
        $maildata['NAME'] = $db_member[0]["vFirstName"] . " " . $db_member[0]["vLastName"];
        // if($isEmail == "Yes"){
        //     $maildata['LINK'] = $activation_text;
        //     $status = $COMM_MEDIA_OBJ->SendMailToMember("CUSTOMER_RESET_PASSWORD", $maildata);
        // } else {
        //     $maildata['LINK'] = $link;
        //     $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("CUSTOMER_RESET_PASSWORD", $maildata, "", $vLangCode);
        //     $status = $COMM_MEDIA_OBJ->SendSystemSMS($Emid,$phoneCode,$message_layout);
        // }
        if (isOnlyDigitsStrSGF($Emid) && !empty($phoneCode) && $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == "Yes") {
            $maildata['LINK'] = $link;
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("CUSTOMER_RESET_PASSWORD", $maildata, "", $vLangCode);
            $status = $COMM_MEDIA_OBJ->SendSystemSMS($Emid, $phoneCode, $message_layout);
        } else {
            $maildata['LINK'] = $activation_text;
            $status = $COMM_MEDIA_OBJ->SendMailToMember("CUSTOMER_RESET_PASSWORD", $maildata);
        }
        if ($tblname == "hotel") {
            $sql = "UPDATE $tblname as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId  set vPassword_token='" . $newToken . "' WHERE vEmail='" . $Emid . "' and a.eStatus != 'Deleted'";
        } else {
            $sql = "UPDATE $tblname set vPassword_token='" . $newToken . "' WHERE (vEmail='" . $Emid . "' OR vPhone='" . $Emid . "' ) and eStatus != 'Deleted'";
        }
        $obj->sql_query($sql);
        if ($status == 1) {
            $returnArr['Action'] = "1";
            // $returnArr['message'] = "LBL_PASSWORD_SENT_TXT";
            if (isOnlyDigitsStrSGF($Emid) && !empty($phoneCode) && $ENABLE_PHONE_LOGIN_VIA_COUNTRY_SELECTION_METHOD == "Yes") {
                $returnArr['message'] = "LBL_PASSWORD_SENT_TXT_SMS";
            } else {
                $returnArr['message'] = "LBL_PASSWORD_SENT_TXT";
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_ERROR_PASSWORD_MAIL";
        }
    } else {
        $returnArr['Action'] = "0";
        if ($isEmail == "Yes") {
            $returnArr['message'] = "LBL_WRONG_EMAIL_PASSWORD_TXT";
        } else {
            $returnArr['message'] = "LBL_INVALID_PHONE_NUMBER";
        }
    }
    setDataResponse($returnArr);
}

###########################################################################
if ($type == "cancelCabRequest") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $iCabRequestId = isset($_REQUEST["iCabRequestId"]) ? $_REQUEST["iCabRequestId"] : '';
    /* For New Payment Flow */
    $params = array("iMemberId" => $iUserId, "eUserType" => "Passenger", "GET_DATA" => "Yes");
    $payment_mode_data = GetPaymentModeDetails($params);
    $ePaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
    $cashPayment = $ePaymentMode == "cash" ? "Yes" : "No";
    $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
    $isRestrictToWallet = $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
    /* For New Payment Flow End */
    if ($iCabRequestId == "") {
        // $data = get_value('cab_request_now', 'max(iCabRequestId),eStatus', 'iUserId',$iUserId);
        $sql = "SELECT iCabRequestId, eStatus FROM cab_request_now WHERE iUserId='" . $iUserId . "' ORDER BY iCabRequestId DESC LIMIT 1 ";
        $data = $obj->MySQLSelect($sql);
        $iCabRequestId = $data[0]['iCabRequestId'];
        $eStatus = $data[0]['eStatus'];
    } else {
        $data = get_value('cab_request_now', 'eStatus', 'iCabRequestId', $iCabRequestId, '', 'true');
        $eStatus = $data[0]['eStatus'];
    }
    if ($eStatus == "Requesting") {
        $where = " iCabRequestId='" . $iCabRequestId . "'";
        $Data_update_cab_request['eStatus'] = "Cancelled";
        $id = $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_request, 'update', $where);
        if ($id) {
            //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 Start
            // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
            if (strtoupper($ePayWallet) == "YES") {
                $obj->sql_query("UPDATE trip_outstanding_amount set iAuthoriseId = '0',eAuthoriseIdName = 'No' WHERE iUserId = '" . $iUserId . "' AND iAuthoriseId='" . $iCabRequestId . "' AND eAuthoriseIdName='iCabRequestId'");
            }
            //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 End
            $returnArr['Action'] = "1";
            $returnArr['message'] = "DO_RESET";
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_REQUEST_CANCEL_FAILED_TXT";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "DO_RESTART";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "sendRequestToDrivers") {
    $driver_id_auto = isset($_REQUEST["driverIds"]) ? $_REQUEST["driverIds"] : '';
    $message = isset($_REQUEST["message"]) ? $_REQUEST["message"] : '';
    $passengerId = isset($_REQUEST["userId"]) ? $_REQUEST["userId"] : '';
    $cashPayment = isset($_REQUEST["CashPayment"]) ? $_REQUEST["CashPayment"] : 'No';
    $selectedCarTypeID = isset($_REQUEST["SelectedCarTypeID"]) ? $_REQUEST["SelectedCarTypeID"] : 0;
    $eFemaleDriverRequest = isset($_REQUEST["eFemaleDriverRequest"]) ? $_REQUEST["eFemaleDriverRequest"] : '';
    $eHandiCapAccessibility = isset($_REQUEST["eHandiCapAccessibility"]) ? $_REQUEST["eHandiCapAccessibility"] : '';
    $PickUpLatitude = isset($_REQUEST["PickUpLatitude"]) ? $_REQUEST["PickUpLatitude"] : '0.0';
    $PickUpLongitude = isset($_REQUEST["PickUpLongitude"]) ? $_REQUEST["PickUpLongitude"] : '0.0';
    $PickUpAddress = isset($_REQUEST["PickUpAddress"]) ? $_REQUEST["PickUpAddress"] : '';
    $DestLatitude = isset($_REQUEST["DestLatitude"]) ? $_REQUEST["DestLatitude"] : '';
    $DestLongitude = isset($_REQUEST["DestLongitude"]) ? $_REQUEST["DestLongitude"] : '';
    $DestAddress = isset($_REQUEST["DestAddress"]) ? $_REQUEST["DestAddress"] : '';
    $promoCode = isset($_REQUEST["PromoCode"]) ? $_REQUEST["PromoCode"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';
    $iPackageTypeId = isset($_REQUEST["iPackageTypeId"]) ? $_REQUEST["iPackageTypeId"] : '';
    $vReceiverName = isset($_REQUEST["vReceiverName"]) ? $_REQUEST["vReceiverName"] : '';
    $vReceiverMobile = isset($_REQUEST["vReceiverMobile"]) ? $_REQUEST["vReceiverMobile"] : '';
    $tPickUpIns = isset($_REQUEST["tPickUpIns"]) ? $_REQUEST["tPickUpIns"] : '';
    $tDeliveryIns = isset($_REQUEST["tDeliveryIns"]) ? $_REQUEST["tDeliveryIns"] : '';
    $tPackageDetails = isset($_REQUEST["tPackageDetails"]) ? $_REQUEST["tPackageDetails"] : '';
    $vDeviceToken = isset($_REQUEST["vDeviceToken"]) ? $_REQUEST["vDeviceToken"] : '';
    $iUserPetId = isset($_REQUEST["iUserPetId"]) ? $_REQUEST["iUserPetId"] : '0';
    $quantity = isset($_REQUEST["Quantity"]) ? $_REQUEST["Quantity"] : '';
    $fTollPrice = isset($_REQUEST["fTollPrice"]) ? $_REQUEST["fTollPrice"] : '';
    $vTollPriceCurrencyCode = isset($_REQUEST["vTollPriceCurrencyCode"]) ? $_REQUEST["vTollPriceCurrencyCode"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $eTollSkipped = isset($_REQUEST["eTollSkipped"]) ? $_REQUEST["eTollSkipped"] : 'Yes';
    $iUserAddressId = isset($_REQUEST["iUserAddressId"]) ? $_REQUEST["iUserAddressId"] : '0';
    $tUserComment = isset($_REQUEST["tUserComment"]) ? $_REQUEST["tUserComment"] : '';
    $eWalletDebitAllow = isset($_REQUEST["eWalletDebitAllow"]) ? $_REQUEST["eWalletDebitAllow"] : 'No';
    $vDistance = isset($_REQUEST["vDistance"]) ? $_REQUEST["vDistance"] : '';
    $vDuration = isset($_REQUEST["vDuration"]) ? $_REQUEST["vDuration"] : '';
    // payment flow 2 changes
    $eWalletIgnore = isset($_REQUEST["eWalletIgnore"]) ? $_REQUEST["eWalletIgnore"] : 'No';
    $ePayWallet = isset($_REQUEST["ePayWallet"]) ? $_REQUEST["ePayWallet"] : 'No';
    $iTripReasonId = isset($_REQUEST["iTripReasonId"]) ? $_REQUEST["iTripReasonId"] : '';
    $vReasonTitle = isset($_REQUEST["vReasonTitle"]) ? $_REQUEST["vReasonTitle"] : ''; // For Other Reason
    // kiosk changes
    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? trim($_REQUEST['GeneralUserType']) : '';
    $iHotelId = isset($_REQUEST["iHotelId"]) ? $_REQUEST["iHotelId"] : '0';
    /* added for rental */
    $iRentalPackageId = isset($_REQUEST["iRentalPackageId"]) ? $_REQUEST["iRentalPackageId"] : '';
    // add for hotel
    $eBookingFrom = isset($_REQUEST["eBookingFrom"]) ? $_REQUEST["eBookingFrom"] : '';
    $iHotelBookingId = isset($_REQUEST["iHotelBookingId"]) ? $_REQUEST["iHotelBookingId"] : '';
    $trip_status = "Requesting";
    $ePaymentBy = isset($_REQUEST["ePaymentBy"]) ? $_REQUEST["ePaymentBy"] : '';
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
    $orderDetails = isset($_REQUEST['OrderDetails']) ? $_REQUEST['OrderDetails'] : '';
    $eServiceLocation = isset($_REQUEST['eServiceLocation']) ? $_REQUEST['eServiceLocation'] : 'Passanger';
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
    $total_del_dist = isset($_REQUEST["total_del_dist"]) ? $_REQUEST["total_del_dist"] : '';
    $total_del_time = isset($_REQUEST["total_del_time"]) ? $_REQUEST["total_del_time"] : '';
    //added by SP for fly stations on 19-08-2019 start
    $iFromStationId = isset($_REQUEST["iFromStationId"]) ? $_REQUEST["iFromStationId"] : '';
    $iToStationId = isset($_REQUEST["iToStationId"]) ? $_REQUEST["iToStationId"] : '';
    $iPaymentInfoId = isset($_REQUEST["iPaymentInfoId"]) ? $_REQUEST["iPaymentInfoId"] : '';
    $eBookingFromWeb = isset($_REQUEST["eBookingFromWeb"]) ? $_REQUEST["eBookingFromWeb"] : 'No';
    $isVideoCall = isset($_REQUEST["isVideoCall"]) ? $_REQUEST["isVideoCall"] : 'No';
    $eSystemAppType = isset($_REQUEST["eSystemAppType"]) ? $_REQUEST["eSystemAppType"] : '';
    $ePoolRequest = isset($_REQUEST["ePoolRequest"]) ? $_REQUEST["ePoolRequest"] : 'No';
    $adminSkip = isset($_REQUEST["adminSkip"]) ? $_REQUEST["adminSkip"] : 'No';
    /* Check if existing request completed */
    // $current_date = date('Y-m-d H:i:s');
    // $accept_duration = $RIDER_REQUEST_ACCEPT_TIME;
    // $requests = $obj->MySQLSelect("SELECT iRequestId, iUserId, dAddedDate, '$current_date' as current_time1, TIMESTAMPDIFF(SECOND, dAddedDate, '$current_date') as timediff FROM `passenger_requests` WHERE iUserId = '$passengerId' HAVING timediff <= $accept_duration");
    // if(!empty($requests) && count($requests) > 0) {
    //     $returnArr['Action'] = "0";
    //     $returnArr["message"] = "LBL_REQUEST_INPROCESS_TXT";
    //     $returnArr["message1"] = "REQ_PROCESS";
    //     setDataResponse($returnArr);
    // }
    /* Check if existing request completed */
    /*$iCabRequestId_cab_now = $obj->MySQLSelect("SELECT iCabRequestId FROM `cab_request_now` WHERE iUserId = $passengerId AND eStatus = 'Requesting' ");
    if(count($iCabRequestId_cab_now))
    {
            $iCabRequestId_cab_now_id = $iCabRequestId_cab_now[0]['iCabRequestId'];
            $where_cab_now = " iCabRequestId = '$iCabRequestId_cab_now_id' ";
            $Data_update_cab_now['eStatus'] = "Cancelled";
            $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_now, 'update', $where_cab_now);

    }*/
    $eFly = "";
    if ($message != "") {
        $message_data = json_decode($message, true);
        $eFly = $message_data['eFly'];
    }
    $orderDetails = preg_replace('/[[:cntrl:]]/', '\r\n', $orderDetails);
    if ((empty($orderDetails) || $orderDetails == "[]") && $eType == "UberX") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
        setDataResponse($returnArr);
    }
    /* Added by HV on 17-02-2021 for  Multiple stopover points | Flat trip should not be applied */
    $stopoverpoint_arr = isset($_REQUEST['stopoverpoint_arr']) ? $_REQUEST['stopoverpoint_arr'] : '';
    $stopoverPointArr = array();
    $StopOverPointAdded = "No";
    if (!empty($stopoverpoint_arr)) {
        $stopoverPointArr = json_decode($stopoverpoint_arr, true);
        $StopOverPointAdded = "Yes";
    }
    /* Added by HV on 17-02-2021 for  Multiple stopover points | Flat trip should not be applied End */
    if (!empty($iFromStationId) && !empty($iToStationId)) {
        $Data_update_passenger['iFromStationId'] = $iFromStationId;
        $Data_update_passenger['iToStationId'] = $iToStationId;
    }
    $eFly = "";
    if (!empty($message)) {
        $message_data = json_decode($message, true);
        $eFly = $message_data['eFly'];
    }
    //added by SP for fly stations on 19-08-2019 end
    /* For New Payment Flow */
    if ($eBookingFromWeb == "No") {
        $params = array("iMemberId" => $passengerId, "eUserType" => "Passenger", "eType" => $eType, "GET_DATA" => "Yes");
        $payment_mode_data = GetPaymentModeDetails($params);
        $ePaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
        $cashPayment = $ePaymentMode == "cash" ? "Yes" : "No";
        $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
        $eWalletDebitAllow = $ePaymentMode == "wallet" ? "Yes" : ($payment_mode_data['eWalletDebit'] == "Yes" ? "Yes" : "No");
        $iTripReasonId = $payment_mode_data['BusinessReasonId'];
        $vReasonTitle = $iTripReasonId > 0 ? $payment_mode_data['BusinessReasonTitle'] : $payment_mode_data['BusinessReasonOther'];
        $isRestrictToWallet = $isVideoCall == "Yes" ? "Yes" : $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
        $iUserProfileId = $_REQUEST["iUserProfileId"] = $payment_mode_data['iUserProfileId'];
        $iOrganizationId = $_REQUEST["iOrganizationId"] = $payment_mode_data['iOrganizationId'];
        if ($eType != "Multi-Delivery") {
            $ePaymentBy = $_REQUEST["ePaymentBy"] = $payment_mode_data['ePaymentBy'];
        }
        $vProfileEmail = $_REQUEST["vProfileEmail"] = $payment_mode_data['vProfileEmail'];
        $iPaymentInfoId = $payment_mode_data['iPaymentInfoId'];
        $promoCode = !empty($promoCode) ? $promoCode : $payment_mode_data['PromoCode'];
        $obj->sql_query("UPDATE payment_mode_user_log SET vPromocode = '' WHERE iLogId = '" . $payment_mode_data['iLogId'] . "'");
    } else {
        $ePaymentMode = "Cash";
        $cashPayment = "Yes";
    }
    /* For New Payment Flow End */
    // check promocode valid or not
    if (($iHotelId == '' || $iHotelId < 1) && (strtolower($GeneralUserType) == 'hotel' || strtolower($GeneralUserType) == 'kiosk')) {
        $GeneralMemberId = isset($_REQUEST['GeneralMemberId']) ? trim($_REQUEST['GeneralMemberId']) : '';
        $iHotelId = $GeneralMemberId;
    }
    if ($iHotelId > 0) {
        $hotel_data = $obj->MySQLSelect("SELECT administrators.vAddress,administrators.vFirstName, hotel.iAdminId FROM administrators, hotel WHERE administrators.iAdminId = hotel.iAdminId AND hotel.iHotelId = '" . $iHotelId . "' AND hotel.eStatus = 'Active' AND administrators.eStatus = 'Active'");
        if (empty($hotel_data) || count($hotel_data) == 0) {
            $returnArr = array();
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_HOTEL_DISABLED";
            setDataResponse($returnArr);
        }
        if (!empty($hotel_data)) {
            $PickUpAddress = $hotel_data[0]['vFirstName'] . " \n" . $hotel_data[0]['vAddress'];
        }
    }
    $vDuration = empty($vDuration) ? 0 : $vDuration;
    $vDistance = empty($vDistance) ? 0 : $vDistance;
    $vDuration = round(($vDuration / 60), 2);
    $vDistance = round(($vDistance / 1000), 2);
    /*if ($eWalletDebitAllow == "" || $eWalletDebitAllow == NULL) {
        $eWalletDebitAllow = "Yes";
    }*/
    if (strtolower($eSystemAppType) == 'kiosk') {
        $eWalletDebitAllow = "No";
        $ePaymentMode = "Cash";
        $cashPayment = "Yes";
    }
    //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount Start
    $TripData = $fareDetails = array();
    if ($SERVICE_PROVIDER_FLOW == "Provider" && $eType == "UberX") {
        $fareDetails = getVehicleTypeFareDetails();
        $typeDataArr = json_decode($orderDetails);
        if (!empty($fareDetails)) {
            $Data_update_passenger['tVehicleTypeFareData'] = json_encode($fareDetails['tripFareDetailsSaveArr']);
        }
        $selectedCarTypeID = 0;
        if (count($typeDataArr) == 1) {
            $selectedCarTypeID = $typeDataArr[0]->iVehicleTypeId;
        }
    }
    if (empty($eServiceLocation)) {
        $eServiceLocation = "Passenger";
    }
    ####### blocking code ################
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $BlockData = getBlockData("Passenger", $passengerId);
        if (!empty($BlockData) || $BlockData != "") {
            setDataResponse($BlockData);
        }
    }
    ####### blocking code ################
    $Data_cabrequest = $obj->MySQLSelect("SELECT iCabRequestId,eStatus FROM `cab_request_now` WHERE iUserId='" . $passengerId . "' ORDER BY iCabRequestId DESC LIMIT 0,1");
    $iCabRequestId_cab_now = $eStatus_cab_now = "";
    if (count($Data_cabrequest) > 0) {
        $iCabRequestId_cab_now = $Data_cabrequest[0]['iCabRequestId'];
        $eStatus_cab_now = $Data_cabrequest[0]['eStatus'];
        if ($eStatus_cab_now == "Requesting") {
            $where_cab_now = " iCabRequestId = '$iCabRequestId_cab_now' ";
            $Data_update_cab_now['eStatus'] = "Cancelled";
            $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_now, 'update', $where_cab_now);
        }
    }
    if($adminSkip == 'No'){
    isMemberEmailPhoneVerified($passengerId, "Passenger");
    }
    ## check pickup addresss for UberX #
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations","APP_TYPE");
    if ($eType == "") {
        $eType = $APP_TYPE == "Delivery" ? "Deliver" : $APP_TYPE;
    }
    $CheckSurgeAddress = $PickUpAddress;
    $Data_update_passenger['tSourceAddress'] = $PickUpAddress;
    if ($eType == "UberX") {
        $Data_update_passenger['tUserComment'] = $tUserComment;
        if ($iUserAddressId != "" && $iUserAddressId > 0) {
            $Address = get_value('user_address', 'vAddressType,vBuildingNo,vLandmark,vServiceAddress,vLatitude,vLongitude', '   iUserAddressId', $iUserAddressId, '', '');
            $vAddressType = $Address[0]['vAddressType'];
            $vBuildingNo = $Address[0]['vBuildingNo'];
            $vLandmark = $Address[0]['vLandmark'];
            $vServiceAddress = $Address[0]['vServiceAddress'];
            $PickUpAddress = ($vAddressType != "") ? $vAddressType . "\n" : "";
            $PickUpAddress .= ($vBuildingNo != "") ? $vBuildingNo . "," : "";
            $PickUpAddress .= ($vLandmark != "") ? $vLandmark . "\n" : "";
            $PickUpAddress .= ($vServiceAddress != "") ? $vServiceAddress : "";
            $Data_update_passenger['tSourceAddress'] = $PickUpAddress;
            $Data_update_passenger['iUserAddressId'] = $iUserAddressId;
            $PickUpLatitude = $Address[0]['vLatitude'];
            $PickUpLongitude = $Address[0]['vLongitude'];
            $CheckSurgeAddress = $vServiceAddress;
        } else {
            if ($eServiceLocation == "Driver" && $SERVICE_PROVIDER_FLOW == "Provider") {
                $provider_data = get_value('register_driver', 'eSelectWorkLocation,vWorkLocationLatitude,vWorkLocationLongitude,vWorkLocation,vLatitude,vLongitude,vLang', 'iDriverId', $driver_id_auto);
                if ($provider_data[0]['eSelectWorkLocation'] == "Dynamic") {
                    $PickUpLatitude = $provider_data[0]['vLatitude'];
                    $PickUpLongitude = $provider_data[0]['vLongitude'];
                    $PickUpAddress = "";
                    //added by SP on 05-09-2020 for getting user address from the api as discussed with KS start.
                    //this is when useraddress is not there, eServiceLocation is Driver, eSelectWorkLocation is Dynamic
                    $vLangProvider = $provider_data[0]['vLang'];
                    $requestDataArr = array();
                    $requestDataArr['LATITUDE'] = $PickUpLatitude;
                    $requestDataArr['LONGITUDE'] = $PickUpLongitude;
                    $requestDataArr['LANGUAGE_CODE'] = $vLangProvider;
                    $direction_data = getAddressFromGeoLocations($requestDataArr);
                    $PickUpAddress = $direction_data['address'];
                    //added by SP on 05-09-2020 for getting user address from the api as discussed with KS end.
                } else {
                    $PickUpLatitude = $provider_data[0]['vWorkLocationLatitude'];
                    $PickUpLongitude = $provider_data[0]['vWorkLocationLongitude'];
                    $PickUpAddress = $provider_data[0]['vWorkLocation'];
                }
            }
            $Data_update_passenger['tSourceAddress'] = $PickUpAddress;
        }
    }
    ## check pickup addresss for UberX #
    ### Checking For Pickup And DropOff Disallow ###
    $pickuplocationarr = array($PickUpLatitude, $PickUpLongitude);
    $allowed_ans_pickup = checkAreaRestriction($pickuplocationarr, "No");
    if ($allowed_ans_pickup == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICKUP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    if ($DestLatitude != "" && $DestLongitude != "") {
        $dropofflocationarr = array($DestLatitude, $DestLongitude);
        $allowed_ans_dropoff = checkAreaRestriction($dropofflocationarr, "Yes");
        if ($allowed_ans_dropoff == "No") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_DROP_LOCATION_NOT_ALLOW";
            setDataResponse($returnArr);
        }
    }
    ### Checking For Pickup And DropOff Disallow ###
    //Added By HJ On 17-06-2020 For Optimize language_master Table Query Start
    $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
    //Added By HJ On 17-06-2020 For Optimize language_master Table Query End
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $userwaitinglabel = $languageLabelsArr['LBL_TRIP_USER_WAITING'];
    $alertMsg = $languageLabelsArr['LBL_DELIVERY_SENDER_WAITING'];
    if ($eType == "UberX") {
        $alertMsg = $languageLabelsArr['LBL_USER_WAITING'];
    } else if ($eType == "Ride") {
        $alertMsg = $userwaitinglabel;
    }
    $address_data['PickUpAddress'] = $PickUpAddress;
    $address_data['DropOffAddress'] = $DestAddress;
    $DropOff = "No";
    if ($DestLatitude != "" && $DestLongitude != "") {
        $DropOff = "Yes";
    }
    $DataArr = FetchAvailableDrivers($PickUpLatitude, $PickUpLongitude, $address_data, $DropOff, "No", "No", "", $DestLatitude, $DestLongitude, $eType, "", $driver_id_auto);
    // echo "<pre>"; print_r($DataArr); exit;
    $Data = $DataArr['DriverList'];
   // echo "<pre>"; print_r($Data); exit;
    $driver_id_auto_tmp = "";
    $driverDataIdsArr_tmp = array();
    foreach ($Data as $driver_item_tmp) {
        if ((strtoupper($driver_item_tmp['ACCEPT_CASH_TRIPS']) == "YES" && strtoupper($ePaymentMode) == "CASH" ) ||  strtoupper($ePaymentMode) != "CASH" || strtoupper($ePoolRequest) == "YES") {
            $driverDataIdsArr_tmp[] = $driver_item_tmp['iDriverId'];
        }
    }
        
    $driverIdsArr_tmp = explode(",", $driver_id_auto);

    foreach ($driverIdsArr_tmp as $driverId_tmp) {
        if (in_array($driverId_tmp, $driverDataIdsArr_tmp)) {
            $driver_id_auto_tmp = $driver_id_auto_tmp == "" ? $driverId_tmp : $driver_id_auto_tmp . "," . $driverId_tmp;
        }
    }
    $driver_id_auto = $driver_id_auto_tmp;

    if ($DataArr['PickUpDisAllowed'] == "No" && $DataArr['DropOffDisAllowed'] == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICK_DROP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    if ($DataArr['PickUpDisAllowed'] == "Yes" && $DataArr['DropOffDisAllowed'] == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_DROP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    if ($DataArr['PickUpDisAllowed'] == "No" && $DataArr['DropOffDisAllowed'] == "Yes") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICKUP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    //Added By HJ On 20-06-2020 For Optimization register_user Table Query Start
    if (isset($userDetailsArr["register_user_" . $passengerId])) {
        $UserDetail = $userDetailsArr["register_user_" . $passengerId];
    } else {
        $UserDetail = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $passengerId . "'");
        $userDetailsArr["register_user_" . $passengerId] = $UserDetail;
    }
    if (count($UserDetail) > 0) {
        $vCurrencyPassenger = $UserDetail[0]['vCurrencyPassenger'];
        if (isset($currencyAssociateArr[$vCurrencyPassenger])) {
            $userCurrencyData = $currencyAssociateArr[$vCurrencyPassenger];
            $UserDetail[0]['Ratio'] = $userCurrencyData['Ratio'];
            $UserDetail[0]['vSymbol'] = $userCurrencyData['vSymbol'];
        }
    }
    $passengerData = array();
    if (count($UserDetail) > 0) {
        $passengerData = $UserDetail;
    }
    $userLanguageCode = $passengerData[0]['vLang'];
    if (empty($userLanguageCode)) {
        $userLanguageCode = $vLangCode;
        $userLanguageLabelsArr = $languageLabelsArr;
    } else {
        if ($userLanguageCode == $vLangCode) {
            $userLanguageLabelsArr = $languageLabelsArr;
        } else {
            $userLanguageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userLanguageCode, "1", $iServiceId);
        }
    }
    $iGcmRegId = $passengerData[0]['iGcmRegId'];
    if ($vDeviceToken != "" && $vDeviceToken != $iGcmRegId) {
        $returnArr['Action'] = "0";
        $returnArr['RESTRICT_APP'] = "Yes";
        $returnArr['isSessionExpired'] = "Yes";
        $returnArr['message'] = "LBL_SESSION_TIME_OUT";
        $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
        setDataResponse($returnArr);
    }
    $final_message['Message'] = "CabRequested";
    $final_message['sourceLatitude'] = strval($PickUpLatitude);
    $final_message['sourceLongitude'] = strval($PickUpLongitude);
    $final_message['PassengerId'] = strval($passengerId);
    //added by SP for fly stations on 27-09-2019 start
    $final_message['eFly'] = "No";
    if (!empty($iFromStationId) && !empty($iToStationId)) {
        $final_message['eFly'] = "Yes";
    }
    //added by SP for fly stations on 27-09-2019 end
    $passengerFName = $passengerData[0]['vName'];
    $passengerLName = $passengerData[0]['vLastName'];
    $final_message['PName'] = $passengerFName . " " . $passengerLName;
    $final_message['PPicName'] = $passengerData[0]['vImgName'];
    $final_message['PFId'] = $passengerData[0]['vFbId'];
    $final_message['PRating'] = $passengerData[0]['vAvgRating'];
    $final_message['PPhone'] = $passengerData[0]['vPhone'];
    $final_message['PPhoneC'] = $passengerData[0]['vPhoneCode'];
    $final_message['PPhone'] = '+' . $final_message['PPhoneC'] . $final_message['PPhone'];
    $final_message['REQUEST_TYPE'] = $eType;
    // packagename changes
    $final_message['destLatitude'] = strval($DestLatitude);
    $final_message['destLongitude'] = strval($DestLongitude);
    $final_message['MsgCode'] = strval(time() . mt_rand(1000, 9999));
    $final_message['vTitle'] = $alertMsg;
    $final_message['iTripId'] = $iCabRequestId_cab_now;
    $final_message['iHotelId'] = $iHotelId;
    $final_message['eSystem'] = "";
    //$final_message['Time']= strval(date('Y-m-d'));
    $ALLOW_SERVICE_PROVIDER_AMOUNT = "No";
    $vVehicleTypeName = $eFareType = "";
    $fAmount = 0;
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if ($eType == "UberX") {
        if ($quantity < 1) {
            $quantity = 1;
        }
        $vVehicleTypeName = "";
        $eFareType = "";
        $minHour_ufx = -1;
        if (isset($fareDetails['originalFareTotal']) && !empty($fareDetails['originalFareTotal'])) {
            $iPrice = $fareDetails['originalFareTotal'];
            $vVehicleTypeName = $fareDetails['ParentCategoryName'];
            $eFareType = $fareDetails['eFareTypeServices'];
        } else if ($selectedCarTypeID > 0) {
            $sqlv = "SELECT vt.iVehicleCategoryId,vt.vVehicleType_" . $vLangCode . " as vVehicleTypeName,vc.iParentId,vt.eFareType,vt.ePickStatus,vt.eNightStatus,vt.fFixedFare, vt.iBaseFare, vt.iMinFare, vt.fMinHour, vc.ePriceType From vehicle_type as vt LEFT JOIN " . $sql_vehicle_category_table_name . " as vc ON  vc.iVehicleCategoryId = vt.iVehicleCategoryId WHERE vt.iVehicleTypeId = '" . $selectedCarTypeID . "'";
            $tripVehicleData = $obj->MySQLSelect($sqlv);
            $iVehicleCategoryId = $tripVehicleData[0]['iVehicleCategoryId'];
            $vVehicleTypeName = $tripVehicleData[0]['vVehicleTypeName'];
            $eFareType = $tripVehicleData[0]['eFareType'];
            $iParentId = $tripVehicleData[0]['iParentId'];
            if ($iParentId == 0) {
                $ePriceType = $tripVehicleData[0]['ePriceType'];
            } else {
                $ePriceType = get_value($sql_vehicle_category_table_name, 'ePriceType', 'iVehicleCategoryId', $iParentId, '', 'true');
            }
            $ALLOW_SERVICE_PROVIDER_AMOUNT = $ePriceType == "Provider" ? "Yes" : "No";
            if ($eFareType != "Regular") {
                if ($eFareType == "Fixed") {
                    $fAmount = $tripVehicleData[0]['fFixedFare'] * $quantity;
                } else {
                    $minHour_ufx = $tripVehicleData[0]['fMinHour'];
                }
                //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount Start
                $checkProviderAmt = 1;
                $iPrice = 0;
                if (isset($fareDetails['originalFareTotal']) && $fareDetails['originalFareTotal'] > 0) {
                    $iPrice = $fareDetails['originalFareTotal'];
                    $vVehicleTypeName = $fareDetails['ParentCategoryName'];
                    $checkProviderAmt = 0;
                }
                //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount End
                if ($ALLOW_SERVICE_PROVIDER_AMOUNT == "Yes" && $checkProviderAmt == 1) {
                    $drivervehicleData = $obj->MySQLSelect("SELECT iDriverVehicleId FROM  `driver_vehicle` WHERE iDriverId = '" . $driver_id_auto . "' AND eType='UberX'");
                    $iDriverVehicleId = $drivervehicleData[0]['iDriverVehicleId'];
                    $serviceProData = $obj->MySQLSelect("SELECT * FROM `service_pro_amount` WHERE iDriverVehicleId='" . $iDriverVehicleId . "' AND iVehicleTypeId='" . $selectedCarTypeID . "'");
                    if (count($serviceProData) > 0) {
                        $fAmount = $serviceProData[0]['fAmount'] * $quantity;
                    } else {
                        $fAmount = $iPrice;
                    }
                    $iPrice = $fAmount;
                }
            } else {
                $iBaseFare = round($tripVehicleData[0]['iBaseFare'], 2);
                $iMinFare = round($tripVehicleData[0]['iMinFare'], 2);
                $fAmount = ($iMinFare > $iBaseFare) ? $iMinFare : $iBaseFare;
            }
            $iPrice = $fAmount;
            // added for payment method 2 //
            if ($iVehicleCategoryId != 0) {
                $vVehicleCategoryName = get_value($sql_vehicle_category_table_name, 'vCategory_' . $vLangCode, 'iVehicleCategoryId', $iVehicleCategoryId, '', 'true');
                $vVehicleTypeName = $vVehicleCategoryName . "-" . $vVehicleTypeName;
            }
        }
        $final_message['SelectedTypeName'] = $vVehicleTypeName;
        $final_message['eFareType'] = $eFareType;
    }
    $ePoolStatus = "No";
    $vehiclePesonSize = 1;
    if ($eType == "Ride" && strtoupper(PACKAGE_TYPE) == "SHARK") {
        poolVariableGetForSendRequest();
    }
    //Added By Hasmukh On
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        BookForSomeOneElse();
    }
    // $ePickStatus = $tripVehicleData[0]['ePickStatus'];
    // $eNightStatus = $tripVehicleData[0]['eNightStatus'];
    $fPickUpPrice = $fNightPrice = 1;
    $sourceLocationArr = array($PickUpLatitude, $PickUpLongitude);
    $destinationLocationArr = array($DestLatitude, $DestLongitude);
    $data_flattrip['eFlatTrip'] = "No";
    $data_flattrip['Flatfare'] = 0;
    if ($eType == 'Ride' && strtoupper(PACKAGE_TYPE) != "STANDARD") {
        $data_flattrip = checkFlatTripnew($sourceLocationArr, $destinationLocationArr, $selectedCarTypeID, $iRentalPackageId);
    }
    if ($StopOverPointAdded == "Yes") {
        $data_flattrip['eFlatTrip'] = "No";
        $data_flattrip['Flatfare'] = 0;
    }
    if ($eType != "UberX" || ($eType == "UberX" && !empty($eFareType) && $eFareType == "Regular")) {
        $data_surgePrice = checkSurgePrice($selectedCarTypeID, "", $iRentalPackageId);
        if ($data_surgePrice['Action'] == "0") {
            if ($data_surgePrice['message'] == "LBL_PICK_SURGE_NOTE") {
                $fPickUpPrice = $data_surgePrice['SurgePriceValue'];
            } else {
                $fNightPrice = $data_surgePrice['SurgePriceValue'];
            }
        }
    }
    if ($APPLY_SURGE_ON_FLAT_FARE == "No" && $data_flattrip['eFlatTrip'] == "Yes") {
        $fPickUpPrice = $fNightPrice = 1;
    }
    // add airport surge //
    $fpickupsurchargefare = $fdropoffsurchargefare = 0;
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        if ($ENABLE_AIRPORT_SURCHARGE_SECTION == 'Yes' && $eType != "UberX") {
            $pickuplocationarr = array($PickUpLatitude, $PickUpLongitude);
            $dropofflocationarr = array($DestLatitude, $DestLongitude);
            $GetVehicleIdfromGeoLocation = CheckSurgeAirportFromGeoLocation($pickuplocationarr, $dropofflocationarr, $selectedCarTypeID);
            $fpickupsurchargefare = $GetVehicleIdfromGeoLocation['fpickupsurchargefare'];
            $fdropoffsurchargefare = $GetVehicleIdfromGeoLocation['fdropoffsurchargefare'];
            //$airportsurgetype = $AIRPORT_SURGE_ADD_OR_OVERRIDE;
        }
    }
    $Data_update_passenger['fAirportPickupSurge'] = $fpickupsurchargefare;
    $Data_update_passenger['fAirportDropoffSurge'] = $fdropoffsurchargefare;
    // end airport surge //
    $cmpMinutes = ceil((fetchtripstatustimeMAXinterval() + $intervalmins) / 60);
    $str_date = @date('Y-m-d H:i:s', strtotime('-' . $cmpMinutes . ' minutes'));
    //$sql_driver_status_chk = "SELECT iGcmRegId,eDeviceType,iDriverId,vLang,tSessionId,iAppVersion,eAppTerminate,eDebugMode FROM register_driver WHERE tLocationUpdateDate > '$str_date' AND iDriverId IN (" . $driver_id_auto . ")";
    $sql_driver_status_chk = "SELECT vTripStatus,iGcmRegId,eDeviceType,iDriverId,vLang,tSessionId,iAppVersion,eAppTerminate,eDebugMode,eHmsDevice FROM register_driver WHERE  iDriverId IN (" . $driver_id_auto . ")   ";
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        reGenerateRequestQueryForDriver();
    }
    $result_driverData = $obj->MySQLSelect($sql_driver_status_chk);
    if(isset($_REQUEST['test'])){
        echo"<prE>";echo count($result_driverData);
        echo"<br/>"; echo  $driver_id_auto;
        echo"<br/>"; echo count($Data);echo"<br/>";die;
    }
    if (count($result_driverData) == 0 || $driver_id_auto == "" || count($Data) == 0) {
        $returnArr['Action'] = "0";
        $returnArr['Actiowwwn'] = "0";
        $returnArr['message'] = ($final_message['eFly'] == "No") ? "NO_CARS" : "LBL_NO_DRIVER_FOUND";
        setDataResponse($returnArr);
    }
    $tripPaymentMode = "Card";
    if ($cashPayment == 'Yes') {
        $tripPaymentMode = "Cash";
    }
    /* For New Payment Flow */
    $tripPaymentMode = mb_convert_case($ePaymentMode, MB_CASE_TITLE, 'UTF-8');
   // $tripPaymentMode = ucfirst($ePaymentMode);
    /* For New Payment Flow End */
    $where = "";
    $Data_update_passenger['ePayType'] = $tripPaymentMode;
    $Data_update_passenger['fTollPrice'] = "0";
    $Data_update_passenger['vTollPriceCurrencyCode'] = "";
    $Data_update_passenger['eTollSkipped'] = "No";
    //Added By HJ On 26-10-2019 For Insert toll Data As Per App Data Discuss With KS Start
    if ((empty($fTollPrice) || $fTollPrice <= 0) && $eTollSkipped == "Yes") {
        $Data_update_passenger['eTollSkipped'] = $eTollSkipped;
    }
    //Added By HJ On 26-10-2019 For Insert toll Data As Per App Data Discuss With KS End
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
    $Data_update_passenger['eServiceLocation'] = $eServiceLocation;
    //$Data_update_passenger['tVehicleTypeData'] = stripcslashes($orderDetails); // Commented By HJ On 23-11-2019 For Soled \n data issue
    if (!empty($orderDetails)) { //added by SP condition only bcoz in db store ull value in ride trip.
        $Data_update_passenger['tVehicleTypeData'] = str_replace("'", getJsonFromAnArr(json_decode($orderDetails, true)), "\'"); // Added By HJ On 23-11-2019 For Soled \n data issue
    }
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
    if (($eTollSkipped == 'No' || $fTollPrice != "") && $eType != "Multi-Delivery" && $fTollPrice > 0) {
        $fTollPrice_Original = $fTollPrice;
        $vTollPriceCurrencyCode = strtoupper($vTollPriceCurrencyCode);
        $default_currency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        $sql = " SELECT round(($fTollPrice/(SELECT Ratio FROM currency where vName='" . $vTollPriceCurrencyCode . "'))*(SELECT Ratio FROM currency where vName='" . $default_currency . "' ) ,2)  as price FROM currency  limit 1";
        $result_toll = $obj->MySQLSelect($sql);
        $fTollPrice = $result_toll[0]['price'];
        if ($fTollPrice == 0) {
            $fTollPrice = FetchTollPrice($vTollPriceCurrencyCode, $default_currency, $fTollPrice_Original);
        }
        $Data_update_passenger['fTollPrice'] = $fTollPrice;
        $Data_update_passenger['vTollPriceCurrencyCode'] = $vTollPriceCurrencyCode;
        $Data_update_passenger['eTollSkipped'] = $eTollSkipped;
    }

    $sourceLoc = $PickUpLatitude . ',' . $PickUpLongitude;
    $destLoc = $DestLatitude . ',' . $DestLongitude;
    
    $Data_update_passenger['iUserId'] = $passengerId;
    $Data_update_passenger['tMsgCode'] = $final_message['MsgCode'];
    $Data_update_passenger['eStatus'] = 'Requesting';
    $Data_update_passenger['vSourceLatitude'] = $PickUpLatitude;
    $Data_update_passenger['vSourceLongitude'] = $PickUpLongitude;
    $Data_update_passenger['vDestLatitude'] = $DestLatitude;
    $Data_update_passenger['vDestLongitude'] = $DestLongitude;
    $Data_update_passenger['tDestAddress'] = $DestAddress;
    $Data_update_passenger['iVehicleTypeId'] = $selectedCarTypeID;
    $Data_update_passenger['fPickUpPrice'] = $fPickUpPrice;
    $Data_update_passenger['fNightPrice'] = $fNightPrice;
    $Data_update_passenger['eType'] = $eType;
    $Data_update_passenger['iPackageTypeId'] = $eType == "Deliver" ? $iPackageTypeId : '';
    $Data_update_passenger['vReceiverName'] = $eType == "Deliver" ? $vReceiverName : '';
    $Data_update_passenger['vReceiverMobile'] = $eType == "Deliver" ? $vReceiverMobile : '';
    $Data_update_passenger['tPickUpIns'] = $eType == "Deliver" ? $tPickUpIns : '';
    $Data_update_passenger['tDeliveryIns'] = $eType == "Deliver" ? $tDeliveryIns : '';
    $Data_update_passenger['tPackageDetails'] = $eType == "Deliver" ? $tPackageDetails : '';
    $Data_update_passenger['vCouponCode'] = $promoCode;
    $Data_update_passenger['iQty'] = $quantity;
    // $Data_update_passenger['vRideCountry'] = $vCountryCode;
    $Data_update_passenger['eFemaleDriverRequest'] = $eFemaleDriverRequest;
    $Data_update_passenger['eHandiCapAccessibility'] = $eHandiCapAccessibility;
    $Data_update_passenger['vTimeZone'] = $vTimeZone;
    $Data_update_passenger['dAddedDate'] = date("Y-m-d H:i:s");
    $Data_update_passenger['eFlatTrip'] = $data_flattrip["eFlatTrip"];
    $Data_update_passenger['fFlatTripPrice'] = $data_flattrip["Flatfare"];
    /* added for rental */
    $Data_update_passenger['iRentalPackageId'] = $iRentalPackageId;
    $Data_update_passenger['fDistance'] = $vDistance;
    $Data_update_passenger['fDuration'] = $vDuration;
    $Data_update_passenger['iHotelId'] = $iHotelId;
    $Data_update_passenger['iPaymentInfoId'] = $iPaymentInfoId;
    ###### payment method 2 #########
    $Data_update_passenger['ePayWallet'] = $ePayWallet;
    ######### payment method 2 #########
    if (!empty($iHotelId) && $iHotelId != '0') {
        if (isset($eBookingFrom) && !empty($eBookingFrom)) {
            $Data_update_passenger['eBookingFrom'] = $eBookingFrom;
        } else {
            $Data_update_passenger['eBookingFrom'] = 'Kiosk';
        }
        // $iHotelId
        $iHotelAdminId = "";
        if (!empty($iHotelBookingId)) {
            $iHotelAdminId = $iHotelBookingId;
        } else {
            if (!empty($hotel_data)) {
                $iHotelAdminId = $hotel_data[0]['iAdminId'];
            } else {
                $Asql = "SELECT a.iAdminId FROM hotel as h LEFT JOIN administrators as a on a.iAdminId=h.iAdminId WHERE h.iHotelId='" . $iHotelId . "'";
                $resultadmin = $obj->MySQLSelect($Asql);
                $iHotelAdminId = $resultadmin[0]['iAdminId'];
            }
        }
        $Data_update_passenger['iHotelBookingId'] = $iHotelAdminId;
    } else {
        // add for hotel web
        $Data_update_passenger['eBookingFrom'] = $eBookingFrom;
        $Data_update_passenger['iHotelBookingId'] = $iHotelBookingId;
    }
    if ($eType == "Multi-Delivery") {
        $Data_update_passenger['fDuration'] = $total_del_time;
        $Data_update_passenger['fDistance'] = $total_del_dist;
    }
    $Data_update_passenger['eWalletDebitAllow'] = $eWalletDebitAllow;
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        GetSendRequestToDriverParam();
    }
    if ($iTripReasonId != "" || $vReasonTitle != "") {
        $Data_update_passenger['iTripReasonId'] = $iTripReasonId;
        $Data_update_passenger['vReasonTitle'] = $vReasonTitle;
        $Data_update_passenger['eTripReason'] = "Yes";
    }
    // Payment Method 2 Flow Start
    $isDestinationAdded = "No";
    if ($DestLatitude != "" && $DestLongitude != "") {
        $isDestinationAdded = "Yes";
    }
    // get user wallet balance
    $user_available_balance_wallet = $WALLET_OBJ->FetchMemberWalletBalance($passengerId, "Rider", true);
    $walletDataArr = array();
    if (is_array($user_available_balance_wallet)) {
        $walletDataArr = $user_available_balance_wallet;
        $user_available_balance_wallet = $walletDataArr['CurrentBalance'];
        $Data_update_passenger['tUserWalletBalance'] = $walletDataArr['AutorizedWalletBalance'];
    }
    $ratio = $UserDetail[0]['Ratio'];
    $currency_vSymbol = $UserDetail[0]['vSymbol'];
    $currnecycode = $UserDetail[0]['vCurrencyPassenger'];
    $user_available_balance_wallet = setTwoDecimalPoint($user_available_balance_wallet * $ratio);
    /*     * * Checking User's wallet balance respect to 'Method-2,3' Payment flow ** */
    //Added By HJ On 10-06-2019 For Get User Out Standing Amount For Payment Method 2 Or 3 Start
    $userOutStandingAmt = 0;
    $outstandingIds = "";
    // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
    if (strtoupper($ePayWallet) == "YES") {
        $getUserOutstandingAmount = getUserOutstandingAmount($passengerId, "iCabRequestId");
        $userOutStandingAmt = $getUserOutstandingAmount['fPendingAmount'];
        $outstandingIds = $getUserOutstandingAmount['iTripOutstandId'];
    }
    //Added By HJ On 10-06-2019 For Get User Out Standing Amount For Payment Method 2 Or 3 End
    // if (($cashPayment == 'No' || $cashPayment == 'false') && (($iHotelId == '' || $iHotelId < 1) && strtoupper($GeneralUserType) != 'HOTEL') && ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3')) {
    if (($iHotelId == '' || $iHotelId < 1) && strtoupper($GeneralUserType) != 'HOTEL' && strtoupper($ePayWallet) == "YES") {
        $fareAmount = 0;
        if (isset($fareDetails['tripFareDetailsSaveArr']) && count($fareDetails['tripFareDetailsSaveArr']) > 0) {
            $minHour = -1;
            if (!empty($fareDetails['tripFareDetailsSaveArr']['eFareTypeServices']) && $fareDetails['tripFareDetailsSaveArr']['eFareTypeServices'] == "Hourly" && count($fareDetails['tripFareDetailsSaveArr']['FareData']) > 0) {
                $minHour = $fareDetails['tripFareDetailsSaveArr']['FareData'][0]['MinimumHour'];
            }
            //$fareAmount = $fareDetails['tripFareDetailsSaveArr']['subTotal'];
            $fareAmount = $fareDetails['tripFareDetailsSaveArr']['originalFareTotal'];
            //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir Start
            if ($promoCode != "") {
                $discValue = EvaluatePromoCodeValue($promoCode, $fareAmount, $ratio);
                if ($discValue > 0) {
                    $fareAmount = $fareAmount - $discValue;
                }
            }
            //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir End
            if ($minHour > 0) {
                $fareAmount = $fareAmount * $minHour;
            }
        } else if ($selectedCarTypeID > 0 && $isDestinationAdded == "Yes") {
            $Fare_data_New = calculateApproximateFareGeneral($vDuration, $vDistance, $selectedCarTypeID, $passengerId, 1, "", "", $promoCode, 1, 0, 0, 0, "DisplySingleVehicleFare", "Passenger", 1, "", $isDestinationAdded, $data_flattrip['eFlatTrip'], $data_flattrip["Flatfare"], $sourceLocationArr, $destinationLocationArr, "Yes", $eType, "", $eFly, $iFromStationId, $iToStationId);
            $fareAmount = $Fare_data_New[0]['total_fare_amount'];
            if ($Fare_data_New[0]['eRental'] == "Yes" && $Fare_data_New[0]['eRental_total_fare_value'] > 0 && !empty($_REQUEST["iRentalPackageId"]) && $_REQUEST["iRentalPackageId"] > 0) {
                $fareAmount = $Fare_data_New[0]['eRental_total_fare_value'];
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir Start
                if ($promoCode != "") {
                    $discValue = EvaluatePromoCodeValue($promoCode, $fareAmount, $ratio);
                    if ($discValue > 0) {
                        $fareAmount = $fareAmount - $discValue;
                    }
                }
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir End
            }
            //Added By HJ On 07-08-2019 For Calculate Pool Person Wise Fare Amount By Defined Pool Pecentage Start
            $fPoolPercentage = 1;
            if (isset($Fare_data_New[0]['fPoolPercentage']) && $Fare_data_New[0]['fPoolPercentage'] > 0) {
                $fPoolPercentage = $Fare_data_New[0]['fPoolPercentage'];
            }
            if ($ePoolStatus == "Yes" && !empty($_REQUEST['iPersonSize']) && $_REQUEST['iPersonSize'] > 1 && $fPoolPercentage > 1) {
                $extraSeatCharge = $fareAmount * $fPoolPercentage / 100;
                //$totalSeatCharge = $extraSeatCharge * $_REQUEST['iPersonSize'];
                $fareAmount += $extraSeatCharge;
            }
            //Added By HJ On 07-08-2019 For Calculate Pool Person Wise Fare Amount By Defined Pool Pecentage End
            if (!empty($Data_update_passenger['fTollPrice']) && $Data_update_passenger['fTollPrice'] > 0 && !empty($Data_update_passenger['eTollSkipped']) && strtoupper($Data_update_passenger['eTollSkipped']) == "NO") {
                $fareAmount += $Data_update_passenger['fTollPrice'];
            }
        } else if ($selectedCarTypeID > 0 && $isDestinationAdded != "Yes" && $eType == 'Ride') {
            $Fare_data_New = calculateApproximateFareGeneral($vDuration, $vDistance, $selectedCarTypeID, $passengerId, 1, "", "", $promoCode, 1, 0, 0, 0, "DisplySingleVehicleFare", "Passenger", 1, "", $isDestinationAdded, $data_flattrip['eFlatTrip'], $data_flattrip["Flatfare"], $sourceLocationArr, $destinationLocationArr, "Yes", $eType, "", $eFly, $iFromStationId, $iToStationId);
            $fareAmount = $Fare_data_New[0]['total_fare_amount'];
            if ($Fare_data_New[0]['eRental'] == "Yes" && $Fare_data_New[0]['eRental_total_fare_value'] > 0 && !empty($_REQUEST["iRentalPackageId"]) && $_REQUEST["iRentalPackageId"] > 0) {
                $Fare_data_New[0]['fBufferAmount'] = 0;
                $fareAmount = $Fare_data_New[0]['eRental_total_fare_value'];
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir Start
                if ($promoCode != "") {
                    $discValue = EvaluatePromoCodeValue($promoCode, $fareAmount, $ratio);
                    if ($discValue > 0) {
                        $fareAmount = $fareAmount - $discValue;
                    }
                }
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir End
            }
            $fBufferAmount = $Fare_data_New[0]['fBufferAmount'];
            if ($fBufferAmount > 0) {
                $fBufferAmount = $fBufferAmount * $ratio;
            }
            $fareAmount = $fareAmount + $fBufferAmount;
            if (!empty($Data_update_passenger['fTollPrice']) && $Data_update_passenger['fTollPrice'] > 0 && !empty($Data_update_passenger['eTollSkipped']) && strtoupper($Data_update_passenger['eTollSkipped']) == "NO") {
                $fareAmount = $fareAmount + $Data_update_passenger['fTollPrice'];
            }
        } else if ($selectedCarTypeID > 0 && $eType == 'UberX') {
            $fareAmount = $iPrice * $ratio;
            if (!empty($minHour_ufx) && $minHour_ufx > 0) {
                $fareAmount = $fareAmount * $minHour_ufx;
            }
        }
        $fareAmount = setTwoDecimalPoint($fareAmount + $userOutStandingAmt); // Added By HJ On 10-06-2019 For Payment Flow 2/3
        if ($user_available_balance_wallet < $fareAmount && $eWalletIgnore == 'No') {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LOW_WALLET_AMOUNT";
            $auth_wallet_amount = 0;
            $returnArr['ORIGINAL_WALLET_BALANCE'] = formateNumAsPerCurrency(0, $currnecycode);
            $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = setTwoDecimalPoint(0);
            if (!empty($walletDataArr) && count($walletDataArr) > 0) {
                $auth_wallet_amount = strval(setTwoDecimalPoint((isset($walletDataArr['TotalAuthorizedAmount']) ? $walletDataArr['TotalAuthorizedAmount'] : 0) * $ratio));
                // $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? ($currency_vSymbol . ' ' . setTwoDecimalPoint($auth_wallet_amount)) : "";
                $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? formateNumAsPerCurrency($auth_wallet_amount, $currnecycode) : "";
                $returnArr['AUTH_AMOUNT_VALUE'] = $auth_wallet_amount > 0 ? setTwoDecimalPoint($auth_wallet_amount) : "";
                //$returnArr['ORIGINAL_WALLET_BALANCE'] = $currency_vSymbol . ' ' . setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? setTwoDecimalPoint($walletDataArr['WalletBalance']) : 0) * $ratio);
                $returnArr['ORIGINAL_WALLET_BALANCE'] = isset($walletDataArr['WalletBalance']) ? formateNumAsPerCurrency(($walletDataArr['WalletBalance'] * $ratio), $currnecycode) : formateNumAsPerCurrency(0, $currnecycode);
                $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? setTwoDecimalPoint($walletDataArr['WalletBalance']) : 0) * $ratio));
            }
            //$returnArr['CURRENT_JOB_EST_CHARGE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint($fareAmount));
            $returnArr['CURRENT_JOB_EST_CHARGE'] = formateNumAsPerCurrency($fareAmount, $currnecycode);
            $returnArr['CURRENT_JOB_EST_CHARGE_VALUE'] = strval(setTwoDecimalPoint($fareAmount));
            //$returnArr['WALLET_AMOUNT_NEEDED'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint($fareAmount - $user_available_balance_wallet));
            $returnArr['WALLET_AMOUNT_NEEDED'] = formateNumAsPerCurrency(($fareAmount - $user_available_balance_wallet + $auth_wallet_amount), $currnecycode);
            $returnArr['WALLET_AMOUNT_NEEDED_VALUE'] = strval(setTwoDecimalPoint($fareAmount - $user_available_balance_wallet + $auth_wallet_amount));
            if (!empty($walletDataArr) && count($walletDataArr) > 0 && $auth_wallet_amount > 0) {
                $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT'];
                // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT_NO_CASH'];
                }
                $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                    $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                }
                if (!empty($returnArr['AUTH_AMOUNT'])) {
                    $content_msg_low_balance = str_replace("###", $returnArr['AUTH_AMOUNT'], $content_msg_low_balance);
                }
                $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
            } else {
                $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT'];
                // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT_NO_CASH'];
                }
                $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                    $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                }
                if (!empty($returnArr['CURRENT_JOB_EST_CHARGE'])) {
                    $content_msg_low_balance = str_replace("###", $returnArr['CURRENT_JOB_EST_CHARGE'], $content_msg_low_balance);
                }
                $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
            }
            // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
            if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "Yes";
            } else {
                $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "No";
            }
            setDataResponse($returnArr);
        }
        $Data_update_passenger['tEstimatedCharge'] = $fareAmount / $ratio;
    }
    if ($eType == "Multi-Delivery") {
        $data_fare = calculateFareEstimateAllMultiDelivery($total_del_time, $total_del_dist, $selectedCarTypeID, $passengerId, 1, "", "", $promoCode, 1, 0, 0, 0, "DisplySingleVehicleFare", "Passenger", 1, "", "", $data_flattrip['eFlatTrip'], $data_flattrip["Flatfare"], "", "", "Yes", $eType, "", $ePaymentBy, $eWalletDebitAllow);
        if (!empty($Data_update_passenger['fTollPrice']) && $Data_update_passenger['fTollPrice'] > 0 && !empty($Data_update_passenger['eTollSkipped']) && strtoupper($Data_update_passenger['eTollSkipped']) == "NO") {
            $data_fare[0]['TotalGenratedFare'] = $data_fare[0]['TotalGenratedFare'] + $Data_update_passenger['fTollPrice'] + $userOutStandingAmt; // $userOutStandingAmt Added By HJ On 10-06-2019 For Payment Flow 2/3
        }
        /*         * * Checking User's wallet balance respect to 'Method-2,3' Payment flow ** */
        // if (($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') && (($iHotelId == '' || $iHotelId < 1) && strtoupper($GeneralUserType) != 'HOTEL') && ($cashPayment == 'false' || $cashPayment == 'No')) {
        if (strtoupper($ePayWallet) == "YES" && ($iHotelId == '' || $iHotelId < 1) && strtoupper($GeneralUserType) != 'HOTEL') {
            if ($user_available_balance_wallet < ($data_fare[0]['TotalGenratedFare'] * $ratio) && $eWalletIgnore == 'No') {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LOW_WALLET_AMOUNT";
                if (!empty($walletDataArr) && count($walletDataArr) > 0) {
                    $auth_wallet_amount = strval(setTwoDecimalPoint((isset($walletDataArr['TotalAuthorizedAmount']) ? $walletDataArr['TotalAuthorizedAmount'] : 0) * $ratio));
                    //$returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? ($currency_vSymbol . ' ' . $auth_wallet_amount) : "";
                    $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? formateNumAsPerCurrency($auth_wallet_amount, $currnecycode) : "";
                    $returnArr['AUTH_AMOUNT_VALUE'] = $auth_wallet_amount > 0 ? $auth_wallet_amount : "";
                    //$returnArr['ORIGINAL_WALLET_BALANCE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? $walletDataArr['WalletBalance'] : 0) * $ratio));
                    $returnArr['ORIGINAL_WALLET_BALANCE'] = isset($walletDataArr['WalletBalance']) ? formateNumAsPerCurrency(($walletDataArr['WalletBalance'] * $ratio), $currnecycode) : 0;
                    $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? $walletDataArr['WalletBalance'] : 0) * $ratio));
                }
                //$returnArr['CURRENT_JOB_EST_CHARGE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio)));
                $returnArr['CURRENT_JOB_EST_CHARGE'] = formateNumAsPerCurrency(($data_fare[0]['TotalGenratedFare'] * $ratio), $currnecycode);
                $returnArr['CURRENT_JOB_EST_CHARGE_VALUE'] = strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio)));
                $walletbal = ($data_fare[0]['TotalGenratedFare'] * $ratio) - $user_available_balance_wallet + $auth_wallet_amount;
                $returnArr['WALLET_AMOUNT_NEEDED'] = formateNumAsPerCurrency($walletbal, $currnecycode);
                //$returnArr['WALLET_AMOUNT_NEEDED'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio) - $user_available_balance_wallet));
                $returnArr['WALLET_AMOUNT_NEEDED_VALUE'] = strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio) - $user_available_balance_wallet + $auth_wallet_amount));
                if (!empty($walletDataArr) && count($walletDataArr) > 0 && $auth_wallet_amount > 0) {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT'];
                    if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                        $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT_NO_CASH'];
                    }
                    $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                    if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                        $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                    }
                    if (!empty($returnArr['AUTH_AMOUNT'])) {
                        $content_msg_low_balance = str_replace("###", $returnArr['AUTH_AMOUNT'], $content_msg_low_balance);
                    }
                    $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                    $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                } else {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT'];
                    if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                        $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT_NO_CASH'];
                    }
                    $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                    if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                        $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                    }
                    if (!empty($returnArr['CURRENT_JOB_EST_CHARGE'])) {
                        $content_msg_low_balance = str_replace("###", $returnArr['CURRENT_JOB_EST_CHARGE'], $content_msg_low_balance);
                    }
                    $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                    $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                }
                // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                    $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "Yes";
                } else {
                    $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "No";
                }
                setDataResponse($returnArr);
            }
            $Data_update_passenger['tEstimatedCharge'] = $data_fare[0]['TotalGenratedFare'];
        }
        /*         * * Checking User's wallet balance respect to 'Method-2,3' Payment flow ** */
        $fTripGenerateFare = $data_fare[0]['TotalGenratedFare'];
        $Data_update_passenger['iFare'] = $data_fare[0]['iFare_Ori'];
        $Data_update_passenger['iBaseFare'] = $data_fare[0]['iBaseFare_AMT'];
        $Data_update_passenger['fPricePerMin'] = $data_fare[0]['FareOfMinutes_Ori'];
        $Data_update_passenger['fPricePerKM'] = $data_fare[0]['FareOfDistance_Ori'];
        $Data_update_passenger['fCommision'] = $data_fare[0]['fCommision_AMT'];
        $Data_update_passenger['fSurgePriceDiff'] = $data_fare[0]['fSurgePriceDiff_Ori'];
        $Data_update_passenger['fTax1'] = $data_fare[0]['fTax1_Ori'];
        $Data_update_passenger['fTax2'] = isset($data_fare[0]['fTax2_Ori']) ? $data_fare[0]['fTax2_Ori'] : 0;
        $Data_update_passenger['fTax1Percentage'] = $data_fare[0]['fTax1Percentage'];
        $Data_update_passenger['fTax2Percentage'] = $data_fare[0]['fTax2Percentage'];
        $Data_update_passenger['fOutStandingAmount'] = $data_fare[0]['fOutStandingAmount'];
        $Data_update_passenger['fDiscount'] = isset($data_fare[0]['fDiscount']) ? $data_fare[0]['fDiscount'] : 0;
        $Data_update_passenger['vDiscount'] = isset($data_fare[0]['vDiscount']) ? $data_fare[0]['vDiscount'] : 0;
        $Data_update_passenger['fMinFareDiff'] = $data_fare[0]['fMinFareDiff_Ori'];
        $Data_update_passenger['fTripGenerateFare'] = $fTripGenerateFare;
        $Data_update_passenger['fWalletDebit'] = $data_fare[0]['fWalletDebit'];
        //added by SP for rounding off on 7-11-2019 for multi delivery
        if ($tripPaymentMode == 'Cash' && isset($data_fare[0]['fRoundingAmount'])) {
            $Data_update_passenger['fRoundingAmount'] = $data_fare[0]['fRoundingAmount'];
            $Data_update_passenger['eRoundingType'] = $data_fare[0]['eRoundingType'];
        }
    }
    // if (!empty($Data_update_passenger['tEstimatedCharge']) && $Data_update_passenger['tUserWalletBalance'] > $Data_update_passenger['tEstimatedCharge'] && ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3')) {
    if (!empty($Data_update_passenger['tEstimatedCharge']) && $Data_update_passenger['tUserWalletBalance'] > $Data_update_passenger['tEstimatedCharge'] && strtoupper($ePayWallet) == "YES") {
        $Data_update_passenger['tUserWalletBalance'] = $Data_update_passenger['tEstimatedCharge'];
    }
    $Data_update_passenger['tTotalDistance'] = !empty($Data_update_passenger['fDistance']) ? $Data_update_passenger['fDistance'] : $vDistance;
    $Data_update_passenger['tTotalDuration'] = !empty($Data_update_passenger['fDuration']) ? $Data_update_passenger['fDuration'] : $vDuration;
    $delivery_arr = isset($_REQUEST["delivery_arr"]) ? $_REQUEST["delivery_arr"] : '';
    $details_arr = json_decode($delivery_arr, true);
    if ($MODULES_OBJ->isEnableVideoConsultingService()) {
        $Data_update_passenger['isVideoCall'] = $isVideoCall;
    }
    $insert_id = $obj->MySQLQueryPerform("cab_request_now", $Data_update_passenger, 'insert');
    
    // $insert_id = mysql_insert_id();
    $final_message['iCabRequestId'] = $insert_id;
    //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 Start
    if ($userOutStandingAmt > 0 && $outstandingIds != "") {
        $obj->sql_query("UPDATE trip_outstanding_amount set eAuthoriseIdName='iCabRequestId',iAuthoriseId = '" . $insert_id . "' WHERE iTripOutstandId IN ($outstandingIds)");
    }
    //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 End
    /* ------------------------multi delivery details------------------- */
    $delivery_arr = isset($_REQUEST["delivery_arr"]) ? $_REQUEST["delivery_arr"] : '';
    $delivery_arr = stripslashes($delivery_arr);
    if ($delivery_arr != "" && $eType == "Multi-Delivery") {
        // $delivery_arr = str_replace("\\", "", $delivery_arr);
        $details_arr = json_decode($delivery_arr, true);
        $j = 0;
        $details_arr_keys = array_keys($details_arr);
        $last_key = end($details_arr_keys);
        foreach ($details_arr as $key123 => $values1) {
            $i = 0;
            $insert_did = array();
            foreach ($values1 as $key => $value) {
                if ($key == "vReceiverAddress" || $key == "vReceiverLatitude" || $key == "vReceiverLongitude" || $key == "ePaymentByReceiver") {
                    $Data_trip_locations[$key] = $value;
                    if ($key == "vReceiverLatitude") {
                        $Old_end_lat = isset($Data_trip_locations['tEndLat']) ? $Data_trip_locations['tEndLat'] : '';
                        $Data_trip_locations['tEndLat'] = $value;
                    } else if ($key == "vReceiverLongitude") {
                        $Old_end_long = isset($Data_trip_locations['tEndLong']) ? $Data_trip_locations['tEndLong'] : '';
                        $Data_trip_locations['tEndLong'] = $value;
                    } else if ($key == "vReceiverAddress") {
                        $Old_end_address = isset($Data_trip_locations['tDaddress']) ? $Data_trip_locations['tDaddress'] : '';
                        $Data_trip_locations['tDaddress'] = $value;
                    } else if ($key == "ePaymentByReceiver") {
                        $Data_trip_locations['ePaymentByReceiver'] = $value;
                    }
                    if (($ePaymentBy == "Sender" || $ePaymentBy == "Receiver") && $key123 != 0) {
                        $Data_trip_locations['tStartLat'] = $Old_end_lat;
                        $Data_trip_locations['tStartLong'] = $Old_end_long;
                        $Data_trip_locations['tSaddress'] = $Old_end_address;
                    } else {
                        $Data_trip_locations['tStartLat'] = $PickUpLatitude;
                        $Data_trip_locations['tStartLong'] = $PickUpLongitude;
                        $Data_trip_locations['tSaddress'] = $PickUpAddress;
                    }
                } else {
                    $Data_delivery['iDeliveryFieldId'] = $key;
                    $Data_delivery['iCabRequestId'] = $insert_id;
                    $Data_delivery['vValue'] = $value;
                    $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
                }
            }
            $Data_trip_locations['iCabBookingId'] = $insert_id;
            $Data_trip_locations['ePaymentBy'] = $ePaymentBy;
            $insert_dfid = $obj->MySQLQueryPerform("trips_delivery_locations", $Data_trip_locations, 'insert');
            $delivery_ids = implode("','", $insert_did);
            $where = " iTripDeliveryFieldId in ('" . $delivery_ids . "')";
            $data_update['iTripDeliveryLocationId'] = $insert_dfid;
            $obj->MySQLQueryPerform("trip_delivery_fields", $data_update, 'update', $where);
            if ($last_key == $key123) {
                $where = " iCabRequestId='" . $insert_id . "'";
                $data_update_cab['vDestLatitude'] = isset($Data_trip_locations['tEndLat']) ? $Data_trip_locations['tEndLat'] : $DestLatitude;
                $data_update_cab['vDestLongitude'] = isset($Data_trip_locations['tEndLong']) ? $Data_trip_locations['tEndLong'] : $DestLongitude;
                $data_update_cab['tDestAddress'] = isset($Data_trip_locations['tDaddress']) ? $Data_trip_locations['tDaddress'] : $DestAddress;
                $obj->MySQLQueryPerform("cab_request_now", $data_update_cab, 'update', $where);
            }
        }
    } else if ($delivery_arr == "" && $eType == "Multi-Delivery" && $ENABLE_MULTI_VIEW_IN_SINGLE_DELIVERY == "Yes") {//for web/admin
        $Data_trip_locations['tEndLat'] = $DestLatitude;
        $Data_trip_locations['tEndLong'] = $DestLongitude;
        $Data_trip_locations['tDaddress'] = $DestAddress;
        $Data_trip_locations['ePaymentByReceiver'] = "No";
        $Data_trip_locations['tStartLat'] = $PickUpLatitude;
        $Data_trip_locations['tStartLong'] = $PickUpLongitude;
        $Data_trip_locations['tSaddress'] = $PickUpAddress;
        $Data_trip_locations['iCabBookingId'] = $insert_id;
        $Data_trip_locations['ePaymentBy'] = "Sender";
        $insert_dfid = $obj->MySQLQueryPerform("trips_delivery_locations", $Data_trip_locations, 'insert');
        $insert_did = array();
        $Data_delivery['iDeliveryFieldId'] = 4;
        $Data_delivery['iCabRequestId'] = $insert_id;
        $Data_delivery['vValue'] = $tDeliveryIns;
        $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
        $Data_delivery['iDeliveryFieldId'] = 3;
        $Data_delivery['iCabRequestId'] = $insert_id;
        $Data_delivery['vValue'] = $vReceiverMobile;
        $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
        $Data_delivery['iDeliveryFieldId'] = 2;
        $Data_delivery['iCabRequestId'] = $insert_id;
        $Data_delivery['vValue'] = $vReceiverName;
        $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
        $Data_delivery['iDeliveryFieldId'] = 1;
        $Data_delivery['iCabRequestId'] = $insert_id;
        $Data_delivery['vValue'] = $iPackageTypeId;
        $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
        $Data_delivery['iDeliveryFieldId'] = 5;
        $Data_delivery['iCabRequestId'] = $insert_id;
        $Data_delivery['vValue'] = $tPackageDetails;
        $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
        $delivery_ids = implode("','", $insert_did);
        $where = " iTripDeliveryFieldId in ('" . $delivery_ids . "')";
        $data_update['iTripDeliveryLocationId'] = $insert_dfid;
        $obj->MySQLQueryPerform("trip_delivery_fields", $data_update, 'update', $where);
        $where = " iCabRequestId='" . $insert_id . "'";
        $data_update_cab['vDestLatitude'] = $Data_trip_locations['tEndLat'];
        $data_update_cab['vDestLongitude'] = $Data_trip_locations['tEndLong'];
        $data_update_cab['tDestAddress'] = $Data_trip_locations['tDaddress'];
        $obj->MySQLQueryPerform("cab_request_now", $data_update_cab, 'update', $where);
    }
    /* ------------------------multi delivery details end------------------- */
    if ($MODULES_OBJ->checkStopOverPointModule()) {
        setStopOverPointLocation($insert_id);
    }
    if ($PUBNUB_DISABLED == "Yes") {
        $ENABLE_PUBNUB = "No";
    }
    $alertSendAllowed = true;
    $labelsStoreArr = array();
    $labelsStoreArr[$userLanguageCode]['LBL_TRIP_USER_WAITING'] = $userLanguageLabelsArr['LBL_TRIP_USER_WAITING'];
    $labelsStoreArr[$userLanguageCode]['LBL_USER_WAITING'] = $userLanguageLabelsArr['LBL_USER_WAITING'];
    $labelsStoreArr[$userLanguageCode]['LBL_DELIVERY_SENDER_WAITING'] = $userLanguageLabelsArr['LBL_DELIVERY_SENDER_WAITING'];
    ### GCM ####
    $generalDataArr = $DriverDataArr = array();
    
    foreach ($result_driverData as $item) {
        if ($eType == "Ride") {
            if (!empty($labelsStoreArr[$item['vLang']]['LBL_TRIP_USER_WAITING'])) {
                $alertMsg_db = $labelsStoreArr[$item['vLang']]['LBL_TRIP_USER_WAITING'];
            } else {
                $alertMsg_db = get_value('language_label', 'vValue', 'vLabel', 'LBL_TRIP_USER_WAITING', " and vCode='" . $item['vLang'] . "'", 'true');
                $labelsStoreArr[$item['vLang']]['LBL_TRIP_USER_WAITING'] = $alertMsg_db;
            }
        } elseif ($eType == "UberX") {
            if (!empty($labelsStoreArr[$item['vLang']]['LBL_USER_WAITING'])) {
                $alertMsg_db = $labelsStoreArr[$item['vLang']]['LBL_USER_WAITING'];
            } else {
                $alertMsg_db = get_value('language_label', 'vValue', 'vLabel', 'LBL_USER_WAITING', " and vCode='" . $item['vLang'] . "'", 'true');
                $labelsStoreArr[$item['vLang']]['LBL_USER_WAITING'] = $alertMsg_db;
            }
        } else {
            if (!empty($labelsStoreArr[$item['vLang']]['LBL_DELIVERY_SENDER_WAITING'])) {
                $alertMsg_db = $labelsStoreArr[$item['vLang']]['LBL_DELIVERY_SENDER_WAITING'];
            } else {
                $alertMsg_db = get_value('language_label', 'vValue', 'vLabel', 'LBL_DELIVERY_SENDER_WAITING', " and vCode='" . $item['vLang'] . "'", 'true');
                $labelsStoreArr[$item['vLang']]['LBL_DELIVERY_SENDER_WAITING'] = $alertMsg_db;
            }
        }
        $tSessionId = $item['tSessionId'];
        // packagename changes
        if ($eType == "Deliver" || $eType == "Delivery") {
            $sql_request = "SELECT vName_" . $item['vLang'] . " as vName FROM package_type WHERE iPackageTypeId='" . $iPackageTypeId . "'";
            $pkgdata = $obj->MySQLSelect($sql_request);
            $final_message['PACKAGE_TYPE'] = ($eType == "Deliver" || $eType == "Delivery") ? $pkgdata[0]['vName'] : '';
        } else {
            $final_message['PACKAGE_TYPE'] = "";
        }
        $final_message['tSessionId'] = $tSessionId;
        $final_message['tSessionId'] = "";
        $final_message['vTitle'] = $alertMsg_db;
        if ($item['vTripStatus'] == "On Going Trip") {
            $final_message['eAcceptTripRequest'] = "Yes";
        } else {
            $final_message['eAcceptTripRequest'] = "No";
        }
        if ($MODULES_OBJ->isEnableVideoConsultingService()) {
            $final_message['isVideoCall'] = $isVideoCall;
            $final_message['moreServices'] = "No";
            if (!empty($orderDetails)) {
                $tVehicleTypeDataArr = json_decode($orderDetails, true);
                if (count($tVehicleTypeDataArr) > 1) {
                    $final_message['moreServices'] = "Yes";
                }
            }
        }

        $item['iCabRequestId'] = $insert_id;
        $DriverDataArr[] = $item;

        $generalDataArr[] = array('eDeviceType' => $item['eDeviceType'], 'deviceToken' => $item['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $item['eAppTerminate'], 'eDebugMode' => $item['eDebugMode'], 'eHmsDevice' => $item['eHmsDevice'], 'message' => $final_message, 'addRequestSentArr' => array('iUserId' => $passengerId, 'iDriverId' => $item['iDriverId'], 'tMessage' => $final_message, 'iMsgCode' => $final_message['MsgCode'], 'vStartLatlong' => $sourceLoc, 'vEndLatlong' => $destLoc, 'tStartAddress' => $PickUpAddress, 'tEndAddress' => $DestAddress), 'channelName' => "CAB_REQUEST_DRIVER_" . $item['iDriverId']);
    }

    if(!empty($OPTIMIZE_DATA_OBJ)) {
        $OPTIMIZE_DATA_OBJ->SetCabRequestAddress($DriverDataArr);    
    }

    
    $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
    $returnArr['Action'] = "1";
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "cancelTrip") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $driverComment = isset($_REQUEST["Comment"]) ? $_REQUEST["Comment"] : '';
    $driverReason = isset($_REQUEST["Reason"]) ? $_REQUEST["Reason"] : '';
    $eConfirmByUser = isset($_REQUEST['eConfirmByUser']) ? $_REQUEST['eConfirmByUser'] : 'No';
    $iCancelReasonId = isset($_REQUEST["iCancelReasonId"]) ? $_REQUEST["iCancelReasonId"] : '';
    $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
    $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
    if ($eConfirmByUser == "" || $eConfirmByUser == NULL) {
        $eConfirmByUser = "No";
    }
    //Added By HJ On 03-07-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $iTripId])) {
        $tripCancelData = $tripDetailsArr['trips_' . $iTripId];
    } else {
        $tripCancelData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $iTripId . "'");
        $tripDetailsArr['trips_' . $iTripId] = $tripCancelData;
    }
    //Added By HJ On 03-07-2020 For Optimize trips Table Query End
    $iVehicleTypeId = $tripCancelData[0]['iVehicleTypeId'];
    //$tripCancelData = get_value('trips AS tr LEFT JOIN vehicle_type AS vt ON vt.iVehicleTypeId=tr.iVehicleTypeId', 'tr.vCouponCode,tr.vTripPaymentMode,tr.iUserId,tr.iFare,tr.vRideNo,tr.tStartDate,tr.tTripRequestDate,tr.tDriverArrivedDate,tr.eType,tr.ePaymentBy,tr.iOrganizationId, tr.tUserWalletBalance,vt.fCancellationFare,vt.iCancellationTimeLimit,vt.iWaitingFeeTimeLimit,tr.ePoolRide,tr.tVehicleTypeFareData,tr.eWalletDebitAllow,tr.eType', 'iTripId', $iTripId);
    //Added By HJ On 03-07-2020 For Optimize vehicle_type Table Query Start
    if (isset($vehicleTypeDataArr['vehicle_type'])) {
        $vehicleTypeDataArr = $vehicleTypeDataArr['vehicle_type'];
    } else {
        $vehicleTypeData = $obj->MySQLSelect("SELECT * FROM vehicle_type");
        $vehicleTypeDataArr['vehicle_type'] = $vehicleTypeData;
    }
    $typeDataArr = array();
    for ($h = 0; $h < count($vehicleTypeData); $h++) {
        $typeDataArr[$vehicleTypeData[$h]['iVehicleTypeId']] = $vehicleTypeData[$h];
    }
    //Added By HJ On 03-07-2020 For Optimize vehicle_type Table Query End
    $tripCancelData[0]['fCancellationFare'] = $typeDataArr[$iVehicleTypeId]['fCancellationFare'];
    $tripCancelData[0]['iCancellationTimeLimit'] = $typeDataArr[$iVehicleTypeId]['iCancellationTimeLimit'];
    $tripCancelData[0]['iWaitingFeeTimeLimit'] = $typeDataArr[$iVehicleTypeId]['iWaitingFeeTimeLimit'];
    $old_iActive = $tripCancelData[0]['iActive'];
    $isVideoCall = $tripCancelData[0]['isVideoCall'];

    $eWalletDebitAllow = "No";
    $TripType = "Ride";
    if (count($tripCancelData) > 0) {
        $eWalletDebitAllow = $tripCancelData[0]['eWalletDebitAllow'];
        $TripType = $tripCancelData[0]['eType'];
    }
    if ($TripType == 'Multi-Delivery') {
        $sql1 = "SELECT count(`iTripDeliveryLocationId`) AS Total FROM trips_delivery_locations WHERE iTripId='" . $iTripId . "' AND (iActive = 'Finished' OR iActive = 'On Going Trip')";
        $totalRunning = $obj->MySQLSelect($sql1);
        if ($totalRunning[0]['Total'] > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NOT_CANCELLED_TRIP_TXT";
            setDataResponse($returnArr);
        }
    }
    if ($TripType != 'Multi-Delivery') {
        $ssql = " AND (iActive = 'Finished' OR iActive = 'On Going Trip') ";
        if(strtoupper($isVideoCall) == "YES") {
            $ssql = " AND iActive = 'Finished' ";
        }
        $sql1 = "SELECT count(`iTripId`) AS Total FROM trips WHERE iTripId='" . $iTripId . "' $ssql";
        $totalRunning = $obj->MySQLSelect($sql1);
        if ($totalRunning[0]['Total'] > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "DO_RESTART";
            setDataResponse($returnArr);
        }
    }
    $iOrganizationId = $tripCancelData[0]['iOrganizationId'];
    $ePaymentBy = $tripCancelData[0]['ePaymentBy'];
    $ePoolRide = $tripCancelData[0]['ePoolRide'];
    $tUserWalletBalance = $tripCancelData[0]['tUserWalletBalance'];
    if ($iUserId == "" || $iUserId == NULL || $iUserId == 0) {
        $iUserId = $tripCancelData[0]['iUserId'];
    }
    $tStartDate = $tripCancelData[0]['tStartDate'];
    $tTripRequestDate = $tripCancelData[0]['tTripRequestDate'];
    $tDriverArrivedDate = $tripCancelData[0]['tDriverArrivedDate'];
    if ($userType != "Driver") {
        $currentDate = @date("Y-m-d H:i:s");
    } else {
        $currentDate = @date("Y-m-d H:i:s");
        $tTripRequestDate = $tDriverArrivedDate;
        if ($tTripRequestDate == "0000-00-00 00:00:00") {
            $tTripRequestDate = @date("Y-m-d H:i:s");
        }
    }
    $fCancellationFare = 0;
    /*if ($ePaymentBy == "Organization") {
        $fCancellationFare = $tripCancelData[0]['fCancellationFare'];
    }*/
    if ($tDriverArrivedDate == "0000-00-00 00:00:00") {
        $fWaitingFees = 0;
    } else {
        $fWaitingFees = FetchTripWaitingCharges($iTripId);
    }
    //Added By HJ On 03-07-2020 For Optimize register_driver Table Query Start
    if (isset($userDetailsArr['register_driver_' . $iDriverId])) {
        $result = $userDetailsArr['register_driver_' . $iDriverId];
    } else {
        $result = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='" . $iDriverId . "'");
        $userDetailsArr['register_driver_' . $iDriverId] = $result;
    }
    $driverTripId = $result[0]['iTripId'];
    //Added By HJ On 03-07-2020 For Optimize register_driver Table Query End
    //Added By HJ On 03-07-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $driverTripId])) {
        $driverTripData = $tripDetailsArr['trips_' . $driverTripId];
    } else {
        $driverTripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $driverTripId . "'");
        $tripDetailsArr['trips_' . $driverTripId] = $driverTripData;
    }
    $result[0]['driverName'] = $result[0]['vName'] . " " . $result[0]['vLastName'];
    $result[0]['vRideNo'] = $driverTripData[0]['vRideNo'];
    $result[0]['eType'] = $driverTripData[0]['eType'];
    $result[0]['fWalletDebit'] = $driverTripData[0]['fWalletDebit'];
    //Added By HJ On 03-07-2020 For Optimize trips Table Query End
    //Added By HJ On 03-07-2020 For Optimize register_driver Table Query End
    //$sql = "SELECT CONCAT(rd.vName,' ',rd.vLastName) AS driverName, tr.vRideNo, tr.eType,tr.fWalletDebit FROM trips as tr,register_driver as rd WHERE tr.iTripId=rd.iTripId AND rd.iDriverId = '" . $iDriverId . "'";
    //$result = $obj->MySQLSelect($sql);
    $eType = $result[0]['eType'];
    $fWaitingFees = 0; // As per discussion now waiting fee is not charge when cancel trip
    $eCancelChargeFailed = "No";
    $totalMinute = @round(abs(strtotime($currentDate) - strtotime($tTripRequestDate)) / 60, 2);
    //Added By HJ On 05-02-2019 For Calculate Cancellation Charge When Select Multiple Service Type Start
    $chkTimeLimit = $totalMinute >= $tripCancelData[0]['iCancellationTimeLimit'];
    $fCancellationFareAmt = $tripCancelData[0]['fCancellationFare'];
    if ($SERVICE_PROVIDER_FLOW == "Provider" && $eType == "UberX") {
        $tVehicleTypeFareData = (array)json_decode($tripCancelData[0]['tVehicleTypeFareData']);
        $fCancellationFareAmt = $chkTimeLimit = 0;
        if ($totalMinute >= $tVehicleTypeFareData['ParentCancellationTimeLimit']) {
            $timeCheckArr[] = 1;
            $fCancellationFareAmt += $tVehicleTypeFareData['ParentCancellationFare'];
        }
        if (in_array(1, $timeCheckArr)) {
            $chkTimeLimit = 1;
        }
    }
    $user_wallet_debit_amount = 0;
    //Added By HJ On 05-02-2019 For Calculate Cancellation Charge When Select Multiple Service Type End
    //Added By HJ On 03-07-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr['register_user_' . $iUserId])) {
        $getUserData = $getPassenger = $userDetailsArr['register_user_' . $iUserId];
    } else {
        $getUserData = $getPassenger = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr['register_user_' . $iUserId] = $getUserData;
    }
    $vLangCode = $getUserData[0]['vLang'];
    //Added By HJ On 03-07-2020 For Optimize register_user Table Query End
    $countryPaymentMethod = $obj->MySQLSelect("SELECT vPaymentGateway FROM country WHERE vCountryCode = '" . $getUserData[0]['vCountry'] . "'");
    $USER_APP_PAYMENT_METHOD = $APP_PAYMENT_METHOD;
    if (!empty($countryPaymentMethod[0]['vPaymentGateway'])) {
        $USER_APP_PAYMENT_METHOD = $countryPaymentMethod[0]['vPaymentGateway'];
    }
    $TOKENIZED_STATUS = strtoupper($USER_APP_PAYMENT_METHOD) . '_TOKENIZED';
    $IS_TOKENIZED = $$TOKENIZED_STATUS;
    $fTax1 = $fTax2 = $fTax1Percentage = $fTax2Percentage = setTwoDecimalPoint(0); // Added By HJ On 30-07-2020 For Apply Tax When Cancel Trip As Per Discuss With KS Sir
    if ($chkTimeLimit == 1) {
        ## Display Trip cancellation charge message to user ##
        if ($eConfirmByUser == "No" && $userType != "Driver" && $fCancellationFareAmt > 0) {
            // Added By HJ On 30-07-2020 For Apply Tax When Cancel Trip As Per Discuss With KS Sir Start
            $tripDriverId = $tripCancelData[0]['iDriverId'];
            $taxData = caancelTripCountryTax($tripDriverId, "Driver", $fCancellationFareAmt); // For Apply Tax Plz remove comment
            if (isset($taxData['fTax1']) && $taxData['fTax1'] > 0) {
                $fTax1 = $taxData['fTax1'];
                $fCancellationFareAmt += $fTax1;
                $fTax1Percentage = $taxData['fTax1Percentage'];
            }
            if (isset($taxData['fTax2']) && $taxData['fTax2'] > 0) {
                $fTax2 = $taxData['fTax2'];
                $fCancellationFareAmt += $fTax2;
                $fTax2Percentage = $taxData['fTax2Percentage'];
            }
            // Added By HJ On 30-07-2020 For Apply Tax When Cancel Trip As Per Discuss With KS Sir End
            $Cancel_Amount_ARR = getPriceUserCurrency($iUserId, "Passenger", $fCancellationFareAmt);
            $Cancel_Amount = $Cancel_Amount_ARR['fPricewithsymbol'];
            $TripType = $tripCancelData[0]['eType'];
            //$vLangCode = get_value("register_user", "vLang", "iUserId", $iUserId, '', 'true');
            if ($vLangCode == "" || $vLangCode == NULL) {
                //Added By HJ On 03-07-2020 For Optimize language_master Table Query Start
                $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 03-07-2020 For Optimize language_master Table Query End
            }
            //Added By HJ On 03-07-2020 For Optimize language_label_1 Table Query Start
            if (isset($languageLabelDataArr['language_label_1_' . $vLangCode])) {
                $lngLabelsArr = $languageLabelDataArr['language_label_1_' . $vLangCode];
            } else {
                $lngLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
                $languageLabelDataArr['language_label_1_' . $vLangCode] = $lngLabelsArr;
            }
            //Added By HJ On 03-07-2020 For Optimize language_label_1 Table Query End
            if ($TripType == "Ride") {
                $cancelMsg_db = $lngLabelsArr['LBL_CANCELTRIP_RIDE_CHARGE_PREFIX_TXT'] . " " . $Cancel_Amount . " " . $lngLabelsArr['LBL_CANCELTRIP_RIDE_CHARGE_POSTFIX_TXT'];
            } elseif ($TripType == "UberX") {
                $cancelMsg_db = $lngLabelsArr['LBL_CANCELTRIP_SERVICE_CHARGE_PREFIX_TXT'] . " " . $Cancel_Amount . " " . $lngLabelsArr['LBL_CANCELTRIP_SERVICE_CHARGE_POSTFIX_TXT'];
            } else {
                $cancelMsg_db = $lngLabelsArr['LBL_CANCELTRIP_DELIVER_CHARGE_PREFIX_TXT'] . " " . $Cancel_Amount . " " . $lngLabelsArr['LBL_CANCELTRIP_DELIVER_CHARGE_POSTFIX_TXT'];
            }
            $returnArr['Action'] = "0";
            $returnArr['message'] = $cancelMsg_db;
            $returnArr['isCancelChargePopUpShow'] = "Yes";
            $returnArr['CancelChargeAmount'] = $Cancel_Amount;
            setDataResponse($returnArr);
        }
        if ($ePaymentBy == "Passenger" || $ePaymentBy == "Organization") {
            ## Display Trip cancellation charge message to user ##
            $fCancellationFare = $fCancellationFareAmt;
            $fCancellationFare = $fCancellationFare + $fWaitingFees;
            $vTripPaymentMode = $tripCancelData[0]['vTripPaymentMode'];
            // Added By HJ On 30-07-2020 For Apply Tax When Cancel Trip As Per Discuss With KS Sir Start
            $totalCancelFare = $fCancellationFare;
            $tripDriverId = $tripCancelData[0]['iDriverId'];
            $taxData = caancelTripCountryTax($tripDriverId, "Driver", $totalCancelFare); // For Apply Tax Plz remove comment
            if (isset($taxData['fTax1']) && $taxData['fTax1'] > 0) {
                $fTax1 = $taxData['fTax1'];
                $totalCancelFare += $fTax1;
                $fTax1Percentage = $taxData['fTax1Percentage'];
                $Data_update_trips_tax['fTax1'] = $fTax1;
                $Data_update_trips_tax['fTax1Percentage'] = $fTax1Percentage;
            }
            if (isset($taxData['fTax2']) && $taxData['fTax2'] > 0) {
                $fTax2 = $taxData['fTax2'];
                $totalCancelFare += $fTax2;
                $fTax2Percentage = $taxData['fTax2Percentage'];
                $Data_update_trips_tax['fTax1'] = $fTax1;
                $Data_update_trips_tax['fTax1Percentage'] = $fTax1Percentage;
            }
            if (isset($Data_update_trips_tax['fTax1']) || isset($Data_update_trips_tax['fTax2'])) {
                $where_trip_tax = " iTripId = '$iTripId'";
                $obj->MySQLQueryPerform("trips", $Data_update_trips_tax, 'update', $where_trip_tax);
            }
            $totalCancelFare = $totalCancelFare + $driverTripData[0]['fOutStandingAmount'];
            // Added By HJ On 30-07-2020 For Apply Tax When Cancel Trip As Per Discuss With KS Sir End
            /* Check debit wallet For Cancel Charge */
            if ($totalCancelFare > 0 && $eWalletDebitAllow == "Yes" && $ePaymentBy == "Passenger") {
                $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iUserId, "Rider");
                if ($user_available_balance > 0) {
                    $totalCurrentActiveTripsArr = FetchTotalOngoingTrips($iUserId);
                    $totalCurrentActiveTripsIdsArr = $totalCurrentActiveTripsArr['ActiveTripIds'];
                    $totalCurrentActiveOrderIdsArr = $totalCurrentActiveTripsArr['ActiveOrderIds'];
                    $totalCurrentActiveTripsCount = $totalCurrentActiveTripsArr['TotalCount'];
                    /** ******** Replace current wallet balance of user when System payment flow is Method-2/Method-3 ***** */
                    // Charge an amount that is autorized when trip was initially requested in case when multiple jobs are going on.
                    // if (($totalCurrentActiveTripsCount > 1 || in_array($iTripId, $totalCurrentActiveTripsIdsArr) == false) && ($SYSTEM_PAYMENT_FLOW == "Method-2" || $SYSTEM_PAYMENT_FLOW == 'Method-3')) {
                    if (($totalCurrentActiveTripsCount > 1 || in_array($iTripId, $totalCurrentActiveTripsIdsArr) == false) && ($vTripPaymentMode == "Wallet")) {
                        $user_available_balance = $tUserWalletBalance;
                    }
                    /** ******** Replace current wallet balance of user when System payment flow is Method-2/Method-3 ***** */
                }
                if ($totalCancelFare > $user_available_balance) {
                    $fCancellationFare = $totalCancelFare - $user_available_balance;
                    $totalCancelFare = $fCancellationFare;
                    $user_wallet_debit_amount = $user_available_balance;
                } else {
                    $user_wallet_debit_amount = $totalCancelFare;
                    $fCancellationFare = 0;
                    $totalCancelFare = $fCancellationFare;
                    $updateQuery = "UPDATE trips set fWalletDebit = '" . $user_wallet_debit_amount . "' WHERE iTripId = " . $iTripId;
                    $obj->sql_query($updateQuery);
                    $os_paidToDriver = "No";
                    if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()) {
                        $os_paidToDriver = "Yes";
                    }
                    $iTripOutstandId = ReviseTripPayableAmount($iTripId, "Yes", $os_paidToDriver);
                    //added by SP on 24-06-2021 for solving scenario of cancel trip Outstanding start
                    $outStandingSql = "";
                    if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
                        $outStandingSql = " AND eAuthoriseIdName='iTripId' AND iAuthoriseId='" . $iTripId . "'";
                    }
                    $org_sql = " AND iOrganizationId = '0' AND ePaymentBy = 'Passenger' ";
                    if (!empty($iOrganizationId) && $iOrganizationId > 0 && $ePaymentBy == "Organization") {
                        $org_sql = " AND iOrganizationId = '" . $iOrganizationId . "' AND ePaymentBy = 'Organization' ";
                    }
                    $updateQury = "UPDATE trip_outstanding_amount set vTripPaymentMode = '" . $vTripPaymentMode . "', vTripAdjusmentId = '" . $iTripId . "',ePaidByPassenger = 'Yes' WHERE iUserId = '" . $iUserId . "' AND ePaidByPassenger = 'No' $outStandingSql $org_sql";
                    $obj->sql_query($updateQury);
                    //added by SP on 24-06-2021 for solving scenario of cancel trip Outstanding end
                }
            }
            /* Check debit wallet For Cancel Charge */
            // if ($vTripPaymentMode == "Card" && $totalCancelFare > 0 && $SYSTEM_PAYMENT_FLOW != "Method-2" && $SYSTEM_PAYMENT_FLOW != "Method-3") {
            $eCardFailed = "No";
            if ($vTripPaymentMode == "Card" && $totalCancelFare > 0) {
                ///$getUserData = $obj->MySQLSelect("SELECT vStripeCusId,vBrainTreeToken FROM register_user WHERE iUserId='" . $iUserId . "'");
                $vStripeCusId = $vBrainTreeToken = "";
                if (count($getUserData) > 0) {
                    $vStripeCusId = $getUserData[0]['vStripeCusId'];
                    $vBrainTreeToken = $getUserData[0]['vBrainTreeToken'];
                }
                //Added By HJ On 08-06-2020 For Optimization currency Table Query Start
                if (!empty($vSystemDefaultCurrencyName)) {
                    $currency = $vSystemDefaultCurrencyName;
                } else {
                    $currency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
                }
                //Added By HJ On 08-06-2020 For Optimization currency Table Query End
                $price_new = $totalCancelFare * 100;
                $description = "Payment received for cancelled trip number: #" . $tripCancelData[0]['vRideNo'];
                $AMOUNT = $fCancellationFare;
                $iMemberId = $iUserId;
                $UserType = "Passenger";
                $iPaymentInfoId = $tripCancelData[0]['iPaymentInfoId'];
                $paymentData = array("amount" => $AMOUNT, "description" => $description, "iMemberId" => $iMemberId, "UserType" => $UserType, "iPaymentInfoId" => $iPaymentInfoId);
                if (strtoupper($IS_TOKENIZED) == "NO") {
                    $paymentData['return_url'] = $tconfig['tsite_url'];
                    $paymentData['eType'] = $eType;
                }
                $result = (PaymentGateways::getInstance())->execute($paymentData);
                if ($result['Action'] == "1") {
                    if (isset($result['AUTHENTICATION_REQUIRED'])) {
                        // $returnArr['Action'] = "0";
                        // $returnArr['AUTHENTICATION_REQUIRED'] = "Yes";
                        // $returnArr['AUTHENTICATION_URL'] = $result['AUTHENTICATION_URL'];
                        // $returnArr['message'] = 'To collect payment user authentication is required or you can collect cash. By clicking on "Continue" user will receive payment url request in Application, email and sms.';
                        // setDataResponse($returnArr);
                        $eCancelChargeFailed = 'Yes';
                        $Data_update_trips['eCardFailed'] = "Yes";
                    } else {
                        $payment_id = $result['payment_id'];
                        $where_payments = " iPaymentId = '" . $payment_id . "'";
                        $data_payments['iTripId'] = $iTripId;
                        $data_payments['eEvent'] = "Trip";
                        $obj->MySQLQueryPerform("payments", $data_payments, 'update', $where_payments);
                    }
                } else {
                    $returnArr = $result;
                    $eCancelChargeFailed = 'Yes';
                    $returnArr['message'] = $languageLabelsArr['LBL_CHARGE_COLLECT_FAILED'];
                    if(isset($result['message'])) {
                        $returnArr['message'] = $result['message']; 
                    }
                    // setDataResponse($returnArr);
                }
                /*$Charge_Array = array(
                    "iFare" => $totalCancelFare,
                    "price_new" => $price_new,
                    "currency" => $currency,
                    "vStripeCusId" => $vStripeCusId,
                    "description" => $description,
                    "iTripId" => $iTripId,
                    "eCancelChargeFailed" => $eCancelChargeFailed,
                    "vBrainTreeToken" => $vBrainTreeToken,
                    "vRideNo" => $tripCancelData[0]['vRideNo'],
                    "iMemberId" => $iUserId,
                    "UserType" => "Passenger"
                );
                $ChargeidArr = ChargeCustomer($Charge_Array, "cancelTrip"); // function for charge customer
                $ChargeidArrId = $ChargeidArr['id'];
                $eCancelChargeFailed = $ChargeidArr['eCancelChargeFailed'];
                $status = $ChargeidArr['status'];
                if ($status == "success") {
                    $where_payments = " iPaymentId = '" . $ChargeidArrId . "'";
                    $data_payments['iTripId'] = $iTripId;
                    $data_payments['eEvent'] = "Trip";
                    $obj->MySQLQueryPerform("payments", $data_payments, 'update', $where_payments);
                } else {
                    $eCancelChargeFailed = 'Yes';
                }*/
            }
            // if (($vTripPaymentMode == "Cash" && $totalCancelFare > 0) || (($SYSTEM_PAYMENT_FLOW == "Method-2" || $SYSTEM_PAYMENT_FLOW == "Method-3") && $totalCancelFare > 0)) {
            if (($vTripPaymentMode == "Cash" || $vTripPaymentMode == "Wallet") && $totalCancelFare > 0) {
                $eCancelChargeFailed = 'Yes';
            }
        }
    }
    $active_status = "Canceled";
    $message = "TripCancelledByDriver";
    if ($userType != "Driver") {
        $message = "TripCancelled";
    }
    $couponCode = $tripCancelData[0]['vCouponCode'];
    if ($couponCode != '') {
        $noOfCouponUsed = get_value('coupon', 'iUsed', 'vCouponCode', $couponCode, '', 'true');
        $where = " vCouponCode = '" . $couponCode . "'";
        $data_coupon['iUsed'] = $noOfCouponUsed - 1;
        $obj->MySQLQueryPerform("coupon", $data_coupon, 'update', $where);
    }
    $statusUpdate_user = "Not Assigned";
    $trip_status = "Cancelled";
    $fWalletDebit = $result[0]['fWalletDebit'];
    /* For PubNub Setting */
    $tableName = $userType != "Driver" ? "register_driver" : "register_user";
    $iMemberId_VALUE = $userType != "Driver" ? $iDriverId : $iUserId;
    $iMemberId_KEY = $userType != "Driver" ? "iDriverId" : "iUserId";
    //Added By HJ On 03-07-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr[$tableName . '_' . $iDriverId])) {
        $AppData = $userDetailsArr[$tableName . '_' . $iDriverId];
    } else {
        $AppData = $obj->MySQLSelect("SELECT *,$iMemberId_KEY as iMemberId FROM " . $tableName . " WHERE $iMemberId_KEY='" . $iMemberId_VALUE . "'");
        $userDetailsArr[$tableName . '_' . $iDriverId] = $AppData;
    }
    //Added By HJ On 03-07-2020 For Optimize register_user Table Query End
    //$AppData = get_value($tableName, 'iAppVersion,eDeviceType,eLogout,vLang', $iMemberId_KEY, $iMemberId_VALUE);
    $iAppVersion = $AppData[0]['iAppVersion'];
    $eLogout = $AppData[0]['eLogout'];
    $eDeviceType = $AppData[0]['eDeviceType'];
    $alertMsg = "Trip canceled";
    //$vLangCode=get_value($tableName, 'vLang', $iMemberId_KEY,$iMemberId_VALUE,'','true');
    $vLangCode = $AppData[0]['vLang'];
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 03-07-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 03-07-2020 For Optimize language_master Table Query End
    }
    //Added By HJ On 03-07-2020 For Optimize language_label_1 Table Query Start
    if (isset($languageLabelDataArr['language_label_1_' . $vLangCode])) {
        $languageLabelsArr = $languageLabelDataArr['language_label_1_' . $vLangCode];
    } else {
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
        $languageLabelDataArr['language_label_1_' . $vLangCode] = $languageLabelsArr;
    }
    //Added By HJ On 03-07-2020 For Optimize language_label_1 Table Query End
    if ($iCancelReasonId != "") {
        //Added By HJ On 03-07-2020 For Optimize cancel_reason Table Query Start
        if (isset($tripDetailsArr['cancel_reason'])) {
            $getCancelReasons = $tripDetailsArr['cancel_reason'];
        } else {
            $getCancelReasons = $obj->MySQLSelect("SELECT * FROM cancel_reason");
            $tripDetailsArr['cancel_reason'] = $getCancelReasons;
        }
        $cancelReasonArr = array();
        for ($c = 0; $c < count($getCancelReasons); $c++) {
            $cancelReasonArr[$getCancelReasons[$c]['iCancelReasonId']] = $getCancelReasons[$c];
        }
        if (isset($cancelReasonArr[$iCancelReasonId])) {
            $driverReason = $cancelReasonArr[$iCancelReasonId]['vTitle_' . $vLangCode];
        } else {
            $driverReason = get_value('cancel_reason', "vTitle_" . $vLangCode, 'iCancelReasonId', $iCancelReasonId, '', 'true');
        }
        //Added By HJ On 03-07-2020 For Optimize cancel_reason Table Query End
    }
    if ($userType == "Driver") {
        if ($eType == "Ride") {
            $usercanceltriplabel = $languageLabelsArr['LBL_PREFIX_TRIP_CANCEL_DRIVER'] . ' ' . $driverReason . ' ' . $languageLabelsArr['LBL_CANCEL_TRIP_BY_DRIVER_MSG_SUFFIX'];
        } elseif ($eType == "Deliver") {
            $usercanceltriplabel = $languageLabelsArr['LBL_PREFIX_DELIVERY_CANCEL_DRIVER'] . ' ' . $driverReason . ' ' . $languageLabelsArr['LBL_CANCEL_DELIVERY_BY_DRIVER_MSG_SUFFIX'];
        } else {
            $jobnotitle = "#" . $result[0]['vRideNo'];
            $jobnomsg = str_replace('####', $jobnotitle, $languageLabelsArr['LBL_PREFIX_JOB_CANCEL_PROVIDER']);
            $usercanceltriplabel = $jobnomsg . ' ' . $driverReason . ' ' . $languageLabelsArr['LBL_CANCEL_UBERX_BOOKING_BY_DRIVER_MSG_SUFFIX'];
        }
    } else {
        if ($eType == "Ride") {
            $usercanceltriplabel = $languageLabelsArr['LBL_PASSENGER_CANCEL_TRIP_TXT'];
            //Added By Hasmukh On 07-12-2018 For Get Pool Trip's Passenger Name Start
            if ($POOL_ENABLE == "Yes" && $ePoolRide == "Yes") {
                $riderName = "";
                //$getPassenger = $obj->MySQLSelect("SELECT vName,vLastName FROM register_user WHERE iUserId='" . $iUserId . "'");
                if (isset($getPassenger[0]['vName']) && $getPassenger[0]['vName'] != "") {
                    $riderName = $getPassenger[0]['vName'] . " " . $getPassenger[0]['vLastName'];
                }
                $usercanceltriplabel = $riderName . " " . $languageLabelsArr['LBL_PASSENGER_CANCEL_TRIP_TXT'];
            }
            //Added By Hasmukh On 07-12-2018 For Get Pool Trip's Passenger Name End
        } elseif ($eType == "Deliver") {
            $usercanceltriplabel = $languageLabelsArr['LBL_SENDER_CANCEL_DELIVERY_TXT'];
        } else {
            $usercanceltriplabel = $languageLabelsArr['LBL_USER_CANCEL_JOB_TXT'];
        }
    }
    $alertMsg = $usercanceltriplabel;
    $message_arr = array();
    $message_arr['Message'] = $message;
    if ($userType == "Driver") {
        $message_arr['Reason'] = $driverReason;
        $message_arr['isTripStarted'] = "false";
    }
    $message_arr['iTripId'] = $iTripId;
    $message_arr['iDriverId'] = $iDriverId;
    $message_arr['iUserId'] = $iUserId;
    $message_arr['driverName'] = $result[0]['driverName'];
    $message_arr['vRideNo'] = $result[0]['vRideNo'];
    $message_arr['eType'] = $result[0]['eType'];
    $message_arr['vTitle'] = $alertMsg;
    $message_arr['eSystem'] = "";
    $where = " iTripId = '$iTripId'";
    $Data_update_trips['iActive'] = $active_status;
    $Data_update_trips['tEndDate'] = @date("Y-m-d H:i:s");
    $Data_update_trips['fWaitingFees'] = $fWaitingFees;
    $Data_update_trips['fWalletDebit'] = $user_wallet_debit_amount;
    if ($tStartDate == "0000-00-00 00:00:00") {
        $Data_update_trips['tStartDate'] = @date("Y-m-d H:i:s");
    }
    if ($tDriverArrivedDate == "0000-00-00 00:00:00") {
        $Data_update_trips['tDriverArrivedDate'] = @date("Y-m-d H:i:s");
    }
    //if($vTripPaymentMode == "Card" && $fCancellationFare > 0){
    if ($fCancellationFare > 0) {
        $Data_update_trips['eCancelChargeFailed'] = $eCancelChargeFailed;
        $Data_update_trips['fCancellationFare'] = $fCancellationFare;
    }
    // Added By HJ On 30-07-2020 For Insert Tax When Cancel Trip As Per Discuss With KS Sir Start
    if ($fTax1 > 0) {
        $Data_update_trips['fTax1'] = $fTax1;
        $Data_update_trips['fTax1Percentage'] = $fTax1Percentage;
    }
    if ($fTax2 > 0) {
        $Data_update_trips['fTax2'] = $fTax2;
        $Data_update_trips['fTax2Percentage'] = $fTax2Percentage;
    }
    // Added By HJ On 30-07-2020 For Insert Tax When Cancel Trip As Per Discuss With KS Sir End
    $Data_update_trips['eCancelledBy'] = $userType;
    //if ($userType == "Driver") { // Commented By HJ On 26-03-2019 As Per Discuss With BM QA Bug - 6430
    $Data_update_trips['vCancelReason'] = ($iCancelReasonId > 0) ? "" : $driverReason;
    $Data_update_trips['vCancelComment'] = $driverComment;
    $Data_update_trips['eCancelled'] = "Yes";
    //} // Commented By HJ On 26-03-2019 As Per Discuss With BM QA Bug - 6430
    if ($eType == "Multi-Delivery") {
        $Data_update_trips['fTripGenerateFare'] = $Data_update_trips['iFare'] = $Data_update_trips['iBaseFare'] = $Data_update_trips['fCommision'] = 0;
        if ($fWalletDebit > 0) {
            $dDate = Date('Y-m-d H:i:s');
        }
        //$Data_update_trips['fWalletDebit'] = 0;
        $Data_update_trips['fDiscount'] = $Data_update_trips['fSurgePriceDiff'] = 0;
        $Data_update_trips['vCouponCode'] = "";
        $endtime = @date("Y-m-d H:i:s");
        $updateQuery = "UPDATE trips_delivery_locations set iActive='Canceled',tEndTime='" . $endtime . "'  WHERE iTripId = '" . $iTripId . "'";
        $obj->sql_query($updateQuery);
    }
    $Data_update_trips['iCancelReasonId'] = $iCancelReasonId;
    $id = $obj->MySQLQueryPerform("trips", $Data_update_trips, 'update', $where);
    //update insurance log
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $details_arr['iTripId'] = $iTripId;
        $details_arr['LatLngArr']['vLatitude'] = $vLatitude;
        $details_arr['LatLngArr']['vLongitude'] = $vLongitude;
        // $details_arr['LatLngArr']['vLocation'] = $Source_point_Address;
        $allow_blank_latlong = "No";
        if ($userType != "Driver") {
            $allow_blank_latlong = "Yes";
        }
        update_driver_insurance_status($iDriverId, "Trip", $details_arr, "cancelTrip", "", $allow_blank_latlong);
    }
    //update insurance log
    ## Update Passenger OutStanding Amount ##
    if ($eCancelChargeFailed == "Yes" && $fCancellationFare > 0 && $ePaymentBy == "Passenger" && $iOrganizationId == 0) {
        $iTripOutstandId = ReviseTripPayableAmount($iTripId, "No", "No");
    }
    if ($eCancelChargeFailed == "No" && $vTripPaymentMode == "Card" && $fCancellationFare > 0 && $ePaymentBy == "Passenger" && $iOrganizationId == 0) {
        $iTripOutstandId = ReviseTripPayableAmount($iTripId, "Yes", "No");
        /* Added By PM On 25-01-2020 For wallet credit to driver Start */
        if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()) {
            $Data['iUserId'] = $iUserId;
            $Data['iTripId'] = $iTripId;
            //AutoCreditWalletDriver($Data, "cancelTrip", 0);
            autoCreditDriverEarning($Data, "cancelTrip");
        }
        /* Added By PM On 25-01-2020 For wallet credit to driver End */
        //added by SP on 24-06-2021 for solving scenario of cancel trip Outstanding start
        $outStandingSql = "";
        if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
            $outStandingSql = " AND eAuthoriseIdName='iTripId' AND iAuthoriseId='" . $iTripId . "'";
        }
        $org_sql = " AND iOrganizationId = '0' AND ePaymentBy = 'Passenger' ";
        if (!empty($iOrganizationId) && $iOrganizationId > 0 && $ePaymentBy == "Organization") {
            $org_sql = " AND iOrganizationId = '" . $iOrganizationId . "' AND ePaymentBy = 'Organization' ";
        }
        $updateQury = "UPDATE trip_outstanding_amount set vTripPaymentMode = '" . $vTripPaymentMode . "', vTripAdjusmentId = '" . $iTripId . "',ePaidByPassenger = 'Yes' WHERE iUserId = '" . $iUserId . "' AND ePaidByPassenger = 'No' $outStandingSql $org_sql";
        $obj->sql_query($updateQury);
        //added by SP on 24-06-2021 for solving scenario of cancel trip Outstanding end
    }
    ## Update Passenger OutStanding Amount ##
    ## Update Organization OutStanding Amount ##
    if ($totalMinute >= $tripCancelData[0]['iCancellationTimeLimit'] && $fCancellationFare > 0 && $iOrganizationId > 0 && strtoupper(PACKAGE_TYPE) == "SHARK") {
        $iTripOutstandId = UpdateOrganizationTripOutstandingAmount($iTripId, "No", "No");
    }
    ## Update Organization OutStanding Amount ##
    $where = " iUserId = '$iUserId'";
    $Data_update_passenger['vCallFromDriver'] = $statusUpdate_user;
    if ($APP_TYPE == "Ride-Delivery-UberX" && $eType != "UberX") {
        $Data_update_passenger['vTripStatus'] = $trip_status;
    } else if ($eType != "UberX") {
        $Data_update_passenger['vTripStatus'] = $trip_status;
    }
    $id = $obj->MySQLQueryPerform("register_user", $Data_update_passenger, 'update', $where);
    $where = " iDriverId='$iDriverId'";
    // $Data_update_driver['iTripId']=$statusUpdate_user;
    if ($tripCancelData[0]['iActive'] != 'Inactive') {
        $Data_update_driver['vTripStatus'] = $trip_status;
        $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
    }
    //Added By HJ On 03-07-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $iTripId])) {
        $tripData = $tripDetailsArr['trips_' . $iTripId];
    } else {
        $tripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $iTripId . "'");
        $tripDetailsArr['trips_' . $iTripId] = $tripData;
    }
    $fOutStandingAmount = $tripData[0]['fOutStandingAmount'];
    $driverId_log = $tripData[0]['iDriverId'];
    //Added By HJ On 03-07-2020 For Optimize trips Table Query End
    //$fOutStandingAmount = get_value('trips', 'fOutStandingAmount', 'iTripId', $iTripId, '', 'true');
    //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 Start
    // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
    if ($vTripPaymentMode == "Wallet") {
        $obj->sql_query("UPDATE trip_outstanding_amount set eAuthoriseIdName='No',iAuthoriseId = '0' WHERE iAuthoriseId='" . $iTripId . "' AND eAuthoriseIdName='iTripId'");
    }
    $tripData12 = $obj->MySQLSelect("SELECT ePaymentCollect FROM trips WHERE iTripId='" . $iTripId . "'");
    $ePaymentCollect = $tripData12[0]['ePaymentCollect'];
    //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 End
    if ($fOutStandingAmount > 0 && $ePaymentCollect == 'No') {
        $obj->sql_query("UPDATE trip_outstanding_amount set ePaidByPassenger = 'No',vTripAdjusmentId = '' WHERE iUserId = '" . $iUserId . "' AND vTripAdjusmentId IN($iTripId)");
        $obj->sql_query("UPDATE register_user set fTripsOutStandingAmount = fTripsOutStandingAmount+'" . $fOutStandingAmount . "' WHERE iUserId = " . $iUserId);
        $obj->sql_query("UPDATE trips set fOutStandingAmount = 0 WHERE iTripId = " . $iTripId);
    }
    $tableName = "register_user";
    $fieldName = "iUserId";
    $memberId = $iUserId;
    $channelName = "PASSENGER_" . $iUserId;
    //$sql = "SELECT iGcmRegId,eDeviceType,tLocationUpdateDate FROM register_user WHERE iUserId IN (" . $iUserId . ")";
    if ($userType != "Driver") {
        $channelName = "DRIVER_" . $iDriverId;
        $tableName = "register_driver";
        $fieldName = "iDriverId";
        $memberId = $iDriverId;
        //$sql = "SELECT iGcmRegId,eDeviceType,tLocationUpdateDate FROM register_driver WHERE iDriverId IN (" . $iDriverId . ")";
    }
    //Added By HJ On 03-07-2020 For Optimize register_driver/User Table Query Start
    if (isset($userDetailsArr[$tableName . '_' . $memberId])) {
        $result = $userDetailsArr[$tableName . '_' . $memberId];
    } else {
        $result = $obj->MySQLSelect("SELECT *,$fieldName as iMemberId FROM " . $tableName . " WHERE $fieldName='" . $memberId . "'");
        $userDetailsArr[$tableName . '_' . $iDriverId] = $result;
    }
    $tSessionId = $result[0]['tSessionId'];
    $eAppTerminate = $result[0]['eAppTerminate'];
    $eDebugMode = $result[0]['eDebugMode'];
    $eHmsDevice = $result[0]['eHmsDevice'];
    $eDeviceType = $result[0]['eDeviceType'];
    $iGcmRegId = $result[0]['iGcmRegId'];
    
    if(strtoupper($eDeviceType) == "IOS") {
        $tDeviceLiveActivityToken = getLiveActivityDeviceToken($iTripId, 'Trip');
    } else {
        $tDeviceLiveActivityToken = $iGcmRegId;
    }
    
    //Added By HJ On 03-07-2020 For Optimize register_driver/User Table Query End
    //$result = $obj->MySQLSelect($sql);
    $deviceTokens_arr_ios = $registation_ids_new = $eAppTerminateArr = array();
    foreach ($result as $item) {
        if ($item['eDeviceType'] == "Android") {
            array_push($registation_ids_new, $item['iGcmRegId']);
        } else {
            array_push($deviceTokens_arr_ios, $item['iGcmRegId']);
        }
    }
    $cmpMinutes = ceil((fetchtripstatustimeMAXinterval() + $intervalmins) / 60);
    $compare_date = @date('Y-m-d H:i:s', strtotime('-' . $cmpMinutes . ' minutes'));
    //added by SP on 17-02-2021 for custom notification
    $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
    //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
    $message_arr['CustomViewBtn'] = "No";
    $message_arr['CustomTrackDetails'] = "No";
    $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
    $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
    $customNotiArray = GetCustomNotificationDetails($iTripId, $message_arr['vTitle'], $vLangCode);
    //title and sub description shown in custom notification
    $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
    $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
    $message_arr['CustomMessage'] = $customNotiArray;
    $message_arr['tSessionId'] = $tSessionId;
    if ($userType != "Driver") {
        $channelName = "DRIVER_" . $iDriverId;
    } else {
        $channelName = "PASSENGER_" . $iUserId;

        if(strtoupper($ENABLE_NOTIFICATION_LIVE_ACTIVITY) == "YES") {
            $message_arr['LiveActivityData'] = getTripLiveActivity($iTripId);
            $message_arr['LiveActivity'] = "Yes";
            $message_arr['LiveActivityEnd'] = "Yes";

            $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $tDeviceLiveActivityToken, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr);    
        }        
    }
    $generalDataArr[] = array('eDeviceType' => $result[0]['eDeviceType'], 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName, 'tripStatusMsgArr' => array('tMessage' => $message_arr, 'iDriverId' => $iDriverId, 'iTripId' => $iTripId, 'iUserId' => $iUserId, 'eFromUserType' => ($userType == "Driver") ? "Driver" : "Passenger", 'eToUserType' => ($userType == "Driver") ? "Passenger" : "Driver", 'eReceived' => "No"));
    $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), $userType == "Driver" ? RN_USER : RN_PROVIDER);
    // Code for Check last logout date is update in driver_log_report
    //$driverId_log = get_value('trips', 'iDriverId', 'iTripId', $iTripId, '', 'true');
    $query = "SELECT * FROM driver_log_report WHERE iDriverId = '" . $driverId_log . "' ORDER BY iDriverLogId DESC LIMIT 0,1";
    $db_driver = $obj->MySQLSelect($query);
    if (count($db_driver) > 0) {
        $driver_lastonline = @date("Y-m-d H:i:s");
        $updateQuery = "UPDATE driver_log_report set dLogoutDateTime='" . $driver_lastonline . "' WHERE iDriverLogId = " . $db_driver[0]['iDriverLogId'];
        $obj->sql_query($updateQuery);
    }
    // Code for Check last logout date is update in driver_log_report Ends
    //getTripChatDetails($iTripId);
    $returnArr['Action'] = "1";
    $eType = $tripCancelData[0]['eType'];
    $label = "LBL_SUCCESS_DELIVERY_CANCELED";
    if ($eType == "Ride") {
        $label = "LBL_SUCCESS_TRIP_CANCELED";
    } elseif ($eType == "UberX") {
        $label = "LBL_SUCCESS_BOOKING_CANCELED";
    }
    if ($userType == "Passenger") {
        // $returnArr['message'] = getPassengerDetailInfo($iUserId, "", "");
        $returnArr['USER_DATA'] = getPassengerDetailInfo($iUserId, "", "");
        $returnArr['message1'] = $label;
    } else {
        $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId, "", "");
        $returnArr['message1'] = $label;
    }
    if ($old_iActive != 'Active' || $fCancellationFare > 0) {
        if ($userType == "Passenger") {
            if ($eType == "Multi-Delivery") {
                sendTripReceipt_Multi($iTripId);
            } else {
                sendTripReceipt($iTripId);
            }
        } else {
            if ($eType == "Multi-Delivery") {
                sendTripReceiptAdmin_Multi($iTripId);
            } else {
                sendTripReceiptAdmin($iTripId);
            }
        }
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "GenerateTrip") {
    $passenger_id = isset($_REQUEST["PassengerID"]) ? $_REQUEST["PassengerID"] : '';
    $driver_id = isset($_REQUEST["DriverID"]) ? $_REQUEST["DriverID"] : '';
    $iCabRequestId = isset($_REQUEST["iCabRequestId"]) ? $_REQUEST["iCabRequestId"] : '';
    $Source_point_latitude = isset($_REQUEST["start_lat"]) ? $_REQUEST["start_lat"] : '';
    $Source_point_longitude = isset($_REQUEST["start_lon"]) ? $_REQUEST["start_lon"] : '';
    $Source_point_Address = isset($_REQUEST["sAddress"]) ? $_REQUEST["sAddress"] : '';
    $GoogleServerKey = isset($_REQUEST["GoogleServerKey"]) ? $_REQUEST["GoogleServerKey"] : '';
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : '';
    $vMsgCode = isset($_REQUEST["vMsgCode"]) ? $_REQUEST["vMsgCode"] : '';
    $setCron = isset($_REQUEST["setCron"]) ? $_REQUEST["setCron"] : 'No';
    $ride_type = isset($_REQUEST["ride_type"]) ? $_REQUEST["ride_type"] : '';
    $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
    $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
    $REQUEST_TYPE = isset($_REQUEST["REQUEST_TYPE"]) ? $_REQUEST["REQUEST_TYPE"] : '';
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations","APP_TYPE");
    if ($ride_type == '' && isset($iCabBookingId) && !empty($iCabBookingId)) {
        $cabBookingData = get_value('cab_booking', 'eType', 'iCabBookingId', $iCabBookingId);
        $ride_type = $cabBookingData[0]['eType'];
    }
    ####### blocking code ################
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $BlockData = getBlockData("Driver", $driver_id);
        if (!empty($BlockData) || $BlockData != "") {
            setDataResponse($BlockData);
        }
    }
    ####### blocking code ################
    // if ($ride_type != "Multi-Delivery" && $ride_type != "UberX" && $driver_id > 0) {
        if ($MODULES_OBJ->isSendRequestToDriverBeforFinishTripModule() && $REQUEST_TYPE == "Ride") {
            $sqldata = "SELECT iTripId,ePoolRide,eType,tSaddress,tDaddress FROM `trips` WHERE ( iActive='Active' OR iActive='Inactive' ) AND iDriverId='" . $driver_id . "' AND ePoolRide='No'";
            $TripData = $obj->MySQLSelect($sqldata);
        } else {
            $sqldata = "SELECT iTripId,ePoolRide,eType,tSaddress,tDaddress FROM `trips` WHERE ( iActive='On Going Trip' OR iActive='Active' ) AND iDriverId='" . $driver_id . "' AND ePoolRide='No'";
            $TripData = $obj->MySQLSelect($sqldata);
        }
        if (count($TripData) > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_DRIVER_NOT_ACCEPT_TRIP";
            setDataResponse($returnArr);
        }
    // }
    #### Update Driver Request Status of Trip ####
    UpdateDriverRequest2($driver_id, $passenger_id, $iTripId, "", $vMsgCode, "Yes");
    #### Update Driver Request Status of Trip ####
    /* For DriverSubscription added by SP start */
    if ($MODULES_OBJ->isDriverSubscriptionModuleAvailable()) {
        $returnSubStatus = 0;
        $returnSubStatus = checkDriverSubscribed($driver_id);
        if ($returnSubStatus == 1) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_PENDING_MIXSUBSCRIPTION";
            setDataResponse($returnArr);
        } else if ($returnSubStatus == 2) {
            $returnArr['Action'] = "0";
            //$returnArr['message'] = "PENDING_SUBSCRIPTION";
            $returnArr['message'] = "LBL_PENDING_SUBSCRIPTION_TEXT";
            setDataResponse($returnArr);
        }
    }
    /*     * ******* Create Service Lock ********* */
    $isServiceLock = checkServiceLock($iCabRequestId, $iCabBookingId, false, false, $driver_id);
    if ($isServiceLock) {
        if (empty($REQUEST_TYPE)) {
            if (!empty($iCabRequestId)) {
                $sql_RequestData = "SELECT eType FROM cab_request_now WHERE iUserId='$passenger_id' and iCabRequestId = '$iCabRequestId'";
                $cabRequestData = $obj->MySQLSelect($sql_RequestData);
                if (!empty($cabRequestData) && count($cabRequestData) > 0) {
                    $REQUEST_TYPE = $cabRequestData[0]['eType'];
                }
            } else if (!empty($iCabBookingId)) {
                $cabBookingData = get_value('cab_booking', 'eType', 'iCabBookingId', $iCabBookingId);
                if (!empty($cabBookingData) && count($cabBookingData) > 0) {
                    $REQUEST_TYPE = $cabBookingData[0]['eType'];
                }
            }
        }
        $returnArr['Action'] = "0";
        $returnArr['message'] = empty($REQUEST_TYPE) ? "LBL_DRIVER_NOT_ACCEPT_TRIP" : ($REQUEST_TYPE == "Ride" ? "LBL_FAIL_ASSIGN_TO_PASSENGER_TXT" : ($REQUEST_TYPE == "Deliver" || $REQUEST_TYPE == "Delivery") ? "LBL_FAIL_ASSIGN_TO_PASSENGER_DELIVERY_TXT" : "LBL_FAIL_ASSIGN_TO_PASSENGER_UFX_TXT");
        setDataResponse($returnArr);
    }
    /*     * ******* Create Service Lock ********* */
    $eType_cabbooking = "";
    $vDriverLangCode = "EN";
    //Added By HJ On 01-07-2020 For Optimize register_driver Table Query Start
    if (isset($userDetailsArr['register_driver_' . $driver_id])) {
        $driver_data = $userDetailsArr['register_driver_' . $driver_id];
    } else {
        $driver_data = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId = '" . $driver_id . "'");
        $userDetailsArr['register_driver_' . $driver_id] = $driver_data;
    }
    $vDriverLangCode = $driver_data[0]['vLang'];
    //Added By HJ On 01-07-2020 For Optimize register_driver Table Query End
    //$vDriverLangCode = get_value('register_driver', 'vLang', 'iDriverId', $driver_id, '', 'true');
    //Added By HJ On 02-07-2020 For Optimize language_label Table Query Start
    $langLabelData = $obj->MySQLSelect("SELECT vValue,vLabel FROM language_label WHERE vCode='" . $vDriverLangCode . "' AND vLabel IN ('LBL_MINUTES_TXT','LBL_HOURS_TXT','LBL_RIDE_LATER_START_VALIDATION_TXT','LBL_MANAUL_BOOKING_CANCELLED_MSG')");
    $langLabelArr = array();
    for ($h = 0; $h < count($langLabelData); $h++) {
        $langLabelArr[$langLabelData[$h]['vLabel']] = $langLabelData[$h]['vValue'];
    }
    if ($iCabBookingId != "") {
        $bookingData = get_value('cab_booking', 'iUserId,vSourceLatitude,vSourceLongitude,vSourceAddresss,eType,dBooking_date,eStatus,ePayType', 'iCabBookingId', $iCabBookingId);
        $passenger_id = $bookingData[0]['iUserId'];
        $Source_point_latitude = $bookingData[0]['vSourceLatitude'];
        $Source_point_longitude = $bookingData[0]['vSourceLongitude'];
        $Source_point_Address = $bookingData[0]['vSourceAddresss'];
        $eType_cabbooking = $bookingData[0]['eType'];
        ## Check Timing For Later Booking ##
        $additional_mins = $BOOKING_LATER_ACCEPT_BEFORE_INTERVAL;
        $additional_mins_into_secs = $additional_mins * 60;
        $dBooking_date = $bookingData[0]['dBooking_date'];
        $currDate = date('Y-m-d H:i:s');
        //$currDate = date("Y-m-d H:i:s", strtotime($currDate . "-".$additional_mins." minutes"));
        $datediff = abs(strtotime($dBooking_date) - strtotime($currDate));
        $eStatusnew = $bookingData[0]['eStatus'];
        if ($datediff > $additional_mins_into_secs) {
            if (isset($langLabelArr['LBL_MINUTES_TXT'])) {
                $mins = $langLabelArr['LBL_MINUTES_TXT'];
            } else {
                $mins = get_value('language_label', 'vValue', 'vLabel', 'LBL_MINUTES_TXT', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            if (isset($langLabelArr['LBL_HOURS_TXT'])) {
                $hrs = $langLabelArr['LBL_HOURS_TXT'];
            } else {
                $hrs = get_value('language_label', 'vValue', 'vLabel', 'LBL_HOURS_TXT', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            if (isset($langLabelArr['LBL_RIDE_LATER_START_VALIDATION_TXT'])) {
                $LBL_RIDE_LATER_START_VALIDATION_TXT = $langLabelArr['LBL_RIDE_LATER_START_VALIDATION_TXT'];
            } else {
                $LBL_RIDE_LATER_START_VALIDATION_TXT = get_value('language_label', 'vValue', 'vLabel', 'LBL_RIDE_LATER_START_VALIDATION_TXT', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            //Added By HJ On 02-07-2020 For Optimize language_label Table Query End
            if ($additional_mins <= 60) {
                $beforetext = $additional_mins . " " . $mins;
                $message = str_replace('####', $beforetext, $LBL_RIDE_LATER_START_VALIDATION_TXT);
            } else if ($eStatusnew == 'Cancel') {
                if (isset($langLabelArr['LBL_MANAUL_BOOKING_CANCELLED_MSG'])) {
                    $LBL_MANAUL_BOOKING_CANCELLED_MSG = $langLabelArr['LBL_MANAUL_BOOKING_CANCELLED_MSG'];
                } else {
                    $LBL_MANAUL_BOOKING_CANCELLED_MSG = get_value('language_label', 'vValue', 'vLabel', 'LBL_MANAUL_BOOKING_CANCELLED_MSG', " and vCode='" . $vDriverLangCode . "'", 'true');
                }
                $message = $LBL_MANAUL_BOOKING_CANCELLED_MSG;
                $returnArr['DO_RELOAD'] = "Yes";
            } else {
                $hours = floor($additional_mins / 60);
                $beforetext = $hours . " " . $hrs;
                $message = str_replace('####', $beforetext, $LBL_RIDE_LATER_START_VALIDATION_TXT);
            }
            //Added BY HJ On 20-01-2020 For Removed Lock File For UFX Request Start
            $serviceId = empty($iCabRequestId) ? $iCabBookingId : $iCabRequestId;
            $fileName = $isDeliverAll == true ? "Order_" . $iCabRequestId : (empty($iCabRequestId) ? "CabBooking_" . $iCabBookingId : "CabRequest_" . $iCabRequestId);
            /*added 26-05-2020*/
            $fileName .= "_" . $_SERVER['HTTP_HOST'];
            $file_name = md5($fileName) . ".txt";
            unlink($tconfig['tpanel_path'] . "webimages/lockFile/" . $file_name);
            //Added BY HJ On 20-01-2020 For Removed Lock File For UFX Request End
            $returnArr['Action'] = "0";
            $returnArr['message'] = $message;
            setDataResponse($returnArr);
        }
        ## Check Timing For Later Booking ##
        //added by SP for checking wallet balance in uberx when driver accept request of user of book later start
        $ePayType_cabbooking = $bookingData[0]['ePayType'];
        //$Data1['ACCEPT_CASH_TRIPS'] = "Yes";
        $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision("Ride"); // Added By HJ On 16-10-2020 For get Auto Deduct Driver Commision Configuration As Per eSystem
        if ($enableCommisionDeduct == 'Yes') {
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($driver_id, "Driver");
            if ($WALLET_MIN_BALANCE > $user_available_balance) {
                //$Data1['ACCEPT_CASH_TRIPS'] = "No";
                //Added BY HJ On 23-09-2019 As Per Discuss with BM and GP Mam Start
                if ($ePayType_cabbooking == "Cash" && $eType_cabbooking == "UberX") {
                    $returnArr = array();
                    $returnArr['Action'] = "0"; // code is invalid
                    $returnArr["message"] = "LBL_CHECK_PROVIDER_MIN_WALLET_BALANCE_TXT";
                    echo json_encode($returnArr);
                    exit;
                }
                //Added BY HJ On 23-09-2019 As Per Discuss with BM and GP Mam End
            }
        }
        //added by SP for checking wallet balance in uberx when driver accept request of user of book later end
    }
    $DriverMessage = "CabRequestAccepted";
    //$TripRideNO = rand(10000000, 99999999);
    $TripRideNO = GenerateUniqueTripNo();
    $TripVerificationCode = generateCommonRandom();
    $Active = "Active";
    if ($MODULES_OBJ->isSendRequestToDriverBeforFinishTripModule() && $REQUEST_TYPE == "Ride") {
        $sql_data = "SELECT iTripId,ePoolRide,eType,tSaddress,tDaddress FROM `trips` WHERE ( iActive='On Going Trip' ) AND iDriverId='" . $driver_id . "' AND ePoolRide='No'";
        $checkongoingTripData = $obj->MySQLSelect($sql_data);
        if (count($checkongoingTripData) > 0) {
            $Active = "Inactive";
        }
    }
    //Added By HJ On 01-07-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr['register_user_' . $passenger_id])) {
        $user_data = $userDetailsArr['register_user_' . $passenger_id];
    } else {
        $user_data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId = '" . $passenger_id . "'");
        $userDetailsArr['register_user_' . $passenger_id] = $user_data;
    }
    $vLangCode = $user_data[0]['vLang'];
    //Added By HJ On 01-07-2020 For Optimize register_user Table Query End
    //Added By HJ On 01-07-2020 For Optimize country table Query Start
    if (isset($country_data_arr[$user_data[0]['vCountry']])) {
        $passangerPhoneCode = $country_data_arr[$user_data[0]['vCountry']]['vPhoneCode'];
    } else {
        $sqlCodeData = $obj->MySQLSelect("SELECT vPhoneCode FROM country WHERE vCountryCode='" . $user_data[0]['vCountry'] . "'");
        $passangerPhoneCode = $sqlCodeData[0]['vPhoneCode'];
    }
    $user_data[0]['vPhoneCode'] = $passangerPhoneCode;
    //Added By HJ On 01-07-2020 For Optimize country table Query End
    //$vLangCode = get_value('register_user', 'vLang', 'iUserId', $passenger_id, '', 'true');
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 01-07-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 01-07-2020 For Optimize language_master Table Query End
    }
    //Added By HJ On 01-07-2020 For Optimize language_master Table Query Start
    if (isset($languageAssociateArr[$vLangCode])) {
        $vGMapLangCode = $languageAssociateArr[$vLangCode]['vGMapLangCode'];
    } else {
        $vGMapLangCode = get_value('language_master', 'vGMapLangCode', 'vCode', $vLangCode, '', 'true');
    }
    //Added By HJ On 01-07-2020 For Optimize language_master Table Query End
    $languageLabelsArr = $langLabels = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $tripdriverarrivlbl = $languageLabelsArr['LBL_DRIVER_ARRIVING'];
    $reqestId = $vBookSomeOneName = $vBookSomeOneNumber = "";
    $outstandingId = $iCabRequestId;
    $trip_status_chkField = "iCabRequestId";
    /* added for rental */
    $ePoolRide = $eBookForSomeOneElse = "No";
    $iPersonSize = $poolParentId = 0;
    if ($iCabRequestId != "") {
        $sql = "SELECT eStatus, ePayType, iVehicleTypeId, iCabBookingId, vSourceLatitude, vSourceLongitude, tSourceAddress, vDestLatitude, vDestLongitude, tDestAddress, iRentalPackageId, vCouponCode, eType, iPackageTypeId, vReceiverName, vReceiverMobile, tPickUpIns, tDeliveryIns, tPackageDetails, fPickUpPrice, fNightPrice, iQty, vRideCountry, fTollPrice, vTollPriceCurrencyCode,eTollSkipped,vTimeZone,iUserAddressId,tUserComment,eFlatTrip,fFlatTripPrice,eWalletDebitAllow,eBookingFrom,iHotelId,iFare,iBaseFare,fPricePerMin,fPricePerKM,fCommision,fSurgePriceDiff,fTax1,fTax2,fTax1Percentage,fTax2Percentage,fOutStandingAmount,fDistance,fDuration,iOrganizationId,iUserProfileId,ePaymentBy,ePaymentByReceiver,fMinFareDiff,fTripGenerateFare,fDiscount,vDiscount,fWalletDebit,iTripReasonId,vReasonTitle,eTripReason,ePayWallet,eServiceLocation,tVehicleTypeData,tVehicleTypeFareData, tTotalDuration, tTotalDistance, tEstimatedCharge, tUserWalletBalance, iFromStationId, iToStationId,vBookSomeOneNumber,eBookForSomeOneElse,vBookSomeOneName,iUserId,fRoundingAmount,eRoundingType,iPaymentInfoId,isVideoCall FROM cab_request_now WHERE iUserId='$passenger_id' and iCabRequestId = '$iCabRequestId'"; //added by SP for fly stations on 19-08-2019
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            reDefineGenerateTripQuery();
        }
        $check_row = $obj->MySQLSelect($sql);
        if (count($check_row) > 0) {
            $eStatus = $check_row[0]['eStatus'];
            $eType = $check_row[0]['eType'];
            if ($eType_cabbooking != "") {
                $eType = $eType_cabbooking;
            }
            $reqestId = $iCabRequestId;
            $trip_status_chkField = "iCabRequestId";
        }
    } else {
        $cab_data = $obj->MySQLSelect("select eStatus,eType from cab_booking where iCabBookingId = '$iCabBookingId'");
        $eStatus = $cab_data[0]['eStatus'];
        $eType = $cab_data[0]['eType'];
        $reqestId = $outstandingId = $iCabBookingId;
        $trip_status_chkField = "iCabBookingId";
    }
    if ($eType == "Ride") {
        $requestcancelbyuser = "LBL_CAR_REQUEST_CANCELLED_TXT";
        $failassigntopassenger = "LBL_FAIL_ASSIGN_TO_PASSENGER_TXT";
        $useronanothertrip = "LBL_USER_ON_ANOTHER_TRIP";
    } else if ($eType == "Deliver" || $eType == "Multi-Delivery") {
        $requestcancelbyuser = "LBL_CAR_REQUEST_CANCELLED_DELIVERY_TXT";
        $failassigntopassenger = "LBL_FAIL_ASSIGN_TO_PASSENGER_DELIVERY_TXT";
        $useronanothertrip = "LBL_USER_ON_ANOTHER_TRIP";
    } else {
        $requestcancelbyuser = "LBL_CAR_REQUEST_CANCELLED_UFX_TXT";
        $failassigntopassenger = "LBL_FAIL_ASSIGN_TO_PASSENGER_UFX_TXT";
        $useronanothertrip = "LBL_USER_ON_ANOTHER_TRIP";
    }

    if ($eStatus == "Completed") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = $failassigntopassenger;
        setDataResponse($returnArr);
    } else {
        if ($APP_TYPE != "UberX") {
            //Added By HJ On 01-07-2020 For Optimize register_user Table Query Start
            if (isset($userDetailsArr['register_user_' . $passenger_id])) {
                $user_data = $userDetailsArr['register_user_' . $passenger_id];
            } else {
                $user_data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId = '" . $passenger_id . "'");
                $userDetailsArr['register_user_' . $passenger_id] = $user_data;
            }
            //Added By HJ On 01-07-2020 For Optimize register_user Table Query End
            //$sql = "select iTripId,vTripStatus from register_user where iUserId='$passenger_id'";
            //$user_data = $obj->MySQLSelect($sql);
            $iTripId = $user_data[0]['iTripId'];
            if ($iTripId != "" && $iTripId != 0) {
                if (isset($tripDetailsArr['trips_' . $iTripId])) {
                    $userTripData = $tripDetailsArr['trips_' . $iTripId];
                } else {
                    $userTripData = $obj->MySQLSelect("SELECT * FROM `trips` WHERE iTripId = '" . $iTripId . "'");
                    $tripDetailsArr['trips_' . $iTripId] = $userTripData;
                }
                $status_trip = $userTripData[0]['iActive'];
                $trip_etype = $userTripData[0]['eType'];
                $iOrderId_chk_ext = $userTripData[0]['iOrderId'];
                $cab_id = $userTripData[0][$trip_status_chkField];
                //$status_trip = get_value("trips", 'iActive', "iTripId", $iTripId, '', 'true');
                //$trip_etype = get_value("trips", 'eType', "iTripId", $iTripId, '', 'true');
                //$cab_id = get_value("trips", $trip_status_chkField, "iTripId", $iTripId, '', 'true');
                //$iOrderId_chk_ext = get_value("trips", 'iOrderId', "iTripId", $iTripId, '', 'true');
                // added for multiple trips (deliverall)
                if (($status_trip == "Active" || $status_trip == "On Going Trip") && ($trip_etype != "UberX" && $trip_etype != "Multi-Delivery") && $ride_type != "Multi-Delivery" && $iOrderId_chk_ext == 0 /* && DELIVERALL == "No" */) {
                    if ($reqestId == $cab_id) {
                        $returnArr['Action'] = "0";
                        $returnArr['message'] = $failassigntopassenger;
                        setDataResponse($returnArr);
                    } else {
                        $returnArr['Action'] = "0";
                        $returnArr['message'] = $useronanothertrip;
                        setDataResponse($returnArr);
                    }
                }
            }
        }
    }

    if ($eStatus == "Requesting" || (($eStatus == "Assign" || $eStatus == "Accepted") && $iCabBookingId != "" && $iCabRequestId == "")) {
        if ($iCabRequestId != "") {
            $where = " iCabRequestId = '$iCabRequestId'";
            $Data_update_cab_request['eStatus'] = 'Complete';
            $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_request, 'update', $where);
        }
        //Added By HJ On 01-07-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $passenger_id])) {
            $Data_passenger_detail = $userDetailsArr['register_user_' . $passenger_id];
        } else {
            $Data_passenger_detail = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId = '" . $passenger_id . "'");
            $userDetailsArr['register_user_' . $passenger_id] = $Data_passenger_detail;
        }
        //Added By HJ On 01-07-2020 For Optimize register_user Table Query End
        //$sql = "SELECT vCurrencyPassenger,iAppVersion,iUserPetId,CONCAT(vName,' ',vLastName) AS bookerName FROM `register_user` WHERE iUserId = '$passenger_id'";
        //$Data_passenger_detail = $obj->MySQLSelect($sql);
        //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019
        //$sqlCodeData = $obj->MySQLSelect("SELECT c.vPhoneCode FROM  `register_user` AS r,  `country` AS c WHERE r.iUserId = $passenger_id AND r.vCountry = c.vCountryCode");
        $Data_passenger_detail[0]['vPhoneCode'] = $passangerPhoneCode;
        $Data_passenger_detail[0]['bookerName'] = $Data_passenger_detail[0]['vName'] . " " . $Data_passenger_detail[0]['vLastName'];
        //Added By HJ On 01-07-2020 For Optimize register_driver Table Query Start
        if (isset($userDetailsArr['register_driver_' . $driver_id])) {
            $Data_vehicle = $userDetailsArr['register_driver_' . $driver_id];
        } else {
            $Data_vehicle = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId = '" . $driver_id . "'");
            $userDetailsArr['register_driver_' . $driver_id] = $Data_vehicle;
        }
        //Added By HJ On 01-07-2020 For Optimize register_driver Table Query End
        $CAR_id_driver = $Data_vehicle[0]['iDriverVehicleId'];
        if ($APP_TYPE == "Ride-Delivery-UberX" && $eType == "UberX") {
            $Data_vehicle_uberx = $obj->MySQLSelect("SELECT iDriverVehicleId FROM `driver_vehicle` WHERE iDriverId = '" . $driver_id . "' AND eType = 'UberX'");
            $CAR_id_driver = $Data_vehicle_uberx[0]['iDriverVehicleId'];
        }
        // Changed for rental
        // add for hotel web
        if ($iCabBookingId != "") {
            $sql_booking = "SELECT vSourceLatitude,vSourceLongitude,vSourceAddresss,vDestLatitude,vDestLongitude,tDestAddress,ePayType,iVehicleTypeId,iRentalPackageId,eType,iPackageTypeId,vReceiverName,vReceiverMobile,tPickUpIns,tDeliveryIns,tPackageDetails,fPickUpPrice,fNightPrice,iUserPetId,vCouponCode,iQty,vRideCountry,fTollPrice,vTollPriceCurrencyCode,eTollSkipped, vTimeZone,iUserAddressId,tUserComment,eFlatTrip,fFlatTripPrice,eWalletDebitAllow,eBookingFrom,iHotelBookingId,iFare,iBaseFare,fPricePerMin,fPricePerKM,fCommision,fSurgePriceDiff,fTax1,fTax2,fTax1Percentage,fTax2Percentage,fOutStandingAmount,vDistance, vDuration, iUserProfileId, iOrganizationId, ePaymentBy, ePaymentByReceiver, fMinFareDiff, fTripGenerateFare, fDiscount, vDiscount, fWalletDebit, iTripReasonId, vReasonTitle, eTripReason, ePayWallet, eServiceLocation, tVehicleTypeData, tVehicleTypeFareData, vWorkLocation, vWorkLocationLatitude, vWorkLocationLongitude, eSelectWorkLocation, tTotalDuration, tTotalDistance, tEstimatedCharge, tUserWalletBalance, iFromStationId, iToStationId,vBookSomeOneNumber,eBookForSomeOneElse,vBookSomeOneName,iUserId,iPaymentInfoId,isVideoCall FROM cab_booking WHERE iCabBookingId='$iCabBookingId'"; //added by SP for fly stations on 19-08-2019
            if (strtoupper(PACKAGE_TYPE) == "SHARK") {
                reDefineGenerateTripQuery();
            }
            $data_booking = $obj->MySQLSelect($sql_booking);
            $bokingData = $data_booking; //Added By HJ On 22-03-2019 For Get Data OF Trip
            $iSelectedCarType = $data_booking[0]['iVehicleTypeId'];
            $iRentalPackageId = $data_booking[0]['iRentalPackageId'];
            $vTripPaymentMode = $data_booking[0]['ePayType'];
            $tDestinationLatitude = $data_booking[0]['vDestLatitude'];
            $tDestinationLongitude = $data_booking[0]['vDestLongitude'];
            $tDestinationAddress = $data_booking[0]['tDestAddress'];
            $fPickUpPrice = $data_booking[0]['fPickUpPrice'];
            $fNightPrice = $data_booking[0]['fNightPrice'];
            $Source_point_latitude = $data_booking[0]['vSourceLatitude'];
            $Source_point_longitude = $data_booking[0]['vSourceLongitude'];
            $Source_point_Address = $data_booking[0]['vSourceAddresss'];
            $eType = $data_booking[0]['eType'];
            $iPackageTypeId = $data_booking[0]['iPackageTypeId'];
            $vReceiverName = $data_booking[0]['vReceiverName'];
            $vReceiverMobile = $data_booking[0]['vReceiverMobile'];
            $tPickUpIns = $data_booking[0]['tPickUpIns'];
            $tDeliveryIns = $data_booking[0]['tDeliveryIns'];
            $tPackageDetails = $data_booking[0]['tPackageDetails'];
            $iUserPetId = $data_booking[0]['iUserPetId'];
            $vCouponCode = $data_booking[0]['vCouponCode'];
            $iQty = $data_booking[0]['iQty'];
            $vRideCountry = $data_booking[0]['vRideCountry'];
            $fTollPrice = $data_booking[0]['fTollPrice'];
            $vTollPriceCurrencyCode = $data_booking[0]['vTollPriceCurrencyCode'];
            $eTollSkipped = $data_booking[0]['eTollSkipped'];
            $vTimeZone = $data_booking[0]['vTimeZone'];
            $iUserAddressId = $data_booking[0]['iUserAddressId'];
            $tUserComment = $data_booking[0]['tUserComment'];
            $eFlatTrip = $data_booking[0]['eFlatTrip'];
            $fFlatTripPrice = $data_booking[0]['fFlatTripPrice'];
            #######to use in multidelivery#######
            $fTripGenerateFare = $data_booking[0]['fTripGenerateFare'];
            $iFare = $data_booking[0]['iFare'];
            $eWalletDebitAllow = $data_booking[0]['eWalletDebitAllow'];
            // add for hotel web
            $eBookingFrom = $data_booking[0]['eBookingFrom'];
            $iHotelId = $data_booking[0]['iHotelBookingId'];
            $iBaseFare = $data_booking[0]['iBaseFare'];
            $fPricePerMin = $data_booking[0]['fPricePerMin'];
            $fPricePerKM = $data_booking[0]['fPricePerKM'];
            $fCommision = $data_booking[0]['fCommision'];
            $fSurgePriceDiff = $data_booking[0]['fSurgePriceDiff'];
            $fTax1 = $data_booking[0]['fTax1'];
            $fTax2 = $data_booking[0]['fTax2'];
            $fTax1Percentage = $data_booking[0]['fTax1Percentage'];
            $fTax2Percentage = $data_booking[0]['fTax2Percentage'];
            $fOutStandingAmount = $data_booking[0]['fOutStandingAmount'];
            $fDiscount = $data_booking[0]['fDiscount'];
            $vDiscount = $data_booking[0]['vDiscount'];
            $fDistance = $data_booking[0]['vDistance'];
            $fDuration = $data_booking[0]['vDuration'];
            $fMinFareDiff = $data_booking[0]['fMinFareDiff'];
            $iUserProfileId = $data_booking[0]['iUserProfileId'];
            $iOrganizationId = $data_booking[0]['iOrganizationId'];
            $ePaymentBy = $data_booking[0]['ePaymentBy'];
            $ePaymentByReceiver = $data_booking[0]['ePaymentByReceiver'];
            $fWalletDebit = $data_booking[0]['fWalletDebit'];
            $iTripReasonId = $data_booking[0]['iTripReasonId'];
            $vReasonTitle = $data_booking[0]['vReasonTitle'];
            $eTripReason = $data_booking[0]['eTripReason'];
            #######to use in multidelivery#######
            // Related to New Service Provider Flow
            $vWorkLocation = $data_booking[0]['vWorkLocation'];
            $vWorkLocationLatitude = $data_booking[0]['vWorkLocationLatitude'];
            $vWorkLocationLongitude = $data_booking[0]['vWorkLocationLongitude'];
            $eSelectWorkLocation = $data_booking[0]['eSelectWorkLocation'];
            // payment method 2
            $ePayWallet = $data_booking[0]['ePayWallet'];
            $tTotalDuration = $data_booking[0]['tTotalDuration'];
            $tTotalDistance = $data_booking[0]['tTotalDistance'];
            $tEstimatedCharge = $data_booking[0]['tEstimatedCharge'];
            $tUserWalletBalance = $data_booking[0]['tUserWalletBalance'];
            //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
            $tVehicleTypeData = $data_booking[0]['tVehicleTypeData'];
            $tVehicleTypeFareData = $data_booking[0]['tVehicleTypeFareData'];
            $eServiceLocation = $data_booking[0]['eServiceLocation'];
            //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
            //added by SP for fly stations on 19-08-2019 start
            $iFromStationId = $data_booking[0]['iFromStationId'];
            $iToStationId = $data_booking[0]['iToStationId'];
            //added by SP for fly stations on 19-08-2019 end
            //$fRoundingAmount = $data_booking[0]['fRoundingAmount'];
            //$eRoundingType = $data_booking[0]['eRoundingType'];
            $eBookForSomeOneElse = $data_booking[0]['eBookForSomeOneElse'];
            $vBookSomeOneName = $data_booking[0]['vBookSomeOneName'];
            $vBookSomeOneNumber = $data_booking[0]['vBookSomeOneNumber'];
            $iPaymentInfoId = $data_booking[0]['iPaymentInfoId'];
            $isVideoCall = $data_booking[0]['isVideoCall'];
        } else {
            $bokingData = $check_row; //Added By HJ On 22-03-2019 For Get Data OF Trip
            $iSelectedCarType = $check_row[0]['iVehicleTypeId'];
            $iRentalPackageId = $check_row[0]['iRentalPackageId'];
            $vTripPaymentMode = $check_row[0]['ePayType'];
            $tDestinationLatitude = $check_row[0]['vDestLatitude'];
            $tDestinationLongitude = $check_row[0]['vDestLongitude'];
            $tDestinationAddress = $check_row[0]['tDestAddress'];
            $fPickUpPrice = $check_row[0]['fPickUpPrice'];
            $fNightPrice = $check_row[0]['fNightPrice'];
            $Source_point_latitude = $check_row[0]['vSourceLatitude'];
            $Source_point_longitude = $check_row[0]['vSourceLongitude'];
            $Source_point_Address = $check_row[0]['tSourceAddress'];
            $eType = $check_row[0]['eType'];
            $iPackageTypeId = $check_row[0]['iPackageTypeId'];
            $vReceiverName = $check_row[0]['vReceiverName'];
            $vReceiverMobile = $check_row[0]['vReceiverMobile'];
            $tPickUpIns = $check_row[0]['tPickUpIns'];
            $tDeliveryIns = $check_row[0]['tDeliveryIns'];
            $tPackageDetails = $check_row[0]['tPackageDetails'];
            $iUserPetId = $Data_passenger_detail[0]['iUserPetId'];
            $vCouponCode = $check_row[0]['vCouponCode'];
            $iQty = $check_row[0]['iQty'];
            $eFlatTrip = $check_row[0]['eFlatTrip'];
            $fFlatTripPrice = $check_row[0]['fFlatTripPrice'];
            $vRideCountry = $check_row[0]['vRideCountry'];
            $fTollPrice = $check_row[0]['fTollPrice'];
            $vTollPriceCurrencyCode = $check_row[0]['vTollPriceCurrencyCode'];
            $eTollSkipped = $check_row[0]['eTollSkipped'];
            $vTimeZone = $check_row[0]['vTimeZone'];
            $iUserAddressId = $check_row[0]['iUserAddressId'];
            $tUserComment = $check_row[0]['tUserComment'];
            $iCabBookingId = $check_row[0]['iCabBookingId'];
            #######to use in multidelivery#######
            $fTripGenerateFare = $check_row[0]['fTripGenerateFare'];
            $iFare = $check_row[0]['iFare'];
            $eWalletDebitAllow = $check_row[0]['eWalletDebitAllow'];
            //  add for hotel web
            $eBookingFrom = $check_row[0]['eBookingFrom'];
            $iHotelId = $check_row[0]['iHotelId'];
            $iBaseFare = $check_row[0]['iBaseFare'];
            $fPricePerMin = $check_row[0]['fPricePerMin'];
            $fPricePerKM = $check_row[0]['fPricePerKM'];
            $fCommision = $check_row[0]['fCommision'];
            $fSurgePriceDiff = $check_row[0]['fSurgePriceDiff'];
            $fTax1 = $check_row[0]['fTax1'];
            $fTax2 = $check_row[0]['fTax2'];
            $fTax1Percentage = $check_row[0]['fTax1Percentage'];
            $fTax2Percentage = $check_row[0]['fTax2Percentage'];
            //$fOutStandingAmount = $check_row[0]['fOutStandingAmount'];
            $fOutStandingAmount = GetPassengerOutstandingAmount($passenger_id);
            $fDiscount = $check_row[0]['fDiscount'];
            $vDiscount = $check_row[0]['vDiscount'];
            $fDistance = $check_row[0]['fDistance'];
            $fDuration = $check_row[0]['fDuration'];
            $fMinFareDiff = $check_row[0]['fMinFareDiff'];
            $iUserProfileId = $check_row[0]['iUserProfileId'];
            $iOrganizationId = $check_row[0]['iOrganizationId'];
            $ePaymentBy = $check_row[0]['ePaymentBy'];
            $ePaymentByReceiver = $check_row[0]['ePaymentByReceiver'];
            $fWalletDebit = $check_row[0]['fWalletDebit'];
            $iTripReasonId = $check_row[0]['iTripReasonId'];
            $vReasonTitle = $check_row[0]['vReasonTitle'];
            $eTripReason = $check_row[0]['eTripReason'];
            #######to use in multidelivery#######
            // payment method 2
            $ePayWallet = $check_row[0]['ePayWallet'];
            $tTotalDuration = $check_row[0]['tTotalDuration'];
            $tTotalDistance = $check_row[0]['tTotalDistance'];
            $tEstimatedCharge = $check_row[0]['tEstimatedCharge'];
            $tUserWalletBalance = $check_row[0]['tUserWalletBalance'];
            //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
            $tVehicleTypeData = $check_row[0]['tVehicleTypeData'];
            $tVehicleTypeFareData = $check_row[0]['tVehicleTypeFareData'];
            $eServiceLocation = $check_row[0]['eServiceLocation'];
            //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
            //added by SP for fly stations on 19-08-2019 start
            $iFromStationId = $check_row[0]['iFromStationId'];
            $iToStationId = $check_row[0]['iToStationId'];
            //added by SP for fly stations on 19-08-2019 end
            //added by SP for rounding off for multi delivery on 7-11-2019
            $fRoundingAmount = $check_row[0]['fRoundingAmount'];
            $eRoundingType = $check_row[0]['eRoundingType'];
            $eBookForSomeOneElse = $check_row[0]['eBookForSomeOneElse'];
            $vBookSomeOneName = $check_row[0]['vBookSomeOneName'];
            $vBookSomeOneNumber = $check_row[0]['vBookSomeOneNumber'];
            $iPaymentInfoId = $check_row[0]['iPaymentInfoId'];
            $isVideoCall = $check_row[0]['isVideoCall'];
        }
        $Data_trips['vRideNo'] = $TripRideNO;
        $Data_trips['iUserId'] = $passenger_id;
        $Data_trips['iDriverId'] = $driver_id;
        $Data_trips['tTripRequestDate'] = @date("Y-m-d H:i:s");
        $Data_trips['tStartLat'] = $Source_point_latitude;
        $Data_trips['tStartLong'] = $Source_point_longitude;
        $Data_trips['tSaddress'] = $Source_point_Address;
        $Data_trips['iActive'] = $Active;
        $Data_trips['iDriverVehicleId'] = $CAR_id_driver;
        $Data_trips['iVerificationCode'] = $TripVerificationCode;
        $Data_trips['iVehicleTypeId'] = $iSelectedCarType;
        $Data_trips['iRentalPackageId'] = $iRentalPackageId;
        $Data_trips['tUserWalletBalance'] = $tUserWalletBalance;
        $Data_trips['iPaymentInfoId'] = $iPaymentInfoId;
        $Data_trips['isVideoCall'] = $isVideoCall;
        //added by SP for fly stations on 19-08-2019 start
        //if($iFromStationId!='' && $iToStationId!='' && $iFromStationId!=0 && $iToStationId!=0) {
        if (!empty($iFromStationId) && !empty($iToStationId)) {
            $Data_trips['iActive'] = 'Arrived';
            //$where_fly = " iDriverId = '".$driver_id."'";
            //$Data_update_driver_fly['vTripStatus'] = 'Arrived';
            //$obj->MySQLQueryPerform("register_driver", $Data_update_driver_fly, 'update', $where_fly);
        }
        $Data_trips['iFromStationId'] = $iFromStationId;
        $Data_trips['iToStationId'] = $iToStationId;
        //added by SP for fly stations on 19-08-2019 end
        $tVehicleTypeDataCnt = $VehicleData = array();
        $eIconType = "Car";
        $vLogo = "";
        if ($iSelectedCarType > 0) {
            //$VehicleData = get_value('vehicle_type', 'eFareType,fVisitFee,eIconType,iWaitingFeeTimeLimit,vVehicleType', 'iVehicleTypeId', $iSelectedCarType);
            $sqlv = "SELECT eFareType,fVisitFee,eIconType,iWaitingFeeTimeLimit,vVehicleType_" . $vLangCode . " as vVehicleType, vLogo From vehicle_type WHERE iVehicleTypeId = '" . $iSelectedCarType . "'";
            $VehicleData = $obj->MySQLSelect($sqlv);
            $Data_trips['eFareType'] = $VehicleData[0]['eFareType'];
            $Data_trips['fVisitFee'] = $VehicleData[0]['fVisitFee'];
            $Data_trips['iWaitingFeeTimeLimit'] = $VehicleData[0]['iWaitingFeeTimeLimit'];
            $eIconType = $VehicleData[0]['eIconType'];
            $vLogo = $VehicleData[0]['vLogo'];
        } else {
            $tVehicleTypeDataCnt = (array)json_decode($tVehicleTypeData);
            if (count($tVehicleTypeDataCnt > 1)) {
                $Data_trips['eFareType'] = "Fixed";
                $Data_trips['fVisitFee'] = $Data_trips['iWaitingFeeTimeLimit'] = 0;
            }
        }
        if (strtoupper($isVideoCall) == "YES") {
            $Data_trips['eFareType'] = "Fixed";
        }
        if ($eBookingFrom == 'kiosk') {
            $eWalletDebitAllow = "No";
        }
        $Data_trips['vTripPaymentMode'] = $vTripPaymentMode;
        $Data_trips['tEndLat'] = $tDestinationLatitude;
        $Data_trips['tEndLong'] = $tDestinationLongitude;
        $Data_trips['tDaddress'] = $tDestinationAddress;
        $Data_trips['fPickUpPrice'] = $fPickUpPrice;
        $Data_trips['fNightPrice'] = $fNightPrice;
        $Data_trips['iQty'] = $iQty;
        $Data_trips['eType'] = $eType;
        $Data_trips['iPackageTypeId'] = $iPackageTypeId;
        $Data_trips['vReceiverName'] = $vReceiverName;
        $Data_trips['vReceiverMobile'] = $vReceiverMobile;
        $Data_trips['tPickUpIns'] = $tPickUpIns;
        $Data_trips['tDeliveryIns'] = $tDeliveryIns;
        $Data_trips['tPackageDetails'] = $tPackageDetails;
        $Data_trips['iUserPetId'] = $iUserPetId;
        $Data_trips['vCountryUnitRider'] = getMemberCountryUnit($passenger_id, "Passenger");
        $Data_trips['vCountryUnitDriver'] = getMemberCountryUnit($driver_id, "Driver");
        $Data_trips['fTollPrice'] = $fTollPrice;
        $Data_trips['vTollPriceCurrencyCode'] = $vTollPriceCurrencyCode;
        $Data_trips['eTollSkipped'] = $eTollSkipped;
        $Data_trips['vTimeZone'] = $vTimeZone;
        $Data_trips['iUserAddressId'] = $iUserAddressId;
        $Data_trips['tUserComment'] = $tUserComment;
        $Data_trips['iCabBookingId'] = $iCabBookingId;
        $Data_trips['iCabRequestId'] = $iCabRequestId;
        $Data_trips['eFlatTrip'] = $eFlatTrip;
        $Data_trips['fFlatTripPrice'] = $fFlatTripPrice;
        $Data_trips['eWalletDebitAllow'] = $eWalletDebitAllow;
        // add for hotel web
        $Data_trips['eBookingFrom'] = $eBookingFrom;
        $Data_trips['iHotelId'] = 0;
        // payment method 2
        $Data_trips['ePayWallet'] = $ePayWallet;
        $Data_trips['tEstimatedCharge'] = $tEstimatedCharge;
        $Data_trips['tTotalDuration'] = $tTotalDuration;
        $Data_trips['tTotalDistance'] = $tTotalDistance;
        // payment method 2
        //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
        //$Data_trips['tVehicleTypeData'] = $tVehicleTypeData; // Commented By HJ On 23-11-2019 For Soled \n data issue
        $Data_trips['tVehicleTypeData'] = $Data_trips['tVehicleTypeFareData'] = "";
        if (count($tVehicleTypeData) > 0 && !empty($tVehicleTypeData)) {
            $tVehicleTypeData_json = json_decode($tVehicleTypeData, true);
            //$Data_trips['tVehicleTypeData'] = str_replace("\\'", "'", json_encode($tVehicleTypeData, JSON_UNESCAPED_UNICODE)); // Added By HJ On 23-11-2019 For Soled \n data issue
            $Data_trips['tVehicleTypeData'] = getJsonFromAnArr($tVehicleTypeData_json);
            // $Data_trips['tVehicleTypeData'] = getJsonFromAnArr($tVehicleTypeData_json);
            $Data_trips['tVehicleTypeData'] = str_replace("'", getJsonFromAnArr($tVehicleTypeData_json), "\'");
            $Data_trips['tVehicleTypeFareData'] = $tVehicleTypeFareData;
        }
        //Added By HJ On 19-06-2020 For Solved Null Issue Start
        if ($Data_trips['tVehicleTypeData'] == null || $Data_trips['tVehicleTypeData'] == "null") {
            $Data_trips['tVehicleTypeData'] = "";
        }
        if ($Data_trips['tVehicleTypeFareData'] == null || $Data_trips['tVehicleTypeFareData'] == "null") {
            $Data_trips['tVehicleTypeFareData'] = "";
        }
        //Added By HJ On 19-06-2020 For Solved Null Issue End
        $Data_trips['eServiceLocation'] = $eServiceLocation;
        if ($MODULES_OBJ->isEnableVideoConsultingService() && $isVideoCall == "Yes") {
            $Data_trips['iActive'] = 'On Going Trip';
            $Data_trips['tStartDate'] = @date("Y-m-d H:i:s");
            $Data_trips['tDriverArrivedDate'] = date('Y-m-d H:i:s');
            $Data_trips['eDriverArrived'] = "Yes";
            $Data_trips['eServiceLocation'] = "Passenger";
        }
        //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
        $sql = "SELECT dv.vLicencePlate,ma.vMake,mo.vTitle FROM driver_vehicle as dv LEFT JOIN make as ma ON dv.iMakeId = ma.iMakeId LEFT JOIN model as mo ON dv.iModelId = mo.iModelId WHERE dv.iDriverVehicleId = '" . $CAR_id_driver . "'";
        $DriverVehicle = $obj->MySQLSelect($sql);
        $DriverVehicleMake = $DriverVehicle[0]['vMake'];
        $DriverVehicleModel = $DriverVehicle[0]['vTitle'];
        $DriverVehicleLicencePlate = $DriverVehicle[0]['vLicencePlate'];
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            reDefineGenerateTripParam();
        }
        if ($ride_type == "Multi-Delivery") {
            $Data_trips['fTripGenerateFare'] = $fTripGenerateFare;
            $Data_trips['vVerificationMethod'] = $DELIVERY_VERIFICATION_METHOD;
            $Data_trips['iFare'] = $iFare;
            //Added By HJ On 22-09-2020 For Change Payment Mode Cash If Payment Flow 2 OR 3 and eType= Multi-Delivery and Partial Payment Start
            /* For New Payment Flow */
            // if (($SYSTEM_PAYMENT_FLOW == "Method-2" || $SYSTEM_PAYMENT_FLOW == "Method-3") && $iFare > 0) {
            if ($vTripPaymentMode == "Wallet" && $iFare > 0) {
                $Data_trips['vTripPaymentMode'] = $vTripPaymentMode = "Cash";
            }
            /* For New Payment Flow End */
            //Added By HJ On 22-09-2020 For Change Payment Mode Cash If Payment Flow 2 OR 3 and eType= Multi-Delivery and Partial Payment End
            $Data_trips['iBaseFare'] = $iBaseFare;
            $Data_trips['fPricePerMin'] = $fPricePerMin;
            $Data_trips['fPricePerKM'] = $fPricePerKM;
            $Data_trips['fCommision'] = $fCommision;
            $Data_trips['fSurgePriceDiff'] = $fSurgePriceDiff;
            $Data_trips['fTax1'] = $fTax1;
            $Data_trips['fTax2'] = $fTax2;
            $Data_trips['fTax1Percentage'] = $fTax1Percentage;
            $Data_trips['fTax2Percentage'] = $fTax2Percentage;
            $Data_trips['fOutStandingAmount'] = $fOutStandingAmount;
            $Data_trips['fDistance'] = $fDistance;
            $Data_trips['fDuration'] = $fDuration;
            $Data_trips['fMinFareDiff'] = $fMinFareDiff;
            $Data_trips['iUserProfileId'] = $iUserProfileId;
            $Data_trips['iOrganizationId'] = $iOrganizationId;
            $Data_trips['ePaymentBy'] = $ePaymentBy;
            $Data_trips['ePaymentByReceiver'] = $ePaymentByReceiver;
            $Data_trips['eFareGenerated'] = "Yes";
            $Data_trips['fWalletDebit'] = $fWalletDebit;
            //added by SP for rounding off on 07-11-2019 for multi delivery
            $Data_trips['fRoundingAmount'] = $fRoundingAmount;
            $Data_trips['eRoundingType'] = $eRoundingType;
            // added  for multidelivery
            $sqlp = "SELECT cu.vName, cu.iCurrencyId, cu.eRoundingOffEnable, cu.Ratio FROM register_user AS ru LEFT JOIN currency AS cu ON ru.vCurrencyPassenger = cu.vName WHERE ru.iUserId = '" . $passenger_id . "'";
            $currData = $obj->MySQLSelect($sqlp);
            $vCurrency = $currData[0]['vName'];
            $sqld = "SELECT cu.vName, cu.iCurrencyId, cu.eRoundingOffEnable FROM register_driver AS rd LEFT JOIN currency AS cu ON rd.vCurrencyDriver = cu.vName WHERE rd.iDriverId = '" . $driver_id . "'";
            $currDatad = $obj->MySQLSelect($sqld);
            $vCurrencyd = $currDatad[0]['vName'];
            $DriverRation = get_value('currency', 'Ratio', 'vName', $vCurrencyd, '', 'true');
            if ($vTripPaymentMode == "Cash" && $MODULES_OBJ->isEnableRoundingMethod()) {
                if ($currData[0]['eRoundingOffEnable'] == "No" || $currDatad[0]['eRoundingOffEnable'] == "Yes") {
                    $roundingOffTotal_fare_amountArr_driver = getRoundingOffAmount($iFare * $DriverRation, $vCurrencyd);
                    if(isset($roundingOffTotal_fare_amountArr_driver['method'])) {
                        if ($roundingOffTotal_fare_amountArr_driver['method'] == "Addition") {
                            $eRoundingTypeDriver = "Addition";
                        } else {
                            $eRoundingTypeDriver = "Substraction";
                        }

                        $fRoundingAmountDriver = setTwoDecimalPoint($roundingOffTotal_fare_amountArr_driver['differenceValue']);
                        $Data_trips['fRoundingAmountDriver'] = $fRoundingAmountDriver;
                        $Data_trips['eRoundingTypeDriver'] = $eRoundingTypeDriver;
                    }
                }
            }
            //end for multi
        }
        if ($ride_type != "Multi-Delivery") {
            $fOutStandingAmount = GetPassengerOutstandingAmount($passenger_id);
            $Data_trips['fOutStandingAmount'] = $fOutStandingAmount;
        }
        $Data_trips['iTripReasonId'] = $iTripReasonId;
        $Data_trips['vReasonTitle'] = $vReasonTitle;
        $Data_trips['eTripReason'] = $eTripReason;
        $sql_vehicle_category_table_name = getVehicleCategoryTblName();
        if ($eType == "UberX") {
            if ($iSelectedCarType > 0) {
                $iVehicleCategoryId = get_value('vehicle_type', 'iVehicleCategoryId', 'iVehicleTypeId', $iSelectedCarType, '', 'true');
                $imageuploaddata = get_value($sql_vehicle_category_table_name, 'eBeforeUpload, eAfterUpload', 'iVehicleCategoryId', $iVehicleCategoryId);
                $Data_trips['eBeforeUpload'] = $imageuploaddata[0]['eBeforeUpload'];
                $Data_trips['eAfterUpload'] = $imageuploaddata[0]['eAfterUpload'];
            } else {
                //Added By HJ On On 01-02-2019 For Check Photo Upload Status When Multiple Service Found Start
                $eBeforeUploadArr = $eAfterUploadArr = array();
                for ($r = 0; $r < count($tVehicleTypeDataCnt); $r++) {
                    $typeIdSel = $tVehicleTypeDataCnt[$r]->iVehicleTypeId;
                    $iVehicleCategoryId = get_value('vehicle_type', 'iVehicleCategoryId', 'iVehicleTypeId', $typeIdSel, '', 'true');
                    $imageuploaddata = get_value($sql_vehicle_category_table_name, 'eBeforeUpload, eAfterUpload', 'iVehicleCategoryId', $iVehicleCategoryId);
                    $eBeforeUploadArr[] = $imageuploaddata[0]['eBeforeUpload'];
                    $eAfterUploadArr[] = $imageuploaddata[0]['eAfterUpload'];
                }
                $eBeforeUpload = $eAfterUpload = "No";
                if (in_array("Yes", $eBeforeUploadArr)) {
                    $eBeforeUpload = "Yes";
                }
                if (in_array("Yes", $eAfterUploadArr)) {
                    $eAfterUpload = "Yes";
                }
                $Data_trips['eBeforeUpload'] = $eBeforeUpload;
                $Data_trips['eAfterUpload'] = $eAfterUpload;
                //Added By HJ On On 01-02-2019 For Check Photo Upload Status When Multiple Service Found End
                $iSelectedCarType = $typeIdSel;
            }
        }
        if ($vCouponCode != '') {
            $Data_trips['vCouponCode'] = $vCouponCode;
            $Data_trips['fDiscount'] = $fDiscount;
            $Data_trips['vDiscount'] = $vDiscount;
            $coupon_result = $obj->MySQLSelect("SELECT iUsed, iUsageLimit from coupon WHERE vCouponCode = '" . $vCouponCode . "'");
            $noOfCouponUsed = $coupon_result[0]['iUsed'];
            $iUsageLimit = $coupon_result[0]['iUsageLimit'];
            $where = " vCouponCode = '" . $vCouponCode . "'";
            $data_coupon['iUsed'] = $noOfCouponUsed + 1;
            $obj->MySQLQueryPerform("coupon", $data_coupon, 'update', $where);
            ## Check Coupon Code Usage Limit , Send Email to Admin if Usage  Limit is over ##
            $UpdatedCouponUsedNo = $noOfCouponUsed + 1;
            if ($iUsageLimit == $UpdatedCouponUsedNo) {
                $maildata['vCouponCode'] = $vCouponCode;
                $maildata['iUsageLimit'] = $iUsageLimit;
                $maildata['COMPANY_NAME'] = $COMPANY_NAME;
                $mail = $COMM_MEDIA_OBJ->SendMailToMember('COUPON_LIMIT_COMPLETED_TO_ADMIN', $maildata);
            }
            ## Check Coupon Code Usage Limit , Send Email to Admin if Usage  Limit is over ##
        }
        // Related to New Service Provider Flow
        if ($eType == "UberX" && $SERVICE_PROVIDER_FLOW == "Provider" && $Data_trips['eServiceLocation'] == "Driver") {
            if ($Data_trips['iCabBookingId'] > 0) {
                $Data_trips['vWorkLocationLatitude'] = $vWorkLocationLatitude;
                $Data_trips['vWorkLocationLongitude'] = $vWorkLocationLongitude;
                $Data_trips['vWorkLocation'] = $vWorkLocation;
                $Data_trips['eSelectWorkLocation'] = $eSelectWorkLocation;
            } else {
                if ($Data_vehicle[0]['eSelectWorkLocation'] == "Dynamic") {
                    $Data_trips['vWorkLocationLatitude'] = $vLatitude;
                    $Data_trips['vWorkLocationLongitude'] = $vLongitude;
                    //$url_driver_geo = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" . $vLatitude . "," . $vLongitude . "&key=" . $GoogleServerKey . "&language=" . $Data_vehicle[0]['vLang'];
                    //try {
                    //    $jsonfile_driver_geo = file_get_contents($url_driver_geo);
                    //    $jsondata_driver_geo = json_decode($jsonfile_driver_geo);
                    //    $source_address_driver_geo = $jsondata_driver_geo->results[0]->formatted_address;
                    //    $Data_trips['vWorkLocation'] = $source_address_driver_geo;
                    //}
                    //    catch(ErrorException $ex) {
                    //}
                    //added by SP on 05-09-2020 for getting user address from the api as discussed with KS start.
                    //this is when useraddress is not there, eServiceLocation is Driver, eSelectWorkLocation is Dynamic
                    $vLangProvider = $Data_vehicle[0]['vLang'];
                    $requestDataArr = array();
                    $requestDataArr['LATITUDE'] = $vLatitude;
                    $requestDataArr['LONGITUDE'] = $vLongitude;
                    $requestDataArr['LANGUAGE_CODE'] = $vLangProvider;
                    $direction_data = getAddressFromGeoLocations($requestDataArr);
                    $Data_trips['vWorkLocation'] = $direction_data['address'];
                    //added by SP on 05-09-2020 for getting user address from the api as discussed with KS end.
                } else {
                    $Data_trips['vWorkLocation'] = $Data_vehicle[0]['vWorkLocation'];
                    $Data_trips['vWorkLocationLatitude'] = $Data_vehicle[0]['vWorkLocationLatitude'];
                    $Data_trips['vWorkLocationLongitude'] = $Data_vehicle[0]['vWorkLocationLongitude'];
                }
                $Data_trips['eSelectWorkLocation'] = $Data_vehicle[0]['eSelectWorkLocation'];
            }
            $Data_trips['tStartLat'] = $Data_trips['vWorkLocationLatitude'];
            $Data_trips['tStartLong'] = $Data_trips['vWorkLocationLongitude'];
            $Data_trips['tSaddress'] = $Data_trips['vWorkLocation'];
        }
        //Added By HJ On 01-07-2020 For Optimize currency Table Query Start
        if (count($Data_ALL_currency_Arr) > 0) {
            $currencyList = array();
            for ($g = -0; $g < count($Data_ALL_currency_Arr); $g++) {
                if (strtoupper($Data_ALL_currency_Arr[$g]['eStatus']) == "ACTIVE") {
                    $currencyList[] = $Data_ALL_currency_Arr[$g];
                }
            }
        } else {
            $currencyList = get_value('currency', '*', 'eStatus', 'Active');
        }
        //Added By HJ On 01-07-2020 For Optimize currency Table Query End
        for ($fd = 0; $fd < count($currencyList); $fd++) {
            $currencyCode = $currencyList[$fd]['vName'];
            $Data_trips['fRatio_' . $currencyCode] = $currencyList[$fd]['Ratio'];
        }
        $Data_trips['vCurrencyPassenger'] = $Data_passenger_detail[0]['vCurrencyPassenger'];
        $Data_trips['vCurrencyDriver'] = $Data_vehicle[0]['vCurrencyDriver'];
        //Added By HJ On 01-07-2020 For Optimize currency Table Query Start
        if (isset($currencyAssociateArr[$Data_trips['vCurrencyPassenger']])) {
            $fRatioPassenger = $currencyAssociateArr[$Data_trips['vCurrencyPassenger']]['Ratio'];
        } else {
            $fRatioPassenger = get_value('currency', 'Ratio', 'vName', $Data_trips['vCurrencyPassenger'], '', 'true');
        }
        if (isset($currencyAssociateArr[$Data_trips['vCurrencyDriver']])) {
            $fRatioDriver = $currencyAssociateArr[$Data_trips['vCurrencyDriver']]['Ratio'];
        } else {
            $fRatioDriver = get_value('currency', 'Ratio', 'vName', $Data_trips['vCurrencyDriver'], '', 'true');
        }
        //Added By HJ On 01-07-2020 For Optimize currency Table Query End
        $Data_trips['fRatioPassenger'] = $fRatioPassenger;
        $Data_trips['fRatioDriver'] = $fRatioDriver;
        $eOTPCodeEnable = $eAskCodeToUser = "No";
        if (($MODULES_OBJ->isEnableOTPVerificationRide() && $eType == "Ride") || ($MODULES_OBJ->isEnableOTPVerificationDelivery() && ($eType == "Deliver" || $eType == "Multi-Delivery"))) {
            $vehicle_type_data = $obj->MySQLSelect("SELECT eOTPCodeEnable FROM vehicle_type WHERE iVehicleTypeId = $iSelectedCarType");
            if ($vehicle_type_data[0]['eOTPCodeEnable'] == "Yes") {
                $Data_trips['eAskCodeToUser'] = $eAskCodeToUser = "Yes";
                $Data_trips['vRandomCode'] = $vRandomCode = generateCommonRandom();
                $eOTPCodeEnable = "Yes";
            }
        }
        if ($MODULES_OBJ->isEnableOTPVerificationUberX() && $eType == "UberX") {
            $vehicle_type_data = $obj->MySQLSelect("SELECT iVehicleCategoryId FROM vehicle_type WHERE iVehicleTypeId = $iSelectedCarType");
            $iParentCategoryId = getParentCategoryId($vehicle_type_data[0]['iVehicleCategoryId']);
            $vehicle_category_data = $obj->MySQLSelect("SELECT eOTPCodeEnable FROM vehicle_category WHERE iVehicleCategoryId = $iParentCategoryId");
            if ($vehicle_category_data[0]['eOTPCodeEnable'] == "Yes") {
                $Data_trips['eAskCodeToUser'] = $eAskCodeToUser = "Yes";
                $Data_trips['vRandomCode'] = $vRandomCode = generateCommonRandom();
                $eOTPCodeEnable = "Yes";
            }
        }

        $iTripId = $obj->MySQLQueryPerform("trips", $Data_trips, 'insert');

        if ($eOTPCodeEnable == "Yes") {
            if ($eType == "Ride") {
                $DRIVER_TXT = $languageLabelsArr['LBL_DRIVER'];
            } elseif ($eType == "Deliver" || $eType == "Multi-Delivery") {
                $DRIVER_TXT = $languageLabelsArr['LBL_DELIVERY_DRIVER_TXT'];
            } elseif ($eType == "UberX") {
                $DRIVER_TXT = $languageLabelsArr['LBL_PROVIDER'];
            }
            $Data_Mail['OTP'] = $vRandomCode;
            $Data_Mail['FROMNAME'] = $Data_passenger_detail[0]['bookerName'];
            $Data_Mail['vEmail'] = $Data_passenger_detail[0]['vEmail'];
            $Data_Mail['DRIVER'] = $DRIVER_TXT;
            $sendemail = $COMM_MEDIA_OBJ->SendMailToMember("START_TRIP_OTP", $Data_Mail);
            $Data_SMS['OTP'] = $vRandomCode;
            $Data_SMS['DRIVER'] = $DRIVER_TXT;
            if (strtoupper(PACKAGE_TYPE) == "SHARK" && $eBookForSomeOneElse == "Yes") {
                $sms_message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("START_TRIP_OTP", $Data_SMS, "", $vLangCode);
                $result_sms = $COMM_MEDIA_OBJ->SendSystemSMS($vBookSomeOneNumber, $passangerPhoneCode, $sms_message_layout);
            }
            $sms_message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("START_TRIP_OTP", $Data_SMS, "", $vLangCode);

            $passangerPhone = $Data_passenger_detail[0]['vPhone'];
            if (strtoupper($eBookingFrom) == 'KIOSK') {
                $passangerPhoneCode = $user_data[0]['vPhoneCode'];
                $passangerPhone = $user_data[0]['vPhone'];
            }
            $result_sms = $COMM_MEDIA_OBJ->SendSystemSMS($passangerPhone, $passangerPhoneCode, $sms_message_layout);
        }
        //Added By HJ On 22-03-2019 For Send SMS of Book FOr Someone Else Process Start
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            $Data_vehicle[0]['DriverVehicleLicencePlate'] = $DriverVehicleLicencePlate;
            sendSMSBookForSomeOneElse($vTripPaymentMode, $bokingData, $iTripId, $Data_passenger_detail, $VehicleData, $DriverVehicleMake, $DriverVehicleModel, $Data_vehicle);
            if (in_array($bokingData[0]['eBookingFrom'], ['Admin', 'Company']) && $eType == "Ride") {
                sendSMSBookFromWeb($vTripPaymentMode, $bokingData, $iTripId, $Data_passenger_detail, $VehicleData, $DriverVehicleMake, $DriverVehicleModel, $Data_vehicle);
            }
        }
        //Added By HJ On 22-03-2019 For Send SMS of Book FOr Someone Else Process End
        //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 Start
        // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
        if ($vTripPaymentMode == "Wallet") {
            $obj->sql_query("UPDATE trip_outstanding_amount set eAuthoriseIdName='iTripId',iAuthoriseId = '" . $iTripId . "' WHERE iAuthoriseId='" . $outstandingId . "' AND eAuthoriseIdName='" . $trip_status_chkField . "'");
        }
        //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 End
        $trip_status = "Active";
        //if(($iFromStationId!='' && $iToStationId!='') || $iFromStationId!=0 && $iToStationId!=0) {
        if (!empty($iFromStationId) && !empty($iToStationId)) {
            $trip_status = 'Arrived';
        }
        if ($MODULES_OBJ->isEnableVideoConsultingService() && $isVideoCall == 'Yes') {
            $trip_status = 'On Going Trip';
        }
        ###For multidelivery trip id update in trip locations#######
        if ($ride_type == "Multi-Delivery") {
            $field_name = ($iCabBookingId != "" && $iCabBookingId > 0) ? "iCabBookingId" : "iCabRequestId";
            $field_value = ($iCabBookingId != "" && $iCabBookingId > 0) ? $iCabBookingId : $iCabRequestId;
            $where = " iCabBookingId='" . $field_value . "'";
            $data_update_loc['iTripId'] = $iTripId;
            $obj->MySQLQueryPerform("trips_delivery_locations", $data_update_loc, 'update', $where);
            $where1 = " $field_name='" . $field_value . "'";
            $data_update_field['iTripId'] = $iTripId;
            $obj->MySQLQueryPerform("trip_delivery_fields", $data_update_field, 'update', $where1);
            Update_Price_Individual($iTripId);
        }
        ############For multidelivery#######
        ###For Stopoverpoint iTripId update in trips_stopoverpoint_location######
        if ($MODULES_OBJ->checkStopOverPointModule() && !empty($iCabRequestId) && !empty($iTripId)) {
            updateTripIds($iCabRequestId, $iTripId);
        }
        ############End Stopoverpoint#######
        ############For Outstanding Amount#######
        if ($fOutStandingAmount > 0 && $ride_type == "Multi-Delivery") {
            $obj->sql_query("UPDATE register_user set fTripsOutStandingAmount = '0' WHERE iUserId = " . $passenger_id);
            $obj->sql_query("UPDATE trip_outstanding_amount set ePaidByPassenger = 'Yes',vTripAdjusmentId = '" . $iTripId . "' WHERE iUserId = '" . $passenger_id . "' AND ePaidByPassenger = 'No'");
        }
        ############For Outstanding Amount#######
        if ($iCabRequestId != "") {
            $where1 = " iCabRequestId = '$iCabRequestId'";
            $Data_update_cab_request['iTripId'] = $iTripId;
            $Data_update_cab_request['iDriverId'] = $driver_id;
            $obj->MySQLQueryPerform("cab_request_now", $Data_update_cab_request, 'update', $where1);
        }
        #### Update Driver Request Status of Trip ####
        UpdateDriverRequest2($driver_id, $passenger_id, $iTripId, "Accept", $vMsgCode, "No");
        #### Update Driver Request Status of Trip ####
        if ($iCabBookingId > 0) {
            $where = " iCabBookingId = '$iCabBookingId'";
            $data_update_booking['iTripId'] = $iTripId;
            $data_update_booking['eStatus'] = "Completed";
            $data_update_booking['iDriverId'] = $driver_id;
            $obj->MySQLQueryPerform("cab_booking", $data_update_booking, 'update', $where);
        }
        $where = " iUserId = '$passenger_id'";
        if ($APP_TYPE == "Ride-Delivery-UberX" && $eType != "UberX") {
            $Data_update_passenger['iTripId'] = $iTripId;
            $Data_update_passenger['vTripStatus'] = $trip_status;
        } else if ($eType != "UberX") {
            $Data_update_passenger['iTripId'] = $iTripId;
            $Data_update_passenger['vTripStatus'] = $trip_status;
        }
        $Data_update_passenger['dSendverificationDateEmergency'] = "0000-00-00 00:00:00";
        $Data_update_passenger['vVerificationCountEmergency'] = 0;
        $id = $obj->MySQLQueryPerform("register_user", $Data_update_passenger, 'update', $where);
        $where = " iDriverId = '$driver_id'";
        $Data_update_driver['iTripId'] = $iTripId;
        $Data_update_driver['vTripStatus'] = $trip_status;
        $Data_update_driver['vRideCountry'] = $vRideCountry;
        $Data_update_driver['vAvailability'] = "Not Available";
        $Data_update_driver['dSendverificationDateEmergency'] = "0000-00-00 00:00:00";
        $Data_update_driver['vVerificationCountEmergency'] = 0;
        if ($MODULES_OBJ->isSendRequestToDriverBeforFinishTripModule() && $REQUEST_TYPE == "Ride") {
            if (count($checkongoingTripData) == 0) {
                $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
            }
        } else {
            $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
        }
        //update insurance log
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            $details_arr['iTripId'] = $iTripId;
            $details_arr['LatLngArr']['vLatitude'] = $vLatitude;
            $details_arr['LatLngArr']['vLongitude'] = $vLongitude;
            // $details_arr['LatLngArr']['vLocation'] = $Source_point_Address;
            update_driver_insurance_status($driver_id, "Accept", $details_arr, "GenerateTrip");
        }
        //update insurance log
        if ($eType == "Deliver") {
            $drivername = $Data_vehicle[0]['vName'] . " " . $Data_vehicle[0]['vLastName'];
            $tripdriverarrivlbl = $languageLabelsArr['LBL_CARRIER'] . " " . $drivername . " " . $languageLabelsArr['LBL_DRIVER_IS_ARRIVING'];
            $alertMsg = $tripdriverarrivlbl;
        } else if ($eType == "Ride") {
            $alertMsg = $tripdriverarrivlbl; // HeRE
        } else {
            $drivername = $Data_vehicle[0]['vName'] . " " . $Data_vehicle[0]['vLastName'];
            $tripdriverarrivlbl = $languageLabelsArr['LBL_PROVIDER'] . " " . $drivername . " " . $languageLabelsArr['LBL_DRIVER_IS_ARRIVING'];
            if ($MODULES_OBJ->isEnableVideoConsultingService() && $isVideoCall == 'Yes') {
                $tripdriverarrivlbl = $languageLabelsArr['LBL_PROVIDER'] . ' ' . $drivername . ' ' . $languageLabelsArr['LBL_DRIVER_START_NOTIMSG'] . $TripRideNO;
            }
            $alertMsg = $tripdriverarrivlbl;
        }
        //Added By HJ On 04-12-2019 For Chnaged Message For Fly ride Start
        if (!empty($iFromStationId) && !empty($iToStationId)) {
            $alertMsg = $languageLabelsArr['LBL_FLY_ARRIVED'];
        }
        //Added By HJ On 04-12-2019 For Chnaged Message For Fly ride End
        //added by SP on 26-08-2020 for uberx and servicelocation is driver
        if ($eType == "UberX" && $eServiceLocation == "Driver") {
            $alertMsg = $languageLabelsArr['LBL_DRIVER_IS_ARRIVING_UBERX'];
        }
        if ($eOTPCodeEnable == "Yes") {
            $alertMsg .= ". " . $languageLabelsArr['LBL_YOUR_TRIP_OTP_TXT'] . " " . $vRandomCode;
        }
        $message_arr = array();
        $message_arr['iDriverId'] = $driver_id;
        $message_arr['Message'] = $DriverMessage;
        $message_arr['iTripId'] = strval($iTripId);
        $message_arr['DriverAppVersion'] = strval($Data_vehicle[0]['iAppVersion']);
        if ($iCabBookingId > 0) {
            $message_arr['iCabBookingId'] = $iCabBookingId;
            $message_arr['iBookingId'] = $iCabBookingId;
        }
        $message_arr['eType'] = $eType;
        $message_arr['iTripVerificationCode'] = $TripVerificationCode;
        //$message_arr['driverName'] = $Data_vehicle[0]['vName'] . " " . $Data_vehicle[0]['vLastName'];
        $message_arr['driverName'] = $Data_vehicle[0]['vName'];
        $message_arr['driverPhone'] = "+" . $Data_vehicle[0]['vCode'] . " " . $Data_vehicle[0]['vPhone'];
        $driver_img_path = "";
        if ($Data_vehicle[0]['vImage'] != "" && file_exists($tconfig["tsite_upload_images_driver_path"] . "/" . $driver_id . "/2_" . $Data_vehicle[0]['vImage'])) {
            $driver_img_path = $tconfig["tsite_upload_images_driver"] . "/" . $driver_id . "/2_" . $Data_vehicle[0]['vImage'];
        }
        $message_arr['driverImage'] = get_tiny_url($driver_img_path);
        $message_arr['DriverVehicleLicencePlate'] = $DriverVehicleLicencePlate;
        $message_arr['DriverVehicleMakeModel'] = $DriverVehicleMake;
        $message_arr['driverRating'] = $Data_vehicle[0]['vAvgRating'];
        $message_arr['vRideNo'] = $TripRideNO;
        $message_arr['vTitle'] = $alertMsg;
        $message_arr['eSystem'] = "";
        if ($eOTPCodeEnable == "Yes") {
            $message_arr['eAskCodeToUser'] = $eAskCodeToUser;
            $message_arr['vRandomCode'] = $vRandomCode;
        }
        //$TripsHotelData = get_value('trips', 'iHotelId,eBookingFrom', 'iTripId', $iTripId);
        //$eBookingFrom = $TripsHotelData[0]['eBookingFrom'];
        if ($eBookingFrom == 'Kiosk') {
            //$iHotelId = $TripsHotelData[0]['iHotelId'];
            if (!empty($iHotelId) && $iHotelId > 0) {
                // $HotelData = get_value('hotel', 'vPickupFrom', 'iHotelId', $iHotelId);
                $HotelData = $obj->MySQLSelect("SELECT administrators.vAddress,administrators.vFirstName, hotel.iAdminId FROM administrators, hotel WHERE administrators.iAdminId = hotel.iAdminId AND hotel.iHotelId = '" . $iHotelId . "' AND hotel.eStatus = 'Active' AND administrators.eStatus = 'Active'");
                $message_arr['vPickupFrom'] = $Source_point_Address;
                if (!empty($HotelData)) {
                    $vPickupFrom = $HotelData[0]['vFirstName'] . " \n" . $HotelData[0]['vAddress'];
                    $message_arr['vPickupFrom'] = $vPickupFrom;
                }
            }
        }

        $Data_activity = array();
        $Data_activity['iTripId'] = $iTripId;
        $Data_activity['vLatitude'] = $vLatitude;
        $Data_activity['vLongitude'] = $vLongitude;
        $obj->MySQLQueryPerform("trip_activity_details", $Data_activity, "insert");

        //added by SP on 17-02-2021 for custom notification
        $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
        //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
        $message_arr['CustomViewBtn'] = "Yes";
        $message_arr['CustomTrackDetails'] = "No";
        $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
        $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
        $customNotiArray = GetCustomNotificationDetails($iTripId, $message_arr['vTitle'], $vLangCode);
        //title and sub description shown in custom notification
        $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
        $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
        $message_arr['CustomMessage'] = $customNotiArray;
        
        $message_arr['LiveActivityData'] = getTripLiveActivity($iTripId);
        $message_arr['LiveActivity'] = "No";
        
        // $message = json_encode($message_arr);
        // #####################Add Status Message#########################
        // $DataTripMessages['tMessage'] = $message;
        // $DataTripMessages['iDriverId'] = $driver_id;
        // $DataTripMessages['iTripId'] = $iTripId;
        // $DataTripMessages['iUserId'] = $passenger_id;
        // $DataTripMessages['eFromUserType'] = "Driver";
        // $DataTripMessages['eToUserType'] = "Passenger";
        // $DataTripMessages['eReceived'] = "No";
        // $DataTripMessages['dAddedDate'] = @date("Y-m-d H:i:s");
        // $obj->MySQLQueryPerform("trip_status_messages", $DataTripMessages, 'insert');
        ################################################################
        if ($setCron == 'Yes') {
            //$passengerDetail = get_value('register_user', 'vName,vLastName,vPhone,vPhoneCode', 'iUserId', $passenger_id);
            $passengerName = $user_data[0]['vName'] . ' ' . $user_data[0]['vLastName'];
            $vPhoneCode = $user_data[0]['vPhoneCode'];
            $vPhone = $user_data[0]['vPhone'];
            //$driverName = $Data_vehicle[0]['vName'] . ' ' . $Data_vehicle[0]['vLastName'];
            $driverName = $Data_vehicle[0]['vName'];
            $messageEmail['details'] = '<p>Dear Administrator,</p>

            <p>Driver ( ' . $driverName . ' ) is assigned successfully for the following manual booking.</p>

            <p>Name: ' . $passengerName . ',</p>

            <p>Contact Number: +' . $vPhoneCode . $vPhone . '</p>';
            $mail = $COMM_MEDIA_OBJ->SendMailToMember('CRON_BOOKING_EMAIL', $messageEmail);
            $where_cabid2 = " iCabBookingId = '" . $iCabBookingId . "'";
            $Data_update2['eAssigned'] = 'Yes';
            $Data_update2['iDriverId'] = $driver_id;
            $id = $obj->MySQLQueryPerform("cab_booking", $Data_update2, 'update', $where_cabid2);
        }
        if ($iTripId > 0) {
            $alertSendAllowed = true;
            /* For PubNub Setting */
            $tableName = "register_user";
            $iMemberId_VALUE = $passenger_id;
            $iMemberId_KEY = "iUserId";
            //$AppData = get_value($tableName, 'iAppVersion,eDeviceType', $iMemberId_KEY, $iMemberId_VALUE);
            $iAppVersion = $user_data[0]['iAppVersion'];
            $eDeviceType = $user_data[0]['eDeviceType'];
            $tSessionId = $user_data[0]['tSessionId'];
            $eAppTerminate = $user_data[0]['eAppTerminate'];
            $eDebugMode = $user_data[0]['eDebugMode'];
            $eHmsDevice = $user_data[0]['eHmsDevice'];
            $message_arr['tSessionId'] = $tSessionId;
            $passengerID = $passenger_id;
            if ($eBookingFrom == "Kiosk") {
                $hotel_data = $obj->MySQLSelect("SELECT tSessionId,eDeviceType,iGcmRegId,eAppTerminate,eDebugMode FROM `hotel` WHERE iHotelId = '" . $user_data[0]['iHotelId'] . "'");
                $message_arr['tSessionId'] = $hotel_data[0]['tSessionId'];
                $passengerID = $user_data[0]['iHotelId'];
                $user_data[0]['eDeviceType'] = $hotel_data[0]['eDeviceType'];
                $user_data[0]['iGcmRegId'] = $hotel_data[0]['iGcmRegId'];
                $eAppTerminate = $hotel_data[0]['eAppTerminate'];
                $eDebugMode = $hotel_data[0]['eDebugMode'];
                $eHmsDevice = 'No';
            }
            $channelName = "PASSENGER_" . $passengerID;
            $generalDataArr[] = array('eDeviceType' => $user_data[0]['eDeviceType'], 'deviceToken' => $user_data[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName, 'tripStatusMsgArr' => array('tMessage' => $message_arr, 'iDriverId' => $driver_id, 'iTripId' => $iTripId, 'iUserId' => $passengerID, 'eFromUserType' => "Driver", 'eToUserType' => "Passenger", 'eReceived' => "No"));
            $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), ($eBookingFrom == "Kiosk") ? RN_KIOSK : RN_USER);
            ###### PUBNUB #########
            $returnArr['Action'] = "1";
            $data['iTripId'] = $iTripId;
            $data['tEndLat'] = $tDestinationLatitude;
            $data['tEndLong'] = $tDestinationLongitude;
            $data['tDaddress'] = $tDestinationAddress;
            $data['PAppVersion'] = $Data_passenger_detail[0]['iAppVersion'];
            $data['eFareType'] = $Data_trips['eFareType'];
            $data['vVehicleType'] = $eIconType;
            //$returnArr['APP_TYPE'] = $CONFIG_OBJ->getConfigurations("configurations","APP_TYPE");
            $returnArr['APP_TYPE'] = $APP_TYPE;
            $returnArr['message'] = $data;
            if ($iCabBookingId != "") {
                //$passengerData = get_value('register_user', 'vName,vLastName,vImgName,vFbId,vAvgRating,vPhone,vPhoneCode,iAppVersion', 'iUserId', $passenger_id);
                $returnArr['sourceLatitude'] = $Source_point_latitude;
                $returnArr['sourceLongitude'] = $Source_point_longitude;
                $returnArr['PassengerId'] = $passenger_id;
                $returnArr['PName'] = $user_data[0]['vName'] . ' ' . $user_data[0]['vLastName'];
                $returnArr['PPicName'] = $user_data[0]['vImgName'];
                $returnArr['PFId'] = $user_data[0]['vFbId'];
                $returnArr['PRating'] = $user_data[0]['vAvgRating'];
                $returnArr['PPhone'] = $user_data[0]['vPhone'];
                $returnArr['PPhoneC'] = $user_data[0]['vPhoneCode'];
                $returnArr['PAppVersion'] = $user_data[0]['iAppVersion'];
                $returnArr['TripId'] = strval($iTripId);
                $returnArr['DestLocLatitude'] = $tDestinationLatitude;
                $returnArr['DestLocLongitude'] = $tDestinationLongitude;
                $returnArr['DestLocAddress'] = $tDestinationAddress;
                $returnArr['vVehicleType'] = $eIconType;
            }
            if ($Data_trips['eBookingFrom'] == 'Kiosk') {
                $maildata1 = array();
                $maildata1['VEHICLE_TYPE'] = $VehicleData[0]['vVehicleType'];
                $maildata1['CAR_NUMBER'] = "(" . $DriverVehicleMake . " " . $DriverVehicleModel . ")";
                $maildata1['DRIVER_NAME'] = $Data_vehicle[0]['vName'] . " " . $Data_vehicle[0]['vLastName'];
                $maildata1['DRIVER_NUMBER'] = "(+" . $Data_vehicle[0]['vCode'] . " " . $Data_vehicle[0]['vPhone'] . ")";
                $maildata1['vRideNo'] = $Data_trips['vRideNo'];
                //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019 start
                //$passengerData = $obj->MySQLSelect("SELECT r.vName,r.vLastName,r.vPhone,c.vPhoneCode FROM  `register_user` AS r, `country` AS c WHERE r.iUserId = $passenger_id AND r.vCountry = c.vCountryCode");
                $PhoneCode = $user_data[0]['vPhoneCode'];
                $PPhone = $user_data[0]['vPhone'];
                $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("BOOKING_IN_KIOSK", $maildata1, "", $vLangCode);
                $result = $COMM_MEDIA_OBJ->SendSystemSMS($PPhone, $PhoneCode, $message_layout);
                //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019 end
            }
            $returnArr['USER_DATA'] = getDriverDetailInfo($driver_id);
            setDataResponse($returnArr);
        } else {
            $data['Action'] = "0";
            $data['message'] = "LBL_TRY_AGAIN_LATER_TXT";
            setDataResponse($data);
        }
    } else {
        if ($eStatus == "Complete") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = $failassigntopassenger;
        } else if ($eStatus == "Cancel") {
            $returnArr['Action'] = "0";
            if (isset($langLabelArr['LBL_MANAUL_BOOKING_CANCELLED_MSG'])) {
                $LBL_MANAUL_BOOKING_CANCELLED_MSG = $langLabelArr['LBL_MANAUL_BOOKING_CANCELLED_MSG'];
            } else {
                $LBL_MANAUL_BOOKING_CANCELLED_MSG = get_value('language_label', 'vValue', 'vLabel', 'LBL_MANAUL_BOOKING_CANCELLED_MSG', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            //$vDriverLangCode = get_value('register_driver', 'vLang', 'iDriverId', $driver_id, '', 'true');
            //$LBL_MANAUL_BOOKING_CANCELLED_MSG = get_value('language_label', 'vValue', 'vLabel', 'LBL_MANAUL_BOOKING_CANCELLED_MSG', " and vCode='" . $vDriverLangCode . "'", 'true');
            $returnArr['message'] = $LBL_MANAUL_BOOKING_CANCELLED_MSG;
        } else if ($eStatus == "Cancelled") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = $requestcancelbyuser;
        }
        $returnArr['DO_RELOAD'] = "Yes";
        setDataResponse($returnArr);
    }
}
###########################################################################
if ($type == "DriverArrived") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    if ($iDriverId != '') {
        //Added By HJ On 24-06-2020 For Optimization register_driver Table Query Start
        /*if(isset($userDetailsArr['register_driver_'.$iDriverId])){
            $driverData = $userDetailsArr['register_driver_'.$iDriverId];
        }else{
            $driverData = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='".$iDriverId."'");
            $userDetailsArr['register_driver_'.$iDriverId] = $driverData;
        }*/
        //Added By HJ On 12-09-2020 For Solved tDriverArrivedDate Update ni not Current Trip B'Coz Old Data Got From Global Array Start
        $driverData = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='" . $iDriverId . "'");
        $userDetailsArr['register_driver_' . $iDriverId] = $driverData;
        //Added By HJ On 12-09-2020 For Solved tDriverArrivedDate Update ni not Current Trip B'Coz Old Data Got From Global Array End
        $driver_img_path = "";
        if (!empty($driverData[0]['vImage']) && file_exists($tconfig["tsite_upload_images_driver_path"] . "/" . $iDriverId . "/2_" . $driverData[0]['vImage'])) {
            $driver_img_path = $tconfig["tsite_upload_images_driver"] . "/" . $iDriverId . "/2_" . $driverData[0]['vImage'];
        }

        $driver_img_path = !empty($driver_img_path) ? get_tiny_url($tconfig['tsite_url'] . 'resizeImg.php?w=150&src=' . $driver_img_path) : "";
        //Added By HJ On 24-06-2020 For Optimization register_driver Table Query End
        $vTripStatus = $driverData[0]['vTripStatus'];
        //$vTripStatus = get_value('register_driver', 'vTripStatus', 'iDriverId', $iDriverId, '', 'true');
        if ($vTripStatus == "Cancelled") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "DO_RESTART";
            setDataResponse($returnArr);
        }
        ## Add On for Checking Driver Distance in nearest to User Pick Up Address ##
        if ($MODULES_OBJ->isEnableDriverArrivalDistance()) {
            $driverLat = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
            $driverLon = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
            $iTripId = $driverData[0]['iTripId'];
            $TripData = $obj->MySQLSelect("SELECT tStartLat,tStartLong,eType FROM trips WHERE iTripId='" . $iTripId . "'");
            $UserPickupLat = $TripData[0]['tStartLat'];//as here startlat is some different disctance from user but it avoids for now..so take this one only.
            $UserPickupLong = $TripData[0]['tStartLong'];
            $driverdistance = distanceByLocation($driverLat, $driverLon, $UserPickupLat, $UserPickupLong, "K");
            $driverdistance = $driverdistance * 1000;
            if ($driverdistance > $DRIVER_ARRIVAL_DISTANCE_TO_USER_PICKUP_ADDRESS) {
                $returnArr['Action'] = "0";
                if ($TripData[0]['eType'] == 'UberX') {
                    $returnArr['message'] = "LBL_DRIVER_ARRIVED_DISTANCE_TXT_UBERX";
                } else {
                    $returnArr['message'] = "LBL_DRIVER_ARRIVED_DISTANCE_TXT";
                }
                setDataResponse($returnArr);
            }
        }
        ## Add On for Checking Driver Distance in nearest to User Pick Up Address ##
        $where = " iDriverId = '$iDriverId'";
        $Data_update_driver['vTripStatus'] = 'Arrived';
        //$Data_update_driver['eDriverArrived'] = 'Yes';
        $Data_update_driver['dSendverificationDateEmergency'] = "0000-00-00 00:00:00";
        $Data_update_driver['vVerificationCountEmergency'] = 0;
        $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
        if ($id > 0) {
            //Added By HJ On 24-06-2020 For Optimization trips Table Query Start
            $driverTripId = $driverData[0]['iTripId'];
            if (isset($tripDetailsArr['trips_' . $driverTripId])) {
                $data_trips = $tripDetailsArr['trips_' . $driverTripId];
            } else {
                $data_trips = $obj->MySQLSelect("select * from trips where iTripId='" . $driverTripId . "'");
                $tripDetailsArr['trips_' . $driverTripId] = $data_trips;
            }

            $tripData = $obj->MySQLSelect("SELECT tr.iVehicleTypeId, dv.vLicencePlate, ma.vMake, mo.vTitle, vt.vLogo FROM trips as tr 
                LEFT JOIN register_driver as rd ON rd.iDriverId = tr.iDriverId 
                LEFT JOIN driver_vehicle as dv ON dv.iDriverVehicleId = rd.iDriverVehicleId 
                LEFT JOIN make as ma ON dv.iMakeId = ma.iMakeId 
                LEFT JOIN model as mo ON dv.iModelId = mo.iModelId 
                LEFT JOIN vehicle_type as vt ON vt.iVehicleTypeId = tr.iVehicleTypeId 
                WHERE tr.iTripId='" . $driverTripId . "' ");

            $result = $driverData;
            $result[0]['driverName'] = $result[0]['vName'] . " " . $result[0]['vLastName'];
            $result[0]['vRideNo'] = $data_trips[0]['vRideNo'];
            $result[0]['tEndLat'] = $data_trips[0]['tEndLat'];
            $result[0]['tEndLong'] = $data_trips[0]['tEndLong'];
            $result[0]['tDaddress'] = $data_trips[0]['tDaddress'];
            $result[0]['iUserId'] = $data_trips[0]['iUserId'];
            $result[0]['eType'] = $data_trips[0]['eType'];
            $result[0]['eTollSkipped'] = $data_trips[0]['eTollSkipped'];
            $result[0]['eBeforeUpload'] = $data_trips[0]['eBeforeUpload'];
            $result[0]['eAfterUpload'] = $data_trips[0]['eAfterUpload'];
            $result[0]['ePoolRide'] = $data_trips[0]['ePoolRide'];
            $result[0]['eServiceLocation'] = $data_trips[0]['eServiceLocation'];
            //Added By HJ On 24-06-2020 For Optimization trips Table Query End
            //$sql = "SELECT CONCAT(rd.vName,' ',rd.vLastName) AS driverName, tr.vRideNo, tr.tEndLat,tr.tEndLong,tr.tDaddress,tr.iUserId,tr.eType,rd.iTripId,tr.eTollSkipped,tr.eBeforeUpload,tr.eAfterUpload,tr.ePoolRide, tr.eServiceLocation FROM trips as tr,register_driver as rd WHERE tr.iTripId=rd.iTripId AND rd.iDriverId = '" . $iDriverId . "'";
            //$result = $obj->MySQLSelect($sql);
            $returnArr['Action'] = "1";
            /* move down to up */
            $tableName = "register_user";
            $iMemberId_VALUE = $result[0]['iUserId'];
            $iMemberId_KEY = "iUserId";
            //Added By HJ On 24-06-2020 For Optimization register_user Table Query Start
            if (isset($userDetailsArr[$tableName . '_' . $iMemberId_VALUE])) {
                $AppData = $userDetailsArr[$tableName . '_' . $iMemberId_VALUE];
            } else {
                $AppData = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tableName . " WHERE iUserId='" . $iMemberId_VALUE . "'");
                $userDetailsArr[$tableName . '_' . $iMemberId_VALUE] = $AppData;
            }
            //Added By HJ On 24-06-2020 For Optimization register_user Table Query End
            //$AppData = get_value($tableName, 'iAppVersion,eDeviceType,iGcmRegId,vLang', $iMemberId_KEY, $iMemberId_VALUE);
            $iAppVersion = $AppData[0]['iAppVersion'];
            $eDeviceType = $AppData[0]['eDeviceType'];
            $iGcmRegId = $AppData[0]['iGcmRegId'];
            $vLangCode = $AppData[0]['vLang'];
            $tSessionId = $AppData[0]['tSessionId'];
            $eAppTerminate = $AppData[0]['eAppTerminate'];
            $eDebugMode = $AppData[0]['eDebugMode'];
            $eHmsDevice = $AppData[0]['eHmsDevice'];
            if(strtoupper($eDeviceType) == "IOS") {
                $tDeviceLiveActivityToken = getLiveActivityDeviceToken($driverTripId, 'Trip');
            } else {
                $tDeviceLiveActivityToken = $iGcmRegId;
            }
            /* For PubNub Setting Finished */
            if ($vLangCode == "" || $vLangCode == NULL) {
                //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
                $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
            $driverArrivedLblValue = $languageLabelsArr['LBL_DRIVER_ARRIVED_NOTIMSG'];
            $driverArrivedLblValue_delivery = $languageLabelsArr['LBL_CARRIER_ARRIVED_NOTIMSG'];
            $driverArrivedLblValue_ride = $languageLabelsArr['LBL_DRIVER_ARRIVED_TXT'];
            //$tSessionId = get_value("register_user", 'tSessionId', "iUserId", $result[0]['iUserId'], '', 'true');
            $message = "";
            $message_arr['Message'] = "DriverArrived";
            $message_arr['MsgType'] = "DriverArrived";
            $message_arr['iDriverId'] = $iDriverId;
            $message_arr['driverName'] = $result[0]['driverName'];
            $message_arr['tSessionId'] = $tSessionId;
            $message_arr['vRideNo'] = $result[0]['vRideNo'];
            $message_arr['iTripId'] = $result[0]['iTripId'];
            $message_arr['eType'] = $result[0]['eType'];
            $eType = $result[0]['eType'];
            $alertMsg = $driverArrivedLblValue_ride;
            if ($eType == "UberX") {
                if ($result[0]['eServiceLocation'] == "Driver") {
                    $driverArrivedLblValue = $languageLabelsArr['LBL_USER_ARRIVED_PROVIDER_LOC_NOTIMSG'];
                }
                $alertMsg = $languageLabelsArr['LBL_PROVIDER'] . ' ' . $result[0]['driverName'] . ' ' . $driverArrivedLblValue . $result[0]['vRideNo'];
            } else if ($eType == "Deliver") {
                $alertMsg = $languageLabelsArr['LBL_CARRIER'] . ' ' . $result[0]['driverName'] . ' ' . $driverArrivedLblValue_delivery;
            } else if ($eType == "Multi-Delivery") {
                $alertMsg = $languageLabelsArr['LBL_CARRIER'] . ' ' . $result[0]['driverName'] . ' ' . $driverArrivedLblValue . $result[0]['vRideNo'];
            }
            $message_arr['vTitle'] = $alertMsg;
            $message_arr['eSystem'] = "";
            /* move down to up */
            if (isset($result[0]['iTripId']) && $result[0]['iTripId'] != "") {
                //Added By HJ On 22-09-2020 For Change Payment Mode Cash If Payment Flow 2 OR 3 and eType= Multi-Delivery and Partial Payment Start
                $iFare = $data_trips[0]['iFare'];
                $where1 = " iTripId = '" . $result[0]['iTripId'] . "'";
                $DataUpdate_trips_arrive = array();
                $DataUpdate_trips_arrive['eDriverArrived'] = "Yes";
                $DataUpdate_trips_arrive['iActive'] = "Arrived";
                $obj->MySQLQueryPerform("trips", $DataUpdate_trips_arrive, 'update', $where1);
                // if (($SYSTEM_PAYMENT_FLOW == "Method-2" || $SYSTEM_PAYMENT_FLOW == "Method-3") && $iFare > 0 && $eType == "Multi-Delivery") {
                if ($data_trips[0]['vTripPaymentMode'] == "Wallet" && $iFare > 0 && $eType == "Multi-Delivery") {
                    $DataUpdate_trips_arrive = array();
                    $DataUpdate_trips_arrive['vTripPaymentMode'] = "Cash";
                    if ($result[0]['ePoolRide'] == "Yes") {
                        $DataUpdate_trips_arrive['eAskCodeToUser'] = "No";
                    }
                    $obj->MySQLQueryPerform("trips", $DataUpdate_trips_arrive, 'update', $where1);
                }
                //Added By HJ On 22-09-2020 For Change Payment Mode Cash If Payment Flow 2 OR 3 and eType= Multi-Delivery and Partial Payment End
                if (strtoupper(PACKAGE_TYPE) == "SHARK") {
                    configureTripForArriveStatus();
                } else {
                    $DataUpdate_trips_arrive = array();
                    $DataUpdate_trips_arrive['tDriverArrivedDate'] = date('Y-m-d H:i:s');
                    if ($result[0]['ePoolRide'] == "Yes") {
                        $DataUpdate_trips_arrive['eAskCodeToUser'] = "No";
                    }
                    $obj->MySQLQueryPerform("trips", $DataUpdate_trips_arrive, 'update', $where1);
                }
                $tripUserId = $result[0]['iUserId'];
                $where_user = " iUserId = '$tripUserId'";
                $Data_update_passenger['dSendverificationDateEmergency'] = "0000-00-00 00:00:00";
                $Data_update_passenger['vVerificationCountEmergency'] = 0;
                $User_Update_id = $obj->MySQLQueryPerform("register_user", $Data_update_passenger, 'update', $where_user);
            }
            $data['DLatitude'] = $data['DLongitude'] = $data['DAddress'] = "0";
            if ($result[0]['tEndLat'] != '' && $result[0]['tEndLong'] != '') {
                $data['DLatitude'] = $result[0]['tEndLat'];
                $data['DLongitude'] = $result[0]['tEndLong'];
                $data['DAddress'] = $result[0]['tDaddress'];
            }
            $data['eTollSkipped'] = $result[0]['eTollSkipped'];
            $data['eBeforeUpload'] = $result[0]['eBeforeUpload'];
            $data['eAfterUpload'] = $result[0]['eAfterUpload'];
            $returnArr['message'] = $data;
            $deviceTokens_arr_ios = $registation_ids_new = array();
            //added by SP on 17-02-2021 for custom notification
            $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
            //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
            $message_arr['CustomViewBtn'] = "Yes";
            $message_arr['CustomTrackDetails'] = "No";
            $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
            $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
            $customNotiArray = GetCustomNotificationDetails($result[0]['iTripId'], $message_arr['vTitle'], $vLangCode);
            //title and sub description shown in custom notification
            $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
            $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
            $message_arr['CustomMessage'] = $customNotiArray;

            $message_arr['tRandomCode'] = time();
            $channelName = "PASSENGER_" . $result[0]['iUserId'];

            $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName, 'tripStatusMsgArr' => array('tMessage' => $message_arr, 'iDriverId' => $iDriverId, 'iTripId' => $result[0]['iTripId'], 'iUserId' => $result[0]['iUserId'], 'eFromUserType' => "Driver", 'eToUserType' => "Passenger", 'eReceived' => "No",));

            $message_arr['tRandomCode'] = mt_rand(100,999) . time();

            if(strtoupper($ENABLE_NOTIFICATION_LIVE_ACTIVITY) == "YES") {
                $message_arr['LiveActivityData'] = getTripLiveActivity($iTripId);
                $message_arr['LiveActivity'] = "Yes";

                $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $tDeviceLiveActivityToken, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr);
            }

            $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
            $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId);
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "StartTrip") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $TripID = isset($_REQUEST["TripID"]) ? $_REQUEST["TripID"] : '';
    $image_name = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    $iTripDeliveryLocationId = isset($_REQUEST["iTripDeliveryLocationId"]) ? $_REQUEST["iTripDeliveryLocationId"] : '';
    $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
    $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
    // Added by HV on 17-10-2020 for Face Mask Verification feature
    $vFaceMaskVerifyImage_name = isset($_FILES['vFaceMaskVerifyImage']['name']) ? $_FILES['vFaceMaskVerifyImage']['name'] : '';
    $vFaceMaskVerifyImage_object = isset($_FILES['vFaceMaskVerifyImage']['tmp_name']) ? $_FILES['vFaceMaskVerifyImage']['tmp_name'] : '';
    if ($image_object) {
        ExifCleaning::adjustImageOrientation($image_object);
    }
    if ($vFaceMaskVerifyImage_object) {
        ExifCleaning::adjustImageOrientation($vFaceMaskVerifyImage_object);
    }
    $startDateOfTrip = @date("Y-m-d H:i:s");
    //Added By HJ On 02-07-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr['register_user_' . $iUserId])) {
        $userData = $userDetailsArr['register_user_' . $iUserId];
    } else {
        $userData = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr['register_user_' . $iUserId] = $userData;
    }
    //Added By HJ On 02-07-2020 For Optimize register_user Table Query End
    $vLangCode = $userData[0]['vLang'];
    //$vLangCode = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 02-07-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 02-07-2020 For Optimize language_master Table Query End
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $tripstartlabel = $languageLabelsArr['LBL_DRIVER_START_NOTIMSG'];
    $tripstartlabel_ride = $languageLabelsArr['LBL_START_TRIP_DIALOG_TXT'];
    $tripstartlabel_delivery = $languageLabelsArr['LBL_START_DELIVERY_DIALOG_TXT'];
    $message = "TripStarted";
    //Added By HJ On 02-07-2020 For Optimize register_driver Table Query Start
    if (isset($userDetailsArr['register_driver_' . $iDriverId])) {
        $result22 = $userDetailsArr['register_driver_' . $iDriverId];
    } else {
        $result22 = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='" . $iDriverId . "'");
        $userDetailsArr['register_driver_' . $iDriverId] = $result22;
    }
    $iTripId = $result22[0]['iTripId'];
    //Added By HJ On 02-07-2020 For Optimize register_driver Table Query Start
    //Added By HJ On 02-07-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $iTripId])) {
        $tripData = $tripDetailsArr['trips_' . $iTripId];
    } else {
        $tripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $iTripId . "'");
        $tripDetailsArr['trips_' . $iTripId] = $tripData;
    }
    //Added By HJ On 02-07-2020 For Optimize trips Table Query End
    $result22[0]['driverName'] = $result22[0]['vName'] . ' ' . $result22[0]['vLastName'];
    $result22[0]['vRideNo'] = $tripData[0]['vRideNo'];
    //$sql = "SELECT CONCAT(rd.vName,' ',rd.vLastName) AS driverName, tr.vRideNo FROM trips as tr,register_driver as rd WHERE tr.iTripId=rd.iTripId AND rd.iDriverId = '" . $iDriverId . "'";
    //$result22 = $obj->MySQLSelect($sql);
    //$verificationCode = rand(10000000, 99999999);
    $verificationCode = generateCommonRandom();
    //Added By HJ On 02-07-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $TripID])) {
        $TripData = $tripDetailsArr['trips_' . $TripID];
    } else {
        $TripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $TripID . "'");
        $tripDetailsArr['trips_' . $TripID] = $TripData;
    }
    //Added By HJ On 02-07-2020 For Optimize trips Table Query End
    //$TripData = get_value('trips', 'eType,fVisitFee,eFareType,iRunningTripDeliveryNo,tStartDate', 'iTripId', $TripID);
    $eType = $TripData[0]['eType'];
    $tStartDate = $TripData[0]['tStartDate'];
    $fVisitFee = $TripData[0]['fVisitFee'];
    $eFareType = $TripData[0]['eFareType'];
    $iRunningTripDeliveryNo = $TripData[0]['iRunningTripDeliveryNo'];
    $iRunningTripDeliveryNo = $iRunningTripDeliveryNo + 1;
    if ($DELIVERY_VERIFICATION_METHOD != "Code" && $eType == "Deliver") {
        $message_verificationCode = "";
    } else {
        //$verificationCode = rand ( 10000000 , 99999999 );
        $message_verificationCode = $verificationCode;
    }
    if ($eType == "UberX") {
        $alertMsg = $languageLabelsArr['LBL_PROVIDER'] . ' ' . $result22[0]['driverName'] . ' ' . $tripstartlabel . $result22[0]['vRideNo'];
    } else if ($eType == "Ride") {
        $alertMsg = $tripstartlabel_ride;
    } else {
        $alertMsg = $tripstartlabel_delivery;
    }
    //Added By HJ On 02-07-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr['register_user_' . $iUserId])) {
        $result = $userDetailsArr['register_user_' . $iUserId];
    } else {
        $result = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr['register_user_' . $iUserId] = $result;
    }
    //Added By HJ On 02-07-2020 For Optimize register_user Table Query End
    //$sql = "SELECT iGcmRegId,eDeviceType,iTripId,tLocationUpdateDate,eLogout,tSessionId FROM register_user WHERE iUserId='$iUserId'";
    //$result = $obj->MySQLSelect($sql);
    $message_arr = array();
    $message_arr['Message'] = $message;
    $message_arr['MsgType'] = $message;
    $message_arr['iDriverId'] = $iDriverId;
    $message_arr['iTripId'] = $TripID;
    $message_arr['driverName'] = $result22[0]['driverName'];
    $message_arr['tSessionId'] = $result[0]['tSessionId'];
    $message_arr['vRideNo'] = $result22[0]['vRideNo'];
    $message_arr['VerificationCode'] = "";
    if ($eType == "Deliver") {
        $message_arr['VerificationCode'] = strval($verificationCode);
    } else if ($eType == "Multi-Delivery") {
        $msgarr = gettexttripdeliverydetails($TripID, "Passenger", "Starttrip");
        $message_arr['iTripDeliveryLocationId'] = $msgarr['iTripDeliveryLocationId'];
        $message_arr['vTitle'] = $msgarr['Delivery_Start_Txt'];
        $alertMsg = $msgarr['Delivery_Start_Txt'];
        $message_arr['VerificationCode'] = ($DELIVERY_VERIFICATION_METHOD == "Code") ? strval($verificationCode) : "";
    }
    $message_arr['vTitle'] = $alertMsg;
    $message_arr['eType'] = $eType;
    $message_arr['eSystem'] = "";
    //Update passenger Table
    $where = " iUserId = '$iUserId'";
    if ($APP_TYPE == "Ride-Delivery-UberX" && $eType != "UberX" && $eType != "Multi-Delivery") { // $eType != "Multi-Delivery" Condition Added By HJ On 26-12-2019 As Per Discuss with KS Sir For Solved Sheet Bug - 687
        $Data_update_passenger['vTripStatus'] = 'On Going Trip';
    } else if ($eType != "Multi-Delivery" && $eType != "UberX") {
        $Data_update_passenger['vTripStatus'] = 'On Going Trip';
    }
    $Data_update_passenger['dSendverificationDateEmergency'] = "0000-00-00 00:00:00";
    $Data_update_passenger['vVerificationCountEmergency'] = 0;
    $id = $obj->MySQLQueryPerform("register_user", $Data_update_passenger, 'update', $where);
    //Update Driver Table
    $where = " iDriverId = '$iDriverId'";
    $Data_update_driver['vTripStatus'] = 'On Going Trip';
    $Data_update_driver['dSendverificationDateEmergency'] = "0000-00-00 00:00:00";
    $Data_update_driver['vVerificationCountEmergency'] = 0;
    $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
    $TRIP_CONTINUE = "No";
    if ($eType == "Multi-Delivery") {
        $sql = "SELECT count(iTripDeliveryLocationId) AS TotalTripDelivery FROM `trips_delivery_locations` WHERE iActive='Finished'  AND iTripId='" . $TripID . "'";
        $TotalTripDeliveryData = $obj->MySQLSelect($sql);
        $TotalTripDelivery = $TotalTripDeliveryData[0]['TotalTripDelivery'];
        if ($TotalTripDelivery > 0) {
            $TRIP_CONTINUE = "Yes";
        }
    }
    //update insurance log
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        if ($TRIP_CONTINUE == "No") {
            $details_arr['iTripId'] = $TripID;
            $details_arr['LatLngArr']['vLatitude'] = $vLatitude;
            $details_arr['LatLngArr']['vLongitude'] = $vLongitude;
            // $details_arr['LatLngArr']['vLocation'] = $Source_point_Address;
            update_driver_insurance_status($iDriverId, "Trip", $details_arr, "StartTrip");
        }
    }
    //update insurance log
    # Check Active trip delivery and update Status of Trip Delivery #
    if ($eType == "Multi-Delivery") {
        $sqldeliverydata = "SELECT * FROM `trips_delivery_locations` WHERE iActive='Active'  AND iTripId='" . $TripID . "' ORDER BY iTripDeliveryLocationId ASC LIMIT 0,1";
        $TripDeliveryData = $obj->MySQLSelect($sqldeliverydata);
        if (count($TripDeliveryData) > 0) {
            $iTripDeliveryLocationId = $TripDeliveryData[0]['iTripDeliveryLocationId'];
            $Data_update_trip_delivery['iActive'] = 'On Going Trip';
            $Data_update_trip_delivery['tStartTime'] = $startDateOfTrip;
            $Data_update_trip_delivery['vDeliveryConfirmCode'] = $verificationCode;
            $where_trip_delivery = " iTripDeliveryLocationId = '$iTripDeliveryLocationId'";
            $Data_update_trip_delivery_id = $obj->MySQLQueryPerform("trips_delivery_locations", $Data_update_trip_delivery, 'update', $where_trip_delivery);
        }
    }
    # Check Active trip delivery and update Status of Trip Delivery #
    // $Curr_TripID=$result[0]['iTripId'];
    $where = " iTripId = '$TripID'";
    $Data_update_trips['iActive'] = 'On Going Trip';
    if ($tStartDate == "0000-00-00 00:00:00") {
        $Data_update_trips['tStartDate'] = $startDateOfTrip;
    }
    $Data_update_trips['iRunningTripDeliveryNo'] = $iRunningTripDeliveryNo;
    /* Code for Upload StartImage of trip Start */
    if ($image_name != "") {
        //$Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path']."/".$TripID."/";
        $Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path'];
        if (!is_dir($Photo_Gallery_folder)) {
            mkdir($Photo_Gallery_folder, 0777);
            chmod($Photo_Gallery_folder, 0777);
        }
        $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $image_name, $prefix = '', $vaildExt = "pdf,doc,docx,jpg,jpeg,gif,png");
        $vImageName = $vFile[0];
        $Data_update_trips['vBeforeImage'] = $vImageName;
    }
    /* Code for Upload StartImage of trip End */
    /* Added by HV on 17-10-2020 for Face Mask Verification Feature */
    if ($vFaceMaskVerifyImage_name != "") {
        //$Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path']."/".$TripID."/";
        $Photo_Gallery_folder = $tconfig['tsite_upload_face_mask_verify_images_path'];
        if (!is_dir($Photo_Gallery_folder)) {
            mkdir($Photo_Gallery_folder, 0777);
            chmod($Photo_Gallery_folder, 0777);
        }
        $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $vFaceMaskVerifyImage_object, $vFaceMaskVerifyImage_name, $prefix = '', $vaildExt = "pdf,doc,docx,jpg,jpeg,gif,png");
        $vImageName = $vFile[0];
        $Data_update_trips['vFaceMaskVerifyImage'] = $vImageName;
    }
    /* Added by HV on 17-10-2020 for Face Mask Verification Feature End */
    $Data_update_trips['eAskCodeToUser'] = "No";
    $id = $obj->MySQLQueryPerform("trips", $Data_update_trips, 'update', $where);
    if ($id > 0) {
        $returnArr['Action'] = "1";
        $returnArr['fVisitFee'] = $fVisitFee;
        /* For PubNub Setting */
        $tableName = "register_user";
        $iMemberId_VALUE = $iUserId;
        $iMemberId_KEY = "iUserId";
        //$AppData = get_value($tableName, 'iAppVersion,eDeviceType', $iMemberId_KEY, $iMemberId_VALUE);
        $iAppVersion = $result[0]['iAppVersion'];
        $eDeviceType = $result[0]['eDeviceType'];
        $eAppTerminate = $result[0]['eAppTerminate'];
        $eDebugMode = $result[0]['eDebugMode'];
        $eHmsDevice = $result[0]['eHmsDevice'];
        $iGcmRegId = $result[0]['iGcmRegId'];
        
        if(strtoupper($eDeviceType) == "IOS") {
            $tDeviceLiveActivityToken = getLiveActivityDeviceToken($TripID, 'Trip');
        } else {
            $tDeviceLiveActivityToken = $iGcmRegId;
        }
        /* For PubNub Setting Finished */
        $cmpMinutes = ceil((fetchtripstatustimeMAXinterval() + $intervalmins) / 60);
        $compare_date = @date('Y-m-d H:i:s', strtotime('-' . $cmpMinutes . ' minutes'));
        //$alertSendAllowed = false;
        $alertSendAllowed = true;
        //$message = $alertMsg;
        $tLocUpdateDate = date("Y-m-d H:i:s", strtotime($result[0]['tLocationUpdateDate']));
        //added by SP on 17-02-2021 for custom notification
        $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
        //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
        $message_arr['CustomViewBtn'] = "Yes";
        $message_arr['CustomTrackDetails'] = "No";
        $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
        $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
        $customNotiArray = GetCustomNotificationDetails($TripID, $message_arr['vTitle'], $vLangCode);
        //title and sub description shown in custom notification
        $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
        $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
        $message_arr['CustomMessage'] = $customNotiArray;
        $message_arr['tSessionId'] = $result[0]['tSessionId'];
        $channelName = "PASSENGER_" . $iUserId;
        $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName, 'tripStatusMsgArr' => array('tMessage' => $message_arr, 'iDriverId' => $iDriverId, 'iTripId' => $TripID, 'iUserId' => $iUserId, 'eFromUserType' => "Driver", 'eToUserType' => "Passenger", 'eReceived' => "No",));

        if(strtoupper($ENABLE_NOTIFICATION_LIVE_ACTIVITY) == "YES") {
            $message_arr['LiveActivityData'] = getTripLiveActivity($iTripId);
            $message_arr['LiveActivity'] = "Yes";

            $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $tDeviceLiveActivityToken, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr);
        }

        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
        // Send SMS to receiver if trip type is delivery.
        if ($eType == "Deliver" || $eType == "Multi-Delivery") {
            //$vPhoneCode = get_value('register_user', 'vPhoneCode', 'iUserId', $iUserId, '', 'true');
            $vPhoneCode = $result[0]['vPhoneCode'];
            //$receiverMobile = get_value('trips', 'vReceiverMobile', 'iTripId', $TripID, '', 'true');
            $receiverMobile = $TripData[0]['vReceiverMobile'];
            $receiverMobile1 = "+" . $receiverMobile;
            $where_trip_update = " iTripId = '$TripID'";
            $data_delivery['vDeliveryConfirmCode'] = $verificationCode;
            $obj->MySQLQueryPerform("trips", $data_delivery, 'update', $where_trip_update);
            if ($eType == "Multi-Delivery") {
                $sql = "SELECT iTripDeliveryLocationId FROM `trips_delivery_locations` WHERE iTripId = '$TripID'";
                $Data_delivery_locations = $obj->MySQLSelect($sql);
                $sql = "select vValue from trip_delivery_fields where iDeliveryFieldId='3' and iTripId = '$TripID' and iTripDeliveryLocationId='$iTripDeliveryLocationId'";
                $Data_delivery_values = $obj->MySQLSelect($sql);
                $receiverMobile = $Data_delivery_values[0]['vValue'];
                //$receiverMobile1 = "+".$vPhoneCode.$Data_delivery_values[0]['vValue'];
                $receiverMobile1 = "+" . $Data_delivery_values[0]['vValue'];
            }
            $message_deliver = deliverySmsToReceiver($TripID, $iTripDeliveryLocationId);
            //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019 start
            $vCountry = $result[0]['vCountry'];
            if (isset($country_data_arr[$vCountry])) {
                $PhoneCode = $country_data_arr[$vCountry]['vPhoneCode'];
            } else {
                $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM  `register_user` AS r, `country` AS c WHERE r.iUserId = $iUserId AND r.vCountry = c.vCountryCode");
                $PhoneCode = $passengerData[0]['vPhoneCode'];
            }
            //$passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM  `register_user` AS r, `country` AS c WHERE r.iUserId = $iUserId AND r.vCountry = c.vCountryCode");
            //$PhoneCode = $passengerData[0]['vPhoneCode'];
            $result = $COMM_MEDIA_OBJ->SendSystemSMS($receiverMobile1, $PhoneCode, $message_deliver);
            //added by SP for sms functionality change, to get phonecode use this one on 12-7-2019 end
            $returnArr['message'] = $verificationCode;
            $returnArr['SITE_TYPE'] = SITE_TYPE;
        }

        $returnArr['iTripTimeId'] = '';
        if ($eFareType == 'Hourly') {
            $dTime = date('Y-m-d H:i:s');
            $Data_update['dResumeTime'] = $dTime;
            $Data_update['iTripId'] = $TripID;
            $id = $obj->MySQLQueryPerform("trip_times", $Data_update, 'insert');
            $returnArr['iTripTimeId'] = $id;
        }

        $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "ProcessEndTrip") {

    $tripId = isset($_REQUEST["TripId"]) ? $_REQUEST["TripId"] : '';
    $userId = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
    $driverId = isset($_REQUEST["DriverId"]) ? $_REQUEST["DriverId"] : '';
    $latitudes = isset($_REQUEST["latList"]) ? $_REQUEST["latList"] : '';
    $longitudes = isset($_REQUEST["lonList"]) ? $_REQUEST["lonList"] : '';
    $tripDistance = isset($_REQUEST["TripDistance"]) ? $_REQUEST["TripDistance"] : '0';
    $dAddress = isset($_REQUEST["dAddress"]) ? $_REQUEST["dAddress"] : '';
    // $currentCity= isset($_REQUEST["currentCity"]) ? $_REQUEST["currentCity"] : '';
    $destination_lat = isset($_REQUEST["dest_lat"]) ? $_REQUEST["dest_lat"] : '';
    $destination_lon = isset($_REQUEST["dest_lon"]) ? $_REQUEST["dest_lon"] : '';
    $isTripCanceled = isset($_REQUEST["isTripCanceled"]) ? $_REQUEST["isTripCanceled"] : '';
    $driverComment = isset($_REQUEST["Comment"]) ? $_REQUEST["Comment"] : '';
    $driverReason = isset($_REQUEST["Reason"]) ? $_REQUEST["Reason"] : '';
    $image_name = $vImage = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    $fMaterialFee = isset($_REQUEST["fMaterialFee"]) ? $_REQUEST["fMaterialFee"] : 0;
    $fMiscFee = isset($_REQUEST["fMiscFee"]) ? $_REQUEST["fMiscFee"] : 0;
    $fDriverDiscount = isset($_REQUEST["fDriverDiscount"]) ? $_REQUEST["fDriverDiscount"] : 0;
    $iTripTimeId = isset($_REQUEST["iTripTimeId"]) ? $_REQUEST["iTripTimeId"] : '';
    $iCancelReasonId = isset($_REQUEST["iCancelReasonId"]) ? $_REQUEST["iCancelReasonId"] : '';
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
    $vConfirmationCode = isset($_REQUEST["vConfirmationCode"]) ? $_REQUEST["vConfirmationCode"] : '';
    $fOtherCharges = isset($_REQUEST["fOtherCharges"]) ? $_REQUEST["fOtherCharges"] : 0;
    $fTollPrice = isset($_REQUEST["fTollPrice"]) ? $_REQUEST["fTollPrice"] : 0;
    $isUpdateAddress = isset($_REQUEST["isUpdateAddress"]) ? $_REQUEST["isUpdateAddress"] : "Yes";

    if(empty($fMaterialFee)) {
        $fMaterialFee = 0;
    }
    if(empty($fMiscFee)) {
        $fMiscFee = 0;
    }
    if(empty($fDriverDiscount)) {
        $fDriverDiscount = 0;
    }
    if(empty($fTollPrice)) {
        $fTollPrice = 0;
    }
    if(empty($fOtherCharges)) {
        $fOtherCharges = 0;
    }
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
    //Added By HJ On 22-06-2020 For Optimize register_driver Table Query Start
    if (isset($userDetailsArr['register_driver_' . $driverId])) {
        $vCurrencyDriver = $userDetailsArr['register_driver_' . $driverId][0]['vCurrencyDriver'];
    } else {
        $vCurrencyDriver = get_value('register_driver', 'vCurrencyDriver', 'iDriverId', $driverId, '', 'true');
    }
    if (isset($currencyAssociateArr[$vCurrencyDriver])) {
        $DriverRation = $currencyAssociateArr[$vCurrencyDriver]['Ratio'];
        $currencySymbolDriver = $currencyAssociateArr[$vCurrencyDriver]['vSymbol'];
    } else {
        $DriverRation = $vSystemDefaultCurrencyRatio;
        $currencySymbolDriver = $vSystemDefaultCurrencySymbol;
        $getCurrencyData = $obj->MySQLSelect("SELECT Ratio,vSymbol FROM currency WHERE vName='" . $vCurrencyDriver . "'");
        if (count($getCurrencyData) > 0) {
            $DriverRation = $getCurrencyData[0]['Ratio'];
            $currencySymbolDriver = $getCurrencyData[0]['vSymbol'];
        }
    }
    //Added By HJ On 22-06-2020 For Optimize register_driver Table Query End
    if ($image_object) {
        ExifCleaning::adjustImageOrientation($image_object);
    }
    //$exifDATA = exif_read_data($image_object, 0, true);
    ## Check Service End For UberX Trip ###
    //Added By HJ On 22-06-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $tripId])) {
        $UberXTripData = $tripDetailsArr['trips_' . $tripId];
    } else {
        $UberXTripData = $obj->MySQLSelect("SELECT *,fRatio_" . $vCurrencyDriver . " as fRatioDriver FROM trips WHERE iTripId='" . $tripId . "'");
        $tripDetailsArr['trips_' . $tripId] = $UberXTripData;
    }
    /*----------------------Comission Change---------------*/
    $isVideoCall = $UberXTripData[0]['isVideoCall'];

    if (strtoupper($UberXTripData[0]['eType']) == 'UBERX' && $isVideoCall == 'No') {
        $TripId = $tripId;
        $currencyratioDriver = $DriverRation;
        $currencyvNameDriver = $vCurrencyDriver;
        $tVehicle_TypeFare_Data = json_decode($UberXTripData[0]['tVehicleTypeFareData'], true);
        $vChargesDetailData = json_decode($UberXTripData[0]['vChargesDetailData'], true);
        $fDriverDiscountDefaultCurrency = setTwoDecimalPoint($fDriverDiscount / $currencyratioDriver);
        $tripData = $UberXTripData;
        if (!isset($vChargesDetailData) && empty($vChargesDetailData)) {
            $vChargesDetailData = '';
        }
        if($UberXTripData[0]['isVideoCall'] == "No") {
            getValidDiscountForTrip($tVehicle_TypeFare_Data, $vChargesDetailData);
        }
    }
    /*----------------------Comission Change---------------*/
    //Added By HJ On 22-06-2020 For Optimize trips Table Query End
    //$UberXTripData = get_value('trips', 'eServiceEnd,eType,tEndDate,vCancelReason,vCancelComment,eCancelled,eCancelledBy,tEndLat,tEndLong,tDaddress,vAfterImage,eFareType,iCancelReasonId,ePoolRide,iPersonSize,iVehicleTypeId,fPoolDuration,fPoolDistance,eServiceLocation,tVehicleTypeData,tStartLat,tStartLong', 'iTripId', $tripId);
    $eType = $UberXTripData[0]['eType'];
    $eServiceEnd = $UberXTripData[0]['eServiceEnd'];
    $UberXtripEndDate = $UberXTripData[0]['tEndDate'];
    $ePoolRide = $UberXTripData[0]['ePoolRide'];
    $iPersonSize = $UberXTripData[0]['iPersonSize'];
    $iVehicleTypeId = $UberXTripData[0]['iVehicleTypeId'];
    //Added By HJ On 22-07-2019 For Get Pickup Airport Sircharge Value Start
    $tStartLat = $UberXTripData[0]['tStartLat'];
    $tStartLong = $UberXTripData[0]['tStartLong'];
    //Added By HJ On 22-07-2019 For Get Pickup Airport Sircharge Value End
    $iFromStationId = $UberXTripData[0]['iFromStationId'];
    $iToStationId = $UberXTripData[0]['iToStationId'];
    $isVideoCall = $UberXTripData[0]['isVideoCall'];
    $eTollSkipped = $UberXTripData[0]['eTollSkipped'];
    $eBookingFrom = $UberXTripData[0]['eBookingFrom'];
    /* ============STARTSTOPPOINT============= */
    /* stop over point drop and check other stop */
    if ($MODULES_OBJ->checkStopOverPointModule() && $eType == 'Ride') {
        addActualStopOverPoint();
        dropStopOverPoint();
    }
    /* ============ENDSTOPPOINT============= */
    // add airport surge //
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        if ($ENABLE_AIRPORT_SURCHARGE_SECTION == 'Yes' && $eType != "UberX") {
            $Data_update_trips = $pickuplocationarr = array();
            $dropofflocationarr = array($destination_lat, $destination_lon);
            $pickuplocationarr = array($tStartLat, $tStartLong); // Added By HJ On 22-07-2019 As Per Discuss With KS
            $GetVehicleIdfromGeoLocation = CheckSurgeAirportFromGeoLocation($pickuplocationarr, $dropofflocationarr, $iVehicleTypeId);
            $fdropoffsurchargefare = $fpickupsurchargefare = 0;
            if (isset($GetVehicleIdfromGeoLocation['fdropoffsurchargefare']) && $GetVehicleIdfromGeoLocation['fdropoffsurchargefare'] > 0) {
                $fdropoffsurchargefare = $GetVehicleIdfromGeoLocation['fdropoffsurchargefare'];
            }
            $Data_update_trips['fAirportDropoffSurge'] = $fdropoffsurchargefare;
            // Added By HJ On 22-07-2019 As Per Discuss With KS Start
            if (isset($GetVehicleIdfromGeoLocation['fpickupsurchargefare']) && $GetVehicleIdfromGeoLocation['fpickupsurchargefare'] > 0) {
                $fpickupsurchargefare = $GetVehicleIdfromGeoLocation['fpickupsurchargefare'];
            }
            $Data_update_trips['fAirportPickupSurge'] = $fpickupsurchargefare;
            // Added By HJ On 22-07-2019 As Per Discuss With KS End
            $where = " iTripId='" . $tripId . "'";
            $obj->MySQLQueryPerform("trips", $Data_update_trips, 'update', $where);
        }
    }
    // end airport surge //
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
    $extraScreen = 0;
    //$iFromStationId,$iToStationId put by SP on 12-01-2021 because for fly, $ENABLE_MANUAL_TOLL_FEATURE is not shown
    if ((strtoupper($eType) == "RIDE" && empty($iFromStationId) && empty($iToStationId)) && (strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "YES" || strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "YES") && strtoupper($ePoolRide) == "NO") {
        $extraScreen = 1;
    }
    if ($MODULES_OBJ->isEnableVideoConsultingService() && $isVideoCall == 'Yes') {
        $Data_update_vc = array();
        $Data_update_vc['eServiceEnd'] = 'Yes';
        $Data_update_vc['iVehicleTypeId'] = 0;
        if ($UberXTripData[0]['iVehicleTypeId'] == 0) {
            $tVehicleTypeData = json_decode($UberXTripData[0]['tVehicleTypeData'], true);
            $Data_update_vc['iVehicleTypeId'] = $tVehicleTypeData[0]['iVehicleTypeId'];
        }
        $Data_update_vc['tEndDate'] = @date("Y-m-d H:i:s");
        if ($isTripCanceled == "true") {
            $Data_update_vc['vCancelReason'] = $driverReason;
            $Data_update_vc['vCancelComment'] = $driverComment;
            $Data_update_vc['eCancelled'] = "Yes";
            $Data_update_vc['eCancelledBy'] = "Driver";
            $Data_update_vc['iCancelReasonId'] = $iCancelReasonId;
            $Data_update_vc['ePaymentCollect'] = "Yes";
        }
        $where = " iTripId='" . $tripId . "'";
        $obj->MySQLQueryPerform("trips", $Data_update_vc, 'update', $where);
        $eServiceEnd = 'Yes';
        $extraScreen = 0;
    }
    if (trim($vConfirmationCode) != "" && $ENABLE_MANUAL_TOLL_VERIFICATION_METHOD == "Verification" && strtoupper($eType) == "RIDE") {
        $obj->sql_query("UPDATE trips SET eApproveByUser = 'Yes',eApproved = 'Yes' WHERE iTripId='" . $tripId . "'");
    }
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
    if ($eServiceEnd == "No" && ($eType == "UberX" || $extraScreen > 0)) {
        if ($latitudes != '' && $longitudes != '') {
            UpdateTripPositions($tripId, $latitudes, $longitudes);
        }
        $where = " iTripId='" . $tripId . "'";
        $Data_Trip_UberX = array();
        if ($isTripCanceled == "true") {
            $Data_Trip_UberX['vCancelReason'] = $driverReason;
            $Data_Trip_UberX['vCancelComment'] = $driverComment;
            $Data_Trip_UberX['eCancelled'] = "Yes";
            $Data_Trip_UberX['eCancelledBy'] = "Driver";
            $Data_Trip_UberX['iCancelReasonId'] = $iCancelReasonId;
        }
        $Data_Trip_UberX['eServiceEnd'] = "Yes";
        $Data_Trip_UberX['tEndDate'] = @date("Y-m-d H:i:s");
        if (empty($dAddress)) {
            $dAddress = getLocationNameLatLog($destination_lat, $destination_lon);
            $Data_Trip_UberX['tEndLat'] = $destination_lat;
            $Data_Trip_UberX['tEndLong'] = $destination_lon;
            $Data_Trip_UberX['tDaddress'] = $dAddress;
        }
        /* Code for Upload AfterImage of trip Start */
        if ($image_name != "") {
            //$Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path']."/".$TripID."/";
            $Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path'];
            if (!is_dir($Photo_Gallery_folder)) mkdir($Photo_Gallery_folder, 0777);
            $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $image_name, $prefix = '', $vaildExt = "pdf,doc,docx,jpg,jpeg,gif,png");
            $vImageName = $vFile[0];
            $Data_Trip_UberX['vAfterImage'] = $vImageName;
        }
        /* Code for Upload AfterImage of trip End */
        $obj->MySQLQueryPerform("trips", $Data_Trip_UberX, 'update', $where);
        $eFareType = $UberXTripData[0]['eFareType'];
        if ($eFareType == "Hourly") {
            if ($iTripTimeId == "" || $iTripTimeId == NULL) {
                $sql22 = "SELECT * FROM `trip_times` WHERE iTripId='$tripId' ORDER BY iTripTimeId DESC LIMIT 0,1";
                $db_tripTimes = $obj->MySQLSelect($sql22);
                $dPauseTime = $db_tripTimes[0]['dPauseTime'];
                if ($dPauseTime == "0000-00-00 00:00:00") {
                    $iTripTimeId = $db_tripTimes[0]['iTripTimeId'];
                }
            }
            if ($iTripTimeId != "") {
                $where_triptime = " iTripTimeId = '$iTripTimeId'";
                $Data_update['dPauseTime'] = @date("Y-m-d H:i:s");
                $Data_update['iTripId'] = $tripId;
                $Trip_Time_id = $obj->MySQLQueryPerform("trip_times", $Data_update, 'update', $where_triptime);
            }
        }
        $returnArr['Action'] = "1";
        $returnArr['USER_DATA'] = getDriverDetailInfo($driverId);
        setDataResponse($returnArr);
    } else {
        if (empty($dAddress)) {
            $where = " iTripId='" . $tripId . "'";
            $Data_Trip_UberX = array();
            $dAddress = getLocationNameLatLog($destination_lat, $destination_lon);
            $Data_Trip_UberX['tEndLat'] = $destination_lat;
            $Data_Trip_UberX['tEndLong'] = $destination_lon;
            $Data_Trip_UberX['tDaddress'] = $dAddress;
            $obj->MySQLQueryPerform("trips", $Data_Trip_UberX, 'update', $where);
        }
    }
    
    //if ($eServiceEnd == "Yes" && $eType == "UberX") {
    if ($eServiceEnd == "Yes" && ($eType == "UberX" || $extraScreen > 0)) {
        if ($isVideoCall == 'Yes' && $isTripCanceled == "true") {
            $eCancelled = "Yes";
            $eCancelledBy = "Driver";
        } else {
            $dAddress = $UberXTripData[0]['tDaddress'];
            $driverReason = $UberXTripData[0]['vCancelReason'];
            $driverComment = $UberXTripData[0]['vCancelComment'];
            $destination_lat = $UberXTripData[0]['tEndLat'];
            $destination_lon = $UberXTripData[0]['tEndLong'];
            $image_name = $UberXTripData[0]['vAfterImage'];
            $eCancelled = $UberXTripData[0]['eCancelled'];
            $iCancelReasonId = $UberXTripData[0]['iCancelReasonId'];
            $isTripCanceled = "";
            if ($eCancelled == "Yes") {
                $isTripCanceled = "true";
            }
        }
    }
    ## Check Service End For UberX Trip ###
    $fMaterialFee = setTwoDecimalPoint($fMaterialFee / $DriverRation);
    $fMiscFee = setTwoDecimalPoint($fMiscFee / $DriverRation);
    $fDriverDiscount = setTwoDecimalPoint($fDriverDiscount / $DriverRation);
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
    $fOtherCharges = setTwoDecimalPoint($fOtherCharges / $DriverRation);
    $fTollPrice = setTwoDecimalPoint($fTollPrice / $DriverRation);
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
    //$eType = get_value('trips', 'eType', 'iTripId', $tripId, '', 'true');
    //$eFareGenerated = get_value('trips', 'eFareGenerated', 'iTripId', $tripId, '', 'true');
    if (count($UberXTripData) > 0) {
        $eType = $UberXTripData[0]['eType'];
        $eFareGenerated = $UberXTripData[0]['eFareGenerated'];
    }
    $TRIP_CONTINUE = "No";
    if ($eType == "Multi-Delivery") {
        // Added By HJ On 23-06-2020 For Optimize trips_delivery_locations Table Query Start
        $totalTripDeliveryCount = 0;
        if (isset($tripDetailsArr["trips_delivery_locations_" . $tripId])) {
            $sqldeliverydata = $tripDetailsArr["trips_delivery_locations_" . $tripId];
            //$totalTripDeliveryCount = count($sqldeliverydata);
        } else {
            $sqldeliverydata = $obj->MySQLSelect("SELECT * FROM `trips_delivery_locations` WHERE iTripId='" . $tripId . "' ORDER BY  iTripDeliveryLocationId ASC");
            $tripDetailsArr["trips_delivery_locations_" . $tripId] = $sqldeliverydata;
            //$totalTripDeliveryCount = count($sqldeliverydata);
        }
        $TripDeliveryData = $tripDeliveryFieldArr = array();
        if (count($sqldeliverydata) > 0) {
            $dataFound = 0;
            for ($d = 0; $d < count($sqldeliverydata); $d++) {
                $iActiveStatus = $sqldeliverydata[$d]['iActive'];
                if ((strtoupper($iActiveStatus) == "ACTIVE" || strtoupper($iActiveStatus) == "ON GOING TRIP") && $dataFound == 0) {
                    $totalTripDeliveryCount += 1;
                }
                if ((strtoupper($iActiveStatus) == "ON GOING TRIP") && $dataFound == 0) {
                    $dataFound = 1;
                    $TripDeliveryData[] = $sqldeliverydata[$d];
                }
            }
        }
        // Added By HJ On 23-06-2020 For Optimize trips_delivery_locations Table Query End
        //$sqldeliverydata = "SELECT * FROM `trips_delivery_locations` WHERE iActive='On Going Trip' AND iTripId='" . $tripId . "' ORDER BY iTripDeliveryLocationId ASC LIMIT 0,1";
        //$TripDeliveryData = $obj->MySQLSelect($sqldeliverydata);
        if (count($TripDeliveryData) > 0) {
            $iTripDeliveryLocationId = $TripDeliveryData[0]['iTripDeliveryLocationId'];
            $Data_update_trip_delivery['iActive'] = ($isTripCanceled == 'true') ? 'Canceled' : 'Finished';
            $Data_update_trip_delivery['tEndTime'] = @date("Y-m-d H:i:s");
            /* Added by HV on 26-03-2021 when Delivery Verification Method = None */
            if (strtoupper($DELIVERY_VERIFICATION_METHOD) == "NONE") {
                $Data_update_trip_delivery['eSignVerification'] = "Yes";
            }
            /* Added by HV on 26-03-2021 when Delivery Verification Method = None End */
            $where_trip_delivery = " iTripDeliveryLocationId = '$iTripDeliveryLocationId'";
            $Data_update_trip_delivery_id = $obj->MySQLQueryPerform("trips_delivery_locations", $Data_update_trip_delivery, 'update', $where_trip_delivery);
        }
        //changed by SP on 13-01-2021 not finish multidelivery here..it will be completed in confirmdelivery after sign verification is done.so here trip continue Yes set although ends last trip.
        //$TotalTripDeliveryData = $obj->MySQLSelect("SELECT count(iTripDeliveryLocationId) AS TotalTripDelivery FROM `trips_delivery_locations` WHERE iActive IN ('On Going Trip','Active')  AND iTripId='" . $tripId . "'");
        $TotalTripDeliveryData = $obj->MySQLSelect("SELECT count(iTripDeliveryLocationId) AS TotalTripDelivery FROM `trips_delivery_locations` WHERE  iTripId='" . $tripId . "' AND iActive IN ('On Going Trip','Active','Finished') AND eSignVerification='No'");
        $TotalTripDelivery = $TotalTripDeliveryData[0]['TotalTripDelivery'];
        //$TotalTripDelivery = $totalTripDeliveryCount;
        if ($TotalTripDelivery > 0) {
            $TRIP_CONTINUE = "Yes";
        }
    }
    # Check Ongoing trip delivery and update Status of Trip Delivery #
    $Active = "On Going Trip";
    if ($TRIP_CONTINUE == "No") {
        $Active = "Finished";
    }
    if (isset($userDetailsArr['register_user_' . $userId])) {
        $getUserData = $userDetailsArr['register_user_' . $userId];
    } else {
        $getUserData = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $userId . "'");
        $userDetailsArr['register_user_' . $userId] = $getUserData;
    }
    //$vLangCode = get_value('register_user', 'vLang', 'iUserId', $userId, '', 'true');
    $tSessionId = $vLangCode = "";
    if (count($getUserData) > 0) {
        $vLangCode = $getUserData[0]['vLang'];
        $tSessionId = $getUserData[0]['tSessionId'];
    }
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 22-06-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 22-06-2020 For Optimize language_master Table Query End
    }
    //Added By HJ On 24-06-2020 For Optimize language label Table Query Start
    if (isset($languageLabelDataArr[$vLangCode])) {
        $languageLabelsArr = $languageLabelDataArr[$vLangCode];
    } else {
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "1");
        $languageLabelDataArr[$vLangCode] = $languageLabelsArr;
    }
    //Added By HJ On 24-06-2020 For Optimize language label Table Query End
    //$languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $tripcancelbydriver = $languageLabelsArr['LBL_TRIP_CANCEL_BY_DRIVER'];
    $tripfinish = $languageLabelsArr['LBL_DRIVER_END_NOTIMSG'];
    $tripfinish_ride = $languageLabelsArr['LBL_TRIP_FINISH'];
    $tripfinish_delivery = $languageLabelsArr['LBL_DELIVERY_FINISH'];
    $message_arr = array();
    $message_arr['ShowTripFare'] = "true";
    if ($isVideoCall == 'Yes' && $isTripCanceled == "true") {
        $Active = "Canceled";
        $message_arr['ShowTripFare'] = "false";
    }
    $message = "TripEnd";
    if ($isTripCanceled == "true") {
        $message = "TripCancelledByDriver";
    }
    if ($iCancelReasonId != "") {
        $driverReason = get_value('cancel_reason', "vTitle_" . $vLangCode, 'iCancelReasonId', $iCancelReasonId, '', 'true');
    }
    if (isset($userDetailsArr['register_driver_' . $driverId])) {
        $result22 = $userDetailsArr['register_driver_' . $driverId];
    } else {
        $result22 = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver iDriverId='" . $driverId . "'");
        $userDetailsArr['register_driver_' . $driverId] = $result22;
    }
    if (count($result22) > 0) {
        if (isset($tripDetailsArr['trips_' . $result22[0]['iTripId']])) {
            $tripData = $tripDetailsArr['trips_' . $result22[0]['iTripId']];
        } else {
            $tripData = $obj->MySQLSelect("SELECT * FROM trips iTripId='" . $result22[0]['iTripId'] . "'");
        }
        if (count($tripData) > 0) {
            $result22[0]['vRideNo'] = $tripData[0]['vRideNo'];
            $result22[0]['driverName'] = $result22[0]['vName'] . " " . $result22[0]['vLastName'];
        }
    }
    //$sql = "SELECT CONCAT(rd.vName,' ',rd.vLastName) AS driverName,rd.vCode,rd.vLang,tr.vRideNo FROM trips as tr,register_driver as rd WHERE tr.iTripId=rd.iTripId AND rd.iDriverId = '" . $driverId . "'";
    //$result22 = $obj->MySQLSelect($sql);
    if ($isTripCanceled == "true") {
        // $alertMsg = $tripcancelbydriver;
        if ($eType == "UberX") {
            $usercanceltriplabel = $result22[0]['driverName'] . ':' . $result22[0]['vRideNo'] . '-' . $languageLabelsArr['LBL_PREFIX_JOB_CANCEL_DRIVER'] . ' ' . $driverReason;
        } else if ($eType == "Ride") {
            $usercanceltriplabel = $languageLabelsArr['LBL_PREFIX_TRIP_CANCEL_DRIVER'] . ' ' . $driverReason;
        } else {
            $usercanceltriplabel = $languageLabelsArr['LBL_PREFIX_DELIVERY_CANCEL_DRIVER'] . ' ' . $driverReason;
        }
        $alertMsg = $usercanceltriplabel;
    } else {
        $alertMsg = $tripfinish_delivery;
        if ($eType == "UberX") {
            //$alertMsg = $tripfinish;
            $alertMsg = $result22[0]['driverName'] . " " . $tripfinish . " " . $result22[0]['vRideNo'];
        } else if ($eType == "Ride") {
            $alertMsg = $tripfinish_ride;
        }
    }
    $message_arr['Message'] = $message;
    $message_arr['iTripId'] = $tripId;
    $message_arr['iDriverId'] = $driverId;
    $message_arr['driverName'] = $result22[0]['driverName'];
    $message_arr['tSessionId'] = $tSessionId;
    $message_arr['vRideNo'] = $result22[0]['vRideNo'];
    if ($isTripCanceled == "true") {
        $message_arr['Reason'] = $driverReason;
        $message_arr['isTripStarted'] = "true";
    }
    if ($eType == "Multi-Delivery") {
        $msgarr = gettexttripdeliverydetails($tripId, "Passenger", "Processendtrip");
        $message_arr['iTripDeliveryLocationId'] = $msgarr['iTripDeliveryLocationId'];
        $message_arr['vTitle'] = $msgarr['Delivery_End_Txt'];
        $message_arr['Is_Last_Delivery'] = $msgarr['Is_Last_Delivery'];
        $alertMsg = $msgarr['Delivery_End_Txt'];
        if (strtoupper($DELIVERY_VERIFICATION_METHOD) == "NONE") {
            sendnotificationfordeliveryend($userId, $driverId, $tripId, $iServiceId, $eType);
        }
    } else {
        $message_arr['iTripDeliveryLocationId'] = 0;
        $message_arr['vTitle'] = $alertMsg;
        $message_arr['Is_Last_Delivery'] = "Yes";
    }
    // $message_arr['vTitle'] = $alertMsg;
    $message_arr['eType'] = $eType;
    $couponCode = trim($UberXTripData[0]['vCouponCode']);
    $discountValue = 0;
    $discountValueType = "cash";
    if ($couponCode != '') {
        //Added By HJ On 18-01-2019 For Check and Get Active Coupon Data Start
        $getCouponCode = $obj->MySQLSelect("SELECT fDiscount,eType FROM coupon WHERE vCouponCode='" . $couponCode . "' AND eStatus='Active'");
        if (count($getCouponCode) > 0) {
            $discountValue = $getCouponCode[0]['fDiscount'];
            $discountValueType = $getCouponCode[0]['eType'];
        }
        //Added By HJ On 18-01-2019 For Check and Get Active Coupon Data End
    }
    if ($latitudes != '' && $longitudes != '' && $eType != "UberX") {
        UpdateTripPositions($tripId, $latitudes, $longitudes);
    }
    //Added By HJ On 22-06-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $tripId])) {
        $trip_start_data_arr = $tripDetailsArr['trips_' . $tripId];
    } else {
        $trip_start_data_arr = $obj->MySQLSelect("SELECT *,fRatio_" . $vCurrencyDriver . " as fRatioDriver FROM trips WHERE iTripId='" . $tripId . "'");
        $tripDetailsArr['trips_' . $tripId] = $trip_start_data_arr;
    }
    $scheduled_trip = $obj->MySQLSelect("SELECT dBooking_date FROM cab_booking WHERE iTripId = '$tripId' ");
    $dBooking_date = "";
    if (!empty($scheduled_trip) && count($scheduled_trip) > 0) {
        $dBooking_date = $scheduled_trip[0]['dBooking_date'];
    }
    //Added By HJ On 22-06-2020 For Optimize trips Table Query End
    $tripDistance = calcluateTripDistance($tripId);
    $sourcePointLatitude = $trip_start_data_arr[0]['tStartLat'];
    $sourcePointLongitude = $trip_start_data_arr[0]['tStartLong'];
    $startDate = $trip_start_data_arr[0]['tStartDate'];
    $tDriverArrivedDate = $trip_start_data_arr[0]['tDriverArrivedDate'];
    $waiting_time_diff = strtotime($startDate) - strtotime($tDriverArrivedDate);
    if (!empty($dBooking_date)) {
        $waiting_time_diff = strtotime($startDate) - strtotime($dBooking_date);
    }
    $waitingTime = floor($waiting_time_diff / 60);
    $vehicleTypeID = $trip_start_data_arr[0]['iVehicleTypeId'];
    $eFareType = $trip_start_data_arr[0]['eFareType'];
    $eType = $trip_start_data_arr[0]['eType'];
    $eFlatTrip = $trip_start_data_arr[0]['eFlatTrip'];
    $fFlatTripPrice = $trip_start_data_arr[0]['fFlatTripPrice'];
    $eHailTrip = $trip_start_data_arr[0]['eHailTrip'];
    //$endDateOfTrip=@date("Y-m-d H:i:s");
    $endDateOfTrip = $trip_start_data_arr[0]['tEndDate'];
    if ($endDateOfTrip == "0000-00-00 00:00:00" || $eType == "Multi-Delivery") {
        $endDateOfTrip = @date("Y-m-d H:i:s");
    }
    $totalHoldTimeInMinutes_trip = 0;
    if ($eType == "UberX") {
        $endDateOfTrip = $UberXtripEndDate;
    }
    if ($TRIP_CONTINUE == "No") {
        //update insurance log
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            $details_arr['iTripId'] = $tripId;
            $details_arr['LatLngArr']['vLatitude'] = $destination_lat;
            $details_arr['LatLngArr']['vLongitude'] = $destination_lon;
            // $details_arr['LatLngArr']['vLocation'] = $Source_point_Address;
            update_driver_insurance_status($driverId, "Trip", $details_arr, "ProcessEndTrip");
        }
        //update insurance log
    }
    /* --------Added By HJ ON 28-12-2018 for hold time calculatation Start ------ */
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        if ($eType == "Ride" && $ENABLE_INTRANSIT_SHOPPING_SYSTEM == "Yes") {
            $totalHoldTimeInMinutes_trip = InTransitMinutes($tripId);
        }
    }
    /* --------Added By HJ ON 28-12-2018 for hold time calculatation End ------ */
    if ($eFareType == 'Hourly') {
        $db_tripTimes = $obj->MySQLSelect("SELECT * FROM `trip_times` WHERE iTripId='" . $tripId . "'");
        $totalSec = 0;
        $iTripTimeId = '';
        foreach ($db_tripTimes as $dtT) {
            if ($dtT['dPauseTime'] != '' && $dtT['dPauseTime'] != '0000-00-00 00:00:00') {
                $totalSec += strtotime($dtT['dPauseTime']) - strtotime($dtT['dResumeTime']);
            }
        }
        $totalTimeInMinutes_trip = @round(abs($totalSec) / 60, 2);
    } else {
        $totalTimeInMinutes_trip = @round(abs(strtotime($startDate) - strtotime($endDateOfTrip)) / 60, 2);
    }
    if ($totalTimeInMinutes_trip <= 1) {
        $FinalDistance = $tripDistance;
        $FGDTime = $FGDDistance = 0;
    } else {
        $FinalDistanceArr = getDistanceInfoFromGoogleDirections($tripDistance, $sourcePointLatitude, $sourcePointLongitude, $destination_lat, $destination_lon, "0", "", true);
        $FinalDistance = $FinalDistanceArr['Distance'];
        $FGDTime = $FinalDistanceArr['Time'];
        $FGDDistance = $FinalDistanceArr['GDistance'];
    }
    $tripDistance = $FinalDistance;
    $where = " iTripId = '" . $tripId . "'";
    if ($eFareGenerated == "No") {
        if ($ePoolRide == "Yes" && $POOL_ENABLE == "Yes") {
            $totalTimeInMinutes_trip = $UberXTripData[0]['fPoolDuration'];
            $tripDistance = $UberXTripData[0]['fPoolDistance'];
        }
        $personData = array();
        $personData['iPersonSize'] = $iPersonSize;
        $personData['ePoolRide'] = $ePoolRide;
        $personData['POOL_ENABLE'] = $POOL_ENABLE;
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        $personData['fOtherCharges'] = $fOtherCharges;
        $personData['fTollPrice'] = $fTollPrice;
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        //Added By HJ On 29-09-2020 For Fare Time and Distance Base On Fare Strategy Model Start
        $iRentalPackageId = $trip_start_data_arr[0]['iRentalPackageId'];
        $isEnableFareStrategyModule = ($MODULES_OBJ->isEnableRideFareModelStrategy()) ? "Yes" : "No";
        if (strtoupper($isEnableFareStrategyModule) == "YES" && $iRentalPackageId == 0 && strtoupper($eType) == "RIDE") {
            $fixedFareData = getFixedFareStrategyDetails($tripId, $vCurrencyDriver);
            if (isset($fixedFareData['time'])) {
                $totalTimeInMinutes_trip = $fixedFareData['time'];
            }
            if (isset($fixedFareData['distance'])) {
                $tripDistance = $fixedFareData['distance'];
            }
        }
        if ($MODULES_OBJ->isEnableVideoConsultingService() && $isVideoCall == 'Yes') {
            if ($vehicleTypeID == 0 || $vehicleTypeID == '') {
                $tVehicleTypeData = json_decode($UberXTripData[0]['tVehicleTypeData'], true);
                $vehicleTypeID = $tVehicleTypeData[0]['iVehicleTypeId'];
            }
        }
        //Added By HJ On 29-09-2020 For Fare Time and Distance Base On Fare Strategy Model End
        $Fare_data = calculateTripCost($totalTimeInMinutes_trip, $tripDistance, $vehicleTypeID, $userId, 1, $startDate, $endDateOfTrip, $couponCode, $tripId, $fMaterialFee, $fMiscFee, $fDriverDiscount, $waitingTime, $totalHoldTimeInMinutes_trip, $personData);
    }
    $Data_update_trips['tEndDate'] = $endDateOfTrip;
    //added by SP for fly stations on 31-08-2019 start bc when fly type then no need to replace following add to the current location bc user can not land in between trip
    if (empty($trip_start_data_arr[0]['iFromStationId']) && empty($trip_start_data_arr[0]['iToStationId']) && strtoupper($isUpdateAddress) == "YES") {
        $Data_update_trips['tEndLat'] = $destination_lat;
        $Data_update_trips['tEndLong'] = $destination_lon;
        $Data_update_trips['tDaddress'] = $dAddress;
    }
    //added by SP for fly stations on 31-08-2019 end
    $Data_update_trips['iActive'] = $Active;
    if ($eFareGenerated == "No") {
        $Data_update_trips['iFare'] = $Fare_data['total_fare'];
        if (isset($userDetailsArr['register_user_' . $userId])) {
            $userData = $userDetailsArr['register_user_' . $userId];
        } else {
            $userData = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='" . $userId . "'");
            $userDetailsArr['register_user_' . $userId] = $userData;
        }
        if (count($userData) > 0) {
            $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
            $currData[] = $currencyAssociateArr[$vCurrencyPassenger];
        } else {
            $currData = $obj->MySQLSelect("SELECT cu.vName, cu.iCurrencyId, cu.eRoundingOffEnable, cu.Ratio FROM register_user AS ru LEFT JOIN currency AS cu ON ru.vCurrencyPassenger = cu.vName WHERE r9u.iUserId = '" . $userId . "'");
        }
        //Added By HJ On 22-06-2020 For Optimize register_user Table Query End
        $vCurrency = $currData[0]['vName'];
        if (isset($userDetailsArr['register_driver_' . $driverId])) {
            $driverData = $userDetailsArr['register_driver_' . $driverId];
        } else {
            $driverData = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='" . $driverId . "'");
            $userDetailsArr['register_driver_' . $driverId] = $driverData;
        }
        if (count($driverData) > 0) {
            $vCurrencyDriver = $driverData[0]['vCurrencyDriver'];
            $currDatad[] = $currencyAssociateArr[$vCurrencyDriver];
        } else {
            $currDatad = $obj->MySQLSelect("SELECT cu.vName, cu.iCurrencyId, cu.eRoundingOffEnable FROM register_driver AS rd LEFT JOIN currency AS cu ON rd.vCurrencyDriver = cu.vName WHERE rd.iDriverId = '" . $driverId . "'");
        }
        $vCurrencyd = $currDatad[0]['vName'];
        if ($trip_start_data_arr[0]['vTripPaymentMode'] == "Cash" && $MODULES_OBJ->isEnableRoundingMethod()) {
            if ($eHailTrip == 'Yes') {
                if ($currDatad[0]['eRoundingOffEnable'] == "Yes") {
                    //&& $trip_start_data_arr[0]['vCurrencyPassenger']==$trip_start_data_arr[0]['vCurrencyDriver']
                    $roundingOffTotal_fare_amountArr = getRoundingOffAmount($Fare_data['total_fare'] * $DriverRation, $vCurrencyd);
                    $Data_update_trips['vCurrencyPassenger'] = $trip_start_data_arr[0]['vCurrencyDriver'];
                    $roundingOffTotal_fare_amount = $roundingOffTotal_fare_amountArr['finalFareValue'];
                    $eRoundingType = "Substraction";
                    if ($roundingOffTotal_fare_amountArr['method'] == "Addition") {
                        $eRoundingType = "Addition";
                    }
                    $fRoundingAmount = setTwoDecimalPoint($roundingOffTotal_fare_amountArr['differenceValue']);
                    //$Data_update_trips['iFare'] = setTwoDecimalPoint($roundingOffTotal_fare_amount / $priceRatio);
                    $Data_update_trips['fRoundingAmount'] = $fRoundingAmount;
                    $Data_update_trips['eRoundingType'] = $eRoundingType;
                }
            } else {
                if ($currData[0]['eRoundingOffEnable'] == "Yes" || $currDatad[0]['eRoundingOffEnable'] == "Yes") {
                    //&& $trip_start_data_arr[0]['vCurrencyPassenger']==$trip_start_data_arr[0]['vCurrencyDriver']
                    if ($currData[0]['eRoundingOffEnable'] == "No" || $currDatad[0]['eRoundingOffEnable'] == "Yes") {
                        $roundingOffTotal_fare_amountArr_driver = getRoundingOffAmount($Fare_data['total_fare'] * $DriverRation, $vCurrencyd);
                        if ($roundingOffTotal_fare_amountArr_driver['method'] == "Addition") {
                            $eRoundingTypeDriver = "Addition";
                        } else {
                            $eRoundingTypeDriver = "Substraction";
                        }
                        $fRoundingAmountDriver = setTwoDecimalPoint($roundingOffTotal_fare_amountArr_driver['differenceValue']);
                        //$Data_update_trips['iFare'] = setTwoDecimalPoint($roundingOffTotal_fare_amount / $priceRatio);
                        $Data_update_trips['fRoundingAmountDriver'] = $fRoundingAmountDriver;
                        $Data_update_trips['eRoundingTypeDriver'] = $eRoundingTypeDriver;
                    }
                    if (isset($currencyAssociateArr[$vCurrency])) {
                        $userCurrencyRatio = $currencyAssociateArr[$vCurrency]['Ratio'];
                    } else {
                        $userCurrencyRatio = get_value('currency', 'Ratio', 'vName', $vCurrency, '', 'true');
                    }
                    $roundingOffTotal_fare_amountArr = getRoundingOffAmount($Fare_data['total_fare'] * $userCurrencyRatio, $vCurrency);
                    //$userCurrencyRatio = $currData[0]['Ratio'];
                    $roundingOffTotal_fare_amount = $roundingOffTotal_fare_amountArr['finalFareValue'];
                    $eRoundingType = "Substraction";
                    if ($roundingOffTotal_fare_amountArr['method'] == "Addition") {
                        $eRoundingType = "Addition";
                    }
                    $fRoundingAmount = setTwoDecimalPoint($roundingOffTotal_fare_amountArr['differenceValue']);
                    //$Data_update_trips['iFare'] = setTwoDecimalPoint($roundingOffTotal_fare_amount / $priceRatio);
                    $Data_update_trips['fRoundingAmount'] = $fRoundingAmount;
                    $Data_update_trips['eRoundingType'] = $eRoundingType;
                }
            }
        }
        //added by SP for rounding off currency wise on 26-8-2019 end
        /*         * ** System Payment Flow Method-2 - Changing payment mode to cash if method-2 >> no need to change for method -3. For method -3 this must be goes into outstanding amount. **** */
        /* For New Payment Flow */
        // if (($SYSTEM_PAYMENT_FLOW == "Method-2" || $SYSTEM_PAYMENT_FLOW == "Method-3") && $Fare_data['total_fare'] > 0) {
        if ($trip_start_data_arr[0]['vTripPaymentMode'] == "Wallet" && $Fare_data['total_fare'] > 0) {
            if (strtoupper($CASH_AVAILABLE) == "YES") {
                $Data_update_trips['vTripPaymentMode'] = "Cash";
            }
        }
        /* For New Payment Flow End */
        /*         * ** System Payment Flow Method-2 **** */
        // $Data_update_trips['tVehicleTypeFareData'] = $Fare_data['tVehicleTypeFareData'];
        $Data_update_trips['fDistance'] = $tripDistance;
        $Data_update_trips['fDuration'] = $totalTimeInMinutes_trip;
        $Data_update_trips['fPricePerMin'] = $Fare_data['fPricePerMin'];
        $Data_update_trips['fPricePerKM'] = $Fare_data['fPricePerKM'];
        $Data_update_trips['iBaseFare'] = $Fare_data['iBaseFare'];
        $Data_update_trips['fCommision'] = $Fare_data['fCommision'];
        $Data_update_trips['fDiscount'] = $Fare_data['fDiscount'];
        $Data_update_trips['vDiscount'] = $Fare_data['vDiscount'];
        $Data_update_trips['fMinFareDiff'] = $Fare_data['MinFareDiff'];
        $Data_update_trips['fSurgePriceDiff'] = $Fare_data['fSurgePriceDiff'];
        $Data_update_trips['fWalletDebit'] = $Fare_data['user_wallet_debit_amount'];
        $Data_update_trips['fTripGenerateFare'] = $Fare_data['fTripGenerateFare'];
        $Data_update_trips['fMaterialFee'] = $fMaterialFee;
        $Data_update_trips['fMiscFee'] = $fMiscFee;
        $Data_update_trips['fDriverDiscount'] = $fDriverDiscount;
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        $Data_update_trips['fOtherCharges'] = $fOtherCharges;
        if (isset($_REQUEST["fTollPrice"]) && $fTollPrice > 0) {
            $Data_update_trips['fTollPrice'] = $fTollPrice;
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        $Data_update_trips['fTax1'] = $Fare_data['fTax1'];
        $Data_update_trips['fTax2'] = $Fare_data['fTax2'];
        $Data_update_trips['fTripHoldPrice'] = $Fare_data['fTripHoldPrice']; // Added By HJ For Insert Intransit Amount On 28-12-2018
        $Data_update_trips['fTax1Percentage'] = $Fare_data['fTax1Percentage'];
        $Data_update_trips['fTax2Percentage'] = $Fare_data['fTax2Percentage'];
        $Data_update_trips['fOutStandingAmount'] = $Fare_data['fOutStandingAmount'];
        $Data_update_trips['fExtraPersonCharge'] = $Fare_data['fExtraPersonCharge']; //Added By HJ On 26-12-2018 For Insert Extra Charge Amount
        // added for airport
        $Data_update_trips['fAirportPickupSurgeAmount'] = $Fare_data['fAirportPickupSurgeAmount'];
        $Data_update_trips['fAirportDropoffSurgeAmount'] = $Fare_data['fAirportDropoffSurgeAmount'];

        $Data_update_trips['fHotelCommision'] = $Fare_data['Commision_Fare_Hotel'];
        $Data_update_trips['fHotelBookingChargePercentage'] = $Fare_data['fHotelBookingChargePercentage'];
        if ($eHailTrip == "No") {
            $Data_update_trips['fWaitingFees'] = $Fare_data['fWaitingFees'];
        }
    }
    $Data_update_trips['fGDtime'] = $FGDTime;
    $Data_update_trips['fGDdistance'] = $FGDDistance;
    $Data_update_trips['fWaitingFees'] = 0;
    
    if ($ePoolRide == "Yes" && $POOL_ENABLE == "Yes") {
        $Data_update_trips['fWaitingFees'] = 0;
    }
    if ($isTripCanceled == "true") {
        $Data_update_trips['vCancelReason'] = $driverReason;
        $Data_update_trips['vCancelComment'] = $driverComment;
        $Data_update_trips['eCancelled'] = "Yes";
        $Data_update_trips['eCancelledBy'] = "Driver";
    }
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        finalizeProcessEndTrip();
    }
    /* Code for Upload AfterImage of trip Start */
    if ($image_name != "") {
        //$Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path']."/".$TripID."/";
        if (!empty($image_object)) {
            $Photo_Gallery_folder = $tconfig['tsite_upload_trip_images_path'];
            if (!is_dir($Photo_Gallery_folder)) {
                mkdir($Photo_Gallery_folder, 0777);
                chmod($Photo_Gallery_folder, 0777);
            }
            $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $image_name, $prefix = '', $vaildExt = "pdf,doc,docx,jpg,jpeg,gif,png");
            $vImageName = $vFile[0];
            $image_name = $vImageName;
        }
        $Data_update_trips['vAfterImage'] = $image_name;
    }
    /* Code for Upload AfterImage of trip End */
    $Data_update_trips['iCancelReasonId'] = $iCancelReasonId;
    if ($MODULES_OBJ->isEnableVideoConsultingService() && $isVideoCall == 'Yes') {
        $Data_update_trips['tEndDate'] = @date("Y-m-d H:i:s");
    }
    $id = $obj->MySQLQueryPerform("trips", $Data_update_trips, 'update', $where);
    $trip_status = "On Going Trip";
    $vCallFromDriver = '';
    $trip_status_driver = "Arrived";
    if ($TRIP_CONTINUE == "No") {
        $trip_status = $trip_status_driver = "Not Active";
        $vCallFromDriver = 'Not Assigned';
    }
    // $trip_status    = "Not Active";
    $where = " iUserId = '$userId'";
    if ($APP_TYPE == "Ride-Delivery-UberX" && $eType != "UberX") {
        $Data_update_passenger['iTripId'] = $tripId;
        $Data_update_passenger['vTripStatus'] = $trip_status;
    } else if ($eType != "UberX") {
        $Data_update_passenger['iTripId'] = $tripId;
        $Data_update_passenger['vTripStatus'] = $trip_status;
    }
    $Data_update_passenger['vCallFromDriver'] = 'Not Assigned';
    $Data_update_passenger['fTripsOutStandingAmount'] = '0';
    $id = $obj->MySQLQueryPerform("register_user", $Data_update_passenger, 'update', $where);
    $where = " iDriverId = '$driverId'";
    $Data_update_driver['iTripId'] = $tripId;
    $Data_update_driver['vTripStatus'] = $trip_status_driver;
    $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
    ## Update User Outstanding Amount ##
    //$updateQuery = "UPDATE register_user set fTripsOutStandingAmount = '0' WHERE iUserId = " . $userId;
    //$obj->sql_query($updateQuery);
    //$updateQury = "UPDATE trip_outstanding_amount set ePaidByPassenger = 'Yes' WHERE iUserId = ".$iUserId;
    $outStandingSql = "";
    // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
    if ($trip_start_data_arr[0]['vTripPaymentMode'] == "Wallet") {
        $outStandingSql = " AND eAuthoriseIdName='iTripId' AND iAuthoriseId='" . $tripId . "'";
    }
    $org_sql = " AND iOrganizationId = '0' AND ePaymentBy = 'Passenger' ";
    if (!empty($trip_start_data_arr[0]['iOrganizationId']) && $trip_start_data_arr[0]['iOrganizationId'] > 0 && $trip_start_data_arr[0]['ePaymentBy'] == "Organization") {
        $org_sql = " AND iOrganizationId = '" . $trip_start_data_arr[0]['iOrganizationId'] . "' AND ePaymentBy = 'Organization' ";
    }
    /* Added By PM On 25-01-2020 For wallet credit to driver Start */
    if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable() && $vTripPaymentMode == "Card") {
        $updateQury = "UPDATE trip_outstanding_amount set eBillGenerated = 'Yes',vTripPaymentMode = '" . $vTripPaymentMode . "', vTripAdjusmentId = '" . $tripId . "' WHERE iUserId = '" . $userId . "' AND ePaidByPassenger = 'No' $outStandingSql $org_sql";
        $obj->sql_query($updateQury);
    } else {
        $updateQury = "UPDATE trip_outstanding_amount set ePaidByPassenger = 'Yes', eBillGenerated = 'Yes',vTripAdjusmentId = '" . $tripId . "' WHERE iUserId = '" . $userId . "' AND ePaidByPassenger = 'No' $outStandingSql $org_sql";
        $obj->sql_query($updateQury);
    }
    /* Added By PM On 25-01-2020 For wallet credit to driver End */
    ## Update User Outstanding Amount ##
    if ($id > 0) {
        /* For PubNub Setting */
        $tableName = "register_user";
        $iMemberId_VALUE = $userId;
        $iMemberId_KEY = "iUserId";
        //Added By HJ On 22-06-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr[$tableName . "_" . $iMemberId_VALUE])) {
            $AppData = $userDetailsArr[$tableName . "_" . $iMemberId_VALUE];
        } else {
            $AppData = get_value($tableName, '*,' . $iMemberId_KEY . ' as iMemberId', $iMemberId_KEY, $iMemberId_VALUE);
            $userDetailsArr[$tableName . "_" . $iMemberId_VALUE] = $AppData;
        }
        //Added By HJ On 22-06-2020 For Optimize register_user Table Query End
        $iAppVersion = $AppData[0]['iAppVersion'];
        $eDeviceType = $AppData[0]['eDeviceType'];
        $eLogout = $AppData[0]['eLogout'];
        $tLocationUpdateDate = $AppData[0]['tLocationUpdateDate'];
        $iGcmRegId = $AppData[0]['iGcmRegId'];
        $tSessionId = $AppData[0]['tSessionId'];
        $eAppTerminate = $AppData[0]['eAppTerminate'];
        $eDebugMode = $AppData[0]['eDebugMode'];
        $eHmsDevice = $AppData[0]['eHmsDevice'];
        
        if(strtoupper($eDeviceType) == "IOS") {
            $tDeviceLiveActivityToken = getLiveActivityDeviceToken($tripId, 'Trip');
        } else {
            $tDeviceLiveActivityToken = $iGcmRegId;
        }
        /* For PubNub Setting Finished */
        $cmpMinutes = ceil((fetchtripstatustimeMAXinterval() + $intervalmins) / 60);
        $compare_date = @date('Y-m-d H:i:s', strtotime('-' . $cmpMinutes . ' minutes'));
        //$alertSendAllowed = false;
        $alertSendAllowed = true;
        //$message = $alertMsg;
        $tLocUpdateDate = date("Y-m-d H:i:s", strtotime($tLocationUpdateDate));
        if ($tLocUpdateDate < $compare_date) {
            $alertSendAllowed = true;
        }
        $alertSendAllowed = true;
        if ($eLogout == "Yes") {
            $alertSendAllowed = false;
        }
        //added by SP on 17-02-2021 for custom notification
        $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
        //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
        $message_arr['CustomViewBtn'] = "Yes";
        $message_arr['CustomTrackDetails'] = "No";
        $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
        $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
        $customNotiArray = GetCustomNotificationDetails($tripId, $message_arr['vTitle'], $vLangCode);
        //title and sub description shown in custom notification
        $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
        $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
        $message_arr['CustomMessage'] = $customNotiArray;
        $message_arr['tSessionId'] = $tSessionId;
        $deviceTokens_arr = array();
        if ($eType != "Multi-Delivery") {
            $channelName = "PASSENGER_" . $userId;
            $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName, 'tripStatusMsgArr' => array('tMessage' => $message_arr, 'iDriverId' => $driverId, 'iTripId' => $tripId, 'iUserId' => $userId, 'eFromUserType' => "Driver", 'eToUserType' => "Passenger", 'eReceived' => "No",),'event'=>'TripFinished');
            $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);

            if(strtoupper($ENABLE_NOTIFICATION_LIVE_ACTIVITY) == "YES") {
                $message_arr['LiveActivityData'] = getTripLiveActivity($tripId);
                $message_arr['LiveActivity'] = "Yes";
                $message_arr['LiveActivityEnd'] = "Yes";

                $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $tDeviceLiveActivityToken, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr);
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
            }
        }
        $returnArr['Action'] = "1";
        $returnArr['iTripsLocationsID'] = $id;
        if ($TRIP_CONTINUE == "No") {
            $returnArr['TotalFare'] = round($Fare_data['total_fare'] * $trip_start_data_arr[0]['fRatioDriver'], 1);
            $returnArr['Discount'] = round($Fare_data['fDiscount'] * $trip_start_data_arr[0]['fRatioDriver'], 1);
        } else {
            $returnArr['TotalFare'] = round($trip_start_data_arr[0]['iFare'] * $trip_start_data_arr[0]['fRatioDriver'], 1);
            $returnArr['Discount'] = round($trip_start_data_arr[0]['fDiscount'] * $trip_start_data_arr[0]['fRatioDriver'], 1);
        }
        $returnArr['fMaterialFee'] = setTwoDecimalPoint($fMaterialFee * $DriverRation);
        $returnArr['fMiscFee'] = setTwoDecimalPoint($fMiscFee * $DriverRation);
        $returnArr['fDriverDiscount'] = setTwoDecimalPoint($fDriverDiscount * $DriverRation);
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        $returnArr['fOtherCharges'] = setTwoDecimalPoint($fOtherCharges * $DriverRation);
        $returnArr['fTollPrice'] = setTwoDecimalPoint($fTollPrice * $DriverRation);
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        $returnArr['CurrencySymbol'] = $currencySymbolDriver;
        $returnArr['tripStartTime'] = $startDate;
        $returnArr['TripPaymentMode'] = $trip_start_data_arr[0]['vTripPaymentMode'];
        $returnArr['Discount'] = round($Fare_data['fDiscount'] * $trip_start_data_arr[0]['fRatioDriver'], 1);
        $returnArr['Message'] = "Data Updated";
        $returnArr['FormattedTripDate'] = date('dS M Y \a\t h:i a', strtotime($startDate));
        $REFERRAL_OBJ->CreditReferralAmount($tripId);
        // Code for Check last logout date is update in driver_log_report
        $query = "SELECT * FROM driver_log_report WHERE iDriverId = '" . $driverId . "' ORDER BY iDriverLogId DESC LIMIT 0,1";
        $db_driver = $obj->MySQLSelect($query);
        if (count($db_driver) > 0) {
            $driver_lastonline = @date("Y-m-d H:i:s");
            $updateQuery = "UPDATE driver_log_report set dLogoutDateTime='" . $driver_lastonline . "' WHERE iDriverLogId = " . $db_driver[0]['iDriverLogId'];
            $obj->sql_query($updateQuery);
        }
        // Code for Check last logout date is update in driver_log_report Ends
        /* ---------------------------Multi delivery values--------------------------- */
        if ($eType == "Multi-Delivery") {
            $returnArr['ePaymentByReceiverForDelivery'] = "No";
            // Added By HJ On 24-06-2020 For Optimize trips_delivery_locations Table Query Start
            $totalTripDeliveryCount = 0;
            if (isset($tripDetailsArr["trips_delivery_locations_" . $tripId])) {
                $sqldeliverydata = $tripDetailsArr["trips_delivery_locations_" . $tripId];
                $totalTripDeliveryCount = count($sqldeliverydata);
            } else {
                $sqldeliverydata = $obj->MySQLSelect("SELECT * FROM `trips_delivery_locations` WHERE iTripId='" . $tripId . "' ORDER BY  iTripDeliveryLocationId ASC");
                $tripDetailsArr["trips_delivery_locations_" . $tripId] = $sqldeliverydata;
                $totalTripDeliveryCount = count($sqldeliverydata);
            }
            $TripDeliveryData = $tripDeliveryFieldArr = array();
            if (count($sqldeliverydata) > 0) {
                $dataFound = 0;
                for ($d = 0; $d < count($sqldeliverydata); $d++) {
                    $iActiveStatus = $sqldeliverydata[$d]['iActive'];
                    if ((strtoupper($iActiveStatus) == "ACTIVE" || strtoupper($iActiveStatus) == "ON GOING TRIP") && $dataFound == 0) {
                        $dataFound = 1;
                        $TripDeliveryData[] = $sqldeliverydata[$d];
                    }
                }
            }
            // Added By HJ On 24-06-2020 For Optimize trips_delivery_locations Table Query End
            //$sqldeliverydata = "SELECT * FROM `trips_delivery_locations` WHERE ( iActive='Active' OR iActive='On Going Trip')  AND iTripId='" . $tripId . "' ORDER BY iTripDeliveryLocationId ASC LIMIT 0,1";
            //$TripDeliveryData = $obj->MySQLSelect($sqldeliverydata);
            if (count($TripDeliveryData) > 0) {
                $iTripDeliveryLocationId = $TripDeliveryData[0]['iTripDeliveryLocationId'];
                $vPhoneCode = $result22[0]['vCode'];
                $vLang = $result22[0]['vLang'];
                if ($vLang == "" || $vLang == NULL) {
                    //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
                    $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                    //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
                }
                // Added By HJ On 24-06-2020 For Optimize trip_delivery_fields Table Query Start
                if (isset($tripDetailsArr["trip_delivery_fields_" . $tripId])) {
                    $sqldeliveryFielddata = $tripDetailsArr["trip_delivery_fields_" . $tripId];
                } else {
                    $sqldeliveryFielddata = $obj->MySQLSelect("SELECT * FROM trip_delivery_fields WHERE iTripId='" . $tripId . "'");
                    $tripDetailsArr["trip_delivery_fields_" . $tripId] = $sqldeliveryFielddata;
                }
                $tripDeliveryFieldArr = array();
                for ($f = 0; $f < count($sqldeliveryFielddata); $f++) {
                    $iTripDeliveryLocationId = $sqldeliveryFielddata[$f]['iTripDeliveryLocationId'];
                    $iDeliveryFieldId = $sqldeliveryFielddata[$f]['iDeliveryFieldId'];
                    $tripDeliveryFieldArr[$iTripDeliveryLocationId][$iDeliveryFieldId] = $sqldeliveryFielddata[$f];
                }
                // Added By HJ On 24-06-2020 For Optimize trip_delivery_fields Table Query End
                // Added By HJ On 24-06-2020 For Optimize trip_delivery_fields Table Query Start
                if (isset($tripDeliveryFieldArr[$iTripDeliveryLocationId][2])) {
                    $vReceiverName = $tripDeliveryFieldArr[$iTripDeliveryLocationId][2]['vValue'];
                } else {
                    $vReceiverName = get_value('trip_delivery_fields', 'vValue', 'iDeliveryFieldId', '2', " and iTripDeliveryLocationId ='" . $iTripDeliveryLocationId . "'", 'true');
                }
                if (isset($tripDeliveryFieldArr[$iTripDeliveryLocationId][2])) {
                    $vReceiverMobile = $tripDeliveryFieldArr[$iTripDeliveryLocationId][3]['vValue'];
                } else {
                    $vReceiverMobile = get_value('trip_delivery_fields', 'vValue', 'iDeliveryFieldId', '3', " and iTripDeliveryLocationId ='" . $iTripDeliveryLocationId . "'", 'true');
                }
                // Added By HJ On 24-06-2020 For Optimize trip_delivery_fields Table Query End
                //$vReceiverName = get_value('trip_delivery_fields', 'vValue', 'iDeliveryFieldId', '2', " and iTripDeliveryLocationId ='" . $TripDeliveryData[0]['iTripDeliveryLocationId'] . "'", 'true');
                //$vReceiverMobile = get_value('trip_delivery_fields', 'vValue', 'iDeliveryFieldId', '3', " and iTripDeliveryLocationId ='" . $TripDeliveryData[0]['iTripDeliveryLocationId'] . "'", 'true');
                //$sql = "SELECT count(iTripDeliveryLocationId) AS TotalTripDelivery FROM trips_delivery_locations WHERE iTripId='" . $tripId . "'";
                //$TotalTripDeliveryData = $obj->MySQLSelect($sql);
                //$TotalTripDelivery = $TotalTripDeliveryData[0]['TotalTripDelivery'];
                $TotalTripDelivery = $totalTripDeliveryCount;
                //Added By HJ On 24-06-2020 For Optimize language label Table Query Start
                if (isset($languageLabelDataArr[$vLang])) {
                    $languageLabelsArr = $languageLabelDataArr[$vLang];
                } else {
                    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1");
                    $languageLabelDataArr[$vLang] = $languageLabelsArr;
                }
                //Added By HJ On 24-06-2020 For Optimize language label Table Query End
                if (isset($languageLabelsArr['LBL_CURRENT_DELIVERY_NUMBER'])) {
                    $LBL_CURRENT_DELIVERY_NUMBER_TXT = $languageLabelsArr['LBL_CURRENT_DELIVERY_NUMBER'];
                } else {
                    $LBL_CURRENT_DELIVERY_NUMBER_TXT = get_value('language_label', 'vValue', 'vLabel', 'LBL_CURRENT_DELIVERY_NUMBER', " and vCode ='" . $vLang . "'", 'true');
                }
                if (isset($languageLabelsArr['LBL_OUT_OF_TXT'])) {
                    $LBL_OUT_OF_TXT = $languageLabelsArr['LBL_OUT_OF_TXT'];
                } else {
                    $LBL_OUT_OF_TXT = get_value('language_label', 'vValue', 'vLabel', 'LBL_OUT_OF_TXT', " and vCode ='" . $vLang . "'", 'true');
                }
                if (isset($languageLabelsArr['LBL_CURRENT_DELIVERY_NUMBER'])) {
                    $LBL_CURRENT_DELIVERY_NUMBER = $languageLabelsArr['LBL_CURRENT_DELIVERY_NUMBER'];
                } else {
                    $LBL_CURRENT_DELIVERY_NUMBER = get_value('language_label', 'vValue', 'vLabel', 'LBL_CURRENT_DELIVERY_NUMBER', " and vCode ='" . $vLang . "'", 'true');
                }
                $iRunningTripDeliveryNo = $trip_start_data_arr[0]['iRunningTripDeliveryNo'];
                if ($Active == "Active") {
                    $iRunningTripDeliveryNo = $iRunningTripDeliveryNo + 1;
                }
                if ($iRunningTripDeliveryNo > $TotalTripDelivery) {
                    $iRunningTripDeliveryNo = $TotalTripDelivery;
                }
                if ($TotalTripDelivery > 1) {
                    $Running_Delivery_Txt = $LBL_CURRENT_DELIVERY_NUMBER_TXT . " " . $iRunningTripDeliveryNo . " " . $LBL_OUT_OF_TXT . " " . $TotalTripDelivery;
                } else {
                    $Running_Delivery_Txt = $LBL_CURRENT_DELIVERY_NUMBER_TXT;
                }
                $returnArr['Running_Delivery_Txt'] = $Running_Delivery_Txt;
                $returnArr['Running_Receipent_Detail'] = $LBL_CURRENT_DELIVERY_NUMBER . " " . $iRunningTripDeliveryNo . " ( " . $vReceiverName . " )";
                $returnArr['iTripDeliveryLocationId'] = $TripDeliveryData[0]['iTripDeliveryLocationId'];
            }
            $IS_OPEN_SIGN_VERIFY = $IS_OPEN_FOR_SENDER = "No";
            $vTripStatus = $trip_start_data_arr[0]['iActive'];
            $vTripDriverId = $trip_start_data_arr[0]['iDriverId'];
            //Added By HJ On 24-06-2020 For Optimize register_driver Table Query Start
            if (isset($userDetailsArr['register_driver_' . $vTripDriverId])) {
                $vDriverTripStatus = $userDetailsArr['register_driver_' . $vTripDriverId][0]['vTripStatus'];
            } else {
                $vDriverTripStatus = get_value('register_driver', 'vTripStatus', 'iDriverId', $vTripDriverId, '', 'true');
            }
            //Added By HJ On 24-06-2020 For Optimize register_driver Table Query End
            $eSignVerification = $trip_start_data_arr[0]['eSignVerification'];
            if (($vTripStatus == "Active" && $vDriverTripStatus == "Arrived" && $eSignVerification == "No") || ($trip_start_data_arr[0]['ePaymentCollect_Delivery'] == "No" && $vDriverTripStatus == "Arrived")) {
                $IS_OPEN_SIGN_VERIFY = $IS_OPEN_FOR_SENDER = "Yes";
            }
            if ($IS_OPEN_SIGN_VERIFY == "No") {
                $sqldelivdata = "SELECT eSignVerification FROM `trips_delivery_locations` WHERE ( iActive='Canceled' OR iActive='Finished')  AND eSignVerification = 'No' AND iTripId='" . $tripId . "' ORDER BY iTripDeliveryLocationId ASC LIMIT 0,1";
                $TripDeliData = $obj->MySQLSelect($sqldelivdata);
                $eSignVerification = $TripDeliData[0]['eSignVerification'];
                if ($eSignVerification == "No" && $DELIVERY_VERIFICATION_METHOD != "None") {
                    $IS_OPEN_SIGN_VERIFY = "Yes";
                    $IS_OPEN_FOR_SENDER = "No";
                }
            }
            $returnArr['IS_OPEN_SIGN_VERIFY'] = $IS_OPEN_SIGN_VERIFY;
            $returnArr['IS_OPEN_FOR_SENDER'] = $IS_OPEN_FOR_SENDER;
        } else {
            $returnArr['IS_OPEN_SIGN_VERIFY'] = $returnArr['IS_OPEN_FOR_SENDER'] = "No";
            // $vDeliveryConfirmCode = $tripData[0]['vDeliveryConfirmCode'];
        }
        $returnArr['USER_DATA'] = getDriverDetailInfo($driverId);
        /* ---------------------------Multi delivery values end--------------------------- */
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    //getTripChatDetails($tripId);
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "CollectPayment") {
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $isCollectCash = isset($_REQUEST["isCollectCash"]) ? $_REQUEST["isCollectCash"] : '';
    // for hotel panel web
    //Added By HJ On 26-06-2020 For Optimize trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $iTripId])) {
        $tripData = $tripDetailsArr['trips_' . $iTripId];
    } else {
        $tripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='$iTripId'");
        $tripDetailsArr['trips_' . $iTripId] = $tripData;
    }
    //Added By HJ On 26-06-2020 For Optimize trips Table Query End
    $vTripPaymentMode = $tripData[0]['vTripPaymentMode'];
    $data['vTripPaymentMode'] = $vTripPaymentMode;
    $iUserId = $tripData[0]['iUserId'];
    //$iFare = $tripData[0]['iFare']+$tripData[0]['fTollPrice'];
    $iFare = $tripData[0]['iFare'];
    $vRideNo = $tripData[0]['vRideNo'];
    $eHailTrip = $tripData[0]['eHailTrip'];
    $eBookingFrom = $tripData[0]['eBookingFrom'];
    $eType = $eType_Trip = $tripData[0]['eType'];
    $ePaymentCollect_Delivery = $tripData[0]['ePaymentCollect_Delivery'];
    $totalTax = $tripData[0]['fTax1'] + $tripData[0]['fTax2'];
    //Added By HJ On 26-06-2020 For Optimize language_master Table Query Start
    $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
    //Added By HJ On 26-06-2020 For Optimize language_master Table Query End
    //Added By HJ On 26-06-2020 For Optimize register_user Table Query Start
    if (isset($userDetailsArr['register_user_' . $iUserId])) {
        $userData == $userDetailsArr['register_user_' . $iUserId];
    } else {
        $userData = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM register_user WHERE iUserId='$iUserId'");
        $userDetailsArr['register_user_' . $iUserId] = $userData;
    }
    $countryPaymentMethod = $obj->MySQLSelect("SELECT vPaymentGateway FROM country WHERE vCountryCode = '" . $userData[0]['vCountry'] . "'");
    $USER_APP_PAYMENT_METHOD = $APP_PAYMENT_METHOD;
    if (!empty($countryPaymentMethod[0]['vPaymentGateway'])) {
        $USER_APP_PAYMENT_METHOD = $countryPaymentMethod[0]['vPaymentGateway'];
    }
    $TOKENIZED_STATUS = strtoupper($USER_APP_PAYMENT_METHOD) . '_TOKENIZED';
    $IS_TOKENIZED = $$TOKENIZED_STATUS;
    //Added By HJ On 26-06-2020 For Optimize register_user Table Query End
    
    $vEmailUser = $userData[0]['vRecipientEmail'];
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $returnArr['message1'] = "LBL_COLLECT_CASH"; //added by SP to show label at app when card is selected at that time skip is displayd otherwise collect cash on 30-07-2019
    // if ($vTripPaymentMode == "Card" && $SYSTEM_PAYMENT_FLOW == 'Method-1' && $isCollectCash == "" && ($eType_Trip != "Multi-Delivery" || ($ePaymentCollect_Delivery == "No" && $eType_Trip == "Multi-Delivery"))) {
    if ($vTripPaymentMode == "Card" && $isCollectCash == "" && ($eType_Trip != "Multi-Delivery" || ($ePaymentCollect_Delivery == "No" && $eType_Trip == "Multi-Delivery"))) {
        
        $price_new = $iFare * 100;
        //Added By HJ On 26-06-2020 For Optimization currency Table Query Start
        if (!empty($vSystemDefaultCurrencyName)) {
            $currency = $vSystemDefaultCurrencyName;
        } else {
            $currency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        }
        //Added By HJ On 26-06-2020 For Optimization currency Table Query End
        //$currency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        $description = $languageLabelsArr['LBL_TRIP_PAYMENT_RECEIVED'] . " #" . $vRideNo;
        if ($iFare != 0) {
            $AMOUNT = $iFare;
            $iMemberId = $iUserId;
            $UserType = "Passenger";
            $iPaymentInfoId = $tripData[0]['iPaymentInfoId'];
            $paymentData = array("amount" => $AMOUNT, "description" => $description, "iMemberId" => $iMemberId, "UserType" => $UserType, "iPaymentInfoId" => $iPaymentInfoId,);
            if (strtoupper($IS_TOKENIZED) == "NO") {
                $paymentData['return_url'] = $tconfig['tsite_url'];
                $paymentData['eType'] = $eType;
            }
            $result = (PaymentGateways::getInstance())->execute($paymentData);
            if ($result['Action'] == "1") {
                if (isset($result['AUTHENTICATION_REQUIRED'])) {
                    $fOutStandingAmount = $iFare;
                    $where = " iTripId = '$iTripId'";
                    $data_out['eCardFailed'] = 'Yes';
                    $idOut = $obj->MySQLQueryPerform("trips", $data_out, 'update', $where);
                    ReviseTripPayableAmount($iTripId, "No", "No");
                    $fOutStandingAmount = get_value('trips', 'fOutStandingAmount', 'iTripId', $iTripId, '', 'true');
                    if ($fOutStandingAmount > 0) {
                        $updateQury = "UPDATE trip_outstanding_amount set ePaidByPassenger = 'No',vTripAdjusmentId = '' WHERE iUserId = '" . $iUserId . "' AND vTripAdjusmentId IN($iTripId)";
                        $obj->sql_query($updateQury);
                        $obj->sql_query("UPDATE register_user set fTripsOutStandingAmount = fTripsOutStandingAmount+'" . $fOutStandingAmount . "' WHERE iUserId = " . $iUserId);
                        $obj->sql_query("UPDATE trips set fAddedOutstandingamt = '" . $fOutStandingAmount . "',fOutStandingAmount = 0 WHERE iTripId = " . $iTripId);
                    }
                    $tDescription = "Amount charge for trip oustanding balance";
                    $extraParams = "eType=" . $eType . "&ePaymentType=ChargeOutstandingAmount&tSessionId=" . $userData[0]['tSessionId'] . "&GeneralMemberId=" . $iUserId . "&GeneralUserType=Passenger&iServiceId=&AMOUNT=" . $fOutStandingAmount . "&PAGE_TYPE=CHARGE_OUTSTANDING_AMT&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes&description=" . urlencode($tDescription);
                    $OUTSTANDING_PAYMENT_URL = $tconfig['tsite_url'] . 'assets/libraries/webview/payment_mode_select.php?' . $extraParams;
                    $alertMsg = str_replace("#RIDE_NO#", $vRideNo, $languageLabelsArr['LBL_OUTSTANDING_PAYMENT_PENDING_MSG']);
                    $message_arr = array();
                    $message_arr['Message'] = "OutstandingGenerated";
                    $message_arr['iTripId'] = $iTripId;
                    $message_arr['iUserId'] = $iUserId;
                    $message_arr['vRideNo'] = $vRideNo;
                    $message_arr['vTitle'] = $alertMsg;
                    $message_arr['tSessionId'] = $userData[0]['tSessionId'];
                    $message_arr['PAYMENT_URL'] = $OUTSTANDING_PAYMENT_URL;
                    $message_arr['vMsgCode'] = strval(time());
                    $channelName = "PASSENGER_" . $iUserId;
                    $generalDataArr[] = array('eDeviceType' => $userData[0]['eDeviceType'], 'deviceToken' => $userData[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $userData[0]['eAppTerminate'], 'eDebugMode' => $userData[0]['eDebugMode'], 'eHmsDevice' => $userData[0]['eHmsDevice'], 'message' => $message_arr, 'channelName' => $channelName,);
                    $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
                } else {
                    $payment_id = $result['payment_id'];
                    $where_payments = " iPaymentId = '" . $payment_id . "'";
                    $data_payments['iTripId'] = $iTripId;
                    $data_payments['eEvent'] = "Trip";
                    $obj->MySQLQueryPerform("payments", $data_payments, 'update', $where_payments);
                }
            } else {
                if (strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING) == "OUTSTANDING" || $tripData[0]['isVideoCall'] == "Yes") {
                    $returnArr['message1'] = "LBL_PAY_LATER_TXT";
                }
                $returnArr = array_merge($returnArr, $result);
                $returnArr['Action'] = "0";
                $returnArr['message'] = $languageLabelsArr['LBL_CHARGE_COLLECT_FAILED'];
                if($tripData[0]['isVideoCall'] == "Yes") {
                    $returnArr['message'] = $languageLabelsArr['LBL_CHARGE_FAILED_COLLECT_NO_CASH'];
                }
                if(isset($result['message'])) {
                    $returnArr['message'] = $result['message']; 
                }
                setDataResponse($returnArr);
            }
        }
        $data['vTripPaymentMode'] = "Card";
        $data['eCardFailed'] = 'No';
    } else if ($vTripPaymentMode == "Card" && $isCollectCash == "true" && ($eType_Trip != "Multi-Delivery" || ($ePaymentCollect_Delivery == "No" && $eType_Trip == "Multi-Delivery"))) {
        /* added by SP Outstanding calculate if payment failed start on 27-7-2019 */
        if (strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING) == "CASH") {
            $data['vTripPaymentMode'] = "Cash";
        } else {
            $fOutStandingAmount = $iFare;
            $where = " iTripId = '$iTripId'";
            $data_out['eCardFailed'] = 'Yes';
            $idOut = $obj->MySQLQueryPerform("trips", $data_out, 'update', $where);
            ReviseTripPayableAmount($iTripId, "No", "No");
            $fOutStandingAmount = get_value('trips', 'fOutStandingAmount', 'iTripId', $iTripId, '', 'true');
            // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
            if ($vTripPaymentMode == "Wallet") {
                $obj->sql_query("UPDATE trip_outstanding_amount set eAuthoriseIdName='No',iAuthoriseId = '0' WHERE iAuthoriseId='" . $iTripId . "' AND eAuthoriseIdName='iTripId'");
            }
            if ($fOutStandingAmount > 0) {
                $updateQury = "UPDATE trip_outstanding_amount set ePaidByPassenger = 'No',vTripAdjusmentId = '' WHERE iUserId = '" . $iUserId . "' AND vTripAdjusmentId IN($iTripId)";
                $obj->sql_query($updateQury);
                $obj->sql_query("UPDATE register_user set fTripsOutStandingAmount = fTripsOutStandingAmount+'" . $fOutStandingAmount . "' WHERE iUserId = " . $iUserId);
                $obj->sql_query("UPDATE trips set fAddedOutstandingamt = '" . $fOutStandingAmount . "',fOutStandingAmount = 0 WHERE iTripId = " . $iTripId);
                //$updateQuery2 = "UPDATE trips set fOutStandingAmount = 0 WHERE iTripId = " . $iTripId;
                //$obj->sql_query($updateQuery2);
            }
        }
        $UserData = $obj->MySQLSelect("select concat(vName,' ',vLastName) as username, vEmail from register_user where `iUserId`= $iUserId");
        $Data1['username'] = $UserData[0]['username'];
        $Data1['vEmail'] = $UserData[0]['vEmail'];
        $Data1['TripNo'] = $vRideNo;
        $sendMailfromDriver = $COMM_MEDIA_OBJ->SendMailToMember("TRANSACTION_FAILED_OUTSTANDING_AMT", $Data1);
        /* added by SP Outstanding calculate if payment failed end on 27-7-2019 */
    } elseif ($iFare > 0 && $vTripPaymentMode == "Wallet" && $isCollectCash == "" && ($eType_Trip != "Multi-Delivery" || ($ePaymentCollect_Delivery == "No" && $eType_Trip == "Multi-Delivery"))) {
        $returnArr['Action'] = "0";
        if (strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING) == "OUTSTANDING") {
            $returnArr['message1'] = "LBL_PAY_LATER_TXT";
        }
        $returnArr['message'] = $languageLabelsArr['LBL_LOW_WALLET_BALANCE'];
        setDataResponse($returnArr);
    } elseif ($vTripPaymentMode == "Wallet" && $isCollectCash == "true" && ($eType_Trip != "Multi-Delivery" || ($ePaymentCollect_Delivery == "No" && $eType_Trip == "Multi-Delivery"))) {
        if (strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING) == "CASH") {
            $data['vTripPaymentMode'] = "Cash";
        } else {
            $fOutStandingAmount = $iFare;
            $where = " iTripId = '$iTripId'";
            $data_out['eCardFailed'] = 'Yes';
            $idOut = $obj->MySQLQueryPerform("trips", $data_out, 'update', $where);
            ReviseTripPayableAmount($iTripId, "No", "No");
            $fOutStandingAmount = get_value('trips', 'fOutStandingAmount', 'iTripId', $iTripId, '', 'true');
            if ($fOutStandingAmount > 0) {
                $updateQury = "UPDATE trip_outstanding_amount set ePaidByPassenger = 'No',vTripAdjusmentId = '' WHERE iUserId = '" . $iUserId . "' AND vTripAdjusmentId IN($iTripId)";
                $obj->sql_query($updateQury);
                $obj->sql_query("UPDATE register_user set fTripsOutStandingAmount = fTripsOutStandingAmount+'" . $fOutStandingAmount . "' WHERE iUserId = " . $iUserId);
                $obj->sql_query("UPDATE trips set fAddedOutstandingamt = '" . $fOutStandingAmount . "',fOutStandingAmount = 0 WHERE iTripId = " . $iTripId);
            }
        }
    }
    $where = " iTripId = '$iTripId'";
    if ($eType_Trip == "Multi-Delivery" && $ePaymentCollect_Delivery == "No" && $isCollectCash == "true") {
        $data['ePaymentCollect_Delivery'] = "Yes";
        $fWalletDebit = $tripData[0]['fWalletDebit'];
        if ($fWalletDebit > 0) {
            $data_wallet['iUserId'] = $iUserId;
            $data_wallet['eUserType'] = "Rider";
            $data_wallet['iBalance'] = $fWalletDebit;
            $data_wallet['eType'] = "Debit";
            $data_wallet['dDate'] = date("Y-m-d H:i:s");
            $data_wallet['iTripId'] = $iTripId;
            $data_wallet['eFor'] = "Booking";
            $data_wallet['ePaymentStatus'] = "Settelled";
            $data_wallet['tDescription'] = "#LBL_DEBITED_BOOKING#" . $vRideNo;
            $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], $data_wallet['iTripId'], $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate']);
        }
    } else {
        $data['ePaymentCollect'] = "Yes";
        $data['ePaymentCollect_Delivery'] = $ePaymentCollect_Delivery = "No";
    }
    $iBalance = 0;
    $id = $obj->MySQLQueryPerform("trips", $data, 'update', $where);
    $fWalletDebit = $tripData[0]['fWalletDebit'];
    $fDiscount = $tripData[0]['fDiscount'];
    $discountValue = setTwoDecimalPoint($fWalletDebit + $fDiscount);
    $walletamountofcreditcard = $tripData[0]['fTripGenerateFare'];
    $driverId = $tripData[0]['iDriverId'];
    $tripeSystem = $tripData[0]['eSystem'];
    $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision($tripeSystem); // Added By HJ On 16-10-2020 For get Auto Deduct Driver Commision Configuration As Per eSystem
    if ($enableCommisionDeduct == 'Yes') {
        #Deduct Amount From Driver's Wallet Acount#
        $vTripPaymentMode = $data['vTripPaymentMode'];
        if ($vTripPaymentMode == "Cash" && $isCollectCash == "" && ($eType_Trip != "Multi-Delivery" || ($ePaymentCollect_Delivery == "No" && $eType_Trip == "Multi-Delivery"))) {
            $vRideNo = $tripData[0]['vRideNo'];
            //$iBalance = $tripData[0]['fCommision'];
            //for hotel panel web
            $iBalance = $tripData[0]['fCommision'] + $tripData[0]['fOutStandingAmount'] + $tripData[0]['fHotelCommision'] + $totalTax;
            $eFor = "Withdrawl";
            $eType = "Debit";
            //$tDescription = 'Debited for booking#'.$vRideNo;
            //$tDescription = '#LBL_DEBITED_BOOKING# ' . $vRideNo;
            $tDescription = '#LBL_DEBITED_SITE_EARNING_BOOKING#' . $vRideNo;
            $ePaymentStatus = 'Settelled';
            $dDate = Date('Y-m-d H:i:s');
            //$iBalance = $iBalance - $discountValue;
            //$discountValue = 0;
            $totalUserFare = $iFare;
            // Added By HJ On 18-12-2019 For Prevent Duplication Issue Dicuss with KS Sir Start
            //eFor is added by SP because when referral credited and discount is credited then it creates problem
            $getPaymentStatus = $obj->MySQLSelect("SELECT iTripId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iTripId='" . $iTripId . "'");
            $walletArr = array();
            for ($h = 0; $h < count($getPaymentStatus); $h++) {
                $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iTripId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
            }
            // Added By HJ On 18-12-2019 For Prevent Duplication Issue Dicuss with KS Sir End
            if ($discountValue > 0) {
                $eFor_credit = "Deposit";
                $eType_credit = "Credit";
                $tDescription_credit = '#LBL_CREDITED_BOOKING# ' . $vRideNo;
                //$tDescription_credit = 'Credited for booking#'.$vRideNo;
                if (!isset($walletArr[$eType_credit]['Driver'][$iTripId][$eFor_credit])) {
                    $WALLET_OBJ->PerformWalletTransaction($driverId, "Driver", $discountValue, $eType_credit, $iTripId, $eFor_credit, $tDescription_credit, $ePaymentStatus, $dDate); // Commet
                }
                $totalUserFare += $discountValue;
            }
            /* added by PM for Auto credit wallet driver on 25-01-2020 start */
            if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()) {
                $Where = " iTripId = '$iTripId'";
                $Data_update_driver_paymentstatus = array();
                $Data_update_driver_paymentstatus['eDriverPaymentStatus'] = "Settelled";
                $Update_Payment_Id = $obj->MySQLQueryPerform("trips", $Data_update_driver_paymentstatus, 'update', $Where); // Added By HJ On 08-08-2019 As Per Discuss With KS and BM mam
                if (!isset($walletArr[$eType]['Driver'][$iTripId][$eFor])) {
                    $WALLET_OBJ->PerformWalletTransaction($driverId, "Driver", $iBalance, $eType, $iTripId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                }
            } else {
                $Where = " iTripId = '$iTripId'";
                $Data_update_driver_paymentstatus = array();
                if ($totalUserFare >= $iBalance) {
                    $Data_update_driver_paymentstatus['eDriverPaymentStatus'] = "Settelled";
                    if ($walletamountofcreditcard > $totalUserFare) {
                        $Data_update_driver_paymentstatus['eDriverPaymentStatus'] = "Unsettelled";
                    }
                    $Update_Payment_Id = $obj->MySQLQueryPerform("trips", $Data_update_driver_paymentstatus, 'update', $Where); // Added By HJ On 08-08-2019 As Per Discuss With KS and BM mam
                    if (!isset($walletArr[$eType]['Driver'][$iTripId][$eFor])) {
                        $WALLET_OBJ->PerformWalletTransaction($driverId, "Driver", $iBalance, $eType, $iTripId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                    }
                }
            }
            /* added by PM for Auto credit wallet driver on 25-01-2020 end */
            /* if ($iBalance > 0) {

              //Added By HJ On 09-09-2019 For Update eDriverPaymentStatus Status Settelled As Per Discuss With KS and BM Start

              $Data_update_driver_paymentstatus['eDriverPaymentStatus'] = "Settelled";

              $Update_Payment_Id = $obj->MySQLQueryPerform("trips", $Data_update_driver_paymentstatus, 'update', $Where);

              //Added By HJ On 09-09-2019 For Update eDriverPaymentStatus Status Settelled As Per Discuss With KS and BM End

              $WALLET_OBJ->PerformWalletTransaction($driverId, "Driver", $iBalance, $eType, $iTripId, $eFor, $tDescription, $ePaymentStatus, $dDate);

          } */
            ///$Update_Payment_Id = $obj->MySQLQueryPerform("trips", $Data_update_driver_paymentstatus, 'update', $Where); // Commented By HJ On 08-08-2019 As Per Discuss With KS and BM mam
            $returnArr['message1'] = "LBL_COLLECT_CASH"; //added by SP to show label at app when card is selected at that time skip is displayd otherwise collect cash on 30-07-2019
        }
        #Deduct Amount From Driver's Wallet Acount#
    }
    /* added by PM for Auto credit wallet driver on 25-01-2020 start */
    if ($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()) {
        $Data = array();
        $Data['ePaymentStatus'] = $ePaymentStatus;
        $Data['isCollectCash'] = $isCollectCash;
        $Data['iUserId'] = $iUserId;
        $Data['iTripId'] = $iTripId;
        $Data['iBalance'] = $iBalance;
        autoCreditDriverEarning($Data, "CollectPayment");
    }
    /* added by PM for Auto credit wallet driver on 25-01-2020 end  */
    if ($id > 0) {
        $returnArr['Action'] = "1";
        // Rating entry if trip is hail
        if ($eHailTrip == "Yes") {
            $Data_update_ratings['iTripId'] = $iTripId;
            $Data_update_ratings['vRating1'] = "0.0";
            $Data_update_ratings['vMessage'] = "";
            $Data_update_ratings['eUserType'] = "Driver";
            $Data_update_ratings['eFromUserType'] = "Driver";
            $Data_update_ratings['eToUserType'] = "Passenger";
            $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert');
            $Data_update_ratings['eUserType'] = "Passenger";
            $Data_update_ratings['eFromUserType'] = "Passenger";
            $Data_update_ratings['eToUserType'] = "Driver";
            $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert');
            //$eType_Trip = get_value('trips', 'eType', 'iTripId', $iTripId, '', 'true');
            if ($eType_Trip == "Multi-Delivery") {
                sendTripReceiptAdmin_Multi($iTripId);
            } else {
                sendTripReceiptAdmin($iTripId);
            }
        }
        // Commented by HV on 07-06-2021 for Issue sheet - 2240
        if ($MODULES_OBJ->isEnableRiderRewardModule() && $eType_Trip == "Ride" && $eHailTrip == "No") {
            $RIDER_REWARD_OBJ->GiveRiderReward($iUserId,$iTripId);
        }
        // if ($eBookingFrom == 'Admin' || $eBookingFrom == 'User' || $eBookingFrom == 'Hotel' || $eBookingFrom == 'Company') {
        if ($eBookingFrom == 'Hotel' || $eBookingFrom == 'Company') {
            $Data_update_ratings['iTripId'] = $iTripId;
            $Data_update_ratings['vRating1'] = "0.0";
            $Data_update_ratings['vMessage'] = "";
            $Data_update_ratings['eUserType'] = "Driver";
            $Data_update_ratings['eFromUserType'] = "Driver";
            $Data_update_ratings['eToUserType'] = "Passenger";
            $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert');
            $Data_update_ratings['eUserType'] = "Passenger";
            $Data_update_ratings['eFromUserType'] = "Passenger";
            $Data_update_ratings['eToUserType'] = "Driver";
            $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert');
        }
        if ($eBookingFrom == 'Kiosk') {
            $Data_update_ratings['iTripId'] = $iTripId;
            $Data_update_ratings['vRating1'] = "0.0";
            $Data_update_ratings['vMessage'] = "";
            $Data_update_ratings['eUserType'] = "Driver";
            $Data_update_ratings['eFromUserType'] = "Driver";
            $Data_update_ratings['eToUserType'] = "Passenger";
            $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert');
            $Data_update_ratings['eUserType'] = "Passenger";
            $Data_update_ratings['eFromUserType'] = "Passenger";
            $Data_update_ratings['eToUserType'] = "Driver";
            $obj->MySQLQueryPerform("ratings_user_driver", $Data_update_ratings, 'insert');
            //$vEmailUser = get_value('register_user', 'vRecipientEmail', 'iUserId', $iUserId, '', 'true'); //added by SP for kiosk change in vRecipientEmail
            if ($vEmailUser != '') {
                sendTripReceipt($iTripId);
            }
            sendTripReceiptHotel($iTripId);
            //sendTripReceiptAdmin($iTripId);
        }
        $returnArr['USER_DATA'] = getDriverDetailInfo($driverId);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "GenerateCustomer") {
    $Data = array();
    $Data = $_REQUEST;
    $returnArr = GenerateCustomer($Data);
    ###############################    Stripe Request Param  #####################################
    /* $iUserId     = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';

      $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';  //Passenger,Driver

      $vStripeToken     = isset($_REQUEST["vStripeToken"]) ? $_REQUEST["vStripeToken"] : '';

      $CardNo     = isset($_REQUEST["CardNo"]) ? $_REQUEST["CardNo"] : ''; */
    ###############################    Stripe Request Param  #####################################
    ###############################    Braintree Request Param  #####################################
    /* $iUserId     = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';

      $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';  //Passenger,Driver

      $CardNo     = isset($_REQUEST["CardNo"]) ? $_REQUEST["CardNo"] : '';

      $paymentMethodNonce = isset($_REQUEST["paymentMethodNonce"]) ? $_REQUEST["paymentMethodNonce"] : ''; */
    ###############################    Braintree Request Param  #####################################
    ###############################    Paymaya Request Param  #####################################
    /* $iUserId     = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';

      $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';  //Passenger,Driver

      $vPaymayaToken     = isset($_REQUEST["vPaymayaToken"]) ? $_REQUEST["vPaymayaToken"] : '';

      $CardNo     = isset($_REQUEST["CardNo"]) ? $_REQUEST["CardNo"] : ''; */
    ###############################    Paymaya Request Param  #####################################
    ###############################    Omise Request Param  #####################################
    /* $iUserId     = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';

      $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';  //Passenger,Driver

      $vOmiseToken     = isset($_REQUEST["vOmiseToken"]) ? $_REQUEST["vOmiseToken"] : '';

      $CardNo     = isset($_REQUEST["CardNo"]) ? $_REQUEST["CardNo"] : ''; */
    ###############################    Omise Request Param  #####################################
    ###############################    Xendit Request Param  #####################################
    /* $iUserId     = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';

      $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';  //Passenger,Driver

      $vXenditToken     = isset($_REQUEST["vXenditToken"]) ? $_REQUEST["vXenditToken"] : ''; */
    ###############################    Xendit Request Param  #####################################
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "ScheduleARide") {
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : '';
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $pickUpLocAdd = isset($_REQUEST["pickUpLocAdd"]) ? $_REQUEST["pickUpLocAdd"] : '';
    $pickUpLatitude = isset($_REQUEST["pickUpLatitude"]) ? $_REQUEST["pickUpLatitude"] : '';
    $pickUpLongitude = isset($_REQUEST["pickUpLongitude"]) ? $_REQUEST["pickUpLongitude"] : '';
    $destLocAdd = isset($_REQUEST["destLocAdd"]) ? $_REQUEST["destLocAdd"] : '';
    $destLatitude = isset($_REQUEST["destLatitude"]) ? $_REQUEST["destLatitude"] : '';
    $destLongitude = isset($_REQUEST["destLongitude"]) ? $_REQUEST["destLongitude"] : '';
    $scheduleDate = isset($_REQUEST["scheduleDate"]) ? $_REQUEST["scheduleDate"] : '';
    $iVehicleTypeId = isset($_REQUEST["iVehicleTypeId"]) ? $_REQUEST["iVehicleTypeId"] : 0;
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';
    $iPackageTypeId = isset($_REQUEST["iPackageTypeId"]) ? $_REQUEST["iPackageTypeId"] : '';
    $vReceiverName = isset($_REQUEST["vReceiverName"]) ? $_REQUEST["vReceiverName"] : '';
    $vReceiverMobile = isset($_REQUEST["vReceiverMobile"]) ? $_REQUEST["vReceiverMobile"] : '';
    $tPickUpIns = isset($_REQUEST["tPickUpIns"]) ? $_REQUEST["tPickUpIns"] : '';
    $tDeliveryIns = isset($_REQUEST["tDeliveryIns"]) ? $_REQUEST["tDeliveryIns"] : '';
    $tPackageDetails = isset($_REQUEST["tPackageDetails"]) ? $_REQUEST["tPackageDetails"] : '';
    $vCouponCode = isset($_REQUEST["PromoCode"]) ? $_REQUEST["PromoCode"] : '';
    $iUserPetId = isset($_REQUEST["iUserPetId"]) ? $_REQUEST["iUserPetId"] : '';
    $cashPayment = isset($_REQUEST["CashPayment"]) ? $_REQUEST["CashPayment"] : 'No';
    $quantity = isset($_REQUEST["Quantity"]) ? $_REQUEST["Quantity"] : '';
    $fTollPrice = isset($_REQUEST["fTollPrice"]) ? $_REQUEST["fTollPrice"] : '';
    $vTollPriceCurrencyCode = isset($_REQUEST["vTollPriceCurrencyCode"]) ? $_REQUEST["vTollPriceCurrencyCode"] : '';
    $eTollSkipped = isset($_REQUEST["eTollSkipped"]) ? $_REQUEST["eTollSkipped"] : 'Yes';
    $HandicapPrefEnabled = isset($_REQUEST["HandicapPrefEnabled"]) ? $_REQUEST["HandicapPrefEnabled"] : '';
    $PreferFemaleDriverEnable = isset($_REQUEST["PreferFemaleDriverEnable"]) ? $_REQUEST["PreferFemaleDriverEnable"] : '';
    $iDriverId = isset($_REQUEST["SelectedDriverId"]) ? $_REQUEST["SelectedDriverId"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $iUserAddressId = isset($_REQUEST["iUserAddressId"]) ? $_REQUEST["iUserAddressId"] : '0';
    $tUserComment = isset($_REQUEST["tUserComment"]) ? $_REQUEST["tUserComment"] : '';
    $total_del_dist = isset($_REQUEST["total_del_dist"]) ? $_REQUEST["total_del_dist"] : '';
    $total_del_time = isset($_REQUEST["total_del_time"]) ? $_REQUEST["total_del_time"] : '';
    $eWalletDebitAllow = isset($_REQUEST["eWalletDebitAllow"]) ? $_REQUEST["eWalletDebitAllow"] : 'No';
    $iRentalPackageId = isset($_REQUEST["iRentalPackageId"]) ? $_REQUEST["iRentalPackageId"] : '';
    $vDistance = isset($_REQUEST["vDistance"]) ? $_REQUEST["vDistance"] : '';
    $vDuration = isset($_REQUEST["vDuration"]) ? $_REQUEST["vDuration"] : '';
    $iTripReasonId = isset($_REQUEST["iTripReasonId"]) ? $_REQUEST["iTripReasonId"] : '';
    $vReasonTitle = isset($_REQUEST["vReasonTitle"]) ? $_REQUEST["vReasonTitle"] : ''; // For Other Reason
    ######### added payment flow 2 ############
    $eWalletIgnore = isset($_REQUEST["eWalletIgnore"]) ? $_REQUEST["eWalletIgnore"] : 'No';
    $ePayWallet = isset($_REQUEST["ePayWallet"]) ? $_REQUEST["ePayWallet"] : '';
    $ePaymentBy = isset($_REQUEST["ePaymentBy"]) ? $_REQUEST["ePaymentBy"] : '';
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
    $orderDetails = isset($_REQUEST['OrderDetails']) ? $_REQUEST['OrderDetails'] : '';
    $eServiceLocation = isset($_REQUEST['eServiceLocation']) ? $_REQUEST['eServiceLocation'] : 'Passanger';
    $iPaymentInfoId = isset($_REQUEST['iPaymentInfoId']) ? $_REQUEST['iPaymentInfoId'] : '';
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
    ########## added payment flow 2 ##############
    $orderDetails = preg_replace('/[[:cntrl:]]/', '\r\n', $orderDetails);
    $vDuration = empty($vDuration) ? 0 : $vDuration;
    $vDistance = empty($vDistance) ? 0 : $vDistance;
    $vDuration = setTwoDecimalPoint($vDuration / 60);
    $vDistance = setTwoDecimalPoint($vDistance / 1000);
    //added by SP for fly stations on 19-08-2019 start
    $iFromStationId = isset($_REQUEST["iFromStationId"]) ? $_REQUEST["iFromStationId"] : '';
    $iToStationId = isset($_REQUEST["iToStationId"]) ? $_REQUEST["iToStationId"] : '';
    $eBookingFromWeb = isset($_REQUEST["eBookingFromWeb"]) ? $_REQUEST["eBookingFromWeb"] : 'No';
    $isVideoCall = isset($_REQUEST['isVideoCall']) ? $_REQUEST['isVideoCall'] : 'No';
    if (!empty($iFromStationId) && !empty($iToStationId)) {
        $Data['iFromStationId'] = $iFromStationId;
        $Data['iToStationId'] = $iToStationId;
    }
    //added by SP for fly stations on 19-08-2019 end
    /* Added by HV on 17-02-2021 for  Multiple stopover points | Flat trip should not be applied */
    $stopoverpoint_arr = isset($_REQUEST['stopoverpoint_arr']) ? $_REQUEST['stopoverpoint_arr'] : '';
    $stopoverPointArr = array();
    $StopOverPointAdded = "No";
    if (!empty($stopoverpoint_arr)) {
        $stopoverPointArr = json_decode($stopoverpoint_arr, true);
        $StopOverPointAdded = "Yes";
    }
    /* Added by HV on 17-02-2021 for  Multiple stopover points | Flat trip should not be applied End */
    /* For New Payment Flow */
    if ($eBookingFromWeb == "No") {
        $params = array("iMemberId" => $iUserId, "eUserType" => "Passenger", "eType" => $eType, "GET_DATA" => "Yes");
        $payment_mode_data = GetPaymentModeDetails($params);
        $ePaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
        $cashPayment = $ePaymentMode == "cash" ? "Yes" : "No";
        $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
        $eWalletDebitAllow = $ePaymentMode == "wallet" ? "Yes" : ($payment_mode_data['eWalletDebit'] == "Yes" ? "Yes" : "No");
        $iTripReasonId = $payment_mode_data['BusinessReasonId'];
        $vReasonTitle = $iTripReasonId > 0 ? $payment_mode_data['BusinessReasonTitle'] : $payment_mode_data['BusinessReasonOther'];
        $isRestrictToWallet = $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
        $iUserProfileId = $_REQUEST["iUserProfileId"] = $payment_mode_data['iUserProfileId'];
        $iOrganizationId = $_REQUEST["iOrganizationId"] = $payment_mode_data['iOrganizationId'];
        $ePaymentBy = $_REQUEST["ePaymentBy"] = $payment_mode_data['ePaymentBy'];
        if ($eType != "Multi-Delivery") {
            $ePaymentBy = $_REQUEST["ePaymentBy"] = $payment_mode_data['ePaymentBy'];
        }
        $vProfileEmail = $_REQUEST["vProfileEmail"] = $payment_mode_data['vProfileEmail'];
        $iPaymentInfoId = $payment_mode_data['iPaymentInfoId'];
        $vCouponCode = !empty($vCouponCode) ? $vCouponCode : $payment_mode_data['PromoCode'];
        $obj->sql_query("UPDATE payment_mode_user_log SET vPromocode = '' WHERE iLogId = '" . $payment_mode_data['iLogId'] . "'");
    } else {
        $ePaymentMode = "Cash";
        $cashPayment = "Yes";
    }
    /* For New Payment Flow End */
    ####### blocking code ################
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $BlockData = getBlockData("Passanger", $iUserId);
        if (!empty($BlockData) || $BlockData != "") {
            setDataResponse($BlockData);
        }
    }
    if (empty($eServiceLocation)) {
        $eServiceLocation = "Passenger";
    }
    if ($APP_TYPE == "Ride-Delivery-UberX") {
        $sqldata = "SELECT iTripId FROM `trips` WHERE iActive='On Going Trip'  AND iUserId='" . $iUserId . "' AND eType != 'UberX' AND eType != 'Multi-Delivery' AND eSystem != 'DeliverAll'";
        $TripData = $obj->MySQLSelect($sqldata);
        if (count($TripData) > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_ONGOING_TRIP_USER_TXT";
            setDataResponse($returnArr);
        }
    }
    $action = ($iCabBookingId != "") ? 'Edit' : 'Add';
    if ($eType == "") {
        $eType = $APP_TYPE == "Delivery" ? "Deliver" : $APP_TYPE;
    }
    $paymentMode = "Card";
    if ($cashPayment == 'Yes') {
        $paymentMode = "Cash";
    }
    /* For New Payment Flow */
    $paymentMode =mb_convert_case($ePaymentMode, MB_CASE_TITLE, 'UTF-8');
  //  $paymentMode = ucfirst($ePaymentMode);
    /* For New Payment Flow End */
    isMemberEmailPhoneVerified($iUserId, "Passenger");
    ## Check Pickup Address For UberX##
    $fAmount = 0;
    $ALLOW_SERVICE_PROVIDER_AMOUNT = "No";
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if ($eType == "UberX") {
        if ($quantity < 1) {
            $quantity = 1;
        }
        $minHour_ufx = -1;
        $Data['tUserComment'] = $tUserComment;
        //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount Start
        $fareDetails = array();
        if ($SERVICE_PROVIDER_FLOW == "Provider") {
            $fareDetails = getVehicleTypeFareDetails();
            if (!empty($fareDetails)) {
                $Data['tVehicleTypeFareData'] = json_encode($fareDetails['tripFareDetailsSaveArr']);
            }
            $typeDataArr = json_decode($orderDetails);
            $iVehicleTypeId = 0;
            if (count($typeDataArr) == 1) {
                $iVehicleTypeId = $typeDataArr[0]->iVehicleTypeId;
            }
        }
        //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount End
        // added for payment method 2 //
        if (isset($fareDetails['originalFareTotal']) && !empty($fareDetails['originalFareTotal'])) {
            $iPrice = $fareDetails['originalFareTotal'];
        } else if ($iVehicleTypeId > 0) {
            $sqlv = "SELECT vt.iVehicleCategoryId,vc.iParentId,vt.eFareType,vt.ePickStatus,vt.eNightStatus,vt.fFixedFare, vt.iBaseFare, vt.iMinFare, vt.fMinHour,vc.ePriceType From vehicle_type as vt LEFT JOIN " . $sql_vehicle_category_table_name . " as vc ON  vc.iVehicleCategoryId = vt.iVehicleCategoryId WHERE vt.iVehicleTypeId = '" . $iVehicleTypeId . "'";
            $tripVehicleData = $obj->MySQLSelect($sqlv);
            $iVehicleCategoryId = $tripVehicleData[0]['iVehicleCategoryId'];
            $vVehicleTypeName = $tripVehicleData[0]['vVehicleTypeName'];
            $eFareType = $tripVehicleData[0]['eFareType'];
            $iParentId = $tripVehicleData[0]['iParentId'];
            if ($iParentId == 0) {
                $ePriceType = $tripVehicleData[0]['ePriceType'];
            } else {
                $ePriceType = get_value($sql_vehicle_category_table_name, 'ePriceType', 'iVehicleCategoryId', $iParentId, '', 'true');
            }
            $ALLOW_SERVICE_PROVIDER_AMOUNT = $ePriceType == "Provider" ? "Yes" : "No";
            if ($eFareType != "Regular") {
                if ($eFareType == "Fixed") {
                    $fAmount = $tripVehicleData[0]['fFixedFare'] * $quantity;
                } else {
                    $minHour_ufx = $tripVehicleData[0]['fMinHour'];
                }
                //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount Start
                $checkProviderAmt = 1;
                if (isset($fareDetails['originalFareTotal']) && $fareDetails['originalFareTotal'] > 0) {
                    $iPrice = $fareDetails['originalFareTotal'];
                    $vVehicleTypeName = $fareDetails['ParentCategoryName'];
                    $checkProviderAmt = 0;
                }
                //Added By HJ On 01-02-2019 For Get Vehicle Type Total Fare Amount End
                if ($ALLOW_SERVICE_PROVIDER_AMOUNT == "Yes" && $checkProviderAmt == 1) {
                    $sql12 = "SELECT iDriverVehicleId FROM  `driver_vehicle` WHERE iDriverId = '" . $iDriverId . "' AND eType='UberX'";
                    $drivervehicleData = $obj->MySQLSelect($sql12);
                    $iDriverVehicleId = $drivervehicleData[0]['iDriverVehicleId'];
                    $sqlServicePro = "SELECT * FROM `service_pro_amount` WHERE iDriverVehicleId='" . $iDriverVehicleId . "' AND iVehicleTypeId='" . $iVehicleTypeId . "'";
                    $serviceProData = $obj->MySQLSelect($sqlServicePro);
                    if (count($serviceProData) > 0) {
                        $fAmount = $serviceProData[0]['fAmount'] * $quantity;
                    } else {
                        $fAmount = $iPrice;
                    }
                    $iPrice = $fAmount;
                }
            } else {
                $iBaseFare = round($tripVehicleData[0]['iBaseFare'], 2);
                $iMinFare = round($tripVehicleData[0]['iMinFare'], 2);
                $fAmount = ($iMinFare > $iBaseFare) ? $iMinFare : $iBaseFare;
            }
            $iPrice = $fAmount;
        }
        // added for payment method 2 //
        if ($iUserAddressId != "") {
            //$pickUpLocAdd=get_value('user_address', 'vServiceAddress', '  iUserAddressId',$iUserAddressId,'','true');
            $Address = get_value('user_address', 'vAddressType,vBuildingNo,vLandmark,vServiceAddress,vLatitude,vLongitude', '   iUserAddressId', $iUserAddressId, '', '');
            $vAddressType = $Address[0]['vAddressType'];
            $vBuildingNo = $Address[0]['vBuildingNo'];
            $vLandmark = $Address[0]['vLandmark'];
            $vServiceAddress = $Address[0]['vServiceAddress'];
            $pickUpLocAdd = ($vAddressType != "") ? $vAddressType . "\n" : "";
            $pickUpLocAdd .= ($vBuildingNo != "") ? $vBuildingNo . "," : "";
            $pickUpLocAdd .= ($vLandmark != "") ? $vLandmark . "\n" : "";
            $pickUpLocAdd .= ($vServiceAddress != "") ? $vServiceAddress : "";
            $Data['vSourceAddresss'] = $pickUpLocAdd;
            $Data['iUserAddressId'] = $iUserAddressId;
            $pickUpLatitude = $Address[0]['vLatitude'];
            $pickUpLongitude = $Address[0]['vLongitude'];
        } else {
            $Data['vSourceAddresss'] = $pickUpLocAdd;
        }
        $eAutoAssign = 'No';
    } else {
        $Data['vSourceAddresss'] = $pickUpLocAdd;
        $eAutoAssign = 'Yes';
    }
    ### Checking For Pickup And DropOff Disallow ###
    $pickuplocationarr = array($pickUpLatitude, $pickUpLongitude);
    $dropofflocationarr = array($destLatitude, $destLongitude);
    $allowed_ans_pickup = checkAreaRestriction($pickuplocationarr, "No");
    if ($allowed_ans_pickup == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICKUP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    if ($destLatitude != "" && $destLongitude != "") {
        $allowed_ans_dropoff = checkAreaRestriction($dropofflocationarr, "Yes");
        if ($allowed_ans_dropoff == "No") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_DROP_LOCATION_NOT_ALLOW";
            setDataResponse($returnArr);
        }
    }
    ### Checking For Pickup And DropOff Disallow ###
    ## Check Pickup Address For UberX##
    ## Check For PichUp/DropOff Location DisAllow ##
    $address_data['PickUpAddress'] = $pickUpLocAdd;
    $address_data['DropOffAddress'] = $destLocAdd;
    $DropOff = "No";
    if ($destLatitude != "" && $destLongitude != "") {
        $DropOff = "Yes";
    }
    $DataArr = FetchAvailableDrivers($pickUpLatitude, $pickUpLongitude, $address_data, $DropOff, "No", "No", "", $destLatitude, $destLongitude, $eType, "", $iDriverId);
    if ($DataArr['PickUpDisAllowed'] == "No" && $DataArr['DropOffDisAllowed'] == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICK_DROP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    if ($DataArr['PickUpDisAllowed'] == "Yes" && $DataArr['DropOffDisAllowed'] == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_DROP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    if ($DataArr['PickUpDisAllowed'] == "No" && $DataArr['DropOffDisAllowed'] == "Yes") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICKUP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    ## Check For PichUp/DropOff Location DisAllow Ends##
    if ($eType == "UberX") {
        $sdate = explode(" ", $scheduleDate);
        $shour = explode("-", $sdate[1]);
        $shour1 = $shour[0];
        $shour2 = $shour[1];
        if ($shour1 == "12" && $shour2 == "01") {
            $shour1 = 00;
        }
        $scheduleDate = $sdate[0] . " " . $shour1 . ":00:00";
        $currentdate = date("Y-m-d H:i:s");
        $datediff = strtotime($scheduleDate) - strtotime($currentdate);
    }
    $Booking_Date_Time = $scheduleDate;
    $systemTimeZone = date_default_timezone_get();
    $scheduleDate = converToTz($scheduleDate, $systemTimeZone, $vTimeZone);
    if ($eType == "UberX") {
        $dateprevious = date('Y-m-d H:i', strtotime($scheduleDate));
        $sqlprevious = " SELECT * FROM cab_booking WHERE eType = 'UberX' AND dBooking_date = '" . $dateprevious . "' AND iDriverId = $iDriverId AND eStatus IN ('Pending', 'Assign', 'Accepted')";
        $resultprevious = $obj->MySQLSelect($sqlprevious);
        if (count($resultprevious) > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_PROVIDER_NOT_AVAIL_NOTE";
            setDataResponse($returnArr);
        }
    }
    if ($iVehicleTypeId > 0) {
        $SurchargeDetail = get_value('vehicle_type', 'ePickStatus,eNightStatus', 'iVehicleTypeId', $iVehicleTypeId);
        $ePickStatus = $SurchargeDetail[0]['ePickStatus'];
        $eNightStatus = $SurchargeDetail[0]['eNightStatus'];
    }
    $fPickUpPrice = $fNightPrice = 1;
    ## Checking For Flat Trip ##
    $eFlatTrip = "No";
    $fFlatTripPrice = 0;
    if ($eType == "Ride" && strtoupper(PACKAGE_TYPE) != "STANDARD") {
        $data_flattrip = checkFlatTripnew($pickuplocationarr, $dropofflocationarr, $iVehicleTypeId, $iRentalPackageId);
        $eFlatTrip = $data_flattrip['eFlatTrip'];
        $fFlatTripPrice = $data_flattrip['Flatfare'];
    }
    if ($StopOverPointAdded == "Yes") {
        $eFlatTrip = "No";
        $fFlatTripPrice = 0;
    }
    ## Checking For Flat Trip ##
    if ($eType != "UberX") {
        $data_surgePrice = checkSurgePrice($iVehicleTypeId, $Booking_Date_Time, $iRentalPackageId);
        if ($data_surgePrice['Action'] == "0") {
            if ($data_surgePrice['message'] == "LBL_PICK_SURGE_NOTE") {
                $fPickUpPrice = $data_surgePrice['SurgePriceValue'];
            } else {
                $fNightPrice = $data_surgePrice['SurgePriceValue'];
            }
        }
    }
    if ($APPLY_SURGE_ON_FLAT_FARE == "No" && $eFlatTrip == "Yes") {
        $fPickUpPrice = $fNightPrice = 1;
    }
    // add airport surge //
    $fpickupsurchargefare = $fdropoffsurchargefare = 0;
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        if ($ENABLE_AIRPORT_SURCHARGE_SECTION == 'Yes' && $eType != "UberX") {
            $pickuplocationarr = array($pickUpLatitude, $pickUpLongitude);
            $dropofflocationarr = array($destLatitude, $destLongitude);
            $GetVehicleIdfromGeoLocation = CheckSurgeAirportFromGeoLocation($pickuplocationarr, $dropofflocationarr, $iVehicleTypeId);
            $fpickupsurchargefare = $GetVehicleIdfromGeoLocation['fpickupsurchargefare'];
            $fdropoffsurchargefare = $GetVehicleIdfromGeoLocation['fdropoffsurchargefare'];
            //$airportsurgetype = $AIRPORT_SURGE_ADD_OR_OVERRIDE;
        }
    }
    $Data_update_passenger['fAirportPickupSurge'] = $fpickupsurchargefare;
    $Data_update_passenger['fAirportDropoffSurge'] = $fdropoffsurchargefare;
    // end airport surge //
    if ($eTollSkipped == 'No' || $fTollPrice != "") {
        $fTollPrice_Original = $fTollPrice;
        $vTollPriceCurrencyCode = strtoupper($vTollPriceCurrencyCode);
        $default_currency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        $sql = " SELECT round(($fTollPrice/(SELECT Ratio FROM currency where vName='" . $vTollPriceCurrencyCode . "'))*(SELECT Ratio FROM currency where vName='" . $default_currency . "' ) ,2)  as price FROM currency  limit 1";
        $result = $obj->MySQLSelect($sql);
        $fTollPrice = $result[0]['price'];
        if ($fTollPrice == 0) {
            $fTollPrice = FetchTollPrice($vTollPriceCurrencyCode, $default_currency, $fTollPrice_Original);
        }
        $Data['fTollPrice'] = $fTollPrice;
        $Data['vTollPriceCurrencyCode'] = $vTollPriceCurrencyCode;
        $Data['eTollSkipped'] = $eTollSkipped;
    } else {
        $Data['fTollPrice'] = "0";
        $Data['vTollPriceCurrencyCode'] = "";
        $Data['eTollSkipped'] = "No";
    }
    $rand_num = rand(10000000, 99999999);
    /* $Booking_Date = @date('d-m-Y',strtotime($scheduleDate));
    $Booking_Time = @date('H:i:s',strtotime($scheduleDate)); */
    $Booking_Date = @date('d-m-Y', strtotime($Booking_Date_Time));
    $Booking_Time = @date('H:i:s', strtotime($Booking_Date_Time));
    $Data['iUserId'] = $iUserId;
    $Data['vSourceLatitude'] = $pickUpLatitude;
    $Data['vSourceLongitude'] = $pickUpLongitude;
    $Data['vDestLatitude'] = $destLatitude;
    $Data['vDestLongitude'] = $destLongitude;
    //$Data['vSourceAddresss']=$pickUpLocAdd;
    $Data['tDestAddress'] = $destLocAdd;
    $Data['ePayType'] = $paymentMode;
    $Data['iVehicleTypeId'] = $iVehicleTypeId;
    $Data['dBooking_date'] = date('Y-m-d H:i', strtotime($scheduleDate));
    $Data['eCancelBy'] = "";
    $Data['fPickUpPrice'] = $fPickUpPrice;
    $Data['fNightPrice'] = $fNightPrice;
    $Data['eType'] = $eType;
    $Data['iUserPetId'] = $iUserPetId;
    $Data['iQty'] = $quantity;
    $Data['vCouponCode'] = $vCouponCode;
    $Data['eAutoAssign'] = $eAutoAssign;
    $Data['vRideCountry'] = $vCountryCode;
    $Data['iDriverId'] = $iDriverId;
    $Data['vTimeZone'] = $vTimeZone;
    $Data['eFemaleDriverRequest'] = $PreferFemaleDriverEnable;
    $Data['eHandiCapAccessibility'] = $HandicapPrefEnabled;
    $Data['eFlatTrip'] = $eFlatTrip;
    $Data['fFlatTripPrice'] = $fFlatTripPrice;
    $Data['eWalletDebitAllow'] = $eWalletDebitAllow;
    /* added for rental */
    $Data['iRentalPackageId'] = $iRentalPackageId;
    $Data['vDistance'] = $vDistance;
    $Data['vDuration'] = $vDuration;
    $Data['tTotalDistance'] = !empty($Data['vDistance']) ? $Data['vDistance'] : $vDistance;
    $Data['tTotalDuration'] = !empty($Data['vDuration']) ? $Data['vDuration'] : $vDuration;
    $Data['iPaymentInfoId'] = $iPaymentInfoId;
    $Data['isVideoCall'] = $isVideoCall;
    ################## Book For Someone Else ############################
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        BookForSomeOneElse();
    }
    ################## Book For Someone Else ############################
    // Payment Method 2 Flow Start
    $Data['ePayWallet'] = $ePayWallet;
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data Start
    $Data['eServiceLocation'] = $eServiceLocation;
    //$Data['tVehicleTypeData'] = stripcslashes($orderDetails); // Commented By HJ On 23-11-2019 For Soled \n data issue
    $Data['tVehicleTypeData'] = $orderDetails; // Added By HJ On 23-11-2019 For Soled \n data issue
    //Added By HJ On 01-02-2019 For Store Service Related Vehicle Type Data End
    $isDestinationAdded = "No";
    if ($destLatitude != "" && $destLongitude != "") {
        $isDestinationAdded = "Yes";
    }
    $user_available_balance_wallet = $WALLET_OBJ->FetchMemberWalletBalance($iUserId, "Rider", true);
    $walletDataArr = array();
    if (is_array($user_available_balance_wallet)) {
        $walletDataArr = $user_available_balance_wallet;
        $user_available_balance_wallet = $walletDataArr['CurrentBalance'];
        $Data['tUserWalletBalance'] = $walletDataArr['AutorizedWalletBalance'];
    }
    $UserDetail = get_value('register_user AS ru LEFT JOIN currency AS c ON c.vName=ru.vCurrencyPassenger', 'ru.vCurrencyPassenger,ru.vLang,c.Ratio,c.vSymbol', 'ru.iUserId', $iUserId);
    $userLanguageCode = $UserDetail[0]['vLang'];
    $ratio = $UserDetail[0]['Ratio'];
    $currency_vSymbol = $UserDetail[0]['vSymbol'];
    $currencycode = $UserDetail[0]['vCurrencyPassenger'];
    $userLanguageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userLanguageCode, "1", $iServiceId);
    $user_available_balance_wallet = $user_available_balance_wallet * $ratio;
    //Added By HJ On 10-06-2019 For Get User Out Standing Amount For Payment Method 2 Or 3 Start
    $userOutStandingAmt = 0;
    $outstandingIds = "";
    // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
    if (strtoupper($ePayWallet) == "YES") {
        $getUserOutstandingAmount = getUserOutstandingAmount($iUserId, "iCabBookingId");
        $userOutStandingAmt = $getUserOutstandingAmount['fPendingAmount'];
        $outstandingIds = $getUserOutstandingAmount['iTripOutstandId'];
    }
    //Added By HJ On 10-06-2019 For Get User Out Standing Amount For Payment Method 2 Or 3 End
    /*     * ****** Checking wallet balance for system payment floe for method-2/method-3 ********** */
    // if (($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') && ($cashPayment == 'false' || $cashPayment == 'No')) {
    if (strtoupper($ePayWallet) == "YES") {
        $fareAmount = 0;
        if (isset($fareDetails['tripFareDetailsSaveArr']) && count($fareDetails['tripFareDetailsSaveArr']) > 0) {
            $minHour = -1;
            if (!empty($fareDetails['tripFareDetailsSaveArr']['eFareTypeServices']) && $fareDetails['tripFareDetailsSaveArr']['eFareTypeServices'] == "Hourly" && count($fareDetails['tripFareDetailsSaveArr']['FareData']) > 0) {
                $minHour = $fareDetails['tripFareDetailsSaveArr']['FareData'][0]['MinimumHour'];
            }
            $fareAmount = $fareDetails['tripFareDetailsSaveArr']['originalFareTotal'];
            //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir Start
            if ($vCouponCode != "") {
                $discValue = EvaluatePromoCodeValue($vCouponCode, $fareAmount, $ratio);
                if ($discValue > 0) {
                    $fareAmount = $fareAmount - $discValue;
                }
            }
            //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir End
            if ($minHour > 0) {
                $fareAmount = $fareAmount * $minHour;
            }
        } else if ($iVehicleTypeId > 0 && $isDestinationAdded == "Yes") {
            $Fare_data_New = calculateApproximateFareGeneral($vDuration, $vDistance, $iVehicleTypeId, $iUserId, 1, "", "", $vCouponCode, 1, 0, 0, 0, "DisplySingleVehicleFare", "Passenger", 1, "", $isDestinationAdded, $eFlatTrip, $fFlatTripPrice, $pickuplocationarr, $dropofflocationarr, "Yes", $eType, $scheduleDate);
            $fareAmount = $Fare_data_New[0]['total_fare_amount'];
            if ($Fare_data_New[0]['eRental'] == "Yes" && $Fare_data_New[0]['eRental_total_fare_value'] > 0 && !empty($_REQUEST["iRentalPackageId"]) && $_REQUEST["iRentalPackageId"] > 0) {
                $fareAmount = $Fare_data_New[0]['eRental_total_fare_value'];
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir Start
                if ($vCouponCode != "") {
                    $discValue = EvaluatePromoCodeValue($vCouponCode, $fareAmount, $ratio);
                    if ($discValue > 0) {
                        $fareAmount = $fareAmount - $discValue;
                    }
                }
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir End
            }
            if (!empty($Data['fTollPrice']) && $Data['fTollPrice'] > 0 && !empty($Data['eTollSkipped']) && strtoupper($Data['eTollSkipped']) == "NO") {
                $fareAmount = $fareAmount + $Data['fTollPrice'];
            }
        } else if ($iVehicleTypeId > 0 && $isDestinationAdded != "Yes" && $eType == 'Ride') {
            $Fare_data_New = calculateApproximateFareGeneral($vDuration, $vDistance, $iVehicleTypeId, $iUserId, 1, "", "", $vCouponCode, 1, 0, 0, 0, "DisplySingleVehicleFare", "Passenger", 1, "", $isDestinationAdded, $eFlatTrip, $fFlatTripPrice, $pickuplocationarr, $dropofflocationarr, "Yes", $eType, $scheduleDate);
            $fareAmount = $Fare_data_New[0]['total_fare_amount'];
            if ($Fare_data_New[0]['eRental'] == "Yes" && $Fare_data_New[0]['eRental_total_fare_value'] > 0 && !empty($_REQUEST["iRentalPackageId"]) && $_REQUEST["iRentalPackageId"] > 0) {
                $Fare_data_New[0]['fBufferAmount'] = 0;
                $fareAmount = $Fare_data_New[0]['eRental_total_fare_value'];
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir Start
                if ($vCouponCode != "") {
                    $discValue = EvaluatePromoCodeValue($vCouponCode, $fareAmount, $ratio);
                    if ($discValue > 0) {
                        $fareAmount = $fareAmount - $discValue;
                    }
                }
                //Added By HJ On 07-08-2019 For Calculate Promocode Discount For UbeX App Type As Per Discuss with KS Sir End
            }
            $fBufferAmount = $Fare_data_New[0]['fBufferAmount'];
            if ($fBufferAmount > 0) {
                $fBufferAmount = $fBufferAmount * $ratio;
            }
            $fareAmount = $fareAmount + $fBufferAmount;
        } else if ($iVehicleTypeId > 0 && $eType == 'UberX') {
            $fareAmount = $iPrice * $ratio;
            if (!empty($minHour_ufx) && $minHour_ufx > 0) {
                $fareAmount = $fareAmount * $minHour_ufx;
            }
        }
        $fareAmount = setTwoDecimalPoint($fareAmount + $userOutStandingAmt); // Added By HJ On 10-06-2019 For Payment Flow 2/3
        if ($user_available_balance_wallet < $fareAmount && $eWalletIgnore == 'No') {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LOW_WALLET_AMOUNT";
            if (!empty($walletDataArr) && count($walletDataArr) > 0) {
                $auth_wallet_amount = strval(setTwoDecimalPoint((isset($walletDataArr['TotalAuthorizedAmount']) ? $walletDataArr['TotalAuthorizedAmount'] : 0) * $ratio));
                //$returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? ($currency_vSymbol . ' ' . $auth_wallet_amount) : "";
                $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? formateNumAsPerCurrency($auth_wallet_amount, $currencycode) : "";
                $returnArr['AUTH_AMOUNT_VALUE'] = $auth_wallet_amount > 0 ? $auth_wallet_amount : "";
                //$returnArr['ORIGINAL_WALLET_BALANCE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? $walletDataArr['WalletBalance'] : 0) * $ratio));
                $returnArr['ORIGINAL_WALLET_BALANCE'] = isset($walletDataArr['WalletBalance']) ? formateNumAsPerCurrency(($walletDataArr['WalletBalance'] * $ratio), $currencycode) : 0;
                $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? $walletDataArr['WalletBalance'] : 0) * $ratio));
            }
            //$returnArr['CURRENT_JOB_EST_CHARGE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint($fareAmount));
            $returnArr['CURRENT_JOB_EST_CHARGE'] = formateNumAsPerCurrency($fareAmount, $currencycode);
            $returnArr['CURRENT_JOB_EST_CHARGE_VALUE'] = strval(setTwoDecimalPoint($fareAmount));
            //$returnArr['WALLET_AMOUNT_NEEDED'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint($fareAmount - $user_available_balance_wallet));
            $returnArr['WALLET_AMOUNT_NEEDED'] = formateNumAsPerCurrency(($fareAmount - $user_available_balance_wallet), $currencycode);
            $returnArr['WALLET_AMOUNT_NEEDED_VALUE'] = strval(setTwoDecimalPoint($fareAmount - $user_available_balance_wallet));
            if (!empty($walletDataArr) && count($walletDataArr) > 0 && $auth_wallet_amount > 0) {
                $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT'];
                // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT_NO_CASH'];
                }
                $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                    $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                }
                if (!empty($returnArr['AUTH_AMOUNT'])) {
                    $content_msg_low_balance = str_replace("###", $returnArr['AUTH_AMOUNT'], $content_msg_low_balance);
                }
                $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
            } else {
                $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT'];
                // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT_NO_CASH'];
                }
                $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                    $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                }
                if (!empty($returnArr['CURRENT_JOB_EST_CHARGE'])) {
                    $content_msg_low_balance = str_replace("###", $returnArr['CURRENT_JOB_EST_CHARGE'], $content_msg_low_balance);
                }
                $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
            }
            // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
            if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "Yes";
            } else {
                $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "No";
            }
            setDataResponse($returnArr);
        }
        $Data['tEstimatedCharge'] = $fareAmount / $ratio;
    }
    /*     * ****** Checking wallet balance for system payment floe for method-2/method-3 ********** */
    // Payment Method 2 Flow End
    if ($eType == "Deliver") {
        $Data['iPackageTypeId'] = $iPackageTypeId;
        $Data['vReceiverName'] = $vReceiverName;
        $Data['vReceiverMobile'] = $vReceiverMobile;
        $Data['tPickUpIns'] = $tPickUpIns;
        $Data['tDeliveryIns'] = $tDeliveryIns;
        $Data['tPackageDetails'] = $tPackageDetails;
    }
    if ($eType == "Multi-Delivery") {
        $data_fare = calculateFareEstimateAllMultiDelivery($total_del_time, $total_del_dist, $iVehicleTypeId, $iUserId, 1, "", "", $vCouponCode, 1, 0, 0, 0, "DisplySingleVehicleFare", "Passenger", 1, "", "", $eFlatTrip, $fFlatTripPrice, "", "", "Yes", $eType, $scheduleDate, $ePaymentBy, $eWalletDebitAllow);
        if (!empty($Data['fTollPrice']) && $Data['fTollPrice'] > 0 && !empty($Data['eTollSkipped']) && strtoupper($Data['eTollSkipped']) == "NO") {
            $data_fare[0]['TotalGenratedFare'] = $data_fare[0]['TotalGenratedFare'] + $Data['fTollPrice'] + $userOutStandingAmt; // $userOutStandingAmt Added By HJ On 10-06-2019 For Payment Flow 2/3
        }
        /*         * ****** Checking wallet balance for system payment floe for method-2/method-3 ********** */
        // if (($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') && ($cashPayment == 'false' || $cashPayment == 'No')) {
        if (strtoupper($ePayWallet) == "YES") {
            if ($user_available_balance_wallet < ($data_fare[0]['TotalGenratedFare'] * $ratio) && $eWalletIgnore == 'No') {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LOW_WALLET_AMOUNT";
                if (!empty($walletDataArr) && count($walletDataArr) > 0) {
                    $auth_wallet_amount = strval(setTwoDecimalPoint(setTwoDecimalPoint((isset($walletDataArr['TotalAuthorizedAmount']) ? $walletDataArr['TotalAuthorizedAmount'] : 0) * $ratio)));
                    $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? formateNumAsPerCurrency($auth_wallet_amount, $currencycode) : "";
                    $returnArr['AUTH_AMOUNT_VALUE'] = $auth_wallet_amount > 0 ? $auth_wallet_amount : "";
                    //$returnArr['ORIGINAL_WALLET_BALANCE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? $walletDataArr['WalletBalance'] : 0) * $ratio));
                    $returnArr['ORIGINAL_WALLET_BALANCE'] = isset($walletDataArr['WalletBalance']) ? formateNumAsPerCurrency($walletDataArr['WalletBalance'] * $ratio, $currencycode) : 0;
                    $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? $walletDataArr['WalletBalance'] : 0) * $ratio));
                }
                // $returnArr['CURRENT_JOB_EST_CHARGE'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio)));
                $returnArr['CURRENT_JOB_EST_CHARGE'] = formateNumAsPerCurrency(($data_fare[0]['TotalGenratedFare'] * $ratio), $currencycode);
                $returnArr['CURRENT_JOB_EST_CHARGE_VALUE'] = strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio)));
                //$returnArr['WALLET_AMOUNT_NEEDED'] = $currency_vSymbol . ' ' . strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio) - $user_available_balance_wallet));
                $walletamountneeded = ($data_fare[0]['TotalGenratedFare'] * $ratio) - $user_available_balance_wallet;
                $returnArr['WALLET_AMOUNT_NEEDED'] = formateNumAsPerCurrency($walletamountneeded, $currencycode);
                $returnArr['WALLET_AMOUNT_NEEDED_VALUE'] = strval(setTwoDecimalPoint(($data_fare[0]['TotalGenratedFare'] * $ratio) - $user_available_balance_wallet));
                if (!empty($walletDataArr) && count($walletDataArr) > 0 && $auth_wallet_amount > 0) {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT'];
                    if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                        $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT_NO_CASH'];
                    }
                    $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                    if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                        $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                    }
                    if (!empty($returnArr['AUTH_AMOUNT'])) {
                        $content_msg_low_balance = str_replace("###", $returnArr['AUTH_AMOUNT'], $content_msg_low_balance);
                    }
                    $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                    $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                } else {
                    $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT'];
                    if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                        $content_msg_low_balance = $userLanguageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT_NO_CASH'];
                    }
                    $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                    if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                        $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                    }
                    if (!empty($returnArr['CURRENT_JOB_EST_CHARGE'])) {
                        $content_msg_low_balance = str_replace("###", $returnArr['CURRENT_JOB_EST_CHARGE'], $content_msg_low_balance);
                    }
                    $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                    $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                }
                // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                    $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "Yes";
                } else {
                    $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "No";
                }
                setDataResponse($returnArr);
            }
            $Data['tEstimatedCharge'] = $data_fare[0]['TotalGenratedFare'];
        }
        /*         * ****** Checking wallet balance for system payment floe for method-2/method-3 ********** */
        $fTripGenerateFare = $data_fare[0]['TotalGenratedFare'];
        $Data['iFare'] = $data_fare[0]['iFare_Ori'];
        $Data['iBaseFare'] = $data_fare[0]['iBaseFare_AMT'];
        $Data['fPricePerMin'] = $data_fare[0]['FareOfMinutes_Ori'];
        $Data['fPricePerKM'] = $data_fare[0]['FareOfDistance_Ori'];
        $Data['fCommision'] = $data_fare[0]['fCommision_AMT'];
        $Data['fSurgePriceDiff'] = $data_fare[0]['fSurgePriceDiff_Ori'];
        $Data['fTax1'] = $data_fare[0]['fTax1_Ori'];
        $Data['fTax2'] = $data_fare[0]['fTax2_Ori'];
        $Data['fDiscount'] = $data_fare[0]['fDiscount_Ori'];
        $Data['vDiscount'] = $data_fare[0]['vDiscount'];
        $Data['fMinFareDiff'] = $data_fare[0]['fMinFareDiff_Ori'];
        $Data['fTripGenerateFare'] = $fTripGenerateFare;
        $Data['vDistance'] = $total_del_dist;
        $Data['vDuration'] = $total_del_time;
        //added by SP for rounding off on 7-11-2019 for multi delivery
        $Data['fRoundingAmount'] = $data_fare[0]['fRoundingAmount'];
        $Data['eRoundingType'] = $data_fare[0]['eRoundingType'];
    }
    // if (!empty($Data['tEstimatedCharge']) && $Data['tUserWalletBalance'] > $Data['tEstimatedCharge'] && ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3')) {
    if (!empty($Data['tEstimatedCharge']) && $Data['tUserWalletBalance'] > $Data['tEstimatedCharge'] && strtoupper($ePayWallet) == "YES") {
        $Data['tUserWalletBalance'] = $Data['tEstimatedCharge'];
    }
    if ($eType == "UberX" && $SERVICE_PROVIDER_FLOW == "Provider" && $eServiceLocation == "Driver" && $action == "Add") {
        //$provider_data = get_value('register_driver', 'eSelectWorkLocation,vWorkLocationLatitude,vWorkLocationLongitude,vWorkLocation,vLatitude,vLongitude,vLang', 'iDriverId', $iDriverId);
        //Added By HJ On 05-10-2020 For Optimize register_driver Table Query Start
        if (isset($userDetailsArr['register_driver_' . $iDriverId])) {
            $provider_data = $userDetailsArr['register_driver_' . $iDriverId];
        } else {
            $provider_data = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM register_driver WHERE iDriverId='" . $iDriverId . "'");
            $userDetailsArr['register_driver_' . $driverId] = $provider_data;
        }
        //Added By HJ On 05-10-2020 For Optimize register_driver Table Query End
        if ($provider_data[0]['eSelectWorkLocation'] == "Dynamic") {
            $Data['vWorkLocationLatitude'] = $provider_data[0]['vLatitude'];
            $Data['vWorkLocationLongitude'] = $provider_data[0]['vLongitude'];
            $url_driver_geo = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" . $provider_data[0]['vLatitude'] . "," . $provider_data[0]['vLongitude'] . "&key=" . $GOOGLE_SEVER_GCM_API_KEY . "&language=" . $provider_data[0]['vLang'];
            try {
                $jsonfile_driver_geo = file_get_contents($url_driver_geo);
                $jsondata_driver_geo = json_decode($jsonfile_driver_geo);
                $source_address_driver_geo = $jsondata_driver_geo->results[0]->formatted_address;
                $Data['vWorkLocation'] = $source_address_driver_geo;
            } catch (ErrorException $ex) {
            }
        } else {
            $Data['vWorkLocation'] = $provider_data[0]['vWorkLocation'];
            $Data['vWorkLocationLatitude'] = $provider_data[0]['vWorkLocationLatitude'];
            $Data['vWorkLocationLongitude'] = $provider_data[0]['vWorkLocationLongitude'];
        }
        $Data['vSourceLatitude'] = $Data['vWorkLocationLatitude'];
        $Data['vSourceLongitude'] = $Data['vWorkLocationLongitude'];
        $Data['vSourceAddresss'] = $Data['vWorkLocation'];
        $Data['eSelectWorkLocation'] = $provider_data[0]['eSelectWorkLocation'];
    }
    $GetiCompanyId = get_value('register_driver', 'iCompanyId', 'iDriverId', $iDriverId, '', 'true');
    $Data['iCompanyId'] = $GetiCompanyId;
    if ($action == "Add") {
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            GetScheduleParam();
        }
        if ($iTripReasonId != "" || $vReasonTitle != "") {
            $Data['iTripReasonId'] = $iTripReasonId;
            $Data['vReasonTitle'] = $vReasonTitle;
            $Data['eTripReason'] = "Yes";
        }
        $Data['vBookingNo'] = $rand_num;
        $id = $obj->MySQLQueryPerform("cab_booking", $Data, 'insert');
    } else {
        $Data['eStatus'] = "Pending";
        $Data['iCancelByUserId'] = "";
        $Data['vCancelReason'] = "";
        $where = " iCabBookingId = '" . $iCabBookingId . "'";
        $id = $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
    }
    /* ------------ Added By HJ On 28-09-2020 For Ride Later Booking Of Multi Delivery Type ------------ */
    $insert_id = $id;
    $delivery_arr = isset($_REQUEST["delivery_arr"]) ? $_REQUEST["delivery_arr"] : '';
    if ($delivery_arr != "" && ($eType == "Multi-Delivery" || $eType == "Deliver") && strtoupper($DELIVERY_LATER_BOOKING_ENABLED) == "YES") {
        // Added by HV on 05-03-2021 for Parcel Delivery - Book later
        $obj->sql_query("UPDATE cab_booking SET tDeliveryData = '$delivery_arr' WHERE iCabBookingId = '$insert_id'");
        $details_arr = json_decode($delivery_arr, true);
        $j = 0;
        $last_key = end(array_keys($details_arr));
        foreach ($details_arr as $key123 => $values1) {
            $i = 0;
            $insert_did = array();
            foreach ($values1 as $key => $value) {
                //$Data_trip_locations = array();
                if ($key == "vReceiverAddress" || $key == "vReceiverLatitude" || $key == "vReceiverLongitude" || $key == "ePaymentByReceiver") {
                    $Data_trip_locations[$key] = $value;
                    if ($key == "vReceiverLatitude") {
                        $Old_end_lat = $Data_trip_locations['tEndLat'];
                        $Data_trip_locations['tEndLat'] = $value;
                    } else if ($key == "vReceiverLongitude") {
                        $Old_end_long = $Data_trip_locations['tEndLong'];
                        $Data_trip_locations['tEndLong'] = $value;
                    } else if ($key == "vReceiverAddress") {
                        $Old_end_address = $Data_trip_locations['tDaddress'];
                        $Data_trip_locations['tDaddress'] = $value;
                    } else if ($key == "ePaymentByReceiver") {
                        $Data_trip_locations['ePaymentByReceiver'] = $value;
                    }
                    if (($ePaymentBy == "Sender" || $ePaymentBy == "Receiver") && $key123 != 0) {
                        $Data_trip_locations['tStartLat'] = $Old_end_lat;
                        $Data_trip_locations['tStartLong'] = $Old_end_long;
                        $Data_trip_locations['tSaddress'] = $Old_end_address;
                    } else {
                        $Data_trip_locations['tStartLat'] = $PickUpLatitude;
                        $Data_trip_locations['tStartLong'] = $PickUpLongitude;
                        $Data_trip_locations['tSaddress'] = $PickUpAddress;
                    }
                } else {
                    $deliveryDataArr[$key] = $value;
                    $Data_delivery['iDeliveryFieldId'] = $key;
                    $Data_delivery['iCabBookingId'] = $insert_id;
                    $Data_delivery['vValue'] = $value;
                    $insert_did[] = $obj->MySQLQueryPerform("trip_delivery_fields", $Data_delivery, 'insert');
                }
            }
            $Data_trip_locations['iCabBookingId'] = $insert_id;
            $Data_trip_locations['ePaymentBy'] = $ePaymentBy;
            $insert_dfid = $obj->MySQLQueryPerform("trips_delivery_locations", $Data_trip_locations, 'insert');
            $delivery_ids = implode("','", $insert_did);
            $where = " iTripDeliveryFieldId in ('" . $delivery_ids . "')";
            $data_update['iTripDeliveryLocationId'] = $insert_dfid;
            $obj->MySQLQueryPerform("trip_delivery_fields", $data_update, 'update', $where);
            if ($last_key == $key123) {
                $data_update_cab = array();
                $where = " iCabBookingId='" . $insert_id . "'";
                if (isset($deliveryDataArr[1])) {
                    $data_update_cab['iPackageTypeId'] = $deliveryDataArr[1];
                }
                if (isset($deliveryDataArr[2])) {
                    $data_update_cab['vReceiverName'] = $deliveryDataArr[2];
                }
                if (isset($deliveryDataArr[3])) {
                    $data_update_cab['vReceiverMobile'] = $deliveryDataArr[3];
                }
                if (isset($deliveryDataArr[4])) {
                    $data_update_cab['tDeliveryIns'] = $deliveryDataArr[4];
                }
                if (isset($deliveryDataArr[5])) {
                    $data_update_cab['tPackageDetails'] = $deliveryDataArr[5];
                }
                $data_update_cab['vDestLatitude'] = $Data_trip_locations['tEndLat'];
                $data_update_cab['vDestLongitude'] = $Data_trip_locations['tEndLong'];
                $data_update_cab['tDestAddress'] = $Data_trip_locations['tDaddress'];
                $obj->MySQLQueryPerform("cab_booking", $data_update_cab, 'update', $where);
            }
        }
    }
    /* ------------ Added By HJ On 28-09-2020 For Ride Later Booking Of Multi Delivery Type ------------ */
    //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 Start
    if ($userOutStandingAmt > 0) {
        $obj->sql_query("UPDATE trip_outstanding_amount set eAuthoriseIdName='iCabBookingId',iAuthoriseId = '" . $id . "' WHERE iTripOutstandId IN ($outstandingIds)");
    }
    //Added By HJ On 11-06-2019 For Manage User Out Standing Record For Payment Method 2 Or 3 End
    if ($id > 0) {
        $returnArr["Action"] = "1";
        if ($eType == "UberX") {
            $returnArr['message'] = "LBL_BOOKING_SUCESS_NOTE";
        } else {
            $returnArr['message'] = ($eType == "Deliver" || $eType == "Multi-Delivery") ? "LBL_DELIVERY_BOOKED" : "LBL_RIDE_BOOKED";
        }
        //added by SP for sms functionality on 15-7-2019 start
        $userdetail = $obj->MySQLSelect("SELECT concat(r.vName,' ',r.vLastName) as senderName,r.vEmail,r.vPhone,r.vLang,c.vPhoneCode FROM `register_user` AS r, `country` AS c WHERE r.iUserId = $iUserId AND r.vCountry = c.vCountryCode");
        $driverdetail = $obj->MySQLSelect("SELECT concat(r.vName,' ',r.vLastName) as drivername,r.vEmail,r.iDriverVehicleId,r.vLang,r.vPhone,c.vPhoneCode FROM  `register_driver` AS r, `country` AS c WHERE r.iDriverId = $iDriverId AND r.vCountry = c.vCountryCode");
        //added by SP for sms functionality on 15-7-2019 end
        $userPhoneNo = $userdetail[0]['vPhone'];
        $userPhoneCode = $userdetail[0]['vPhoneCode'];
        $UserLang = $userdetail[0]['vLang'];
        $DriverPhoneNo = $driverdetail[0]['vPhone'];
        //$DriverPhoneCode = $driverdetail[0]['vcode'];
        $DriverPhoneCode = $driverdetail[0]['vPhoneCode'];
        $DriverLang = $driverdetail[0]['vLang'];
        $Data1['vRider'] = $userdetail[0]['senderName'];
        $Data1['vDriver'] = $driverdetail[0]['drivername'];
        $Data1['vDriverMail'] = $driverdetail[0]['vEmail'];
        $Data1['vRiderMail'] = $userdetail[0]['vEmail'];
        $Data1['vSourceAddresss'] = $pickUpLocAdd;
        //added by SP to change date format in mail on 07-10-2019 start
        //$Data1['dBookingdate'] = date('Y-m-d H:i', strtotime($Booking_Date_Time));
        $dBookingDate_new_mail = date("jS F, Y", strtotime($Booking_Date_Time));
        $dBookingDate_new_mail_time = date("h:i A", strtotime($Booking_Date_Time));
        $Data1['dBookingdate'] = $dBookingDate_new_mail . " " . $userLanguageLabelsArr['LBL_AT_TXT'] . " " . $dBookingDate_new_mail_time;
        //added by SP to change date format in mail on 07-10-2019 end
        if ($action == "Add") {
            $Data1['vBookingNo'] = $rand_num;
        } else {
            $BookingNo = get_value('cab_booking', 'vBookingNo', 'iCabBookingId', $iCabBookingId, '', 'true');
            $Data1['vBookingNo'] = $BookingNo;
        }
        $db_driver_vehicles = $obj->MySQLSelect("SELECT vLicencePlate FROM driver_vehicle WHERE iDriverVehicleId=" . $iVehicleTypeId);
        if ($eType == "UberX") {
            $sendMailfromDriver = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_TAXI_DISPATCH_DRIVER_APP_SP", $Data1);
        } else {
            $sendMailfromDriver = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_TAXI_DISPATCH_DRIVER_APP", $Data1);
            $sendMailfromUser = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_TAXI_DISPATCH_RIDER_APP", $Data1);
        }
        $maildata['DRIVER_NAME'] = $Data1['vDriver'];
        //$maildata['PLATE_NUMBER'] = $db_driver_vehicles[0]['vLicencePlate'];
        $maildata['BOOKING_DATE'] = $Booking_Date;
        $maildata['BOOKING_TIME'] = $Booking_Time;
        $maildata['BOOKING_NUMBER'] = $Data1['vBookingNo'];
        $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("USER_SEND_MESSAGE_APP", $maildata, "", $UserLang);
        $UsersendMessage = $COMM_MEDIA_OBJ->SendSystemSMS($userPhoneNo, $userPhoneCode, $message_layout); //added by SP for sms functionality on 15-7-2019
        if ($eType == "UberX") {
            $maildata1['PASSENGER_NAME'] = $Data1['vRider'];
            $maildata1['BOOKING_DATE'] = $Booking_Date;
            $maildata1['BOOKING_TIME'] = $Booking_Time;
            $maildata1['BOOKING_NUMBER'] = $Data1['vBookingNo'];
            $DRIVER_SMS_TEMPLATE = ($eType == "UberX") ? "DRIVER_SEND_MESSAGE_SP" : "DRIVER_SEND_MESSAGE";
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate($DRIVER_SMS_TEMPLATE, $maildata1, "", $DriverLang);
            $DriversendMessage = $COMM_MEDIA_OBJ->SendSystemSMS($DriverPhoneNo, $DriverPhoneCode, $message_layout); //added by SP for sms functionality on 15-7-2019
        }
    } else {
        $returnArr["Action"] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == 'displayFare') {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $tableName = $userType != "Driver" ? "register_user" : "register_driver";
    $iMemberId_KEY = $userType != "Driver" ? "iUserId" : "iDriverId";
    if ($iTripId == "") {
        //Added By HJ On 22-07-2020 For Optimize register_user/register_driver Table Query Start
        if (isset($userDetailsArr[$tableName . '_' . $iMemberId])) {
            $memberData = $userDetailsArr[$tableName . '_' . $iMemberId];
        } else {
            $memberData = $obj->MySQLSelect("SELECT *,$iMemberId_KEY as iMemberId FROM " . $tableName . " WHERE $iMemberId_KEY='" . $userId . "'");
            $userDetailsArr[$tableName . '_' . $iMemberId] = $memberData;
        }
        $iTripId = $memberData[0]['iTripId'];
        //Added By HJ On 22-07-2020 For Optimize register_user/register_driver Table Query End
        //$iTripId = get_value($tableName, 'iTripId', $iMemberId_KEY, $iMemberId, '', 'true');
    }
    //Added By HJ On 22-07-2020 For Optimization trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $iTripId])) {
        $getTripData = $tripDetailsArr['trips_' . $iTripId];
    } else {
        $getTripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $iTripId . "'");
        $tripDetailsArr['trips_' . $iTripId] = $getTripData;
    }
    //Added By HJ On 22-07-2020 For Optimization trips Table Query End
    //$getTripData = $obj->MySQLSelect("SELECT vTripPaymentMode,eType FROM trips WHERE iTripId='" . $iTripId . "'");
    $vTripPaymentMode = "Cash";
    $eType = "Ride";
    if (count($getTripData) > 0) {
        $vTripPaymentMode = $getTripData[0]['vTripPaymentMode'];
        $eType = $getTripData[0]['eType'];
    }
    $result_fare = FetchTripFareDetails($iTripId, $iMemberId, $userType, "DISPLAY");
    //Added By HJ On 23-01-2020 For Optimized Code End
    if (($vTripPaymentMode == "Card" || $vTripPaymentMode == "Wallet") && $eType == "Ride") {
        $result_fare['ENABLE_TIP_MODULE'] = $ENABLE_TIP_MODULE;
    } else {
        $result_fare['ENABLE_TIP_MODULE'] = "No";
    }
    $result_fare['FormattedTripDate'] = date('dS M Y \a\t h:i a', strtotime($getTripData[0]['tStartDate']));
    $result_fare['PayPalConfiguration'] = "No";
    $result_fare['DefaultCurrencyCode'] = "USD";
    // $result_fare['PaypalFare'] = strval($getTripData[0]['TotalFare']);
    // $result_fare['PaypalCurrencyCode'] = $vCurrencyCode;
    $result_fare['APP_TYPE'] = $APP_TYPE;
    $result_fare['APP_DESTINATION_MODE'] = $APP_DESTINATION_MODE;
    $result_fare['SYSTEM_PAYMENT_FLOW'] = $SYSTEM_PAYMENT_FLOW;
    $result_fare['ShowSafetyRating'] = 'No';
    if ($MODULES_OBJ->isEnableSafetyGuidelines() && $getTripData[0]['isVideoCall'] == "No") {
        if ($eType == "Ride") {
            $result_fare['ShowSafetyRating'] = (strtoupper($ENABLE_SAFETY_FEATURE_RIDE) == "YES") ? $ENABLE_SAFETY_RATING : "No";
        } elseif ($eType == "Deliver" || $eType == "Multi-Delivery") {
            $result_fare['ShowSafetyRating'] = (strtoupper($ENABLE_SAFETY_FEATURE_DELIVERY) == "YES") ? $ENABLE_SAFETY_RATING : "No";
        } elseif ($eType == "UberX") {
            $result_fare['ShowSafetyRating'] = (strtoupper($ENABLE_SAFETY_FEATURE_UFX) == "YES") ? $ENABLE_SAFETY_RATING : "No";
        }
    }
    // $result_fare = array_merge($result_fare, $returnArr);
    $returnArr['Action'] = "0";
    if (count($returnArr) > 0) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $result_fare;
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "getDriverRideHistory") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $vFilterParam = isset($_REQUEST["vFilterParam"]) ? $_REQUEST["vFilterParam"] : ''; // Ride , Deliver Or UberX
    $date = isset($_REQUEST["date"]) ? $_REQUEST["date"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $date = $date . " " . "12:01:00";
    $date = date("Y-m-d H:i:s", strtotime($date));
    $serverTimeZone = date_default_timezone_get();
    $date = converToTz($date, $serverTimeZone, $vTimeZone, "Y-m-d");
    if ($vFilterParam == "" || $vFilterParam == NULL) {
        $vFilterParam = "";
    }
    ##  App Type Filtering ##
    $ssql = "";
    if ($vFilterParam != "") {
        if ($vFilterParam == "Deliver") {
            $ssql .= " AND tr.eType IN ('Deliver','Multi-Delivery') ";
        } else if ($vFilterParam == "eFly") { //added by SP for fly stations on 31-08-2019
            $ssql .= " AND tr.iFromStationId != '' AND tr.iToStationId != ''";
        } else {
            $ssql .= " AND tr.eType IN ('" . $vFilterParam . "') ";
        }
        if ($MODULES_OBJ->isAirFlightModuleAvailable() && $vFilterParam == 'Ride') {
            $ssql .= " AND tr.iFromStationId = '' AND tr.iToStationId = ''";
        }
    }
    ##  App Type Filtering ##
    $DriverDetail = get_value('register_driver', 'vCurrencyDriver,vLang', 'iDriverId', $iDriverId);
    $vCurrencyDriver = $DriverDetail[0]['vCurrencyDriver'];
    $vLanguage = $DriverDetail[0]['vLang'];
    $currencySymbol = get_value('currency', 'vSymbol', 'vName', $vCurrencyDriver, '', 'true');
    if ($vLanguage == "" || $vLanguage == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $tripData = $obj->MySQLSelect("SELECT ru.vImgName as vUserImage, tr.*, ru.vName,ru.vLastName FROM trips as tr,register_user as ru WHERE tr.iDriverId='$iDriverId' AND tr.eSystem = 'General' AND tr.tTripRequestDate LIKE '" . $date . "%' AND ( tr.iActive='Finished' OR (tr.iActive='Canceled' AND (tr.fCancellationFare > 0 OR tr.fWalletDebit > 0)))   AND ru.iUserId=tr.iUserId $ssql ORDER By tr.iTripId DESC");
    $totalEarnings = $avgRating = 0;
    if (count($tripData) > 0) {
        for ($i = 0; $i < count($tripData); $i++) {
            /* added for rental */
            if ($tripData[$i]['iRentalPackageId'] > 0) {
                $tripData[$i]['eRental'] = "Yes";
            } else {
                $tripData[$i]['eRental'] = "";
            }
            /* End added for rental */
            $tripData[$i]['vImage'] = $tripData[$i]['vUserImage'];
            $iActive = $tripData[$i]['iActive'];
            if ($iActive == "Finished") {
                $iFare = $tripData[$i]['fTripGenerateFare'];
            } else {
                $iFare = $tripData[$i]['fCancellationFare'] + $tripData[$i]['fWalletDebit'];
            }
            //$iFare = $tripData[$i]['fTripGenerateFare'];
            $fCommision = $tripData[$i]['fCommision'];
            $fDiscount = $tripData[$i]['fDiscount'];
            $fTipPrice = $tripData[$i]['fTipPrice'];
            $fTollPrice = $tripData[$i]['fTollPrice'];
            $fTax1 = $tripData[$i]['fTax1'];
            $fTax2 = $tripData[$i]['fTax2'];
            $iActive = $tripData[$i]['iActive'];
            $fOutStandingAmount = $tripData[$i]['fOutStandingAmount'];
            // hotel panel changes
            $fHotelCommision = $tripData[$i]['fHotelCommision'];
            //$vRating1 = $tripData[$i]['vRating1'];
            $priceRatio = $tripData[$i]['fRatio_' . $vCurrencyDriver];
            $tripData_rating = $obj->MySQLSelect("SELECT vRating1, vMessage FROM ratings_user_driver WHERE iTripId = '" . $tripData[$i]['iTripId'] . "' AND eUserType='Passenger' AND vRating1 != '' ");
            if (count($tripData_rating) > 0) {
                $tripData[$i]['vRating1'] = $tripData_rating[0]['vRating1'];
                $tripData[$i]['vMessage'] = $tripData_rating[0]['vMessage'];
                $vRating1 = $tripData_rating[0]['vRating1'];
            } else {
                $tripData[$i]['vRating1'] = "0";
                $tripData[$i]['vMessage'] = "";
                $vRating1 = 0;
            }
            // hotel panel changes
            if (($iFare == "" || $iFare == 0) && $fDiscount > 0) {
                $incValue = ($fDiscount - $fCommision - $fTax1 - $fTax2 - $fOutStandingAmount - $fHotelCommision) + $fTipPrice;
                $totalEarnings = $totalEarnings + ($incValue * $priceRatio);
            } else if ($iFare != "" && $iFare > 0 && $iActive != "Canceled") {
                $incValue = ($iFare - $fCommision - $fTax1 - $fTax2 - $fOutStandingAmount - $fHotelCommision) + $fTipPrice;
                $totalEarnings = $totalEarnings + ($incValue * $priceRatio);
            } else if ($iFare != "" && $iFare > 0 && $iActive == "Canceled") {
                $incValue = ($iFare - $fCommision - $fTax1 - $fTax2) + $fTipPrice;
                $totalEarnings = $totalEarnings + ($incValue * $priceRatio);
            }
            $avgRating = $avgRating + $vRating1;
            $returnArr = FetchTripFareDetails($tripData[$i]['iTripId'], $iDriverId, "Driver", "HISTORY");
            $tripData[$i] = array_merge($tripData[$i], $returnArr);
            $eType = $tripData[$i]['eType'];
            $iVehicleTypeId = $tripData[$i]['iVehicleTypeId'];
            $eFareType = get_value('vehicle_type', 'eFareType', 'iVehicleTypeId', $iVehicleTypeId, '', 'true');
            if ($eType == 'UberX' && $eFareType != "Regular") {
                $tripData[$i]['tDaddress'] = "";
            }
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = $tripData;
        ## Checking For Cancel Trip ##
        $sqlc = "SELECT tr.*, ru.vName,ru.vLastName,ru.vImgName as vUserImage FROM trips as tr,register_user as ru WHERE tr.iDriverId='$iDriverId' AND tr.tTripRequestDate LIKE '" . $date . "%' AND tr.iActive='Canceled' AND ru.iUserId=tr.iUserId $ssql ORDER By tr.iTripId DESC";
        $tripcancelData = $obj->MySQLSelect($sqlc);
        if (count($tripcancelData) > 0) {
            for ($j = 0; $j < count($tripcancelData); $j++) {
                $returnArr_cancel = FetchTripFareDetails($tripcancelData[$j]['iTripId'], $iDriverId, "Driver");
                $tripcancelData[$j] = array_merge($tripcancelData[$j], $returnArr_cancel);
                $tripcancelData[$j]['vImage'] = $tripcancelData[$j]['vUserImage'];
            }
            $returnArr['message1'] = $tripcancelData;
        }
        ## Checking For Cancel Trip ##
    } else {
        ## Checking For Cancel Trip ##
        $sqlc = "SELECT ru.vImgName as vUserImage,tr.*, ru.vName,ru.vLastName FROM trips as tr,register_user as ru WHERE tr.iDriverId='$iDriverId' AND tr.tTripRequestDate LIKE '" . $date . "%' AND tr.iActive='Canceled' AND ru.iUserId=tr.iUserId $ssql ORDER By tr.iTripId DESC";
        $tripcancelData = $obj->MySQLSelect($sqlc);
        if (count($tripcancelData) > 0) {
            for ($j = 0; $j < count($tripcancelData); $j++) {
                $returnArr_cancel = FetchTripFareDetails($tripcancelData[$j]['iTripId'], $iDriverId, "Driver");
                $tripcancelData[$j] = array_merge($tripcancelData[$j], $returnArr_cancel);
                $tripcancelData[$j]['vImage'] = $tripcancelData[$j]['vUserImage'];
            }
            $returnArr['message1'] = $tripcancelData;
            $returnArr['Action'] = "1";
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NO_DATA_AVAIL";
        }
        ## Checking For Cancel Trip ##
    }
    $returnArr['TotalEarning'] = strval(formatnum($totalEarnings));
    $returnArr['TripDate'] = date('l, dS M Y', strtotime($date));
    $returnArr['TripCount'] = strval(count($tripData));
    $returnArr['AvgRating'] = strval(CalculateMemberAvgRating($iDriverId, "Driver", $date));
    $returnArr['CurrencySymbol'] = $currencySymbol;
    $returnArr['AppTypeFilterArr'] = AppTypeFilterArr($iDriverId, "Driver", $vLanguage);
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "checkBookings") {
    // // Commented By HJ On 15-07-2020 Bcoz Not Required
    $page = isset($_REQUEST['page']) ? trim($_REQUEST['page']) : 1;
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $bookingType = isset($_REQUEST["bookingType"]) ? $_REQUEST["bookingType"] : '';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $dataType = isset($_REQUEST["DataType"]) ? $_REQUEST["DataType"] : '';
    $vFilterParam = isset($_REQUEST["vFilterParam"]) ? $_REQUEST["vFilterParam"] : ''; // Ride , Deliver Or UberX
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations", "APP_TYPE");
    if ($UserType == "Passenger") {
        $vLang = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
    } else {
        $vLang = get_value('register_driver', 'vLang', 'iDriverId', $iDriverId, '', 'true');
    }
    if ($vLang == "" || $vLang == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1");
    if ($vFilterParam == "" || $vFilterParam == NULL) {
        $vFilterParam = "";
    }
    ##  App Type Filtering ##
    $ssql3 = "";
    $ssql4 = "";
    if ($vFilterParam != "") {
        if ($vFilterParam == "Deliver") {
            $ssql3 .= " AND eType IN ('Deliver','Multi-Delivery') ";
            $ssql4 .= " AND cb.eType IN ('Deliver','Multi-Delivery') ";
        } else if ($vFilterParam == "eFly") { //added by SP for fly stations on 31-08-2019
            $ssql3 .= " AND iFromStationId != '' AND iToStationId != ''";
            $ssql4 .= " AND cb.iFromStationId != '' AND cb.iToStationId != ''";
        } else {
            $ssql3 .= " AND eType IN ('" . $vFilterParam . "') ";
            $ssql4 .= " AND cb.eType IN ('" . $vFilterParam . "') ";
        }
        if ($MODULES_OBJ->isAirFlightModuleAvailable() && $vFilterParam == 'Ride') {
            $ssql3 .= " AND iFromStationId = '' AND iToStationId = ''";
            $ssql4 .= " AND cb.iFromStationId = '' AND cb.iToStationId = ''";
        }
    }
    ##  App Type Filtering ##
    $per_page = 10;
    $additional_mins = $BOOKING_LATER_ACCEPT_AFTER_INTERVAL;
    $currDate = date('Y-m-d H:i:s');
    $currDate = date("Y-m-d H:i:s", strtotime($currDate . "-" . $additional_mins . " minutes"));
    $ssql1 = " AND dBooking_date > '" . $currDate . "'";
    $ssql2 = " AND cb.dBooking_date > '" . $currDate . "'";
    if ($UserType == "Driver") {
        if ($dataType == "PENDING") {
            $sql_all = "SELECT COUNT(iCabBookingId) As TotalIds FROM cab_booking WHERE iDriverId != '' AND eStatus = 'Pending' AND iDriverId='" . $iDriverId . "'" . $ssql1 . $ssql3;
        } else {
            $sql_all = "SELECT COUNT(iCabBookingId) As TotalIds FROM cab_booking WHERE iDriverId != '' AND ( eStatus = 'Accepted' || eStatus = 'Assign' ) AND iDriverId='" . $iDriverId . "'" . $ssql1 . $ssql3;
        }
    } else {
        $sql_all = "SELECT COUNT(iCabBookingId) As TotalIds FROM cab_booking WHERE  iUserId='$iUserId' AND  ( eStatus = 'Assign' OR eStatus = 'Pending' OR eStatus = 'Accepted' OR eStatus = 'Declined' OR eStatus = 'Cancel') AND eCancelBy != 'Rider' $ssql1.$ssql3";
    }
    $data_count_all = $obj->MySQLSelect($sql_all);
    $TotalPages = ceil($data_count_all[0]['TotalIds'] / $per_page);
    $start_limit = ($page - 1) * $per_page;
    $limit = " LIMIT " . $start_limit . ", " . $per_page;
    if ($UserType == "Driver") {
        if ($dataType == "PENDING") {
            $sql = "SELECT cb.*, IF(cb.iVehicleTypeId > 0, (SELECT vt.vVehicleType_" . $vLang . " FROM vehicle_type as vt WHERE vt.iVehicleTypeId = cb.iVehicleTypeId), '') as vVehicleType FROM `cab_booking` as cb  WHERE cb.iDriverId != '' AND  cb.eStatus = 'Pending' AND cb.iDriverId='" . $iDriverId . "' $ssql2 $ssql4 ORDER BY cb.iCabBookingId DESC" . $limit;
        } else {
            $sql = "SELECT cb.*, IF(cb.iVehicleTypeId > 0, (SELECT vt.vVehicleType_" . $vLang . " FROM vehicle_type as vt WHERE vt.iVehicleTypeId = cb.iVehicleTypeId), '') as vVehicleType FROM `cab_booking` as cb  WHERE cb.iDriverId != '' AND  ( cb.eStatus = 'Accepted' || cb.eStatus = 'Assign' )  AND cb.iDriverId='" . $iDriverId . "' $ssql2 $ssql4 ORDER BY cb.iCabBookingId DESC" . $limit;
        }
    } else {
        $sql = "SELECT cb.*, IF(cb.iVehicleTypeId > 0, (SELECT vt.vVehicleType_" . $vLang . " FROM vehicle_type as vt WHERE vt.iVehicleTypeId = cb.iVehicleTypeId), '') as vVehicleType FROM `cab_booking` as cb  WHERE cb.iUserId='$iUserId' AND ( cb.eStatus = 'Assign' OR cb.eStatus = 'Pending' OR eStatus = 'Accepted' OR eStatus = 'Declined'  OR eStatus = 'Cancel' ) AND eCancelBy != 'Rider' $ssql2  $ssql4 ORDER BY cb.iCabBookingId DESC" . $limit;
    }
    $Data = $obj->MySQLSelect($sql);
    $totalNum = count($Data);
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if (count($Data) > 0) {
        $iVehicleTypeIds_str_ufx = $iVehicleCategoryIds_str_ufx = "";
        for ($i = 0; $i < count($Data); $i++) {
            //Added By HJ On 22-03-2019 For Get Cancelled Reason Start
            $iCancelReasonId = $Data[$i]['iCancelReasonId'];
            $vCancelReason = $Data[$i]['vCancelReason'];
            if ($iCancelReasonId > 0) {
                $vCancelReason = get_value('cancel_reason', "vTitle_" . $vLang, 'iCancelReasonId', $iCancelReasonId, '', 'true');
            }
            $Data[$i]['vCancelReason'] = $vCancelReason;
            //Added By HJ On 22-03-2019 For Get Cancelled Reason End
            $Data[$i]['dBooking_dateOrig'] = $Data[$i]['dBooking_date'];
            // Convert Into Timezone
            $tripTimeZone = $Data[0]['vTimeZone'];
            if ($tripTimeZone != "") {
                $serverTimeZone = date_default_timezone_get();
                $Data[$i]['dBooking_dateOrig'] = converToTz($Data[$i]['dBooking_dateOrig'], $tripTimeZone, $serverTimeZone);
            }
            // Convert Into Timezone
            $Data[$i]['dBooking_date'] = date('dS M Y \a\t h:i a', strtotime($Data[$i]['dBooking_date']));
            //added by SP for fly stations on 30-08-2019 start
            if (!empty($Data[$i]['iFromStationId']) && !empty($Data[$i]['iToStationId'])) {
                $Data[$i]['eFly'] = "Yes";
            } else {
                $Data[$i]['eFly'] = "No";
            }
            if ($Data[$i]['eType'] == 'Ride' && $Data[$i]['eFly'] == 'Yes') {
                $Data[$i]['eType'] = 'Fly';
            }
            //added by SP for fly stations on 30-08-2019 end
            $eType = $Data[$i]['eType'];
            //$iVehicleTypeId = $Data[$i]['iVehicleTypeId'];
            $Data[$i]['moreServices'] = "No";
            $Data[$i]['vServiceTitle'] = $Data[$i]['vVehicleType'];
            $Data[$i]['vServiceDetailTitle'] = $Data[$i]['vVehicleType'];
            if ($eType == "Ride") {
                if ($APP_TYPE != "Ride") {
                    $Data[$i]['vServiceTitle'] = $languageLabelsArr['LBL_RIDE'];
                    $Data[$i]['vServiceDetailTitle'] = $Data[$i]['vVehicleType'];
                }
                if ($Data[$i]['iRentalPackageId'] > 0) {
                    $Data[$i]['vServiceTitle'] = $languageLabelsArr['LBL_RENTAL_CATEGORY_TXT'];
                    $Data[$i]['vServiceDetailTitle'] = $languageLabelsArr['LBL_RENTAL_CATEGORY_TXT'] . " - " . $Data[$i]['vVehicleType'];
                }
            } else if ($eType == "Delivery" || $eType == "Deliver") {
                if ($APP_TYPE != "Delivery" || $APP_TYPE != "Deliver") {
                    $Data[$i]['vServiceTitle'] = $languageLabelsArr['LBL_DELIVERY'];
                    $Data[$i]['vServiceDetailTitle'] = $Data[$i]['vVehicleType'];
                }
            }
            if ($eType == 'UberX') {
                if ($Data[$i]['tVehicleTypeData'] != "" /* && $iVehicleTypeId == 0 */) {
                    $tVehicleTypeDataArr = (array)json_decode($Data[$i]['tVehicleTypeData']);
                    $Data[$i]['moreServices'] = "Yes";
                    if (!empty($Data[$i]['tVehicleTypeFareData'])) {
                        $tVehicleTypeFareDataArr = (array)json_decode($Data[$i]['tVehicleTypeFareData']);
                        $ParentVehicleCategoryId = isset($tVehicleTypeFareDataArr['ParentVehicleCategoryId']) ? $tVehicleTypeFareDataArr['ParentVehicleCategoryId'] : 0;
                        if ($ParentVehicleCategoryId == 0) {
                            $tVehicleTypeFareDataArr_fareArr = (array)($tVehicleTypeFareDataArr['FareData']);
                            if (count($tVehicleTypeFareDataArr_fareArr) > 0) {
                                $sql_parent_id = "SELECT (SELECT vcs.vCategory_" . $vLang . " FROM " . $sql_vehicle_category_table_name . " as vcs WHERE vcs.iVehicleCategoryId = vc.iParentId) as vCategory FROM " . $sql_vehicle_category_table_name . " as vc, vehicle_type as vt WHERE vc.iVehicleCategoryId = vt.iVehicleCategoryId AND vt.iVehicleTypeId = '" . $tVehicleTypeFareDataArr_fareArr[0]->id . "'";
                                $parent_data_arr = $obj->MySQLSelect($sql_parent_id);
                                $Data[$i]['vCategory'] = $parent_data_arr[0]['vCategory'];
                            }
                        } else {
                            $Data[$i]['ParentVehicleCategoryId'] = $ParentVehicleCategoryId;
                            $iVehicleCategoryIds_str_ufx = $iVehicleCategoryIds_str_ufx == "" ? $ParentVehicleCategoryId : $iVehicleCategoryIds_str_ufx . "," . $ParentVehicleCategoryId;
                        }
                        $Data[$i]['eFareTypeServices'] = $tVehicleTypeFareDataArr['eFareTypeServices'];
                    } else {
                        if (count($tVehicleTypeDataArr) > 0) {
                            $tmpTVehicleTypeDataArr = (array)$tVehicleTypeDataArr[0];
                            $iVehicleTypeId = $tmpTVehicleTypeDataArr['iVehicleTypeId'];
                        }
                    }
                }
                $DisplayBookingDetails = array();
                $DisplayBookingDetails = ShowBookingDetails($Data[$i]['iCabBookingId']);
                $Data[$i]['tDestAddress'] = "";
                $Data[$i]['selectedtime'] = $DisplayBookingDetails['selectedtime'];
                $Data[$i]['selecteddatetime'] = $DisplayBookingDetails['selecteddatetime'];
                $Data[$i]['SelectedFareType'] = $DisplayBookingDetails['SelectedFareType'];
                $Data[$i]['SelectedQty'] = $DisplayBookingDetails['SelectedQty'];
                $Data[$i]['SelectedPrice'] = strval($DisplayBookingDetails['SelectedPrice']);
                $Data[$i]['SelectedCurrencySymbol'] = $DisplayBookingDetails['SelectedCurrencySymbol'];
                $Data[$i]['SelectedCurrencyRatio'] = $DisplayBookingDetails['SelectedCurrencyRatio'];
                $Data[$i]['SelectedVehicle'] = $DisplayBookingDetails['SelectedVehicle'];
                $Data[$i]['SelectedCategory'] = $DisplayBookingDetails['SelectedCategory'];
                $Data[$i]['vVehicleType'] = $DisplayBookingDetails['SelectedVehicle'];
                $Data[$i]['vVehicleCategory'] = $DisplayBookingDetails['SelectedCategory'];
                $Data[$i]['SelectedCategoryId'] = $DisplayBookingDetails['SelectedCategoryId'];
                $Data[$i]['SelectedCategoryTitle'] = $DisplayBookingDetails['SelectedCategoryTitle'];
                $Data[$i]['SelectedCategoryDesc'] = $DisplayBookingDetails['SelectedCategoryDesc'];
                $Data[$i]['SelectedAllowQty'] = $DisplayBookingDetails['SelectedAllowQty'];
                $Data[$i]['SelectedPriceType'] = $DisplayBookingDetails['SelectedPriceType'];
                $Data[$i]['ALLOW_SERVICE_PROVIDER_AMOUNT'] = $DisplayBookingDetails['ALLOW_SERVICE_PROVIDER_AMOUNT'];
                if ($SERVICE_PROVIDER_FLOW == "Provider" && $Data[$i]['eType'] == "UberX" && $Data[$i]['eServiceLocation'] == "Driver") {
                    $Data[$i]['vSourceAddresss'] = $Data[$i]['vWorkLocation'];
                }
            }
            /* added for rental */
            if ($Data[$i]['iRentalPackageId'] > 0) {
                $rentalData = getRentalData($Data[$i]['iRentalPackageId']);
                $Data[$i]['vPackageName'] = $rentalData[0]['vPackageName_' . $vLang];
            } else {
                $Data[$i]['vPackageName'] = "";
            }
            /* end added for rental */
        }
        if (!empty($iVehicleCategoryIds_str_ufx)) {
            $sql_parent_cat_name = "SELECT vcs.vCategory_" . $vLang . " as vCategory, vcs.iVehicleCategoryId FROM " . $sql_vehicle_category_table_name . " as vcs WHERE vcs.iVehicleCategoryId IN ($iVehicleCategoryIds_str_ufx)";
            $parent_data_arr = $obj->MySQLSelect($sql_parent_cat_name);
            $parent_cat_arr = array();
            if (count($parent_data_arr) > 0) {
                for ($i = 0; $i < count($parent_data_arr); $i++) {
                    $parent_cat_arr[$parent_data_arr[$i]['iVehicleCategoryId']] = $parent_data_arr[$i]['vCategory'];
                }
                for ($i = 0; $i < count($Data); $i++) {
                    if ($Data[$i]['eType'] == "UberX") {
                        if (!empty($parent_cat_arr[$Data[$i]['ParentVehicleCategoryId']])) {
                            $Data[$i]['vServiceTitle'] = $parent_cat_arr[$Data[$i]['ParentVehicleCategoryId']];
                        }
                        if (!empty($Data[$i]['ParentVehicleCategoryId']) && !empty($Data[$i]['eFareTypeServices']) && $Data[$i]['eFareTypeServices'] == "Fixed" && !empty($parent_cat_arr[$Data[$i]['ParentVehicleCategoryId']])) {
                            $Data[$i]['vServiceDetailTitle'] = $parent_cat_arr[$Data[$i]['ParentVehicleCategoryId']];
                        } else if (!empty($parent_cat_arr[$Data[$i]['ParentVehicleCategoryId']])) {
                            $Data[$i]['vServiceDetailTitle'] = $parent_cat_arr[$Data[$i]['ParentVehicleCategoryId']] . " - " . $Data[$i]['vVehicleType'];
                        }
                    }
                }
            }
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = $Data;
        if ($TotalPages > $page) {
            $returnArr['NextPage'] = $page + 1;
        } else {
            $returnArr['NextPage'] = "0";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    $returnArr['AppTypeFilterArr'] = AppTypeFilterArr($iUserId, $UserType, $vLang);
    setDataResponse($returnArr);
}
#############################Check Source Location and get Vehicle Deteails#################################################################
if ($type == "CheckSourceLocationState") {
    //global $tconfig; // Commented By HJ On 15-07-2020 Bcoz Not Required
    $PickUpLatitude = isset($_REQUEST["PickUpLatitude"]) ? $_REQUEST["PickUpLatitude"] : '0.0';
    $PickUpLongitude = isset($_REQUEST["PickUpLongitude"]) ? $_REQUEST["PickUpLongitude"] : '0.0';
    $selectedCarTypeID = isset($_REQUEST["SelectedCarTypeID"]) ? $_REQUEST["SelectedCarTypeID"] : '';
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations","APP_TYPE");
    $CurrentCabGeneralType = isset($_REQUEST["CurrentCabGeneralType"]) ? $_REQUEST["CurrentCabGeneralType"] : '';
    $APP_TYPE = $CurrentCabGeneralType;
    if ($APP_TYPE == "Delivery" || $APP_TYPE == "Deliver") {
        $ssql .= " AND eType = 'Deliver'";
    } else if ($APP_TYPE == "Ride-Delivery" || $APP_TYPE == "Ride-Deliver") {
        $ssql .= " AND ( eType = 'Deliver' OR eType = 'Ride')";
    } else if ($APP_TYPE == "Ride-Delivery-UberX" || $APP_TYPE == "Ride-Deliver-UberX") {
        $ssql .= " AND ( eType = 'Deliver' OR eType = 'Ride' OR eType = 'UberX')";
    } else {
        $ssql .= " AND eType = '" . $APP_TYPE . "'";
    }
    $pickuplocationarr = array($PickUpLatitude, $PickUpLongitude);
    $allowed_ans = checkAreaRestriction($pickuplocationarr, "No");
    if ($allowed_ans == "No") {
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    }
    $GetVehicleIdfromGeoLocation = FetchVehicleTypeFromGeoLocation($pickuplocationarr);
    $sql23 = "SELECT iVehicleTypeId FROM `vehicle_type` WHERE iLocationid IN ($GetVehicleIdfromGeoLocation) $ssql ORDER BY iVehicleTypeId ASC";
    $vehicleTypes = $obj->MySQLSelect($sql23);
    $Vehicle_Str = "";
    if (count($vehicleTypes) > 0) {
        for ($i = 0; $i < count($vehicleTypes); $i++) {
            $Vehicle_Str .= $vehicleTypes[$i]['iVehicleTypeId'] . ",";
        }
        $Vehicle_Str = substr($Vehicle_Str, 0, -1);
    }
    $selectedCarTypeID_Arr = explode(",", $selectedCarTypeID);
    $Vehicle_Str_Arr = explode(",", $Vehicle_Str);
    if ($selectedCarTypeID_Arr === array_intersect($selectedCarTypeID_Arr, $Vehicle_Str_Arr) && $Vehicle_Str_Arr === array_intersect($Vehicle_Str_Arr, $selectedCarTypeID_Arr)) {
        $returnArr['Action'] = "0";
    } else {
        $returnArr['Action'] = "1";
    }
    setDataResponse($returnArr);
}
#############################Check Source Location and get Vehicle Deteails#################################################################
###########################################################################
if ($type == "cancelBooking") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : '';
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : '';
    $Reason = isset($_REQUEST["Reason"]) ? $_REQUEST["Reason"] : '';
    $iCancelReasonId = isset($_REQUEST["iCancelReasonId"]) ? $_REQUEST["iCancelReasonId"] : '';
    $sqldata = "SELECT eStatus FROM `cab_booking` WHERE iCabBookingId ='" . $iCabBookingId . "'";
    $BookingData = $obj->MySQLSelect($sqldata);
    $BookingStatus = $BookingData[0]['eStatus'];
    if ($BookingStatus == "Cancel") {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_MANAUL_BOOKING_CANCELLED_MSG";
        $returnArr['DO_RELOAD'] = "Yes";
        setDataResponse($returnArr);
    }
    $where = " iCabBookingId = '$iCabBookingId'";
    $data_update_booking['eStatus'] = "Cancel";
    $data_update_booking['vCancelReason'] = $Reason;
    $data_update_booking['iCancelByUserId'] = $iUserId;
    $data_update_booking['dCancelDate'] = @date("Y-m-d H:i:s");
    $data_update_booking['eCancelBy'] = $userType == "Driver" ? $userType : "Rider";
    $data_update_booking['iCancelReasonId'] = $iCancelReasonId;
    $id = $obj->MySQLQueryPerform("cab_booking", $data_update_booking, 'update', $where);
    $sql = "select cb.iUserId, cb.iDriverId,cb.vBookingNo,cb.eType,concat(rd.vName,' ',rd.vLastName) as DriverName,concat(ru.vName,' ',ru.vLastName) as RiderName,ru.vEmail as vRiderMail,ru.vPhone as RiderPhone,ru.vPhoneCode as RiderPhoneCode,rd.vPhone as DriverPhone,rd.vCode as DriverPhoneCode,rd.vEmail as vDriverMail,rd.vLang as driverlang, rd.eDeviceType, rd.eDebugMode, rd.eAppTerminate, rd.eHmsDevice, rd.iGcmRegId, ru.vLang as riderlang ,cb.vSourceAddresss,cb.tDestAddress,cb.dBooking_date,cb.vCancelReason,cb.dCancelDate from cab_booking cb left join register_driver rd on rd.iDriverId = cb.iDriverId left join register_user ru on ru.iUserId = cb.iUserId where cb.iCabBookingId = '$iCabBookingId'"; //added by SP cb.iUserId, cb.iDriverId for getting phoneocde in country table on 15-7-2019
    $data_cab = $obj->MySQLSelect($sql);
    $RiderPhoneNo = $data_cab[0]['RiderPhone'];
    $RiderPhoneCode = $data_cab[0]['RiderPhoneCode'];
    $UserLang = $data_cab[0]['riderlang'];
    $DriverPhoneNo = $data_cab[0]['DriverPhone'];
    $DriverPhoneCode = $data_cab[0]['DriverPhoneCode'];
    $DriverLang = $data_cab[0]['driverlang'];
    $eType = $data_cab[0]['eType'];
    $Data['vBookingNo'] = $data_cab[0]['vBookingNo'];
    $Data['DriverName'] = $data_cab[0]['DriverName'];
    $Data['RiderName'] = $data_cab[0]['RiderName'];
    $Data['vDriverMail'] = $data_cab[0]['vDriverMail'];
    $Data['vRiderMail'] = $data_cab[0]['vRiderMail'];
    $Data['vSourceAddresss'] = $data_cab[0]['vSourceAddresss'];
    $Data['tDestAddress'] = $data_cab[0]['tDestAddress'];
    $Data['dBookingdate'] = date('Y-m-d H:i', strtotime($data_cab[0]['dBooking_date']));
    $Data['vCancelReason'] = $Reason;
    $Data['dCancelDate'] = $data_cab[0]['dCancelDate'];
    //Added By HJ On 12-08-2019 For Reset User Outstanding Amount As Per Discuss With BM Mam Bug - 6730 Start
    if ($iCabBookingId > 0) {
        $whereCabId = "iAuthoriseId='" . $iCabBookingId . "'";
        $outstanding_update['eAuthoriseIdName'] = "No";
        $outstanding_update['iAuthoriseId'] = "0";
        $obj->MySQLQueryPerform("trip_outstanding_amount", $outstanding_update, 'update', $whereCabId);
    }
    //Added By HJ On 12-08-2019 For Reset User Outstanding Amount As Per Discuss With BM Mam Bug - 6730 End
    if ($userType == "Driver" && $eType != "UberX") {
        $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_CANCEL_TRIP_ADMIN", $Data);
        $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_CANCEL_TRIP_DRIVER_TO_RIDER", $Data);
        $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("USER_SEND_MESSAGE_BOOKING_CANCEL", $Data, "", $UserLang);
        $COMM_MEDIA_OBJ->SendSystemSMS($RiderPhoneNo, $RiderPhoneCode, $message_layout);
    }
    if ($userType != "Driver") {
        /*$COMM_MEDIA_OBJ->SendMailToMember("MANUAL_CANCEL_TRIP_DRIVER", $Data);
        $DriverData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM  `register_driver` AS r, `country` AS c WHERE r.iDriverId = '" . $data_cab[0]['iDriverId'] . "' AND r.vCountry = c.vCountryCode");
        $UserPhoneCode = $DriverData[0]['vPhoneCode'];
        $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate('BOOKING_CANCEL_BYRIDER_MESSAGE', $Data, "", $UserLang);
        $UsersendMessage = $COMM_MEDIA_OBJ->SendSystemSMS($DriverPhoneNo, $UserPhoneCode, $message_layout);*/
        $lbl_data = $obj->MySQLSelect("SELECT vValue FROM language_label WHERE vLabel = 'LBL_BOOKING_CANCELLED_DRIVER_NOTIFY' AND vCode = '$DriverLang'");
        $LBL_BOOKING_CANCELLED_DRIVER_NOTIFY = str_replace("#BOOKING_NO#", "#" . $data_cab[0]['vBookingNo'], $lbl_data[0]['vValue']);
        $alertMsg = $LBL_BOOKING_CANCELLED_DRIVER_NOTIFY;
        $message_arr = array();
        $message_arr['vTitle'] = $alertMsg;
        $message_arr['tRandomCode'] = time();
        $channelName = "CAB_REQUEST_DRIVER_" . $data_cab[0]['iDriverId'];
        $generalDataArr[] = array('eDeviceType' => $data_cab[0]['eDeviceType'], 'deviceToken' => $data_cab[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $data_cab[0]['eAppTerminate'], 'eDebugMode' => $data_cab[0]['eDebugMode'], 'eHmsDevice' => $data_cab[0]['eHmsDevice'], 'message' => $message_arr, 'channelName' => $channelName);
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
        if ($BookingStatus == "Accepted") {
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("DRIVER_SEND_MESSAGE_BOOKING_CANCEL", $Data, "", $DriverLang);
            $COMM_MEDIA_OBJ->SendSystemSMS($DriverPhoneNo, $DriverPhoneCode, $message_layout);
        }
    }
    if ($APP_TYPE == "UberX" || $eType == "UberX") {
        $USER_EMAIL_TEMPLATE = ($userType == "Driver") ? "MANUAL_BOOKING_CANCEL_BYDRIVER_SP" : "MANUAL_BOOKING_CANCEL_BYRIDER_SP";
        $COMM_MEDIA_OBJ->SendMailToMember($USER_EMAIL_TEMPLATE, $Data);
        $UserPhoneNo = ($userType == "Driver") ? $RiderPhoneNo : $DriverPhoneNo;
        //$UserPhoneNo = ($userType == "Driver") ? $DriverPhoneNo : $RiderPhoneNo; //added by SP for sms functionality on 15-7-2019, before its wrongly taken so i have changed it
        $UserPhoneCode = ($userType == "Driver") ? $RiderPhoneCode : $DriverPhoneCode;
        $USER_SMS_TEMPLATE = ($userType == "Driver") ? "BOOKING_CANCEL_BYDRIVER_MESSAGE_SP" : "BOOKING_CANCEL_BYRIDER_MESSAGE_SP";
        $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate($USER_SMS_TEMPLATE, $Data, "", $UserLang);
        //added by SP for sms functionality on 15-7-2019 start
        if ($userType == "Driver") {
            $DriverData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM  `register_driver` AS r, `country` AS c WHERE r.iDriverId = '" . $data_cab[0]['iDriverId'] . "' AND r.vCountry = c.vCountryCode");
            //$UserPhoneCode = $DriverData[0]['vPhoneCode'];
            $DriverPhoneCode = $DriverData[0]['vPhoneCode'];
        } else {
            $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM `register_user` AS r, `country` AS c WHERE r.iUserId = '" . $data_cab[0]['iUserId'] . "' AND r.vCountry = c.vCountryCode");
            //$UserPhoneCode = $passengerData[0]['vPhoneCode'];
            $RiderPhoneCode = $passengerData[0]['vPhoneCode'];
        }
        $UserPhoneCode = ($userType == "Driver") ? $RiderPhoneCode : $DriverPhoneCode;
        $UsersendMessage = $COMM_MEDIA_OBJ->SendSystemSMS($UserPhoneNo, $UserPhoneCode, $message_layout);
        //added by SP for sms functionality on 15-7-2019 end
        /* $UsersendMessage = $COMM_MEDIA_OBJ->SendMemberSMS($UserPhoneNo, $UserPhoneCode, $message_layout, "");

          if ($UsersendMessage == 0) {

          $isdCode = $SITE_ISD_CODE;

          $UserPhoneCode = $isdCode;

          $UsersendMessage = $COMM_MEDIA_OBJ->SendMemberSMS($UserPhoneNo, $UserPhoneCode, $message_layout, "");

      } */
    }
    if ($id) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_BOOKING_CANCELED";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "DeclineTripRequest") {
    $passenger_id = isset($_REQUEST["PassengerID"]) ? $_REQUEST["PassengerID"] : '';
    $driver_id = isset($_REQUEST["DriverID"]) ? $_REQUEST["DriverID"] : '';
    $vMsgCode = isset($_REQUEST["vMsgCode"]) ? $_REQUEST["vMsgCode"] : '';
    $sql = "SELECT iDriverRequestId,eAcceptAttempted FROM `driver_request` WHERE iDriverId = '" . $driver_id . "' AND iUserId = '" . $passenger_id . "' AND iTripId = '0' AND vMsgCode='" . $vMsgCode . "' AND eAcceptAttempted = 'No'";
    $db_sql = $obj->MySQLSelect($sql);
    if (count($db_sql) > 0) {
        $request_count = UpdateDriverRequest2($driver_id, $passenger_id, "0", "Decline", $vMsgCode, "No");
    } else {
        $request_count = 0;
    }
    echo $request_count;
}
#####################################Generate Review Mode Login For IOS###########################################################
if ($type == "generateReviewModeLogin") {
    $iGcmRegId = isset($_REQUEST["vDeviceToken"]) ? $_REQUEST["vDeviceToken"] : '';
    if ($APPSTORE_MODE_IOS == "Review") {
        $sql = "SELECT iUserId from register_user WHERE eReviewModeLogin = 'Yes'";
        $ReviewModeClient = $obj->MySQLSelect($sql);
        if (count($ReviewModeClient) == 0) {
            $eReftype = "Rider";
            $currenttime = time();
            $vCountry = "US";
            $sql = "SELECT vPhoneCode,vTimeZone FROM country WHERE vCountryCode = '" . $vCountry . "'";
            $db_country_code = $obj->MySQLSelect($sql);
            $vPhoneCode = $db_country_code[0]['vPhoneCode'];
            $vTimeZone = $db_country_code[0]['vTimeZone'];
            $vPhone = "9876543210";
            $DataR['vRefCode'] = $REFERRAL_OBJ->GenerateReferralCode($eReftype);
            $DataR['iRefUserId'] = '';
            $DataR['eRefType'] = '';
            $DataR['vName'] = "";
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
            $vLangcode = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
            $DataR['vLang'] = $vLangcode;
            $DataR['vLastName'] = "";
            $DataR['vPassword'] = encrypt_bycrypt($currenttime);
            $DataR['vEmail'] = "review" . $currenttime . "@demo.com";
            $DataR['vPhone'] = $vPhone;
            $DataR['vCountry'] = $vCountry;
            $DataR['vPhoneCode'] = $vPhoneCode;
            $DataR['vZip'] = '121212';
            $DataR['vInviteCode'] = "";
            $DataR['vCurrencyPassenger'] = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
            $DataR['dRefDate'] = @date('Y-m-d H:i:s');
            $DataR['tRegistrationDate'] = @date('Y-m-d H:i:s');
            $DataR['eDeviceType'] = "Ios";
            $DataR['eSignUpType'] = "Normal";
            $DataR['eStatus'] = 'Active';
            $DataR['eEmailVerified'] = 'Yes';
            $DataR['ePhoneVerified'] = 'Yes';
            $DataR['eReviewModeLogin'] = 'Yes';
            $random = substr(md5(rand()), 0, 7);
            $DataR['tDeviceSessionId'] = session_id() . time() . $random;
            $DataR['tSessionId'] = session_id() . time();
            $DataR['iGcmRegId'] = $iGcmRegId;
            $id = $obj->MySQLQueryPerform("register_user", $DataR, 'insert');
            $returnArr['Action'] = "1";
            $returnArr['message'] = getPassengerDetailInfo($id, "", "");
            setDataResponse($returnArr);
        } else {
            $iUserId = $ReviewModeClient[0]['iUserId'];
            $returnArr['Action'] = "1";
            $returnArr['message'] = getPassengerDetailInfo($iUserId, "", "");
            setDataResponse($returnArr);
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "You are not allow to skip login";
        setDataResponse($returnArr);
    }
}
#####################################Generate Review Mode Login For IOS###########################################################
############################Send Sms Twilio END################################
if ($type == "updateDriverStatus") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $Status_driver = isset($_REQUEST["Status"]) ? $_REQUEST["Status"] : '';
    $isUpdateOnlineDate = isset($_REQUEST["isUpdateOnlineDate"]) ? $_REQUEST["isUpdateOnlineDate"] : '';
    $isOnlineSwitchPressed = isset($_REQUEST["isOnlineSwitchPressed"]) ? $_REQUEST["isOnlineSwitchPressed"] : '';
    $latitude_driver = isset($_REQUEST["latitude"]) ? $_REQUEST["latitude"] : '';
    $longitude_driver = isset($_REQUEST["longitude"]) ? $_REQUEST["longitude"] : '';
    $iGCMregID = isset($_REQUEST["vDeviceToken"]) ? $_REQUEST["vDeviceToken"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $driverDetail = $obj->MySQLSelect("SELECT rd.vCurrencyDriver, rd.iTrackServiceCompanyId, rd.vLang, rd.iGcmRegId, c.Ratio, c.vSymbol FROM register_driver as rd LEFT JOIN currency as c ON c.vName = rd.vCurrencyDriver WHERE iDriverId = '$iDriverId'");
    $iTrackServiceCompanyId = $driverDetail[0]['iTrackServiceCompanyId'];
    $ssql = "";
    $CheckRideDeliveryFeatureDisable_Arr = CheckRideDeliveryFeatureDisable();
    //$eShowRideVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowRideVehicles'];
    //$eShowDeliveryVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowDeliveryVehicles'];
    $RideDeliveryBothFeatureDisable = $CheckRideDeliveryFeatureDisable_Arr['RideDeliveryBothFeatureDisable'];
    $sql_car = "SELECT make.vMake, model.vTitle, dv.*, rd.iDriverVehicleId as iSelectedVehicleId,rd.iDestinationCount,rd.tDestinationModifiedDate,rd.tOnline FROM `driver_vehicle` dv, make, model, register_driver as rd WHERE dv.iDriverId='$iDriverId' AND rd.iDriverId='$iDriverId' AND dv.`iMakeId` = make.`iMakeId` AND dv.`iModelId` = model.`iModelId` AND dv.`eStatus`='Active'" . $ssql;
    //added by SP on 08-09-2020 chk whether ride or any other service is not selected..so in app select vehicle line in home screen will be disabled.
    $Data_Car = $obj->MySQLSelect($sql_car);
    $returnArr['isOnlyUfxServicesSelected'] = 'No';
    if (count($Data_Car) > 0) {
        if (count($Data_Car) == 1 && $Data_Car[0]['eType'] == "UberX" && $Data_Car[0]['vCarType'] != "" && $isUfxAvailable == 'Yes') {
            $returnArr['isOnlyUfxServicesSelected'] = 'Yes';
        }
    }
    if ($APP_TYPE == "UberX") {
        $returnArr['isOnlyUfxServicesSelected'] = 'Yes';
    }
    ############################ blocking code ##############################
    //if (strtoupper(PACKAGE_TYPE) == "SHARK" && $isOnlineSwitchPressed != "true" && $Status_driver != "Available") { //Commented By HJ On 11-07-2019 As Per Discuss With DT (Says : No any solution of this case). Bug - 6673
    if ($iTrackServiceCompanyId == 0) {
        if (strtoupper(PACKAGE_TYPE) == "SHARK" && $Status_driver == "Available") {
            $BlockData = getBlockData("Driver", $iDriverId);
            if (!empty($BlockData) || $BlockData != "") {
                setDataResponse($BlockData);
            }
        }
        ############################ blocking code ##############################
        /* For DriverSubscription added by SP start */
        if ($Status_driver == "Available" && $MODULES_OBJ->isDriverSubscriptionModuleAvailable()) {
            $returnSubStatus = 0;
            $returnSubStatus = checkDriverSubscribed($iDriverId);
            if ($returnSubStatus == 1) {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_PENDING_MIXSUBSCRIPTION";
                setDataResponse($returnArr);
            } else if ($returnSubStatus == 2) {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "PENDING_SUBSCRIPTION";
                setDataResponse($returnArr);
            }
        }
        /* For DriverSubscription added by SP end */
        /* Added By PJ for Chcek DOC expiry validation */
        $dDocStatusCheck = $SET_DRIVER_OFFLINE_AS_DOC_EXPIRED;
        if ($dDocStatusCheck == 'Yes') {
            $sql1 = "SELECT DISTINCT(rd.iDriverId) as driverid
            FROM document_list as doc Left Join company as cmp  ON doc.doc_userid = cmp.iCompanyId 
            Left Join register_driver as rd  ON doc.doc_userid = rd.iDriverId 
            Left Join document_master as dm  ON doc.doc_masterid = dm.doc_masterid 
            WHERE doc.ex_date < CURDATE() AND doc.ex_date != '0000-00-00' AND  dm.status !='Deleted' AND rd.iDriverId IS NOT NULL ";
            $data_ex_docs = $obj->MySQLSelect($sql1);
            $docExpDrivers = [];
            foreach ($data_ex_docs as $key => $data_ex_doc) {
                $docExpDrivers[] = $data_ex_doc['driverid'];
            }
            if (in_array($iDriverId, $docExpDrivers)) {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_DRIVER_DOC_EXPIRED";
                setDataResponse($returnArr);
            }
        }
        /* End Chcek DOC expiry validation */
        if ($Status_driver == "Available") {
            isMemberEmailPhoneVerified($iDriverId, "Driver");
        }
    }
    if ($iDriverId == '') {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        setDataResponse($returnArr);
    }
    $vCurrencyDriver = "USD";
    $ratio = 1;
    $currencySymbol = "$";
    $GCMID = "";
    if (count($driverDetail) > 0) {
        $vLang = $driverDetail[0]['vLang'];
        $vCurrencyDriver = $driverDetail[0]['vCurrencyDriver'];
        $ratio = $driverDetail[0]['Ratio'];
        $currencySymbol = $driverDetail[0]['vSymbol'];
        $GCMID = $driverDetail[0]['iGcmRegId'];
    }
    //$GCMID = get_value('register_driver', 'iGcmRegId', 'iDriverId', $iDriverId, '', 'true');
    if ($GCMID != "" && $iGCMregID != "" && $GCMID != $iGCMregID) {
        $returnArr['Action'] = "0";
        $returnArr['RESTRICT_APP'] = "Yes";
        $returnArr['isSessionExpired'] = "Yes";
        $returnArr['message'] = "LBL_SESSION_TIME_OUT";
        $returnArr['message_title'] = "LBL_SESSION_TIME_OUT_TITLE";
        setDataResponse($returnArr);
    }
    $returnArr['Enable_Hailtrip'] = $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
    $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision("Ride"); // Added By HJ On 16-10-2020 For get Auto Deduct Driver Commision Configuration As Per eSystem
    // Added by HV on 29-01-2021 to check if auto deduct commission configuration for deliverall system
    if ($enableCommisionDeduct == "No") {
        $enableCommisionDeductDeliverall = $MODULES_OBJ->autoDeductDriverCommision("DeliverAll");
        if ($enableCommisionDeductDeliverall == "Yes" && $MODULES_OBJ->isDeliverAllFeatureAvailable()) {
            $driver_vehicle = $obj->MySQLSelect("SELECT dv.iDriverVehicleId,dv.vCarType FROM driver_vehicle as dv LEFT JOIN register_driver as rd ON rd.iDriverId = dv.iDriverId WHERE dv.eStatus = 'Active' AND rd.iDriverVehicleId = dv.iDriverVehicleId AND dv.iDriverId = $iDriverId");
            $driver_vehicle_ids = explode(',', $driver_vehicle[0]['vCarType']);
            $deliverall_vehicles = $obj->MySQLSelect("SELECT iVehicleTypeId,vVehicleType,eType FROM vehicle_type WHERE eType = 'DeliverAll'");
            foreach ($deliverall_vehicles as $dVehicle) {
                if (in_array($dVehicle['iVehicleTypeId'], $driver_vehicle_ids)) {
                    $enableCommisionDeduct = "Yes";
                }
            }
        }
    }
    $row_result_ratings = 1;
    $ePaymentCollect = "Yes";
    //added by SP on 15-02-2021 as discussed with KS for issue sheet 2002
    if ($iTrackServiceCompanyId == 0) {
        if ($enableCommisionDeduct == 'Yes' && $Status_driver == "Available") {
            if ($vLang == "" || $vLang == NULL) {
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iDriverId, "Driver");
            $user_available_balance = setTwoDecimalPoint($user_available_balance);
            if ($WALLET_MIN_BALANCE > $user_available_balance) {
                $returnArr['message'] = "REQUIRED_MINIMUM_BALNCE";
                if ($APP_TYPE == "UberX") {
                    //$returnArr['Msg'] = str_replace('####', $currencySymbol . ($WALLET_MIN_BALANCE * $ratio), $languageLabelsArr['LBL_REQUIRED_MINIMUM_BALNCE_UBERX']);
                    $returnArr['Msg'] = str_replace('####', formateNumAsPerCurrency(($WALLET_MIN_BALANCE * $ratio), $vCurrencyDriver), $languageLabelsArr['LBL_REQUIRED_MINIMUM_BALNCE_UBERX']);
                } else {
                    //$returnArr['Msg'] = str_replace('####', $currencySymbol . ($WALLET_MIN_BALANCE * $ratio), $languageLabelsArr['LBL_REQUIRED_MINIMUM_BALNCE']);
                    $returnArr['Msg'] = str_replace('####', formateNumAsPerCurrency(($WALLET_MIN_BALANCE * $ratio), $vCurrencyDriver), $languageLabelsArr['LBL_REQUIRED_MINIMUM_BALNCE']);
                }
                // if ($APP_PAYMENT_MODE == "Cash") {
                if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                    if ($Status_driver == "Available") {
                        $returnArr['Action'] = "0";
                        setDataResponse($returnArr);
                    }
                }
            }
        }
        if (strtoupper($CASH_AVAILABLE) == "YES" && $Status_driver == "Available" && $MODULES_OBJ->isRideFeatureAvailable() == 1) {
            $returnArr['Enable_Hailtrip'] = "Yes";
        }
        if ($Status_driver == "Available" && $MODULES_OBJ->isRideFeatureAvailable() == 1) {
            $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "Yes";
        }
        if (strtoupper(PACKAGE_TYPE) == "STANDARD") {
            $returnArr['Enable_Hailtrip'] = "No";
        }
        if (count($Data_Car) > 0) {
            if (count($Data_Car) == 1 && $Data_Car[0]['eType'] == "UberX") {
                $returnArr['Enable_Hailtrip'] = $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                if ($APP_TYPE != "UberX") {
                    $RideDeliveryBothFeatureDisable = "Yes";
                    $returnArr['message'] = ($RideDeliveryBothFeatureDisable == "No") ? "LBL_PROVIDER_NO_SERVICE_ENABLE_TXT" : "LBL_ONLY_OTHER_SERVICE_ENABLE_TXT";
                }
            } else {
                $status = "CARS_NOT_ACTIVE";
                $i = 0;
                $selectedVehicle = 0;
                while (count($Data_Car) > $i) {
                    $eStatus = $Data_Car[$i]['eStatus'];
                    if ($eStatus == "Active") {
                        $status = "CARS_AVAIL";
                    }
                    if ($Data_Car[0]['iSelectedVehicleId'] == $Data_Car[$i]['iDriverVehicleId']) {
                        $selectedVehicle = 1;
                    }
                    if (($Data_Car[0]['iSelectedVehicleId'] == $Data_Car[$i]['iDriverVehicleId']) && $returnArr['Enable_Hailtrip'] == "Yes") {
                        if (strtoupper(PACKAGE_TYPE) != "STANDARD") {
                            $returnArr['Enable_Hailtrip'] = checkHailRideEnable($Data_Car[$i]['vCarType']);
                        }
                    }
                    if (($Data_Car[0]['iSelectedVehicleId'] == $Data_Car[$i]['iDriverVehicleId']) && $returnArr['ENABLE_DRIVER_DESTINATIONS'] == "Yes") {
                        $returnArr['ENABLE_DRIVER_DESTINATIONS'] = $ENABLE_DRIVER_DESTINATIONS;
                    }
                    //added by SP for fly vehicle do not enable hail and end of day trip  on 27-09-2019 start
                    if ($Data_Car[0]['iSelectedVehicleId'] == $Data_Car[$i]['iDriverVehicleId']) {
                        $vCarType = $Data_Car[$i]['vCarType'];
                        if ($vCarType != "") {
                            /* $sql = "SELECT iVehicleTypeId,eType  FROM `vehicle_type` WHERE `iVehicleTypeId` IN ($vCarType)";

                              $db_cartype = $obj->MySQLSelect($sql);

                              print_R($db_cartype); exit; */
                            $sql = "SELECT count(iVehicleTypeId) as Totalrec,SUM(CASE WHEN eType='Ride' AND eFly=1 THEN 1 ELSE 0 END) Totalfly,SUM(CASE WHEN eType!='DeliverAll'  THEN 1 ELSE 0 END) TotalRide  FROM `vehicle_type` WHERE `iVehicleTypeId` IN ($vCarType)";
                            $db_cartype = $obj->MySQLSelect($sql);
                            if (count($db_cartype) > 0 && $db_cartype[0]['Totalfly'] > 0 && $db_cartype[0]['TotalRide'] == $db_cartype[0]['Totalfly']) {
                                $returnArr['Enable_Hailtrip'] = "No";
                                $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                            }
                        }
                    }
                    //added by SP for fly vehicle do not enable hail and end of day trip  on 27-09-2019 end
                    $i++;
                }
                //if ($selectedVehicle == 0 && $status == "CARS_AVAIL" && $Status_driver == "Available") {
                if ($selectedVehicle == 0 && $status == "CARS_NOT_ACTIVE" && $Status_driver == "Available") {//CARS_NOT_ACTIVE added bc when vehicle is not selected but it is active then also it shows vehicle is not active..
                    $returnArr = array();
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LBL_SELECTED_VEHICLE_NOT_ACTIVE";
                    setDataResponse($returnArr);
                }
                if ($status == "CARS_AVAIL" && ($Data_Car[0]['iSelectedVehicleId'] == "0" || $Data_Car[0]['iSelectedVehicleId'] == "") && $Status_driver == "Available") {
                    if ($APP_TYPE == "Ride-Delivery-UberX") {
                        $sql = "SELECT vCarType from driver_vehicle WHERE iDriverId = '" . $iDriverId . "' AND eType = 'UberX' AND `eStatus`='Active'";
                        $db_cartype = $obj->MySQLSelect($sql);
                        $vCarType = $db_cartype[0]['vCarType'];
                        if ($vCarType == "") {
                            $returnArr['Action'] = "0";
                            $returnArr['Enable_Hailtrip'] = $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                            //$returnArr['message']="LBL_PROVIDER_NO_SERVICE_ENABLE_TXT";
                            $returnArr['message'] = ($RideDeliveryBothFeatureDisable == "No") ? "LBL_PROVIDER_NO_SERVICE_ENABLE_TXT" : "LBL_ONLY_OTHER_SERVICE_ENABLE_TXT";
                            //$returnArr['Enable_Hailtrip'] = "Yes"; //Comment This Line Added For Testing By HJ On 30-12-2018
                            setDataResponse($returnArr);
                        } else {
                            $returnArr['Enable_Hailtrip'] = $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                            //$returnArr['UberX_message']="LBL_PROVIDER_OTHER_SERVICE_ENABLE_TXT";
                            $returnArr['UberX_message'] = ($RideDeliveryBothFeatureDisable == "No") ? "LBL_PROVIDER_OTHER_SERVICE_ENABLE_TXT" : "LBL_ONLY_OTHER_SERVICE_ENABLE_TXT";
                        }
                    } else {
                        $returnArr['Action'] = "0";
                        $returnArr['message'] = "LBL_SELECT_CAR_MESSAGE_TXT";
                        setDataResponse($returnArr);
                    }
                } else if ($status == "CARS_NOT_ACTIVE") {
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LBL_INACTIVE_CARS_MESSAGE_TXT";
                    $returnArr['Enable_Hailtrip'] = "No";
                    $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                    setDataResponse($returnArr);
                }
            }
        } else {
            if ($APP_TYPE == "Ride-Delivery-UberX" || $APP_TYPE == "UberX") {
                $sql = "SELECT vCarType from driver_vehicle WHERE iDriverId = '" . $iDriverId . "' AND eType = 'UberX' AND `eStatus`='Active'";
                $db_cartype = $obj->MySQLSelect($sql);
                $vCarType = $db_cartype[0]['vCarType'];
                if ($vCarType == "" && count($db_cartype) > 0) {
                    $returnArr['Action'] = "0";
                    $returnArr['Enable_Hailtrip'] = "No";
                    $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                    if ($APP_TYPE == "UberX") {
                        $returnArr['message'] = "LBL_NO_SERVICE_AVAIL";
                    } else {
                        $returnArr['message'] = "LBL_PROVIDER_NO_SERVICE_ENABLE_TXT";
                    }
                    setDataResponse($returnArr);
                }
            }
            if ($Status_driver == "Available") { // Added By HJ On 02-12-2019 For Solved Sheet Bug = 567 As Per Discuss With KS Sir
                $sql = "SELECT count(iDriverVehicleId) as TotalVehicles from driver_vehicle WHERE iDriverId = '" . $iDriverId . "' AND ( eStatus = 'Inactive' OR eStatus = 'Deleted')";
                $db_Total_vehicle = $obj->MySQLSelect($sql);
                $TotalVehicles = $db_Total_vehicle[0]['TotalVehicles'];
                $returnArr['Action'] = "0";
                if ($TotalVehicles == 0) {
                    $returnArr['Enable_Hailtrip'] = $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
                    $returnArr['message'] = "LBL_NO_CAR_AVAIL_TXT";
                } else {
                    $returnArr['message'] = "LBL_INACTIVE_CARS_MESSAGE_TXT";
                }
                setDataResponse($returnArr);
            }
        }
        /*$sql = "SELECT vTripStatus FROM register_driver WHERE iDriverId = '" . $iDriverId . "' AND vTripStatus IN ('Active', 'Arrived','On Going Trip')";
        $DrivervTripStatus = $obj->MySQLSelect($sql);

        $where = " iDriverId='" . $iDriverId . "'";
        if ($Status_driver != '' && count($DrivervTripStatus) == 0) {
            $Data_update_driver['vAvailability'] = $Status_driver;
        }*/
        //change for ios driver online show on ongoing trip issue start//
        $sql = "SELECT vTripStatus,iTripId,eHailTrip FROM register_driver WHERE iDriverId = '" . $iDriverId . "' AND vTripStatus IN ('Not Active','Active', 'Arrived','On Going Trip')";
        $DrivervTripStatus = $obj->MySQLSelect($sql);
        if ($DrivervTripStatus[0]['vTripStatus'] == 'Not Active' && isset($DrivervTripStatus[0]['iTripId']) && !empty($DrivervTripStatus[0]['iTripId']) && $DrivervTripStatus[0]['iTripId'] > 0) {
            $iTrip_Id = $DrivervTripStatus[0]['iTripId'];
            $sql = "SELECT * FROM `trips` WHERE `iTripId` = $iTrip_Id AND  iActive IN ('Finished') ";
            $DrivervTripStatus = $obj->MySQLSelect($sql);

            $row_result_ratings = $obj->MySQLSelect("SELECT iTripId,eUserType FROM `ratings_user_driver` WHERE iTripId='" . $iTrip_Id . "' AND eFromUserType='Driver' AND vRating1 != '' ");
            if (count($row_result_ratings) > 0) {
                $row_result_ratings = 1;
            } else {
                $row_result_ratings = 0;
            }
            if (!empty($DrivervTripStatus)) {
                $ePaymentCollect = $DrivervTripStatus[0]['ePaymentCollect'];
                if (($DrivervTripStatus[0]['isVideoCall'] == "Yes" && $DrivervTripStatus[0]['eCancelled'] == "Yes") || $DrivervTripStatus[0]['eSystem'] == "DeliverAll" || $DrivervTripStatus[0]['eHailTrip'] == "Yes") {
                    $row_result_ratings = 1;
                    $ePaymentCollect = "Yes";
                }
            } else {
                $row_result_ratings = 1;
                $ePaymentCollect = "Yes";
            }
        }
    }
    //change for ios driver online show on ongoing trip issue end//
    $where = " iDriverId='" . $iDriverId . "'";
    if ($Status_driver != '' && $ePaymentCollect == "Yes" && $row_result_ratings == 1) {
        $Data_update_driver['vAvailability'] = $Status_driver;
    }
    //$time = date("H:i:");
    if ($MODULES_OBJ->checkDriverDestinationModule()) {
        $iDestinationCount = $Data_Car[0]['iDestinationCount'];
        $tDestinationModifiedDate = $Data_Car[0]['tDestinationModifiedDate'];
        $tOnline = $Data_Car[0]['tOnline'];
        $resetData = date('Y-m-d') . ' ' . $DRIVER_DESTINATIONS_RESET_TIME . ':00';
        $tOnline = converToTz($tOnline, $vTimeZone, date_default_timezone_get());
        // $today1 = date("Y-m-d H:i:s");
        // $today1 = converToTz($today1, date_default_timezone_get(), $vTimeZone);
        // $tDestinationModifiedDate = converToTz($tDestinationModifiedDate, date_default_timezone_get(), $vTimeZone);
        $DRIVER_DESTINATIONS_RESET_TIME_ARR = explode(":", $DRIVER_DESTINATIONS_RESET_TIME);
        $DRIVER_DESTINATIONS_RESET_TIME_HOUR = $DRIVER_DESTINATIONS_RESET_TIME_ARR[0];
        $DRIVER_DESTINATIONS_RESET_TIME_MINITE = $DRIVER_DESTINATIONS_RESET_TIME_ARR[1];
        if ((!empty($tDestinationModifiedDate) && $tOnline >= $resetData && $tDestinationModifiedDate < $resetData)) {
            $where_driver_registration_data = "iDriverId='" . $iDriverId . "'";
            //$Data_update_driver_registration_data1['eDestinationMode'] = 'No';
            $Data_update_driver_registration_data1['iDestinationCount'] = 0;
            //$Data_update_driver_registration_data1['tDestinationModifiedDate'] = date('Y-m-d H:i:s',strtotime('+'.$DRIVER_DESTINATIONS_RESET_TIME_HOUR.' hour +'.$DRIVER_DESTINATIONS_RESET_TIME_MINITE.' minutes',time()));
            $Data_update_driver_registration_data1['tDestinationModifiedDate'] = date('Y-m-d H:i:s');
            $data = $obj->MySQLQueryPerform('register_driver', $Data_update_driver_registration_data1, 'update', $where_driver_registration_data);
        }
        if ($iDestinationCount >= $MAX_DRIVER_DESTINATIONS) {
            $returnArr['DRIVER_DESTINATION_AVAILABLE'] = 'No';
        } else {
            $returnArr['DRIVER_DESTINATION_AVAILABLE'] = 'Yes';
        }
    }
    if ($latitude_driver != '' && $longitude_driver != '') {
        $Data_update_driver['vLatitude'] = $latitude_driver;
        $Data_update_driver['vLongitude'] = $longitude_driver;
    }
    if ($Status_driver == "Available") {
        //$Data_update_driver['tOnline'] = @date("Y-m-d H:i:s");
        // insert as online
        // Code for Check last logout date is update in driver_log_report
        $query = "SELECT * FROM driver_log_report WHERE dLogoutDateTime = '0000-00-00 00:00:00' AND iDriverId = '" . $iDriverId . "' ORDER BY iDriverLogId DESC LIMIT 0,1";
        $db_driver = $obj->MySQLSelect($query);
        if (count($db_driver) > 0) {
            $sql = "SELECT tLastOnline FROM register_driver WHERE iDriverId = '" . $iDriverId . "'";
            $db_drive_lastonline = $obj->MySQLSelect($sql);
            $driver_lastonline = $db_drive_lastonline[0]['tLastOnline'];
            $updateQuery = "UPDATE driver_log_report set dLogoutDateTime='" . $driver_lastonline . "' WHERE iDriverLogId = " . $db_driver[0]['iDriverLogId'];
            $obj->sql_query($updateQuery);
        }
        // Code for Check last logout date is update in driver_log_report Ends
        $vIP = get_client_ip();
        $curr_date = date('Y-m-d H:i:s');
        $sql = "INSERT INTO `driver_log_report` (`iDriverId`,`dLoginDateTime`,`vIP`) VALUES ('" . $iDriverId . "','" . $curr_date . "','" . $vIP . "')";
        $insert_log = $obj->sql_query($sql);
        //update insurance log
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            $details_arr['iTripId'] = "0";
            $details_arr['LatLngArr']['vLatitude'] = $latitude_driver;
            $details_arr['LatLngArr']['vLongitude'] = $longitude_driver;
            // $details_arr['LatLngArr']['vLocation'] = "";
            update_driver_insurance_status($iDriverId, "Available", $details_arr, "updateDriverStatus", "Online");
        }
        //update insurance log
    }
    if ($Status_driver == "Not Available") {
        // update as offline
        $Data_update_driver['tLastOnline'] = @date("Y-m-d H:i:s");
        $curr_date = date('Y-m-d H:i:s');
        $selct_query = "select * from driver_log_report WHERE iDriverId = '" . $iDriverId . "' order by `iDriverLogId` desc limit 0,1";
        $get_data_log = $obj->sql_query($selct_query);
        $update_sql = "UPDATE driver_log_report set dLogoutDateTime = '" . $curr_date . "' WHERE iDriverLogId ='" . $get_data_log[0]['iDriverLogId'] . "'";
        $result = $obj->sql_query($update_sql);
        //update insurance log
        if (strtoupper(PACKAGE_TYPE) == "SHARK") {
            $details_arr['iTripId'] = "0";
            $details_arr['LatLngArr']['vLatitude'] = $latitude_driver;
            $details_arr['LatLngArr']['vLongitude'] = $longitude_driver;
            // $details_arr['LatLngArr']['vLocation'] = "";
            update_driver_insurance_status($iDriverId, "Available", $details_arr, "updateDriverStatus", "Offline");
        }
        //update insurance log
    }
    if (($isUpdateOnlineDate == "true" && $Status_driver == "Available") || ($isUpdateOnlineDate == "" && $Status_driver == "") || $isUpdateOnlineDate == "true") {
        $Data_update_driver['tOnline'] = @date("Y-m-d H:i:s");
        $Data_update_driver['tLastOnline'] = @date("Y-m-d H:i:s");
    }
    if ($isOnlineSwitchPressed == "true" && $Status_driver == "Available") {
        $Data_update_driver['tSwitchOnline'] = @date("Y-m-d H:i:s");
    }
    $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
    # Update User Location Date #
    Updateuserlocationdatetime($iDriverId, "Driver", $vTimeZone);
    # Update User Location Date #
    if ($APP_TYPE == "Ride-Delivery-UberX" || $APP_TYPE == "UberX") {
        $isExistUberXServices = "Yes";
        $sql = "SELECT vCarType from driver_vehicle WHERE iDriverId = '" . $iDriverId . "' AND eType = 'UberX'";
        $db_cartype = $obj->MySQLSelect($sql);
        $vCarType = $db_cartype[0]['vCarType'];
        if ($vCarType == "") {
            $isExistUberXServices = "No";
        }
        $returnArr['isExistUberXServices'] = $isExistUberXServices;
    }
    if ($ENABLE_HAIL_RIDES == "No" || ONLYDELIVERALL == "Yes") {
        $returnArr['Enable_Hailtrip'] = "No";
    }
    if ($ENABLE_DRIVER_DESTINATIONS == "No" || ONLYDELIVERALL == "Yes" || $APP_TYPE == 'Delivery') {
        $returnArr['ENABLE_DRIVER_DESTINATIONS'] = "No";
    }
    if ($APP_TYPE != "Ride-Delivery-UberX" && $APP_TYPE != "UberX") {
        $returnArr['isExistUberXServices'] = "No";
    }
    if (strtoupper($returnArr['isExistUberXServices']) == "YES") {
        //$returnArr['isExistUberXServices'] = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
        $returnArr['isExistUberXServices'] = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
    }
    if ($id) {
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        setDataResponse($returnArr);
    }
}
###########################################################################
######################################## General types For all App Type ######################################
###################### getAssignedDriverLocation ##########################
if ($type == "getDriverLocations") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $sql = "SELECT vLatitude, vLongitude,vTripStatus FROM `register_driver` WHERE iDriverId='$iDriverId'";
    $Data = $obj->MySQLSelect($sql);
    if (count($Data) == 1) {
        $returnArr['Action'] = "1";
        $returnArr['vLatitude'] = $Data[0]['vLatitude'];
        $returnArr['vLongitude'] = $Data[0]['vLongitude'];
        $returnArr['vTripStatus'] = $Data[0]['vTripStatus'];
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = 'Not Found';
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "LoadAvailableCars") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $CheckRideDeliveryFeatureDisable_Arr = CheckRideDeliveryFeatureDisable();
    $eShowRideVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowRideVehicles'];
    $eShowDeliveryVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowDeliveryVehicles'];
    $eShowDeliverAllVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowDeliverAllVehicles'];
    $eShowVehicles = "Yes";
    if ($eShowRideVehicles == 'No' && $eShowDeliveryVehicles == 'No' && ($eShowDeliverAllVehicles == 'No' || DELIVERALL == 'No')) {
        $eShowVehicles = "No";
    }
    $ssql = " AND dv.eType != 'UberX'";
    $sql = "SELECT register_driver.iDriverVehicleId as DriverSelectedVehicleId,make.vMake, model.vTitle, dv.* FROM `driver_vehicle` dv, make, model,register_driver WHERE dv.iDriverId='$iDriverId' AND register_driver.iDriverId = '$iDriverId' AND dv.`iMakeId` = make.`iMakeId` AND dv.`iModelId` = model.`iModelId` AND dv.`eStatus`='Active'" . $ssql . " Order By dv.iDriverVehicleId desc";
    $Data_Car = $obj->MySQLSelect($sql);
    if (count($Data_Car) > 0) {
        $sql = "SELECT count(dv.iDriverVehicleId) as TotalVehicles from driver_vehicle as dv WHERE iDriverId = '" . $iDriverId . "'" . $ssql;
        $db_Total_vehicle = $obj->MySQLSelect($sql);
        $TotalVehicles = $db_Total_vehicle[0]['TotalVehicles'];
        if (count($Data_Car) == 1 && $Data_Car[0]['eType'] == "UberX" && $TotalVehicles == 1 && $APP_TYPE == "Ride-Delivery-UberX") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = ($eShowVehicles == "No") ? "LBL_ONLY_OTHER_SERVICE_ENABLE_TXT" : "LBL_PROVIDER_OTHER_SERVICE_ENABLE_TXT";
            setDataResponse($returnArr);
        } else {
            $status = "CARS_NOT_ACTIVE";
            $i = 0;
            while (count($Data_Car) > $i) {
                $eStatus = $Data_Car[$i]['eStatus'];
                if ($eStatus == "Active") {
                    $status = "CARS_AVAIL";
                }
                $i++;
            }
            if ($status == "CARS_NOT_ACTIVE") {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_INACTIVE_CARS_MESSAGE_TXT";
                setDataResponse($returnArr);
            }
            // $returnArr['carList'] = $Data_Car;
            $db_vehicle_new = $Data_Car;
            for ($i = 0; $i < count($Data_Car); $i++) {
                $eType = $Data_Car[$i]['eType'];
                if ($eType == "UberX") {
                    unset($db_vehicle_new[$i]);
                }
            }
            $db_vehicle_new = array_values($db_vehicle_new);
            if (count($db_vehicle_new) == 0) {
                $sql = "SELECT count(iDriverVehicleId) as TotalVehicles from driver_vehicle WHERE iDriverId = '" . $driverId . "' AND eStatus = 'Inactive'";
                $db_tot_vehicle = $obj->MySQLSelect($sql);
                $TotalVehicles = $db_tot_vehicle[0]['TotalVehicles'];
                $returnArr['Action'] = "0";
                if ($TotalVehicles > 0) {
                    $returnArr['message'] = "LBL_INACTIVE_CARS_MESSAGE_TXT";
                } else {
                    $returnArr['message'] = "LBL_NO_CAR_AVAIL_TXT";
                }
                setDataResponse($returnArr);
            }
            for ($i = 0; $i < count($db_vehicle_new); $i++) {
                $vCarType = $db_vehicle_new[$i]['vCarType'];
                $enable_hail_flag = "No";
                if ($vCarType != "") {
                    $sql = "SELECT iVehicleTypeId,eType  FROM `vehicle_type` WHERE `iVehicleTypeId` IN ($vCarType)";
                    $db_cartype = $obj->MySQLSelect($sql);
                    if (count($db_cartype) > 0) {
                        for ($j = 0; $j < count($db_cartype); $j++) {
                            $eVehicleType = $db_cartype[$j]['eType'];
                            if ($eVehicleType == "Ride") {
                                $enable_hail_flag = "Yes";
                            }
                        }
                    }
                    //added by SP for fly vehicle do not enable hail and end of day trip  on 27-09-2019 start
                    $sql = "SELECT count(iVehicleTypeId) as Totalrec,SUM(CASE WHEN eType='Ride' AND eFly=1 THEN 1 ELSE 0 END) Totalfly,SUM(CASE WHEN eType!='DeliverAll'  THEN 1 ELSE 0 END) TotalRide  FROM `vehicle_type` WHERE `iVehicleTypeId` IN ($vCarType)";
                    $db_cartype = $obj->MySQLSelect($sql);
                    if (count($db_cartype) > 0 && $db_cartype[0]['Totalfly'] > 0 && $db_cartype[0]['TotalRide'] == $db_cartype[0]['Totalfly']) {
                        $enable_hail_flag = "No";
                    }
                    //added by SP for fly vehicle do not enable hail and end of day trip  on 27-09-2019 end
                }
                // $db_vehicle_new[$i]['Enable_Hailtrip'] = ($enable_hail_flag == "Yes" && $APP_PAYMENT_MODE != "Card") ? "Yes" : "No";
                $db_vehicle_new[$i]['Enable_Hailtrip'] = ($enable_hail_flag == "Yes" && strtoupper($CASH_AVAILABLE) == "YES") ? "Yes" : "No";
            }
            $returnArr['Action'] = "1";
            $returnArr['message'] = $db_vehicle_new;
            setDataResponse($returnArr);
        }
    } else {
        $sql = "SELECT count(iDriverVehicleId) as TotalVehicles from driver_vehicle WHERE iDriverId = '" . $driverId . "' AND ( eStatus = 'Inactive' OR eStatus = 'Deleted')";
        $db_Total_vehicle = $obj->MySQLSelect($sql);
        $TotalVehicles = $db_Total_vehicle[0]['TotalVehicles'];
        $returnArr['Action'] = "0";
        if ($TotalVehicles == 0) {
            // $returnArr['message'] = "LBL_NO_CAR_AVAIL_TXT";
            $returnArr['message'] = "LBL_NO_CAR_AVAIL_FOR_RIDE_DELIVERY_TXT";
        } else {
            $returnArr['message'] = "LBL_INACTIVE_CARS_MESSAGE_TXT";
        }
        setDataResponse($returnArr);
    }
}
########################### Set Driver CarID ############################
if ($type == "SetDriverCarID") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $Data['iDriverVehicleId'] = isset($_REQUEST["iDriverVehicleId"]) ? $_REQUEST["iDriverVehicleId"] : '';
    /* For DriverSubscription added by SP start */
    //$sql = "SELECT iDriverVehicleId from register_driver WHERE iDriverId = '" . $iDriverId . "'";
    //$db_driver_vehicle = $obj->MySQLSelect($sql);
    //if(!empty($db_driver_vehicle[0]['iDriverVehicleId'])) {
    if ($MODULES_OBJ->isDriverSubscriptionModuleAvailable()) {
        $returnSubStatus = 0;
        $returnSubStatus = checkDriverSubscribed($iDriverId, $Data['iDriverVehicleId']);
        if ($returnSubStatus == 1) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_PENDING_MIXSUBSCRIPTION";
            setDataResponse($returnArr);
        }
        if ($returnSubStatus == 2) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "PENDING_SUBSCRIPTION";
            setDataResponse($returnArr);
        }
    }
    //}
    /* For DriverSubscription added by SP end */
    $where = " iDriverId = '" . $iDriverId . "'";
    $sql = $obj->MySQLQueryPerform("register_driver", $Data, 'update', $where);
    if ($sql > 0) {
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        setDataResponse($returnArr);
    }
}
############################################################################
if ($type == "updateDriverLocations") {
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $latitude_driver = isset($_REQUEST["latitude"]) ? $_REQUEST["latitude"] : '';
    $longitude_driver = isset($_REQUEST["longitude"]) ? $_REQUEST["longitude"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $where = " iDriverId='$iDriverId'";
    $Data_update_driver['vLatitude'] = $latitude_driver;
    $Data_update_driver['vLongitude'] = $longitude_driver;
    $id = $obj->MySQLQueryPerform("register_driver", $Data_update_driver, 'update', $where);
    # Update User Location Date #
    Updateuserlocationdatetime($iDriverId, "Driver", $vTimeZone);
    # Update User Location Date #
    if ($id) {
        $returnArr['Action'] = "1";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "updateTripLocations") {
    $tripId = isset($_REQUEST["TripId"]) ? $_REQUEST["TripId"] : '';
    $latitudes = isset($_REQUEST['latList']) ? $_REQUEST['latList'] : '';
    $longitudes = isset($_REQUEST['lonList']) ? $_REQUEST['lonList'] : '';
    $iDriverId = isset($_REQUEST['iDriverId']) ? $_REQUEST['iDriverId'] : '';
    if ($iDriverId != "" && $tripId == "") {
        $iTripId = get_value('register_driver', 'iTripId', 'iDriverId', $iDriverId, '', 'true');
        if ($iTripId != "") {
            $tripId = $iTripId;
        }
    }
    if ($tripId != '' && $latitudes != '' && $longitudes != '') {
        $latitudes = preg_replace("/[^0-9,.-]/", "", $latitudes);
        $longitudes = preg_replace("/[^0-9,.-]/", "", $longitudes);
        $id = UpdateTripPositions($tripId, $latitudes, $longitudes);
    }
    if ($id > 0) {
        $returnArr['Action'] = "1";
    } else {
        $returnArr['Action'] = "0";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "checkSurgePrice") {
    $selectedCarTypeID = isset($_REQUEST["SelectedCarTypeID"]) ? $_REQUEST["SelectedCarTypeID"] : '';
    $selectedTime = isset($_REQUEST["SelectedTime"]) ? $_REQUEST["SelectedTime"] : '';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $PickUpLatitude = isset($_REQUEST["PickUpLatitude"]) ? $_REQUEST["PickUpLatitude"] : '0.0';
    $PickUpLongitude = isset($_REQUEST["PickUpLongitude"]) ? $_REQUEST["PickUpLongitude"] : '0.0';
    $DestLatitude = isset($_REQUEST["DestLatitude"]) ? $_REQUEST["DestLatitude"] : '';
    $DestLongitude = isset($_REQUEST["DestLongitude"]) ? $_REQUEST["DestLongitude"] : '';
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    /* added for rental */
    $iRentalPackageId = isset($_REQUEST["iRentalPackageId"]) ? $_REQUEST["iRentalPackageId"] : '';
    $ePool = isset($_REQUEST["ePool"]) ? $_REQUEST["ePool"] : 'No';
    /* Added by HV on 17-02-2021 for  Multiple stopover points | Flat trip should not be applied */
    $stopoverpoint_arr = isset($_REQUEST['stopoverpoint_arr']) ? $_REQUEST['stopoverpoint_arr'] : '';
    $stopoverPointArr = array();
    $StopOverPointAdded = "No";
    if (!empty($stopoverpoint_arr) && $stopoverpoint_arr != "[]") {
        $stopoverPointArr = json_decode($stopoverpoint_arr, true);
        $StopOverPointAdded = "Yes";
    }
    /* Added by HV on 17-02-2021 for  Multiple stopover points | Flat trip should not be applied End */
    $CashPayment = isset($_REQUEST["CashPayment"]) ? $_REQUEST["CashPayment"] : 'No';
    $ePayWallet = isset($_REQUEST["ePayWallet"]) ? $_REQUEST["ePayWallet"] : 'No';
    $eWalletIgnore = isset($_REQUEST["eWalletIgnore"]) ? $_REQUEST["eWalletIgnore"] : 'No';
    $eWalletDebitAllow = isset($_REQUEST["eWalletDebitAllow"]) ? $_REQUEST["eWalletDebitAllow"] : 'No';
    // changes for flattrip 29-01-2019
    $eType_vehicle = get_value('vehicle_type', 'eType', 'iVehicleTypeId', $selectedCarTypeID, '', 'true');
    if ($eType_vehicle == "UberX" && $SERVICE_PROVIDER_FLOW == "Provider" && $selectedTime != "") {
        $sdate = explode(" ", $selectedTime);
        $shour = explode("-", $sdate[1]);
        $shour1 = $shour[0];
        $shour2 = $shour[1];
        if ($shour1 == "12" && $shour2 == "01") {
            $shour1 = 00;
        }
        $selectedTime = $sdate[0] . " " . $shour1 . ":00:00";
    }
    ######### Checking For Flattrip #########
    if ($UserType == "Passenger") {
        $tblname = "register_user";
        $iUserId = "iUserId";
        $vCurrency = "vCurrencyPassenger";
        $sqlp = "SELECT ru.vCurrencyPassenger,ru.vLang,cu.vSymbol,cu.Ratio FROM register_user as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE iUserId = '" . $iMemberId . "'";
        $passengerData = $obj->MySQLSelect($sqlp);
        $currencycode = $passengerData[0]['vCurrencyPassenger'];
        $currencySymbol = $passengerData[0]['vSymbol'];
        $priceRatio = $passengerData[0]['Ratio'];
        $vLangCode = $passengerData[0]['vLang'];
    } else {
        $tblname = "register_driver";
        $iUserId = "iDriverId";
        $vCurrency = "vCurrencyDriver";
        $sqld = "SELECT rd.vCurrencyDriver,rd.vLang,cu.vSymbol,cu.Ratio FROM register_driver as rd LEFT JOIN currency as cu ON rd.vCurrencyDriver = cu.vName WHERE iDriverId = '" . $iMemberId . "'";
        $driverData = $obj->MySQLSelect($sqld);
        $currencycode = $driverData[0]['vCurrencyDriver'];
        $currencySymbol = $driverData[0]['vSymbol'];
        $priceRatio = $driverData[0]['Ratio'];
        $vLangCode = $driverData[0]['vLang'];
    }
    if ($currencycode == "" || $currencycode == NULL) {
        $sql = "SELECT vName,vSymbol,Ratio from currency WHERE eDefault = 'Yes'";
        $currencyData = $obj->MySQLSelect($sql);
        $currencycode = $currencyData[0]['vName'];
        $currencySymbol = $currencyData[0]['vSymbol'];
        $priceRatio = $currencyData[0]['Ratio'];
    }
    ######### Checking For Flattrip #########
    $isDestinationAdded = "No";
    if ($DestLatitude != "" && $DestLongitude != "") {
        $isDestinationAdded = "Yes";
    }
    // changes for flattrip 29-01-2019
    $eFlatTrip = "No";
    $fFlatTripPrice = 0;
    if ($isDestinationAdded == "Yes" && $eType_vehicle == 'Ride') {
        $sourceLocationArr = array($PickUpLatitude, $PickUpLongitude);
        $destinationLocationArr = array($DestLatitude, $DestLongitude);
        if (strtoupper(PACKAGE_TYPE) != "STANDARD") {
            $data_flattrip = checkFlatTripnew($sourceLocationArr, $destinationLocationArr, $selectedCarTypeID, $iRentalPackageId);
            $eFlatTrip = $data_flattrip['eFlatTrip'];
            $fFlatTripPrice = $data_flattrip['Flatfare'];
        }
    }
    if ($StopOverPointAdded == "Yes") {
        $eFlatTrip = "No";
        $fFlatTripPrice = 0;
    }
    $SurgePriceValue = 1;
    if ($APP_TYPE == "UberX") {
        $data['Action'] = "1";
        $data = checkSurgePrice($selectedCarTypeID, $selectedTime);
        if ($data['Action'] == "0") {
            $SurgePriceValue = $data['SurgePriceValue'];
        }
    } else {
        /* changed for rental */
        $data = checkSurgePrice($selectedCarTypeID, $selectedTime, $iRentalPackageId);
        if ($data['Action'] == "0") {
            $SurgePriceValue = $data['SurgePriceValue'];
        }
    }
    if ($APPLY_SURGE_ON_FLAT_FARE == "No" && $eFlatTrip == "Yes") {
        $SurgePriceValue = 1;
        $data['Action'] = "1";
    }
    /* For New Payment Flow */
    $params = array("iMemberId" => $iMemberId, "eUserType" => $UserType, "eType" => $eType_vehicle, "GET_DATA" => "Yes");
    $payment_mode_data = GetPaymentModeDetails($params);
    $ePaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
    $CashPayment = $ePaymentMode == "cash" ? "Yes" : "No";
    $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
    $ePaymentBy = $payment_mode_data['ePaymentBy'];
    if ($eType_vehicle == "Ride" && $ePaymentMode == "business") {
        $iOrganizationId = $payment_mode_data['iOrganizationId'];
        // $ePaymentBy = $payment_mode_data['ePaymentBy'];
    }
    /* For New Payment Flow End */
    $fFlatTripPrice = setTwoDecimalPoint($fFlatTripPrice * $priceRatio);
    $fSurgePriceDiff = setTwoDecimalPoint(($fFlatTripPrice * $SurgePriceValue) - $fFlatTripPrice);
    $fFlatTripPrice = $fFlatTripPrice + $fSurgePriceDiff;
    $data['eFlatTrip'] = $eFlatTrip;
    $data['fFlatTripPrice'] = $fFlatTripPrice;
    $data['fFlatTripPricewithsymbol'] = formateNumAsPerCurrency($fFlatTripPrice, $currencycode);
    $data['fOutStandingAmount'] = 0.00;
    $data['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency(0, $currencycode);

    $tOutStandingIds = "";
    if($MODULES_OBJ->isDeliverAllFeatureAvailable()) {
        $orderData = $obj->MySQLSelect("SELECT tOutStandingIds FROM orders WHERE fOutStandingAmount > 0 AND iStatusCode IN (1,2,4,5,13,14) AND iUserId = '$iMemberId' ");
        if(!empty($orderData[0]['tOutStandingIds'])) {
            $tOutStandingIds = $orderData[0]['tOutStandingIds'];
        }
    }

    if ($UserType == "Passenger") {
        $fOutStandingAmount = GetPassengerOutstandingAmount($iMemberId, $tOutStandingIds);
        $fOutStandingAmount = setTwoDecimalPoint($fOutStandingAmount * $priceRatio);
        $data['fOutStandingAmount'] = $fOutStandingAmount;
        $data['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($fOutStandingAmount, $currencycode);
    }
    //Added By HJ On 10-06-2019 For Get User Out Standing Amount For Payment Method 2 Or 3 Start
    // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
    if (strtoupper($ePayWallet) == "YES") {
        $getUserOutstandingAmount = getUserOutstandingAmount($iMemberId, "iCabRequestId");
        $fOutStandingAmount = setTwoDecimalPoint($getUserOutstandingAmount['fPendingAmount'] * $priceRatio);
        $data['fOutStandingAmount'] = $fOutStandingAmount;
        $data['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($fOutStandingAmount, $currencycode);
    }
    //Added By HJ On 10-06-2019 For Get User Out Standing Amount For Payment Method 2 Or 3 End
    //added by SP on 11-06-2020 for outstanding restriction start...
    
    $data['ShowAdjustTripBtn'] = $data['ShowPayNow'] = "Yes";
    $data['ShowContactUsBtn'] = "No";
    if ($MODULES_OBJ->isEnableOutstandingRestriction() && $data['fOutStandingAmount'] > 0) {
        if ($UserType == "Passenger") {
            // if ($APP_PAYMENT_MODE == "Cash") {
            if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                $data['ShowPayNow'] = "No";
                $data['ShowAdjustTripBtn'] = "No";
                $data['ShowContactUsBtn'] = "Yes";
            }
            // if ($APP_PAYMENT_MODE == "Card") {
            if ($CONFIG_OBJ->isOnlyCardPaymentModeAvailable() || $CONFIG_OBJ->isOnlyWalletPaymentModeAvailable()) {
                $data['ShowPayNow'] = "Yes";
                $data['ShowAdjustTripBtn'] = "No";
            }
            // if ($SYSTEM_PAYMENT_FLOW == 'Method-2' || $SYSTEM_PAYMENT_FLOW == 'Method-3') {
            if (strtoupper($ePayWallet) == "YES") {
                $outStandingSql = " AND eAuthoriseIdName='No' AND iAuthoriseId ='0'";
            }
            if ($vLangCode == "" || $vLangCode == NULL) {
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
            $sql = "SELECT count(iTripOutstandId) as counttrip FROM trip_outstanding_amount WHERE iUserId='" . $iMemberId . "' AND iUserId > 0 AND ePaidByPassenger = 'No' $outStandingSql";
            $counttripData = $obj->MySQLSelect($sql);
            if ($counttripData[0]['counttrip'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                // if ($APP_PAYMENT_MODE == "Cash") {
                if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                    $data['outstanding_restriction_label'] = str_replace("##", $data['fOutStandingAmountWithSymbol'], $languageLabelsArr["LBL_OUTSTANDING_RESTRICTION_MSG"]);
                    $data['ShowAdjustTripBtn'] = "No";
                }
                // if ($APP_PAYMENT_MODE == "Card") {
                if ($CONFIG_OBJ->isOnlyCardPaymentModeAvailable() || $CONFIG_OBJ->isOnlyWalletPaymentModeAvailable()) {
                    $data['outstanding_restriction_label'] = str_replace("##", $data['fOutStandingAmountWithSymbol'], $languageLabelsArr["LBL_OUTSTANDING_RESTRICTION_MSG"]);
                    $data['ShowAdjustTripBtn'] = "No";
                    $data['ShowPayNow'] = "Yes";
                }
                //if($counttripData[0]['counttrip'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                //    $returnArr['ShowAdjustTripBtn'] = "No";
                //}
            }
            $data['OutstandingTrips'] = $counttripData[0]['counttrip'];
            if ($data['OutstandingTrips'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                $data['ShowAdjustTripBtn'] = "No";
            }
            if ($data['ShowPayNow'] == "Yes") {
                $data['ShowContactUsBtn'] = "No";
            }
            if ($ePaymentMode == "business" && strtolower($ePaymentBy) == "organization") {
                $data['ShowPayNow'] = "No";
                $data['ShowAdjustTripBtn'] = "Yes";
            }
        }
    }
    //added by SP on 11-06-2020 for outstanding restriction end...
    //Added By HJ On 31-12-2018 For Check Pool Status Start As Per Discuss With KS Sir
    // Commented by HV on 08-02-2021 as discussed with KS
    /*if ($ePool == "Yes") {
        $data['fFlatTripPrice'] = $data['fOutStandingAmount'] = 0.00;
        $data['fFlatTripPricewithsymbol'] = $data['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency(0, $currencycode);
    }*/
    //Added By HJ On 31-12-2018 For Check Pool Status End As Per Discuss With KS Sir
    setDataResponse($data);
}

###################################################################
if ($type == "getUserVehicleDetails") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $user_type = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Driver';
    $vCountry = '';
    if ($user_type == "Passenger") {
        $tblname = "register_user";
        $fieldName = "iUserId";
        //$vLangCode = get_value('register_user', 'vLang', 'iUserId', $iMemberId, '', 'true');
    } else {
        $tblname = "register_driver";
        $fieldName = "iDriverId";
        //$driveData = get_value('register_driver', 'vLang,vCountry', 'iDriverId', $iMemberId);
    }
    //Added By HJ On 22-07-2020 For Optimize register_driver/register_user Table Query Start
    if (isset($userDetailsArr[$tblname . '_' . $iMemberId])) {
        $memberData = $userDetailsArr[$tblname . '_' . $iMemberId];
    } else {
        $memberData = $obj->MySQLSelect("SELECT * FROM " . $tblname . " WHERE $fieldName = '" . $iMemberId . "'");
        $userDetailsArr[$tblname . '_' . $iMemberId] = $memberData;
    }
    $vLangCode = $memberData[0]['vLang'];
    $vCountry = $memberData[0]['vCountry'];
    if ($user_type == "Passenger") {
        $vCountry = '';
    }
    //Added By HJ On 22-07-2020 For Optimize register_driver/register_user Table Query End
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
    $lbl_all = $languageLabelsArr['LBL_ALL'];
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations", "APP_TYPE");
    $ServiceIdData = get_value('company', 'iServiceId', 'iCompanyId', $memberData[0]['iCompanyId']);
    $ServiceIdnew = $ServiceIdData[0]['iServiceId'];
    $isMultipleVehicleCategoryAvailable = false;
    $ssql = "";
    if ($ServiceIdnew > 0) {
        $ssql .= " AND eType = 'DeliverAll'";
    } else {
        if ($APP_TYPE == "Delivery") {
            $ssql .= " AND eType = 'Deliver'";
        } else if ($APP_TYPE == "Ride-Delivery" || $APP_TYPE == "Ride-Delivery-UberX") {
            $isMultipleVehicleCategoryAvailable = true;
            $ssql .= " AND eType != 'UberX'";
            ### Checking Vehicles For Ride , Delivery Icons and Banners Availability ##
            $CheckRideDeliveryFeatureDisable_Arr = CheckRideDeliveryFeatureDisable();
            $eShowRideVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowRideVehicles'];
            $eShowDeliveryVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowDeliveryVehicles'];
            $eShowDeliverAllVehicles = $CheckRideDeliveryFeatureDisable_Arr['eShowDeliverAllVehicles'];
            if ($eShowRideVehicles == "No") {
                $ssql .= " AND eType != 'Ride'";
            }
            if ($eShowDeliveryVehicles == "No") {
                $ssql .= " AND eType != 'Deliver'";
            }
            if ($eShowDeliverAllVehicles == "No") {
                $ssql .= " AND eType != 'DeliverAll'";
            }
            ### Checking Vehicles For Ride , Delivery Icons and Banners Availability ##
        } else {
            $ssql .= " AND eType = '" . $APP_TYPE . "'";
        }
    }
    $getLocationData = $obj->MySQLSelect("SELECT * FROM location_master");
    if ($vCountry != "") {
        if (isset($country_data_arr[$vCountry])) {
            $iCountryId = $country_data_arr[$vCountry]['iCountryId'];
        } else {
            $iCountryId = get_value('country', 'iCountryId', 'vCountryCode', $vCountry, '', 'true');
        }
        //Added By HJ On 22-07-2020 For Optimize language_master Table Query Start
        $db_country = array();
        for ($d = 0; $d < count($getLocationData); $d++) {
            if ($getLocationData[$d]['eStatus'] == "Active" && $getLocationData[$d]['iCountryId'] == $iCountryId && $getLocationData[$d]['eFor'] == "VehicleType") {
                $db_country[] = $getLocationData[$d];
            }
        }
        //Added By HJ On 22-07-2020 For Optimize language_master Table Query End
        $country_str = "-1";
        if (count($db_country) > 0) {
            for ($i = 0; $i < count($db_country); $i++) {
                $country_str .= "," . $db_country[$i]['iLocationId'];
            }
        }
        $ssql .= " AND iLocationid IN ($country_str) ";
    }
    //Added By HJ On 30-12-2018 For Check POOL Status Start
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $ssql = regenerateQueryForPool($ssql);
    }
    //added by SP for fly on 6-9-2019
    $fly = 'No';
    if ($MODULES_OBJ->isAirFlightModuleAvailable()) {
        $fly = 'Yes';
    }
    if ($fly != 'Yes') {
        $ssql .= " AND eFly='0'";
    }
    //Added By HJ On 30-12-2018 For Check POOL Status End
    $sql = "SELECT iVehicleTypeId,vVehicleType_" . $vLangCode . " as vVehicleType,iLocationid,iCountryId,iStateId,iCityId,eType,eFly,eDeliveryHelper,tDeliveryHelperNoteDriver,eIconType FROM `vehicle_type` WHERE 1" . $ssql . " AND eStatus = 'Active'";
    $db_vehicletype = $obj->MySQLSelect($sql);
    if ($APP_TYPE == 'UberX') {
        $sql = "SELECT vCarType FROM `driver_vehicle` where iDriverId ='" . $iMemberId . "'";
        $db_vCarType = $obj->MySQLSelect($sql);
        if (count($db_vehicletype) > 0 && count($db_vCarType) > 0) {
            $vehicle_service_id = explode(",", $db_vCarType[0]['vCarType']);
            for ($i = 0; $i < count($db_vehicletype); $i++) {
                if (in_array($db_vehicletype[$i]['iVehicleTypeId'], $vehicle_service_id)) {
                    $db_vehicletype[$i]['VehicleServiceStatus'] = 'true';
                } else {
                    $db_vehicletype[$i]['VehicleServiceStatus'] = 'false';
                }
            }
        }
    } else {
        if (count($db_vehicletype) > 0) {
            $j = 0;
            //Added By HJ On 22-07-2020 For Optimize vehicle_type Table Query Start
            $db_vehicletype_fly = $obj->MySQLSelect("SELECT DISTINCT(vehicle_type.iVehicleTypeId),vehicle_type.iVehicleTypeId,vehicle_type.vVehicleType_" . $vLangCode . " as vVehicleType,vehicle_type.iLocationid,vehicle_type.iCountryId,vehicle_type.iStateId,vehicle_type.iCityId,vehicle_type.eType,vehicle_type.eFly,vehicle_type.eDeliveryHelper,vehicle_type.tDeliveryHelperNoteDriver,vehicle_type.eIconType FROM vehicle_type RIGHT JOIN fly_location_wise_fare ON vehicle_type.iVehicleTypeId = fly_location_wise_fare.iVehicleTypeId WHERE 1 $ssql AND vehicle_type.eStatus = 'Active' AND fly_location_wise_fare.eStatus = 'Active'");
            $vehicleTypeDataArr = $locationDataArr = array();
            for ($b = 0; $b < count($db_vehicletype_fly); $b++) {
                $vehicleTypeDataArr[$db_vehicletype_fly[$b]['iVehicleTypeId']][] = $db_vehicletype_fly[$b];
            }
            //Added By HJ On 22-07-2020 For Optimize vehicle_type Table Query End
            //Added By HJ On 22-07-2020 For Optimize language_master Table Query Start
            for ($l = 0; $l < count($getLocationData); $l++) {
                $locationDataArr[$getLocationData[$l]['iLocationId']] = $getLocationData[$l]['vLocationName'];
            }
            //Added By HJ On 22-07-2020 For Optimize location_master Table Query End
            for ($i = 0; $i < count($db_vehicletype); $i++) {
                //added by SP for fly stations on 6-9-2019, its bc fly vehicles are shown only if price in location wise fare is entered
                if ($fly == 'Yes' && $db_vehicletype[$i]['eFly'] == '1') {
                    $db_vehicletype_fly = array();
                    if (isset($vehicleTypeDataArr[$db_vehicletype[$i]['iVehicleTypeId']])) {
                        $db_vehicletype_fly = $vehicleTypeDataArr[$db_vehicletype[$i]['iVehicleTypeId']];
                    }
                    if (empty($db_vehicletype_fly)) {
                        continue;
                    }
                }
                $db_vehicletype1[$j]['iVehicleTypeId'] = $db_vehicletype[$i]['iVehicleTypeId'];
                $db_vehicletype1[$j]['vVehicleType'] = $db_vehicletype[$i]['vVehicleType'];
                $db_vehicletype1[$j]['iLocationid'] = $db_vehicletype[$i]['iLocationid'];
                $db_vehicletype1[$j]['iCountryId'] = $db_vehicletype[$i]['iCountryId'];
                $db_vehicletype1[$j]['iStateId'] = $db_vehicletype[$i]['iStateId'];
                $db_vehicletype1[$j]['iCityId'] = $db_vehicletype[$i]['iCityId'];
                $db_vehicletype1[$j]['eType'] = $db_vehicletype[$i]['eType'];
                $db_vehicletype1[$j]['eFly'] = $db_vehicletype[$i]['eFly'];
                if ($db_vehicletype[$j]['iLocationid'] == "-1") {
                    $db_vehicletype1[$j]['SubTitle'] = $lbl_all;
                } else {
                    $vLocationName = "";
                    if (isset($locationDataArr[$db_vehicletype[$i]['iLocationid']])) {
                        $vLocationName = $locationDataArr[$db_vehicletype[$i]['iLocationid']];
                    }
                    $db_vehicletype1[$j]['SubTitle'] = $vLocationName;
                }
                if (strtoupper(PACKAGE_TYPE) != "STANDARD") {
                    $db_vehicletype1[$j]['eRental'] = isRentalEnable($db_vehicletype[$i]['iVehicleTypeId']);
                } else {
                    $db_vehicletype1[$j]['eRental'] = 'No';
                }
                //added by SP for fly on 6-9-2019
                if ($db_vehicletype[$i]['eType'] == 'Ride' && $db_vehicletype[$i]['eFly'] == '1' && $fly == 'Yes') {
                    $db_vehicletype1[$j]['eType'] = 'Fly';
                }
                if ($db_vehicletype[$i]['eIconType'] == "Ambulance" && $MODULES_OBJ->isEnableMedicalServices()) {
                    $db_vehicletype1[$j]['eType'] = 'Ambulance';
                }
                $db_vehicletype1[$j]['eDeliveryHelper'] = "No";
                $db_vehicletype1[$j]['tDeliveryHelperNoteDriver'] = "";
                if ($MODULES_OBJ->isEnableDeliveryHelper()) {
                    $db_vehicletype1[$j]['eDeliveryHelper'] = $db_vehicletype[$i]['eDeliveryHelper'];
                    if (!empty($db_vehicletype[$i]['tDeliveryHelperNoteDriver'])) {
                        $tDeliveryHelperNoteDriver = json_decode($db_vehicletype[$i]['tDeliveryHelperNoteDriver'], true);
                        $db_vehicletype1[$j]['tDeliveryHelperNoteDriver'] = $tDeliveryHelperNoteDriver['tDeliveryHelperNoteDriver_' . $vLangCode];
                    }
                }
                $j++;
            }
        }
    }
    $make = $obj->MySQLSelect("SELECT * FROM make WHERE eStatus = 'Active' ORDER BY vMake ASC");
    $start = @date('Y');
    $end = '1970';
    $year = array();
    for ($j = $start; $j >= $end; $j--) {
        $year[] = strval($j);
    }
    $carlist = $makemodalArr = array();
    if (count($make) > 0) {
        $j = 0;
        $db_model = $obj->MySQLSelect("SELECT  * FROM  `model` WHERE  `eStatus` = 'Active' ORDER BY vTitle ASC");
        for ($h = 0; $h < count($db_model); $h++) {
            $makemodalArr[$db_model[$h]['iMakeId']][] = $db_model[$h];
        }
        for ($i = 0; $i < count($make); $i++) {
            $db_model_data = array();
            if (isset($makemodalArr[$make[$i]['iMakeId']])) {
                $db_model_data = $makemodalArr[$make[$i]['iMakeId']];
            }
            if (count($db_model_data) > 0) {
                $ModelArr['List'] = $db_model_data;
                $carlist[$j]['iMakeId'] = $make[$i]['iMakeId'];
                $carlist[$j]['vMake'] = $make[$i]['vMake'];
                $carlist[$j]['vModellist'] = $ModelArr['List'];
                $j++;
            }
        }
        $data['year'] = $year;
        $data['carlist'] = $carlist;
        $data['IS_SHOW_VEHICLE_TYPE'] = $isMultipleVehicleCategoryAvailable == true ? "Yes" : "No";
        foreach ($db_vehicletype1 as $key => $value) {
            if ($value['eType'] == "Ride") {
                $eTypeNew = 1;
            }
            if ($value['eType'] == "Deliver") {
                $eTypeNew = 2;
            }
            if ($value['eType'] == 'Fly') {
                $eTypeNew = 3;
            }
            $db_vehicletype1[$key]['eTypeNew'] = $eTypeNew;
        }
        $sort_eType = array_column($db_vehicletype1, 'eTypeNew');
        array_multisort($sort_eType, SORT_ASC, $db_vehicletype1);
        $data['vehicletypelist'] = $db_vehicletype1;
        if (count($db_vehicletype) == 0) {
            $returnArr['message1'] = "LBL_EDIT_VEHI_RESTRICTION_TXT";
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = $data;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################Add/Edit Driver Vehicle#######################################################
if ($type == "UpdateDriverVehicle") {
    $iDriverVehicleId = isset($_REQUEST['iDriverVehicleId']) ? $_REQUEST['iDriverVehicleId'] : '';
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $iMakeId = isset($_REQUEST["iMakeId"]) ? $_REQUEST["iMakeId"] : '';
    $iModelId = isset($_REQUEST["iModelId"]) ? $_REQUEST["iModelId"] : '';
    $iYear = isset($_REQUEST["iYear"]) ? $_REQUEST["iYear"] : '';
    $vLicencePlate = isset($_REQUEST["vLicencePlate"]) ? $_REQUEST["vLicencePlate"] : '';
    $eCarX = isset($_REQUEST["eCarX"]) ? $_REQUEST["eCarX"] : '';
    $eCarGo = isset($_REQUEST["eCarGo"]) ? $_REQUEST["eCarGo"] : '';
    $vColour = isset($_REQUEST["vColor"]) ? $_REQUEST["vColor"] : '';
    $vCarType = isset($_REQUEST["vCarType"]) ? $_REQUEST["vCarType"] : '';
    /* added for rental */
    $vRentalCarType = isset($_REQUEST["vRentalCarType"]) ? $_REQUEST["vRentalCarType"] : '';
    $handiCap = isset($_REQUEST["HandiCap"]) ? $_REQUEST["HandiCap"] : 'No';
    $iVehicleCategoryId = isset($_REQUEST["iVehicleCategoryId"]) ? $_REQUEST["iVehicleCategoryId"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : 'Ride'; //'Ride', 'Delivery', 'UberX'
    $eAddedDeliverVehicle = isset($_REQUEST["eAddedDeliverVehicle"]) ? $_REQUEST["eAddedDeliverVehicle"] : 'No';
    $eVideoConsultEnableProvider = isset($_REQUEST["eVideoConsultEnableProvider"]) ? $_REQUEST["eVideoConsultEnableProvider"] : 'No';
    $eVideoServiceDescription = isset($_REQUEST["eVideoServiceDescription"]) ? $_REQUEST["eVideoServiceDescription"] : '';
    $fAmount = isset($_REQUEST["fAmount"]) ? $_REQUEST["fAmount"] : '0';
    //Added By HJ On 22-07-2020 For Optimize register_driver Table Query Start
    $tblname = "register_driver";
    if (isset($userDetailsArr[$tblname . '_' . $iDriverId])) {
        $driverData = $userDetailsArr[$tblname . '_' . $iDriverId];
    } else {
        $driverData = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM " . $tblname . " WHERE iDriverId = '" . $iDriverId . "'");
        $userDetailsArr[$tblname . '_' . $iDriverId] = $driverData;
    }
    $vCurrencyData = get_value('currency', 'vSymbol, Ratio', 'vName', $driverData[0]['vCurrencyDriver']);
    $vCurrencyRatio = $vCurrencyData[0]['Ratio'];
    $Amount = $fAmount / $vCurrencyRatio;
    $Amount = round($Amount, 2);
    //$iDriverStatus = $obj->MySQLSelect("SELECT eStatus FROM register_driver WHERE iDriverId = '" . $iDriverId . "'");
    $eStatus = $driverData[0]['eStatus'];
    if ($eType == "UberX") {
        ## Check message if driver is online ##
        //$db_available = $obj->MySQLSelect("select vAvailability from `register_driver` where iDriverId = '" . $iDriverId . "'");
        if (isset($driverData[0]['vAvailability']) && $driverData[0]['vAvailability'] == "Available") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_CHANGE_SERVICE_AFTER_OFFLINE_TXT";
            setDataResponse($returnArr);
        }
        ## Check message if driver is online ##
        $query = "SELECT iDriverVehicleId FROM `driver_vehicle` WHERE iDriverId = '" . $iDriverId . "' AND eType = 'UberX'";
        $result = $obj->MySQLSelect($query);
        if (count($result) > 0) {
            $iDriverVehicleId = $result[0]['iDriverVehicleId'];
        } else {
            $iDriverVehicleId = 0;
        }
    } else {
        ## Check message if driver is online ##
        //$db_available = $obj->MySQLSelect("select vAvailability from `register_driver` where iDriverId = '" . $iDriverId . "'");
        $vAvailability = $driverData[0]['vAvailability'];
        if ($vAvailability == "Available") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_RESTRICT_VEHICLE_UPDATE";
            setDataResponse($returnArr);
        }
        ## Check message if driver is online ##
    }
    $action = ($iDriverVehicleId != 0) ? 'Edit' : 'Add';
    if ($action == "Add") {
        $eStatus = "inactive";
    }
    if (strtoupper($eStatus) != 'INACTIVE') {
        if ($action == "Edit" && $ENABLE_EDIT_DRIVER_VEHICLE == "No" && $eType != "UberX") {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_EDIT_VEHICLE_DISABLED";
            setDataResponse($returnArr);
        } else if ($eType == "UberX" && $action == "Edit" && $ENABLE_EDIT_DRIVER_SERVICE == "No") { // Added By HJ On 10-08-2019 For Check Permission As Per Discuss With KS
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_EDIT_SERVICE_DISABLED";
            setDataResponse($returnArr);
        }
    }
    //$db_usr = $obj->MySQLSelect("select iCompanyId from `register_driver` where iDriverId = '" . $iDriverId . "'");
    $iCompanyId = $driverData[0]['iCompanyId'];
    $Data_Driver_Vehicle['iDriverId'] = $iDriverId;
    $Data_Driver_Vehicle['iCompanyId'] = $iCompanyId;
    if (SITE_TYPE == "Demo") {
        $Data_Driver_Vehicle['eStatus'] = "Active";
    } else {
        if ($action == "Add") {
            //$Data_Driver_Vehicle['eStatus'] = $eStatus;
            if (strtoupper($eStatus) == 'ACTIVE') {
                $Data_Driver_Vehicle['eStatus'] = 'Active';
            } else if (strtoupper($eStatus) == 'INACTIVE') {
                $Data_Driver_Vehicle['eStatus'] = 'Inactive';
            } else {
                $Data_Driver_Vehicle['eStatus'] = $eStatus;
            }
        } else {
            //$Data_Driver_Vehicle['eStatus'] = "Active"; // Commented By HJ On 22-05-2019 As Per Discuss With BM Mam and KS Sir
        }
    }
    ## Update Vehicle Type For UberX ##
    if (($APP_TYPE == "UberX" || $eType == "UberX") && $action == "Edit") {
        $sql = "select vCarType from `driver_vehicle` where iDriverVehicleId = '" . $iDriverVehicleId . "'";
        $vCarTypeData = $obj->MySQLSelect($sql);
        $vCarTypeData = explode(",", $vCarTypeData[0]['vCarType']);
        $sql = "select iVehicleTypeId from `vehicle_type` where iVehicleCategoryId = '" . $iVehicleCategoryId . "'";
        $db_vehicategoryid = $obj->MySQLSelect($sql);
        $array_vehiclie_id = array();
        for ($i = 0; $i < count($db_vehicategoryid); $i++) {
            array_push($array_vehiclie_id, $db_vehicategoryid[$i]['iVehicleTypeId']);
        }
        $arraydiff = array_diff($vCarTypeData, $array_vehiclie_id);
        $sssql2 = "";
        if (count($arraydiff) > 0) {
            $sssql2 = implode(",", $arraydiff);
        }
        if ($vCarType != "") {
            $vCarType = $vCarType . "," . $sssql2;
            if ($sssql2 == "") {
                $vCarType = substr($vCarType, 0, -1);
            }
        } else {
            $vCarType = $sssql2;
        }
    }
    /* --------------------------------------- */
    /* Insert a service Request as a Pending Request  */
    $mailSendToAdmin = 0;
    if (($APP_TYPE == 'UberX' || $APP_TYPE == 'Ride-Delivery-UberX') && $eType == "UberX" && $ENABLE_DRIVER_SERVICE_REQUEST_MODULE == 'Yes') {
        if ($eStatus != 'inactive') {
            $newCarTypeData = explode(',', $_REQUEST['vCarType']);
            $remainingCats = array_filter(array_diff($newCarTypeData, $vCarTypeData));
            foreach ($remainingCats as $key => $catVal) {
                if (!empty($catVal)) {
                    $tbl_dsr = 'driver_service_request';
                    $sql = "SELECT iDriverId from driver_service_request where iDriverId = '" . $iDriverId . "' AND iVehicleCategoryId = '" . $catVal . "'";
                    $existRequest = $obj->MySQLSelect($sql);
                    if (count($existRequest) == 0) {
                        $q = "INSERT INTO ";
                        $wheredrs = '';
                        $query = $q . " `" . $tbl_dsr . "` SET      
                        `iVehicleCategoryId` = '" . $catVal . "',
                        `iDriverId` = '" . $iDriverId . "',
                        `cRequestStatus` = 'Pending'" . $wheredrs;
                        $obj->sql_query($query);
                    }
                }
            }
            if (!empty($remainingCats)) {
                //$existRequestdb = $obj->MySQLSelect('SELECT vEmail, vName ,vLastName ,vCode ,vPhone FROM  register_driver WHERE iDriverId = ' . $iDriverId . '');
                /* Send Email to Driver */
                $getMaildata['name'] = $driverData[0]['vName'] . " " . $driverData[0]['vLastName'];
                $getMaildata['email'] = $driverData[0]['vEmail'];
                $getMaildata['phone'] = "+" . $driverData[0]['vCode'] . " " . $driverData[0]['vPhone'];
                $getMaildata['Service'] = $languageLabelsArr['LBL_SERVICE_ON_DEMAND'];
                $mail = $COMM_MEDIA_OBJ->SendMailToMember('SERVICE_REQUEST_FROM_PROVIDER', $getMaildata);
                $mailSendToAdmin = 1;
            }
        }
    }
    /* End Request as a Pending Request  */
    /* ------------------------------ */
    ## Update Vehicle Type For UberX ##
    $Data_Driver_Vehicle['eCarX'] = $eCarX;
    $Data_Driver_Vehicle['eCarGo'] = $eCarGo;
    $Data_Driver_Vehicle['vCarType'] = $vCarType;
    /* added for rental */
    $Data_Driver_Vehicle['vRentalCarType'] = $vRentalCarType;
    $Data_Driver_Vehicle['eHandiCapAccessibility'] = $handiCap;
    if (strtoupper(PACKAGE_TYPE) == "SHARK") {
        $Data_Driver_Vehicle = ChildSeatAvailable($Data_Driver_Vehicle);
    }
    $Data_Driver_Vehicle['eType'] = $eType;
    $Data_Driver_Vehicle['eAddedDeliverVehicle'] = $eAddedDeliverVehicle;
    if ($iMakeId != "") {
        $Data_Driver_Vehicle['iMakeId'] = $iMakeId;
    }
    if ($iModelId != "") {
        $Data_Driver_Vehicle['iModelId'] = $iModelId;
    }
    if ($iYear != "") {
        $Data_Driver_Vehicle['iYear'] = $iYear;
    }
    $Data_Driver_Vehicle['vColour'] = $vColour;
    if ($vLicencePlate != "") {
        $Data_Driver_Vehicle['vLicencePlate'] = $vLicencePlate;
    }
    if ($APP_TYPE == 'UberX' || $eType == 'UberX') {
        $Data_Driver_Vehicle['iCompanyId'] = "1";
        $Data_Driver_Vehicle['iMakeId'] = "3";
        $Data_Driver_Vehicle['iModelId'] = "1";
        $Data_Driver_Vehicle['iYear'] = Date('Y');
        $Data_Driver_Vehicle['vLicencePlate'] = "My Services";
        $Data_Driver_Vehicle['eStatus'] = "Active";
        $Data_Driver_Vehicle['eCarX'] = "Yes";
        $Data_Driver_Vehicle['eCarGo'] = "Yes";
    }
    if ($action == "Add") {
        $id = $obj->MySQLQueryPerform("driver_vehicle", $Data_Driver_Vehicle, 'insert');
    } else {
        $where = " iDriverVehicleId = '" . $iDriverVehicleId . "'";
        $id = $obj->MySQLQueryPerform("driver_vehicle", $Data_Driver_Vehicle, 'update', $where);
    }
    /* ------------------------------ */
    if ($MODULES_OBJ->isEnableVideoConsultingService()) {
        $Data = array('iDriverId' => $iDriverId, 'iVehicleCategoryId' => $iVehicleCategoryId, 'eVideoConsultEnableProvider' => $eVideoConsultEnableProvider, 'eVideoServiceDescription' => $eVideoServiceDescription, 'eVideoConsultServiceCharge' => $Amount);
        $VIDEO_CONSULT_OBJ->updateVideoConsultService($Data);
        if ($mailSendToAdmin == 0) {
            $getMaildata['name'] = $driverData[0]['vName'] . " " . $driverData[0]['vLastName'];
            $getMaildata['email'] = $driverData[0]['vEmail'];
            $getMaildata['phone'] = "+" . $driverData[0]['vCode'] . " " . $driverData[0]['vPhone'];
            $getMaildata['Service'] = $languageLabelsArr['LBL_SERVICE_VIDEO_CONSULTING'];
            $mail = $COMM_MEDIA_OBJ->SendMailToMember('SERVICE_REQUEST_FROM_PROVIDER', $getMaildata);
        }
    }
    /* This is for Reverse operation for new added services as it should be approve first */
    if (($APP_TYPE == 'UberX' || $APP_TYPE == 'Ride-Delivery-UberX') && $eType == "UberX" && $ENABLE_DRIVER_SERVICE_REQUEST_MODULE == 'Yes') {
        if ($eStatus != 'inactive') {
            $existRequest = $obj->MySQLSelect("SELECT vCarType from driver_vehicle where iDriverVehicleId = '" . $iDriverVehicleId . "'");
            $existServices = explode(',', $existRequest[0]['vCarType']);
            $fnlServices = implode(',', array_diff($existServices, $remainingCats));
            $existingServices = $obj->sql_query('UPDATE driver_vehicle SET vCarType = "' . $fnlServices . '" WHERE iDriverVehicleId = "' . $iDriverVehicleId . '"');
        }
    }
    /* Request Service for Activation */
    /* ------------------------------ */
    if ($id > 0) {
        $LBL_SERVICE_ADD_SUCCESS_NOTE = "LBL_SERVICE_ADD_SUCCESS_NOTE";
        $LBL_SERVICE_UPDATE_SUCCESS = "LBL_SERVICE_UPDATE_SUCCESS";

        /* For Service Wise Document*/
        if ($MODULES_OBJ->isEnableServiceTypeWiseProviderDocument() == "Yes") {
            $vehicleTypeArray = array('vCarType' => rtrim($vCarType, ','));
            $isServiceWiseDocumentAvailable = isServiceWiseDocumentAvailable($vehicleTypeArray);

            if ($isServiceWiseDocumentAvailable == "Yes") {
                $LBL_SERVICE_ADD_SUCCESS_NOTE = "LBL_SERVICE_ADD_SUCCESS_NOTE_TWO";
                $LBL_SERVICE_UPDATE_SUCCESS = "LBL_SERVICE_UPDATE_SUCCESS_TWO";
            }
            $returnArr['isdocavailable'] = $isServiceWiseDocumentAvailable;
        }
        /* For Service Wise Document*/
        $returnArr['Action'] = "1";
        if ($eType == "UberX") {
            $returnArr['message'] = ($action == 'Add') ? $LBL_SERVICE_ADD_SUCCESS_NOTE : $LBL_SERVICE_UPDATE_SUCCESS;
        } else {
            $returnArr['message'] = ($action == 'Add') ? 'LBL_VEHICLE_ADD_SUCCESS_NOTE' : 'LBL_VEHICLE_UPDATE_SUCCESS';
        }
        $returnArr['VehicleInsertId'] = $id;
        $returnArr['VehicleStatus'] = $Data_Driver_Vehicle['eStatus'];
        ### Send Email Code ###
        //$db_driver_detail = $obj->MySQLSelect("SELECT vEmail,vName,vLastName FROM register_driver WHERE iDriverId = '" . $iDriverId . "'");
        //$sql1 = "SELECT mo.vTitle,m.vMake from make as m LEFT JOIN model as mo on mo.iMakeId = m.iMakeId where m.iMakeId = '" . $iMakeId . "'";
        $sql1 = "SELECT mo.vTitle,m.vMake from make as m LEFT JOIN model as mo on mo.iMakeId = m.iMakeId where  mo.iModelId = '" . $iModelId . "'";
        $db_make_data = $obj->MySQLSelect($sql1);
        if ($action == "Add" && $eType != "UberX") {
            $maildata['EMAIL'] = $driverData[0]['vEmail'];
            $maildata['NAME'] = $driverData[0]['vName'] . " " . $driverData[0]['vLastName'];
            $maildata['MAKE'] = $db_make_data[0]['vMake'];
            $maildata['MODEL'] = $db_make_data[0]['vTitle'];
            $maildata['DETAIL'] = "You can active this Vehicle by clicking below link<br>
            <p><a href='" . $tconfig["tsite_url_main_admin"] . "vehicle_add_form.php?id=$id'>Active this Vehicle</a></p>";
            $COMM_MEDIA_OBJ->SendMailToMember("VEHICLE_BOOKING_ADMIN", $maildata);
        }
        if ($action == "Add" && $eType == "UberX") {
        }
        ### Send Email Code ###
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################Add/Edit Driver Vehicle End#######################################################

###########################################################################
if ($type == "getOngoingUserTrips") {
    //global $obj; // Commented By HJ On 15-07-2020 Bcoz Not Required
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $vLangCode = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
    if ($vLangCode == "" || $vLangCode == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    $Data1 = array();
    if ($iUserId != "") {
        if ($APP_TYPE == "UberX" || strtoupper(PACKAGE_TYPE) == "STANDARD") {
            $sql1 = "SELECT rd.iDriverId,rd.vImage as driverImage,concat(rd.vName,' ',rd.vLastName) as driverName, rd.vCode ,rd.vPhone as driverMobile ,rd.vLatitude as driverLatitude,rd.vLongitude as driverLongitude,if(tr.eType = 'Multi-Delivery',tr.iActive,rd.vTripStatus) as driverStatus, rd.vAvgRating as driverRating, tr.`vRideNo`, tr.tSaddress,tr.iTripId, tr.iVehicleTypeId, tr.tTripRequestDate, tr.eFareType, tr.vTimeZone, tr.eType, tr.eServiceLocation, tr.vWorkLocation, tr.vWorkLocationLatitude, tr.vWorkLocationLongitude, tr.eSelectWorkLocation, tr.tVehicleTypeData, tr.tVehicleTypeFareData, IF(tr.iVehicleTypeId > 0, (SELECT vt.vVehicleType_" . $vLangCode . " FROM vehicle_type as vt WHERE vt.iVehicleTypeId = tr.iVehicleTypeId), '') as vVehicleType, IF(tr.tVehicleTypeFareData != '', (SELECT vc.vCategory_" . $vLangCode . " FROM " . $sql_vehicle_category_table_name . " as vc WHERE vc.iVehicleCategoryId = JSON_UNQUOTE(JSON_VALUE(tr.tVehicleTypeFareData, '$.ParentVehicleCategoryId'))), '') as ParentCategoryName from trips as tr  LEFT JOIN register_driver as rd ON rd.iDriverId=tr.iDriverId WHERE tr.iActive != 'Canceled' AND if(tr.vVerificationMethod='None' or tr.vVerificationMethod='',tr.iActive != 'Finished','1=1') AND tr.iUserId='" . $iUserId . "' AND tr.eSystem = 'General' AND (tr.eType = 'UberX' or tr.eType = 'Multi-Delivery') GROUP BY tr.iTripId ORDER BY tr.iTripId DESC";
        } else {
            $sql1 = "SELECT rd.iDriverId,rd.vImage as driverImage,concat(rd.vName,' ',rd.vLastName) as driverName, rd.vCode ,rd.vPhone as driverMobile ,rd.vLatitude as driverLatitude,rd.vLongitude as driverLongitude,if(tr.eType = 'Multi-Delivery',tr.iActive,rd.vTripStatus) as driverStatus, rd.vAvgRating as driverRating, tr.`vRideNo`, tr.tSaddress,tr.iTripId, tr.iVehicleTypeId, tr.tTripRequestDate, tr.eFareType, tr.vTimeZone, tr.eType, tr.eServiceLocation, tr.vWorkLocation, tr.vWorkLocationLatitude, tr.vWorkLocationLongitude, tr.eSelectWorkLocation, tr.tVehicleTypeData, tr.tVehicleTypeFareData, IF(tr.iVehicleTypeId > 0, (SELECT vt.vVehicleType_" . $vLangCode . " FROM vehicle_type as vt WHERE vt.iVehicleTypeId = tr.iVehicleTypeId), '') as vVehicleType, IF(tr.tVehicleTypeFareData != '', (SELECT vc.vCategory_" . $vLangCode . " FROM " . $sql_vehicle_category_table_name . " as vc WHERE vc.iVehicleCategoryId = JSON_UNQUOTE(JSON_VALUE(tr.tVehicleTypeFareData, '$.ParentVehicleCategoryId'))), '') as ParentCategoryName from trips as tr  LEFT JOIN register_driver as rd ON rd.iDriverId=tr.iDriverId LEFT JOIN trips_delivery_locations as tdl ON tdl.iTripId=tr.iTripId WHERE tr.iActive != 'Canceled' AND if(tr.vVerificationMethod='None' or tr.vVerificationMethod='',tr.iActive != 'Finished','1=1') AND tr.iUserId='" . $iUserId . "' AND tr.eSystem = 'General' AND (tr.eType = 'UberX' or tr.eType = 'Multi-Delivery') AND if(tr.eType = 'Multi-Delivery',tdl.eSignVerification = 'No','1=1') GROUP BY tr.iTripId ORDER BY tr.iTripId DESC";
        }
        $Data1 = $obj->MySQLSelect($sql1);
        if (count($Data1) > 0) {
            $iVehicleCategoryIds_str_ufx = "";
            for ($i = 0; $i < count($Data1); $i++) {
                $Data1[$i]['moreServices'] = "No";
                if ($SERVICE_PROVIDER_FLOW == "Provider" && $Data1[$i]['eType'] == "UberX" && $Data1[$i]['eServiceLocation'] == "Driver") {
                    $Data1[$i]['tSaddress'] = $Data1[$i]['vWorkLocation'];
                }
                $Data1[$i]['SelectedTypeName'] = $Data1[$i]['vVehicleType'];
                $Data1[$i]['vServiceTitle'] = $Data1[$i]['vVehicleType'];
                $Data1[$i]['vServiceDetailTitle'] = $Data1[$i]['vVehicleType'];
                if ($Data1[$i]['eType'] == "UberX" && !empty($Data1[$i]['tVehicleTypeFareData'])) {
                    $Data1[$i]['moreServices'] = "Yes";
                    $tVehicleTypeFareDataArr = (array)json_decode($Data1[$i]['tVehicleTypeFareData']);
                    $ParentVehicleCategoryId = isset($tVehicleTypeFareDataArr['ParentVehicleCategoryId']) ? $tVehicleTypeFareDataArr['ParentVehicleCategoryId'] : 0;
                    if ($ParentVehicleCategoryId == 0) {
                        $tVehicleTypeFareDataArr_fareArr = (array)($tVehicleTypeFareDataArr['FareData']);
                        if (count($tVehicleTypeFareDataArr_fareArr) > 0) {
                            $sql_parent_id = "SELECT (SELECT vcs.vCategory_" . $vLang . " FROM " . $sql_vehicle_category_table_name . " as vcs WHERE vcs.iVehicleCategoryId = vc.iParentId) as vCategory FROM " . $sql_vehicle_category_table_name . " as vc, vehicle_type as vt WHERE vc.iVehicleCategoryId = vt.iVehicleCategoryId AND vt.iVehicleTypeId = '" . $tVehicleTypeFareDataArr_fareArr[0]->id . "'";
                            $parent_data_arr = $obj->MySQLSelect($sql_parent_id);
                            $Data1[$i]['vCategory'] = $parent_data_arr[0]['vCategory'];
                        }
                    } else {
                        $Data1[$i]['ParentVehicleCategoryId'] = $ParentVehicleCategoryId;
                        $iVehicleCategoryIds_str_ufx = $iVehicleCategoryIds_str_ufx == "" ? $ParentVehicleCategoryId : $iVehicleCategoryIds_str_ufx . "," . $ParentVehicleCategoryId;
                    }
                    $Data1[$i]['eFareTypeServices'] = $tVehicleTypeFareDataArr['eFareTypeServices'];
                    if (!empty($Data1[$i]['ParentVehicleCategoryId']) && $tVehicleTypeFareDataArr['eFareTypeServices'] == "Fixed") {
                        $Data1[$i]['vServiceDetailTitle'] = $Data1[$i]['ParentCategoryName'];
                    } else {
                        $Data1[$i]['vServiceDetailTitle'] = $parent_cat_arr[$Data1[$i]['ParentCategoryName']] . " - " . $Data1[$i]['vVehicleType'];
                    }
                }
                // Convert Into Timezone
                $tripTimeZone = $Data1[$i]['vTimeZone'];
                if ($tripTimeZone != "") {
                    $serverTimeZone = date_default_timezone_get();
                    $Data1[$i]['tTripRequestDate'] = converToTz($Data1[$i]['tTripRequestDate'], $tripTimeZone, $serverTimeZone);
                }
                // Convert Into Timezone
                $Data1[$i]['dDateOrig'] = $Data1[$i]['tTripRequestDate'];
                /* ---------------------Multi delivery start--------------------------- */
                if ($Data1[$i]['eType'] == "Multi-Delivery") {
                    $sql = "SELECT tdl.iTripDeliveryLocationId,tdl.eSignVerification,tr.iActive, tr.eServiceLocation from trips as tr LEFT JOIN trips_delivery_locations as tdl ON tdl.iTripId=tr.iTripId

                        WHERE tr.iTripId='" . $Data1[$i]['iTripId'] . "' AND tr.eSystem = 'General' GROUP BY tr.iTripId ORDER BY tr.iTripId DESC";
                    $Data2 = $obj->MySQLSelect($sql);
                    for ($j = 0; $j < count($Data2); $j++) {
                        if ($Data2[$j]['eSignVerification'] == "No") {
                            $Data1[$i]['iTripDeliveryLocationId'] = $Data2[$j]['iTripDeliveryLocationId'];
                            $Data1[$i]['eSignVerification'] = $Data2[$j]['eSignVerification'];
                        }
                    }
                }
                /* ---------------------Multi delivery end ---------------------------- */
            }
            $returnArr['Action'] = "1";
            $returnArr['SERVER_TIME'] = date('Y-m-d H:i:s');
            $returnArr['message'] = $Data1;
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NO_DATA_AVAIL";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}
###########################################################################
if ($type == "getTripDeliveryLocations") {
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $userType = isset($_REQUEST["userType"]) ? $_REQUEST["userType"] : 'Passenger';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    //date_default_timezone_set($vTimeZone); // Added By HJ On 29-02-2020 For Solved 141 Mantis Issue #3784
    $Data = array();
    if ($iTripId != "") {
        if ($userType != 'Passenger') {
            $sql = "SELECT ru.iUserId,ru.vimgname as riderImage,concat(ru.vName,' ',ru.vLastName) as riderName, ru.vPhoneCode ,ru.vPhone as riderMobile,ru.vTripStatus as driverStatus, ru.vAvgRating as riderRating,tr.* from trips as tr LEFT JOIN register_user as ru ON ru.iUserId=tr.iUserId WHERE tr.iTripId = '" . $iTripId . "'";
            $dataUser = $obj->MySQLSelect($sql);
            $Data['driverDetails'] = $dataUser[0];
            $iMemberId = get_value('trips', 'iDriverId', 'iTripId', $iTripId, '', 'true');
            $vLangCode = get_value('register_driver', 'vLang', 'iDriverId', $iMemberId, '', 'true');
        } else {
            $sql = "SELECT rd.iDriverId,rd.vImage as driverImage,concat(rd.vName,' ',rd.vLastName) as driverName, rd.vCode ,rd.vPhone as driverMobile,rd.vTripStatus as driverStatus, rd.vAvgRating as driverRating, vLatitude as driverLatitude, vLongitude as driverLongitude,tr.* from trips as tr LEFT JOIN register_driver as rd ON rd.iDriverId=tr.iDriverId WHERE tr.iTripId = '" . $iTripId . "'";
            $dataUser = $obj->MySQLSelect($sql);
            $Data['driverDetails'] = $dataUser[0];
            $iMemberId = get_value('trips', 'iUserId', 'iTripId', $iTripId, '', 'true');
            $vLangCode = get_value('register_user', 'vLang', 'iUserId', $iMemberId, '', 'true');
        }
        if ($vLangCode == "" || $vLangCode == NULL) {
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
        $lbl_at = $languageLabelsArr['LBL_AT_GENERAL'];
        $lbl_minago = $languageLabelsArr['LBL_MIN_AGO'];
        if ($userType == "Driver") {
            $Driver_Acceprt_Delivery_Request = $languageLabelsArr['LBL_DRIVER1_ACCEPTED_DELIVERY_REQUEST_TXT'];
            if ($dataUser[0]['eType'] == "UberX") {
                $Driver_Arrived_Pick_Location = $languageLabelsArr[$dataUser[0]['eServiceLocation'] == "Driver" ? 'LBL_USER_ARRIVED_SERVICE_LOCATION' : 'LBL_DRIVER1_ARRIVED_PICK_LOCATION_TXT_UBERX'];
            } else {
                $Driver_Arrived_Pick_Location = $languageLabelsArr[$dataUser[0]['eServiceLocation'] == "Driver" ? 'LBL_USER_ARRIVED_SERVICE_LOCATION' : 'LBL_DRIVER1_ARRIVED_PICK_LOCATION_TXT'];
            }
            $Driver_Start_job = $languageLabelsArr['LBL_PROVIDER1_START_JOB_TXT'];
            $Driver_Finished_job = $languageLabelsArr['LBL_PROVIDER1_FINISHED_JOB_TXT'];
        } else {
            $Driver_Acceprt_Delivery_Request = $languageLabelsArr[$dataUser[0]['eServiceLocation'] == "Driver" ? 'LBL_DRIVER_ACCEPTED_SPECIFIED_LOC_REQUEST' : 'LBL_DRIVER_ACCEPTED_DELIVERY_REQUEST_TXT'];
            if ($dataUser[0]['eType'] == "UberX") {
                $Driver_Arrived_Pick_Location = $languageLabelsArr[$dataUser[0]['eServiceLocation'] == "Driver" ? 'LBL_USER_ARRIVED_SERVICE_LOCATION_TXT' : 'LBL_DRIVER_ARRIVED_PICK_LOCATION_TXT_UBERX'];
            } else {
                $Driver_Arrived_Pick_Location = $languageLabelsArr[$dataUser[0]['eServiceLocation'] == "Driver" ? 'LBL_USER_ARRIVED_SERVICE_LOCATION_TXT' : 'LBL_DRIVER_ARRIVED_PICK_LOCATION_TXT'];
            }
            if ($dataUser[0]['eType'] == "Multi-Delivery") {
                $Driver_Acceprt_Delivery_Request = $languageLabelsArr['LBL_DELIVERY_DRIVER_ACCEPT_REQUEST_MULTI'];
                $Driver_Arrived_Pick_Location = $languageLabelsArr['LBL_DELIVERY_DRIVER_ARRIVED_MULTI'];
            }
            $Driver_Start_job = $languageLabelsArr['LBL_PROVIDER_START_JOB_TXT'];
            $Driver_Finished_job = $languageLabelsArr['LBL_PROVIDER_FINISHED_JOB_TXT'];
        }
        $testBool = 1;
        if (count($dataUser) > 0) {
            if ($SERVICE_PROVIDER_FLOW == "Provider" && $dataUser[0]['eType'] == "UberX" && $dataUser[0]['eServiceLocation'] == "Driver") {
                $dataUser[0]['tSaddress'] = $dataUser[0]['vWorkLocation'];
                $Data['driverDetails']['tSaddress'] = $dataUser[0]['vWorkLocation'];
            }
            if ($dataUser[0]['isVideoCall'] == "Yes") {
                $Data['driverDetails']['tSaddress'] = "";
            }
            // Added by HV on 05-03-2021 as per GP
            $Data['driverDetails']['moreServices'] = "No";
            if ($dataUser[0]['eType'] == "UberX" && !empty($dataUser[0]['tVehicleTypeFareData'])) {
                $Data['driverDetails']['moreServices'] = "Yes";
            }
            $Data['States'] = array();
            $Data_tTripRequestDate = $dataUser[0]['tTripRequestDate'];
            $Data_tTripRequestDate_convert = $dataUser[0]['tTripRequestDate'];
            $Data_tDriverArrivedDate = $dataUser[0]['tDriverArrivedDate'];
            $Data_tDriverArrivedDate_convert = $dataUser[0]['tDriverArrivedDate'];
            $Data_dDeliveredDate = $Data_dDeliveredDate_convert = "";
            if(isset($dataUser[0]['dDeliveredDate'])) {
                $Data_dDeliveredDate = $dataUser[0]['dDeliveredDate'];
                $Data_dDeliveredDate_convert = $dataUser[0]['dDeliveredDate'];
            }
            $Data_tStartDate = $dataUser[0]['tStartDate'];
            $Data_tStartDate_convert = $dataUser[0]['tStartDate'];
            $Data_tEndDate = $dataUser[0]['tEndDate'];
            $Data_tEndDate_convert = $dataUser[0]['tEndDate'];
            $eAskCodeToUser = $dataUser[0]['eAskCodeToUser'];
            $vRandomCode = $dataUser[0]['vRandomCode'];
            if (!empty($vTimeZone)) {
                if ($Data_tTripRequestDate != "" && $Data_tTripRequestDate != "0000-00-00 00:00:00") {
                    $Data_tTripRequestDate_convert = converToTz($Data_tTripRequestDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if ($Data_tDriverArrivedDate != "" && $Data_tDriverArrivedDate != "0000-00-00 00:00:00") {
                    $Data_tDriverArrivedDate_convert = converToTz($Data_tDriverArrivedDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if ($Data_dDeliveredDate != "" && $Data_dDeliveredDate != "0000-00-00 00:00:00") {
                    $Data_dDeliveredDate_convert = converToTz($Data_dDeliveredDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if ($Data_tStartDate != "" && $Data_tStartDate != "0000-00-00 00:00:00") {
                    $Data_tStartDate_convert = converToTz($Data_tStartDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if ($Data_tEndDate != "" && $Data_tEndDate != "0000-00-00 00:00:00") {
                    $Data_tEndDate_convert = converToTz($Data_tEndDate_convert, $vTimeZone, date_default_timezone_get());
                }
            }
            $i = 0;
            if ($Data_tTripRequestDate != "" && $Data_tTripRequestDate != "0000-00-00 00:00:00" && $testBool == 1) {
                $msg = 'Provider accepted the request.';
                if ($userType != 'Passenger') {
                    $msg = 'You accepted the request.';
                }
                $Data['States'][$i]['text'] = $Driver_Acceprt_Delivery_Request;
                //$Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tTripRequestDate));
                $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tTripRequestDate_convert));
                $Data['States'][$i]['dateOrig'] = $Data_tTripRequestDate_convert;
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_tTripRequestDate) - strtotime(date("Y-m-d H:i:s"))) / 60, 0) . " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Accept";
                $i++;
            } else {
                $testBool = 0;
            }
            if ($Data_tDriverArrivedDate != "" && $Data_tDriverArrivedDate != "0000-00-00 00:00:00" && $testBool == 1 && $dataUser[0]['isVideoCall'] == 'No') {
                $msg = "Provider arrived to your location.";
                if ($userType != 'Passenger') {
                    $msg = "You arrived to user's location.";
                }
                $Data['States'][$i]['text'] = $Driver_Arrived_Pick_Location;
                if ($userType == "Passenger" && $eAskCodeToUser == "Yes") {
                    $Data['States'][$i]['text'] = $Driver_Arrived_Pick_Location . " " . $languageLabelsArr['LBL_YOUR_TRIP_OTP_TXT'] . " " . $vRandomCode . ".";
                }
                //$Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tDriverArrivedDate));
                $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tDriverArrivedDate_convert));
                $Data['States'][$i]['dateOrig'] = $Data_tDriverArrivedDate_convert;
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_tDriverArrivedDate) - strtotime(date("Y-m-d H:i:s"))) / 60, 0) . " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Arrived";
                $i++;
            } else {
                $testBool = 0;
            }
            if ($Data_tStartDate != "" && $Data_tStartDate != "0000-00-00 00:00:00" && $testBool == 1 && $dataUser[0]['isVideoCall'] == 'No') {
                $msg = 'Provider has started the job.';
                if ($userType != 'Passenger') {
                    $msg = 'You started the job.';
                }
                $Data['States'][$i]['text'] = $Driver_Start_job;
                //$Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tStartDate));
                $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tStartDate_convert));
                $Data['States'][$i]['dateOrig'] = $Data_tStartDate_convert;
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_tStartDate) - strtotime(date("Y-m-d H:i:s"))) / 60, 0) . " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Onway";
                $i++;
            } else {
                $testBool = 0;
            }
            if ($Data_tEndDate != "" && $Data_tEndDate != "0000-00-00 00:00:00" && $testBool == 1 && $dataUser[0]['iActive'] == "Finished") {
                $msg = 'Provider has completed the job.';
                if ($userType != 'Passenger') {
                    $msg = 'You completed the job.';
                }
                $Data['States'][$i]['text'] = $Driver_Finished_job;
                //$Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tEndDate));
                $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_tEndDate_convert));
                $Data['States'][$i]['dateOrig'] = $Data_tEndDate_convert;
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_tEndDate) - strtotime(date("Y-m-d H:i:s"))) / 60, 0) . " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Delivered";
                $i++;
            }
        } else {
            $Data['States'] = array();
        }
        if (count($Data) > 0) {
            $returnArr['Action'] = "1";
            $returnArr['message'] = $Data;
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NO_DRIVER_FOUND";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_TRIP_FOUND";
    }
    setDataResponse($returnArr);
}
############################################################################
if ($type == "SetTimeForTrips") {
    // @todo : SetTimeForTrips
    //sleep(4);
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $iTripTimeId = isset($_REQUEST["iTripTimeId"]) ? $_REQUEST["iTripTimeId"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $iTripId = isset($_REQUEST["iTripId"]) ? $_REQUEST["iTripId"] : '';
    $tripData = $obj->MySQLSelect("SELECT iUserId,eType,eBookingFrom FROM `trips` WHERE iTripId='$iTripId'");
    $eBookingFrom = $tripData[0]['eBookingFrom'];
    if (($iUserId == "" || $eType == "") && $iTripId > 0) {
        if (count($tripData) > 0) {
            $eType = $tripData[0]['eType'];
            $iUserId = $tripData[0]['iUserId'];
        }
    }
    $dTime = date('Y-m-d H:i:s');
    if ($iTripTimeId == '') {
        $trip_times = $obj->MySQLSelect("SELECT * FROM `trip_times` WHERE iTripId='$iTripId' ORDER BY iTripTimeId DESC LIMIT 0,1");
        if ($trip_times[0]['dPauseTime'] == '0000-00-00 00:00:00') {
            $iTripTime_Id = $trip_times[0]["iTripTimeId"];
            $where = " iTripTimeId = '$iTripTime_Id'";
            $Data_update['dResumeTime'] = $dTime;
            $Data_update['iTripId'] = $iTripId;
            $obj->MySQLQueryPerform("trip_times", $Data_update, 'update', $where);
            $id = $iTripTime_Id;
        } else {
            $Data_update['dResumeTime'] = $dTime;
            $Data_update['iTripId'] = $iTripId;
            $id = $obj->MySQLQueryPerform("trip_times", $Data_update, 'insert');
        }
        // $Data_update['dResumeTime'] = $dTime;
        // $Data_update['iTripId'] = $iTripId;
        // $id = $obj->MySQLQueryPerform("trip_times", $Data_update, 'insert');
        $returnArr['Action'] = "1";
        $returnArr['message'] = $id;
        $alertMsgCode = 1;
        $alertMsg = "Your current trip is put on hold by driver.";
    } else {
        $where = " iTripTimeId = '$iTripTimeId'";
        $Data_update['dPauseTime'] = $dTime;
        $Data_update['iTripId'] = $iTripId;
        $id = $obj->MySQLQueryPerform("trip_times", $Data_update, 'update', $where);
        $returnArr['Action'] = "1";
        $returnArr['message'] = $iTripTimeId;
        $alertMsgCode = 2;
        $alertMsg = "Your trip is resumed.";
    }
    $sql22 = "SELECT * FROM `trip_times` WHERE iTripId='$iTripId'";
    $db_tripTimes = $obj->MySQLSelect($sql22);
    if ($eType == "Ride") {
        $deviceTokens_arr_ios = $registation_ids_new = array();
        $alertSendAllowed = true;
        $getUserData = $obj->MySQLSelect("SELECT iAppVersion,eDeviceType,iGcmRegId,vLang,tSessionId,eAppTerminate,eDebugMode,eHmsDevice FROM register_user WHERE iUserId='" . $iUserId . "'");
        if (count($getUserData) > 0) {
            $iGcmRegId = $getUserData[0]['iGcmRegId'];
            $eDeviceType = $getUserData[0]['eDeviceType'];
            $tSessionId = $getUserData[0]['tSessionId'];
            $vLang = $getUserData[0]['vLang'];
            $eAppTerminate = $getUserData[0]['eAppTerminate'];
            $eDebugMode = $getUserData[0]['eDebugMode'];
            $eHmsDevice = $getUserData[0]['eHmsDevice'];
            if ($vLang == "" || $vLang == NULL) {
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
                $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
                //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
            $alertMsg = $languageLabelsArr['LBL_TRIP_RESUMED_TXT'];
            if ($alertMsgCode == 1) {
                $alertMsg = $languageLabelsArr['LBL_TRIP_PUT_ON_HOLD_TXT'];
            }
            //$message = $alertMsg; // Commented By HJ On 20-10-2020 Then Add Below Array As Per Discuss with KS sir
            // Added By HJ On 20-10-2020 Then Add Below Array As Per Discuss with KS sir Start
            $message_arr = array();
            $message_arr['vMsgCode'] = strval(time());
            $message_arr['MsgType'] = "Notification";
            $message_arr['vTitle'] = $alertMsg;
            $message_arr['tSessionId'] = $tSessionId;
            $message_arr['tRandomCode'] = time();
            //added by SP on 17-02-2021 for custom notification
            $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
            //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
            $message_arr['CustomViewBtn'] = "Yes";
            $message_arr['CustomTrackDetails'] = "No";
            $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
            $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
            $customNotiArray = GetCustomNotificationDetails($iTripId, $message_arr['vTitle'], $vLang);
            //title and sub description shown in custom notification
            $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
            $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
            $message_arr['CustomMessage'] = $customNotiArray;
            if ($eBookingFrom != 'Kiosk') {
                $channelName = "PASSENGER_" . $iUserId;
                $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName);
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
            }
        }
    }
    $totalSec = 0;
    $timeState = 'Pause';
    $iTripTimeId = '';
    foreach ($db_tripTimes as $dtT) {
        if ($dtT['dPauseTime'] != '' && $dtT['dPauseTime'] != '0000-00-00 00:00:00') {
            $totalSec += strtotime($dtT['dPauseTime']) - strtotime($dtT['dResumeTime']);
        } else {
            $totalSec += strtotime(date('Y-m-d H:i:s')) - strtotime($dtT['dResumeTime']);
        }
    }
    $returnArr['totalTime'] = $totalSec;
    setDataResponse($returnArr);
}
###########################################################################
######################################################################
if ($type == "UpdateBookingStatus") {
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : '';
    $eStatus = isset($_REQUEST["eStatus"]) ? $_REQUEST["eStatus"] : '';
    $iDriverId = isset($_REQUEST['iDriverId']) ? $_REQUEST['iDriverId'] : '';
    $vCancelReason = isset($_REQUEST['vCancelReason']) ? $_REQUEST['vCancelReason'] : '';
    $iCancelReasonId = isset($_REQUEST['iCancelReasonId']) ? $_REQUEST['iCancelReasonId'] : '0';
    $eConfirmByProvider = isset($_REQUEST['eConfirmByProvider']) ? $_REQUEST['eConfirmByProvider'] : 'No';
    $dataType = isset($_REQUEST["DataType"]) ? $_REQUEST["DataType"] : '';
    if ($eConfirmByProvider == "" || $eConfirmByProvider == NULL) {
        $eConfirmByProvider = "No";
    }
    $sqldata = "SELECT eStatus,eType,ePayType FROM `cab_booking` WHERE iCabBookingId ='" . $iCabBookingId . "'";
    $BookingData = $obj->MySQLSelect($sqldata);
    $BookingStatus = $BookingData[0]['eStatus'];
    $APP_TYPE = $BookingData[0]['eType'];
    if ($BookingStatus == "Cancel") {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_MANAUL_BOOKING_CANCELLED_MSG";
        $returnArr['DO_RELOAD'] = "Yes";
        setDataResponse($returnArr);
    }
    /*--------------------- After booking time, the service provider does not accept the job ------------------*/
    if ($eConfirmByProvider == "No" && $eStatus == "Accepted" && $APP_TYPE == "UberX") {
        $sql = "SELECT dBooking_date from cab_booking WHERE iCabBookingId ='" . $iCabBookingId . "'";
        $bookingdate = $obj->MySQLSelect($sql);
        $dBooking_date = $bookingdate[0]['dBooking_date'];
        $data_p = date("P");
        $subSqlBook .= "  dBooking_date < ((CONVERT_TZ(NOW(), 'SYSTEM', '" . $data_p . "')))";
        $sql = "SELECT iCabBookingId from cab_booking WHERE $subSqlBook AND iCabBookingId = '" . $iCabBookingId . "' AND iDriverId = '" . $iDriverId . "'";
        $checkbookingdate = $obj->MySQLSelect($sql);
        if (count($checkbookingdate) > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_JOB_ACCEPT_VALIDATION_MSG";
            $returnArr['DO_RELOAD'] = "Yes";
            setDataResponse($returnArr);
        }
    }
    /*--------------------- After booking time, the service provider does not accept the job ------------------*/
    //added by SP for checking wallet balance in uberx when driver accept request of user of book later start
    if ($eStatus == "Accepted" && $eConfirmByProvider == 'No') {
        $ePayType_cabbooking = $BookingData[0]['ePayType'];
        $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision("Ride"); // Added By HJ On 16-10-2020 For get Auto Deduct Driver Commision Configuration As Per eSystem
        if ($enableCommisionDeduct == 'Yes') {
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iDriverId, "Driver");
            $user_available_balance = setTwoDecimalPoint($user_available_balance);
            if ($WALLET_MIN_BALANCE > $user_available_balance) {
                //$Data1['ACCEPT_CASH_TRIPS'] = "No";
                //Added BY HJ On 23-09-2019 As Per Discuss with BM and GP Mam Start
                $driverDetail = get_value('register_driver AS rd LEFT JOIN currency AS c ON c.vName=rd.vCurrencyDriver', 'rd.vCurrencyDriver,c.Ratio,rd.vLang', 'rd.iDriverId', $iDriverId);
                $vCurrencyDriver = $driverDetail[0]['vCurrencyDriver'];
                $ratio = $driverDetail[0]['Ratio'];
                $vLang = $driverDetail[0]['vLang'];
                $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", "");
                $returnArr["IS_LOW_WALLET_BALANCE"] = "No";
                if ($ePayType_cabbooking == "Cash" && $APP_TYPE == "UberX") {
                    $returnArr = array();
                    $returnArr['Action'] = "0"; // code is invalid
                    $returnArr["message"] = str_replace('####', formateNumAsPerCurrency(($WALLET_MIN_BALANCE * $ratio), $vCurrencyDriver), $languageLabelsArr['LBL_REQUIRED_MINIMUM_BALNCE_UBERX']);
                    $returnArr["IS_LOW_WALLET_BALANCE"] = "Yes";
                    echo json_encode($returnArr);
                    exit;
                }
                //Added BY HJ On 23-09-2019 As Per Discuss with BM and GP Mam End
            }
        }
    }
    //added by SP for checking wallet balance in uberx when driver accept request of user of book later end
    ############################################################### CheckPendingBooking UBERX  For same Time booking (Accept , Pending)###########################################################
    if ($APP_TYPE == "UberX") {
        $sql_book = "SELECT dBooking_date from cab_booking WHERE iCabBookingId ='" . $iCabBookingId . "'";
        $checkbooking = $obj->MySQLSelect($sql_book);
        $dBooking_date = $checkbooking[0]['dBooking_date'];
        $sql = "SELECT iCabBookingId from cab_booking WHERE iDriverId ='" . $iDriverId . "' AND dBooking_date = '" . $dBooking_date . "' AND eStatus = 'Accepted' AND iCabBookingId != '" . $iCabBookingId . "'";
        $pendingacceptdriverbooking = $obj->MySQLSelect($sql);
        if (count($pendingacceptdriverbooking) > 0) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_PENDING_PLUS_ACCEPT_BOOKING_AVAIL_TXT";
            $returnArr['message1'] = "Accept";
            setDataResponse($returnArr);
        } else {
            $sql = "SELECT iCabBookingId from cab_booking WHERE iDriverId ='" . $iDriverId . "' AND dBooking_date = '" . $dBooking_date . "' AND eStatus = 'Pending' AND iCabBookingId != '" . $iCabBookingId . "'";
            $pendingdriverbooking = $obj->MySQLSelect($sql);
            if (count($pendingdriverbooking) > 0 && $eConfirmByProvider == "No") {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_PENDING_BOOKING_AVAIL_TXT";
                $returnArr['message1'] = "Pending";
                $returnArr['BookingFound'] = "Yes";
                setDataResponse($returnArr);
            }
        }
    }
    /* For DriverSubscription added by SP start */
    if ($MODULES_OBJ->isDriverSubscriptionModuleAvailable() && $eStatus != 'Declined') {
        $returnSubStatus = 0;
        $returnSubStatus = checkDriverSubscribed($iDriverId);
        if ($returnSubStatus == 1) {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_PENDING_MIXSUBSCRIPTION";
            setDataResponse($returnArr);
        } else if ($returnSubStatus == 2) {
            $returnArr['Action'] = "0";
            //$returnArr['message'] = "PENDING_SUBSCRIPTION";
            $returnArr['message'] = "LBL_PENDING_SUBSCRIPTION_TEXT";
            setDataResponse($returnArr);
        }
    }
    /* For DriverSubscription added by SP end */
    ############################################################### CheckPendingBooking UBERX ###########################################################
    ### Checking For booking timing availablity when driver accept booking ###
    if ($eConfirmByProvider == "No" && $eStatus == "Accepted" && $APP_TYPE == "UberX") {
        $sql = "SELECT dBooking_date from cab_booking WHERE iCabBookingId ='" . $iCabBookingId . "'";
        $bookingdate = $obj->MySQLSelect($sql);
        $dBooking_date = $bookingdate[0]['dBooking_date'];
        $additional_mins = $PROVIDER_BOOKING_ACCEPT_TIME_INTERVAL;
        $FromDate = date("Y-m-d H:i:s", strtotime($dBooking_date . "-" . $additional_mins . " minutes"));
        $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date . "+" . $additional_mins . " minutes"));
        $sql = "SELECT iCabBookingId from cab_booking WHERE (dBooking_date BETWEEN '" . $FromDate . "' AND '" . $ToDate . "') AND iCabBookingId != '" . $iCabBookingId . "' AND eStatus = 'Accepted' AND iDriverId = '" . $iDriverId . "'";
        $checkbookingdate = $obj->MySQLSelect($sql);
        if (count($checkbookingdate) > 0) {
            $returnArr['Action'] = "0";
            $returnArr['BookingFound'] = "Yes";
            $returnArr['message'] = "LBL_PROVIDER_JOB_FOUND_TXT";
            setDataResponse($returnArr);
        }
    }
    ### Checking For booking timing availablity when driver accept booking ###
    $where = " iCabBookingId = '$iCabBookingId' ";
    $Data['eStatus'] = $eStatus;
    $Data['vCancelReason'] = $vCancelReason;
    $Data['iCancelReasonId'] = $iCancelReasonId;
    $Update_Booking_id = $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
    if ($Update_Booking_id) {
        $sql = "SELECT cb.*,concat(ru.vName,' ',ru.vLastName) as UserName,ru.vEmail,ru.vPhone,ru.vPhoneCode,ru.vLang as userlang,concat(rd.vName,' ',rd.vLastName) as DriverName from cab_booking as cb LEFT JOIN register_user as ru ON ru.iUserId=cb.iUserId LEFT JOIN register_driver as rd ON rd.iDriverId=cb.iDriverId WHERE cb.iCabBookingId ='" . $iCabBookingId . "'";
        $bookingdetail = $obj->MySQLSelect($sql);
        $UserPhoneNo = $bookingdetail[0]['vPhone'];
        $UserPhoneCode = $bookingdetail[0]['vPhoneCode'];
        $UserLang = $bookingdetail[0]['userlang'];
        $Data1['vRider'] = $bookingdetail[0]['UserName'];
        $Data1['vDriver'] = $bookingdetail[0]['DriverName'];
        $Data1['vRiderMail'] = $bookingdetail[0]['vEmail'];
        $Data1['vBookingNo'] = $bookingdetail[0]['vBookingNo'];
        $Data1['dBookingdate'] = date('Y-m-d H:i', strtotime($bookingdetail[0]['dBooking_date']));
        if ($eStatus == "Accepted") {
            $returnArr['message'] = "LBL_JOB_ACCEPTED";
            $sendMailtoUser = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_BOOKING_ACCEPT_BYDRIVER_SP", $Data1);
        } else if ($eStatus == "Declined") {
            $returnArr['message'] = "LBL_JOB_DECLINED";
            $sendMailtoUser = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_BOOKING_DECLINED_BYDRIVER_SP", $Data1);
        } else {
            $returnArr['message'] = getDriverDetailInfo($iDriverId);
        }
        if ($eStatus == "Accepted" || $eStatus == "Declined") {
            $USER_SMS_TEMPLATE = ($eStatus == "Accepted") ? "BOOKING_ACCEPT_BYDRIVER_MESSAGE_SP" : "BOOKING_DECLINED_BYDRIVER_MESSAGE_SP";
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate($USER_SMS_TEMPLATE, $Data1, "", $UserLang);
            //added by SP for sms functionality on 15-7-2019 start
            $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM `register_user` AS r, `country` AS c WHERE r.iUserId = '" . $bookingdetail[0]['iUserId'] . "' AND r.vCountry = c.vCountryCode");
            $PhoneCodeP = $passengerData[0]['vPhoneCode'];
            $UsersendMessage = $COMM_MEDIA_OBJ->SendSystemSMS($UserPhoneNo, $PhoneCodeP, $message_layout);
            //added by SP for sms functionality on 15-7-2019 end
            /* $UsersendMessage = $COMM_MEDIA_OBJ->SendMemberSMS($UserPhoneNo, $UserPhoneCode, $message_layout, "");

                  if ($UsersendMessage == 0) {

                  $isdCode = $SITE_ISD_CODE;

                  $UserPhoneCode = $isdCode;

                  $UsersendMessage = $COMM_MEDIA_OBJ->SendMemberSMS($UserPhoneNo, $UserPhoneCode, $message_layout, "");

              } */
        }
        $returnArr['Action'] = "1";
        if ($eStatus == "Accepted") {
            $returnArr['message'] = "LBL_JOB_ACCEPTED";
        } else if ($eStatus == "Declined" && $dataType == "PENDING") {
            $returnArr['message'] = "LBL_JOB_DECLINED";
        } else if ($eStatus == "Declined" && $dataType != "PENDING") {
            $returnArr['message'] = "LBL_BOOKING_CANCELED";
        } else {
            $returnArr['message'] = getDriverDetailInfo($iDriverId);
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
###########################Display User Address##########################################################
if ($type == "DisplayUserAddress") {
    $iUserId = isset($_REQUEST['iUserId']) ? clean($_REQUEST['iUserId']) : '';
    $eUserType = isset($_REQUEST['eUserType']) ? clean($_REQUEST['eUserType']) : 'Passenger';
    /* Food App Param */
    $passengerLat = isset($_REQUEST["PassengerLat"]) ? $_REQUEST["PassengerLat"] : '';
    $passengerLon = isset($_REQUEST["PassengerLon"]) ? $_REQUEST["PassengerLon"] : '';
    $iCompanyId = isset($_REQUEST["iCompanyId"]) ? $_REQUEST["iCompanyId"] : '0';
    $iDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '0';
    $eCatType = isset($_REQUEST["eCatType"]) ? $_REQUEST["eCatType"] : '';
    /* Food App Param */
    if ($eUserType == "Passenger") {
        $eUserType = "Rider";
    }
    if ($iCompanyId > 0) {
        /* Food App Code */
        $sql = "select vRestuarantLocationLat,vRestuarantLocationLong from `company` where iCompanyId = '" . $iCompanyId . "'";
        $db_companydata = $obj->MySQLSelect($sql);
        $vRestuarantLocationLat = $db_companydata[0]['vRestuarantLocationLat'];
        $vRestuarantLocationLong = $db_companydata[0]['vRestuarantLocationLong'];
        $sql = "select * from `user_address` where iUserId = '" . $iUserId . "' AND eUserType = '" . $eUserType . "' AND eStatus = 'Active' ORDER BY iUserAddressId DESC";
        $db_userdata = $obj->MySQLSelect($sql);
        $db_userdata_new = array();
        $db_userdata_new = $db_userdata;
        if (count($db_userdata) > 0) {
            for ($i = 0; $i < count($db_userdata); $i++) {
                $isRemoveAddressFromList = "No";
                $passengeraddlat = $db_userdata[$i]['vLatitude'];
                $passengeraddlong = $db_userdata[$i]['vLongitude'];
                $distance = distanceByLocation($passengerLat, $passengerLon, $passengeraddlat, $passengeraddlong, "K");
                if ($distance > $LIST_RESTAURANT_LIMIT_BY_DISTANCE && !in_array($eCatType, ['Genie', 'Runner', 'Anywhere'])) {
                    $isRemoveAddressFromList = "Yes";
                }
                $distancewithcompany = distanceByLocation($passengerLat, $passengerLon, $vRestuarantLocationLat, $vRestuarantLocationLong, "K");
                if ($distancewithcompany > $LIST_RESTAURANT_LIMIT_BY_DISTANCE && !in_array($eCatType, ['Genie', 'Runner', 'Anywhere'])) {
                    $isRemoveAddressFromList = "Yes";
                }
                if ($isRemoveAddressFromList == "Yes") {
                    unset($db_userdata_new[$i]);
                }
            }
            $db_userdata = array_values($db_userdata_new);
            if (count($db_userdata) > 0) {
                $returnArr['Action'] = "1";
                $returnArr['message'] = $db_userdata;
            } else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_NO_USER_ADDRESS_FOUND";
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NO_USER_ADDRESS_FOUND";
        }
        setDataResponse($returnArr);
        /* Food App Code */
    } else {
        /* Cubejek App Code */
        $sql = "select * from `user_address` where iUserId = '" . $iUserId . "' AND eUserType = '" . $eUserType . "' AND eStatus = 'Active' ORDER BY iUserAddressId DESC";
        $db_userdata = $obj->MySQLSelect($sql);
        if ($SERVICE_PROVIDER_FLOW == "Provider" && $iDriverId > 0) {
            $getLocaionData = $obj->MySQLSelect("SELECT eSelectWorkLocation,vLatitude,vLongitude,vWorkLocationLatitude,vWorkLocationLongitude,vWorkLocationRadius FROM register_driver WHERE iDriverId='" . $iDriverId . "'");
            if (count($getLocaionData) > 0) {
                $vLatitude = $getLocaionData[0]['vLatitude'];
                $vLongitude = $getLocaionData[0]['vLongitude'];
                $eSelectWorkLocation = $getLocaionData[0]['eSelectWorkLocation'];
                $vWorkLocationRadius = $RESTRICTION_KM_NEAREST_TAXI;
                if (isset($getLocaionData[0]['vWorkLocationRadius']) && $getLocaionData[0]['vWorkLocationRadius'] > 0) {
                    $vWorkLocationRadius = $getLocaionData[0]['vWorkLocationRadius'];
                }
                if ($eSelectWorkLocation == "Fixed") {
                    $vLatitude = $getLocaionData[0]['vWorkLocationLatitude'];
                    $vLongitude = $getLocaionData[0]['vWorkLocationLongitude'];
                }
            }
            for ($r = 0; $r < count($db_userdata); $r++) {
                $userLat = $db_userdata[$r]['vLatitude'];
                $userLang = $db_userdata[$r]['vLongitude'];
                $distance = distanceByLocation($vLatitude, $vLongitude, $userLat, $userLang, "K");
                $isRemoveAddressFromList = "No";
                if ($distance <= $vWorkLocationRadius) {
                    $isRemoveAddressFromList = "Yes";
                }
                $db_userdata[$r]['eLocationAvailable'] = $isRemoveAddressFromList;
            }
        }
        if (count($db_userdata) > 0) {
            $returnArr['Action'] = "1";
            $returnArr['message'] = $db_userdata;
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NO_USER_ADDRESS_FOUND";
        }
        setDataResponse($returnArr);
        /* Cubejek App Code */
    }
}
###########################Display User Address End######################################################

#############################Display  Schedule Booking Details######################################################################
if ($type == "DisplayScheduleBookingDetail") {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $eUserType = isset($_REQUEST["eUserType"]) ? $_REQUEST["eUserType"] : 'Passenger';
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : '';
    //$APP_TYPE = $CONFIG_OBJ->getConfigurations("configurations","APP_TYPE");
    //$APP_TYPE = "UberX";
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if ($iCabBookingId != "") {
        $sql = "SELECT * from cab_booking WHERE iCabBookingId = '" . $iCabBookingId . "'";
        $bookingData = $obj->MySQLSelect($sql);
        if ($eUserType == "Passenger") {
            $tableName = "register_driver";
            $fields = 'iDriverId, vPhone,vCode as vPhoneCode, vEmail, CONCAT(vName," ",vLastName) as vName,vAvgRating,vImage as Imgname,vLang';
            $condfield = 'iDriverId';
            $UserId = $bookingData[0]['iDriverId'];
            $Photo_Gallery_folder_path = $tconfig['tsite_upload_images_driver_path'] . "/" . $UserId . "/";
            $Photo_Gallery_folder = $tconfig['tsite_upload_images_driver'] . "/" . $UserId . "/";
            $vCurrency = get_value('register_user', 'vCurrencyPassenger', 'iUserId', $bookingData[0]['iUserId'], '', 'true');
        } else {
            $tableName = "register_user";
            $fields = 'iUserId, vPhone,vPhoneCode as vPhoneCode, vEmail, CONCAT(vName," ",vLastName) as vName,vAvgRating,vImgName as Imgname,vLang';
            $condfield = 'iUserId';
            $UserId = $bookingData[0]['iUserId'];
            $Photo_Gallery_folder_path = $tconfig['tsite_upload_images_passenger_path'] . "/" . $UserId . "/";
            $Photo_Gallery_folder = $tconfig['tsite_upload_images_passenger'] . "/" . $UserId . "/";
            $vCurrency = get_value('register_driver', 'vCurrencyDriver', 'iDriverId', $bookingData[0]['iDriverId'], '', 'true');
        }
        $sql = "select $fields from $tableName where $condfield = '" . $UserId . "'";
        $db_member = $obj->MySQLSelect($sql);
        $lang = $db_member[0]['vLang'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
        }
        $db_member[0]['vLang'] = $lang;
        if ($vCurrency == "" || $vCurrency == NULL) {
            $vCurrency = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
        }
        $UserCurrencyData = get_value('currency', 'vSymbol, Ratio', 'vName', $vCurrency);
        $priceRatio = $UserCurrencyData[0]['Ratio'];
        $vSymbol = $UserCurrencyData[0]['vSymbol'];
        $db_member[0]['vSymbol'] = $vSymbol;
        $imgpath = $Photo_Gallery_folder_path . "2_" . $db_member[0]['Imgname'];
        if ($db_member[0]['Imgname'] != "" && file_exists($imgpath)) {
            $db_member[0]['Imgname'] = $Photo_Gallery_folder . "2_" . $db_member[0]['Imgname'];
        } else {
            $db_member[0]['Imgname'] = "";
        }
        $vehicleDetailsArr = array();
        $iVehicleTypeId = $bookingData[0]['iVehicleTypeId'];
        $sql2 = "SELECT vc.iVehicleCategoryId, vc.iParentId,vc.vCategory_" . $lang . " as vCategory, vc.vCategoryTitle_" . $lang . " as vCategoryTitle, vc.tCategoryDesc_" . $lang . " as tCategoryDesc, vc.ePriceType, vt.vVehicleType_" . $lang . " as vVehicleType, vt.eFareType, vt.fFixedFare, vt.fPricePerHour, vt.fPricePerKM, vt.fPricePerMin, vt.iBaseFare,vt.fCommision, vt.iMinFare,vt.iPersonSize, vt.vLogo as vVehicleTypeImage, vt.eType, vt.eIconType, vt.eAllowQty, vt.iMaxQty, vt.iVehicleTypeId, fFixedFare FROM " . $sql_vehicle_category_table_name . " as vc LEFT JOIN vehicle_type AS vt ON vt.iVehicleCategoryId = vc.iVehicleCategoryId WHERE vt.iVehicleTypeId='" . $iVehicleTypeId . "'";
        $Data = $obj->MySQLSelect($sql2);
        $iParentId = $Data[0]['iParentId'];
        if ($iParentId == 0) {
            $ePriceType = $Data[0]['ePriceType'];
        } else {
            $ePriceType = get_value($sql_vehicle_category_table_name, 'ePriceType', 'iVehicleCategoryId', $iParentId, '', 'true');
        }
        $ALLOW_SERVICE_PROVIDER_AMOUNT = $ePriceType == "Provider" ? "Yes" : "No";
        if ($Data[0]['eFareType'] == "Fixed") {
            //$fAmount = $vCurrencySymbol.$vehicleTypeData[0]['fFixedFare'];
            $fAmount = $Data[0]['fFixedFare'];
        } else if ($Data[0]['eFareType'] == "Hourly") {
            //$fAmount = $vCurrencySymbol.$vehicleTypeData[0]['fPricePerHour']."/hour";
            $fAmount = $Data[0]['fPricePerHour'];
        } else {
            $vDistance = $bookingData[0]['vDistance'];
            $vDuration = $bookingData[0]['vDuration'];
            $Minute_Fare = round($Data[0]['fPricePerMin'] * $vDuration, 2);
            $Distance_Fare = round($Data[0]['fPricePerKM'] * $vDistance, 2);
            $iBaseFare = round($Data[0]['iBaseFare'], 2);
            $fAmount = $iBaseFare + $Minute_Fare + $Distance_Fare;
        }
        $iPrice = $fAmount;
        if ($ALLOW_SERVICE_PROVIDER_AMOUNT == "Yes") {
            $sqlServicePro = "SELECT * FROM `service_pro_amount` WHERE iDriverVehicleId='" . $iDriverVehicleId . "' AND iVehicleTypeId='" . $iVehicleTypeId . "'";
            $serviceProData = $obj->MySQLSelect($sqlServicePro);
            if (count($serviceProData) > 0) {
                $fAmount = $serviceProData[0]['fAmount'];
            } else {
                $fAmount = $iPrice;
            }
            $iPrice = $fAmount;
        }
        $iPrice = $iPrice * $priceRatio;
        $iPrice = round($iPrice, 2);
        //$vehicleDetailsArr['fAmount'] = $vSymbol . " " . $iPrice;
        $vehicleDetailsArr['fAmount'] = formateNumAsPerCurrency($iPrice, $vCurrency);
        $vehicleDetailsArr['ePriceType'] = $ePriceType;
        $vehicleDetailsArr['ALLOW_SERVICE_PROVIDER_AMOUNT'] = $ALLOW_SERVICE_PROVIDER_AMOUNT;
        $returnArr['Action'] = "1";
        $returnArr['MemberDetails'] = $db_member;
        $returnArr['VehicleDetails'] = $vehicleDetailsArr;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
#############################Display  Schedule Booking Details Ends#################################################################
#############################Check Restriction For Pickup and DropOff Location For Delivery#########################################
if ($type == "Checkpickupdropoffrestriction") {
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $PickUpLatitude = isset($_REQUEST["PickUpLatitude"]) ? $_REQUEST["PickUpLatitude"] : '';
    $PickUpLongitude = isset($_REQUEST["PickUpLongitude"]) ? $_REQUEST["PickUpLongitude"] : '';
    $DestLatitude = isset($_REQUEST["DestLatitude"]) ? $_REQUEST["DestLatitude"] : '';
    $DestLongitude = isset($_REQUEST["DestLongitude"]) ? $_REQUEST["DestLongitude"] : '';
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger';
    $CheckType = isset($_REQUEST["CheckType"]) ? $_REQUEST["CheckType"] : 'Pickup'; // Pickup Or Drop
    if ($CheckType == "" || $CheckType == NULL) {
        $CheckType = "Pickup";
    }
    $allowed_ans = $allowed_ans_drop = '';
    if (!empty($PickUpLatitude) && !empty($PickUpLongitude)) {
        $pickuplocationarr = array($PickUpLatitude, $PickUpLongitude);
        $allowed_ans = checkAreaRestriction($pickuplocationarr, "No");
    }
    if (!empty($DestLatitude) && !empty($DestLongitude)) {
        $dropofflocationarr = array($DestLatitude, $DestLongitude);
        $allowed_ans_drop = checkAreaRestriction($dropofflocationarr, "Yes");
    }
    $returnArr['Action'] = "1";
    if ($allowed_ans == "No" && $allowed_ans_drop == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICK_DROP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    } else if ($allowed_ans_drop == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_DROP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    } else if ($allowed_ans == "No") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_PICKUP_LOCATION_NOT_ALLOW";
        setDataResponse($returnArr);
    }
    setDataResponse($returnArr);
}
#############################Check Restriction For Pickup and DropOff Location For Delivery#########################################

################################################UpdateBooking Date  Of Ride, Delivery ######################################
if ($type == "UpdateBookingDateRideDelivery") {
    $iCabBookingId = isset($_REQUEST["iCabBookingId"]) ? $_REQUEST["iCabBookingId"] : '';
    $scheduleDate = isset($_REQUEST["scheduleDate"]) ? $_REQUEST["scheduleDate"] : '';
    $eConfirmByUser = isset($_REQUEST['eConfirmByUser']) ? $_REQUEST['eConfirmByUser'] : 'No';
    if ($eConfirmByUser == "" || $eConfirmByUser == NULL) {
        $eConfirmByUser = "No";
    }
    if (empty($iCabBookingId)) {
        $returnArr["Action"] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        setDataResponse($returnArr);
    }
    $sql = "SELECT * from  cab_booking  WHERE iCabBookingId ='" . $iCabBookingId . "'";
    $bookingdetail = $obj->MySQLSelect($sql);
    if ($bookingdetail[0]['eType'] == "UberX" && $SERVICE_PROVIDER_FLOW == "Provider") {
        $sdate = explode(" ", $scheduleDate);
        $shour = explode("-", $sdate[1]);
        $shour1 = $shour[0];
        $shour2 = $shour[1];
        if ($shour1 == "12" && $shour2 == "01") {
            $shour1 = 00;
        }
        $scheduleDate = $sdate[0] . " " . $shour1 . ":00:00";
    }
    $Booking_Date_Time = $scheduleDate;
    $systemTimeZone = date_default_timezone_get();
    $scheduleDate = converToTz($scheduleDate, $systemTimeZone, $vTimeZone);
    $fPickUpPrice = 1;
    $fNightPrice = 1;
    $iVehicleTypeId = $bookingdetail[0]['iVehicleTypeId'];
    $iUserId = $bookingdetail[0]['iUserId'];
    $vSourceAddresss = $bookingdetail[0]['vSourceAddresss'];
    //added for rental
    $iRentalPackageId = $bookingdetail[0]['iRentalPackageId'];
    $vDistance = $bookingdetail[0]['vDistance'];
    $vDuration = $bookingdetail[0]['vDuration'];
    $iDriverId = $bookingdetail[0]['iDriverId'];
    $vCouponCode = $bookingdetail[0]['vCouponCode'];
    $isDestinationAdded = "Yes";
    $eFlatTrip = $bookingdetail[0]['eFlatTrip'];
    $fFlatTripPrice = $bookingdetail[0]['fFlatTripPrice'];
    $sourceLocationArr = array($bookingdetail[0]['vSourceLatitude'], $bookingdetail[0]['vSourceLongitude']);
    $destinationLocationArr = array($bookingdetail[0]['vDestLatitude'], $bookingdetail[0]['vDestLongitude']);
    $currentdate = date("Y-m-d H:i:s");
    $dBooking_date = $bookingdetail[0]['dBooking_date'];
    $datediff = abs(strtotime($dBooking_date) - strtotime($currentdate));
    if ($datediff < 1800) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_RE_SCHEDULE_BOOK_RESTRICTION";
        setDataResponse($returnArr);
    }
    $eFareType = "";
    if ($bookingdetail[0]['eType'] == "UberX" && !empty($bookingdetail[0]['tVehicleTypeData']) && $SERVICE_PROVIDER_FLOW == "Provider") {
        $tVehicleTypeDataArr = (array)json_decode($bookingdetail[0]['tVehicleTypeData']);
        if (count($tVehicleTypeDataArr) > 0) {
            $eFareType = get_value('vehicle_type', 'eFareType', 'iVehicleTypeId', $tVehicleTypeDataArr[0]->iVehicleTypeId, '', 'true');
        }
    }
    //added for rental
    if ($bookingdetail[0]['eType'] != "UberX" || ($bookingdetail[0]['eType'] == "UberX" && $bookingdetail[0]['eFareType'] == "Regular")) {
        $data_surgePrice = checkSurgePrice($iVehicleTypeId, $Booking_Date_Time, $iRentalPackageId);
        $surgePrice = 1;
        if ($data_surgePrice['Action'] == "0") {
            if ($data_surgePrice['message'] == "LBL_PICK_SURGE_NOTE") {
                $fPickUpPrice = $data_surgePrice['SurgePriceValue'];
                $surgePrice = $fPickUpPrice;
            } else {
                $fNightPrice = $data_surgePrice['SurgePriceValue'];
                $surgePrice = $fNightPrice;
            }
            if ($eConfirmByUser == "No") {
                $Fare_data = calculateApproximateFareGeneral($vDuration, $vDistance, $iVehicleTypeId, $iUserId, 1, "", "", $vCouponCode, $surgePrice, 0, 0, 0, "DisplySingleVehicleFare", $GeneralUserType, 1, "", $isDestinationAdded, $eFlatTrip, $fFlatTripPrice, $sourceLocationArr, $destinationLocationArr);
                $HistoryFareDetailsArr = array();
                foreach ($Fare_data as $inner) {
                    $HistoryFareDetailsArr = array_merge($HistoryFareDetailsArr, $inner);
                }
                $total_fare = end($HistoryFareDetailsArr);
                $data_surgePrice["total_fare"] = $total_fare;
                setDataResponse($data_surgePrice);
            }
        }
    }
    $where = " iCabBookingId = '" . $iCabBookingId . "'";
    $Data['fPickUpPrice'] = $fPickUpPrice;
    $Data['fNightPrice'] = $fNightPrice;
    $Data['dBooking_date'] = date('Y-m-d H:i:s', strtotime($scheduleDate));
    if ($bookingdetail[0]['eType'] == "UberX" && !empty($bookingdetail[0]['tVehicleTypeData']) && $SERVICE_PROVIDER_FLOW == "Provider" && ($bookingdetail[0]['eStatus'] == "Declined" || $bookingdetail[0]['eStatus'] == "Cancel")) {
        $Data['eStatus'] = "Pending";
        $Data['vCancelReason'] = "";
        $Data['iCancelReasonId'] = "";
        $Data['vFailReason'] = "";
        $Data['eCancelBy'] = "";
        $Data['iCancelByUserId'] = "";
    }
    $id = $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
    if ($id > 0) {
        $returnArr["Action"] = "1";
        //$returnArr['message']= $APP_TYPE == "Ride" ?"LBL_RIDE_BOOKED":"LBL_DELIVERY_BOOKED";
        $returnArr["message"] = "LBL_INFO_UPDATED_TXT";
        $sql = "SELECT concat(vName,' ',vLastName) as senderName,vEmail,vPhone,vPhoneCode,vLang from  register_user  WHERE iUserId ='" . $iUserId . "'";
        $userdetail = $obj->MySQLSelect($sql);
        $Data1['vRider'] = $userdetail[0]['senderName'];
        $Data1['vRiderMail'] = $userdetail[0]['vEmail'];
        $Data1['vSourceAddresss'] = $vSourceAddresss;
        $Data1['dBookingdate'] = DateTime($Booking_Date_Time, 7);
        //$Data1['dBookingdate']=date('Y-m-d H:i', strtotime($Booking_Date_Time));
        $Data1['vBookingNo'] = $bookingdetail[0]['vBookingNo'];
        if ($bookingdetail[0]['eType'] == "UberX") {
            $sql = "SELECT concat(vName,' ',vLastName) as drivername,vEmail,vPhone,vcode,iDriverVehicleId,vLang from  register_driver  WHERE iDriverId ='" . $iDriverId . "'";
            $driverdetail = $obj->MySQLSelect($sql);
            $DriverPhoneNo = $driverdetail[0]['vPhone'];
            $Booking_Date = @date('d-m-Y', strtotime($Booking_Date_Time));
            $Booking_Time = @date('H:i:s', strtotime($Booking_Date_Time));
            $maildata1['PASSENGER_NAME'] = $Data1['vRider'];
            $maildata1['BOOKING_DATE'] = $Booking_Date;
            $maildata1['BOOKING_TIME'] = $Booking_Time;
            $maildata1['BOOKING_NUMBER'] = $Data1['vBookingNo'];
            $DRIVER_SMS_TEMPLATE = ($bookingdetail[0]['eType'] == "UberX") ? "DRIVER_SEND_MESSAGE_SP" : "DRIVER_SEND_MESSAGE";
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate($DRIVER_SMS_TEMPLATE, $maildata1, "", $DriverLang);
            $DriversendMessage = $COMM_MEDIA_OBJ->SendMemberSMS($DriverPhoneNo, $DriverPhoneCode, $message_layout, "");
            if ($DriversendMessage == 0) {
                //$isdCode= $CONFIG_OBJ->getConfigurations("configurations","SITE_ISD_CODE");
                $isdCode = $SITE_ISD_CODE;
                $DriverPhoneCode = $isdCode;
                $UsersendMessage = $COMM_MEDIA_OBJ->SendMemberSMS($DriverPhoneNo, $DriverPhoneCode, $message_layout, "");
            }
        }
        $sendMailToAdmin = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_TAXI_DISPATCH_RIDER_RESCEDULE_ADMIN_APP", $Data1);
        $sendMailToUser = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_TAXI_DISPATCH_RIDER_RESCEDULE_APP", $Data1);
    } else {
        $returnArr["Action"] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
################################################UpdateBooking Date  Of Ride, Delivery
################################################Charge Passenger's Outstanding Amount From Credit Card
if ($type == "ChargePassengerOutstandingAmount") {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger'; //Passenger
    /* For New Payment Flow */
    $params = array("iMemberId" => $iMemberId, "eUserType" => "Passenger", "GET_DATA" => "Yes");
    $payment_mode_data = GetPaymentModeDetails($params);
    $ePaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
    $cashPayment = $ePaymentMode == "cash" ? "Yes" : "No";
    $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
    $isRestrictToWallet = $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
    $ePaymentBy = !empty($payment_mode_data['ePaymentBy']) ? $payment_mode_data['ePaymentBy'] : "Passenger";
    /* For New Payment Flow End */
    $fTripsOutStandingAmount = GetPassengerOutstandingAmount($iMemberId);
    if ($fTripsOutStandingAmount == 0) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = getPassengerDetailInfo($iMemberId, "", "");
        $returnArr['message1'] = "LBL_OUTSTANDING_AMOUT_ALREADY_PAID_TXT";
        setDataResponse($returnArr);
    }
    if ($eMemberType == "Passenger") {
        $sql = "SELECT tSessionId FROM `register_user` WHERE iUserId='" . $iMemberId . "'";
    } else {
        $sql = "SELECT tSessionId FROM `register_driver` WHERE iDriverId='" . $iMemberId . "'";
    }
    $userData = $obj->MySQLSelect($sql);
    $tDescription = "Amount charge for trip oustanding balance";
    $extraParams = "eType=&ePaymentType=ChargeOutstandingAmount&tSessionId=" . $userData[0]['tSessionId'] . "&GeneralMemberId=" . $iMemberId . "&GeneralUserType=Passenger&iServiceId=&AMOUNT=" . $fTripsOutStandingAmount . "&PAGE_TYPE=CHARGE_OUTSTANDING_AMT&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes&description=" . urlencode($tDescription);
    $returnArr['Action'] = "0";
    $returnArr['OUTSTANDING_PAYMENT_URL'] = $tconfig['tsite_url'] . 'assets/libraries/webview/payment_mode_select.php?' . $extraParams;
    setDataResponse($returnArr);
}
################################################Charge Passenger's Outstanding Amount From Credit Card #################
################################################Get Passenger's Outstanding Amount############################################
if ($type == "getOutstandingAmount") {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $eMemberType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : 'Passenger'; //Passenger
    $fTripsOutStandingAmount = GetPassengerOutstandingAmount($iMemberId);
    $fTripsOutStandingAmount_ARR = getPriceUserCurrency($iMemberId, "Passenger", $fTripsOutStandingAmount);
    $returnArr['Action'] = "1";
    $returnArr['message']['fOutStandingAmount'] = $fTripsOutStandingAmount_ARR['fPrice'];
    $returnArr['message']['fOutStandingAmountWithSymbol'] = $fTripsOutStandingAmount_ARR['fPricewithsymbol'];
    /* For New Payment Flow */
    $params = array("iMemberId" => $iMemberId, "eUserType" => $eMemberType, "GET_DATA" => "Yes");
    $payment_mode_data = GetPaymentModeDetails($params);
    $ePaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
    $ePayWallet = $ePaymentMode == "wallet" ? "Yes" : "No";
    $returnArr['message']['ShowAdjustTripBtn'] = $returnArr['message']['ShowPayNow'] = "Yes";
    if ($MODULES_OBJ->isEnableOutstandingRestriction()) {
        if ($eMemberType == "Passenger") {
            if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                $returnArr['message']['ShowPayNow'] = "No";
                $returnArr['message']['ShowAdjustTripBtn'] = "No";
            }
            if ($CONFIG_OBJ->isOnlyCardPaymentModeAvailable() || $CONFIG_OBJ->isOnlyWalletPaymentModeAvailable()) {
                $returnArr['message']['ShowPayNow'] = "Yes";
                $returnArr['message']['ShowAdjustTripBtn'] = "No";
            }
            if (strtoupper($ePayWallet) == "YES") {
                $outStandingSql = " AND eAuthoriseIdName='No' AND iAuthoriseId ='0'";
            }
            $sql = "SELECT count(iTripOutstandId) as counttrip FROM trip_outstanding_amount WHERE iUserId='" . $iMemberId . "' AND iUserId > 0 AND ePaidByPassenger = 'No' $outStandingSql";
            $counttripData = $obj->MySQLSelect($sql);
            if ($counttripData[0]['counttrip'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                    $returnArr['message']['ShowAdjustTripBtn'] = "No";
                }
                if ($CONFIG_OBJ->isOnlyCardPaymentModeAvailable() || $CONFIG_OBJ->isOnlyWalletPaymentModeAvailable()) {
                    $returnArr['message']['ShowAdjustTripBtn'] = "No";
                    $returnArr['message']['ShowPayNow'] = "Yes";
                }
                $returnArr['message']['OutstandingTrips'] = $counttripData[0]['counttrip'];
            }
            if ($returnArr['message']['OutstandingTrips'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                $returnArr['message']['ShowAdjustTripBtn'] = "No";
            }
        }
    }
    /* For New Payment Flow End */
    setDataResponse($returnArr);
}
################################################Get Passenger's Outstanding Amount############################################
####################################Service Category##################################
if ($type == "getServiceCategories") {
    $parentId = isset($_REQUEST['parentId']) ? clean($_REQUEST['parentId']) : 0;
    $userId = isset($_REQUEST['userId']) ? clean($_REQUEST['userId']) : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $bookingFrom = isset($_REQUEST["bookingFrom"]) ? $_REQUEST["bookingFrom"] : 'App';//added by SP for manual booking for admin side not check user id.
    $eCatType = isset($_REQUEST["eCatType"]) ? $_REQUEST["eCatType"] : '';
    $eForVideoConsultation = isset($_REQUEST["eForVideoConsultation"]) ? $_REQUEST["eForVideoConsultation"] : 'No';
    $parentId = rtrim($parentId, ",");
    $parentIdCount = count(explode(",", $parentId));
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if ($userId != "" || $bookingFrom == 'Web') {
        $lang = $vGeneralLang;
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $userId])) {
            $row = $userDetailsArr['register_user_' . $userId];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$userId'");
            $userDetailsArr['register_user_' . $userId] = $row;
        }
        $userEmailC = $row[0]['eTestUser'];
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
        $lang = $row[0]['vLang'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
        }
        $vehicle_category_main = get_value($sql_vehicle_category_table_name, 'vCategory_' . $lang, 'iVehicleCategoryId', $parentId, '', 'true');
        $ssql = $ssql1 = $ssql2 = $ssql3 = '';
        //$ufxEnable = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
        $ufxEnable = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
        if ($APP_TYPE == "UberX") {
            $ssql = " AND eCatType='ServiceProvider'";
            if ($parent_ufx_catid > 0 && $parentId == 0) {
                $ssql .= " AND iVehicleCategoryId='" . $parent_ufx_catid . "'";
            }
        }
        if ($THEME_OBJ->isCubexThemeActive() == 'Yes' || $THEME_OBJ->isCubeXv2ThemeActive() == 'Yes' || $THEME_OBJ->isPXCProThemeActive() == 'Yes') {
            $ssql1 = $ssql2 = $ssql3 = $eCatTypeQuery = '';
            if ($ufxEnable != 'Yes') {
                $ssql1 .= " AND eCatType!='ServiceProvider'";
            } else {
                $ssql2 .= " OR eCatType='ServiceProvider'";
            }
            if ($THEME_OBJ->isCubexThemeActive() == 'Yes') {
                $eCatTypeQuery = " ('Ride', 'MotoRide', 'Fly', 'Donation') ";
            } elseif ($THEME_OBJ->isCubeXv2ThemeActive() == 'Yes' || $THEME_OBJ->isPXCProThemeActive() == 'Yes') {
                $eCatTypeQuery = " ('Ride', 'MotoRide', 'Rental', 'MotoRental', 'Fly', 'Donation', 'RidePool') ";
            }
            $ssql .= " AND (iServiceId IN ($enablesevicescategory) OR eCatType IN $eCatTypeQuery OR (eFor = 'DeliveryCategory' AND eCatType = 'MoreDelivery')  $ssql2 )  $ssql1";
        }
        if ($THEME_OBJ->isCubeJekXThemeActive() == 'Yes' || !$MODULES_OBJ->isUberXFeatureAvailable()) {
            if ($ufxEnable != 'Yes') {
                $ssql .= " AND eCatType!='ServiceProvider'";
            }
        }
        if (!$MODULES_OBJ->isAirFlightModuleAvailable()) {
            $ssql .= " AND eCatType!='Fly'";
        }
        if (!$MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
            $ssql .= " AND eCatType!='Genie' AND eCatType!='Runner' AND eCatType!='Anywhere' ";
        } elseif ($MODULES_OBJ->isEnableAnywhereDeliveryFeature() && $THEME_OBJ->isCubeXv2ThemeActive() == 'Yes') {
            $ssql .= " OR eCatType IN ('Genie', 'Runner', 'Anywhere') ";
        }
        if (!$MODULES_OBJ->isDeliverAllFeatureAvailable()) {
            if ($THEME_OBJ->isCubeXv2ThemeActive() == 'Yes') {
                $ssql .= " AND eCatType != 'DeliverAll' ";
            } else {
                $ssql .= " AND eCatType != 'DeliverAll' AND (eCatType != 'MoreDelivery' AND eFor != 'DeliverAllCategory') ";
            }
        }
        if ($MODULES_OBJ->isDonationFeatureAvailable()) {
            $sql2 = "SELECT iVehicleCategoryId, vLogo,vLogo2, eShowType,vBannerImage, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText,iServiceId, eDeliveryType,vListLogo,eCatViewType,tListDescription,vListLogo1,vListLogo2,ePromoteBanner,vPromoteBannerImage,tPromoteBannerTitle,eVideoConsultEnable,eFor,vIconDetails,eForMedicalService,iParentId,tMedicalServiceInfo FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND iParentId IN ($parentId) " . $ssql . " ORDER BY iDisplayOrder,iVehicleCategoryId ASC";
        } else {
            $sql2 = "SELECT iVehicleCategoryId, vLogo,vLogo2, eShowType,vBannerImage, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText,iServiceId, eDeliveryType,vListLogo,eCatViewType,tListDescription,vListLogo1,vListLogo2,ePromoteBanner,vPromoteBannerImage,tPromoteBannerTitle,eVideoConsultEnable,eFor,vIconDetails,eForMedicalService,iParentId,tMedicalServiceInfo FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND eCatType!='Donation' AND iParentId IN ($parentId) " . $ssql . " ORDER BY iDisplayOrder,iVehicleCategoryId ASC";
        }
        $Data = $obj->MySQLSelect($sql2);
        $categoryArr = $Datacategory = array();
        $eShowTerms = "No";
        $eProofUpload = "No";
        $tProofNote = "";
        $deliverAll_serviceArr = array();
        if (strtoupper(DELIVERALL) == "YES") {
            $scsql = "select iServiceId,eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $lang . "')) as tProofNote from service_categories";
            $scsqlData = $obj->MySQLSelect($scsql);
            foreach ($scsqlData as $scValue) {
                if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                    $eShowTerms = $scValue['eShowTerms'];
                }
                if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                    $eProofUpload = $scValue['eProofUpload'];
                    if (is_null($scValue['tProofNote']) || $scValue['tProofNote'] == "null") {
                        $scValue['tProofNote'] = "";
                    }
                    $tProofNote = $scValue['tProofNote'];
                }
                $deliverAll_serviceArr[$scValue['iServiceId']]['eShowTerms'] = $eShowTerms;
                $deliverAll_serviceArr[$scValue['iServiceId']]['eProofUpload'] = $eProofUpload;
                $deliverAll_serviceArr[$scValue['iServiceId']]['tProofNote'] = (!empty($tProofNote) && $tProofNote != NULL) ? $tProofNote : "";
            }
        }
        //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query Start
        $vehicleCatArr = $vehicleTypeArr = array();
        $vehicleTypeData = $obj->MySQLSelect("SELECT iVehicleTypeId,iVehicleCategoryId FROM vehicle_type WHERE eStatus='Active'");
        for ($g = 0; $g < count($vehicleTypeData); $g++) {
            $vehicleTypeArr[$vehicleTypeData[$g]['iVehicleCategoryId']][] = $vehicleTypeData[$g];
        }
        //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
        if ($parentId == 0) {
            $medicalServiceArr = array();
            if (count($Data) > 0) {
                $k = 0;
                //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query Start
                $Data2 = $obj->MySQLSelect("SELECT vc1.iParentId,vc1.iVehicleCategoryId, vc1.vLogo, vc1.eShowType,vc1.vBannerImage, vc1.vCategory_" . $lang . " as vCategory, vc1.eCatType, vc1.eSubCatType, vc1.tBannerButtonText, vc1.iServiceId, vc1.eDeliveryType,vc1.vListLogo,vc1.eCatViewType,vc1.tListDescription,vc1.vListLogo1,vc1.vListLogo2,vc1.ePromoteBanner,vc1.vPromoteBannerImage,vc1.tPromoteBannerTitle,vc1.eVideoConsultEnable,vc1.eFor,vc1.vIconDetails,vc1.eForMedicalService,vc1.tMedicalServiceInfo,vc2.vCategory_" . $lang . " as vParentCategoryName FROM " . $sql_vehicle_category_table_name . " as vc1  LEFT JOIN " . $sql_vehicle_category_table_name . " as vc2 ON vc2.iVehicleCategoryId = vc1.iParentId WHERE vc1.eStatus='Active' ORDER BY vc1.iDisplayOrder ASC");
                for ($h = 0; $h < count($Data2); $h++) {
                    $vehicleCatArr[$Data2[$h]['iParentId']][] = $Data2[$h];
                }
                //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
                for ($i = 0; $i < count($Data); $i++) {
                    $BannerButtonText = "tBannerButtonText_" . $lang;
                    $tBannerButtonTextArr = json_decode($Data[$i]['tBannerButtonText'], true);
                    $tBannerButtonText = $tBannerButtonTextArr[$BannerButtonText];
                    $listDescText = "tListDescription_" . $lang;
                    $tListDescriptionArr = json_decode($Data[$i]['tListDescription'], true);
                    $tListDescriptionText = $tListDescriptionArr[$listDescText];
                    $PromoteBannerTitle = "tPromoteBannerTitle_" . $lang;
                    $tPromoteBannerTitleArr = json_decode($Data[$i]['tPromoteBannerTitle'], true);
                    $tPromoteBannerTitle = $tPromoteBannerTitleArr[$PromoteBannerTitle];
                    $Data[$i]['vBgColor'] = $Data[$i]['vBorderColor'] = "";
                    if (!empty($Data[$i]['vIconDetails'])) {
                        $vIconDetails = json_decode($Data[$i]['vIconDetails'], true);
                        $Data[$i]['vBgColor'] = $vIconDetails['vBgColor'];
                        $Data[$i]['vBorderColor'] = $vIconDetails['vBorderColor'];
                    }
                    if ($tListDescriptionText == null) {
                        $tListDescriptionText = "";
                    }
                    if ($tPromoteBannerTitle == null) {
                        $tPromoteBannerTitle = "";
                    }
                    if ($Data[$i]['eCatType'] == "ServiceProvider" || $Data[$i]['eCatType'] == "MoreDelivery") {
                        //$sql3 = "SELECT iVehicleCategoryId, vLogo, eShowType,vBannerImage, vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText, iServiceId, eDeliveryType FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND iParentId='" . $Data[$i]['iVehicleCategoryId'] . "' ORDER BY iDisplayOrder ASC";
                        //$Data2 = $obj->MySQLSelect($sql3);
                        //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query Start
                        $Data2 = array();
                        if (isset($vehicleCatArr[$Data[$i]['iVehicleCategoryId']])) {
                            $Data2 = $vehicleCatArr[$Data[$i]['iVehicleCategoryId']];
                        }
                        if ($MODULES_OBJ->isEnableMedicalServices() && $Data[$i]['iVehicleCategoryId'] == "3") {
                            $medicalServiceArr = $Data2;
                        }
                        //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
                        if (count($Data2) > 0) {
                            for ($j = 0; $j < count($Data2); $j++) {
                                if ($Data2[$j]['eCatType'] == "ServiceProvider") {
                                    //$sql4 = "SELECT iVehicleTypeId FROM vehicle_type WHERE eStatus='Active' AND iVehicleCategoryId='" . $Data2[$j]['iVehicleCategoryId'] . "'";
                                    //$Data3 = $obj->MySQLSelect($sql4);
                                    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query Start
                                    $Data3 = array();
                                    if (isset($vehicleTypeArr[$Data2[$j]['iVehicleCategoryId']])) {
                                        $Data3 = $vehicleTypeArr[$Data2[$j]['iVehicleCategoryId']];
                                    }
                                    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
                                    if (count($Data3) > 0 || ($Data2[$j]['eVideoConsultEnable'] == "Yes" && $MODULES_OBJ->isEnableVideoConsultingService())) {
                                        $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                                        $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                                        $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                                        $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                                        $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                                        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()) {
                                            $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo2'];
                                            $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                                        } else {
                                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo'];
                                        }
                                        $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                                        $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                                        $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                                        $Datacategory[$k]['eShowTerms'] = "No";
                                        $Datacategory[$k]['eProofUpload'] = "No";
                                        $Datacategory[$k]['tProofNote'] = "";
                                        if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0) {
                                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                                $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                                            }
                                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                                $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                                $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                                            }
                                        }
                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                                        $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;
                                        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV1()) {
                                            $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo1'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo1'] : "";
                                        }
                                        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV2()) {
                                            $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo2'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo2'] : "";
                                            $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                                            $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                                            $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                                            $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                                            $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];
                                        }
                                        $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                                        $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                                        $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                                        $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                                        $k++;
                                    }
                                } else {
                                    $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                                    $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                                    $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                                    $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                                    $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                                    $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                                    if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()) {
                                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo2'];
                                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                                    } else {
                                    $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                                    $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo'];
                                    }
                                    $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                                    $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                                    $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                                    $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                                    $Datacategory[$k]['eShowTerms'] = "No";
                                    $Datacategory[$k]['eProofUpload'] = "No";
                                    $Datacategory[$k]['tProofNote'] = "";
                                    if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0) {
                                        if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                            $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                                        }
                                        if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                            $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                            $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                                        }
                                    }
                                    $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                                    $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                                    $Datacategory[$k]['tListDescription'] = $tListDescriptionText;
                                    if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV1()) {
                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo1'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo1'] : "";
                                    }
                                    if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV2()) {
                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo2'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo2'] : "";
                                        $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                                        $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                                        $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                                        $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                                        $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];
                                    }
                                    $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                                    $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                                    $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                                    $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                                    $k++;
                                }
                            }
                        }
                    } else {
                        $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                        $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                        $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                        $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                        $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()) {
                            $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo2'];
                            $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                       } else {
                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo'];
                       }
                        $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                        $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                        $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                        $Datacategory[$k]['eShowTerms'] = "No";
                        $Datacategory[$k]['eProofUpload'] = "No";
                        $Datacategory[$k]['tProofNote'] = "";
                        if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0 && $MODULES_OBJ->isEnableTermsServiceCategories()) {
                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                            }
                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                            }
                        }
                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                        $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;
                        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV1()) {
                            $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo1'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo1'] : "";
                        }
                        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV2()) {
                            $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo2'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo2'] : "";
                            $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                            $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                            $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                            $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                            $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];
                        }
                        $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                        $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                        $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                        $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                        $k++;
                    }
                }
            }
        }
        else {
            if (count($Data) > 0) {
                $k = 0;
                for ($j = 0; $j < count($Data); $j++) {
                    $BannerButtonText = "tBannerButtonText_" . $lang;
                    $tBannerButtonTextArr = json_decode($Data[$j]['tBannerButtonText'], true);
                    $tBannerButtonText = $tBannerButtonTextArr[$BannerButtonText];
                    $listDescText = "tListDescription_" . $lang;
                    $tListDescriptionArr = json_decode($Data[$j]['tListDescription'], true);
                    $tListDescriptionText = $tListDescriptionArr[$listDescText];
                    if ($tListDescriptionText == null) {
                        $tListDescriptionText = "";
                    }
                    //$sql4 = "SELECT iVehicleTypeId FROM vehicle_type WHERE eStatus='Active' AND iVehicleCategoryId='" . $Data[$j]['iVehicleCategoryId'] . "' ORDER BY iDisplayOrder ASC";
                    //$Data3 = $obj->MySQLSelect($sql4);
                    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query Start
                    // exit;
                    $Data3 = array();
                    if (isset($vehicleTypeArr[$Data[$j]['iVehicleCategoryId']])) {
                        $Data3 = $vehicleTypeArr[$Data[$j]['iVehicleCategoryId']];
                    }
                    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
                    if (count($Data3) > 0) {
                        if ($eForVideoConsultation != "Yes") {
                            $Datacategory[$k]['eCatType'] = $Data[$j]['eCatType'];
                            $Datacategory[$k]['eSubCatType'] = $Data[$j]['eSubCatType'];
                            $Datacategory[$k]['eDeliveryType'] = $Data[$j]['eDeliveryType'];
                            $Datacategory[$k]['iVehicleCategoryId'] = $Data[$j]['iVehicleCategoryId'];
                            $Datacategory[$k]['vCategory'] = $Data[$j]['vCategory'];
                            $Datacategory[$k]['vCategoryBanner'] = $Data[$j]['vCategory'];
                            if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()) {
                                $Datacategory[$k]['vLogo'] = $Data[$j]['vLogo2'];
                                $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/android/' . $Data[$j]['vLogo2'];
                            } else {
                            $Datacategory[$k]['vLogo'] = $Data[$j]['vLogo'];
                            $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/android/' . $Data[$j]['vLogo'];
                            }
                            $Datacategory[$k]['eShowType'] = "";
                            $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                            $Datacategory[$k]['vBannerImage'] = "";
                            $Datacategory[$k]['vListLogo'] = ($Data[$j]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/' . $Data[$j]['vListLogo'] : "";
                            $Datacategory[$k]['eCatViewType'] = $Data[$j]['eCatViewType'];
                            $Datacategory[$k]['tListDescription'] = $tListDescriptionText;
                            if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV1()) {
                                $Datacategory[$k]['vListLogo'] = ($Data[$j]['vListLogo1'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/' . $Data[$j]['vListLogo1'] : "";
                            }
                            $Datacategory[$k]['eVideoConsultEnable'] = "No";
                            if ($MODULES_OBJ->isEnableVideoConsultingService()) {
                                $Datacategory[$k]['eVideoConsultEnable'] = $Data[$j]['eVideoConsultEnable'];
                            }
                            $Datacategory[$k]['eFor'] = $Data[$j]['eFor'];
                            $Datacategory[$k]['iParentId'] = $Data[$j]['iParentId'];
                            $k++;
                        }
                    }
                    if ($Data[$j]['eVideoConsultEnable'] == "Yes" && $eForVideoConsultation == "Yes") {
                        $Datacategory[$k]['eCatType'] = $Data[$j]['eCatType'];
                        $Datacategory[$k]['eSubCatType'] = $Data[$j]['eSubCatType'];
                        $Datacategory[$k]['eDeliveryType'] = $Data[$j]['eDeliveryType'];
                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$j]['iVehicleCategoryId'];
                        $Datacategory[$k]['vCategory'] = $Data[$j]['vCategory'];
                        $Datacategory[$k]['vCategoryBanner'] = $Data[$j]['vCategory'];
                        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()) {
                            $Datacategory[$k]['vLogo'] = $Data[$j]['vLogo2'];
                            $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/android/' . $Data[$j]['vLogo2'];
                        } else {
                        $Datacategory[$k]['vLogo'] = $Data[$j]['vLogo'];
                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/android/' . $Data[$j]['vLogo'];
                        }
                        $Datacategory[$k]['eShowType'] = "";
                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                        $Datacategory[$k]['vBannerImage'] = "";
                        $Datacategory[$k]['vListLogo'] = ($Data[$j]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/' . $Data[$j]['vListLogo'] : "";
                        $Datacategory[$k]['eCatViewType'] = $Data[$j]['eCatViewType'];
                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;
                        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV1()) {
                            $Datacategory[$k]['vListLogo'] = ($Data[$j]['vListLogo1'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$j]['iVehicleCategoryId'] . '/' . $Data[$j]['vListLogo1'] : "";
                        }
                        $Datacategory[$k]['eVideoConsultEnable'] = "No";
                        if ($MODULES_OBJ->isEnableVideoConsultingService()) {
                            $Datacategory[$k]['eVideoConsultEnable'] = $Data[$j]['eVideoConsultEnable'];
                        }
                        $Datacategory[$k]['eFor'] = $Data[$j]['eFor'];
                        $Datacategory[$k]['iParentId'] = $Data[$j]['iParentId'];
                        $k++;
                    }
                }
            }
        }
        $Datacategory1 = array_unique($Datacategory, SORT_REGULAR);
        $DatanewArr = array();
        foreach ($Datacategory1 as $inner) {
            if ($inner['eCatType'] == "Genie") {
                $inner['eCatType'] = "Anywhere";
            }
            array_push($DatanewArr, $inner);
        }
        $returnArr['Action'] = "1";
        if ($vehicle_category_main != '') {
            $returnArr['vParentCategoryName'] = $vehicle_category_main;
        } else {
            $returnArr['vParentCategoryName'] = '';
        }
        //$returnArr['message'] = array_reverse($DatanewArr);
        // echo "<pre>"; print_r($DatanewArr); exit;
        $DatanewArrTmp = array();
        for ($i = 0; $i < count($DatanewArr); $i++) {
            $vLogo_image_tmp = $DatanewArr[$i]['vLogo_image'];
            $vBannerImage_tmp = $DatanewArr[$i]['vBannerImage'];
            $vLogo_image_tmp_orig_name_arr = explode("/", $DatanewArr[$i]['vLogo_image']);
            $vBannerImage_tmp_orig_name_arr = explode("/", $DatanewArr[$i]['vBannerImage']);
            $isFileExist = false;
            if (!empty($vBannerImage_tmp_orig_name_arr) && count($vBannerImage_tmp_orig_name_arr) > 0) {
                $vBannerImage_tmp_orig_name = $vBannerImage_tmp_orig_name_arr[count($vBannerImage_tmp_orig_name_arr) - 1];
                $isFileExist = file_exists($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $DatanewArr[$i]['iVehicleCategoryId'] . '/' . $vBannerImage_tmp_orig_name);
            }
            $isFileExist_1 = false;
            if (!empty($vLogo_image_tmp_orig_name_arr) && count($vLogo_image_tmp_orig_name_arr) > 0) {
                $vLogo_image_tmp_orig_name = $vLogo_image_tmp_orig_name_arr[count($vLogo_image_tmp_orig_name_arr) - 1];
                $isFileExist_1 = file_exists($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $DatanewArr[$i]['iVehicleCategoryId'] . '/android/' . $vLogo_image_tmp_orig_name);
            }
            if (empty($vBannerImage_tmp) || !$isFileExist) {
                $DatanewArr[$i]['vBannerImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/15529086332815.png";
            }
            if (empty($vLogo_image_tmp) || !$isFileExist_1) {
                $DatanewArr[$i]['vLogo_image'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/service_categories.png";
            }
            if ($MODULES_OBJ->isEnableMedicalServices() && isset($DatanewArr[$i]['eForMedicalService']) && $DatanewArr[$i]['eForMedicalService'] == "Yes") {
                $medicalServiceArr[] = $DatanewArr[$i];
            }
            if ($parentIdCount > 1) {
                $DatanewArrTmp[$DatanewArr[$i]['iParentId']][] = $DatanewArr[$i];
            }
        }
        if ($parentIdCount > 1) {
            $a = 0;
            $DatanewArr = array();
            foreach ($DatanewArrTmp as $dKey => $DataTmp) {
                $DatanewArr[$a]['iVehicleCategoryId'] = $dKey;
                $DatanewArr[$a]['vParentCategoryName'] = get_value($sql_vehicle_category_table_name, 'vCategory_' . $lang, 'iVehicleCategoryId', $dKey, '', 'true');
                $DatanewArr[$a]['message'] = $DataTmp;
                $a++;
            }
            unset($returnArr['vParentCategoryName']);
        }
        // echo "<pre>"; print_r($DatanewArr); exit;
        if ($MODULES_OBJ->isEnableBiddingServices()) {
            if ($eCatType == "Bidding") {
                $DatanewArr = $BIDDING_OBJ->getBiddingSubCategory('webservice', $parentId, '', '', '', $lang);
                if ($parentIdCount == 1) {
                    $getbidding = $BIDDING_OBJ->getbidding('webservice', $parentId, $lang);
                    if ($getbidding['vCategory']) {
                        $returnArr['vParentCategoryName'] = $getbidding['vCategory'];
                    } else {
                        $returnArr['vParentCategoryName'] = '';
                    }
                } else {
                    $DatanewArrTmp = array();
                    for ($i = 0; $i < count($DatanewArr); $i++) {
                        $DatanewArrTmp[$DatanewArr[$i]['iParentId']][] = $DatanewArr[$i];
                    }
                    $a = 0;
                    $DatanewArr = array();
                    foreach ($DatanewArrTmp as $dKey => $DataTmp) {
                        $getbidding = $BIDDING_OBJ->getbidding('webservice', $dKey, $lang);
                        $DatanewArr[$a]['iVehicleCategoryId'] = $dKey;
                        $DatanewArr[$a]['vParentCategoryName'] = $getbidding['vCategory'];
                        $DatanewArr[$a]['message'] = $DataTmp;
                        $a++;
                    }
                }
            }
        }

        if ($MODULES_OBJ->isEnableRentItemService()) {
            if ($eCatType == "RentItem" && $parentId > 0) {
                $DatanewArr = $RENTITEM_OBJ->getRentItemSubCategory('webservice', $parentId, '', '', '', $lang);
                $getrentitem = $RENTITEM_OBJ->getrentitem('webservice', $parentId, $lang);
                if ($getrentitem['vCategory']) {
                    $returnArr['vParentCategoryName'] = $getrentitem['vCategory'];
                } else {
                    $returnArr['vParentCategoryName'] = '';
                }
            }
        }

        if ($MODULES_OBJ->isEnableRentEstateService()) {
            if ($eCatType == "RentEstate" && $parentId > 0) {
                $DatanewArr = $RENTITEM_OBJ->getRentItemSubCategory('webservice', $parentId, '', '', '', $lang);
                $getrentitem = $RENTITEM_OBJ->getrentitem('webservice', $parentId, $lang);
                if ($getrentitem['vCategory']) {
                    $returnArr['vParentCategoryName'] = $getrentitem['vCategory'];
                } else {
                    $returnArr['vParentCategoryName'] = '';
                }
            }
        }

        if ($MODULES_OBJ->isEnableRentCarsService()) {
            if ($eCatType == "RentCars" && $parentId > 0) {
                $DatanewArr = $RENTITEM_OBJ->getRentItemSubCategory('webservice', $parentId, '', '', '', $lang);
                $getrentitem = $RENTITEM_OBJ->getrentitem('webservice', $parentId, $lang);
                if ($getrentitem['vCategory']) {
                    $returnArr['vParentCategoryName'] = $getrentitem['vCategory'];
                } else {
                    $returnArr['vParentCategoryName'] = '';
                }
            }
        }

        $returnArr['message'] = $DatanewArr;
        $whereloc = " AND iLocationid IN ('-1')";
        if ($MODULES_OBJ->isEnableLocationwiseBanner()) {
            $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
            $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
            $User_Address_Banner = array($vLatitude, $vLongitude);
            if (!empty($User_Address_Banner)) {
                $iLocationIdBanner = GetUserGeoLocationIdBanner($User_Address_Banner);
                $country_str_banner = "'-1'";
                if (count($iLocationIdBanner) > 0) {
                    foreach ($iLocationIdBanner as $key => $value) {
                        $country_str_banner .= ", '" . $value . "'";
                    }
                    $whereloc = " AND iLocationid IN (" . $country_str_banner . ")";
                }
            }
        }

        $banner_sql = "";
        if($parentId == 0 || $parent_ufx_catid > 0) {
            $banner_sql = " AND eType = 'General'";
        } elseif ($eCatType == "Bidding") {
            $banner_sql = " AND eType = 'Bidding' ";
        } else {
            $banner_sql = " AND eType = 'UberX' AND iVehicleCategoryId = '$parentId' ";
        }
        $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $lang . "' AND vImage != '' AND eStatus = 'Active' AND (iServiceId = '0' OR iServiceId = '') AND eBuyAnyService NOT IN ('Genie', 'Runner') $banner_sql $whereloc ORDER BY iDisplayOrder ASC");





        $dataOfBanners = array();
        $count = 0;
        for ($i = 0; $i < count($Data_banners); $i++) {
            if (isset($Data_banners[$i]['vImage']) && $Data_banners[$i]['vImage'] != "") {
                $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $dataOfBanners[$count]['vStatusBarColor'] = $Data_banners[$i]['vStatusBarColor'];
                $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                // if (file_exists($banner_img_path) && empty($Data_banners[$i]['vStatusBarColor'])) {
                //     $dataOfBanners[$count]['vStatusBarColor'] = getColorFromImage($banner_img_path);
                //     $obj->sql_query("UPDATE banners SET vStatusBarColor = '" . $dataOfBanners[$count]['vStatusBarColor'] . "' WHERE iUniqueId = '" . $Data_banners[$i]['iUniqueId'] . "'");
                // }
                $count++;
            }
        }
        $returnArr['BANNER_DATA'] = $dataOfBanners;
        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV1() && !$MODULES_OBJ->isEnableAppHomeScreenLayoutV2() && $parentId == 0) {
            $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $lang . "')) as vCategoryName FROM $master_service_category_tbl WHERE eStatus = 'Active'");
            $returnArr['MASTER_SERVICE_CATEGORIES'] = array();
            foreach ($master_service_categories as $mServiceCategory) {
                $mServiceCategoryArr = array();
                $mServiceCategoryArr['vCategoryName'] = $mServiceCategory['vCategoryName'];
                $mServiceCategoryArr['eType'] = $mServiceCategory['eType'];
                $mServiceCategoryArr['iDisplayOrder'] = $mServiceCategory['iDisplayOrder'];
                $mServiceCategoryArr['vIconImage'] = $mServiceCategoryArr['vBgImage'] = "";
                if (!empty($mServiceCategory['vIconImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $mServiceCategory['vIconImage'])) {
                    $mServiceCategoryArr['vIconImage'] = $tconfig["tsite_upload_app_home_screen_images"] . $mServiceCategory['vIconImage'];
                }
                if (!empty($mServiceCategory['vBgImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $mServiceCategory['vBgImage'])) {
                    $mServiceCategoryArr['vBgImage'] = $tconfig["tsite_upload_app_home_screen_images"] . $mServiceCategory['vBgImage'];
                }
                $mServiceCategoryArr['vTextColor'] = $mServiceCategory['vTextColor'];
                $mServiceCategoryArr['vBgColor'] = $mServiceCategory['vBgColor'];
                $mServiceCategoryArr['SubCategories'] = array();
                foreach ($DatanewArr as $skey => $SubCategories) {
                    $DatanewArr[$skey]['eShowType'] = "Icon";
                    if ($mServiceCategory['eType'] == "Ride" && (in_array($SubCategories['eCatType'], ['Ride', 'MotoRide', 'Rental', 'MotoRental']) || ($MODULES_OBJ->isAirFlightModuleAvailable() && $SubCategories['eCatType'] == 'Fly'))) {
                        $DatanewArr[$skey]['eCatViewType'] = "List";
                        $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                    } elseif ($mServiceCategory['eType'] == "Deliver") {
                        if (($MODULES_OBJ->isDeliveryFeatureAvailable() && in_array($SubCategories['eCatType'], ['Delivery', 'MotoDelivery', 'MultipleDelivery', 'MoreDelivery'])) || ($MODULES_OBJ->isDeliverAllFeatureAvailable() && in_array($SubCategories['eCatType'], ['DeliverAll'])) || ($MODULES_OBJ->isEnableAnywhereDeliveryFeature() && in_array($SubCategories['eCatType'], ['Genie', 'Runner', 'Anywhere']))) {
                            $DatanewArr[$skey]['eCatViewType'] = "List";
                            $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                        }
                    } elseif ($mServiceCategory['eType'] == "UberX" && in_array($SubCategories['eCatType'], ['ServiceProvider'])) {
                        $DatanewArr[$skey]['eCatViewType'] = "Icon";
                        $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                    }
                }
                if (($mServiceCategory['eType'] == "Ride" && $MODULES_OBJ->isRideFeatureAvailable()) || ($mServiceCategory['eType'] == "Deliver" && ($MODULES_OBJ->isDeliveryFeatureAvailable() || $MODULES_OBJ->isDeliverAllFeatureAvailable())) || ($mServiceCategory['eType'] == "UberX" && $MODULES_OBJ->isUberXFeatureAvailable())) {
                    $returnArr['MASTER_SERVICE_CATEGORIES'][] = $mServiceCategoryArr;
                }
            }
            foreach ($returnArr['MASTER_SERVICE_CATEGORIES'] as $key => $value) {
                $sort_data[$key] = $value['iDisplayOrder'];
            }
            array_multisort($sort_data, SORT_ASC, $returnArr['MASTER_SERVICE_CATEGORIES']);
        }
        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV2() && $parentId == 0) {
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", $iServiceId);
            if (strtoupper($APP_TYPE) == "UBERX") {
                $returnArr['message'] = "";
                $languageLabelsArrUberX = $languageLabelsArr;
                $MASTER_SERVICE_CATEGORIES = getServiceCategoriesUberX($DatanewArr, $lang);
            } elseif ($THEME_OBJ->isCubeXv2ThemeActive() == "Yes" || $THEME_OBJ->isPXCProThemeActive() == "Yes") {
                $returnArr['message'] = "";
                $languageLabelsArrCubeX = $languageLabelsArr;
                $MASTER_SERVICE_CATEGORIES = getServiceCategoriesCubeX($DatanewArr, $lang);
            } elseif ($THEME_OBJ->isDeliveryKingXv2ThemeActive() == "Yes") {
                $returnArr['message'] = "";
                $languageLabelsArrDeliveryKingX = $languageLabelsArr;
                $MASTER_SERVICE_CATEGORIES = getServiceCategoriesDeliveryKingX($DatanewArr, $lang);
            } else {
                $returnArr['message'] = "";
                $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $lang . "')) as vCategoryName FROM $master_service_category_tbl WHERE eStatus = 'Active'");
                if ($userEmailC == "Yes") {
                    $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $lang . "')) as vCategoryName FROM $master_service_category_tbl WHERE eStatus = 'Active' AND eType = 'MedicalServices'");
                }
                $MASTER_SERVICE_CATEGORIES = array();
                $MASTER_SERVICE_CATEGORIES[] = array('vTitle' => $languageLabelsArr['LBL_BOOK_SERVICE_TITLE'], 'eShowType' => 'Header');
                $PromotionalBannerArr = $GenieDataArr = $RunnerDataArr = array();
                
                foreach ($master_service_categories as $mServiceCategory) {
                    $mServiceCategoryArr = array();
                    $mServiceCategoryArr['vCategoryName'] = $mServiceCategory['vCategoryName'];
                    if ($mServiceCategory['eType'] == "Ride") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_TAXI_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "Deliver") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_DELIVERY_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "UberX") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICES_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "VideoConsult") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_VIDEO_CONSULT_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "Bidding") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICE_BID_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "RentItem") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICE_RENT_ITEM_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "RentEstate") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICE_RENT_ESTATE_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "RentCars") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICE_RENT_CARS_CATEGORY_TITLE'];
                    } elseif ($mServiceCategory['eType'] == "MedicalServices") {
                        $mServiceCategoryArr['vCategoryTitle'] = $languageLabelsArr['LBL_MEDICAL_SERVICE_CATEGORY_TITLE'];
                    }
                    $mServiceCategoryArr['eType'] = $mServiceCategory['eType'];
                    $mServiceCategoryArr['iDisplayOrder'] = $mServiceCategory['iDisplayOrder'];
                    $mServiceCategoryArr['ListMaxCount'] = $mServiceCategory['iListMaxCount'];
                    $mServiceCategoryArr['eShowType'] = 'List';
                    $mServiceCategoryArr['vIconImage'] = $mServiceCategoryArr['vBgImage'] = "";
                    if (!empty($mServiceCategory['vIconImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $mServiceCategory['vIconImage'])) {
                        $mServiceCategoryArr['vIconImage'] = $tconfig["tsite_upload_app_home_screen_images"] . $mServiceCategory['vIconImage1'];
                    }
                    $mServiceCategoryArr['vTextColor'] = $mServiceCategory['vTextColor'];
                    $mServiceCategoryArr['vBgColor'] = $mServiceCategory['vBgColor'];
                    if ($mServiceCategory['eType'] == "VideoConsult" && $MODULES_OBJ->isEnableVideoConsultingService()) {
                        $mServiceCategoryArr['VideoConsultSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "Bidding" && $MODULES_OBJ->isEnableBiddingServices()) {
                        $mServiceCategoryArr['biddingSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "RentItem" && $MODULES_OBJ->isEnableRentItemService()) {
                        $mServiceCategoryArr['rentitemSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "RentEstate" && $MODULES_OBJ->isEnableRentEstateService()) {
                        $mServiceCategoryArr['rentestateSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "RentCars" && $MODULES_OBJ->isEnableRentCarsService()) {
                        $mServiceCategoryArr['rentcarSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "MedicalServices" && $MODULES_OBJ->isEnableMedicalServices()) {
                        $mServiceCategoryArr['MedicalServiceSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "TrackService" && $MODULES_OBJ->isEnableTrackServiceFeature()) {
                        $mServiceCategoryArr['TrackServiceSection'] = 'Yes';
                    } elseif ($mServiceCategory['eType'] == "RideShare" && $MODULES_OBJ->isEnableRideShareService()) {
                        $mServiceCategoryArr['RideShareSection'] = 'Yes';
                    }
                    $mServiceCategoryArr['SubCategories'] = array();
                    $vCount = 0;
                    foreach ($DatanewArr as $skey => $SubCategories) {
                        $DatanewArr[$skey]['eShowType'] = "Icon";
                        $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                        if ($MODULES_OBJ->isEnableVideoConsultingService()) {
                            $DatanewArr[$skey]['isVideoConsultEnable'] = $VIDEO_CONSULT_OBJ->checkVideoConsultEnable($SubCategories['iVehicleCategoryId']);
                        }
                        if ($mServiceCategory['eType'] == "Ride" && $SubCategories['eForMedicalService'] == "No" && (in_array($SubCategories['eCatType'], ['Ride', 'MotoRide', 'Rental', 'MotoRental', 'RidePool']) || ($MODULES_OBJ->isAirFlightModuleAvailable() && $SubCategories['eCatType'] == 'Fly'))) {
                            $DatanewArr[$skey]['eCatViewType'] = "List";
                            $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                        } elseif ($mServiceCategory['eType'] == "Deliver") {
                            if (($MODULES_OBJ->isDeliveryFeatureAvailable() && in_array($SubCategories['eCatType'], ['Delivery', 'MotoDelivery', 'MultipleDelivery', 'MoreDelivery'])) || ($MODULES_OBJ->isDeliverAllFeatureAvailable() && in_array($SubCategories['eCatType'], ['DeliverAll'])) || ($MODULES_OBJ->isEnableAnywhereDeliveryFeature() && in_array($SubCategories['eCatType'], ['Genie', 'Runner', 'Anywhere']))) {
                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                if ($SubCategories['iVehicleCategoryId'] != '185') {
                                    $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                                }
                            }
                        } elseif ($mServiceCategory['eType'] == "UberX" && in_array($SubCategories['eCatType'], ['ServiceProvider'])) {
                            $DataSubCat = array();
                            if (isset($vehicleCatArr[$SubCategories['iVehicleCategoryId']])) {
                                $DataSubCat = $vehicleCatArr[$SubCategories['iVehicleCategoryId']];
                            }
                            if (count($DataSubCat) > 0) {
                                for ($sCat = 0; $sCat < count($DataSubCat); $sCat++) {
                                    $DataSubCat1 = array();
                                    if (isset($vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']])) {
                                        $DataSubCat1 = $vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']];
                                    }
                                    if (count($DataSubCat1) > 0) {
                                        $DatanewArr[$skey]['eCatViewType'] = "List";
                                        $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                                        break;
                                    }
                                }
                            }
                        } elseif ($mServiceCategory['eType'] == "VideoConsult" && $MODULES_OBJ->isEnableVideoConsultingService()) {
                            if ($DatanewArr[$skey]['isVideoConsultEnable'] == "Yes") {
                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                $mServiceCategoryArr['SubCategories'][] = $DatanewArr[$skey];
                            }
                        }

                        if ($SubCategories['ePromoteBanner'] == "Yes") {
                            $promotional_banner_data = $obj->MySQLSelect("SELECT vImage FROM banners WHERE vCode = '$lang' AND iVehicleCategoryId = '" . $SubCategories['iVehicleCategoryId'] . "' AND eType = 'Promotion'");
                            if (!empty($promotional_banner_data) && count($promotional_banner_data) > 0) {
                                $PromotionalBannerArr = array('vCategoryName' => !empty($SubCategories['tPromoteBannerTitle']) ? $SubCategories['tPromoteBannerTitle'] : "", 'vCategory' => !empty($SubCategories['tPromoteBannerTitle']) ? $SubCategories['tPromoteBannerTitle'] : "", 'vBannerImage' => $tconfig['tsite_upload_images'] . $promotional_banner_data[0]['vImage'], 'eShowType' => 'Banner', 'eCatType' => $SubCategories['eCatType'], 'vBannerBgColor' => '#00A9B8', 'ePromoteBanner' => 'Yes', 'iVehicleCategoryId' => $SubCategories['iVehicleCategoryId'], 'eFor' => $SubCategories['eFor']);
                                if ($SubCategories['eCatType'] == "DeliverAll") {
                                    $PromotionalBannerArr['iServiceId'] = $SubCategories['iServiceId'];
                                }
                                $imagedata = getimagesize($tconfig['tsite_upload_images_panel'] . $promotional_banner_data[0]['vImage']);
                                $PromotionalBannerArr['vImageWidth'] = strval($imagedata[0]);
                                $PromotionalBannerArr['vImageHeight'] = strval($imagedata[1]);
                            }
                        }
                        if (in_array($SubCategories['eCatType'], ['Genie', 'Anywhere'])) {
                            $GenieDataArr = $SubCategories;
                        }
                        if (in_array($SubCategories['eCatType'], ['Runner'])) {
                            $RunnerDataArr = $SubCategories;
                        }
                    }
                    if ($mServiceCategory['eType'] == "Bidding" && $MODULES_OBJ->isEnableBiddingServices()) {
                        $mServiceCategoryArr['SubCategories'] = $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang);
                    }
                    if ($mServiceCategory['eType'] == "MedicalServices" && $MODULES_OBJ->isEnableMedicalServices()) {
                        $languageLabelsArrMS = $languageLabelsArr;
                        $mServiceCategoryArr['SubCategories'] = getServiceCategoriesMedicalServices($DatanewArr, $lang, 'SubCategories');
                        $mServiceCategoryArr['MoreSubCategories'] = getServiceCategoriesMedicalServices($medicalServiceArr, $lang, 'MoreSubCategories');
                        $mServiceCategoryArr['ListMaxCount'] = count($mServiceCategoryArr['SubCategories']) - 1;
                    }
                    if ($mServiceCategory['eType'] == "TrackService" && $MODULES_OBJ->isEnableTrackServiceFeature()) {
                        $languageLabelsArrTrackService = $languageLabelsArr;
                        $mServiceCategoryArr['SubCategories'] = $TRACK_SERVICE_OBJ->getCategories();
                        $mServiceCategoryArr['ListMaxCount'] = count($mServiceCategoryArr['SubCategories']);
                    }
                    if ($mServiceCategory['eType'] == "RideShare" && $MODULES_OBJ->isEnableRideShareService()) {
                        $languageLabelsArrRideShare = $languageLabelsArr;
                        $mServiceCategoryArr['SubCategories'] = $RIDE_SHARE_OBJ->getCategories();
                        $mServiceCategoryArr['ListMaxCount'] = count($mServiceCategoryArr['SubCategories']);
                    }

                    if ($mServiceCategory['eType'] == "RentItem" && $MODULES_OBJ->isEnableRentItemService()) {
                        $iMServiceCatIdForItem = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', "RentItem", '', 'true');
                        $msql = " AND iMasterServiceCategoryId = " . $iMServiceCatIdForItem;
                        $mServiceCategoryArr['SubCategories'] = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                    }

                    if ($mServiceCategory['eType'] == "RentEstate" && $MODULES_OBJ->isEnableRentEstateService()) {
                        $iMServiceCatIdForEstate = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', "RentEstate", '', 'true');
                        $msql = " AND iMasterServiceCategoryId = " . $iMServiceCatIdForEstate;
                        $mServiceCategoryArr['SubCategories'] = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                    }

                    if ($mServiceCategory['eType'] == "RentCars" && $MODULES_OBJ->isEnableRentCarsService()) {
                        $iMServiceCatIdForCar = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', "RentCars", '', 'true');
                        $msql = " AND iMasterServiceCategoryId = " . $iMServiceCatIdForCar;
                        $mServiceCategoryArr['SubCategories'] = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                    }

                    if ($mServiceCategory['eType'] == "NearBy" && $MODULES_OBJ->isEnableNearByService()) {
                        $mServiceCategoryArr['SubCategories'] = $NEARBY_OBJ->getNearByCategory('webservice', '', '', '', $lang);
                    }

                    if (($mServiceCategory['eType'] == "Ride" && $MODULES_OBJ->isRideFeatureAvailable()) ||
                        ($mServiceCategory['eType'] == "Deliver" && ($MODULES_OBJ->isDeliveryFeatureAvailable() || $MODULES_OBJ->isDeliverAllFeatureAvailable())) ||
                        ($mServiceCategory['eType'] == "UberX" && $MODULES_OBJ->isUberXFeatureAvailable()) ||
                        ($mServiceCategory['eType'] == "VideoConsult" && $MODULES_OBJ->isEnableVideoConsultingService() && !$CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) ||
                        ($mServiceCategory['eType'] == "Bidding" && $MODULES_OBJ->isEnableBiddingServices()) ||
                        ($mServiceCategory['eType'] == "MedicalServices" && $MODULES_OBJ->isEnableMedicalServices()) ||
                        ($mServiceCategory['eType'] == "TrackService" && $MODULES_OBJ->isEnableTrackServiceFeature()) ||
                        ($mServiceCategory['eType'] == "RideShare" && $MODULES_OBJ->isEnableRideShareService()) ||
                        ($mServiceCategory['eType'] == "RentItem" && $MODULES_OBJ->isEnableRentItemService()) ||
                        ($mServiceCategory['eType'] == "RentCars" && $MODULES_OBJ->isEnableRentEstateService()) ||
                        ($mServiceCategory['eType'] == "RentEstate" && $MODULES_OBJ->isEnableRentCarsService()) ||
                        ($mServiceCategory['eType'] == "NearBy" && $MODULES_OBJ->isEnableNearByService())
                    ) {
                        if (count($mServiceCategoryArr['SubCategories']) > 0) {
                            $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                        }
                    }
                }
                foreach ($MASTER_SERVICE_CATEGORIES as $key => $value) {
                    $sort_data[$key] = $value['iDisplayOrder'];
                }
                array_multisort($sort_data, SORT_ASC, $MASTER_SERVICE_CATEGORIES);
                if ($userEmailC == "No") {
                    if (!empty($PromotionalBannerArr) && count($PromotionalBannerArr) > 0) {
                        $MASTER_SERVICE_CATEGORIES[] = $PromotionalBannerArr;
                    }
                    $app_banner_runner = $obj->MySQLSelect("SELECT vImage FROM banners WHERE vCode = '$lang' AND eBuyAnyService = 'Runner' AND eType = 'AppHomeScreen'");
                    if (!empty($app_banner_runner[0]['vImage']) && $MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
                        $MASTER_SERVICE_CATEGORIES[] = array('vTitle' => $languageLabelsArr['LBL_GENIE_SECTION_TITLE_APP'], 'eShowType' => 'Header',// 'vBgColor'      => '#EAFEFF'
                        );
                        $RunnerDataArr['vImageWidth'] = "";
                        $RunnerDataArr['vImageHeight'] = "";
                        $RunnerDataArr['vAppHomeScreenBanner'] = "";
                        if (!empty($app_banner_runner[0]['vImage'])) {
                            $imagedata = getimagesize($tconfig['tsite_upload_images_panel'] . $app_banner_runner[0]['vImage']);
                            $RunnerDataArr['vImageWidth'] = strval($imagedata[0]);
                            $RunnerDataArr['vImageHeight'] = strval($imagedata[1]);
                            $RunnerDataArr['vAppHomeScreenBanner'] = $tconfig['tsite_upload_images'] . $app_banner_runner[0]['vImage'];
                        }
                        $MASTER_SERVICE_CATEGORIES[] = array('vCategoryName' => $RunnerDataArr['vCategory'], 'vCategory' => $RunnerDataArr['vCategory'], 'vBannerImage' => !empty($RunnerDataArr['vAppHomeScreenBanner']) ? $RunnerDataArr['vAppHomeScreenBanner'] : "", 'vImageWidth' => $RunnerDataArr['vImageWidth'], 'vImageHeight' => $RunnerDataArr['vImageHeight'], 'eShowType' => 'Banner', 'eCatType' => $RunnerDataArr['eCatType'], 'ePromoteBanner' => 'No', 'vBgColor' => '#EAFEFF');
                    }
                    if (!empty($RunnerDataArr) && count($RunnerDataArr) > 0 && $MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
                        $geniePackageTypes = $obj->MySQLSelect("SELECT JSON_UNQUOTE(JSON_VALUE(tTitle, '$.tTitle_" . $lang . "')) as tTitle, vImage FROM genie_package_types WHERE eFor = 'Runner' AND eStatus = 'Active'");
                        $GeniePackageTypes = array();
                        foreach ($geniePackageTypes as $package_type) {
                            $GeniePackageTypes[] = array('vCategory' => $package_type['tTitle'], 'vLogo_image' => $tconfig["tsite_upload_genie_package_type_images"] . $package_type['vImage'], 'eCatViewType' => 'Icon', 'eCatType' => $RunnerDataArr['eCatType'], 'eSelectStore' => 'Yes');
                        }
                        $MASTER_SERVICE_CATEGORIES[] = array('vCategoryName' => '', 'vCategory' => $RunnerDataArr['vCategory'], 'eShowType' => 'Icon', 'vBgColor' => '#EAFEFF', 'SubCategories' => $GeniePackageTypes);
                    }
                    if (!empty($GenieDataArr) && count($GenieDataArr) > 0 && $MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
                        $MASTER_SERVICE_CATEGORIES[] = array('vCategoryName' => $languageLabelsArr['LBL_GENIE_SECTION_BTN_TXT_APP'], 'vCategory' => $GenieDataArr['vCategory'], 'eShowType' => 'Button', 'eCatType' => $GenieDataArr['eCatType'], 'vBgColor' => '#EAFEFF', 'vButtonBgColor' => '#00A9B8', 'vButtonTextColor' => '#FFFFFF');
                    }
                }
            }
            $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    $returnArr['MORE_ICON'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more.png";
    setDataResponse($returnArr);
}
###########################################################
if ($type == "getServiceCategoryDetails") {
    $iVehicleCategoryId = isset($_REQUEST['iVehicleCategoryId']) ? clean($_REQUEST['iVehicleCategoryId']) : 0;
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $UserType = isset($_REQUEST['UserType']) ? clean($_REQUEST['UserType']) : 'Passenger';
    $returnArr = array();
    $returnArr['Action'] = "0";
    $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    if ($iMemberId != "") {
        $row = $obj->MySQLSelect("SELECT vLang FROM `register_user` WHERE iUserId='" . $iMemberId . "'");
        $lang = $row[0]['vLang'];
        if ($lang == "") {
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
        }
        $sql_vehicle_category_table_name = getVehicleCategoryTblName();
        if ($THEME_OBJ->isDeliveryXThemeActive() == "Yes" || $THEME_OBJ->isDeliveryXv2ThemeActive() == "Yes") {
            //when only deliveyx then chk parent id of given id.becoz here single and multi both deactive then in app proper msg should be shown.
            $Data_inactive = $obj->MySQLSelect("SELECT eStatus FROM " . $sql_vehicle_category_table_name . " WHERE iParentId='" . $iVehicleCategoryId . "' AND eStatus = 'Active'");
            if (count($Data_inactive) == 0) {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_SERVICE_INACTIVE_MSG";
                setDataResponse($returnArr);
            }
        } else {
            $Data_inactive = $obj->MySQLSelect("SELECT eStatus FROM " . $sql_vehicle_category_table_name . " WHERE iVehicleCategoryId='" . $iVehicleCategoryId . "'");
            if ($Data_inactive[0]['eStatus'] == 'Inactive') {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_SERVICE_INACTIVE_MSG";
                setDataResponse($returnArr);
            }
        }
        $Data = $obj->MySQLSelect("SELECT iVehicleCategoryId,iParentId,eDetailPageView, iServiceId,vCategory_" . $lang . " as vCategory, tCategoryDesc_" . $lang . " as tCategoryDesc, tBannerButtonText, eCatType, eFor FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND iVehicleCategoryId='" . $iVehicleCategoryId . "'");
        //Added BY HJ On 21-12-2019 For Get Parent Category Data As Per Optimization Isseue Start
        $getCatData = $obj->MySQLSelect("SELECT iParentId,iVehicleCategoryId, vLogo, vLogo2, vListLogo2, eShowType,vBannerImage, iServiceId, vCategory_" . $lang . " as vCategory, tCategoryDesc_" . $lang . " as tCategoryDesc, eCatType, tBannerButtonText, eDeliveryType, eFor FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' ORDER BY iDisplayOrder,iVehicleCategoryId ASC");
        $catDataArr = array();
        for ($f = 0; $f < count($getCatData); $f++) {
            $catDataArr[$getCatData[$f]['iParentId']][] = $getCatData[$f];
        }
        if ($MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
            $getService = $obj->MySQLSelect("SELECT iVehicleCategoryId,eCatType FROM " . $sql_vehicle_category_table_name . " WHERE iVehicleCategoryId = $iVehicleCategoryId");
            $getService1 = $obj->MySQLSelect("SELECT iVehicleCategoryId FROM " . $sql_vehicle_category_table_name . " WHERE eCatType = 'MoreDelivery' AND eFor = 'DeliveryCategory'");
            if ($getService[0]['eCatType'] == "Genie") {
                $catDataArr[$iVehicleCategoryId] = $catDataArr[$getService1[0]['iVehicleCategoryId']];
            }
        }
        //Added BY HJ On 21-12-2019 For Get Parent Category Data As Per Optimization Isseue End
        if (count($Data) > 0) {
            //commented by SP on 28-12-2020, cuberidedeliveryx extra array shown so i have commented.
            $returnArr['iServiceId'] = $Data[0]['iServiceId'];
            $returnArr['vCategory'] = $Data[0]['vCategory'];
            $returnArr['tCategoryDesc'] = $Data[0]['tCategoryDesc'];
            $returnArr['eDetailPageView'] = $Data[0]['eDetailPageView'];
            $returnArr['eCatType'] = $Data[0]['eCatType'];
            $returnArr['eFor'] = $Data[0]['eFor'];
            $Datacategory = array();
            $Data2 = array();
            if (isset($catDataArr[$Data[0]['iVehicleCategoryId']])) {
                $Data2 = $catDataArr[$Data[0]['iVehicleCategoryId']];
            }
            if (count($Data2) > 0) {
                $allSubCategories = array();
                $allSubCategoriesCount = 0;
                $j = 0;
                for ($i = 0; $i < count($Data2); $i++) {
                    if ($MODULES_OBJ->isEnableRideDeliveryV1() && $Data2[$i]['eFor'] == "RideCategory") {
                        continue;
                    }
                    $BannerButtonText = "tBannerButtonText_" . $lang;
                    $tBannerButtonTextArr = json_decode($Data2[$i]['tBannerButtonText'], true);
                    $tBannerButtonText = $tBannerButtonTextArr[$BannerButtonText];
                    $Datasubcategory = array();
                    if ($Data[0]['eDetailPageView'] == "Icon") {
                        $Data3 = array();
                        if (isset($catDataArr[$Data2[$i]['iVehicleCategoryId']])) {
                            $Data3 = $catDataArr[$Data2[$i]['iVehicleCategoryId']];
                        }
                        if (count($Data3) > 0) {
                            $k = 0;
                            for ($l = 0; $l < count($Data3); $l++) {
                                $BannerButtonText_sub = "tBannerButtonText_" . $lang;
                                $tBannerButtonTextArr_sub = json_decode($Data3[$l]['tBannerButtonText'], true);
                                $tBannerButtonText_sub = $tBannerButtonTextArr_sub[$BannerButtonText_sub];
                                $Datasubcategory[$k]['eCatType'] = $Data3[$l]['eCatType'];
                                $Datasubcategory[$k]['iServiceId'] = $Data3[$l]['iServiceId'];
                                $Datasubcategory[$k]['vCategory'] = $Data3[$l]['vCategory'];
                                $Datasubcategory[$k]['tCategoryDesc'] = $Data3[$l]['tCategoryDesc'];
                                $Datasubcategory[$k]['eDeliveryType'] = $Data3[$l]['eDeliveryType'];
                                $Datasubcategory[$k]['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data3[$l]['iVehicleCategoryId'] . '/android/' . $Data3[$l]['vLogo2'];
                                if ($Data3[$l]['iServiceId'] > 0) {
                                    $Datasubcategory[$k]['eShowTerms'] = "No";
                                    $Datacategory[$k]['eProofUpload'] = "No";
                                    $Datacategory[$k]['tProofNote'] = "";
                                    $sql = "SELECT eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $lang . "')) as tProofNote FROM service_categories WHERE iServiceId = " . $Data3[$l]['iServiceId'];
                                    $sqlData = $obj->MySQLSelect($sql);
                                    if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                        $Datasubcategory[$k]['eShowTerms'] = $sqlData[0]['eShowTerms'];
                                    }
                                    if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                        $Datasubcategory[$k]['eProofUpload'] = $sqlData[0]['eProofUpload'];
                                        $Datasubcategory[$k]['tProofNote'] = (!empty($sqlData[0]['tProofNote']) && $sqlData[0]['tProofNote'] != NULL) ? $sqlData[0]['tProofNote'] : "";
                                    }
                                }
                                $k++;
                            }
                            $Datacategory[$j]['SubCategory'] = $Datasubcategory;
                            //added by SP this 3 put here bc when it put general then when subcategory not get at that time main cat also not shown, so it will be put in else part also on 15-10-2019
                            $Datacategory[$j]['vCategory'] = $Data2[$i]['vCategory'];
                            $Datacategory[$j]['tCategoryDesc'] = $Data2[$i]['tCategoryDesc'];
                            $Datacategory[$j]['eDeliveryType'] = $Data2[$i]['eDeliveryType'];
                        }
                    } else {
                        $Datacategory[$j]['vCategory'] = $Data2[$i]['vCategory'];
                        $Datacategory[$j]['tCategoryDesc'] = $Data2[$i]['tCategoryDesc'];
                        $Datacategory[$j]['eDeliveryType'] = $Data2[$i]['eDeliveryType'];
                        $Datacategory[$j]['eCatType'] = $Data2[$i]['eCatType'];
                        $Datacategory[$j]['iServiceId'] = $Data2[$i]['iServiceId'];
                        $Datacategory[$j]['vImage'] = ($Data2[$i]['vBannerImage'] != "" && $Data2[$i]['eShowType'] == "Banner") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data2[$i]['iVehicleCategoryId'] . '/' . $Data2[$i]['vBannerImage'] : "";
                        if ($MODULES_OBJ->isEnableAppHomeScreenLayoutV2() && $Data[0]['eCatType'] == "MoreDelivery" && $Data[0]['eFor'] == "DeliverAllCategory") {
                            $Datacategory[$j]['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data2[$i]['iVehicleCategoryId'] . '/' . $Data2[$i]['vListLogo2'];
                        }

                        $Datacategory[$j]['tBannerButtonText'] = $tBannerButtonText;
                        if ($Data2[$i]['iServiceId'] > 0) {
                            $Datacategory[$j]['eShowTerms'] = "No";
                            $Datacategory[$j]['eProofUpload'] = "No";
                            $Datacategory[$j]['tProofNote'] = "";
                            $sql = "SELECT eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $lang . "')) as tProofNote FROM service_categories WHERE iServiceId = " . $Data2[$i]['iServiceId'];
                            $sqlData = $obj->MySQLSelect($sql);
                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                $Datacategory[$j]['eShowTerms'] = $sqlData[0]['eShowTerms'];
                            }
                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                $Datasubcategory[$j]['eProofUpload'] = $sqlData[0]['eProofUpload'];
                                $Datasubcategory[$j]['tProofNote'] = (!empty($sqlData[0]['tProofNote']) && $sqlData[0]['tProofNote'] != NULL) ? $sqlData[0]['tProofNote'] : "";
                            }
                        }
                        $allSubCategories[$allSubCategoriesCount] = $Datacategory[$j];
                        $allSubCategoriesCount++;
                    }
                    $j++;
                }
                $returnArr['Action'] = "1";
                if ($Data[0]['eDetailPageView'] == "Icon") {
                    $returnArr['message'] = $Datacategory;
                } else {
                    $returnArr['message'] = $allSubCategories;
                }
            }
        }
        // added by SP for implement ride delivery new flow.
        if ($MODULES_OBJ->isEnableRideDeliveryV1()) {
            if ($iVehicleCategoryId == 0) {
                $Data = $obj->MySQLSelect("SELECT iVehicleCategoryId,iParentId,eDetailPageView, iServiceId,vCategory_" . $lang . " as vCategory, tCategoryDesc_" . $lang . " as tCategoryDesc, tBannerButtonText, eCatType FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND iParentId='" . $iVehicleCategoryId . "'");
                $getCatData = $obj->MySQLSelect("SELECT iParentId,iVehicleCategoryId, vLogo, eShowType,vBannerImage, iServiceId, vCategory_" . $lang . " as vCategory, tCategoryDesc_" . $lang . " as tCategoryDesc, eCatType, tBannerButtonText, eDeliveryType FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' ORDER BY iDisplayOrder,iVehicleCategoryId ASC");

                $catDataArr = array();
                for ($f = 0; $f < count($getCatData); $f++) {
                    $catDataArr[$getCatData[$f]['iParentId']][] = $getCatData[$f];
                }
                if ($MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
                    $getService = $obj->MySQLSelect("SELECT iVehicleCategoryId,eCatType FROM " . $sql_vehicle_category_table_name . " WHERE iVehicleCategoryId = $iVehicleCategoryId");
                    $getService1 = $obj->MySQLSelect("SELECT iVehicleCategoryId FROM " . $sql_vehicle_category_table_name . " WHERE eCatType = 'MoreDelivery' AND eFor = 'DeliveryCategory'");
                    if ($getService[0]['eCatType'] == "Genie") {
                        $catDataArr[$iVehicleCategoryId] = $catDataArr[$getService1[0]['iVehicleCategoryId']];
                    }
                }
                if (isset($catDataArr[$Data[0]['iParentId']])) {
                    $Data2 = $catDataArr[$Data[0]['iParentId']];
                }
                
                if (count($Data2) > 0) {
                    $allSubCategories = $allBanners = array();
                    $allSubCategoriesCount = 0;
                    $j = 0;
                    
                    for ($i = 0; $i < count($Data2); $i++) {
                        $Datasubcategory = array();
                        $Datacategory[$j]['vCategory'] = $Data2[$i]['vCategory'];
                        $Datacategory[$j]['eCatType'] = $Data2[$i]['eCatType'];
                        $Datacategory[$j]['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data2[$i]['iVehicleCategoryId'] . '/android/' . $Data2[$i]['vLogo'];
                        $Datacategory[$j]['iVehicleCategoryId'] = $Data2[$i]['iVehicleCategoryId'];
                        $appBannerData = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(tTitle, '$.tTitle_" . $lang . "')) as tTitle, JSON_UNQUOTE(JSON_VALUE(tSubtitle, '$.tSubtitle_" . $lang . "')) as tSubtitle, JSON_UNQUOTE(JSON_VALUE(tButtonText, '$.tButtonText_" . $lang . "')) as tButtonText, vImage FROM app_banner_info WHERE iVehicleCategoryId = '" . $Data2[$i]['iVehicleCategoryId'] . "' AND eStatus = 'Active'");

                        if (!empty($appBannerData)) {
                            foreach ($appBannerData as $BannerData) {
                                $bannerarray = array();
                                $bannerarray = $Datacategory[$j];
                                $bannerarray['vTitle'] = $BannerData['tTitle'];
                                $bannerarray['vSubtitle'] = $BannerData['tSubtitle'];
                                if (!empty($BannerData['vImage']) && file_exists($tconfig['tsite_upload_app_banner_images_path'] . $BannerData['vImage'])) {
                                    $bannerarray['vImage'] = $tconfig['tsite_upload_app_banner_images'] . $BannerData['vImage'];
                                    $banner_img_path = $tconfig['tsite_upload_app_banner_images_path'] . $BannerData['vImage'];
                                }
                                $bannerarray['vBtnTtitle'] = $BannerData['tButtonText'];
                                $bannerarray['vTextColor'] = $BannerData['vTextColor'];
                                $bannerarray['vBtnBgColor'] = $BannerData['vButtonBgColor'];
                                $bannerarray['vBtnTextColor'] = $BannerData['vButtonTextColor'];
                                $bannerarray['vStatusBarColor'] = "";
                                if (file_exists($banner_img_path)) {
                                    $bannerarray['vStatusBarColor'] = getColorFromImage($banner_img_path);
                                }
                                $allBanners[] = $bannerarray;
                            }
                        }
                        $allSubCategories[$allSubCategoriesCount] = $Datacategory[$j];
                        $allSubCategoriesCount++;
                        $j++;
                    }
                    $returnArr['Action'] = "1";
                    $returnArr['message'] = $allSubCategories;
                    $returnArr['bannerArray'] = $allBanners;
                }
                //Added BY HJ On 21-12-2019 For Get Parent Category Data As Per Optimization Isseue End
                if (count($Data) > 0) {
                    //commented by SP on 28-12-2020, cuberidedeliveryx extra array shown so i have commented.
                    $returnArr['iServiceId'] = $Data[0]['iServiceId'];
                    $returnArr['vCategory'] = $Data[0]['vCategory'];
                    $returnArr['tCategoryDesc'] = $Data[0]['tCategoryDesc'];
                    $returnArr['eDetailPageView'] = $Data[0]['eDetailPageView'];
                    $returnArr['eCatType'] = $Data[0]['eCatType'];
                }
            }
        }
    }


    if (( $MODULES_OBJ->isEnableAppHomeScreenLayoutV2() || $MODULES_OBJ->isEnableAppHomeScreenLayoutV3() ) && $returnArr['eCatType'] == "MoreDelivery") {
        $whereloc = " AND iLocationid IN ('-1')";
        if ($MODULES_OBJ->isEnableLocationwiseBanner()) {
            $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
            $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
            $User_Address_Banner = array($vLatitude, $vLongitude);
            if (!empty($User_Address_Banner)) {
                $iLocationIdBanner = GetUserGeoLocationIdBanner($User_Address_Banner);
                $country_str_banner = "'-1'";
                if (count($iLocationIdBanner) > 0) {
                    foreach ($iLocationIdBanner as $key => $value) {
                        $country_str_banner .= ", '" . $value . "'";
                    }
                    $whereloc = " AND iLocationid IN (" . $country_str_banner . ")";
                }
            }
        }
        $eTypeBanner = "";
        if (strtoupper($APP_TYPE) == "DELIVERY"){
            $eTypeBanner = "General";
        } else if (strtoupper($APP_TYPE) != "DELIVERY" && $returnArr['eFor'] == "DeliveryCategory") {
            $eTypeBanner = "Deliver";
        } else if ($returnArr['eFor'] == "DeliverAllCategory") {
            $eTypeBanner = "DeliverAll";
        }
        $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $lang . "' AND vImage != '' AND eStatus = 'Active' AND eType = '$eTypeBanner' $whereloc ORDER BY iDisplayOrder ASC");

        $dataOfBanners = array();
        $count = 0;
        for ($i = 0; $i < count($Data_banners); $i++) {
            if (isset($Data_banners[$i]['vImage']) && $Data_banners[$i]['vImage'] != "") {
                $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $dataOfBanners[$count]['vStatusBarColor'] = $Data_banners[$i]['vStatusBarColor'];
                $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                if (file_exists($banner_img_path) && empty($Data_banners[$i]['vStatusBarColor'])) {
                    $dataOfBanners[$count]['vStatusBarColor'] = getColorFromImage($banner_img_path);
                    $obj->sql_query("UPDATE banners SET vStatusBarColor = '" . $dataOfBanners[$count]['vStatusBarColor'] . "' WHERE iUniqueId = '" . $Data_banners[$i]['iUniqueId'] . "'");
                }
                $count++;
            }
        }
        $returnArr['BANNER_DATA'] = $dataOfBanners;
    }
    setDataResponse($returnArr);
}
###########################################################
//Added By HJ On 27-08-2019 For Get Trip Details Start
if ($type == "getMemberTripDetails") {
    $iTripId = isset($_REQUEST['iTripId']) ? clean($_REQUEST['iTripId']) : '';
    $iBiddingPostId = isset($_REQUEST['iBiddingPostId']) ? clean($_REQUEST['iBiddingPostId']) : '';
    $iDriverId = isset($_REQUEST['iDriverId']) ? clean($_REQUEST['iDriverId']) : '';
    $UserType = isset($_REQUEST['UserType']) ? clean($_REQUEST['UserType']) : 'Passenger';
    $vGeneralLang = isset($_REQUEST['vGeneralLang']) ? clean($_REQUEST['vGeneralLang']) : 'EN';
    $tripData = $returnArr = array();
    $returnArr['Action'] = "0";
    $returnArr['message'] = "LBL_NOT_FOUND";
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    $labelsArr = $LANG_OBJ->FetchLanguageLabels($vGeneralLang, "1", $iServiceId);
    if (!empty($iTripId)) {
        if ($UserType == "Passenger") {
            $tableName = " register_driver as rd";
            $fieldName = "rd.iDriverId";
            $fieldName_trip = "tr.iDriverId";
            $memberId = $tripData[0]['iDriverId'];
            $fields = " CONCAT(rd.vName, ' ', rd.vLastName) as vName, rd.vImage as vImage, rd.vLang as vLang, rd.iDriverId as iMemberId,rd.iDriverId, rd.vAvgRating as vAvgRating";
        } else {
            $tableName = " register_user as ru";
            $fieldName_trip = "tr.iUserId";
            $fieldName = "ru.iUserId";
            $fields = " CONCAT(ru.vName, ' ', ru.vLastName) as vName, vImgName as vImage , ru.vLang as vLang, ru.iUserId as iMemberId,ru.iUserId, ru.vAvgRating as vAvgRating";
        }
        $tripData = $obj->MySQLSelect("SELECT tr.tTripRequestDate, tr.eType, tr.vRideNo, IF(tr.tVehicleTypeFareData != '', (SELECT vc.vCategory_" . $vGeneralLang . " FROM " . $sql_vehicle_category_table_name . " as vc WHERE vc.iVehicleCategoryId = JSON_UNQUOTE(JSON_VALUE(IF(tr.tVehicleTypeFareData = '', '0', tr.tVehicleTypeFareData), '$.ParentVehicleCategoryId'))), '') as vServiceName, " . $fields . " FROM trips as tr, " . $tableName . " WHERE tr.iTripId = '" . $iTripId . "' AND " . $fieldName . " = " . $fieldName_trip . "");
        if (!empty($tripData) && count($tripData) > 0) {
            $vImageFolder = "Passenger";
            if ($UserType == "Passenger") {
                $vImageFolder = "Driver";
            }
            if (empty($tripData[0]['vServiceName'])) {
                if ($tripData[0]['eType'] == "Ride") {
                    $tripData[0]['vServiceName'] = $labelsArr['LBL_RIDE'];
                } else if ($tripData[0]['eType'] == "Delivery" || $tripData[0]['eType'] == "Deliver" || $tripData[0]['eType'] == "Multi-Delivery") {
                    $tripData[0]['vServiceName'] = $labelsArr['LBL_DELIVERY'];
                } else {
                    $tripData[0]['vServiceName'] = $labelsArr['LBL_OTHER'];
                }
            }
            $tripData[0]['vImage'] = $tconfig["tsite_url"] . "/webimages/upload/" . $vImageFolder . "/" . $tripData[0]['iMemberId'] . "/" . $tripData[0]['vImage'];
            $returnArr['Action'] = "1";
            $returnArr['message'] = $tripData[0];
        }
    }
    if (!empty($iBiddingPostId)) {
        $biddingData = $BIDDING_OBJ->getBiddingPost('webservice', $iBiddingPostId);
        if ($UserType == "Passenger") {
            $row = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId=" . $iDriverId);
            $bidding_Data['iDriverId'] = $iDriverId;
        } else {
            $iUserId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId,vImgName as vImage FROM `register_user` WHERE iUserId=" . $biddingData[0]['iUserId']);
            $bidding_Data['iUserId'] = $biddingData[0]['iUserId'];
        }
        $vImageFolder = "Passenger";
        if ($UserType == "Passenger") {
            $vImageFolder = "Driver";
        }
        $bidding_Data['tTripRequestDate'] = $biddingData[0]['dAddedDate'];
        $bidding_Data['eType'] = 'Bidding';
        $bidding_Data['vRideNo'] = $biddingData[0]['vBiddingPostNo'];
        $bidding_Data['vImage'] = $tconfig["tsite_url"] . "/webimages/upload/" . $vImageFolder . "/" . $row[0]['iMemberId'] . "/" . $row[0]['vImage'];;
        $bidding_Data['vName'] = $row[0]['vName'] . ' ' . $row[0]['vLastName'];
        $bidding_Data['vServiceName'] = $BIDDING_OBJ->getServiceTitle('webservice', $biddingData[0]['iBiddingId'], $biddingData[0]['vTitle'], $vGeneralLang);
        $bidding_Data['vLang'] = $vGeneralLang;
        $bidding_Data['iMemberId'] = $row[0]['iMemberId'];
        $bidding_Data['vAvgRating'] = $row[0]['vAvgRating'];
        $returnArr['message'] = $bidding_Data;
        $returnArr['Action'] = "1";
    }
    setDataResponse($returnArr);
}
###############  Type sendChargeVerificationCode ###############
if ($type == "sendChargeVerificationCode") {
    $chargeMethod = $ADDITIONAL_CHARGE_VERIFICATION_METHOD;
    $eApproveRequestSentByDriver = isset($_REQUEST['eApproveRequestSentByDriver']) ? clean($_REQUEST['eApproveRequestSentByDriver']) : '';
    $eApproveByUser = isset($_REQUEST['eApproveByUser']) ? clean($_REQUEST['eApproveByUser']) : '';
    $TripId = isset($_REQUEST['TripId']) ? clean($_REQUEST['TripId']) : '';
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
    $eType = isset($_REQUEST['eType']) ? clean($_REQUEST['eType']) : '';
    $fMaterialFee = isset($_REQUEST["fMaterialFee"]) ? $_REQUEST["fMaterialFee"] : '';
    $fMiscFee = isset($_REQUEST["fMiscFee"]) ? $_REQUEST["fMiscFee"] : '';
    $fDriverDiscount = isset($_REQUEST["fDriverDiscount"]) ? $_REQUEST["fDriverDiscount"] : '';
    $passengerID = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
    if ($passengerID == '') {
        $passengerID = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    }
    $DriverId = isset($_REQUEST["DriverId"]) ? $_REQUEST["DriverId"] : '';
    $fTollPrice = isset($_REQUEST["fTollPrice"]) ? $_REQUEST["fTollPrice"] : '';
    $fOtherCharges = isset($_REQUEST["fOtherCharges"]) ? $_REQUEST["fOtherCharges"] : '';
    if (strtoupper($eType) == "RIDE") {
        $chargeMethod = $ENABLE_MANUAL_TOLL_VERIFICATION_METHOD;
    }
    $UserType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : '';
    if (strtoupper($eApproveRequestSentByDriver) == "NO") {
        //Added By HJ On 29-08-2020 For Optimize register_driver Table Query Start
        if (isset($userDetailsArr['register_driver_' . $DriverId])) {
            $rowD = $userDetailsArr['register_driver_' . $DriverId];
        } else {
            $rowD = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId='" . $DriverId . "'");
            $userDetailsArr['register_driver_' . $DriverId] = $rowD;
        }
        //Added By HJ On 29-08-2020 For Optimize register_driver Table Query Start
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $passengerID])) {
            $result = $userDetailsArr['register_user_' . $passengerID];
        } else {
            $result = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $passengerID . "'");
            $userDetailsArr['register_user_' . $passengerID] = $result;
        }
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        $iGcmRegId = $result[0]['iGcmRegId'];
        $eDeviceType = $result[0]['eDeviceType'];
        $vLanguage = $result[0]['vLang'];
        $eAppTerminate = $result[0]['eAppTerminate'];
        $eDebugMode = $result[0]['eDebugMode'];
        $eHmsDevice = $result[0]['eHmsDevice'];
        $labelsList = "'LBL_OTHER_CHARGES_DECLINE_DRIVER','LBL_MANUAL_TRACK_ORDER','LBL_VIEW_DETAILS'";
        $getAllLabels = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel IN ($labelsList) AND vCode = '" . $vLanguage . "'");
        $labelAscArr = array();
        for ($l = 0; $l < count($getAllLabels); $l++) {
            $labelAscArr[$getAllLabels[$l]['vLabel']] = $getAllLabels[$l];
        }
        foreach ($labelAscArr as $labelKey => $labelVal) {
            $$labelKey = $labelVal['vValue'];
        }
        $message = "VerifyChargesDeclined";
        $randomNumber = rand(111111, 999999);
        $message_arr = array();
        $message_arr['Message'] = $message;
        $message_arr['iTripId'] = $TripId;
        $message_arr['iDriverId'] = $DriverId;
        $message_arr['iUserId'] = $passengerID;
        $message_arr['driverName'] = $rowD[0]['vName'];
        $message_arr['eType'] = $eType;
        $message_arr['vTitle'] = $LBL_OTHER_CHARGES_DECLINE_DRIVER;
        $message_arr['iamunique'] = $randomNumber;
        $message_arr['eApproveRequestSentByDriver'] = $eApproveRequestSentByDriver;
        $message_arr['eSystem'] = "";
        //added by SP on 17-02-2021 for custom notification
        $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
        //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
        $message_arr['CustomViewBtn'] = "Yes";
        $message_arr['CustomTrackDetails'] = "No";
        $message_arr['LBL_VIEW_DETAILS'] = $LBL_VIEW_DETAILS;
        $message_arr['LBL_TRACK_ORDER'] = $LBL_MANUAL_TRACK_ORDER;
        $customNotiArray = GetCustomNotificationDetails($TripId, $message_arr['vTitle'], $vLanguage);
        //title and sub description shown in custom notification
        $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
        $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
        $message_arr['CustomMessage'] = $customNotiArray;
        // $channelName = "PASSENGER_" . $userId;
        $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr,// 'channelName'       => $channelName,
        );
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
    }
    //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes
    //$chargeMethod = 'Verification_';
    if ($chargeMethod != "Verification") {
        if ($eApproveRequestSentByDriver == "Yes") {
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
            if (strtoupper($eType) == "RIDE") {
                if (($fTollPrice <= 0) && ($fOtherCharges <= 0) && strtoupper($UserType) == "DRIVER") {
                    $DataForResponce['Action'] = "1";
                    $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                    setDataResponse($DataForResponce);
                } //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
            } else {
                if (($fMaterialFee == '' || $fMaterialFee == 0) && ($fMiscFee == '' || $fMiscFee == 0) && ($fDriverDiscount == '' || $fDriverDiscount == 0) && strtoupper($UserType) == "DRIVER") {
                    //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
                    if (isset($userDetailsArr['register_user_' . $passengerID])) {
                        $row = $userDetailsArr['register_user_' . $passengerID];
                    } else {
                        $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $passengerID . "'");
                        $userDetailsArr['register_user_' . $passengerID] = $row;
                    }
                    //$row = $obj->MySQLSelect("SELECT * FROM `register_user` WHERE iUserId='".$passengerID."'");
                    //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
                    $vLanguage = $row[0]['vLang'];
                    $db_label_lbl = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel = 'LBL_NO_ADDITIONAL_CHARGES_ADDED' AND vCode = '" . $vLanguage . "'");
                    $LBL_NO_ADDITIONAL_CHARGES_ADDED = $db_label_lbl[0]['vValue'];
                    // $DataForResponce['Action'] = "0";
                    // $DataForResponce['message'] = $LBL_NO_ADDITIONAL_CHARGES_ADDED;
                    $DataForResponce['Action'] = "1";
                    $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                    setDataResponse($DataForResponce);
                } else if (($fMaterialFee <= 0) && ($fMiscFee <= 0) && ($fDriverDiscount > 0) && strtoupper($UserType) == "DRIVER") {
                    $DataForResponce['Action'] = "1";
                    $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                    setDataResponse($DataForResponce);
                } else if (($fMaterialFee <= 0) && ($fMiscFee <= 0) && strtoupper($UserType) == "DRIVER") {
                    $DataForResponce['Action'] = "1";
                    $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                    setDataResponse($DataForResponce);
                }
            }
        } else {
            //$fMaterialFee = isset($_REQUEST["fMaterialFee"]) ? $_REQUEST["fMaterialFee"] : '';
            //$fMiscFee =  isset($_REQUEST["fMiscFee"]) ? $_REQUEST["fMiscFee"] : '';
            //$fDriverDiscount = isset($_REQUEST["fDriverDiscount"]) ? $_REQUEST["fDriverDiscount"] : '';
            //$passengerID = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
            if (strtoupper($eType) == "RIDE") {
                if (($fTollPrice <= 0) && ($fOtherCharges <= 0) && strtoupper($UserType) == "DRIVER") {
                    $DataForResponce['Action'] = "1";
                    $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                    setDataResponse($DataForResponce);
                }
            } //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        }
    } else {
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        if (strtoupper($eType) == "RIDE") {
            if (($fTollPrice <= 0) && ($fOtherCharges <= 0) && strtoupper($UserType) == "DRIVER") {
                $DataForResponce['Action'] = "1";
                $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                setDataResponse($DataForResponce);
            } //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        } else {
            if (($fMaterialFee == '' || $fMaterialFee == 0) && ($fMiscFee == '' || $fMiscFee == 0) && ($fDriverDiscount == '' || $fDriverDiscount == 0) && strtoupper($UserType) == "DRIVER") {
                //$passengerID = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
                //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
                if (isset($userDetailsArr['register_user_' . $passengerID])) {
                    $row = $userDetailsArr['register_user_' . $passengerID];
                } else {
                    $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $passengerID . "'");
                    $userDetailsArr['register_user_' . $passengerID] = $row;
                }
                //$row = $obj->MySQLSelect("SELECT * FROM `register_user` WHERE iUserId='".$passengerID."'");
                //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
                $vLanguage = $row[0]['vLang'];
                $db_label_lbl = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel = 'LBL_NO_ADDITIONAL_CHARGES_ADDED' AND vCode = '" . $vLanguage . "'");
                $LBL_NO_ADDITIONAL_CHARGES_ADDED = $db_label_lbl[0]['vValue'];
                // $DataForResponce['Action'] = "0";
                // $DataForResponce['message'] = $LBL_NO_ADDITIONAL_CHARGES_ADDED;
                $DataForResponce['Action'] = "1";
                $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                setDataResponse($DataForResponce);
            } else if (($fMaterialFee <= 0) && ($fMiscFee <= 0) && ($fDriverDiscount > 0) && strtoupper($UserType) == "DRIVER") {
                $DataForResponce['Action'] = "1";
                $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                setDataResponse($DataForResponce);
            } else if (($fMaterialFee <= 0) && ($fMiscFee <= 0) && strtoupper($UserType) == "DRIVER") {
                $DataForResponce['Action'] = "1";
                $DataForResponce['message'] = 'LBL_NO_FURTHER_PROCESS';
                setDataResponse($DataForResponce);
            }
        }
    }
    if (count($_REQUEST) > 0) {
        //$passengerID = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
        //if($passengerID == ''){
        //$passengerID = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
        //}
        //$DriverId = $_REQUEST['DriverId'];
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $passengerID])) {
            $row = $userDetailsArr['register_user_' . $passengerID];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $passengerID . "'");
            $userDetailsArr['register_user_' . $passengerID] = $row;
        }
        //$row = $obj->MySQLSelect("SELECT * FROM `register_user` WHERE iUserId='".$passengerID."'");
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        $Data['vEmail'] = $row[0]['vEmail'];
        $Data['vName'] = $riderNameEmail = $row[0]['vName'] . ' ' . $UserEmail = $row[0]['vLastName'];
        $Data['vPhone'] = $row[0]['vPhone'];
        $iGcmRegId = $row[0]['iGcmRegId'];
        // ============SMS
        $mobileNo = $row[0]['vPhoneCode'] . $row[0]['vPhone'];
        $toMobileNum = "+" . $mobileNo;
        $vLanguage = $row[0]['vLang'];
        //Added By HJ On 29-08-2020 For Optimize currency Table Query Start
        $vCurrency = $vCurrencyPassenger1 = $row[0]['vCurrencyPassenger'];
        if (isset($currencyAssociateArr[$vCurrencyPassenger1])) {
            $vCurrency = array();
            $vCurrency[] = $currencyAssociateArr[$vCurrencyPassenger1];
        } else {
            $vCurrency = get_value('currency', 'vSymbol, Ratio', 'vName', $vCurrency);
        }
        //$vCurrency = get_value('currency', 'vSymbol, Ratio', 'vName', $vCurrency);
        //Added By HJ On 29-08-2020 For Optimize currency Table Query End
        //Added By HJ On 29-08-2020 For Optimize language_label Table Query Start
        //$labelsList = "'LBL_VERIFY_CHRGES_MSG','LBL_CHRGES_MSG','LBL_ADDITIONAL_CHRGES_MSG_RIDE','LBL_DECLINE_DRIVER','LBL_CHARGE_REVOKED_BY_DRIVER','LBL_PASSENGER_APPROVE_NO','LBL_PASSENGER_APPROVE_YES','LBL_VERIFICATIONCODE_SENT_SUCCESS','LBL_CHARGE_APPROVEL_SENT_SUCCESS','LBL_VERIFICATIONCODE_SENT_FAIL','LBL_NO_ADDITIONAL_CHARGES_ADDED','LBL_INFORM_MANUAL_OTHER_CHARGES_TXT','LBL_MANUAL_TRACK_ORDER','LBL_VIEW_DETAILS'";
        //$getAllLabels = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel IN ($labelsList) AND vCode = '" . $vLanguage . "'");
        //$labelAscArr = array();
        //for($l=0;$l<count($getAllLabels);$l++){
        //    $labelAscArr[$getAllLabels[$l]['vLabel']] = $getAllLabels[$l];
        //}
        //foreach($labelAscArr as $labelKey=>$labelVal){
        //    $$labelKey = $labelVal['vValue'];
        //}
        //Added By HJ On 29-08-2020 For Optimize language_label Table Query End
        //$db_label = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel = 'LBL_VERIFY_CHRGES_MSG' AND vCode = '" . $vLanguage . "'");
        //$LBL_VERIFY_CHRGES_MSG = $db_label[0]['vValue'];
        //$db_label = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel = 'LBL_CHRGES_MSG' AND vCode = '" . $vLanguage . "'");
        //$LBL_CHRGES_MSG = $db_label[0]['vValue'];
        //Added By HJ On 29-08-2020 For Optimize register_driver Table Query Start
        if (isset($userDetailsArr['register_driver_' . $DriverId])) {
            $rowD = $userDetailsArr['register_driver_' . $DriverId];
        } else {
            $rowD = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId='" . $DriverId . "'");
            $userDetailsArr['register_driver_' . $DriverId] = $rowD;
        }
        //$rowD = $obj->MySQLSelect("SELECT * FROM `register_driver` WHERE iDriverId='".$DriverId."'");
        //Added By HJ On 29-08-2020 For Optimize register_driver Table Query Start
        $Data['ProviderName'] = $ProviderName = $rowD[0]['vName'];
        $Data['ProviderEmail'] = $rowD[0]['vEmail'];
        //$randomcode = rand(1000,9999);
        $randomcode = generateCommonRandom();
        //if(isset($_REQUEST['UserType']) && strtoupper($_REQUEST['UserType']) == 'DRIVER') {
        $vLabelLanguage = $vLanguage;
        //} else {
        //$vLabelLanguage = $rowD[0]['vLang'];
        //}
        //Added By HJ On 29-08-2020 For Optimize language_label Table Query Start
        $labelsList = "'LBL_VERIFY_CHRGES_MSG','LBL_CHRGES_MSG','LBL_ADDITIONAL_CHRGES_MSG_RIDE','LBL_DECLINE_DRIVER','LBL_CHARGE_REVOKED_BY_DRIVER','LBL_PASSENGER_APPROVE_NO','LBL_PASSENGER_APPROVE_YES','LBL_VERIFICATIONCODE_SENT_SUCCESS','LBL_CHARGE_APPROVEL_SENT_SUCCESS','LBL_VERIFICATIONCODE_SENT_FAIL','LBL_NO_ADDITIONAL_CHARGES_ADDED','LBL_INFORM_MANUAL_OTHER_CHARGES_TXT','LBL_MANUAL_TRACK_ORDER','LBL_VIEW_DETAILS','LBL_CHARGE_APPROVEL_SENT_FAIL'";
        $getAllLabels = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel IN ($labelsList) AND vCode = '" . $vLabelLanguage . "'");
        $labelAscArr = array();
        for ($l = 0; $l < count($getAllLabels); $l++) {
            $labelAscArr[$getAllLabels[$l]['vLabel']] = $getAllLabels[$l];
        }
        foreach ($labelAscArr as $labelKey => $labelVal) {
            $$labelKey = $labelVal['vValue'];
        }
        $labelsListD = "'LBL_CHARGE_APPROVEL_SENT_SUCCESS','LBL_INFORM_MANUAL_OTHER_CHARGES_TXT','LBL_VERIFICATIONCODE_SENT_SUCCESS','LBL_VERIFICATIONCODE_SENT_FAIL','LBL_NO_ADDITIONAL_CHARGES_ADDED', 'LBL_CHARGE_APPROVEL_SENT_FAIL'";
        $getAllLabelsD = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel IN ($labelsListD) AND vCode = '" . $rowD[0]['vLang'] . "'");
        $labelAscArrD = array();
        for ($l = 0; $l < count($getAllLabelsD); $l++) {
            $labelAscArrD[$getAllLabelsD[$l]['vLabel']] = $getAllLabelsD[$l];
        }
        foreach ($labelAscArrD as $labelKey => $labelVal) {
            $$labelKey = $labelVal['vValue'];
        }
        //Added By HJ On 29-08-2020 For Optimize language_label Table Query End
        if ($chargeMethod == "Verification") {
            $Data['VerificationCode'] = $randomcode;
        } else {
            $AcceptLink = $tconfig["tsite_url"] . "charge_Approvalstatus.php?iTripId=" . base64_encode(base64_encode($TripId)) . "&status=Yes";
            $AcceptLink = get_tiny_url($AcceptLink);
            $DeclineLink = $tconfig["tsite_url"] . "charge_Approvalstatus.php?iTripId=" . base64_encode(base64_encode($TripId)) . "&status=No";
            $DeclineLink = get_tiny_url($DeclineLink);
            $linkAcceptDecline = '<a style="color:#000;padding: 8px 30px 10px 30px; background-color: #93ec92; border-radius: 10px; display: inline-block; font-family: poppins;  text-decoration: none;" href="' . $AcceptLink . '">Approve</a>  &nbsp;&nbsp;&nbsp; <a style="color:#000; text-decoration: none; padding: 8px 30px 10px 30px; background-color: #ffc4c4; border-radius: 10px; display: inline-block; font-family: poppins;" type="button" href="' . $DeclineLink . '">Decline</a>';
            //$linkAcceptDecline = '<a style="padding: 5px; background-color: #93ec92; border-radius: 10px;" type="button" href="'.$AcceptLink.'">Approve</a>  &nbsp;&nbsp;&nbsp; <a style="padding: 5px; background-color: #ffc4c4; border-radius: 10px;" type="button" href="'.$DeclineLink.'">Decline</a>';
            // $linkDecline = '<a type="button" href="'.$DeclineLink.'"</a> Decline';
            $Data['AcceptLink'] = $linkAcceptDecline;
        }
        //Added By HJ On 29-08-2020 For Optimize currency Table Query Start
        $vCurrencyDriver = $vCurrencyDriver1 = $rowD[0]['vCurrencyDriver'];
        if (isset($currencyAssociateArr[$vCurrencyDriver1])) {
            $vCurrencyDriver = array();
            $vCurrencyDriver[] = $currencyAssociateArr[$vCurrencyDriver1];
        } else {
            $vCurrencyDriver = get_value('currency', 'vSymbol, Ratio', 'vName', $vCurrencyDriver);
        }
        //$vCurrencyDriver = get_value('currency', 'vSymbol, Ratio', 'vName', $vCurrencyDriver);
        //Added By HJ On 29-08-2020 For Optimize currency Table Query End
        $currencyratioDriver = $vCurrencyDriver[0]['Ratio'];
        $currencyvNameDriver = $vCurrencyDriver[0]['vName'];
        $vSymbolDriver = $vCurrencyDriver[0]['vSymbol'];
        //$fMaterialFee = isset($_REQUEST["fMaterialFee"]) ? $_REQUEST["fMaterialFee"] : '';
        //$fMiscFee =  isset($_REQUEST["fMiscFee"]) ? $_REQUEST["fMiscFee"] : '';
        //$fDriverDiscount = isset($_REQUEST["fDriverDiscount"]) ? $_REQUEST["fDriverDiscount"] : '';
        $fMaterialFeeDefaultCurrency = setTwoDecimalPoint($fMaterialFee / $currencyratioDriver);
        $fMiscFeeDefaultCurrency = setTwoDecimalPoint($fMiscFee / $currencyratioDriver);
        $fDriverDiscountDefaultCurrency = setTwoDecimalPoint($fDriverDiscount / $currencyratioDriver);
        $currencyratio = $vCurrency[0]['Ratio'];
        $fMaterialFee = setTwoDecimalPoint($fMaterialFeeDefaultCurrency * $currencyratio);
        $fMiscFee = setTwoDecimalPoint($fMiscFeeDefaultCurrency * $currencyratio);
        $fDriverDiscount = setTwoDecimalPoint($fDriverDiscountDefaultCurrency * $currencyratio);
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        if (strtoupper($eType) == "RIDE") {
            $fTollPriceDefaultCurrency = $fTollPrice / $currencyratioDriver;
            $fOtherChargesDefaultCurrency = $fOtherCharges / $currencyratioDriver;
            $fTollPrice = setTwoDecimalPoint($fTollPriceDefaultCurrency * $currencyratio);
            $fOtherCharges = setTwoDecimalPoint($fOtherChargesDefaultCurrency * $currencyratio);
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        //Added By HJ On 29-08-2020 For Optimization trips Table Query Start
        if (isset($tripDetailsArr['trips_' . $TripId])) {
            $tripData = $tripDetailsArr['trips_' . $TripId];
        } else {
            $tripData = $obj->MySQLSelect("SELECT * FROM `trips` WHERE iTripId = '" . $TripId . "'");
            $tripDetailsArr['trips_' . $TripId] = $tripData;
        }
        $eType = $tripData[0]['eType'];
        $vRideNo = $tripData[0]['vRideNo'];
        $iVehicleTypeId = $tripData[0]['iVehicleTypeId'];
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        $eHailTrip = $tripData[0]['eHailTrip'];
        $eBookForSomeOneElse = $tripData[0]['eBookForSomeOneElse'];
        $eBookingFrom = $tripData[0]['eBookingFrom'];
        $preventUserInteraction = "No";
        if (strtoupper($eType) == "RIDE") {
            if (strtoupper($eHailTrip) == "YES" || strtoupper($eBookForSomeOneElse) == "YES" || $iGcmRegId == "" || strtoupper($eBookingFrom) == "KIOSK") {
                $preventUserInteraction = "Yes";
            }
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        $eApproveRequestSentByDriverDB = $tripData[0]['eApproveRequestSentByDriver'];
        //$eType = get_value('trips', 'eType', 'iTripId', $TripId, '', 'true');
        //$vRideNo = get_value('trips', 'vRideNo', 'iTripId', $TripId, '', 'true');
        //$iVehicleTypeId = get_value('trips', 'iVehicleTypeId', 'iTripId', $TripId, '', 'true');
        //Added By HJ On 29-08-2020 For Optimization trips Table Query End
        //if (strtoupper(APP_TYPE) == "UBERX" || strtoupper(APP_TYPE) == "RIDE-DELIVERY-UBERX") {
        if ((strtoupper(APP_TYPE) == "UBERX" || strtoupper(APP_TYPE) == "RIDE-DELIVERY-UBERX") && $isUfxAvailable == "Yes") {
            include_once('include/uberx/include_webservice_uberx.php');
            $UberX_Trip_Charge = DisplayTripChargeForUberX($TripId);
            $serviceCost = !is_numeric($UberX_Trip_Charge['TotalFareUberXValue']) ? "" : $UberX_Trip_Charge['TotalFareUberXValue'];
        }
        //$serviceCost = setTwoDecimalPoint($serviceCost);
        $serviceCostDefaultCurrency = setTwoDecimalPoint($serviceCost / $currencyratioDriver);
        $serviceCost = setTwoDecimalPoint($serviceCostDefaultCurrency * $currencyratio);
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $passengerID])) {
            $result = $userDetailsArr['register_user_' . $passengerID];
        } else {
            $result = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $passengerID . "'");
            $userDetailsArr['register_user_' . $passengerID] = $result;
        }
        //$result = $obj->MySQLSelect("SELECT iAppVersion,eDeviceType,iGcmRegId,vLang,tSessionId FROM register_user WHERE iUserId='" . $passengerID . "'");
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        $iGcmRegId = $result[0]['iGcmRegId'];
        $eDeviceType = $result[0]['eDeviceType'];
        $tSessionId = $result[0]['tSessionId'];
        $eAppTerminate = $result[0]['eAppTerminate'];
        $eDebugMode = $result[0]['eDebugMode'];
        $eHmsDevice = $result[0]['eHmsDevice'];
        $message = "VerifyCharges";
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        if (strtoupper($eType) == "RIDE") {
            $totalCharges = $totalAmount = ($fTollPrice + $fOtherCharges - $fDriverDiscount);
            $totalAmountefaultCurrency = $totalChargesDefaultCurrency = ($fTollPriceDefaultCurrency + $fOtherChargesDefaultCurrency - $fDriverDiscountDefaultCurrency);
        } else {
            $totalCharges = ($fMaterialFee + $fMiscFee - $fDriverDiscount);
            $totalChargesDefaultCurrency = ($fMaterialFeeDefaultCurrency + $fMiscFeeDefaultCurrency - $fDriverDiscountDefaultCurrency);
            $totalAmount = ($serviceCost + $fMaterialFee + $fMiscFee - $fDriverDiscount);
            $totalAmountefaultCurrency = ($serviceCostDefaultCurrency + $fMaterialFeeDefaultCurrency + $fMiscFeeDefaultCurrency - $fDriverDiscountDefaultCurrency);
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        $currencyratio = $vCurrency[0]['Ratio'];
        $vSymbol = $vCurrency[0]['vSymbol'];
        if ($chargeMethod == "Verification") {
            $alertMsg = str_replace("#EXTRA_CHARGE#", formateNumAsPerCurrency($totalChargesDefaultCurrency * $currencyratio, $vCurrencyPassenger1), $LBL_VERIFY_CHRGES_MSG);
        } else {
            if (strtoupper($eType) == "RIDE") {
                $alertMsg = str_replace("#DRIVERNAME#", $ProviderName, $LBL_ADDITIONAL_CHRGES_MSG_RIDE);
                $alertMsg = str_replace("#TOTAL#", formateNumAsPerCurrency($totalAmountefaultCurrency * $currencyratio, $vCurrencyPassenger1), $alertMsg);
            } else {
                $alertMsg = str_replace("#EXTRA_CHARGE#", formateNumAsPerCurrency($totalChargesDefaultCurrency * $currencyratio, $vCurrencyPassenger1), $LBL_CHRGES_MSG);
                $alertMsg = str_replace("#PROVIDERNAME#", $ProviderName, $alertMsg);
                $alertMsg = str_replace("#TOTAL#", formateNumAsPerCurrency($totalAmountefaultCurrency * $currencyratio, $vCurrencyPassenger1), $alertMsg);
            }
        }
        $vCurrencyPassenger = $row[0]['vCurrencyPassenger'];
        //Added By HJ On 29-08-2020 For Optimize currency Table Query Start
        if ($vCurrencyPassenger == "" || $vCurrencyPassenger == NULL) {
            if (!empty($vSystemDefaultCurrencyName)) {
                $vCurrencyPassenger = $vSystemDefaultCurrencyName;
            } else {
                $vCurrencyPassenger = get_value('currency', 'vName', 'eDefault', 'Yes', '', 'true');
            }
        }
        if (isset($currencyAssociateArr[$vCurrencyPassenger])) {
            $vCurrencyDriver = array();
            $CurrencySymbol = $currencyAssociateArr[$vCurrencyPassenger]['vSymbol'];
            $Ratio = $currencyAssociateArr[$vCurrencyPassenger]['Ratio'];
        } else {
            $CurrencySymbol = get_value('currency', 'vSymbol', 'vName', $vCurrencyPassenger, '', 'true');
            $Ratio = get_value('currency', 'Ratio', 'vName', $vCurrencyPassenger, '', 'true');
        }
        //$CurrencySymbol = get_value('currency', 'vSymbol', 'vName', $vCurrencyPassenger, '', 'true');
        //$Ratio = get_value('currency', 'Ratio', 'vName', $vCurrencyPassenger, '', 'true');
        //Added By HJ On 29-08-2020 For Optimize currency Table Query End
        $fTripsOutStandingAmount = GetPassengerOutstandingAmount($passengerID);
        $fTripsOutStandingAmount = setTwoDecimalPoint($fTripsOutStandingAmount * $Ratio);
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        if (strtoupper($eType) == "RIDE") {
            $DataForStore['fTollPrice'] = $fTollPriceDefaultCurrency;
            $DataForStore['fOtherCharges'] = $fOtherChargesDefaultCurrency;
            $DataForStore['fDriverDiscount'] = $fDriverDiscountDefaultCurrency;
        } else {
            $DataForStore['fMaterialFee'] = $fMaterialFeeDefaultCurrency;
            $DataForStore['fMiscFee'] = $fMiscFeeDefaultCurrency;
            $DataForStore['fDriverDiscount'] = $fDriverDiscountDefaultCurrency;
            $DataForStore['serviceCost'] = $serviceCostDefaultCurrency;
        }
        $DataForStore['totalAmount'] = $totalAmountefaultCurrency;
        /*----------------------Comission Change---------------*/
        if (strtoupper($eType) == 'UBERX' && strtoupper($_REQUEST['UserType']) == 'DRIVER') {
            $tVehicle_TypeFare_Data = json_decode($tripData[0]['tVehicleTypeFareData'], true);
            getValidDiscountForTrip($tVehicle_TypeFare_Data, $DataForStore);
        }
        /*----------------------Comission Change---------------*/
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        // $DataForStore['vConfirmationCode'] = $randomcode;
        if ($chargeMethod == "Verification") {
            $DataForStore['vConfirmationCode'] = $randomcode;
        } else {
            $DataForStore['vConfirmationCode'] = '';
        }
        $jsonData = json_encode($DataForStore);
        if (isset($_REQUEST['UserType']) && strtoupper($_REQUEST['UserType']) == 'DRIVER') {
            if ($eApproveRequestSentByDriver != '') {
                $obj->sql_query("UPDATE trips SET eApproveRequestSentByDriver= '" . $eApproveRequestSentByDriver . "' WHERE iTripId='" . $TripId . "'");
                if ($eApproveRequestSentByDriver == 'No') {
                    $jsonData = '{}';
                    $obj->sql_query("UPDATE trips SET vChargesDetailData='" . $jsonData . "' WHERE iTripId='" . $TripId . "'");
                    $DataForResponce['eApproveRequestSentByDriver'] = $eApproveRequestSentByDriver;
                    //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_DECLINE_DRIVER' AND vCode = '" . $vLanguage . "'";
                    //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
                    //$LBL_DECLINE_DRIVER = $db_label_lbl[0]['vValue'];
                    if (strtoupper($preventUserInteraction) != "YES") {
                        $DataForResponce['Action'] = "1";
                        $DataForResponce['message'] = $LBL_DECLINE_DRIVER;
                    } else {
                        $DataForResponce['Action'] = "2";
                        $DataForResponce['message'] = $LBL_INFORM_MANUAL_OTHER_CHARGES_TXT;
                    }
                    setDataResponse($DataForResponce);
                } else {
                    $obj->sql_query("UPDATE trips SET eApproved='',eApproveByUser='' WHERE iTripId='" . $TripId . "'");
                }
            }
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
            if ($chargeMethod == "Verification" && strtoupper($eType) == "RIDE") {
                $obj->sql_query("UPDATE trips SET eApproveRequestSentByDriver= 'Yes' WHERE iTripId='" . $TripId . "'");
            }
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        }
        $sendNotiToDriver = "No";
        if (isset($_REQUEST['UserType']) && strtoupper($_REQUEST['UserType']) == 'USER' || strtoupper($_REQUEST['UserType']) == 'PASSENGER') {
            if ($eApproveByUser != '') {
                if ($eApproveRequestSentByDriverDB == 'No' && $eApproveByUser == 'Yes') {
                    //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_CHARGE_REVOKED_BY_DRIVER' AND vCode = '" . $vLanguage . "'";
                    //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
                    //$LBL_CHARGE_REVOKED_BY_DRIVER = $db_label_lbl[0]['vValue'];
                    $DataForResponce['Action'] = "0";
                    $DataForResponce['message'] = $LBL_CHARGE_REVOKED_BY_DRIVER;
                    setDataResponse($DataForResponce);
                } else if ($eApproveByUser == 'No') {
                    $obj->sql_query("UPDATE trips SET vChargesDetailData='{}',eApproveRequestSentByDriver='No',eApproveByUser='No',eApproved = 'No' WHERE iTripId='" . $TripId . "'");
                    //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_PASSENGER_APPROVE_NO' AND vCode = '" . $vLanguage . "'";
                    //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
                    //$LBL_PASSENGER_APPROVE_NO = $db_label_lbl[0]['vValue'];
                    if (strtoupper($preventUserInteraction) != "YES") {
                        $DataForResponce['Action'] = "1";
                        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
                        if ($chargeMethod != "Verification") {
                            $DataForResponce['MSG_TYPE'] = "DO_RESTART";
                        }
                        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
                        $DataForResponce['message'] = $LBL_PASSENGER_APPROVE_NO;
                    } else {
                        $DataForResponce['Action'] = "2";
                        $DataForResponce['message'] = $LBL_INFORM_MANUAL_OTHER_CHARGES_TXT;
                    }
                    setDataResponse($DataForResponce);
                } else {
                    $obj->sql_query("UPDATE trips SET eApproveByUser = '" . $eApproveByUser . "',eApproved = '" . $eApproveByUser . "' WHERE iTripId='" . $TripId . "'");
                    //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_PASSENGER_APPROVE_YES' AND vCode = '" . $vLanguage . "'";
                    //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
                    //$LBL_PASSENGER_APPROVE_YES = $db_label_lbl[0]['vValue'];
                    if (strtoupper($preventUserInteraction) != "YES") {
                        $DataForResponce['Action'] = "1";
                        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
                        if ($chargeMethod != "Verification") {
                            $DataForResponce['MSG_TYPE'] = "DO_RESTART";
                        }
                        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
                        $DataForResponce['message'] = $LBL_PASSENGER_APPROVE_YES;
                        $iGcmRegId = $rowD[0]['iGcmRegId'];
                        $eDeviceType = $rowD[0]['eDeviceType'];
                        $tSessionId = $rowD[0]['tSessionId'];
                        $eAppTerminate = $rowD[0]['eAppTerminate'];
                        $eDebugMode = $rowD[0]['eDebugMode'];
                        $sendNotiToDriver = "Yes";
                    } else {
                        $DataForResponce['Action'] = "2";
                        $DataForResponce['message'] = $LBL_INFORM_MANUAL_OTHER_CHARGES_TXT;
                    }
                    setDataResponse($DataForResponce);
                }
            }
        }
        //$fMaterialFee = isset($_REQUEST["fMaterialFee"]) ? $_REQUEST["fMaterialFee"] : '';
        //$fMiscFee =  isset($_REQUEST["fMiscFee"]) ? $_REQUEST["fMiscFee"] : '';
        //$fDriverDiscount = isset($_REQUEST["fDriverDiscount"]) ? $_REQUEST["fDriverDiscount"] : '';
        if ($eApproveByUser != 'No') {
            $obj->sql_query("UPDATE trips SET vChargesDetailData='" . $jsonData . "' WHERE iTripId='" . $TripId . "'");
        }
        $randomNumber = rand(111111, 999999);
        $message_arr['Message'] = $message;
        $message_arr['MessageType'] = $message;
        $message_arr['iTripId'] = $TripId;
        $message_arr['iDriverId'] = $DriverId;
        $message_arr['iUserId'] = $passengerID;
        $message_arr['driverName'] = $rowD[0]['vName'];
        $message_arr['eType'] = $eType;
        $message_arr['vTitle'] = $alertMsg;
        $message_arr['iamunique'] = $randomNumber;
        $message_arr['eApproveRequestSentByDriver'] = $eApproveRequestSentByDriver;
        if ($chargeMethod == "Verification") {
            $message_arr['vConfirmationCode'] = $randomcode;
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        if (strtoupper($eType) == "RIDE") {
            $message_arr['fTollPrice'] = isset($_REQUEST["fTollPrice"]) ? formateNumAsPerCurrency($fTollPriceDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
            $message_arr['fOtherCharges'] = isset($_REQUEST["fOtherCharges"]) ? formateNumAsPerCurrency($fOtherChargesDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
        } else {
            $message_arr['fMaterialFee'] = isset($_REQUEST["fMaterialFee"]) ? formateNumAsPerCurrency($fMaterialFeeDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
            $message_arr['fMiscFee'] = isset($_REQUEST["fMiscFee"]) ? formateNumAsPerCurrency($fMiscFeeDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
            $message_arr['serviceCost'] = formateNumAsPerCurrency($serviceCostDefaultCurrency * $currencyratio, $vCurrencyPassenger1);
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        $message_arr['fDriverDiscount'] = isset($_REQUEST["fDriverDiscount"]) ? $vSymbol . ' ' . setTwoDecimalPoint($fDriverDiscountDefaultCurrency * $currencyratio) : '';
        $message_arr['totalAmount'] = formateNumAsPerCurrency($totalAmountefaultCurrency * $currencyratio, $vCurrencyPassenger1);
        $message_arr['eSystem'] = "";
        //added by SP on 17-02-2021 for custom notification
        $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification() ? "Yes" : "No";
        //these two btn CustomViewBtn,CustomTrackDetails whether shown in app or not
        $message_arr['CustomViewBtn'] = "Yes";
        $message_arr['CustomTrackDetails'] = "No";
        $message_arr['LBL_VIEW_DETAILS'] = $LBL_VIEW_DETAILS;
        $message_arr['LBL_TRACK_ORDER'] = $LBL_MANUAL_TRACK_ORDER;
        $customNotiArray = GetCustomNotificationDetails($TripId, $message_arr['vTitle'], $vLanguage);
        //title and sub description shown in custom notification
        $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
        $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
        $message_arr['CustomMessage'] = $customNotiArray;
        $message_arr['tSessionId'] = $tSessionId;
        if (strtoupper($preventUserInteraction) != "YES") {
            $channelName = $sendNotiToDriver == "No" ? "PASSENGER_" . $passengerID : "CAB_REQUEST_DRIVER_" . $DriverId;
            $generalDataArr[] = array(
                'eDeviceType' => $eDeviceType,
                'deviceToken' => $iGcmRegId,
                'alertMsg' => $alertMsg,
                'eAppTerminate' => $eAppTerminate,
                'eDebugMode' => $eDebugMode,
                'eHmsDevice' => $eHmsDevice,
                'message' => $message_arr,
                'channelName' => $channelName,
            );
            $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), $sendNotiToDriver == "No" ? RN_USER : RN_PROVIDER);
        }
        if ($sendNotiToDriver == "Yes") {
            setDataResponse($DataForResponce);
        }
        $Data['TripId'] = $vRideNo;
        $Data['DriverId'] = $_REQUEST['DriverId'];
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
        if (strtoupper($eType) == "RIDE") {
            $Data['TOLL_CHARGE'] = isset($_REQUEST["fTollPrice"]) ? formateNumAsPerCurrency($fTollPriceDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
            $Data['OTHER_CHARGE'] = isset($_REQUEST["fOtherCharges"]) ? formateNumAsPerCurrency($fOtherChargesDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
        } else {
            $Data['fMaterialFee'] = isset($_REQUEST["fMaterialFee"]) ? formateNumAsPerCurrency($fMaterialFeeDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
            $Data['fMiscFee'] = isset($_REQUEST["fMiscFee"]) ? formateNumAsPerCurrency($fMiscFeeDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
            $Data['serviceCost'] = formateNumAsPerCurrency($serviceCostDefaultCurrency * $currencyratio, $vCurrencyPassenger1);
        }
        //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
        $Data['fDriverDiscount'] = isset($_REQUEST["fDriverDiscount"]) ? formateNumAsPerCurrency($fDriverDiscountDefaultCurrency * $currencyratio, $vCurrencyPassenger1) : '';
        $Data['PassengerId'] = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
        $Data['iTripTimeId'] = isset($_REQUEST["iTripTimeId"]) ? $_REQUEST["iTripTimeId"] : '';
        $Data['totalAmount'] = formateNumAsPerCurrency($totalAmountefaultCurrency * $currencyratio, $vCurrencyPassenger1);
        if (strtoupper($preventUserInteraction) != "YES") {
            if ($chargeMethod == "Verification") {
                //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
                if (strtoupper($eType) == "RIDE") {
                    $Data['Rider'] = $riderNameEmail;
                    $Data['VERIFICATION_CODE'] = $randomcode;
                    if (strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "YES" && strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "NO") {
                        $verificationEmailTemplate = "MANUAL_TOLL_CHARGES_OTP_MESSAGE";
                    }
                    if (strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "YES" && strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "NO") {
                        $verificationEmailTemplate = "MANUAL_OTHER_CHARGES_OTP_MESSAGE";
                    }
                    if (strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "YES" && strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "YES") {
                        $verificationEmailTemplate = "MANUAL_TOLL_AND_OTHER_CHARGES_OTP_MESSAGE";
                    }
                } else {
                    $verificationEmailTemplate = "SEND_CHARGES__VARIFICATIONCODE";
                }
                $resultemail = $COMM_MEDIA_OBJ->SendMailToMember($verificationEmailTemplate, $Data);
                //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
            } else {
                if (strtoupper($eType) == "RIDE") {
                    $approveMailTemplate = "MANUAL_TOLL_AND_OTHER_CHARGES_APPROVE_MESSAGE";
                } else {
                    $approveMailTemplate = "SEND_CHARGES__APPROVE";
                }
                $resultemail = $COMM_MEDIA_OBJ->SendMailToMember($approveMailTemplate, $Data);
            }
            $lang_usr = $vLanguage;
            if ($chargeMethod == "Verification") {
                //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
                if (strtoupper($eType) == "RIDE") {
                    if (strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "YES" && strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "NO") {
                        $verificationSmsTemplate = "MANUAL_TOLL_CHARGES_OTP_MESSAGE";
                    }
                    if (strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "YES" && strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "NO") {
                        $verificationSmsTemplate = "MANUAL_OTHER_CHARGES_OTP_MESSAGE";
                    }
                    if (strtoupper($ENABLE_MANUAL_TOLL_FEATURE) == "YES" && strtoupper($ENABLE_OTHER_CHARGES_FEATURE) == "YES") {
                        $verificationSmsTemplate = "MANUAL_TOLL_AND_OTHER_CHARGES_OTP_MESSAGE";
                    }
                } else {
                    $verificationSmsTemplate = "SEND_CHARGES__VARIFICATIONCODE";
                }
                $data_SMS = $obj->MySQLSelect("select vBody_$lang_usr as Message from send_message_templates where vEmail_Code = '" . $verificationSmsTemplate . "'");
                $triplink = $tconfig["tsite_url"] . "charge_confirmationcode.php?iTripId=" . base64_encode(base64_encode($TripId));
                $liveTrackingUrl = get_tiny_url($triplink);
            } else {
                if (strtoupper($eType) == "RIDE") {
                    $approveSMSTemplate = "MANUAL_TOLL_AND_OTHER_CHARGES_APPROVE_MESSAGE";
                } else {
                    $approveSMSTemplate = "SEND_CHARGES__APPROVE";
                }
                $data_SMS = $obj->MySQLSelect("select vBody_$lang_usr as Message from send_message_templates where vEmail_Code = '" . $approveSMSTemplate . "'");
                $triplink = $tconfig["tsite_url"] . "charge_approvedecline.php?iTripId=" . base64_encode(base64_encode($TripId));
                $liveTrackingUrl = get_tiny_url($triplink);
            }
            $messageSMS = str_replace("#vName#", $row[0]['vName'], $data_SMS[0]['Message']);
            $messageSMS = str_replace("#PROVIDER_NAME#", $ProviderName, $messageSMS);
            $messageSMS = str_replace("#TRIP_NUMBER#", $vRideNo, $messageSMS);
            $messageSMS = str_replace("#LINK_TO_CHARGE#", $liveTrackingUrl, $messageSMS);
            if (strtoupper($eType) == "RIDE") {
                $messageSMS = str_replace("#TOLL_CHARGE#", $Data['TOLL_CHARGE'], $messageSMS);
                $messageSMS = str_replace("#OTHER_CHARGE#", $Data['OTHER_CHARGE'], $messageSMS);
            }
            if ($chargeMethod == "Verification") {
                $messageSMS = str_replace("#VERIFICATION_CODE#", $randomcode, $messageSMS);
            }
            $resultsms = $COMM_MEDIA_OBJ->SendSystemSMS($toMobileNum, "", $messageSMS);
        } else {
            $resultsms = $resultemail = 1;
        }
        if ($resultemail == 1 || $resultsms == 1) {
            if ($chargeMethod == "Verification") {
                //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_VERIFICATIONCODE_SENT_SUCCESS' AND vCode = '" . $vLanguage . "'";
                //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
                //$LBL_VERIFICATIONCODE_SENT_SUCCESS = $db_label_lbl[0]['vValue'];
                $DataForResponce['Action'] = "1";
                $DataForResponce['message'] = $LBL_VERIFICATIONCODE_SENT_SUCCESS;
            } else {
                // Charges approval request sent to your client,Kindly wait for approval
                //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_CHARGE_APPROVEL_SENT_SUCCESS' AND vCode = '" . $vLanguage . "'";
                //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
                //$LBL_CHARGE_APPROVEL_SENT_SUCCESS = $db_label_lbl[0]['vValue'];
                $DataForResponce['Action'] = "1";
                $DataForResponce['message'] = $LBL_CHARGE_APPROVEL_SENT_SUCCESS;
            }
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
            if (strtoupper($eType) == "RIDE") {
                $DataForResponce['fTollPrice'] = $fTollPrice;
                $DataForResponce['fOtherCharges'] = $fOtherCharges;
            } else {
                $DataForResponce['fMaterialFee'] = $fMaterialFee;
                $DataForResponce['fMiscFee'] = $fMiscFee;
                $DataForResponce['serviceCost'] = $serviceCost;
            }
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
            $DataForResponce['fDriverDiscount'] = $fDriverDiscount;
            $DataForResponce['vConfirmationCode'] = $randomcode;
            $DataForResponce['totalAmount'] = $totalAmount;
            #####################Add Status Message#########################
            $DataTripMessages['tMessage'] = $message;
            $DataTripMessages['iDriverId'] = $DriverId;
            $DataTripMessages['iTripId'] = $TripId;
            $DataTripMessages['iUserId'] = $passengerID;
            $DataTripMessages['eFromUserType'] = "Driver";
            $DataTripMessages['eToUserType'] = "Passenger";
            $DataTripMessages['eReceived'] = "Yes";
            $DataTripMessages['dAddedDate'] = @date("Y-m-d H:i:s");
            $obj->MySQLQueryPerform("trip_status_messages", $DataTripMessages, 'insert');
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes Start
            if (strtoupper($preventUserInteraction) == "YES") {
                $DataForResponce['Action'] = "2";
                $DataForResponce['message'] = $LBL_INFORM_MANUAL_OTHER_CHARGES_TXT;
            }
            //Added By HJ On 29-08-2020 For Manual Toll and Other Charges Related Changes End
            ################################################################
        } else {
            //$sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_VERIFICATIONCODE_SENT_FAIL' AND vCode = '" . $vLanguage . "'";
            //$db_label_lbl = $obj->MySQLSelect($sqlverifycode);
            //$LBL_VERIFICATIONCODE_SENT_FAIL = $db_label_lbl[0]['vValue'];
            // $DataForResponce['Action'] = "0";
            // $DataForResponce['vConfirmationCode'] = $randomcode;
            // $DataForResponce['message'] = $LBL_VERIFICATIONCODE_SENT_FAIL;
            if ($chargeMethod == "Verification") {
                $DataForResponce['Action'] = "1";
                $DataForResponce['vConfirmationCode'] = $randomcode;
                $DataForResponce['message'] = $LBL_VERIFICATIONCODE_SENT_FAIL;
            } else {
                $DataForResponce['Action'] = "1";
                // $DataForResponce['vConfirmationCode'] = $randomcode;
                $DataForResponce['message'] = $LBL_CHARGE_APPROVEL_SENT_FAIL;
            }
        }
    } else {
        //$passengerID = isset($_REQUEST["PassengerId"]) ? $_REQUEST["PassengerId"] : '';
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $passengerID])) {
            $row = $userDetailsArr['register_user_' . $passengerID];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $passengerID . "'");
            $userDetailsArr['register_user_' . $passengerID] = $row;
        }
        //$row = $obj->MySQLSelect("SELECT * FROM `register_user` WHERE iUserId='".$passengerID."'");
        //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
        $vLanguage = $row[0]['vLang'];
        $db_label_lbl = $obj->MySQLSelect("SELECT * FROM `language_label` WHERE vLabel = 'LBL_NO_ADDITIONAL_CHARGES_ADDED' AND vCode = '" . $vLanguage . "'");
        $LBL_NO_ADDITIONAL_CHARGES_ADDED = $db_label_lbl[0]['vValue'];
        $DataForResponce['Action'] = "0";
        $DataForResponce['message'] = $LBL_NO_ADDITIONAL_CHARGES_ADDED;
    }
    setDataResponse($DataForResponce);
}
###########################################################################
if ($type == "getApprovalStatus") {
    $TripId = $_REQUEST['TripId'];
    //Added By HJ On 29-08-2020 For Optimization trips Table Query Start
    if (isset($tripDetailsArr['trips_' . $TripId])) {
        $row = $tripDetailsArr['trips_' . $TripId];
    } else {
        $row = $obj->MySQLSelect("SELECT * FROM `trips` WHERE iTripId = '" . $TripId . "'");
        $tripDetailsArr['trips_' . $TripId] = $row;
    }
    //Added By HJ On 29-08-2020 For Optimization trips Table Query End
    $eApprovelStatus = $row[0]['eApproveByUser'];
    //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
    $DriverId = $row[0]['iDriverId'];
    if (isset($userDetailsArr['register_driver_' . $DriverId])) {
        $rows = $userDetailsArr['register_driver_' . $DriverId];
    } else {
        $rows = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId='" . $DriverId . "'");
        $userDetailsArr['register_driver_' . $DriverId] = $rows;
    }
    //Added By HJ On 29-08-2020 For Optimize register_user Table Query Start
    $vLanguage = $rows[0]['vLang'];
    if ($eApprovelStatus == 'Yes') {
        $sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_APPROVE_STATUS_FOUND' AND vCode = '$vLanguage'";
        $db_label_lbl = $obj->MySQLSelect($sqlverifycode);
        $LBL_APPROVE_STATUS_FOUND = $db_label_lbl[0]['vValue'];
        $returnArr['Action'] = "1";
        $returnArr['message'] = $LBL_APPROVE_STATUS_FOUND;
        $returnArr['eApproved'] = $eApprovelStatus;
    } else if ($eApprovelStatus == 'No') {
        $sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_APPROVE_STATUS_NOT_FOUND' AND vCode = '$vLanguage'";
        $db_label_lbl = $obj->MySQLSelect($sqlverifycode);
        $LBL_APPROVE_STATUS_NOT_FOUND = $db_label_lbl[0]['vValue'];
        $returnArr['Action'] = "1";
        $returnArr['message'] = $LBL_APPROVE_STATUS_NOT_FOUND;
        $returnArr['eApproved'] = $eApprovelStatus;
    } else {
        // $sqlverifycode = "SELECT * FROM `language_label` WHERE vLabel = 'LBL_APPROVE_STATUS_NOT_FOUND' AND vCode = 'EN'";
        // $db_label_lbl = $obj->MySQLSelect($sqlverifycode);
        //
        // $LBL_APPROVE_STATUS_NOT_FOUND = $db_label_lbl[0]['vValue'];
        $returnArr['Action'] = "0";
        $returnArr['message'] = "Approvel Status found empty";
        $returnArr['eApproved'] = $eApprovelStatus;
    }
    setDataResponse($returnArr);
}
###########################################################################
//Added By HV On 29-08-2020 As discussed with KS
if ($type == "getBanners") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $eCatType = isset($_REQUEST['eCatType']) ? clean($_REQUEST['eCatType']) : '';
    if ($iMemberId != "") {
        $vLanguage = get_value('register_user', 'vLang', 'iUserId', $iMemberId, '', 'true');
    }
    if ($vLanguage == "" || $vLanguage == NULL) {
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query Start
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
        //Added By HJ On 15-07-2020 For Optimize language_master Table Query End
    }
    $banners = $obj->MySQLSelect("SELECT vImage FROM `banners` WHERE vCode = '" . $vLanguage . "' AND eStatus = 'Active' AND iServiceId = '" . $iServiceId . "' AND eType = 'General' ORDER BY iDisplayOrder ASC");
    if (in_array($eCatType, ['Genie', 'Runner', 'Anywhere']) && $MODULES_OBJ->isEnableAnywhereDeliveryFeature()) {
        if ($eCatType == "Genie" || $eCatType == "Anywhere") {
            $eCatType = "Genie";
        }
        $banners = $obj->MySQLSelect("SELECT vImage FROM `banners` WHERE vCode = '" . $vLanguage . "' AND eStatus = 'Active' AND eType = '" . $eCatType . "' AND eFor = 'General' ORDER BY iDisplayOrder ASC");
    }
    $data = array();
    $count = 0;
    for ($i = 0; $i < count($banners); $i++) {
        if ($banners[$i]['vImage'] != "") {
            $data[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . urlencode($banners[$i]['vImage']);
            $count++;
        }
    }
    if (empty($data)) {
        $data = '';
    }
    $returnArr['Action'] = "1";
    $returnArr['message'] = $data;
    setDataResponse($returnArr);
}
//Added By HV On 29-08-2020 As discussed with KS End

// ########################## Added by HV on 29-09-2020 for Upload ID Proof for Age feature ##########################################################
if ($type == "UploadIdProof") {
    $iTripId = isset($_REQUEST['iTripId']) ? $_REQUEST['iTripId'] : '';
    $iOrderId = isset($_REQUEST['iOrderId']) ? $_REQUEST['iOrderId'] : '';
    $image_name = $vImage = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    if ($image_name != '') {
        $img_path = $tconfig["tsite_upload_id_proof_service_categories_images_path"];
        $temp_gallery = $img_path . '/';
        $filecheck = basename($image_name);
        $fileextarr = explode(".", $filecheck);
        $ext = strtolower($fileextarr[count($fileextarr) - 1]);
        if ($ext != "jpg" && $ext != "gif" && $ext != "png" && $ext != "jpeg" && $ext != "bmp") {
            $var_msg = "Not valid image extension of .jpg, .jpeg, .gif, .png";
            $returnArr['Action'] = "0";
            $returnArr['message'] = $var_msg;
            setDataResponse($returnArr);
        }
        if (!empty($iOrderId)) {
            $check_file_query = "select vIdProofImg from orders where iOrderId=" . $iOrderId;
            $Photo_Gallery_folder = $img_path . '/Orders/';
        } else {
            $check_file_query = "select vIdProofImg from orders where iTripId=" . $iTripId;
            $Photo_Gallery_folder = $img_path . '/Trips/';
        }
        $check_file = $obj->sql_query($check_file_query);
        $oldImage = $check_file[0]['vImgName'];
        $check_file = $img_path . '/' . $oldImage;
        if ($oldImage != '' && file_exists($check_file)) {
            @unlink($img_path . '/' . $oldImage);
        }
        if (!is_dir($Photo_Gallery_folder)) {
            mkdir($Photo_Gallery_folder, 0777);
            chmod($Photo_Gallery_folder, 0777);
        }
        $img1 = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $image_name, '', 'jpg,png,gif,jpeg');
        $vImgName = $img1[0];
        $Data_update['vIdProofImg'] = $vImgName;
        if (!empty($iOrderId)) {
            $where_order = " iOrderId  = '$iOrderId'";
            $obj->MySQLQueryPerform("orders", $Data_update, 'update', $where_order);
        } else {
            $where_trip = " iTripId  = '$iTripId'";
            $obj->MySQLQueryPerform("trips", $Data_update, 'update', $where_trip);
        }
        $returnArr['Action'] = "1";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
// ########################## Added by HV on 29-09-2020 for Upload ID Proof for Age feature End ################################################

// ########################## Added by HV on 26-03-2021 to get online drivers  ################################################
if ($type == "getOnlineDriversRideDelivery") {
    $PickUpLatitude = isset($_REQUEST["PickUpLatitude"]) ? $_REQUEST["PickUpLatitude"] : '0.0';
    $PickUpLongitude = isset($_REQUEST["PickUpLongitude"]) ? $_REQUEST["PickUpLongitude"] : '0.0';
    $PickUpAddress = isset($_REQUEST["PickUpAddress"]) ? $_REQUEST["PickUpAddress"] : '';
    $DestLatitude = isset($_REQUEST["DestLatitude"]) ? $_REQUEST["DestLatitude"] : '';
    $DestLongitude = isset($_REQUEST["DestLongitude"]) ? $_REQUEST["DestLongitude"] : '';
    $DestAddress = isset($_REQUEST["DestAddress"]) ? $_REQUEST["DestAddress"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';
    $address_data = array();
    $address_data['PickUpAddress'] = $PickUpAddress;
    $address_data['DropOffAddress'] = $DestAddress;
    $DropOff = "No";
    if ($DestLatitude != "" && $DestLongitude != "") {
        $DropOff = "Yes";
    }
    $DataArr = FetchAvailableDrivers($PickUpLatitude, $PickUpLongitude, $address_data, $DropOff, "No", "No", "", $DestLatitude, $DestLongitude, $eType, "", "");
    $db_ridedelivery_vehicle = $obj->MySQLSelect("SELECT GROUP_CONCAT(iVehicleTypeId) as VehicleTypeId FROM `vehicle_type` WHERE eType IN ('Ride', 'Deliver')");
    foreach ($DataArr['DriverList'] as $key => $driver) {
        $VehicleTypeId = $db_ridedelivery_vehicle[0]['VehicleTypeId'];
        $VehicleTypeIdArr = explode(",", $VehicleTypeId);
        $vCarType = get_value('driver_vehicle', 'vCarType', 'iDriverVehicleId', $driver['iDriverVehicleId'], '', 'true');
        $drivercartypeArr = explode(",", $vCarType);
        $vCarTypeArr = array_intersect($VehicleTypeIdArr, $drivercartypeArr);
        $vCarTypeArr = array_values($vCarTypeArr);
        $vCarType = $vCarTypeArr[0];
        $eIconType = get_value('vehicle_type', 'eIconType', 'iVehicleTypeId', $vCarType, '', 'true');
        $ic = "";
        if (strtolower($eIconType) == "car") {
            $ic = "ic_car";
        } else if (strtolower($eIconType) == "bike") {
            $ic = "ic_bike";
        } else if (strtolower($eIconType) == "cycle") {
            $ic = "ic_cycle";
        } else if (strtolower($eIconType) == "truck") {
            $ic = "ic_truck";
        }
        $DataArr['DriverList'][$key]['eIconType'] = $ic;
    }
    $returnArr['Action'] = "1";
    $returnArr['DriverList'] = $DataArr['DriverList'];
    setDataResponse($returnArr);
}
// ########################## Added by HV on 26-03-2021 to get online drivers End ################################################

if ($type == "SearchService") {
    $search_keyword = isset($_REQUEST['search_keyword']) ? $_REQUEST['search_keyword'] : "";
    $iUserId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $vLang = isset($_REQUEST['vGeneralLang']) ? $_REQUEST['vGeneralLang'] : "";
    if (empty($search_keyword)) {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
        setDataResponse($returnArr);
    }
    if (empty($vLang)) {
        $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $subquery = " AND eType != 'VideoConsult'";
    if (!$MODULES_OBJ->isRideFeatureAvailable()) {
        $subquery .= " AND eType != 'Ride'";
    }
    if (!$MODULES_OBJ->isDeliveryFeatureAvailable() && !$MODULES_OBJ->isDeliverAllFeatureAvailable()) {
        $subquery .= " AND eType != 'Deliver'";
    }
    if (!$MODULES_OBJ->isUberXFeatureAvailable()) {
        $subquery .= " AND eType != 'UberX'";
    }
    if (!$MODULES_OBJ->isEnableBiddingServices()) {
        $subquery .= " AND eType != 'Bidding'";
    }
    $master_service_categories = $obj->MySQLSelect("SELECT JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $vLang . "')) as vCategoryName, eType FROM $master_service_category_tbl WHERE 1 = 1 $subquery AND eStatus != 'Deleted' AND eType NOT IN ('MedicalServices','RentItem','RentCars','RentEstate', 'NearBy', 'TrackService', 'RideShare', 'TrackAnyService') ");
    foreach ($master_service_categories as $key => $value) {
        if ($value['eType'] == 'Bidding' && $MODULES_OBJ->isEnableBiddingServices()) {
            $master_service_categories[$key]['SubCategories'] = $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $vLang);
        } else {
            $ssql = getMasterServiceCategoryQuery($value['eType']);
            $vehicleCategoryArr = $obj->MySQLSelect("SELECT iVehicleCategoryId, vCategory_$vLang as vCategory, eCatType, iServiceId, vListLogo2,vListLogo3, iParentId FROM vehicle_category WHERE 1 = 1 AND iParentId = '0' AND eStatus = 'Active' AND iVehicleCategoryId  NOT IN (185,297,339) $ssql");
            $master_service_categories[$key]['SubCategories'] = $vehicleCategoryArr;
        }
    }

    $vehicleTypeArr = array();
    $vehicleTypeData = $obj->MySQLSelect("SELECT iVehicleTypeId,iVehicleCategoryId FROM vehicle_type WHERE eStatus='Active'");
    for ($g = 0; $g < count($vehicleTypeData); $g++) {
        $vehicleTypeArr[$vehicleTypeData[$g]['iVehicleCategoryId']][] = $vehicleTypeData[$g];
    }

    foreach ($master_service_categories as $key => $value) {
        foreach ($value['SubCategories'] as $skey => $service) {
            $vLogo = $service['vListLogo2'];
            if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()) {
                $vLogo = $service['vListLogo3'];
            }
            $master_service_categories[$key]['SubCategories'][$skey]['vLogo'] = ($vLogo != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $service['iVehicleCategoryId'] . '/' . $vLogo : "";
            $master_service_categories[$key]['SubCategories'][$skey]['vParentCategoryName'] = $service['vCategory'];
            if ($master_service_categories[$key]['SubCategories'][$skey]['vParentCategoryName'] == "Delivery Genie") {
                $master_service_categories[$key]['SubCategories'][$skey]['eCatType'] = "Anywhere";
            }
            if ($service['eCatType'] == 'Bidding' && $MODULES_OBJ->isEnableBiddingServices()) {
                $master_service_categories[$key]['SubCategories'][$skey]['vLogo'] = $service['vLogo_image'];
                $vehicle_sub_category_arr = $BIDDING_OBJ->getBiddingSubCategory('webservice', $service['iBiddingId'], '', '', '', $vLang);
            } else {
                $vehicle_sub_category_arr = $obj->MySQLSelect("SELECT vc1.iVehicleCategoryId, vc1.vCategory_$vLang as vCategory, vc1.eCatType, vc1.iServiceId, vc1.vLogo, vc1.iParentId, vc2.vCategory_$vLang as vParentCategoryName FROM vehicle_category as vc1 LEFT JOIN vehicle_category as vc2 ON vc2.iVehicleCategoryId = vc1.iParentId WHERE 1 = 1 AND vc1.iParentId = '" . $service['iVehicleCategoryId'] . "' AND vc1.eStatus = 'Active'");
            }
            if (!empty($vehicle_sub_category_arr) && count($vehicle_sub_category_arr) > 0) {
                foreach ($vehicle_sub_category_arr as $subkey => $sub_service) {
                    if ($sub_service['eCatType'] == "MultipleDelivery" || $sub_service['eCatType'] == "Delivery" || $sub_service['eCatType'] == "MotoDelivery") {
                        if ($sub_service['iParentId'] == '178') {
                            unset($vehicle_sub_category_arr[$subkey]);
                        }
                        $vehicle_sub_category_arr_new = $obj->MySQLSelect("SELECT vc1.iVehicleCategoryId, vc1.vCategory_$vLang as vCategory, vc1.eCatType, vc1.iServiceId, vc1.vLogo, vc1.iParentId, vc2.vCategory_$vLang as vParentCategoryName FROM vehicle_category as vc1 LEFT JOIN vehicle_category as vc2 ON vc2.iVehicleCategoryId = vc1.iParentId WHERE 1 = 1 AND vc1.iParentId = '" . $sub_service['iVehicleCategoryId'] . "' AND vc1.eStatus = 'Active'");
                        foreach ($vehicle_sub_category_arr_new as $k => $vale) {
                            if ($vale['eCatType'] == "MotoDelivery" || $vale['eCatType'] == "Delivery") {
                                $vale['vCategory'] = $vale['vCategory'] . " (" . $vale['vParentCategoryName'] . ")";
                            }
                            // $master_service_categories[$key]['SubCategories'][] = $vale;
                            $vehicle_sub_category_arr[] = $vale;
                        }
                    }
                }
            }

            if (!empty($vehicle_sub_category_arr) && count($vehicle_sub_category_arr) > 0) {
                foreach ($vehicle_sub_category_arr as $subkey => $sub_service) {
                    /*if ($sub_service['eCatType'] == "MultipleDelivery") {
                        $vehicle_sub_category_arr[$subkey]['eCatType'] = "Delivery";
                        $vehicle_sub_category_arr[$subkey]['eDeliveryType'] = "Multi";
                    }
                    if ($sub_service['eCatType'] == "Delivery") {
                       $vehicle_sub_category_arr[$subkey]['eDeliveryType'] = "Single";
                    }*/

                    if($sub_service['eCatType'] == "ServiceProvider" && $sub_service['iParentId'] > 0 && !isset($vehicleTypeArr[$sub_service['iVehicleCategoryId']])) {
                        unset($vehicle_sub_category_arr[$subkey]);
                    } else {
                        if (stripos($sub_service['vCategory'], $search_keyword) === false) {
                            unset($vehicle_sub_category_arr[$subkey]);
                        }    
                    }
                    
                }
                $vehicle_sub_category_arr = array_values($vehicle_sub_category_arr);
                if (!empty($vehicle_sub_category_arr) && count($vehicle_sub_category_arr) > 0) {
                    $master_service_categories[$key]['SubCategories'][$skey]['SubCategories'] = $vehicle_sub_category_arr;
                } else {
                    if (stripos($service['vCategory'], $search_keyword) === false) {
                        unset($master_service_categories[$key]['SubCategories'][$skey]);
                    }
                }
            } else {
                if (stripos($service['vCategory'], $search_keyword) === false) {
                    unset($master_service_categories[$key]['SubCategories'][$skey]);
                }
            }
        }
        $master_service_categories[$key]['SubCategories'] = array_values($master_service_categories[$key]['SubCategories']);
    }
    $searchDataArr = array();
    foreach ($master_service_categories as $key => $value) {
        if (!empty($value['SubCategories'])) {
            foreach ($value['SubCategories'] as $skey => $service) {
                if (isset($service['SubCategories']) && !empty($service['SubCategories'])) {
                    foreach ($service['SubCategories'] as $subkey => $sub_service) {
                        $sub_service['vLogo'] = ($sub_service['vLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $sub_service['iVehicleCategoryId'] . '/android/' . $sub_service['vLogo'] : "";
                        if ($service['eCatType'] == 'Bidding') {
                            $sub_service['vLogo'] = $sub_service['vLogo_image'];
                        }
                        if ($sub_service['iServiceId'] > 0) {
                            $scsqlData = $obj->MySQLSelect("SELECT iServiceId,eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $vLang . "')) as tProofNote from service_categories WHERE iServiceId = '" . $sub_service['iServiceId'] . "'");
                            $eShowTerms = $eProofUpload = "No";
                            $tProofNote = "";
                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                $eShowTerms = $scsqlData[0]['eShowTerms'];
                            }
                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                $eProofUpload = $scsqlData[0]['eProofUpload'];
                                if (is_null($scsqlData[0]['tProofNote']) || $scsqlData[0]['tProofNote'] == "null") {
                                    $scsqlData[0]['tProofNote'] = "";
                                }
                                $tProofNote = $scsqlData[0]['tProofNote'];
                            }
                            $sub_service['eShowTerms'] = $eShowTerms;
                            $sub_service['tProofNote'] = $tProofNote;
                            $sub_service['eProofUpload'] = $eProofUpload;
                        }
                        $searchDataArr[] = $sub_service;
                    }
                } else {
                    if ($service['iServiceId'] > 0) {
                        $scsqlData = $obj->MySQLSelect("SELECT iServiceId,eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $vLang . "')) as tProofNote from service_categories WHERE iServiceId = '" . $service['iServiceId'] . "'");
                        $eShowTerms = $eProofUpload = "No";
                        $tProofNote = "";
                        if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                            $eShowTerms = $scsqlData[0]['eShowTerms'];
                        }
                        if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                            $eProofUpload = $scsqlData[0]['eProofUpload'];
                            if (is_null($scsqlData[0]['tProofNote']) || $scsqlData[0]['tProofNote'] == "null") {
                                $scsqlData[0]['tProofNote'] = "";
                            }
                            $tProofNote = $scsqlData[0]['tProofNote'];
                        }
                        $service['eShowTerms'] = $eShowTerms;
                        $service['tProofNote'] = $tProofNote;
                        $service['eProofUpload'] = $eProofUpload;
                    }
                    $searchDataArr[] = $service;
                }
            }
        }
    }
    $searchServiceID = array();
    foreach ($searchDataArr as $key => $value) {
        if ($value['iServiceId'] > 0) {
            if (in_array($value['iServiceId'], $searchServiceID)) {
                unset($searchDataArr[$key]);
            } else {
                $searchServiceID[] = $value['iServiceId'];
            }
        }
    }
    $searchDataArr = array_values($searchDataArr);
    if (!empty($searchDataArr)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $searchDataArr;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}
if ($type == "getDriverStats") {
    $iDriverId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $dateRange = isset($_REQUEST["dateRange"]) ? $_REQUEST["dateRange"] : 'today';
    $startDate = isset($_REQUEST["startDate"]) ? $_REQUEST["startDate"] : '';
    $endDate = isset($_REQUEST["endDate"]) ? $_REQUEST["endDate"] : '';
    $lang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $duration_sql = '';
    $duration_sql_1 = '';
    if (!empty($dateRange)) {
        if (strtolower($dateRange) == "today") {
            $start_date = date('Y-m-d 00:00:00');
            $end_date = date('Y-m-d 23:59:59');
        } elseif (strtolower($dateRange) == "week") {
            $start_date = date('Y-m-d', strtotime('sunday this week -1 week'));
            $end_date = date('Y-m-d', strtotime('saturday this week'));
        } elseif (strtolower($dateRange) == "month") {
            $start_date = date('Y-m-01 00:00:00');
            $end_date = date('Y-m-t 23:59:59');
        } elseif (strtolower($dateRange) == "range") {
            $start_date = date('Y-m-d 00:00:00', strtotime($startDate));
            $end_date = date('Y-m-d 23:59:59', strtotime($endDate));
        }
        $avg_rating = CalculateMemberAvgRating($iDriverId, 'Driver', $start_date, $end_date);
        $duration_sql = " AND tEndDate BETWEEN '" . $start_date . "' AND '" . $end_date . "' ";
        $duration_sql_2 = " AND tTripRequestDate BETWEEN '" . $start_date . "' AND '" . $end_date . "' ";
        $duration_sql_3 = " AND t.tTripRequestDate BETWEEN '" . $start_date . "' AND '" . $end_date . "' ";
        $duration_sql_4 = " AND b.dBiddingDate BETWEEN '" . $start_date . "' AND '" . $end_date . "' ";
        $start_date = date('Y-m-d H:i:s', strtotime("-30 minutes"));
        $duration_sql_1 = " AND dBooking_date BETWEEN '" . $start_date . "' AND '" . $end_date . "' ";
    }
    if (empty($lang)) {
        $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
    /* ------------------------------- total trip ------------------------------- */
    $trips = $obj->MySQLSelect("SELECT iDriverId ,COUNT(case when iActive != '' AND (iActive = 'Finished' || iActive = 'Canceled') then 1 else NULL  end) `minimum_trip`  FROM `trips` WHERE `iDriverId` = " . $iDriverId . " $duration_sql ");
    $returnArr['total_trip'] = array('vtitle' => (strtolower($dateRange) == "today") ? $languageLabelsArr['LBL_TRIP_TODAY'] : $languageLabelsArr['LBL_TRIP'], 'value' => ($trips[0]['minimum_trip'] > 0 && empty($trips[0]['minimum_trip']) == false) ? $trips[0]['minimum_trip'] : '0', 'color' => RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)], 'vBgColor' => '#C4EBEA', 'vTextColor' => '#000000');
    /* ------------------------------- total trip ------------------------------- */
    /* ------------------------------- avg rating ------------------------------- */
    $returnArr['avg_rating'] = array('vtitle' => $languageLabelsArr['LBL_AVG_RATING'], 'value' => ($avg_rating > 0) ? $avg_rating : '0', 'color' => RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)], 'vBgColor' => '#FCD9D8', 'vTextColor' => '#000000');
    /* ------------------------------- avg rating ------------------------------- */
    /* -------------------- pending_count and upcoming_count -------------------- */
    if ($MODULES_OBJ->isUberXFeatureAvailable()) {
        $getBookingData = $obj->MySQLSelect("SELECT iCabBookingId,eStatus FROM cab_booking WHERE iDriverId = '" . $iDriverId . "' $duration_sql_1 ");
        $db_data_pending = $db_data_assign = array();
        for ($g = 0; $g < count($getBookingData); $g++) {
            $eStatus = $getBookingData[$g]['eStatus'];
            if (strtoupper($eStatus) == "PENDING") {
                $db_data_pending[] = $getBookingData[$g]['iCabBookingId'];
            }
            if (strtoupper($eStatus) == "ACCEPTED" || strtoupper($eStatus) == "ASSIGN") {
                $db_data_assign[] = $getBookingData[$g]['iCabBookingId'];
            }
        }
        $returnArr['pending_count'] = array('vtitle' => $languageLabelsArr['LBL_PENDING_JOBS'], 'value' => (count($db_data_pending) > 0 && empty($db_data_pending) == false) ? count($db_data_pending) : '0', 'color' => RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)], 'vBgColor' => '#CAFFE2', 'vTextColor' => '#000000');
        $returnArr['upcoming_count'] = array('vtitle' => $languageLabelsArr['LBL_UPCOMING_JOBS'], 'value' => (count($db_data_assign) > 0 && empty($db_data_assign) == false) ? count($db_data_assign) : '0', 'color' => RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)], 'vBgColor' => '#FFF0C3', 'vTextColor' => '#000000');
    } else {
        $returnArr['pending_count'] = '';
        $returnArr['upcoming_count'] = '';
    }
    /* -------------------- pending_count and upcoming_count -------------------- */
    /* ------------------------------ your_earning ------------------------------ */
    //$sql = "SELECT fDeliveryCharge,eSystem,eType,fHotelCommision,fAddedOutstandingamt,fOutStandingAmount,fTax2,fTax1,fCommision,fTipPrice,fTripGenerateFare,iTripId,iActive,fCancellationFare,fWalletDebit FROM trips WHERE iDriverId='" . $iDriverId . "' $duration_sql_2";
    $sql = "SELECT t.fTipPrice as fTipAmountTrip,t.fDeliveryCharge,t.eSystem,t.eType,t.fHotelCommision,t.fAddedOutstandingamt,t.fOutStandingAmount,t.fTax2,t.fTax1,t.fCommision,t.fTipPrice,t.fTripGenerateFare,t.iTripId,t.iActive,t.fCancellationFare,t.fWalletDebit,t.iOrderId 
            FROM trips as t 
            WHERE t.iDriverId='" . $iDriverId . "' $duration_sql_3";
    $tripData = $obj->MySQLSelect($sql);
    //eType = 'Ride' AND eSystem = 'DeliverAll'
    $totalEarnings = 0;
    for ($t = 0; $t < count($tripData); $t++) {
        $iTripId = $tripData[$t]['iTripId'];
        $iActive = $tripData[$t]['iActive'];
        $iOrderId = $tripData[$t]['iOrderId'];
        $fTipPrice = $tripData[$t]['fTipPrice'];
        $fCancellationFare = $fWalletDebit = 0;
        if (isset($tripData[$t]['fCancellationFare'])) {
            $fCancellationFare = $tripData[$t]['fCancellationFare'];
        }
        if (isset($tripData[$t]['fWalletDebit'])) {
            $fWalletDebit = $tripData[$t]['fWalletDebit'];
        }
        $earning = $tripData[$t]['fTripGenerateFare'];
        if ($tripData[$t]['eType'] == 'Ride' && $tripData[$t]['eSystem'] == 'DeliverAll') {
            $earning = $tripData[$t]['fDeliveryCharge'];
        }
        if ($tripData[$t]['eSystem'] == 'DeliverAll') {
            $sql1 = "SELECT fTipAmount FROM orders WHERE iOrderId = '" . $iOrderId . "'";
            $orderData = $obj->MySQLSelect($sql1);
            $fTipPrice = $orderData[0]['fTipAmount'];
        }
        if ($iActive == "Finished" || ($iActive == "Canceled" && ($fCancellationFare > 0 || $fWalletDebit > 0))) {
            $iFare = $earning + $fTipPrice - $tripData[$t]['fCommision'] - $tripData[$t]['fTax1'] - $tripData[$t]['fTax2'] - $tripData[$t]['fOutStandingAmount'] - $tripData[$t]['fAddedOutstandingamt'] - $tripData[$t]['fHotelCommision'];
            $iFareSum = str_replace(',', '', $iFare);
            $totalEarnings += $iFareSum;
        }
    }
    if ($MODULES_OBJ->isEnableBiddingServices()) {
        $sql = "SELECT b.iBiddingPostId FROM bidding_post b WHERE  b.eStatus = 'Completed' AND b.iDriverId = '" . $iDriverId . "' {$duration_sql_4} ";
        $biddingData = $obj->MySQLSelect($sql);
        for ($t = 0; $t < count($biddingData); $t++) {
            $iFare = $BIDDING_OBJ->getDriverEarning($biddingData[$t]['iBiddingPostId'])['DriverEarning'];
            $iFareSum = str_replace(',', '', $iFare);
            $totalEarnings += $iFareSum;
        }
        $returnArr['total_trip']['value'] += count($biddingData);
    }
    $register_driver = $obj->MySQLSelect("SELECT vCurrencyDriver,vAvgRating , tRegistrationDate FROM `register_driver` WHERE `iDriverId` = " . $iDriverId . " ");
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $register_driver[0]['vCurrencyDriver'] . "'");
    $totalEarning = formateNumAsPerCurrency($totalEarnings * $currency[0]['ratio'], $register_driver[0]['vCurrencyDriver']);
    $returnArr['your_earning'] = array('vtitle' => (strtolower($dateRange) == "today") ? $languageLabelsArr['LBL_YOUR_EARNINGS_TODAY'] : $languageLabelsArr['LBL_YOUR_EARNINGS'], 'value' => $totalEarning,);
    /* ------------------------------ your_earning ------------------------------ */
    $returnArr['Action'] = "1";
    setDataResponse($returnArr);
}
/* --------------------------------- BIDDING START -------------------------------- */
if ($type == "PostBid") {
    $iUserId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $vGeneralLang = isset($_REQUEST['vGeneralLang']) ? $_REQUEST['vGeneralLang'] : "";
    $iBiddingId = isset($_REQUEST['iBiddingId']) ? $_REQUEST['iBiddingId'] : "";
    $vServiceName = isset($_REQUEST['vServiceName']) ? $_REQUEST['vServiceName'] : "";
    $tDescription = isset($_REQUEST['tDescription']) ? $_REQUEST['tDescription'] : "";
    $fBiddingAmount = isset($_REQUEST['fBiddingAmount']) ? $_REQUEST['fBiddingAmount'] : "";
    $dBiddingDate = isset($_REQUEST['dBiddingDate']) ? $_REQUEST['dBiddingDate'] : "";
    $iAddressId = isset($_REQUEST['iAddressId']) ? $_REQUEST['iAddressId'] : "";
    $vContactName = isset($_REQUEST['vContactName']) ? $_REQUEST['vContactName'] : "";
    $ibiddingPostMediaId = isset($_REQUEST['ibiddingPostMediaId']) ? $_REQUEST['ibiddingPostMediaId'] : "";
    $vTimeZone = isset($_REQUEST['vTimeZone']) ? $_REQUEST['vTimeZone'] : "";


    $lang = $vGeneralLang;
    $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$iUserId'");
    $lang = $row[0]['vLang'];
    if ($lang == "" || $lang == NULL) {
        $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $row[0]['vCurrencyPassenger'] . "'");
    $systemTimeZone = date_default_timezone_get();
    $tStartDate = converToTz($dBiddingDate, $systemTimeZone, $vTimeZone);
    $biddingPost = array();
    $bidding_Post_Array = array();
    $biddingPost['iUserId'] = $iUserId;
    $biddingPost['iBiddingId'] = $iBiddingId;
    $biddingPost['fBiddingAmount'] = $fBiddingAmount / $currency[0]['ratio'];
    $biddingPost['dBiddingDate'] = $tStartDate;
    $biddingPost['iAddressId'] = $iAddressId;
    $biddingPost['vContactName'] = $vContactName;
    $biddingPost['vTimeZone'] = $vTimeZone;
    $biddingPost['vBiddingPostNo'] = rand(10000000, 99999999);
    $biddingPost['vCurrencyPassenger'] = $currency[0]['vName'];
    $biddingPost['tDescription'] = $tDescription;
    $biddingPost['dAddedDate'] = date('Y-m-d H:i:s');
    $parentData = $BIDDING_OBJ->getParentBiddingCategory($iBiddingId);
    $biddingPost['fCommission'] = $parentData['fCommission'];
    if ($iBiddingId == $BIDDING_OBJ->other_id) {
        $bidding_Post_Array = $biddingPost;
        $biddingPost['vServiceName'] = $vServiceName;
        $otherSubCategoryId = $BIDDING_OBJ->createOtherSubcategory('webservice', $biddingPost, $lang);
        $bidding_Post_Array['iBiddingId'] = $otherSubCategoryId;
    } else {
        $bidding_Post_Array = $biddingPost;
    }
    $currency_all = $obj->MySQLSelect("SELECT * FROM currency WHERE eStatus = 'Active'");
    for ($i = 0; $i < count($currency_all); $i++) {
        $bidding_Post_Array['fRatio_' . $currency_all[$i]['vName']] = $currency_all[$i]['Ratio'];
    }
    $biddingPostId = $BIDDING_OBJ->createBiddingPost('webservice', $bidding_Post_Array);
    if (isset($ibiddingPostMediaId) && !empty($ibiddingPostMediaId)) {
        $BIDDING_OBJ->EditBiddingPostMedia($ibiddingPostMediaId, $biddingPostId);
    }
    /* ---------------------------- send notification --------------------------- */
    if (!empty($biddingPostId)) {
        $biddingPostId_driverdata = $BIDDING_OBJ->sendRequestToDriver('webservice', $biddingPostId);
        if (count($biddingPostId_driverdata)) {
            $message_notification = str_replace(array('#TASK_NO#'), array('#' . $biddingPost['vBiddingPostNo']), $languageLabelsArr['LBL_BIDDING_REQUEST_RECEIVED_TXT']);
            $alertMsg_db = $message_notification;
            $final_message['Message'] = "BiddingTaskReceived";
            $final_message['MsgType'] = "BiddingTaskReceived";
            $final_message['iBiddingPostId'] = $biddingPostId;
            $final_message['vTitle'] = $message_notification;
            $final_message['eType'] = "Bidding";
            foreach ($biddingPostId_driverdata as $item) {
                $bidding_Request_Driver['iDriverId'] = '';
                $bidding_Request_Driver['iDriverId'] = $item['iDriverId'];
                $bidding_Request_Driver['eStatus'] = 'Pending';
                $bidding_Request_Driver['iBiddingPostId'] = $biddingPostId;
                $bidding_Request_Driver['iRequestDate'] = gmdate("Y-m-d H:i:s");
                $BIDDING_OBJ->saveBiddingRequestToDriver('webservice', $bidding_Request_Driver);
                $generalDataArr[] = array('eDeviceType' => $item['eDeviceType'], 'deviceToken' => $item['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $item['eAppTerminate'], 'eDebugMode' => $item['eDebugMode'], 'eHmsDevice' => $item['eHmsDevice'], 'message' => $final_message, 'channelName' => "CAB_REQUEST_DRIVER_" . $item['iDriverId']);
            }
            $data = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
        }
    }
    /* ---------------------------- send notification --------------------------- */
    if (!empty($biddingPostId)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = 'LBL_BIDDING_POSTED_MSG';
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}

if ($type == "getBiddingPosts") {
    $vGeneralLang = isset($_REQUEST['vGeneralLang']) ? $_REQUEST['vGeneralLang'] : "";
    $vFilterParam = isset($_REQUEST['vSubFilterParam']) ? $_REQUEST['vSubFilterParam'] : "";
    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? $_REQUEST['GeneralUserType'] : "Passenger";
    if ($GeneralUserType == "Driver") {
        $vFromDate = isset($_REQUEST['vFromDate']) ? $_REQUEST['vFromDate'] : '';
    }
    if (empty($vFromDate)) {
        $vFromDate = date('Y-m-d');
    }
    $lang = $vGeneralLang;
    $systemTimeZone = date_default_timezone_get();
    $iDriverId = $iUserId = "";
    if ($GeneralUserType == "Driver") {
        $iDriverId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
        $row = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId='$iDriverId'");
        $lang = $row[0]['vLang'];
        $vCurrency = $row[0]['vCurrencyDriver'];
        if (isset($row[0]['vTimeZone']) && !empty($row[0]['vTimeZone'])) {
            $vTimeZoneMember = $row[0]['vTimeZone'];
        }
    } else {
        $iUserId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
        $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$iUserId'");
        $lang = $row[0]['vLang'];
        $vCurrency = $row[0]['vCurrencyPassenger'];
        if (isset($row[0]['vTimeZone']) && !empty($row[0]['vTimeZone'])) {
            $vTimeZoneMember = $row[0]['vTimeZone'];
        }
    }
    if ($lang == "" || $lang == NULL) {
        $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
    if ($GeneralUserType == "Driver") {
        if ($vFilterParam == '') {
            $FilterPriority = $BIDDING_OBJ->getFilterPriority($iDriverId)['filter'];
            $vFilterParam = $FilterPriority;
        }
    }
    //$systemTimeZone = date_default_timezone_get();
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
    $farray = [];
    $farray['vFilterParam'] = strtolower($vFilterParam) == "all" ? "" : $vFilterParam;
    if ($GeneralUserType == "Driver") {
        $farray['vFromDate'] = $vFromDate;
        $farray['vFilterParam'] = strtolower($vFilterParam) == "" ? "Pending" : $vFilterParam;
    }
    $biddingPostId = $BIDDING_OBJ->getBiddingPost('webservice', '', $iUserId, $lang, '', $farray, $iDriverId);
    $f_array = [];
    $f_array['vFilterParam'] = 'Completed';
    $f_array['vFromDate'] = $vFromDate;
    $BiddingDriverStats = $BIDDING_OBJ->getBiddingDriverStats('webservice', '', $iUserId, $lang, '', $f_array, $iDriverId);
    $inprocessArr = array();
    $inprocess = "No";
    if (count($biddingPostId)) {
        for ($i = 0; $i < count($biddingPostId); $i++) {
            $vTimeZone = $biddingPostId[$i]['vTimeZone'];
            if (!empty($vTimeZoneMember)) {
                $vTimeZone = $vTimeZoneMember;
            }
            /*if ($GeneralUserType == "Driver") {
                $fCommissioncalculate = round(($biddingPostId[$i]['fBiddingAmount']*$biddingPostId[$i]['fCommission'])/100,2);

                $driverearning = $biddingPostId[$i]['fBiddingAmount'] - $fCommissioncalculate;

                $biddingPostId[$i]['fBiddingAmount'] = formateNumAsPerCurrency($driverearning * $currency[0]['ratio'], $vCurrency);
            } else {*/
            $biddingPostId[$i]['eJobType'] = "Bidding";
            $biddingPostId[$i]['fBiddingAmount'] = formateNumAsPerCurrency($biddingPostId[$i]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
            /*}*/
            if ($biddingPostId[$i]['dStartDate'] == "0000-00-00 00:00:00") {
                $biddingPostId[$i]['dBiddingDate'] = converToTz($biddingPostId[$i]['dBiddingDate'], $vTimeZone, $systemTimeZone);
            } else {
                $biddingPostId[$i]['dBiddingDate'] = converToTz($biddingPostId[$i]['dStartDate'], $vTimeZone, $systemTimeZone);
            }
            if ($GeneralUserType == "Driver") {
                $buttonCheck = $BIDDING_OBJ->buttonCheck('webservice', $biddingPostId[$i]['iBiddingPostId'], $iDriverId, $iUserId);
                $biddingPostId[$i]['showAcceptBtn'] = 'Yes';
                if ($buttonCheck['showAcceptBtn'] == 'No') {
                    $biddingPostId[$i]['showAcceptBtn'] = 'No';
                }
                $biddingPostId[$i]['showDeclineBtn'] = 'Yes';
                if ($buttonCheck['showDeclineBtn'] == 'No') {
                    $biddingPostId[$i]['showDeclineBtn'] = 'No';
                }
                $biddingPostId[$i]['showDetailBtn'] = 'Yes';
                if ($buttonCheck['showDetailBtn'] == 'No') {
                    $biddingPostId[$i]['showDetailBtn'] = 'No';
                }
                if ($biddingPostId[$i]['iDriverId'] == $iDriverId && in_array($biddingPostId[$i]['eStatusMain'], ['Completed'])) {
                    $biddingPostId[$i]['eStatus'] = "Completed";
                }
                if (in_array($biddingPostId[$i]['eStatusMain'], ['Cancelled'])) {
                    $biddingPostId[$i]['eStatus'] = "Cancelled";
                }
                if ($biddingPostId[$i]['eStatus'] == "Accepted" && $biddingPostId[$i]['iDriverId'] == 0 && $GeneralUserType == "Driver") {
                    $biddingPostId[$i]['eStatus'] = "Pending";
                }
            } else {
                $biddingPostId[$i]['showCancelBtn'] = 'Yes';
                $biddingPostId[$i]['showBiddingTaskBtn'] = 'Yes';
                $biddingPostId[$i]['showDetailBtn'] = 'No';
                if ($biddingPostId[$i]['eStatus'] == "Cancelled") {
                    $biddingPostId[$i]['showCancelBtn'] = 'No';
                    $biddingPostId[$i]['showDetailBtn'] = 'Yes';
                    $biddingPostId[$i]['showBiddingTaskBtn'] = 'No';
                } else if ($biddingPostId[$i]['eStatus'] == "Accepted") {
                    $biddingPostId[$i]['showCancelBtn'] = 'No';
                    $biddingPostId[$i]['showDetailBtn'] = 'Yes';
                    $biddingPostId[$i]['showBiddingTaskBtn'] = 'No';
                } else if ($biddingPostId[$i]['eStatus'] == "Completed") {
                    $biddingPostId[$i]['showCancelBtn'] = 'No';
                    $biddingPostId[$i]['showDetailBtn'] = 'Yes';
                    $biddingPostId[$i]['showBiddingTaskBtn'] = 'No';
                }
            }
            $iBiddingId = explode(',', $biddingPostId[$i]['iBiddingId']);
            $_title = $biddingPostId[$i]['vTitle'];
            $biddingPostId[$i]['vService_TEXT_color'] = "#ffffff";
            $biddingPostId[$i]['vService_BG_color'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
            $biddingPostId[$i]['vStatus_BG_color'] = APP_THEME_COLOR;
            if (count($iBiddingId) > 1) {
                $getbidding = $BIDDING_OBJ->getbidding('webservice', $iBiddingId[0], $lang);
                $getbidding_ = $BIDDING_OBJ->getbidding('webservice', $getbidding['iParentId'], $lang);
                $biddingPostId[$i]['vTitle'] = $getbidding_['vCategory'];
                $getbidding_ = $BIDDING_OBJ->getbidding('webservice', $biddingPostId[$i]['iBiddingId'], $lang);
                $vtitle_ = $BIDDING_OBJ->multiToSingle($getbidding_, 'vCategory');
                $_title = implode(',', $vtitle_);
            }
            if ($biddingPostId[$i]['eStatus'] == "Pending" || ($biddingPostId[$i]['eStatus'] == "Reoffer" && $biddingPostId[$i]['eStatusMain'] == "Pending")) {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_PENDING"];
                $biddingPostId[$i]['bidding_statusOrg'] = "Pending";
            } else if ($biddingPostId[$i]['eStatus'] == "Accepted") {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_ACCEPTED"];
                $biddingPostId[$i]['bidding_statusOrg'] = "Accepted";
                if ($biddingPostId[$i]['iDriverId'] != $iDriverId && $GeneralUserType == "Driver") {
                    $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_CLOSED"];
                    $biddingPostId[$i]['bidding_statusOrg'] = "Closed";
                    $biddingPostId[$i]['showDetailBtn'] = 'No';
                    $biddingPostId[$i]['vStatus_BG_color'] = "#C60C0C";
                }
            } else if ($biddingPostId[$i]['eStatus'] == "Completed") {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_COMPLETED"];
                $biddingPostId[$i]['bidding_statusOrg'] = "Completed";
                if ($GeneralUserType == "Driver") {
                    $totalEarning = $BIDDING_OBJ->getDriverEarning($biddingPostId[$i]['iBiddingPostId'])['DriverEarning'];
                    $biddingPostId[$i]['totalEarning'] = formateNumAsPerCurrency($totalEarning * $currency[0]['ratio'], $vCurrency);
                    $totalEarning;
                }
            } else if ($biddingPostId[$i]['eStatusMain'] == "Cancelled" || $biddingPostId[$i]['eStatus'] == "Cancelled" || $biddingPostId[$i]['eStatus'] == "Decline") {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_CANCELLED"];
                $biddingPostId[$i]['bidding_statusOrg'] = "Cancelled";
            } else if ($biddingPostId[$i]['eStatus'] == "Closed") {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_CLOSED"];
                $biddingPostId[$i]['bidding_statusOrg'] = "Closed";
            } else {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_ALL"];
                $biddingPostId[$i]['bidding_statusOrg'] = "All";
            }
            if (in_array($biddingPostId[$i]['vTaskStatus'], ['Active', 'Arrived', 'Ongoing'])) {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_INPROCESS"];
                $biddingPostId[$i]['bidding_statusOrg'] = "In process";
                $inprocessArr[] = $biddingPostId[$i];
                $inprocess = "Yes";
            }
            if ($biddingPostId[$i]['isExpired'] == 1 && $biddingPostId[$i]['eStatus'] != "Closed") {
                $biddingPostId[$i]['bidding_status'] = $languageLabelsArr["LBL_EXPIRED_TXT"];
                $biddingPostId[$i]['bidding_statusOrg'] = "Expired";
                $biddingPostId[$i]['showCancelBtn'] = 'No';
                $biddingPostId[$i]['showBiddingTaskBtn'] = 'No';
                $biddingPostId[$i]['showDetailBtn'] = 'No';
            }

            if (isset($biddingPostId[$i]['driverImage']) && !empty($biddingPostId[$i]['driverImage']) ) {

                $imgUrl = $tconfig['tsite_upload_images_driver'];
                $biddingPostId[$i]['driverImage'] = $imgUrl . "/" . $biddingPostId[$i]['iDriverId'] . "/" . $biddingPostId[$i]['driverImage'];
            }
        }
    }
    /* --------------------------------- filter --------------------------------- */
    $AppTypeFilterArr = array();
    if ($GeneralUserType != "Driver") {
        $AppTypeFilterArr[] = array('vSubFilterParam' => 'All', 'vTitle' => 'All');
    }
    $AppTypeFilterArr[] = array('vSubFilterParam' => 'Pending', 'vTitle' => $languageLabelsArr["LBL_PENDING"]);
    $AppTypeFilterArr[] = array('vSubFilterParam' => 'Accepted', 'vTitle' => $languageLabelsArr["LBL_ACCEPTED"]);
    $AppTypeFilterArr[] = array('vSubFilterParam' => 'Inprocess', 'vTitle' => $languageLabelsArr["LBL_INPROCESS"]);
    $AppTypeFilterArr[] = array('vSubFilterParam' => 'Completed', 'vTitle' => $languageLabelsArr["LBL_COMPLETED"]);
    $AppTypeFilterArr[] = array('vSubFilterParam' => 'Cancelled', 'vTitle' => $languageLabelsArr["LBL_CANCELLED"]);
    $AppTypeFilterArr[] = array("vSubFilterParam" => "Expired", "vTitle" => $languageLabelsArr['LBL_EXPIRED_TXT']);
    if ($GeneralUserType == "Driver") {
        $AppTypeFilterArr[] = array('vSubFilterParam' => 'Closed', 'vTitle' => $languageLabelsArr["LBL_CLOSED"]);
    }
    /* --------------------------------- filter --------------------------------- */
    $returnArr['subFilterOption'] = $AppTypeFilterArr;
    if ($GeneralUserType == "Driver") {
        $returnArr['eFilterSel'] = !empty($vFilterParam) ? $vFilterParam : ($inprocess == "Yes" ? "Inprocess" : "Pending");
    } else {
        $returnArr['eFilterSel'] = !empty($vFilterParam) ? $vFilterParam : ($inprocess == "Yes" ? "Inprocess" : "All");
    }
    if (strtolower($returnArr['eFilterSel']) == "inprocess") {
        $biddingPostId = $inprocessArr;
    }
    $returnArr['TripCount'] = $BiddingDriverStats['TripCount'];
    $returnArr['TotalEarningAmount'] = $BiddingDriverStats['TotalEarningAmount'];
    $returnArr['TotalEarning'] = $BiddingDriverStats['TotalEarning'];
    $returnArr['AvgRating'] = $BiddingDriverStats['AvgRating'];
    /*--------------------- missingDate ------------------*/
    $farray['missingDate'] = 1;
    $biddingDate = $BIDDING_OBJ->getBiddingPost('webservice', '', $iUserId, $lang, '', $farray, $iDriverId);
    // $missingDate = getMissingdate($biddingDate, $vFromDate);
    // $returnArr['NO_DATA'] = $missingDate;
    $returnArr['EARNING_DATA'] = getEarningDates($biddingDate);
    /*--------------------- missingDate ------------------*/
    if (count($biddingPostId) > 0) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $biddingPostId;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_BIDS_FOUND_MSG";
    }
    setDataResponse($returnArr);
}
if ($type == "getBiddingPostInfo") {
    $vGeneralLang = isset($_REQUEST['vGeneralLang']) ? $_REQUEST['vGeneralLang'] : "";
    $vFilterParam = isset($_REQUEST['vSubFilterParam']) ? $_REQUEST['vSubFilterParam'] : "";
    $GeneralUserType = (isset($_REQUEST['GeneralUserType']) && $_REQUEST['GeneralUserType'] == "Driver") ? "Driver" : "Passenger";
    $iBiddingPostId = isset($_REQUEST['iBiddingPostId']) ? $_REQUEST['iBiddingPostId'] : "";
    $lang = $vGeneralLang;
    $iDriverId = $iUserId = '';
    if ($GeneralUserType == "Driver") {
        $iDriverId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
        $row = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM `register_driver` WHERE iDriverId='$iDriverId'");
        $lang = $row[0]['vLang'];
        $vCurrency = $row[0]['vCurrencyDriver'];
    } else {
        $iUserId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
        $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$iUserId'");
        $lang = $row[0]['vLang'];
        $vCurrency = $row[0]['vCurrencyPassenger'];
    }
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
    $getBiddingPost = $BIDDING_OBJ->getBiddingPost('webservice', $iBiddingPostId);
    /* ------------------------------ for the title ----------------------------- */
    $iBiddingId = explode(',', $getBiddingPost[0]['iBiddingId']);
    $_title = $getBiddingPost[0]['vTitle'];
    if (count($iBiddingId) > 1) {
        $getbidding_ = $BIDDING_OBJ->getbidding('webservice', $getBiddingPost[0]['iBiddingId'], $lang);
        $vtitle_ = $BIDDING_OBJ->multiToSingle($getbidding_, 'vCategory');
        $_title = implode(',', $vtitle_);
    }
    /* ------------------------------ for the title ----------------------------- */
    $biddingPostIdArr['vServiceName'] = $_title;
    $biddingPostIdArr['fBiddingAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
    $biddingPostIdArr['tDescription'] = $getBiddingPost[0]['tDescription'];
    $biddingPostIdArr['eStatus'] = $getBiddingPost[0]['eStatus'];
    $systemTimeZone = date_default_timezone_get();
    $biddingPostIdArr['dBiddingDate'] = converToTz($getBiddingPost[0]['dBiddingDate'], $getBiddingPost[0]['vTimeZone'], $systemTimeZone);
    if ($GeneralUserType == "Passenger") {
        if ($getBiddingPost[0]['eStatus'] == 'Cancelled') {
            $cancel_reason = $getBiddingPost[0]['iCancelReasonId'] > 0 ? $BIDDING_OBJ->getCancelReason($getBiddingPost[0]['iCancelReasonId'], $lang) : $getBiddingPost[0]['vCancelReason'];
            $biddingPostIdArr['cancelReason'] = $languageLabelsArr['LBL_TASK_CANCELLED_TXT'] . ': ' . $cancel_reason;
        } else {
            if ($getBiddingPost[0]['eStatus'] == 'Accepted') {
                $iDriverId = $getBiddingPost[0]['iDriverId'];
            }
            //$biddingPostIdArr['provider'] = $BIDDING_OBJ->getDriverBiddingRequest('webservice' , $iBiddingPostId , $vCurrency, $lang, $biddingPostIdArr['fBiddingAmount'], $iDriverId,$getBiddingPost);
            $biddingPostIdArr['provider'] = $BIDDING_OBJ->UserBiddingRequest($iBiddingPostId, $vCurrency, '', $iDriverId);
        }
        if ($getBiddingPost[0]['eStatus'] == 'Accepted') {
            $biddingPostIdArr['biddingfinalAmountTitle'] = $biddingPostIdArr['provider'][0]['biddingfinalAmountTitle'];
            $biddingPostIdArr['biddingFinalAmount'] = $biddingPostIdArr['provider'][0]['biddingFinalAmount'];
        }
    } else {
        $biddingPostIdArr = $BIDDING_OBJ->DriverBiddingRequest($iBiddingPostId, $vCurrency, $iDriverId);
        $biddingPostIdArr = $biddingPostIdArr[0];
    }


    $biddingPostIdArr['isMediaUploaded'] = count($BIDDING_OBJ->getBiddingMediaSQLDATA($iBiddingPostId, $iUserId, $GeneralUserType)) > 0 ? 'Yes' : 'No';
    if (count($getBiddingPost) > 0) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $biddingPostIdArr;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}
if ($type == "getBiddingServices") {
    $iDriverId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $search_keyword = isset($_REQUEST['search_keyword']) ? $_REQUEST['search_keyword'] : "";
    $lang = $vGeneralLang;
    $row = $obj->MySQLSelect("SELECT *,iDriverId  as iMemberId FROM `register_driver` WHERE iDriverId ='$iDriverId'");
    $lang = $row[0]['vLang'];
    if ($lang == "" || $lang == NULL) {
        $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
    $reqArr = ['vCategory', 'vLogo_image', 'iBiddingId'];
    $biddingServices = $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang, '', $reqArr);
    if (count($biddingServices) > 0) {
        /* ----------------------------- bidding Driver ----------------------------- */
        $biddingdriverrequest = $BIDDING_OBJ->biddingdriverrequest('webservice', $iDriverId);
        $biddingdriverrequest = $BIDDING_OBJ->multiToSingle($biddingdriverrequest, 'iBiddingId');
        $biddingdriverservice = $BIDDING_OBJ->biddingDriverService('webservice', $iDriverId);
        $biddingdriverservice = explode(',', $biddingdriverservice[0]['vBiddingId']);
        /* ----------------------------- bidding Driver ----------------------------- */
        $reqArr = ['vTitle', 'vLogo_image', 'iBiddingId'];
        for ($i = 0; $i < count($biddingServices); $i++) {
            if ($biddingServices[$i]['iBiddingId'] != $BIDDING_OBJ->other_id) {
                $SubCategory = $BIDDING_OBJ->getBiddingSubCategory('webservice', $biddingServices[$i]['iBiddingId'], '', '', '', $lang, '', $reqArr);
                /* ----------------------------- bidding Driver ----------------------------- */
                for ($j = 0; $j < count($SubCategory); $j++) {
                    if (in_array($SubCategory[$j]['iBiddingId'], $biddingdriverrequest)) {
                        $SubCategory[$j]['eServiceRequest'] = "Pending";
                    } elseif (in_array($SubCategory[$j]['iBiddingId'], $biddingdriverservice)) {
                        $SubCategory[$j]['eServiceRequest'] = "Active";
                    } else {
                        $SubCategory[$j]['eServiceRequest'] = "Inactive";
                    }
                }
                /* ----------------------------- bidding Driver ----------------------------- */
                $biddingServices[$i]['SubCategory'] = $SubCategory;
            }
        }
    }
    /* --------------------------------- search --------------------------------- */
    if (!empty($search_keyword)) {
        foreach ($biddingServices as $key => $value) {
            $main_cat = $subcat = 0;
            if (stripos($value['vCategory'], $search_keyword) !== false) {
                $main_cat = 1;
            }
            if (isset($value['SubCategory']) && $main_cat == 0) {
                foreach ($value['SubCategory'] as $skey => $sCategory) {
                    if (stripos($sCategory['vTitle'], $search_keyword) !== false) {
                        $subcat = 1;
                    } else {
                        unset($biddingServices[$key]['SubCategory'][$skey]);
                    }
                }
                if (!empty($biddingServices[$key]['SubCategory'])) {
                    $biddingServices[$key]['SubCategory'] = array_values($biddingServices[$key]['SubCategory']);
                }
            }
            if (($main_cat == 0 && $subcat == 0) || empty($biddingServices[$key]['SubCategory'])) {
                unset($biddingServices[$key]);
            }
        }
    }
    /* --------------------------------- search --------------------------------- */
    if (count($biddingServices) > 0) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = array_values($biddingServices);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}
if ($type == "updateDriverBiddingServices") {
    $iDriverId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $iReqBiddingId = isset($_REQUEST["iBiddingId"]) ? $_REQUEST["iBiddingId"] : '';
    $tblname = "register_driver";
    $driverData = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM " . $tblname . " WHERE iDriverId = '" . $iDriverId . "'");
    $eStatus = $driverData[0]['eStatus'];
    $vAvailability = $driverData[0]['vAvailability'];
    if ($vAvailability == "Available") {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_RESTRICT_BIDDING_SERVICES_UPDATE";
        setDataResponse($returnArr);
    }
    //if ($eStatus != 'inactive') {
    $newReqBiddingId = explode(',', $iReqBiddingId);
    $biddingdriverservice = $BIDDING_OBJ->biddingDriverService('webservice', $iDriverId);
    $biddingdriverservice = explode(',', $biddingdriverservice[0]['vBiddingId']);
    $remainingCats = array_diff($newReqBiddingId, $biddingdriverservice);
    if (count($biddingdriverservice > 0)) {
        $updatebiddingDriverService = [];
        $isdeleted = [];
        foreach ($biddingdriverservice as $exit) {
            if (in_array($exit, $newReqBiddingId)) {
                $updatebiddingDriverService[] = $exit;
            } else {
                $isdeleted[] = 1;
            }
        }
        if (count($isdeleted) > 0) {
            $data['vBiddingId'] = implode(',', $updatebiddingDriverService);
            $where = 'iDriverId = "' . $iDriverId . '"';
            $id = $BIDDING_OBJ->updatebiddingDriverService('webservice', $data, $where);
        } else {
            $id = 1;
        }
    }
    foreach ($remainingCats as $key => $Bidding) {
        if (!empty($Bidding)) {
            $existRequest = $BIDDING_OBJ->biddingdriverrequestcount('webservice', $iDriverId, $Bidding);
            if ($existRequest == 0) {
                $creDataArr['iBiddingId'] = $Bidding;
                $creDataArr['iDriverId'] = $iDriverId;
                $id = $BIDDING_OBJ->createbiddingdriverrequest('webservice', $creDataArr);
                $creDataArrs['iDriverId'] = $iDriverId;
                $idd = $BIDDING_OBJ->createbiddingDriverService('webservice', $creDataArrs);
            } else {
                $id = 1;
            }
        }
    }
    if ($id > 0) {

        $tblname = "register_driver";
        if (isset($userDetailsArr[$tblname . '_' . $iDriverId])) {
            $driverData = $userDetailsArr[$tblname . '_' . $iDriverId];
        } else {
            $driverData = $obj->MySQLSelect("SELECT *,iDriverId as iMemberId FROM " . $tblname . " WHERE iDriverId = '" . $iDriverId . "'");
            $userDetailsArr[$tblname . '_' . $iDriverId] = $driverData;
        }
        /* Send Email to Admin */
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
        $getMaildata['name'] = $driverData[0]['vName'] . " " . $driverData[0]['vLastName'];
        $getMaildata['email'] = $driverData[0]['vEmail'];
        $getMaildata['phone'] = "+" . $driverData[0]['vCode'] . " " . $driverData[0]['vPhone'];
        $getMaildata['Service'] = $languageLabelsArr['LBL_SERVICE_BIDDING'];
        $mail = $COMM_MEDIA_OBJ->SendMailToMember('SERVICE_REQUEST_FROM_PROVIDER', $getMaildata);
        $mailSendToAdmin = 1;

        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_BIDDING_SERVICE_ADD_SUCCESS_NOTE";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
if ($type == "cancelBidding") {
    $iUserId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $iBiddingPostId = isset($_REQUEST["iBiddingPostId"]) ? $_REQUEST["iBiddingPostId"] : '';
    $iCancelReasonId = isset($_REQUEST["iCancelReasonId"]) ? $_REQUEST["iCancelReasonId"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : '';
    $Reason = isset($_REQUEST["Reason"]) ? $_REQUEST["Reason"] : '';
    $where = " iBiddingPostId = '$iBiddingPostId'";
    $data_update_booking['eStatus'] = "Cancelled";
    $data_update_booking['iCancelReasonId'] = $iCancelReasonId;
    $data_update_booking['vCancelReason'] = $Reason;
    $data_update_booking['iCancelByUserId'] = $iUserId;
    $data_update_booking['dCancelDate'] = @date("Y-m-d H:i:s");
    $data_update_booking['eCancelBy'] = $userType == "Driver" ? $userType : "User";
    $data_update_booking['iBiddingPostId'] = $iBiddingPostId;
    $id = $BIDDING_OBJ->updateBiddingPost('webservice', $data_update_booking, $where);
    if ($id) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_BOOKING_CANCELED";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
if ($type == "updateBiddingStatus") {
    $iMemberId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $iBiddingPostId = isset($_REQUEST["iBiddingPostId"]) ? $_REQUEST["iBiddingPostId"] : '';
    $userType = isset($_REQUEST["UserType"]) ? $_REQUEST["UserType"] : '';
    $eStatus = isset($_REQUEST["eStatus"]) ? $_REQUEST["eStatus"] : '';
    $GeneralUserType = (isset($_REQUEST['GeneralUserType']) && $_REQUEST['GeneralUserType'] == "Driver") ? "Driver" : "Passenger";
    $description = isset($_REQUEST["description"]) ? $_REQUEST["description"] : '';
    $amount = isset($_REQUEST["amount"]) ? $_REQUEST["amount"] : '';
    $iCancelReasonId = isset($_REQUEST["iCancelReasonId"]) ? $_REQUEST["iCancelReasonId"] : '';
    $vCancelReason = isset($_REQUEST["vCancelReason"]) ? $_REQUEST["vCancelReason"] : '';
    $acceptediDriverId = isset($_REQUEST["iDriverId"]) ? $_REQUEST["iDriverId"] : '';
    $eWalletIgnore = isset($_REQUEST["eWalletIgnore"]) ? $_REQUEST["eWalletIgnore"] : 'No';
    $isOutStandingAdjusted = isset($_REQUEST["isOutStandingAdjusted"]) ? $_REQUEST["isOutStandingAdjusted"] : 'No';
    $getBiddingPost = $BIDDING_OBJ->getBiddingPost('webservice', $iBiddingPostId);
    $getBiddingPost = $getBiddingPost[0];
    $biddingpost[0] = $getBiddingPost;
    $message = 'LBL_BIDDING_UPDATED';
    if ($GeneralUserType == "Driver") {
        $iDriverId = $iMemberId;
        $row = $obj->MySQLSelect("SELECT vCurrencyDriver, vName, vLastName, vLang FROM `register_driver` WHERE iDriverId='$iDriverId'");
        $vCurrency = $row[0]['vCurrencyDriver'];
        $lang = $row[0]['vLang'];
        $row1 = $obj->MySQLSelect("SELECT iUserId, vCurrencyPassenger, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName, eHmsDevice FROM `register_user` WHERE iUserId = '" . $getBiddingPost['iUserId'] . "'");
        $vCurrencyMember = $row1[0]['vCurrencyPassenger'];
        $langMember = $row1[0]['vLang'];
        $currency_ = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrencyMember . "'");
        //$getDriverBiddingRequest = $BIDDING_OBJ->getDriverBiddingRequest('webservice' , $iBiddingPostId , $vCurrencyMember, $langMember, $getBiddingPost['fBiddingAmount'], $iDriverId, $biddingpost);
        $getDriverBiddingRequest = $BIDDING_OBJ->DriverBiddingRequest($iBiddingPostId, $vCurrency, $iDriverId, 'notification');
        if ($eStatus == 'Accepted') {
            $amount_1 = $getDriverBiddingRequest[0]['biddingAmount'];
        } else {
            $amount_1 = $getDriverBiddingRequest[0]['biddingAmount'];
        }
        $amount_1 = getNumber($amount_1);
        $amount_1 = formateNumAsPerCurrency(($amount_1 * $currency_[0]['ratio']), $vCurrencyMember);
        $channelName = 'PASSENGER_' . $getBiddingPost['iUserId'];
        $NOTI_USER_TYPE = RN_USER;
    } else {
        $row = $obj->MySQLSelect("SELECT vCurrencyPassenger, vName, vLastName, vLang FROM `register_user` WHERE iUserId = '$iMemberId'");
        $vCurrency = $row[0]['vCurrencyPassenger'];
        $lang = $row[0]['vLang'];
        $row1 = $obj->MySQLSelect("SELECT iDriverId, vCurrencyDriver, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName, eHmsDevice FROM `register_driver` WHERE iDriverId = '" . $acceptediDriverId . "'");
        $vCurrencyMember = $row1[0]['vCurrencyDriver'];
        $langMember = $row1[0]['vLang'];
        $currency_ = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrencyMember . "'");
        //$getDriverBiddingRequest = $BIDDING_OBJ->getDriverBiddingRequest('webservice' , $iBiddingPostId , $vCurrencyMember, $langMember, $getBiddingPost['fBiddingAmount'], $acceptediDriverId, $biddingpost);
        $channelName = 'CAB_REQUEST_DRIVER_' . $acceptediDriverId;
        $NOTI_USER_TYPE = RN_PROVIDER;
    }
    $languageLabelsArr_notification = $LANG_OBJ->FetchLanguageLabels($langMember, "1", "");
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
    $final_message = array();
    if ($eStatus == 'Reoffer') {
        $data_insert_bidding_offer = [];
        $currency_all = $obj->MySQLSelect("SELECT * FROM currency WHERE eStatus = 'Active'");
        for ($i = 0; $i < count($currency_all); $i++) {
            $data_insert_bidding_offer['fRatio_' . $currency_all[$i]['vName']] = $currency_all[$i]['Ratio'];
        }
        $data_insert_bidding_offer['iUserId'] = '';
        $data_insert_bidding_offer['iDriverId'] = '';
        if ($GeneralUserType == "Driver") {
            $data_insert_bidding_offer['iDriverId'] = $iDriverId;
            $data_insert_bidding_offer['iUserId'] = $getBiddingPost['iUserId'];
            $message = 'LBL_BIDDING_DRIVER_REQUEST_STATUS_REOFFER_BY_DRIVER';
        } else {
            $data_insert_bidding_offer['iUserId'] = $iMemberId;
            $data_insert_bidding_offer['iDriverId'] = $acceptediDriverId;
            $message = 'LBL_BIDDING_DRIVER_REQUEST_STATUS_REOFFER';
        }
        $data_insert_bidding_offer['UserType'] = $GeneralUserType;
        $data_insert_bidding_offer['amount'] = $amount / $currency[0]['ratio'];
        $data_insert_bidding_offer['description'] = $description;
        $data_insert_bidding_offer['iBiddingPostId'] = $iBiddingPostId;
        $id = $BIDDING_OBJ->create_bidding_offer('webservice', $data_insert_bidding_offer);
        $amount_1 = formateNumAsPerCurrency(($amount / $currency[0]['ratio']) * $currency_[0]['ratio'], $vCurrencyMember);
        $message_notification = str_replace(array('#TASK_NO#', '#MEMBER_NAME#', '#AMOUNT#'), array('#' . $getBiddingPost['vBiddingPostNo'], ucwords($row[0]['vName']) . ' ' . $row[0]['vLastName'], $amount_1), $languageLabelsArr_notification['LBL_BIDDING_TASK_REOFFER_MSG']);
        $final_message['Message'] = "BiddingTaskReoffered";
        $final_message['MsgType'] = "BiddingTaskReoffered";
    } elseif ($eStatus == 'Decline') {
        if ($GeneralUserType == "Driver") {
            $where = " iBiddingPostId = '$iBiddingPostId' AND iDriverId = '$iDriverId'";
            $data_update_bidding['eStatus'] = $eStatus;
            $data_update_bidding['DeclineByUser'] = 'Driver';
            $id = $BIDDING_OBJ->updateBiddingRequestTo('webservice', $data_update_bidding, $where);
            $message = 'LBL_BIDDING_DRIVER_REQUEST_STATUS_DECLINE_BY_DRIVER';
        } else {
            $where = " iBiddingPostId = '$iBiddingPostId' AND iDriverId = '$acceptediDriverId'";
            $data_update_bidding['eStatus'] = $eStatus;
            $data_update_bidding['DeclineByUser'] = 'Passenger';
            $data_update_bidding['iCancelReasonId'] = $iCancelReasonId;
            $data_update_bidding['vCancelReason'] = $vCancelReason;
            $id = $BIDDING_OBJ->updateBiddingRequestTo('webservice', $data_update_bidding, $where);
            $message = 'LBL_BIDDING_DRIVER_REQUEST_STATUS_DECLINE';
            $getDriverBiddingRequest = $BIDDING_OBJ->UserBiddingRequest($iBiddingPostId, $vCurrency, '', $acceptediDriverId);
            $amount_1 = formateNumAsPerCurrency((getNumber($getDriverBiddingRequest[0]['biddingReofferAmount']) / $currency[0]['ratio']) * $currency_[0]['ratio'], $vCurrencyMember);
        }
        $message_notification = str_replace(array('#TASK_NO#', '#MEMBER_NAME#', '#AMOUNT#'), array('#' . $getBiddingPost['vBiddingPostNo'], ucwords($row[0]['vName']) . ' ' . $row[0]['vLastName'], $amount_1), $languageLabelsArr_notification['LBL_BIDDING_TASK_DECLINED_MSG']);
        $final_message['Message'] = "BiddingTaskDeclined";
        $final_message['MsgType'] = "BiddingTaskDeclined";
    } elseif ($eStatus == 'Accepted') {
        if ($GeneralUserType == "Driver") {
            $where = " iBiddingPostId = '$iBiddingPostId' AND iDriverId = '$iDriverId'";
            $data_update_bidding['eStatus'] = $eStatus;
            $data_update_bidding['iBiddingPostId'] = $iBiddingPostId;
            $id = $BIDDING_OBJ->updateBiddingRequestTo('webservice', $data_update_bidding, $where);
            $message = 'LBL_BIDDING_DRIVER_REQUEST_STATUS_CONFIRMED_BY_DRIVER';
        } else {
            $where = " iBiddingPostId = '$iBiddingPostId'";
            $data_update_booking['eStatus'] = $eStatus;
            $data_update_booking['iDriverId'] = $acceptediDriverId;
            $data_update_booking['iBiddingPostId'] = $iBiddingPostId;
            $data_update_booking['dConfirmDate'] = date('Y-m-d H:i:s');
            /* For New Payment Flow */
            $params = array("iMemberId" => $iMemberId, "eUserType" => "Passenger", "eType" => "Bidding", "GET_DATA" => "Yes");
            $payment_mode_data = GetPaymentModeDetails($params);
            $PaymentMode = !empty($payment_mode_data['PaymentMode']) ? $payment_mode_data['PaymentMode'] : "cash";
            $eWalletDebit = $PaymentMode == "wallet" ? "Yes" : ($payment_mode_data['eWalletDebit'] == "Yes" ? "Yes" : "No");
            $ePayWallet = $eWalletDebit;
            $iPaymentInfoId = $payment_mode_data['iPaymentInfoId'];
            $isRestrictToWallet = $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
            $data_update_booking['ePaymentOption'] = $PaymentMode;
            $data_update_booking['eWalletDebit'] = $eWalletDebit;
            $data_update_booking['iPaymentInfoId'] = $iPaymentInfoId;
            $fareAmount = setTwoDecimalPoint($BIDDING_OBJ->getbiddingFinalAmount($iBiddingPostId));

            /*Add Company Id*/
            $DriverCompanyData = getDriverCompany($acceptediDriverId);
            $data_update_booking['vDriverCompanyId'] = $DriverCompanyData[0]['iCompanyId'];
            /*Add Company Id*/
            
            $fOutStandingAmount = GetPassengerOutstandingAmount($iMemberId);
            $fOutStandingAmount = setTwoDecimalPoint($fOutStandingAmount * $currency[0]['ratio']);
            $returnArr['fOutStandingAmount'] = $fOutStandingAmount;
            $returnArr['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($fOutStandingAmount, $vCurrency);
            if ($MODULES_OBJ->isEnableOutstandingRestriction() && $returnArr['fOutStandingAmount'] > 0 && $isOutStandingAdjusted == "No") {
                $returnArr['ShowAdjustTripBtn'] = $returnArr['ShowPayNow'] = "Yes";
                $returnArr['ShowContactUsBtn'] = "No";
                if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                    $returnArr['ShowPayNow'] = "No";
                    $returnArr['ShowAdjustTripBtn'] = "No";
                    $returnArr['ShowContactUsBtn'] = "Yes";
                }
                if ($CONFIG_OBJ->isOnlyCardPaymentModeAvailable() || $CONFIG_OBJ->isOnlyWalletPaymentModeAvailable()) {
                    $returnArr['ShowPayNow'] = "Yes";
                    $returnArr['ShowAdjustTripBtn'] = "No";
                }
                if (strtoupper($ePayWallet) == "YES") {
                    $outStandingSql = " AND eAuthoriseIdName='No' AND iAuthoriseId ='0'";
                }
                $counttripData = $obj->MySQLSelect("SELECT count(iTripOutstandId) as counttrip FROM trip_outstanding_amount WHERE iUserId='" . $iMemberId . "' AND iUserId > 0 AND ePaidByPassenger = 'No' $outStandingSql");
                if ($counttripData[0]['counttrip'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                    if ($CONFIG_OBJ->isOnlyCashPaymentModeAvailable()) {
                        $returnArr['outstanding_restriction_label'] = str_replace("##", $returnArr['fOutStandingAmountWithSymbol'], $languageLabelsArr["LBL_OUTSTANDING_RESTRICTION_MSG"]);
                        $returnArr['ShowAdjustTripBtn'] = "No";
                    }
                    // if ($APP_PAYMENT_MODE == "Card") {
                    if ($CONFIG_OBJ->isOnlyCardPaymentModeAvailable() || $CONFIG_OBJ->isOnlyWalletPaymentModeAvailable()) {
                        $returnArr['outstanding_restriction_label'] = str_replace("##", $returnArr['fOutStandingAmountWithSymbol'], $languageLabelsArr["LBL_OUTSTANDING_RESTRICTION_MSG"]);
                        $returnArr['ShowAdjustTripBtn'] = "No";
                        $returnArr['ShowPayNow'] = "Yes";
                    }
                }
                $returnArr['OutstandingTrips'] = $counttripData[0]['counttrip'];
                if ($returnArr['OutstandingTrips'] >= $OUTSTANDING_ALLOW_TRIP_COUNT) {
                    $returnArr['ShowAdjustTripBtn'] = "No";
                }
                if ($returnArr['ShowPayNow'] == "Yes") {
                    $returnArr['ShowContactUsBtn'] = "No";
                }
                $returnArr['Action'] = "1";
                setDataResponse($returnArr);
            }
            if ($returnArr['fOutStandingAmount'] > 0 && $isOutStandingAdjusted == "Yes") {
                $data_update_booking['fOutStandingAmount'] = $returnArr['fOutStandingAmount'];
                $returnArr['fOutStandingAmount'] = 0;
                $returnArr['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($returnArr['fOutStandingAmount'], $vCurrency);
                $fareAmount = $fareAmount + $returnArr['fOutStandingAmount'];
            }
            $user_available_balance_wallet = $WALLET_OBJ->FetchMemberWalletBalance($iMemberId, "Rider", true);
            $walletDataArr = array();
            if (is_array($user_available_balance_wallet)) {
                $walletDataArr = $user_available_balance_wallet;
                $user_available_balance_wallet = $walletDataArr['CurrentBalance'];
                $data_update_booking['tUserWalletBalance'] = $walletDataArr['AutorizedWalletBalance'];
            }
            if (strtoupper($ePayWallet) == "YES") {
                if ($user_available_balance_wallet < $fareAmount && $eWalletIgnore == 'No') {
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LOW_WALLET_AMOUNT";
                    $auth_wallet_amount = 0;
                    $returnArr['ORIGINAL_WALLET_BALANCE'] = formateNumAsPerCurrency(0, $vCurrency);
                    $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = setTwoDecimalPoint(0);
                    if (!empty($walletDataArr) && count($walletDataArr) > 0) {
                        $auth_wallet_amount = strval(setTwoDecimalPoint((isset($walletDataArr['TotalAuthorizedAmount']) ? $walletDataArr['TotalAuthorizedAmount'] : 0) * $currency[0]['ratio']));
                        $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0 ? formateNumAsPerCurrency($auth_wallet_amount, $vCurrency) : "";
                        $returnArr['AUTH_AMOUNT_VALUE'] = $auth_wallet_amount > 0 ? setTwoDecimalPoint($auth_wallet_amount) : "";
                        $returnArr['ORIGINAL_WALLET_BALANCE'] = isset($walletDataArr['WalletBalance']) ? formateNumAsPerCurrency(($walletDataArr['WalletBalance'] * $currency[0]['ratio']), $vCurrency) : formateNumAsPerCurrency(0, $vCurrency);
                        $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance']) ? setTwoDecimalPoint($walletDataArr['WalletBalance']) : 0) * $currency[0]['ratio']));
                    }
                    $returnArr['CURRENT_JOB_EST_CHARGE'] = formateNumAsPerCurrency($fareAmount, $vCurrency);
                    $returnArr['CURRENT_JOB_EST_CHARGE_VALUE'] = strval(setTwoDecimalPoint($fareAmount));
                    $returnArr['WALLET_AMOUNT_NEEDED'] = formateNumAsPerCurrency(($fareAmount - $user_available_balance_wallet + $auth_wallet_amount), $vCurrency);
                    $returnArr['WALLET_AMOUNT_NEEDED_VALUE'] = strval(setTwoDecimalPoint($fareAmount - $user_available_balance_wallet + $auth_wallet_amount));
                    if (!empty($walletDataArr) && count($walletDataArr) > 0 && $auth_wallet_amount > 0) {
                        $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT'];
                        // if ($SYSTEM_PAYMENT_FLOW == 'Method-3') {
                        if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                            $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT_NO_CASH'];
                        }
                        $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                        if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                            $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                        }
                        if (!empty($returnArr['AUTH_AMOUNT'])) {
                            $content_msg_low_balance = str_replace("###", $returnArr['AUTH_AMOUNT'], $content_msg_low_balance);
                        }
                        $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                        $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                    } else {
                        $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT'];
                        if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                            $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT_NO_CASH'];
                        }
                        $content_msg_low_balance = str_replace("#####", $returnArr['WALLET_AMOUNT_NEEDED'], $content_msg_low_balance);
                        if (!empty($returnArr['ORIGINAL_WALLET_BALANCE'])) {
                            $content_msg_low_balance = str_replace("####", $returnArr['ORIGINAL_WALLET_BALANCE'], $content_msg_low_balance);
                        }
                        if (!empty($returnArr['CURRENT_JOB_EST_CHARGE'])) {
                            $content_msg_low_balance = str_replace("###", $returnArr['CURRENT_JOB_EST_CHARGE'], $content_msg_low_balance);
                        }
                        $content_msg_low_balance = str_replace("##", "\n\n", $content_msg_low_balance);
                        $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                    }
                    if (strtoupper($ePayWallet) == "YES" && strtoupper($isRestrictToWallet) == "YES") {
                        $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "Yes";
                    } else {
                        $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "No";
                    }
                    setDataResponse($returnArr);
                } else {
                    $data_update_booking['tEstimatedCharge'] = $fareAmount;
                    if (!empty($data_update_booking['tEstimatedCharge']) && $data_update_booking['tUserWalletBalance'] > $data_update_booking['tEstimatedCharge']) {
                        $data_update_booking['tUserWalletBalance'] = $data_update_booking['tEstimatedCharge'];
                    }
                    if ($eWalletIgnore == "Yes") {
                        $data_update_booking['ePaymentOption'] = "Cash";
                    }
                }
            }
            $id = $BIDDING_OBJ->updateBiddingPost('webservice', $data_update_booking, $where);
            $getDriverBiddingRequest = $BIDDING_OBJ->UserBiddingRequest($iBiddingPostId, $vCurrency, '', $acceptediDriverId);
            //$amount_1 = $getDriverBiddingRequest[0]['biddingFinalAmount'];
            $amount_1 = formateNumAsPerCurrency((getNumber($getDriverBiddingRequest[0]['biddingFinalAmount']) / $currency[0]['ratio']) * $currency_[0]['ratio'], $vCurrencyMember);
            $message = 'LBL_BIDDING_DRIVER_REQUEST_STATUS_CONFIRMED';
            $taskDrivers = $obj->MySQLSelect("SELECT dbr.iDriverId, rd.eDeviceType, rd.iGcmRegId, rd.eAppTerminate, rd.eDebugMode, rd.eHmsDevice FROM driver_bidding_request as dbr LEFT JOIN register_driver as rd ON rd.iDriverId = dbr.iDriverId WHERE dbr.iBiddingPostId = '$iBiddingPostId' AND dbr.eStatus != 'Decline' AND dbr.iDriverId != '$acceptediDriverId' ");
            if (!empty($taskDrivers) && count($taskDrivers) > 0) {
                $alertMsg = str_replace("#TASK_NO#", "#" . $getBiddingPost['vBiddingPostNo'], $languageLabelsArr['LBL_SAME_TASK_EXIST_NOTI_TXT']);
                $final_message_new['Message'] = "BiddingTaskAcceptedOther";
                $final_message_new['MsgType'] = "BiddingTaskAcceptedOther";
                $final_message_new['iBiddingPostId'] = $iBiddingPostId;
                $final_message_new['time'] = time();
                $final_message_new['vTitle'] = $alertMsg;
                $final_message_new['eType'] = "Bidding";
                $generalDataArr = array();
                $taskDriverIdsArr = array();
                foreach ($taskDrivers as $taskDriver) {
                    $taskDriverIdsArr[] = $taskDriver['iDriverId'];
                    $generalDataArr[] = array('eDeviceType' => $taskDriver['eDeviceType'], 'deviceToken' => $taskDriver['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $taskDriver['eAppTerminate'], 'eDebugMode' => $taskDriver['eDebugMode'], 'eHmsDevice' => $taskDriver['eHmsDevice'], 'message' => $final_message_new, 'channelName' => 'CAB_REQUEST_DRIVER_' . $taskDriver['iDriverId']);
                }
                $taskDriverIdsStr = implode(",", $taskDriverIdsArr);
                $obj->sql_query("UPDATE driver_bidding_request SET eStatus = 'Closed' WHERE iDriverId IN ($taskDriverIdsStr) AND iBiddingPostId = '$iBiddingPostId'");
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
            }
        }
        $message_notification = str_replace(array('#TASK_NO#', '#MEMBER_NAME#', '#AMOUNT#'), array('#' . $getBiddingPost['vBiddingPostNo'], ucwords($row[0]['vName']) . ' ' . $row[0]['vLastName'], $amount_1), $languageLabelsArr_notification['LBL_BIDDING_TASK_ACCEPTED_MSG']);
        $final_message['Message'] = "BiddingTaskAccepted";
        $final_message['MsgType'] = "BiddingTaskAccepted";
    }
    /* ---------------------- for the notification data user get --------------------- */
    $alertMsg_db = $message_notification;
    $final_message['iBiddingPostId'] = $iBiddingPostId;
    $final_message['time'] = time();
    $final_message['vTitle'] = $message_notification;
    $final_message['eType'] = "Bidding";
    $notifiactondata = array();
    $notifiactondata['eDeviceType'] = $row1[0]['eDeviceType'];
    $notifiactondata['iGcmRegId'] = $row1[0]['iGcmRegId'];
    $notifiactondata['eAppTerminate'] = $row1[0]['eAppTerminate'];
    $notifiactondata['eDebugMode'] = $row1[0]['eDebugMode'];
    $notifiactondata['eHmsDevice'] = $row1[0]['eHmsDevice'];
    $notifiactondata['alertMsg_db'] = $alertMsg_db;
    $notifiactondata['final_message'] = $final_message;
    $notifiactondata['channelName'] = $channelName;
    $notifiactondata['NOTI_USER_TYPE'] = $NOTI_USER_TYPE;
    $BIDDING_OBJ->sendNotification($notifiactondata);
    /* ---------------------- for the notification data user get --------------------- */
    if ($id) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $message;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
if ($type == "getTaskLocations") {
    $iBiddingPostId = isset($_REQUEST["iBiddingPostId"]) ? $_REQUEST["iBiddingPostId"] : '';
    $UserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : 'Passenger';
    $vTimeZone = isset($_REQUEST["vTimeZone"]) ? $_REQUEST["vTimeZone"] : '';
    $Data = array();
    if ($iBiddingPostId != "") {
        if ($UserType == "Driver") {
            $Data = $BIDDING_OBJ->getDriverTaskDetails($iBiddingPostId);
        } else {
            $Data = $BIDDING_OBJ->getUserTaskDetails($iBiddingPostId);
        }
        if (count($Data) > 0) {
            $returnArr['Action'] = "1";
            $returnArr['message'] = $Data;
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_NO_TASK_FOUND";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_TASK_FOUND";
    }
    setDataResponse($returnArr);
}
if ($type == "UpdateDriverBiddingTaskStatus") {
    $iDriverId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $iBiddingPostId = isset($_REQUEST['iBiddingPostId']) ? $_REQUEST['iBiddingPostId'] : "";
    $vTaskStatus = isset($_REQUEST['vTaskStatus']) ? $_REQUEST['vTaskStatus'] : "";
    if (!empty($vTaskStatus)) {
        $BIDDING_OBJ->updateTaskStatus($iBiddingPostId, $iDriverId, $vTaskStatus);
        $returnArr['Action'] = "1";
        $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
if ($type == "displayFareBiddingService") {
    $iMemberId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $iBiddingPostId = isset($_REQUEST['iBiddingPostId']) ? $_REQUEST['iBiddingPostId'] : "";
    $UserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : 'Passenger';
    $PAGE_MODE = isset($_REQUEST["PAGE_MODE"]) ? $_REQUEST["PAGE_MODE"] : 'History';
    $BIDDING_OBJ->getFareDetails($iBiddingPostId, $iMemberId, $UserType, " ", $PAGE_MODE);
}
if ($type == "CollectPaymentBiddingService") {
    $iDriverId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $iBiddingPostId = isset($_REQUEST['iBiddingPostId']) ? $_REQUEST['iBiddingPostId'] : "";
    $BIDDING_OBJ->collectPayment($iBiddingPostId, $iDriverId);
}
if ($type == "submitRatingBiddingService") {
    $iMemberId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : '';
    $UserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : 'Passenger';
    $iBiddingPostId = isset($_REQUEST["iBiddingPostId"]) ? $_REQUEST["iBiddingPostId"] : '';
    $isSkipRating = isset($_REQUEST["isSkipRating"]) ? $_REQUEST["isSkipRating"] : 'No';
    $BIDDING_OBJ->submitRating($iBiddingPostId, $iMemberId, $UserType);
}
if ($type == "UploadBiddingMedia") {
    $action_type = isset($_REQUEST["action_type"]) ? $_REQUEST["action_type"] : 'ADD'; // ADD,DELETE,GET,DELETEALL
    $eMediaType = isset($_REQUEST["eMediaType"]) ? $_REQUEST["eMediaType"] : ''; //('Image', 'Video', 'Audio')
    $image_name = $vImage = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    $ibiddingPostMediaId = isset($_REQUEST["ibiddingPostMediaId"]) ? $_REQUEST["ibiddingPostMediaId"] : '';
    $iBiddingPostId = isset($_REQUEST["iBiddingPostId"]) ? $_REQUEST["iBiddingPostId"] : 0;
    $iUserId = isset($_REQUEST["GeneralMemberId"]) ? $_REQUEST["GeneralMemberId"] : 0;
    $UserType = isset($_REQUEST["GeneralUserType"]) ? $_REQUEST["GeneralUserType"] : 'Passenger';
    if ($action_type == "ADD") {
        $returnArr = $BIDDING_OBJ->uploadbiddingmedia($image_name, $image_object, $ibiddingPostMediaId, $iBiddingPostId);
    } else if ($action_type == "DELETE" && $ibiddingPostMediaId != "") {
        $returnArr = $BIDDING_OBJ->deletebiddingmedia($ibiddingPostMediaId, $action_type, $iBiddingPostId, $iUserId);
    } else if ($action_type == "GET" && $iUserId > 0) {
        $returnArr = $BIDDING_OBJ->getbiddingmedia($iBiddingPostId, $iUserId, $UserType);
    } else if ($action_type == "DELETEALL" && $iUserId > 0) {
        $returnArr = $BIDDING_OBJ->deleteallbiddingmedia($iBiddingPostId, $iUserId);
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
/* --------------------------------- BIDDING End -------------------------------- */

/* -------------------------Rent Item Start ------------------------- */
// to get rent item categories
if ($type == "getRentItemCategories") {
    $userId = isset($_REQUEST['userId']) ? clean($_REQUEST['userId']) : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $iCategoryId = isset($_REQUEST["iCategoryId"]) ? $_REQUEST["iCategoryId"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';

    if ($userId != "") {
        $lang = $vGeneralLang;
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $userId])) {
            $row = $userDetailsArr['register_user_' . $userId];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$userId'");
            $userDetailsArr['register_user_' . $userId] = $row;
        }
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
        $lang = $row[0]['vLang'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
        }
        $returnArr['Action'] = "1";

        if (!empty($eType)) {
            $iMasterServiceCategoryId = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', $eType, '', 'true');
            $msql = "";
            if (!empty($iMasterServiceCategoryId)) {
                $msql = " AND iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
            }
        }

        $MainCatArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);

        $rentitemarray = array();
        if (!empty($iCategoryId)) {
            $sortArrayVehicleSelected = explode(',', $iCategoryId);
        }

        foreach ($MainCatArr as $key => $value) {
            $reqArr = array('vTitle', 'iCategoryId', 'vImage', 'vImage1', 'iCategoryId');
            $getrentitem = $RENTITEM_OBJ->getrentitem('webservice', $value['iCategoryId'], $lang, $reqArr);
            $DatanewArr = $RENTITEM_OBJ->getRentItemSubCategory('webservice', $value['iCategoryId'], '', '', '', $lang, '', $reqArr);
            $getrentitem['SubCategory'] = $DatanewArr;
            foreach ($DatanewArr as $k => $v) {
                if ($value['iCategoryId'] > 0) {
                    $getrentitem['SubCategory'][$k]['iCategoryId'] = $value['iCategoryId'];
                    $getrentitem['SubCategory'][$k]['iSubCategoryId'] = $v['iCategoryId'];
                }
            }

            if (!in_array($value['iCategoryId'], $sortArrayVehicleSelected)) {
                $sortArrayVehicleSelected[] = $value['iCategoryId'];
            }
            $rentitemarray[$value['iCategoryId']] = $getrentitem;
        }

        $rentitemarray = array_replace(array_flip($sortArrayVehicleSelected), $rentitemarray);
        $rentitemarray = array_values($rentitemarray);

        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "0");
        $timingArray = array('vMonFromSlot', 'vMonToSlot', 'vTueFromSlot', 'vTueToSlot', 'vWedFromSlot', 'vWedToSlot', 'vThuFromSlot', 'vThuToSlot', 'vFriFromSlot', 'vFriToSlot', 'vSatFromSlot', 'vSatToSlot', 'vSunFromSlot', 'vSunToSlot');
        $arrayKey = $tempCntr = 0;
        $timearray = array();
        for ($j = 0; $j < count($timingArray); $j++) {
            //for from timeslot
            $tempArry = array(
                'dayname' => getDaynameBylabel($timingArray[$j]),
                'field' => getDaynameBylabel($timingArray[$j], "field"),
                $timingArray[$j] => $languageLabelsArr['LBL_From'],
            );

            $returnArr['timeslot'][$arrayKey][$tempCntr] = $tempArry;

            //for to timeslot

            $j++;

            $returnArr['timeslot'][$arrayKey][$tempCntr][$timingArray[$j]] = $languageLabelsArr['LBL_To'];

            $timearray[] = $returnArr['timeslot'][$arrayKey][$tempCntr];
        }

        $returnArr['message'] = $rentitemarray;
        $returnArr['timeslot'] = $timearray;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }

    setDataResponse($returnArr);
}
// to get rent item Payment plan
if ($type == "getRentItemPaymentPlan") {
    $iUserId = isset($_REQUEST['iUserId']) ? clean($_REQUEST['iUserId']) : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $iRentItemPostId = isset($_REQUEST["iRentItemPostId"]) ? $_REQUEST["iRentItemPostId"] : '';
    $eType = isset($_REQUEST['eType']) ? clean($_REQUEST['eType']) : 'RentItem';

    if ($iUserId != "") {
        $lang = $vGeneralLang;
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start

        if (isset($userDetailsArr['register_user_' . $iUserId])) {
            $row = $userDetailsArr['register_user_' . $iUserId];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$iUserId'");
            $userDetailsArr['register_user_' . $userId] = $row;
        }
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
        $lang = $row[0]['vLang'];
        $vCurrencyPassenger = $row[0]['vCurrencyPassenger'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "0");
        if (isset($currencyAssociateArr[$vCurrencyPassenger])) {
            $userCurrencyRatio = $currencyAssociateArr[$vCurrencyPassenger]['Ratio'];
            $userCurrencySymbol = $currencyAssociateArr[$vCurrencyPassenger]['vSymbol'];
        } else {
            $userCurrencyData = $obj->MySQLSelect("SELECT vSymbol,vName,Ratio FROM currency WHERE vName='" . $vCurrencyPassenger . "'");
            $userCurrencySymbol = $userCurrencyData[0]['vSymbol'];
            $userCurrencyRatio = $userCurrencyData[0]['Ratio'];
        }

        $msql = "";
        if (!empty($eType)) {
            $iMasterServiceCategoryId = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', $eType, '', 'true');
            if (!empty($iMasterServiceCategoryId)) {
                $msql = " AND iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
            }
        }
        
        $rent_item_payment_plan = $RENTITEM_OBJ->getRentItemPaymentPlan("webservice", $msql, "", "", $lang, $iRentItemPostId);
        
        foreach ($rent_item_payment_plan as $k => $v) {
           
            if ($v['fAmount'] == 0) {
                $rent_item_payment_plan[$k]['fAmount'] = "";
            } else {
                $rent_item_payment_plan[$k]['fAmount'] = formateNumAsPerCurrency(($v['fAmount'] * $userCurrencyRatio), $vCurrencyPassenger);
            }
            if ($v['iTotalPost'] >= 1) {
                $rent_item_payment_plan[$k]['iTotalPostTxt'] = $v['iTotalDays'] . " " . $languageLabelsArr['LBL_DAYS'];
            } else {
                $rent_item_payment_plan[$k]['iTotalPostTxt'] = "";
            }

        }

        /*$TextArray = array("isSimpleText" => "Yes" , "vPlanName"=>$languageLabelsArr['LBL_RENT_PLAN_DETAIL_TXT']);
        
        if (!empty($iRentItemPostId)) {
            $rent_item_payment_plan = array_merge(array_slice($rent_item_payment_plan, 0, 0), array($TextArray), array_slice($rent_item_payment_plan, 0));
        } else {
            $rent_item_payment_plan = array_merge(array_slice($rent_item_payment_plan, 0, 1), array($TextArray), array_slice($rent_item_payment_plan, 1));
        }*/
        
        if (!empty($iUserId)) {

            $paymentlogData = $obj->MySQLSelect("SELECT rl.* FROM `rentitem_payment_log` as rl LEFT JOIN rent_item_payment_plan as rp on rp.iPaymentPlanId=rl.iPaymentPlanId WHERE rl.iUserId = '" . $iUserId . "'  AND rl.eStatus = 'Active' AND rp.iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "' ORDER BY rl.iUserPaymentPlanId DESC LIMIT 1");

            $iPaymentPlanId = $paymentlogData[0]['iPaymentPlanId'];
            $iTotalPost = $paymentlogData[0]['iTotalPost'];
            
            $totalPostData = $obj->MySQLSelect("SELECT COUNT(r.iRentItemPostId) AS Total FROM rentitem_post r LEFT JOIN register_user as u on u.iUserId=r.iUserId LEFT JOIN rent_items_category as rc on rc.iRentItemId=r.iItemCategoryId WHERE 1=1 AND r.iUserId = '" . $iUserId . "' AND rc.iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'");

            $FreePaymentPlanData = $obj->MySQLSelect("SELECT iPaymentPlanId,eFreePlan,iTotalPost,eAvailability FROM rent_item_payment_plan where eFreePlan = 'Yes' $msql order by iPaymentPlanId ASC");

            $FreePlanAvailability = $FreePaymentPlanData[0]['eAvailability'];

            $AllPostData = $obj->MySQLSelect("SELECT r.iRentItemPostId,r.iPaymentPlanId FROM rentitem_post r LEFT JOIN register_user as u on u.iUserId=r.iUserId LEFT JOIN rent_items_category as rc on rc.iRentItemId=r.iItemCategoryId WHERE 1=1 AND r.iUserId = '" . $iUserId . "' AND rc.iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'");
            $paymentplans = array_column($AllPostData, 'iPaymentPlanId');

            
            if ($iTotalPost > 0) {
                if ($FreePlanAvailability == 'FirstTime' && in_array($FreePaymentPlanData[0]['iPaymentPlanId'], $paymentplans)) {
                    $queryData = $obj->MySQLSelect("SELECT iPaymentPlanId,eFreePlan,iTotalPost FROM rent_item_payment_plan where eFreePlan='Yes' AND eStatus = 'Active'  $msql order by iPaymentPlanId ASC"); // AND eFreePlan='No'
                } else {
                    $queryData = $obj->MySQLSelect("SELECT iPaymentPlanId,eFreePlan,iTotalPost FROM rent_item_payment_plan where eFreePlan='No' AND eStatus = 'Active' $msql order by iPaymentPlanId ASC");
                }

                $excludearray = array();

                if ($queryData != "") {
                    foreach ($queryData as $k => $excludedata) {
                        if (($excludedata['eFreePlan'] == "Yes")) { // ($excludedata['iTotalPost'] > 0) ||
                            $excludearray[]['iPaymentPlanId'] = $excludedata['iPaymentPlanId'];
                        }
                    }
                }

                foreach ($rent_item_payment_plan as $keyplan => $paymentplan) {

                    foreach ($excludearray as $t => $planid) {
                        if ($planid['iPaymentPlanId'] == $paymentplan['iPaymentPlanId']) {
                            unset($rent_item_payment_plan[$keyplan]);
                        }
                    }
                }
                $rent_item_payment_plan = array_values($rent_item_payment_plan);

                foreach ($rent_item_payment_plan as $k => $v) {

                    if (!empty($v['iPaymentPlanId']) && !empty($iUserId)) {
                        $paymentlogData = $obj->MySQLSelect("SELECT * FROM `rentitem_payment_log` WHERE iUserId = '" . $iUserId . "' AND iPaymentPlanId = '" . $v['iPaymentPlanId'] . "' AND eStatus = 'Active' ORDER BY iUserPaymentPlanId DESC LIMIT 1");

                        if ($paymentlogData[0]['iTotalPost'] != "" && $paymentlogData[0]['iTotalPost'] > 0) {
                            $rent_item_payment_plan[$k]['iRemainingPost'] = $paymentlogData[0]['iTotalPost'] . " " . $languageLabelsArr['LBL_RENT_POST_PENDING'];
                            $rent_item_payment_plan[$k]['isSelected'] = 'Yes';
                        } else if ($v['iTotalPost'] > 0 && empty($paymentlogData[0]['iTotalPost'])) {
                            $rent_item_payment_plan[$k]['iRemainingPost'] = "";
                            $rent_item_payment_plan[$k]['isDisabled'] = 'Yes';
                        } else {
                            $rent_item_payment_plan[$k]['iRemainingPost'] = "";
                        }
                    }
                }
            } else if ($totalPostData[0]['Total'] > 0 && $FreePlanAvailability == 'FirstTime' && empty($paymentlogData)) {

                if ($FreePlanAvailability == 'FirstTime' && in_array($FreePaymentPlanData[0]['iPaymentPlanId'], $paymentplans)) {
                    $queryData = $obj->MySQLSelect("SELECT iPaymentPlanId,eFreePlan,iTotalPost FROM rent_item_payment_plan where eFreePlan='Yes' AND eStatus = 'Active'  $msql order by iPaymentPlanId ASC"); // AND eFreePlan='No'

                $excludearray = array();
                 
                foreach ($queryData as $k => $excludedata) {
                    if (($excludedata['iTotalPost'] > 0) || ($excludedata['eFreePlan'] == "Yes")) {
                        $excludearray[]['iPaymentPlanId'] = $excludedata['iPaymentPlanId'];
                    }
                }
                 
                foreach ($rent_item_payment_plan as $keyplan => $paymentplan) {

                    foreach ($excludearray as $t => $planid) {
                        if ($planid['iPaymentPlanId'] == $paymentplan['iPaymentPlanId']) {
                            unset($rent_item_payment_plan[$keyplan]);
                        }
                    }
                }
                $rent_item_payment_plan = array_values($rent_item_payment_plan);
                } 
                foreach ($rent_item_payment_plan as $k1 => $val1) {
                    $rent_item_payment_plan[0]['isSelected'] = 'Yes';
                }
            } else if ($iTotalPost == 0 && $totalPostData[0]['Total'] > 0) { // 
                
                //if(empty($paymentlogData)) {
                    if ($FreePlanAvailability == 'FirstTime' && in_array($FreePaymentPlanData[0]['iPaymentPlanId'], $paymentplans)) {
                        $queryData = $obj->MySQLSelect("SELECT iPaymentPlanId,eFreePlan,iTotalPost FROM rent_item_payment_plan where eFreePlan='Yes' AND eStatus = 'Active'  $msql order by iPaymentPlanId ASC"); // AND eFreePlan='No'
                    } else {
                        $queryData = $obj->MySQLSelect("SELECT iPaymentPlanId,eFreePlan,iTotalPost FROM rent_item_payment_plan where eFreePlan='No' AND eStatus = 'Active' $msql order by iPaymentPlanId ASC");
                    }
                    $excludearray = array();
                     
                    if ($queryData != "") {
                        foreach ($queryData as $k => $excludedata) {
                            if (($excludedata['eFreePlan'] == "Yes")) { // ($excludedata['iTotalPost'] > 0) ||
                                $excludearray[]['iPaymentPlanId'] = $excludedata['iPaymentPlanId'];
                            }
                        }
                    }    
                    foreach ($rent_item_payment_plan as $keyplan => $paymentplan) {

                        foreach ($excludearray as $t => $planid) {
                            if ($planid['iPaymentPlanId'] == $paymentplan['iPaymentPlanId']) {
                                unset($rent_item_payment_plan[$keyplan]);
                            }
                        }
                    }
                    $rent_item_payment_plan = array_values($rent_item_payment_plan);
                //}

                foreach ($rent_item_payment_plan as $k1 => $val1) {
                    $rent_item_payment_plan[0]['isSelected'] = 'Yes';
                }
            }
        }

        $returnArr['Action'] = "1";
        $returnArr['message'] = $rent_item_payment_plan;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }

    setDataResponse($returnArr);
}
// to get rent item images
if ($type == "RentItemImages") {
    $action_type = isset($_REQUEST["action_type"]) ? $_REQUEST["action_type"] : 'ADD';
    $image_name = $vImage = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    $iImageId = isset($_REQUEST["iImageId"]) ? $_REQUEST["iImageId"] : '';
    $iUserId = isset($_REQUEST["iUserId"]) ? $_REQUEST["iUserId"] : '';
    $iItemCategoryId = isset($_REQUEST["iItemCategoryId"]) ? $_REQUEST["iItemCategoryId"] : '';
    $iItemSubCategoryId = isset($_REQUEST["iItemSubCategoryId"]) ? $_REQUEST["iItemSubCategoryId"] : '';
    $iRentItemPostId = isset($_REQUEST["iRentItemPostId"]) ? $_REQUEST["iRentItemPostId"] : '';
    $iTmpRentItemPostId = isset($_REQUEST["iTmpRentItemPostId"]) ? $_REQUEST["iTmpRentItemPostId"] : '';

    if (strtoupper($action_type) == "ADD") {
        if ($image_name != "") {
            $Photo_Gallery_folder = $tconfig['tsite_upload_images_rent_item_path'];
            if (!is_dir($Photo_Gallery_folder)) {
                mkdir($Photo_Gallery_folder, 0777);
                chmod($Photo_Gallery_folder, 0777);
            }
            $imgext = explode('.', $image_name);
            $unique = uniqid('', true);
            $file_name = substr($unique, strlen($unique) - 4, strlen($unique));
            $new_imagename = $file_name . "." . $imgext[1];

            $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $new_imagename, $prefix = '', $vaildExt = "jpg,jpeg,gif,png,pdf,doc,docx,MP4,MOV,WMV,AVI,FLV,MKV,WEBM");
            $vImageName = $vFile[0];
            $Data_update_images['vImage'] = $vImageName;
        }
        $Data_update_images['iUserId'] = $iUserId;
        $Data_update_images['tAddedDate'] = @date("Y-m-d H:i:s");
        $Data_update_images['iItemCategoryId'] = $iItemCategoryId;
        $Data_update_images['iItemSubCategoryId'] = $iItemSubCategoryId;
        if (!empty($iTmpRentItemPostId)) {
            $Data_update_images['iTmpRentItemPostId'] = $iTmpRentItemPostId;
        }
        if (!empty($iRentItemPostId)) {
            $Data_update_images['iRentItemPostId'] = $iRentItemPostId;
        }
        $id = $obj->MySQLQueryPerform("rentitem_images", $Data_update_images, 'insert');

        $getImages = $RENTITEM_OBJ->getRentItemImage("webservice", $iItemCategoryId, $iUserId, "", "", $iRentItemPostId, $iTmpRentItemPostId);

        if ($id > 0) {
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_IMAGE_UPLOAD_SUCCESS_NOTE";
            if (!empty($getImages)) {
                $returnArr['AllImages'] = $getImages;
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
    } else if (strtoupper($action_type) == "DELETE" && $iImageId != "") {
        $Photo_Gallery_folder = $tconfig['tsite_upload_images_rent_item_path'];
        $OldImageName = get_value('rentitem_images', 'vImage', 'iRentImageId', $iImageId, '', 'true');
        if ($OldImageName != '') {
            unlink($Photo_Gallery_folder . $OldImageName);
        }
        $sql = "DELETE FROM rentitem_images WHERE `iRentImageId`='" . $iImageId . "'";
        $id = $obj->sql_query($sql);

        $getImages = $RENTITEM_OBJ->getRentItemImage("webservice", $iItemCategoryId, $iUserId, "", "", $iRentItemPostId, $iTmpRentItemPostId);

        if ($id > 0) {
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_IMAGE_DELETE_SUCCESS_NOTE";
            if (!empty($getImages)) {
                $returnArr['AllImages'] = $getImages;
            }
        } else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
    } else if (strtoupper($action_type) == "HISTORY") {
        $getImages = $RENTITEM_OBJ->getRentItemImage("webservice", $iItemCategoryId, $iUserId, "", "", $iRentItemPostId, $iTmpRentItemPostId);
        $returnArr['Action'] = "1";
        $returnArr['message'] = "";
        if (!empty($getImages)) {
            $returnArr['AllImages'] = $getImages;
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
// to get rent item form fields
if ($type == "getRentItemFormFields") {
    $GeneralMemberId = isset($_REQUEST['GeneralMemberId']) ? clean($_REQUEST['GeneralMemberId']) : '';

    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';

    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? clean($_REQUEST['GeneralUserType']) : '';

    $iRentFieldId = isset($_REQUEST['iRentFieldId']) ? clean($_REQUEST['iRentFieldId']) : '';

    $iRentItemId = isset($_REQUEST['iRentItemId']) ? clean($_REQUEST['iRentItemId']) : '';

    $iRentItemPostId = isset($_REQUEST['iRentItemPostId']) ? clean($_REQUEST['iRentItemPostId']) : '';

    $iMasterServiceCategoryId = get_value('rent_items_category', 'iMasterServiceCategoryId', 'iRentItemId', $iRentItemId, '', 'true');
    $eTypeNew = get_value('master_service_category', 'eType', 'iMasterServiceCategoryId', $iMasterServiceCategoryId, '', 'true');
    
    if ($GeneralUserType == "Passenger") {

        $vLanguage = get_value('register_user', 'vLang', 'iUserId', $GeneralMemberId, '', 'true');
    } else {

        $vLanguage = get_value('register_driver', 'vLang', 'iDriverId', $iMemberId, '', 'true');
    }

    if ($vLanguage == "" || $vLanguage == NULL) {

        $vLanguage = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
    }

    $getRentItemFields = $RENTITEM_OBJ->getRentItemFields("webservice", $iRentFieldId, $iRentItemId, $iRentItemPostId, $vLanguage);

    if (!empty($getRentItemFields)) {

        $returnArr['Action'] = "1";

        $returnArr['IsAvailibilitySectionShow'] = "No";

        /*if($eTypeNew == "RentEstate"){
            $returnArr['isBuySell'] = "Yes";
        }*/

        $returnArr['message'] = $getRentItemFields;
    } else {

        $returnArr['Action'] = "0";

        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }

    setDataResponse($returnArr);
}
// to create temp post and edit post
if ($type == "CreateRentPostData") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $GeneralUserType = isset($_REQUEST['GeneralUserType']) ? clean($_REQUEST['GeneralUserType']) : '';
    $iItemCategoryId = isset($_REQUEST['iItemCategoryId']) ? clean($_REQUEST['iItemCategoryId']) : '';
    $iItemSubCategoryId = isset($_REQUEST['iItemSubCategoryId']) ? clean($_REQUEST['iItemSubCategoryId']) : '';
    $vTimeZone = isset($_REQUEST['vTimeZone']) ? $_REQUEST['vTimeZone'] : "";
    $vLocation = isset($_REQUEST["vLocation"]) ? $_REQUEST["vLocation"] : '';
    $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
    $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
    $vBuildingNo = isset($_REQUEST["vBuildingNo"]) ? $_REQUEST["vBuildingNo"] : '';
    $vAddress = isset($_REQUEST["vAddress"]) ? $_REQUEST["vAddress"] : '';
    $fAmount = isset($_REQUEST["fAmount"]) ? $_REQUEST["fAmount"] : '';
    $dPickupAvailableDate = isset($_REQUEST["dPickupAvailableDate"]) ? $_REQUEST["dPickupAvailableDate"] : '';
    $dPickupAvailableTime = isset($_REQUEST["dPickupAvailableTime"]) ? $_REQUEST["dPickupAvailableTime"] : '';
    $eRentItemDuration = isset($_REQUEST["eRentItemDuration"]) ? $_REQUEST["eRentItemDuration"] : '';
    $tFieldsArr = isset($_REQUEST["tFieldsArr"]) ? $_REQUEST["tFieldsArr"] : '';
    $vImageIds = isset($_REQUEST["vImageIds"]) ? $_REQUEST["vImageIds"] : '';
    $iTmpRentItemPostId = isset($_REQUEST["iTmpRentItemPostId"]) ? $_REQUEST["iTmpRentItemPostId"] : '';
    $iRentItemPostId = isset($_REQUEST["iRentItemPostId"]) ? $_REQUEST["iRentItemPostId"] : '';
    $timeslot = isset($_REQUEST['timeslot']) ? $_REQUEST['timeslot'] : '';
    $exiprePaymentPending = isset($_REQUEST['exiprePaymentPending']) ? $_REQUEST['exiprePaymentPending'] : '';
    $eIsUserNumberDisplay = isset($_REQUEST['eIsUserNumberDisplay']) ? $_REQUEST['eIsUserNumberDisplay'] : '';
    $eIsUserAddressDisplay = isset($_REQUEST['eIsUserAddressDisplay']) ? $_REQUEST['eIsUserAddressDisplay'] : '';

    $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $iMemberId . "'");
    $vLanguage = $row[0]['vLang'];
    if ($vLanguage == "" || $vLanguage == NULL) {
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $row[0]['vCurrencyPassenger'] . "'");

    $systemTimeZone = date_default_timezone_get();
    $dPickupAvailableDate = converToTz($dPickupAvailableDate, $systemTimeZone, $vTimeZone);

    $RentItemPostData = array();
    $RentItemPostData['iUserId'] = $iMemberId;
    $eStatusNew = get_value('rentitem_post ', 'eStatus', 'iRentItemPostId', $iRentItemPostId, '', 'true');
    if ($exiprePaymentPending == 'Yes' && $eStatusNew == 'Expired') {
        $RentItemPostData['eStatus'] = 'Expired';
    } else {
        $RentItemPostData['eStatus'] = 'Pending';
    }

    $RentItemPostData['iItemCategoryId'] = $iItemCategoryId;
    $RentItemPostData['iItemSubCategoryId'] = $iItemSubCategoryId;
    $RentItemPostData['vTimeZone'] = $vTimeZone;
   

    $RentItemPostData['vLocation'] = $vLocation;
    $RentItemPostData['vLatitude'] = $vLatitude;
    $RentItemPostData['vLongitude'] = $vLongitude;
    $RentItemPostData['vBuildingNo'] = $vBuildingNo;
    $RentItemPostData['vAddress'] = $vAddress;
    $RentItemPostData['fAmount'] = $fAmount / $currency[0]['ratio'];

    $RentItemPostData['dPickupAvailableDate'] = $dPickupAvailableDate;
    $RentItemPostData['dPickupAvailableTime'] = $dPickupAvailableTime;
    $RentItemPostData['eRentItemDuration'] = $eRentItemDuration;
    $RentItemPostData['vImageIds'] = $vImageIds;
    $RentItemPostData['tFieldsArr'] = $tFieldsArr;

    $RentItemPostData['eIsUserNumberDisplay'] = $eIsUserNumberDisplay;
    $RentItemPostData['eIsUserAddressDisplay'] = $eIsUserAddressDisplay;

    if (empty($iRentItemPostId)) {
        $RentItemPostData['vRentItemPostNo'] = rand(10000000, 99999999);
        $RentItemPostData['vCurrencyPassenger'] = $currency[0]['vName'];
    }

    //if(empty($iRentItemPostId)){
    $timedata = json_decode(str_replace("\\", "", $_REQUEST['timeslot']), true);
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", "0");
    $timingArray = array('vMonFromSlot', 'vMonToSlot', 'vTueFromSlot', 'vTueToSlot', 'vWedFromSlot', 'vWedToSlot', 'vThuFromSlot', 'vThuToSlot', 'vFriFromSlot', 'vFriToSlot', 'vSatFromSlot', 'vSatToSlot', 'vSunFromSlot', 'vSunToSlot');
    foreach ($timedata as $key => $opValue) {
        for ($j = 0; $j < count($timingArray); $j++) {
            if ($opValue[$timingArray[$j]] != $languageLabelsArr['LBL_From'] && $opValue[$timingArray[$j + 1]] == $languageLabelsArr['LBL_To']) {
                $opValue[$timingArray[$j + 1]] = "23:59:00";
            }
            /* if($opValue[$timingArray[$j-1]] == $languageLabelsArr['LBL_From'] && $opValue[$timingArray[$j]] !=  $languageLabelsArr['LBL_To']){
                   $opValue[$timingArray[$j-1]]= "00:00:00";
             }*/
        }
        foreach ($opValue as $k => $value) {
            if ($k == 'dayname' || $k == 'field') {
                continue;
            }

            $RentItemPostData[$k] = $value;
        }
    }
    //}
    
    if (!empty($iRentItemPostId)) {
        $iTmpRentItemPostId = "";
        $iPaymentPlanId = "";

        $getRentItemFields = $RENTITEM_OBJ->createRentItemFinalPost("webservice", $iTmpRentItemPostId, $iRentItemPostId, $iMemberId, $iPaymentPlanId, $vLanguage, "", $RentItemPostData);
    } else {
        $getRentItemFields = $RENTITEM_OBJ->createRentItemPost("webservice", $RentItemPostData, $iTmpRentItemPostId, $vLanguage);
    }

    if (!empty($getRentItemFields)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $getRentItemFields;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }

    setDataResponse($returnArr);
}
// To create main post
if ($type == "GenerateFinalPost") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : clean($_REQUEST['GeneralMemberId']);
    $iTmpRentItemPostId = isset($_REQUEST["iTmpRentItemPostId"]) ? $_REQUEST["iTmpRentItemPostId"] : '';
    $iPaymentPlanId = isset($_REQUEST["iPaymentPlanId"]) ? $_REQUEST["iPaymentPlanId"] : '';
    $ePaymentOption = isset($_REQUEST["ePaymentOption"]) ? $_REQUEST["ePaymentOption"] : '';
    $tPaymentId = isset($_REQUEST["tPaymentId"]) ? $_REQUEST["tPaymentId"] : '';
    $payStatus = isset($_REQUEST["payStatus"]) ? $_REQUEST["payStatus"] : '';
    $iRentItemPostId = isset($_REQUEST["iRentItemPostId"]) ? $_REQUEST["iRentItemPostId"] : '';
    $iUserWalletId = isset($_REQUEST["iUserWalletId"]) ? $_REQUEST["iUserWalletId"] : '';

    if (!empty($iPaymentPlanId) && !empty($iTmpRentItemPostId)) {
        $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='" . $iMemberId . "'");
        $vLanguage = $row[0]['vLang'];
        if ($vLanguage == "" || $vLanguage == NULL) {
            $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $row[0]['vCurrencyPassenger'] . "'");

        $getRentItemPaymentPlanAmount = $RENTITEM_OBJ->getRentItemPlan("webservice", $iPaymentPlanId, $vLanguage);

        if (!empty($iPaymentPlanId) && !empty($iMemberId)) {
            $paymentlogData = $obj->MySQLSelect("SELECT * FROM `rentitem_payment_log` WHERE iUserId = '" . $iMemberId . "'  AND iPaymentPlanId = '" . $iPaymentPlanId . "' AND eStatus = 'Active'  ORDER BY iUserPaymentPlanId DESC LIMIT 1");
            $iTotalPost = $paymentlogData[0]['iTotalPost'];

            if ($iTotalPost >= 1 && $getRentItemPaymentPlanAmount['iTotalPost'] > 0) {
                $ePaymentOption = "card";
                $payStatus = "succeeded";
            }
        }

        $rentitemdata = $obj->MySQLSelect("SELECT iRentItemPostId FROM `rentitem_post` WHERE iTmpRentItemPostId='" . $iTmpRentItemPostId . "'");
        $iRentItemPostId = $rentitemdata[0]['iRentItemPostId'];

        if ($getRentItemPaymentPlanAmount['eFreePlan'] == 'Yes') {
            $isfree = $getRentItemPaymentPlanAmount['eFreePlan'];
            $getRentItemData = $RENTITEM_OBJ->createRentItemFinalPost("webservice", $iTmpRentItemPostId, $iRentItemPostId, $iMemberId, $iPaymentPlanId, $vLanguage, $isfree);

            if (empty($iRentItemPostId)) {
                $iRentItemPostId = $getRentItemData['iRentItemPostId'];
            }

            $getRentItemLogData = $RENTITEM_OBJ->createRentItemlog("webservice", $iRentItemPostId, $iMemberId, $vLanguage);

            if ($getRentItemPaymentPlanAmount['iTotalPost'] > 0) {
                $getRentItemLogPaymentData = $RENTITEM_OBJ->createRentItemPaymentlog("webservice", $iPaymentPlanId, $iRentItemPostId, $iMemberId, $vLanguage);
            }

            $sql = "SELECT vEmail,vLastName,vName FROM register_user where  iUserId =  '" . $iMemberId . "'";
            $data_user = $obj->MySQLSelect($sql);

            $vEmail = $data_user[0]['vEmail'];
            $vName = mb_convert_case($data_user[0]['vName'], MB_CASE_TITLE, 'UTF-8');
           // $vName = ucfirst($data_user[0]['vName']);
            $vLastName = $data_user[0]['vLastName'];

            $mailTemplate = "USER_RENT_ITEM_POSTED";

            $maildata['EMAIL'] = $vEmail;
            $maildata['NAME'] =  mb_convert_case($vName, MB_CASE_TITLE, 'UTF-8') . ' ' . $vLastName;	//ucfirst($vName) . ' ' . $vLastName;
            $maildata['RENT_ITEM_NAME'] = $getRentItemData['vItemName'];
            $maildata['RENT_POST_NO'] = $getRentItemData['vRentItemPostNo'];

            $COMM_MEDIA_OBJ->SendMailToMember($mailTemplate, $maildata);

            if (!empty($getRentItemData)) {

                $returnArr['Action'] = "1";

                $returnArr['message'] = "LBL_RENT_POST_SUCCESS_TXT";
            } else {
                $returnArr['Action'] = "0";

                $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
            }
        } else {
            if ($ePaymentOption != "" && $payStatus == "succeeded") {
                if (!empty($iRentItemPostId)) {
                    $getRentItemData = $RENTITEM_OBJ->createRentItemFinalPost("webservice", $iTmpRentItemPostId, $iRentItemPostId, $iMemberId, $iPaymentPlanId, $vLanguage);
                } else {
                    $getRentItemData = $RENTITEM_OBJ->createRentItemFinalPost("webservice", $iTmpRentItemPostId, $iRentItemPostId, $iMemberId, $iPaymentPlanId, $vLanguage);
                }

                if (empty($iRentItemPostId)) {
                    $iRentItemPostId = $getRentItemData['iRentItemPostId'];
                }

                $getRentItemLogData = $RENTITEM_OBJ->createRentItemlog("webservice", $iRentItemPostId, $iMemberId, $vLanguage);

                if ($getRentItemPaymentPlanAmount['iTotalPost'] > 0) {
                    $getRentItemLogPaymentData = $RENTITEM_OBJ->createRentItemPaymentlog("webservice", $iPaymentPlanId, $iRentItemPostId, $iMemberId, $vLanguage);
                }

                if ($iTotalPost >= 1) {

                    $where_rentitem = " iRentItemPostId = '" . $iRentItemPostId . "'";

                    $data_rentitems['ePaid'] = 'Yes';
                    $data_rentitems['eUserPayment'] = 'Settled';
                    $data_rentitems['ePaymentOption'] = $ePaymentOption;
                    $obj->MySQLQueryPerform("rentitem_post", $data_rentitems, 'update', $where_rentitem);


                    $returnArr['Action'] = "1";

                    $returnArr['message'] = "LBL_RENT_POST_SUCCESS_TXT";

                } else {

                    if ($ePaymentOption == "card" && $tPaymentId != "") {

                        $where_rentitem = " iRentItemPostId = '" . $getRentItemData['iRentItemPostId'] . "'";

                        $data_rentitems['iPaymentInfoId'] = $tPaymentId;

                        $data_rentitems['ePaid'] = 'Yes';

                        $data_rentitems['eUserPayment'] = 'Settled';

                        $data_rentitems['ePaymentOption'] = $ePaymentOption;

                        $obj->MySQLQueryPerform("rentitem_post", $data_rentitems, 'update', $where_rentitem);

                        $where_payments = " iPaymentId = '" . $tPaymentId . "'";

                        $data_payments['iRentItemPostId'] = $getRentItemData['iRentItemPostId'];

                        $obj->MySQLQueryPerform("payments", $data_payments, 'update', $where_payments);
                    } else {

                        $fWalletDebit = $obj->MySQLSelect("SELECT iBalance FROM `user_wallet` WHERE iUserWalletId='" . $iUserWalletId . "'");

                        $where_rentitem = " iRentItemPostId = '" . $getRentItemData['iRentItemPostId'] . "'";

                        $data_rentitems['eWalletDebit'] = 'Yes';

                        $data_rentitems['ePaid'] = 'Yes';

                        $data_rentitems['eUserPayment'] = 'Settled';

                        $data_rentitems['fWalletDebit'] = $fWalletDebit[0]['iBalance'];

                        $data_rentitems['ePaymentOption'] = "Wallet";

                        $obj->MySQLQueryPerform("rentitem_post", $data_rentitems, 'update', $where_rentitem);

                        $where_payments = " iUserWalletId = '" . $iUserWalletId . "'";

                        $data_payments['iRentItemPostId'] = $getRentItemData['iRentItemPostId'];

                        $obj->MySQLQueryPerform("user_wallet", $data_payments, 'update', $where_payments);
                    }

                    $returnUrl = $tconfig['tsite_url'] . "assets/libraries/webview/success.php";
                    header('Location:' . $returnUrl . "?success=1&SYSTEM_TYPE=APP");
                    exit;
                }
            } else {

                $tDescription = "Amount charge for RentItem Post";
                $fAmount = $getRentItemPaymentPlanAmount['fAmount'];
                $extraParams = "eType=&ePaymentType=ChargeRentItemPostAmount&tSessionId=" . $row[0]['tSessionId'] . "&GeneralMemberId=" . $iMemberId . "&GeneralUserType=Passenger&iServiceId=&AMOUNT=" . $fAmount . "&iTmpRentItemPostId=" . $iTmpRentItemPostId . "&iPaymentPlanId=" . $iPaymentPlanId . "&iRentItemPostId=" . $iRentItemPostId . "&vLanguage=" . $vLanguage . "&PAGE_TYPE=CHARGE_RENTITEM_POST&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes&description=" . urlencode($tDescription);

                $returnArr['Action'] = "1";

                $returnArr['RENTITEM_PAYMENT_URL'] = $tconfig['tsite_url'] . 'assets/libraries/webview/payment_mode_select.php?' . $extraParams;
            }
        }
    } else {

        $returnArr['Action'] = "0";

        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }

    setDataResponse($returnArr);
}
// To get posts for user history
if ($type == "GetAllPost") {
    $iUserId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iRentItemPostId = isset($_REQUEST['iRentItemPostId']) ? clean($_REQUEST['iRentItemPostId']) : '';
    $eType = isset($_REQUEST['eType']) ? clean($_REQUEST['eType']) : '';
    $postpage = isset($_REQUEST['page']) ? trim($_REQUEST['page']) : 1;

    $tblName = "register_user";
    if (isset($userDetailsArr[$tblName . "_" . $iUserId]) && count($userDetailsArr[$tblName . "_" . $iUserId]) > 0) {
        $Data = $userDetailsArr[$tblName . "_" . $iUserId];
    } else {
        $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
    }

    $vLanguage = $Data[0]['vLang'];
    if ($vLanguage == "" || $vLanguage == NULL) {
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    //$currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $Data[0]['vCurrencyPassenger'] . "'");

    $getRentItemPostData = $RENTITEM_OBJ->getRentItemPostFinal("webservice", $iRentItemPostId, $iUserId, $vLanguage, "", "", $eType);
    $TotalPages = $getRentItemPostData[0]['TotalPages'];
    
    if (!empty($getRentItemPostData)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $getRentItemPostData;
        if ($TotalPages > $postpage) {
            $returnArr['NextPage'] = "" . ($postpage + 1);
        } else {
            $returnArr['NextPage'] = "0";
        }
    } else {

        $returnArr['Action'] = "0";

        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}

// To delete post
if ($type == "DeletePost") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iRentItemPostId = isset($_REQUEST['iRentItemPostId']) ? clean($_REQUEST['iRentItemPostId']) : '';
    $eDeletedBy = isset($_REQUEST['eDeletedBy']) ? clean($_REQUEST['eDeletedBy']) : '';

    $tblName = "register_user";
    if (isset($userDetailsArr[$tblName . "_" . $iUserId]) && count($userDetailsArr[$tblName . "_" . $iUserId]) > 0) {
        $Data = $userDetailsArr[$tblName . "_" . $iUserId];
    } else {
        $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
    }

    $vLanguage = $Data[0]['vLang'];
    if ($vLanguage == "" || $vLanguage == NULL) {
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
    }

    $RENTITEM_OBJ->rentPostDelete($iMemberId, $iRentItemPostId, $eDeletedBy, $vLanguage);
}

// To get posts for all user in main page
if ($type == "GetRentPostForAllUser") {

    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iCategoryId = isset($_REQUEST['iCategoryId']) ? clean($_REQUEST['iCategoryId']) : '';
    $search_keyword = isset($_REQUEST['search_keyword']) ? clean($_REQUEST['search_keyword']) : '';
    $passengerLat = isset($_REQUEST['passengerLat']) ? clean($_REQUEST['passengerLat']) : '';
    $passengerLon = isset($_REQUEST['passengerLon']) ? clean($_REQUEST['passengerLon']) : '';
    $iSubCategoryIds = isset($_REQUEST['iSubCategoryIds']) ? clean($_REQUEST['iSubCategoryIds']) : '';
    $iSelectedOptionIds = isset($_REQUEST['iSelectedOptionIds']) ? clean($_REQUEST['iSelectedOptionIds']) : '';
    $eType = isset($_REQUEST['eType']) ? clean($_REQUEST['eType']) : '';
    $isBuySell = isset($_REQUEST['isBuySell']) ? clean($_REQUEST['isBuySell']) : '';
    $page = isset($_REQUEST['page']) ? trim($_REQUEST['page']) : 1;
    
    $tblName = "register_user";
    if (isset($userDetailsArr[$tblName . "_" . $iMemberId]) && count($userDetailsArr[$tblName . "_" . $iMemberId]) > 0) {
        $Data = $userDetailsArr[$tblName . "_" . $iMemberId];
    } else {
        $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iMemberId . "'");
        $userDetailsArr[$tblName . "_" . $iMemberId] = $Data;
    }

    $vLanguage = $Data[0]['vLang'];
    if ($vLanguage == "" || $vLanguage == NULL) {
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $Data[0]['vCurrencyPassenger'] . "'");

    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", $iServiceId);

    if (!empty($eType)) {
        $iMasterServiceCategoryId = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', $eType, '', 'true');
        $msql = "";
        if (!empty($iMasterServiceCategoryId)) {
            $msql = " AND iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
        }
    } else {
        $iMasterServiceCategoryId = get_value('rent_items_category', 'iMasterServiceCategoryId', 'iRentItemId ', $iCategoryId, '', 'true');
        if (!empty($iMasterServiceCategoryId)) {
            $msql = " AND iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
        }
    }

    $MainCatArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $vLanguage);

    /*
    $MainCatArr_new[0]['vTitle'] = addslashes($languageLabelsArr['LBL_ALL']);
    $MainCatArr_new[0]['iCategoryId'] = "";
    $MainCatArr_new[0]['vCategory'] = "";
    $MainCatArr_new[0]['vImage'] = $tconfig['tsite_upload_images_rent_item'];
    $MainCatArr_new[0]['eCatType'] = "RentItem";
    $MainCatArr_new[0]['vListLogo'] = $tconfig['tsite_upload_images_rent_item'];

    $MainCatArr = array_merge($MainCatArr_new, $MainCatArr);
    $MainCatArr = array_values($MainCatArr);*/

    $catarray = array();
    foreach ($MainCatArr as $key => $Rentvalue) {
        $vBgColor = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $vTextColor = $vBorderColor = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
        $Rentvalue['vBgColor'] = !empty($Rentvalue['vBgColor']) ? $Rentvalue['vBgColor'] : $vBgColor;
        $Rentvalue['vTextColor'] = !empty($Rentvalue['vTextColor']) ? $Rentvalue['vTextColor'] : $vTextColor;
        $Rentvalue['vBorderColor'] = !empty($Rentvalue['vBorderColor']) ? $Rentvalue['vBorderColor'] : $vBorderColor;
        $catarray[] = $Rentvalue;
    }
    $RentCatarray = array();

    if (!empty($iCategoryId)) {
        $sortArrayVehicleSelected = explode(',', $iCategoryId);
    }

    foreach ($catarray as $k => $catval) {

        if (!in_array($catval['iCategoryId'], $sortArrayVehicleSelected)) {
            $sortArrayVehicleSelected[] = $catval['iCategoryId'];
        }
        $RentCatarray[$catval['iCategoryId']] = $catval;
    }
    $keyexist = array_search($iCategoryId, array_column($RentCatarray, 'iCategoryId'));

    if (!empty($keyexist)) {
        $RentCatarray = array_replace(array_flip($sortArrayVehicleSelected), $RentCatarray);
        $catarray = array_values($RentCatarray);
    }

    $getRentItemPostData = $RENTITEM_OBJ->getRentItemPostFinal("webservice", "", $iMemberId, $vLanguage, "All", $iCategoryId);

    $arrayDataFinal = array();

    $whereloc = " AND iLocationid IN ('-1')";
    if ($MODULES_OBJ->isEnableLocationwiseBanner()) {
        $User_Address_Banner = array($passengerLat, $passengerLon);
        if (!empty($User_Address_Banner)) {
            $iLocationIdBanner = GetUserGeoLocationIdBanner($User_Address_Banner);
            $country_str_banner = "'-1'";
            if (count($iLocationIdBanner) > 0) {
                foreach ($iLocationIdBanner as $key => $value) {
                    $country_str_banner .= ", '" . $value . "'";
                }
                $whereloc = " AND iLocationid IN (" . $country_str_banner . ")";
            }
        }
    }
    $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $vLanguage . "' AND vImage != '' AND eStatus = 'Active' $msql AND eType = '" . $eType . "' $whereloc ORDER BY iDisplayOrder ASC");
    $dataOfBanners = array();
    $count = 0;
    for ($i = 0; $i < count($Data_banners); $i++) {
        if (isset($Data_banners[$i]['vImage']) && $Data_banners[$i]['vImage'] != "") {
            $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
            $dataOfBanners[$count]['vStatusBarColor'] = $Data_banners[$i]['vStatusBarColor'];
            $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
            if (file_exists($banner_img_path) && empty($Data_banners[$i]['vStatusBarColor'])) {
                $dataOfBanners[$count]['vStatusBarColor'] = getColorFromImage($banner_img_path);
                $obj->sql_query("UPDATE banners SET vStatusBarColor = '" . $dataOfBanners[$count]['vStatusBarColor'] . "' WHERE iUniqueId = '" . $Data_banners[$i]['iUniqueId'] . "'");
            }
            $count++;
        }
    }

    $arrayDataFinal['MainCatTitle'] = isset($languageLabelsArr['LBL_RENT_BROWSE_CATEGORIES']) ? addslashes($languageLabelsArr['LBL_RENT_BROWSE_CATEGORIES']) : 'Browse Categories';

    $arrayDataFinal['CategoriesData'] = $catarray;

    //if(isset($_REQUEST['test'])){
    if (!empty($search_keyword) && !empty($getRentItemPostData)) {
        foreach ($getRentItemPostData as $key => $value) {
            $main_cat = 0;

            if (stripos($value['vItemName'], $search_keyword) !== false) {
                $main_cat = 1;
            }

            if ($main_cat == 0) {
                unset($getRentItemPostData[$key]);
            }
        }
        $getRentItemPostData = array_values($getRentItemPostData);
    }

    //}

    if (!empty($iSubCategoryIds) && !empty($getRentItemPostData)) {
        $SelectedSubCategoryIdsArray = explode(",", $iSubCategoryIds);
        foreach ($getRentItemPostData as $rk => $rvalue) {
            $main_cat = 0;
            foreach ($SelectedSubCategoryIdsArray as $catk => $catvalue) {

                if ($rvalue['iItemSubCategoryId'] == $catvalue) {
                    $main_cat = 1;
                }
                if ($main_cat == 0) {
                    unset($getRentItemPostData[$rk]);
                }
            }
        }
        $getRentItemPostData = array_values($getRentItemPostData);
    }

    if(!empty($isBuySell) && !empty($getRentItemPostData)){

        foreach ($getRentItemPostData as $rk => $rvalue) {
            $main_cat = 0;
           
            if ($rvalue['isBuySell'] == $isBuySell) {
                $main_cat = 1;
            }

            if ($main_cat == 0) {
                unset($getRentItemPostData[$rk]);
            }

        }
        
        $getRentItemPostData = array_values($getRentItemPostData);
    }

    if (!empty($iSelectedOptionIds) && !empty($getRentItemPostData)) {
        $iSelectedOptionIds = explode(",", $iSelectedOptionIds);
        
        foreach ($getRentItemPostData as $rk => $rvalue) {
            $main_cat = 0;
            $result = array_intersect($iSelectedOptionIds, $rvalue['tFieldsArr']);

            if (!empty($result) && (array_diff($result,$iSelectedOptionIds) == array_diff($iSelectedOptionIds,$result))) {
                $main_cat = 1;
            }

            if ($main_cat == 0) {
                unset($getRentItemPostData[$rk]);
            }

        }
        
        $getRentItemPostData = array_values($getRentItemPostData);
    }
  
    if (!empty($getRentItemPostData) && $passengerLat != "" && $passengerLon != "") {
        foreach ($getRentItemPostData as $key => $value) {
            $vLatitude = $value['vLatitude'];
            $vLongitude = $value['vLongitude'];
            $distance = distanceByLocation($passengerLat, $passengerLon, $vLatitude, $vLongitude, "K");

            $isRemoveAddressFromList = "No";

            if ($distance > $RENT_ITEM_RADIUS_TO_SHOW) {
                $isRemoveAddressFromList = "Yes";
            }

            if ($isRemoveAddressFromList == "Yes") {
                unset($getRentItemPostData[$key]);
            }
        }

        $getRentItemPostData = array_values($getRentItemPostData);
    }


    if (!empty($getRentItemPostData)) {
        foreach ($getRentItemPostData as $rentk => $rentval) {
            if (!empty($eType)) {
                $getRentItemPostData[$rentk]['eType'] = $eType;
            }
        }
    }


    $featuredArray = $freeArray =  array();
    foreach ($getRentItemPostData as $rentitemkey => $rentitemvalue) {
        if($rentitemvalue['eFreePlan'] == "Yes"){
            $freeArray[] = $rentitemvalue;
        } else {
            $featuredArray[] = $rentitemvalue;
        }
    }

    $featuredArray1 = array_chunk($featuredArray, 2);
    $freeArray1 = array_chunk($freeArray, 2);

    $newArr = array();
    if(!empty($featuredArray1)){
        $featuredArray1Total = count($featuredArray1);
        $freeArray1Total =count($freeArray1);
        if($featuredArray1Total > $freeArray1Total){
            foreach ($featuredArray1 as $fkey => $fvalue) {
                foreach ($fvalue as $k1 => $val1) {
                    $newArr[] = $val1;
                }

                if(isset($freeArray1[$fkey])) {
                    foreach ($freeArray1[$fkey] as $k2 => $val2) {
                        $newArr[] = $val2;
                    }
                }

            }
        } else {
            foreach ($freeArray1 as $fkey => $fvalue) {
                if(isset($featuredArray1[$fkey])) {
                    foreach ($featuredArray1[$fkey] as $k1 => $val1) {
                        $newArr[] = $val1;
                    }
                }
                
                foreach ($fvalue as $k2 => $val2) {
                    $newArr[] = $val2;
                }
                
            }
        }
        
    } else {
        foreach ($freeArray1 as $fk2 => $fval2) {
            foreach ($fval2 as $fk1 => $fval1) {
                $newArr[] = $fval1;
            }
        }
    }
 
    $getRentItemPostData = $newArr;
    
    $total = count($getRentItemPostData);
    $per_page = 6;
    $totalPages = ceil($total / $per_page);
    $start_limit = ($page - 1) * $per_page;
    $getRentItemPostData = array_slice($getRentItemPostData, $start_limit, $per_page);

    if (empty($getRentItemPostData)) {
        $arrayDataFinal['message1'] = "LBL_NO_DATA_AVAIL";
    }
    
    $arrayDataFinal['RentItemData'] = $getRentItemPostData;
    if (!empty($arrayDataFinal)) {
        $returnArr['Action'] = "1";
        $returnArr['BANNER_DATA'] = $dataOfBanners;
        $returnArr['message'] = $arrayDataFinal;
        $returnArr['totalPages'] = $totalPages;
        if ($totalPages > $page) {
            $returnArr['NextPage'] = ($page + 1);
        } else {
            $returnArr['NextPage'] = "0";
        }
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
    
}

// To get posts for owner history
if ($type == "getAllPostOwner") {
    $iUserId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iRentItemPostId = isset($_REQUEST['iRentItemPostId']) ? clean($_REQUEST['iRentItemPostId']) : '';

    $tblName = "register_user";
    if (isset($userDetailsArr[$tblName . "_" . $iUserId]) && count($userDetailsArr[$tblName . "_" . $iUserId]) > 0) {
        $Data = $userDetailsArr[$tblName . "_" . $iUserId];
    } else {
        $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
        $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
    }

    $vLanguage = $Data[0]['vLang'];
    if ($vLanguage == "" || $vLanguage == NULL) {
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
    }
    $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $Data[0]['vCurrencyPassenger'] . "'");

    $getRentItemPostData = $RENTITEM_OBJ->getRentItemPostFinalOwner("webservice", $iRentItemPostId, $iUserId, $vLanguage);

    if (!empty($getRentItemPostData)) {
        $returnArr['Action'] = "1";
        $returnArr['message'] = $getRentItemPostData;
    } else {

        $returnArr['Action'] = "0";

        $returnArr['message'] = "LBL_NO_DATA_AVAIL";
    }
    setDataResponse($returnArr);
}
// To add post as favourite
if ($type == "UpdateUserFavouriteRentPost") {
    $iMemberId = isset($_REQUEST['iMemberId']) ? clean($_REQUEST['iMemberId']) : '';
    $iRentItemPostId = isset($_REQUEST['iRentItemPostId']) ? clean($_REQUEST['iRentItemPostId']) : '';
    $eIsFavourite = isset($_REQUEST['eIsFavourite']) ? clean($_REQUEST['eIsFavourite']) : 'No';

    $RENTITEM_OBJ->UpdateUserFavouriteRentPost($iMemberId, $iRentItemPostId, $eIsFavourite);
}

if ($type == 'sendContactQueryForRent') {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';
    $iRentItemOwnerId = isset($_REQUEST["iRentItemOwnerId"]) ? $_REQUEST["iRentItemOwnerId"] : '';
    $iRentItemPostId = isset($_REQUEST["iRentItemPostId"]) ? $_REQUEST["iRentItemPostId"] : '';
    $iName = isset($_REQUEST["iName"]) ? $_REQUEST["iName"] : '';
    $iEmail  = isset($_REQUEST["iEmail"]) ? $_REQUEST["iEmail"] : '';
    $iMobileNo  = isset($_REQUEST["iMobileNo"]) ? $_REQUEST["iMobileNo"] : '';
    $iPhoneCode  = isset($_REQUEST["iPhoneCode"]) ? $_REQUEST["iPhoneCode"] : '';

    $result_data = $obj->MySQLSelect("SELECT vName,vLastName,vPhone,vEmail FROM register_user WHERE iUserId=$iMemberId");

    $tblName = "register_user";

    if (isset($userDetailsArr[$tblName . "_" . $iRentItemOwnerId]) && count($userDetailsArr[$tblName . "_" . $iRentItemOwnerId]) > 0) {
        $result_data_owner = $userDetailsArr[$tblName . "_" . $iRentItemOwnerId];
    } else {
        $result_data_owner = $obj->MySQLSelect("SELECT *,iUserId as iRentItemOwnerId FROM " . $tblName . " WHERE iUserId='" . $iRentItemOwnerId . "'");
        $userDetailsArr[$tblName . "_" . $iRentItemOwnerId] = $result_data_owner;
    }

    $vLanguage = $result_data_owner[0]['vLang'];

    if ($vLanguage == "" || $vLanguage == NULL) {
        $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
    }

    $getRentItemPostData = $RENTITEM_OBJ->getRentItemPostFinalOwner("webservice", $iRentItemPostId, $iRentItemOwnerId, $vLanguage);

    if ($iMemberId != "") {
        $Data['RiderName'] = isset($iName) ? $iName : $result_data[0]['vName'] . " " . $result_data[0]['vLastName'] ;
        $Data['OwnerName'] = $result_data_owner[0]['vName'] . " " . $result_data_owner[0]['vLastName'];
        $Data['vEmail'] = isset($iEmail) ? $iEmail : $result_data[0]['vEmail'];
        $Data['vOwnerEmail'] = $result_data_owner[0]['vEmail'];
        $Data['cellno'] = isset($iMobileNo) ? $iPhoneCode.$iMobileNo : $iPhoneCode.$result_data[0]['vPhone'];
        $Data['RentItemName'] = $getRentItemPostData[0]['vItemName'];
        $Data['vRentItemPostNo'] = $getRentItemPostData[0]['vRentItemPostNo'];

        if (strtoupper(SITE_TYPE) == "LIVE") {
            $resultemail = $COMM_MEDIA_OBJ->SendMailToMember("USER_RENT_ITEM_INQUIRY", $Data);

            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("USER_RENT_ITEM_INQUIRY", $Data, "", $vLanguage);
            $rentownerphone = $result_data_owner[0]['vPhone'];
            $phoneCode = $result_data_owner[0]['vPhoneCode'];
            $resultsms = $COMM_MEDIA_OBJ->SendSystemSMS($rentownerphone, $phoneCode, $message_layout);

        }

    }

        $InquiryArray = array();
        $InquiryArray['iMemberId']= $iMemberId;
        $InquiryArray['iRentItemOwnerId']= $iRentItemOwnerId;
        $InquiryArray['iRentItemPostId']= $iRentItemPostId;

        $createItemInquirylog = $RENTITEM_OBJ->createItemInquirylog("webservice",$InquiryArray,$vLanguage);
        
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_RENT_SENT_CONTACT_QUERY_SUCCESS_TXT";


    setDataResponse($returnArr);
}

if ($type == 'DeleteRentItemImages') {
    $iMemberId = isset($_REQUEST["iMemberId"]) ? $_REQUEST["iMemberId"] : '';

    $ssql = "";
    if (!empty($iMemberId)) {
        $ssql .= " AND iRentItemPostId = 0  AND iTmpRentItemPostId = 0";
    }
    $getImages = $obj->MySQLSelect("SELECT * FROM rentitem_images WHERE iUserId='" . $iMemberId . "' $ssql ");

    $Photo_Gallery_folder = $tconfig['tsite_upload_images_rent_item_path'];
    $imgarray = array();
    foreach ($getImages as $key => $value) {
        $OldImageName = get_value('rentitem_images', 'vImage', 'iRentImageId', $value['iRentImageId'], '', 'true');
        if ($OldImageName != '') {
            unlink($Photo_Gallery_folder . $OldImageName);
        }

        $imgarray[] = $value['iRentImageId'];
    }

    if (!empty($imgarray)) {
        $imgstring = implode(",", $imgarray);
        $sql = "DELETE FROM rentitem_images WHERE `iRentImageId`IN (" . $imgstring . ")";
        $id = $obj->sql_query($sql);
        if ($id > 0) {
            $returnArr['Action'] = "1";
            //$returnArr['message'] = "LBL_IMAGE_DELETE_SUCCESS_NOTE";
        } else {
            $returnArr['Action'] = "0";
            //$returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
    } else {
        $returnArr['Action'] = "1";
    }

    setDataResponse($returnArr);
}

if ($type == "getFilterRentData") {
    $userId = isset($_REQUEST['userId']) ? clean($_REQUEST['userId']) : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $iCategoryId = isset($_REQUEST["iCategoryId"]) ? $_REQUEST["iCategoryId"] : '';
    $eType = isset($_REQUEST["eType"]) ? $_REQUEST["eType"] : '';

    if ($userId != "") {
        $lang = $vGeneralLang;
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $userId])) {
            $row = $userDetailsArr['register_user_' . $userId];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$userId'");
            $userDetailsArr['register_user_' . $userId] = $row;
        }
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
        $lang = $row[0]['vLang'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
        }
        $returnArr['Action'] = "1";
        if (!empty($eType)) {
            $iMasterServiceCategoryId = get_value($master_service_category_tbl, 'iMasterServiceCategoryId', 'eType', $eType, '', 'true');
            $msql = "";
            if (!empty($iMasterServiceCategoryId)) {
                $msql = " AND iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "' AND iRentItemId ='" . $iCategoryId . "'";
            }
        }

        $MainCatArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "0");

        $rentitemarray = array();
        foreach ($MainCatArr as $catk => $catval) {
            $rentitemarray['headerTitle'] = $languageLabelsArr['LBL_RENT_CHOOSE_SUB_CATEGORY'];
            $rentitemarray['vCategoryTitle'] = $catval['vTitle'];
            $rentitemarray['iCategoryId'] = $catval['iCategoryId'];
            //$rentitemarray['vImage'] = $catval['vImage'];
            //$rentitemarray['vImage1'] = $catval['vImage1'];

            $reqArr = array('vTitle', 'iCategoryId', 'vImage', 'vImage1', 'iCategoryId');
            $DatanewArr = $RENTITEM_OBJ->getRentItemSubCategory('webservice', $catval['iCategoryId'], '', '', '', $lang, '', $reqArr);
            $DatanewArray = array();
            foreach ($DatanewArr as $subk => $subvalue) {
                $DatanewArray[$subk]['vTitle'] = $subvalue['vTitle'];
                $DatanewArray[$subk]['iSubCategoryId'] = $subvalue['iCategoryId'];
                $DatanewArray[$subk]['vImage'] = $subvalue['vImage'];
            }
            $rentitemarray['subData'] = $DatanewArray;
        }

        $getRentItemFields = $RENTITEM_OBJ->getRentItemFields("webservice", "", $iCategoryId, "", $lang);
        
        $FieldsData = array();
        foreach ($getRentItemFields as $k => $FielsDataVal) {
            if (($FielsDataVal['eInputType'] != 'Select') || ($FielsDataVal['eInputType'] == 'Select' && $FielsDataVal['eListing'] == 'Yes')) {
                continue;
            } else {
                $FieldsData[$k]['headerTitle'] = $FielsDataVal['tFieldName'];
                $FieldsData[$k]['iRentFieldId'] = $FielsDataVal['iRentFieldId'];
                $FieldsData[$k]['iCategoryId'] = $FielsDataVal['iRentItemId'];
                $FieldsData[$k]['subData'] = $FielsDataVal['Options'];
            }
        }

        foreach ($rentitemarray as $rentkey => $rentvalue) {
            if (empty($rentvalue['subData'])) {
                unset($rentitemarray[$rentkey]);
            }
        }
        $rentitemarray = array_values($rentitemarray);

        $rentitemMainarray = array();
        if (!empty($rentitemarray)) {
            $rentitemMainarray[] = $rentitemarray;
        }
        foreach ($FieldsData as $k => $valarr) {
            $rentitemMainarray[] = $valarr;
        }

        /*$subarray = array(
            array("vTitle"=>$languageLabelsArr['LBL_RENT_FREE'],"vFieldName"=>$languageLabelsArr['LBL_RENT_FREE']),
            array("vTitle"=>$languageLabelsArr['LBL_RENT_FEATURED'],"vFieldName"=>$languageLabelsArr['LBL_RENT_FEATURED']),
        );

        $FieldsDataNew = array();
        $FieldsDataNew['headerTitle'] = $languageLabelsArr['LBL_RENT_PLAN_TXT'];
        $FieldsDataNew['iRentFieldId'] = "";
        $FieldsDataNew['iCategoryId'] = $iCategoryId;
        $FieldsDataNew['subData'] = $subarray;
        
        $rentitemMainarray[] = $FieldsDataNew;*/

        $returnArr['message'] = $rentitemMainarray;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }

    setDataResponse($returnArr);
}
/*--------------------- nearBy ------------------*/
if ($type == "getNearByPlaces") {
    $NEARBY_OBJ->getUserNearByPlaces('webservice');
}
/*--------------------- nearBy ------------------*/

/* ------------------------- Track Service ------------------------- */
if ($type == "listTrackingUsers") {
    $MemberType = isset($_REQUEST["MemberType"]) ? $_REQUEST["MemberType"] : '';
    if(!empty($MemberType)) {
        $TRACK_ANY_SERVICE_OBJ->listTrackingUsers(0, $MemberType);    
    } else {
        $TRACK_SERVICE_OBJ->listTrackingUsers();
    }    
}
if ($type == "verifyTrackServiceInviteCode") {
    $TRACK_SERVICE_OBJ->verifyInviteCode();
}
if ($type == "initiateTrackingTrip") {
    $TRACK_SERVICE_OBJ->initiateTrackingTrip();
}
if ($type == "updateTrackingTripStatus") {
    $TRACK_SERVICE_OBJ->updateTrackingTripStatus();
}
if ($type == "getTrackingTripsDriver") {
    $TRACK_SERVICE_OBJ->getTrackingTripsDriver();
}
if ($type == "uploadImageForTrackingUser") {
    $TRACK_SERVICE_OBJ->uploadImageForTrackingUser();
}
if ($type == "GeneratePairingCode") {
    $TRACK_ANY_SERVICE_OBJ->getPairingCode();
}
if($type == "verifyTrackServicePairingCode") {
    $TRACK_ANY_SERVICE_OBJ->verifyPairingCode();
}
if ($type == "sendAuthOtpTracking") {
    $TRACK_ANY_SERVICE_OBJ->sendAuthOtpTracking();
}
if ($type == "pairTrackingUser") {
    $TRACK_ANY_SERVICE_OBJ->pairTrackingUser();
}
if ($type == "removeLinkedMember") {
    $TRACK_ANY_SERVICE_OBJ->removeLinkedMember();
}
if ($type == "checkTrackingProfileSetup") {
    $MemberType = isset($_REQUEST["MemberType"]) ? $_REQUEST["MemberType"] : '';

    $returnArr['Action'] = "1";
    $returnArr['message'] = $TRACK_ANY_SERVICE_OBJ->getCategories(array(), $MemberType);
    setDataResponse($returnArr);
}
if($type == "updateLocationTrackingStatus") {
    $TRACK_ANY_SERVICE_OBJ->updateLocationTrackingStatus();
}
/* ------------------------- Track Service End ------------------------- */

/* ------------------------- Ride Share Service ------------------------- */
if ($type == "PublishRideUploadDocuments") {
    $iUserId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : "";
    $vLang = isset($_REQUEST['vGeneralLang']) ? $_REQUEST['vGeneralLang'] : "";
    $iDocumentId = isset($_REQUEST['doc_id']) ? $_REQUEST['doc_id'] : "";
    $doc_masterid = isset($_REQUEST['doc_masterid']) ? $_REQUEST['doc_masterid'] : "";
    $ex_date = isset($_REQUEST['ex_date']) ? $_REQUEST['ex_date'] : "";
    $image_name = isset($_FILES['vImage']['name']) ? $_FILES['vImage']['name'] : '';
    $image_object = isset($_FILES['vImage']['tmp_name']) ? $_FILES['vImage']['tmp_name'] : '';
    $doc_file = isset($_REQUEST['doc_file']) ? clean($_REQUEST['doc_file']) : '';
    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", "");

    if ($doc_file != "") {
        $vImgName = basename($doc_file);

    } else {
        $img_path = $tconfig["tsite_upload_ride_share_documents_path"];
        $temp_gallery = $img_path . '/';
        $filecheck = basename($image_name);
        $fileextarr = explode(".", $filecheck);
        $ext = strtolower($fileextarr[count($fileextarr) - 1]);
        if ($ext != "jpg" && $ext != "png" && $ext != "jpeg" && $ext != "bmp" && $ext != "heic" && $ext != "pdf" && $ext != "doc" && $ext != "docx") {
            $var_msg = $languageLabelsArr['LBL_FILE_EXT_VALID_ERROR_MSG'] . " .jpg, .jpeg, .png, .bmp, .heic, .pdf, .doc, .docx";
            $returnArr['Action'] = "0";
            $returnArr['message'] = $var_msg;
            setDataResponse($returnArr);
        }
        $Photo_Gallery_folder = $img_path . '/' . $iUserId . '/';
        $Photo_Gallery_folder_temp = $img_path . '/' . $iUserId . '/';
        if (!is_dir($img_path . '/')) {
            mkdir($img_path . '/', 0777);
            chmod($img_path . '/', 0777);
        }
        if (!is_dir($Photo_Gallery_folder)) {
            mkdir($Photo_Gallery_folder, 0777);
            chmod($Photo_Gallery_folder, 0777);
        }
        $img1 = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder_temp, $image_object, $image_name, '', 'jpg,png,jpeg,bmp,heic,pdf,doc,docx');
        $vImgName = $img1[0];
    }

    if (!empty($vImgName)) {
        $Data_insert['doc_masterid'] = $doc_masterid;
        $Data_insert['doc_userid'] = $iUserId;
        if (!empty($ex_date)) {
            $Data_insert['ex_date'] = date('Y-m-d', strtotime($ex_date));
        }
        $Data_insert['doc_userid'] = $iUserId;
        $Data_insert['doc_file'] = $vImgName;
        //$Data_insert['doc_file'] = $vImgName;
        $Data_insert['dAddedDate'] = date('Y-m-d H:i:s');
        if (!empty($iDocumentId) && $iDocumentId > 0) {
            $where = " doc_id = '$iDocumentId' ";
            $obj->MySQLQueryPerform("ride_share_document_list", $Data_insert, 'update', $where);
            $document_id = $iDocumentId;
        } else {
            $document_id = $obj->MySQLQueryPerform("ride_share_document_list", $Data_insert, 'insert');
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_FILE_UPLOADED_SUCCESS_MSG";
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_FILE_UPLOADED_UNSUCCESS_MSG";
    }
    setDataResponse($returnArr);
}
if ($type == "getRideShareDriverFields") {
    $RIDE_SHARE_OBJ->getDriverDetailsFields();
}
if ($type == "GetVerificationDocuments") {
    $RIDE_SHARE_OBJ->getVerificationDocuments();
}
if ($type == "PublishRide") {
    $RIDE_SHARE_OBJ->publishRide();
}
if ($type == "GetPublishedRides") {
    $RIDE_SHARE_OBJ->fetchPublishedRides();
}
if ($type == "CancelPublishRide") {
    $RIDE_SHARE_OBJ->cancelPublishRide();
}
if ($type == "SearchRide") {
    $RIDE_SHARE_OBJ->searchRide();
}
if ($type == "bookRide") {
    $RIDE_SHARE_OBJ->bookRide();
}
if ($type == "BookingSummary") {
    $RIDE_SHARE_OBJ->BookRideDetails();
}
if ($type == "GetBookings") {
    $RIDE_SHARE_OBJ->fetchBookings();
}
if ($type == "UpdateBookingsStatus") {
    $RIDE_SHARE_OBJ->UpdateBookingsStatus();
}
if ($type == "CancelRideShareBooking") {
    $RIDE_SHARE_OBJ->cancelRideShareBooking();
}
if ($type == "GetRideShareRecommendedPrice") {
    $RIDE_SHARE_OBJ->GetRideShareRecommendedPrice();
}
/* ------------------------- Ride Share Service End ------------------------- */


/* Home Screen Layout V3 */
if ($type == "getServiceCategoriesProNew") {
    // ini_set('display_errors', 1);
    // error_reporting(E_ALL);
    
    $parentId = isset($_REQUEST['parentId']) ? clean($_REQUEST['parentId']) : 0;
    $userId = isset($_REQUEST['userId']) ? clean($_REQUEST['userId']) : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $bookingFrom = isset($_REQUEST["bookingFrom"]) ? $_REQUEST["bookingFrom"] : 'App';//added by SP for manual booking for admin side not check user id.
    $eCatType = isset($_REQUEST["eCatType"]) ? $_REQUEST["eCatType"] : '';
    $eForVideoConsultation = isset($_REQUEST["eForVideoConsultation"]) ? $_REQUEST["eForVideoConsultation"] : 'No';
    if(empty($parentId)) {
        $parentId = 0;
    }
    $parentId = rtrim($parentId, ",");
    $parentIdCount = count(explode(",", $parentId));
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if ($userId != "" || $bookingFrom == 'Web') {
        if(strtoupper($APP_TYPE) == "RIDE" || strtoupper($APP_TYPE) == "RIDE-DELIVERY" || strtoupper($THEME_OBJ->isPXCProThemeActive()) == "YES") {
            getServiceCategoriesProApp($userId);
        } elseif (strtoupper($APP_TYPE) == "DELIVERY") {
            getServiceCategoriesProDY($userId);
        }
        
        $lang = $vGeneralLang;
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $userId])) {
            $row = $userDetailsArr['register_user_' . $userId];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$userId'");
            $userDetailsArr['register_user_' . $userId] = $row;
        }

        //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
        $lang = $row[0]['vLang'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
        }
        $vehicle_category_main = get_value($sql_vehicle_category_table_name, 'vCategory_' . $lang, 'iVehicleCategoryId', $parentId, '', 'true');
        $ssql = $ssql1 = $ssql2 = $ssql3 = '';
        //$ufxEnable = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
        $ufxEnable = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
        if ($APP_TYPE == "UberX") {
            $ssql = " AND eCatType='ServiceProvider'";
            if ($parent_ufx_catid > 0 && $parentId == 0) {
                $ssql .= " AND iVehicleCategoryId='" . $parent_ufx_catid . "'";
            }
        }

        $isUberXFeatureAvailable = $MODULES_OBJ->isUberXFeatureAvailable();
        $isDeliveryFeatureAvailable = $MODULES_OBJ->isDeliveryFeatureAvailable();
        $isEnableAnywhereDeliveryFeature = $MODULES_OBJ->isEnableAnywhereDeliveryFeature();
        $isDeliverAllFeatureAvailable = $MODULES_OBJ->isDeliverAllFeatureAvailable();
        $isEnableVideoConsultingServices = $MODULES_OBJ->isEnableVideoConsultingService();
        //$isEnableVideoConsultingService = $MODULES_OBJ->isEnableVideoConsultingService();
        $isEnableBiddingServices = $MODULES_OBJ->isEnableBiddingServices();
        $isEnableRentItemService = $MODULES_OBJ->isEnableRentItemService();
        $isEnableRentCarsService = $MODULES_OBJ->isEnableRentCarsService();
        $isEnableRentEstateService = $MODULES_OBJ->isEnableRentEstateService();
        $isEnableMedicalServices = $MODULES_OBJ->isEnableMedicalServices();
        $isEnableRideShareService = $MODULES_OBJ->isEnableRideShareService();
        $isEnableTrackServiceFeature = $MODULES_OBJ->isEnableTrackServiceFeature();
        $isEnableTrackAnyServiceFeature = $MODULES_OBJ->isEnableTrackAnyServiceFeature();
        $isAirFlightModuleAvailable = $MODULES_OBJ->isAirFlightModuleAvailable();

        $isEnableGenieFeature = $MODULES_OBJ->isEnableGenieFeature();
        $isEnableRunnerFeature = $MODULES_OBJ->isEnableRunnerFeature();
        $isEnableVideoConsultingService = false;
        if($isEnableVideoConsultingServices && $isUberXFeatureAvailable){
            $isEnableVideoConsultingService = true;
        }

        if (!$isUberXFeatureAvailable) {
            if ($ufxEnable != 'Yes') {
                $ssql .= " AND eCatType!='ServiceProvider'";
            }
        }
        if (!$isAirFlightModuleAvailable) {
            $ssql .= " AND eCatType!='Fly'";
        }
        if (!$isEnableAnywhereDeliveryFeature) {
            $ssql .= " AND eCatType!='Genie' AND eCatType!='Runner' AND eCatType!='Anywhere' ";
        }
        if (!$isDeliverAllFeatureAvailable) {
            $ssql .= " AND eCatType != 'DeliverAll' AND (eCatType != 'MoreDelivery' AND eFor != 'DeliverAllCategory') ";
        }
        if ($MODULES_OBJ->isDonationFeatureAvailable()) {
            $sql2 = "SELECT iVehicleCategoryId, vLogo,vLogo2, eShowType,vBannerImage, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText,iServiceId, eDeliveryType,vListLogo,eCatViewType,tListDescription,vListLogo1,vListLogo2,vListLogo3,ePromoteBanner,vPromoteBannerImage,tPromoteBannerTitle,eVideoConsultEnable,eFor,vIconDetails,eForMedicalService,iParentId,tMedicalServiceInfo FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND iParentId IN ($parentId) " . $ssql . " ORDER BY iDisplayOrder,iVehicleCategoryId ASC";
        } else {
            $sql2 = "SELECT iVehicleCategoryId, vLogo,vLogo2, eShowType,vBannerImage, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText,iServiceId, eDeliveryType,vListLogo,eCatViewType,tListDescription,vListLogo1,vListLogo2,vListLogo3,ePromoteBanner,vPromoteBannerImage,tPromoteBannerTitle,eVideoConsultEnable,eFor,vIconDetails,eForMedicalService,iParentId,tMedicalServiceInfo FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND eCatType!='Donation' AND iParentId IN ($parentId) " . $ssql . " ORDER BY iDisplayOrder,iVehicleCategoryId ASC";
        }


        $Data = $obj->MySQLSelect($sql2);

        $categoryArr = $Datacategory = array();
        $eShowTerms = "No";
        $eProofUpload = "No";
        $tProofNote = "";
        $deliverAll_serviceArr = array();
        if (strtoupper(DELIVERALL) == "YES") {
            $scsql = "select iServiceId,eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_VALUE(tProofNote, '$.tProofNote_" . $lang . "')) as tProofNote from service_categories";
            $scsqlData = $obj->MySQLSelect($scsql);
            foreach ($scsqlData as $scValue) {
                if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                    $eShowTerms = $scValue['eShowTerms'];
                }
                if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                    $eProofUpload = $scValue['eProofUpload'];
                    if (is_null($scValue['tProofNote']) || $scValue['tProofNote'] == "null") {
                        $scValue['tProofNote'] = "";
                    }
                    $tProofNote = $scValue['tProofNote'];
                }
                $deliverAll_serviceArr[$scValue['iServiceId']]['eShowTerms'] = $eShowTerms;
                $deliverAll_serviceArr[$scValue['iServiceId']]['eProofUpload'] = $eProofUpload;
                $deliverAll_serviceArr[$scValue['iServiceId']]['tProofNote'] = (!empty($tProofNote) && $tProofNote != NULL) ? $tProofNote : "";
            }
        }
        //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query Start
        $vehicleCatArr = $vehicleTypeArr = array();
        $vehicleTypeData = $obj->MySQLSelect("SELECT iVehicleTypeId,iVehicleCategoryId FROM vehicle_type WHERE eStatus='Active'");
        for ($g = 0; $g < count($vehicleTypeData); $g++) {
            $vehicleTypeArr[$vehicleTypeData[$g]['iVehicleCategoryId']][] = $vehicleTypeData[$g];
        }
        //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
        if ($parentId == 0) {
            $medicalServiceArr = array();
            if (count($Data) > 0) {
                $k = 0;
                //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query Start
                $Data2 = $obj->MySQLSelect("SELECT vc1.iParentId,vc1.iVehicleCategoryId, vc1.vLogo, vc1.vLogo2, vc1.eShowType,vc1.vBannerImage, vc1.vCategory_" . $lang . " as vCategory, vc1.eCatType, vc1.eSubCatType, vc1.tBannerButtonText, vc1.iServiceId, vc1.eDeliveryType,vc1.vListLogo,vc1.eCatViewType,vc1.tListDescription,vc1.vListLogo1,vc1.vListLogo2,vc1.vListLogo3,vc1.ePromoteBanner,vc1.vPromoteBannerImage,vc1.tPromoteBannerTitle,vc1.eVideoConsultEnable,vc1.eFor,vc1.vIconDetails,vc1.eForMedicalService,vc1.tMedicalServiceInfo,vc2.vCategory_" . $lang . " as vParentCategoryName FROM " . $sql_vehicle_category_table_name . " as vc1  LEFT JOIN " . $sql_vehicle_category_table_name . " as vc2 ON vc2.iVehicleCategoryId = vc1.iParentId WHERE vc1.eStatus='Active' ORDER BY vc1.iDisplayOrder ASC");
                for ($h = 0; $h < count($Data2); $h++) {
                    $vehicleCatArr[$Data2[$h]['iParentId']][] = $Data2[$h];
                }
                //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
                for ($i = 0; $i < count($Data); $i++) {
                    $BannerButtonText = "tBannerButtonText_" . $lang;
                    $tBannerButtonTextArr = json_decode($Data[$i]['tBannerButtonText'], true);
                    $tBannerButtonText = $tBannerButtonTextArr[$BannerButtonText];
                    $listDescText = "tListDescription_" . $lang;
                    $tListDescriptionArr = json_decode($Data[$i]['tListDescription'], true);
                    $tListDescriptionText = $tListDescriptionArr[$listDescText];
                    $PromoteBannerTitle = "tPromoteBannerTitle_" . $lang;
                    $tPromoteBannerTitleArr = json_decode($Data[$i]['tPromoteBannerTitle'], true);
                    $tPromoteBannerTitle = $tPromoteBannerTitleArr[$PromoteBannerTitle];
                    $Data[$i]['vBgColor'] = $Data[$i]['vBorderColor'] = "";
                    if (!empty($Data[$i]['vIconDetails'])) {
                        $vIconDetails = json_decode($Data[$i]['vIconDetails'], true);
                        $Data[$i]['vBgColor'] = $vIconDetails['vBgColor'];
                        $Data[$i]['vBorderColor'] = $vIconDetails['vBorderColor'];
                    }
                    if ($tListDescriptionText == null) {
                        $tListDescriptionText = "";
                    }
                    if ($tPromoteBannerTitle == null) {
                        $tPromoteBannerTitle = "";
                    }
                    if ($Data[$i]['eCatType'] == "ServiceProvider" || $Data[$i]['eCatType'] == "MoreDelivery") {

                        $Data2 = array();
                        if (isset($vehicleCatArr[$Data[$i]['iVehicleCategoryId']])) {
                            $Data2 = $vehicleCatArr[$Data[$i]['iVehicleCategoryId']];
                        }
                        if ($isEnableMedicalServices && $Data[$i]['iVehicleCategoryId'] == "3") {
                            $medicalServiceArr = $Data2;
                        }
                        //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
                        if (count($Data2) > 0) {
                            for ($j = 0; $j < count($Data2); $j++) {
                                if ($Data2[$j]['eCatType'] == "ServiceProvider") {

                                    $Data3 = array();
                                    if (isset($vehicleTypeArr[$Data2[$j]['iVehicleCategoryId']])) {
                                        $Data3 = $vehicleTypeArr[$Data2[$j]['iVehicleCategoryId']];
                                    }
                                    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
                                    if (count($Data3) > 0 || ($Data2[$j]['eVideoConsultEnable'] == "Yes" && $isEnableVideoConsultingService)) {
                                        $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                                        $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                                        $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                                        $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                                        $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                                        $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                                        $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                                        $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                                        $Datacategory[$k]['eShowTerms'] = "No";
                                        $Datacategory[$k]['eProofUpload'] = "No";
                                        $Datacategory[$k]['tProofNote'] = "";
                                        if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0) {
                                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                                $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                                            }
                                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                                $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                                $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                                            }
                                        }
                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                                        $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;

                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo3'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo3'] : "";
                                        $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                                        $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                                        $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                                        $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                                        $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];

                                        $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                                        $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                                        $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                                        $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                                        $k++;
                                    }
                                } else {
                                    $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                                    $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                                    $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                                    $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                                    $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                                    $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                                    $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                                    $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                                    $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                                    $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                                    $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                                    $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                                    $Datacategory[$k]['eShowTerms'] = "No";
                                    $Datacategory[$k]['eProofUpload'] = "No";
                                    $Datacategory[$k]['tProofNote'] = "";
                                    if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0) {
                                        if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                            $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                                        }
                                        if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                            $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                            $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                                        }
                                    }
                                    $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                                    $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                                    $Datacategory[$k]['tListDescription'] = $tListDescriptionText;

                                    $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo3'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo3'] : "";
                                    $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                                    $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                                    $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                                    $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                                    $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];

                                    $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                                    $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                                    $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                                    $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                                    $k++;
                                }
                            }
                        }
                    } else {
                        $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                        $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                        $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                        $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                        $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                        $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                        $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                        $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                        $Datacategory[$k]['eShowTerms'] = "No";
                        $Datacategory[$k]['eProofUpload'] = "No";
                        $Datacategory[$k]['tProofNote'] = "";
                        if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0 && $MODULES_OBJ->isEnableTermsServiceCategories()) {
                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                            }
                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                            }
                        }
                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                        $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;

                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo3'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo3'] : "";
                        $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                        $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                        $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                        $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                        $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];

                        $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                        $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                        $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                        $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                        $k++;
                    }
                }
            }
        }

        $Datacategory1 = array_unique($Datacategory, SORT_REGULAR);
        $DatanewArr = array();
        foreach ($Datacategory1 as $inner) {
            if ($inner['eCatType'] == "Genie") {
                $inner['eCatType'] = "Anywhere";
            }
            array_push($DatanewArr, $inner);
        }
        $returnArr['Action'] = "1";
        if ($vehicle_category_main != '') {
            $returnArr['vParentCategoryName'] = $vehicle_category_main;
        } else {
            $returnArr['vParentCategoryName'] = '';
        }

        $DatanewArrTmp = array();
        for ($i = 0; $i < count($DatanewArr); $i++) {
            $vLogo_image_tmp = $DatanewArr[$i]['vLogo_image'];
            $vBannerImage_tmp = $DatanewArr[$i]['vBannerImage'];
            $vLogo_image_tmp_orig_name_arr = explode("/", $DatanewArr[$i]['vLogo_image']);
            $vBannerImage_tmp_orig_name_arr = explode("/", $DatanewArr[$i]['vBannerImage']);
            $isFileExist = false;
            if (!empty($vBannerImage_tmp_orig_name_arr) && count($vBannerImage_tmp_orig_name_arr) > 0) {
                $vBannerImage_tmp_orig_name = $vBannerImage_tmp_orig_name_arr[count($vBannerImage_tmp_orig_name_arr) - 1];
                $isFileExist = file_exists($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $DatanewArr[$i]['iVehicleCategoryId'] . '/' . $vBannerImage_tmp_orig_name);
            }
            $isFileExist_1 = false;
            if (!empty($vLogo_image_tmp_orig_name_arr) && count($vLogo_image_tmp_orig_name_arr) > 0) {
                $vLogo_image_tmp_orig_name = $vLogo_image_tmp_orig_name_arr[count($vLogo_image_tmp_orig_name_arr) - 1];
                $isFileExist_1 = file_exists($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $DatanewArr[$i]['iVehicleCategoryId'] . '/android/' . $vLogo_image_tmp_orig_name);
            }
            if (empty($vBannerImage_tmp) || !$isFileExist) {
                $DatanewArr[$i]['vBannerImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/15529086332815.png";
            }
            if (empty($vLogo_image_tmp) || !$isFileExist_1) {
                $DatanewArr[$i]['vLogo_image'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/service_categories.png";
            }
            if ($isEnableMedicalServices && $DatanewArr[$i]['eForMedicalService'] == "Yes") {
                $medicalServiceArr[] = $DatanewArr[$i];
            }
            if ($parentIdCount > 1) {
                $DatanewArrTmp[$DatanewArr[$i]['iParentId']][] = $DatanewArr[$i];
            }
        }

        $returnArr['message'] = $DatanewArr;
        $whereloc = " AND iLocationid IN ('-1')";
        if ($MODULES_OBJ->isEnableLocationwiseBanner()) {
            $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
            $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
            $User_Address_Banner = array($vLatitude, $vLongitude);
            if (!empty($User_Address_Banner)) {
                $iLocationIdBanner = GetUserGeoLocationIdBanner($User_Address_Banner);
                $country_str_banner = "'-1'";
                if (count($iLocationIdBanner) > 0) {
                    foreach ($iLocationIdBanner as $key => $value) {
                        $country_str_banner .= ", '" . $value . "'";
                    }
                    $whereloc = " AND iLocationid IN (" . $country_str_banner . ")";
                }
            }
        }
        $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $lang . "' AND vImage != '' AND eStatus = 'Active' AND (iServiceId = '0' OR iServiceId = '') AND eBuyAnyService NOT IN ('Genie', 'Runner') AND eType = 'General' $whereloc ORDER BY iDisplayOrder ASC");
        $dataOfBanners = array();
        $count = 0;
        for ($i = 0; $i < count($Data_banners); $i++) {
            if (isset($Data_banners[$i]['vImage']) && $Data_banners[$i]['vImage'] != "") {
                $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];

                $imagedata = getimagesize($banner_img_path);
                $dataOfBanners[$count]['vImageWidth'] = strval($imagedata[0]);
                $dataOfBanners[$count]['vImageHeight'] = strval($imagedata[1]);
                $dataOfBanners[$count]['isClickable'] = "No";
                $count++;
            }
        }


        $returnArr['message'] = "";
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", $iServiceId);
        
        if ($APP_TYPE == "UberX") {
            $bannerArr = array(
                'eViewType' => 'BannerView',
                'isScroll' => "Yes",
                'displayCount' => "1",
                'isFullView' => "No",
                'vImageWidth' => $dataOfBanners[0]['vImageWidth'],
                'vImageHeight' => $dataOfBanners[0]['vImageHeight'],
                'imagesArr' => $dataOfBanners
            );
            
            $MASTER_SERVICE_CATEGORIES = getServiceCategoriesProSP($DatanewArr, $lang);
            array_unshift($MASTER_SERVICE_CATEGORIES, $bannerArr);
            $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
            setDataResponse($returnArr);

        } elseif ($THEME_OBJ->isProDeliveryKingThemeActive() == "Yes") {
            $bannerArr = array(
                'eViewType' => 'BannerView',
                'isScroll' => "Yes",
                'displayCount' => "1",
                'isFullView' => "No",
                'vImageWidth' => $dataOfBanners[0]['vImageWidth'],
                'vImageHeight' => $dataOfBanners[0]['vImageHeight'],
                'imagesArr' => $dataOfBanners
            );
            
            $MASTER_SERVICE_CATEGORIES = getServiceCategoriesProDK($DatanewArr, $lang);
            array_unshift($MASTER_SERVICE_CATEGORIES, $bannerArr);
            $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
            setDataResponse($returnArr);
        }

        // echo "<pre>"; print_r($DatanewArr); exit;
        $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $lang . "')) as vCategoryName, JSON_UNQUOTE(JSON_VALUE(vCategoryDesc, '$.vCategoryDesc_" . $lang . "')) as vCategoryDesc FROM $master_service_category_tbl WHERE eStatus = 'Active'");

        $MasterCategoryArr = array();
        foreach ($master_service_categories as $mCategory) {
            $MasterCategoryArr[$mCategory['eType']] = $mCategory;
        }

        $app_home_screen_view = $obj->MySQLSelect("SELECT eViewType, eServiceType, vTitle, vSubtitle, tGridServices, tServiceDetails, iDisplayOrder FROM app_home_screen_view ORDER BY iDisplayOrder ASC");

        $ViewArr = array();
        foreach ($app_home_screen_view as $view) {
            $ViewType = !empty($view['eServiceType']) ? $view['eServiceType'] : $view['eViewType'];
            $ViewTitle = $ViewSubTitle = "";
            if (!empty($view['vTitle'])) {
                $ViewTitleArr = json_decode($view['vTitle'], true);
                $ViewTitle = $ViewTitleArr['vTitle_' . $lang];
            }
            if (!empty($view['vSubtitle'])) {
                $ViewSubTitleArr = json_decode($view['vSubtitle'], true);
                $ViewSubTitle = $ViewSubTitleArr['vSubtitle_' . $lang];
            }

            $view['vTitle'] = $ViewTitle;
            $view['vSubtitle'] = $ViewSubTitle;
            $ViewArr[$ViewType] = $view;
        }

        $MASTER_SERVICE_CATEGORIES = $PromotionalBannerArr = array();
        foreach ($ViewArr as $View) {
            $mServiceCategoryArr = array();
            $mServiceCategoryArr['eViewType'] = $View['eViewType'];

            if ($View['eViewType'] == "IntroView") {
                $mServiceCategoryArr['vTitle'] = str_replace("#USERNAME#", $row[0]['vName'], $View['vTitle']);
                $mServiceCategoryArr['vSubtitle'] = $View['vSubtitle'];
                $mServiceCategoryArr['vImage'] = "";
            } else  if ($View['eViewType'] == "IntroViewBuy") {
                $mServiceCategoryArr['vTitle'] = $View['vTitle'];
                $mServiceCategoryArr['vSubtitle'] = $View['vSubtitle'];
                $mServiceCategoryArr['eViewType'] = 'IntroView';
                $mServiceCategoryArr['vImage'] = "";
            } elseif ($View['eViewType'] == "BannerView") {
                if ($View['eServiceType'] == "GeneralBanner") {
                    if(count($dataOfBanners) > 0) {
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "Yes";
                        $mServiceCategoryArr['displayCount'] = "1";
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['vImageWidth'] = $dataOfBanners[0]['vImageWidth'];
                        $mServiceCategoryArr['vImageHeight'] = $dataOfBanners[0]['vImageHeight'];
                        $mServiceCategoryArr['imagesArr'] = $dataOfBanners;
                    } else {
                        continue;
                    }
                }
                elseif ($View['eServiceType'] == "PromotionalBanner") {
                    foreach ($DatanewArr as $SubCategories) {
                        if ($SubCategories['ePromoteBanner'] == "Yes") {
                            $promotional_banner_data = $obj->MySQLSelect("SELECT vImage FROM banners WHERE vCode = '$lang' AND iVehicleCategoryId = '" . $SubCategories['iVehicleCategoryId'] . "' AND eType = 'Promotion'");
                            if (!empty($promotional_banner_data) && count($promotional_banner_data) > 0) {
                                $PromotionalBannerArr = array(
                                    'vCategoryName' => !empty($SubCategories['tPromoteBannerTitle']) ? $SubCategories['tPromoteBannerTitle'] : "",
                                    'vCategory' => !empty($SubCategories['tPromoteBannerTitle']) ? $SubCategories['tPromoteBannerTitle'] : "",
                                    'vImage' => $tconfig['tsite_upload_images'] . $promotional_banner_data[0]['vImage'],
                                    'eCatType' => $SubCategories['eCatType'],
                                    'ePromoteBanner' => 'Yes',
                                    'iVehicleCategoryId' => $SubCategories['iVehicleCategoryId'],
                                    'iParentId' => $SubCategories['iParentId'],
                                    'iServiceId' => $SubCategories['iServiceId'],
                                    'eShowTerms' => $SubCategories['eShowTerms'],
                                    'eProofUpload' => $SubCategories['eProofUpload'],
                                    'tProofNote' => $SubCategories['tProofNote'],
                                    'eFor' => $SubCategories['eFor'],
                                    'isClickable' => 'Yes'
                                );
                                if ($SubCategories['eCatType'] == "DeliverAll") {
                                    $PromotionalBannerArr['iServiceId'] = $SubCategories['iServiceId'];
                                }
                                $imagedata = getimagesize($tconfig['tsite_upload_images_panel'] . $promotional_banner_data[0]['vImage']);
                                $PromotionalBannerArr['vImageWidth'] = strval($imagedata[0]);
                                $PromotionalBannerArr['vImageHeight'] = strval($imagedata[1]);

                                $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                                $mServiceCategoryArr['isScroll'] = "No";
                                $mServiceCategoryArr['displayCount'] = "1";
                                $mServiceCategoryArr['isFullView'] = "Yes";
                                $mServiceCategoryArr['isOnlyImage'] = "Yes";
                                $mServiceCategoryArr['AddTopPadding'] = "Yes";
                                $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                                $mServiceCategoryArr['vImageWidth'] = $PromotionalBannerArr['vImageWidth'];
                                $mServiceCategoryArr['vImageHeight'] = $PromotionalBannerArr['vImageHeight'];
                                $mServiceCategoryArr['isClickable'] = "Yes";
                                $mServiceCategoryArr['imagesArr'][] = $PromotionalBannerArr;
                            } else {
                                continue 2;
                            }
                        }
                    }
                }
                elseif ($View['eServiceType'] == "BuySell" && ($isEnableRentEstateService || $isEnableRentCarsService || $isEnableRentItemService)) {

                    $BuySellCount = 2;
                    if (!$isEnableRentItemService || !$isEnableRentCarsService) {
                        $BuySellCount = 1;
                    }

                    if ($isEnableRentEstateService) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = "1";
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['isOnlyImage'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "No";
                        $mServiceCategoryArr['imagesArr'] = array();

                        $vImageRentEstate = "";
                        if (!empty($MasterCategoryArr['RentEstate']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentEstate']['vIconImage1'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentEstate']['vIconImage1']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "Yes";

                            $vImageRentEstate = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['RentEstate']['vIconImage1'];
                        }

                        $msql = " AND iMasterServiceCategoryId = " . $MasterCategoryArr['RentEstate']['iMasterServiceCategoryId'];
                        $RentEstateServicesArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                        if(strtoupper($ENABLE_BUY_SELL_DETAIL_VIEW_HOME_SCREEN) == "YES") {
                            $RentEstateServicesArrNew = array();
                            $RentEstateServicesArrNew[] = $RentEstateServicesArr[0];
                            $RentEstateServicesArr = $RentEstateServicesArrNew;
                        }
                        $RentEstateImgArr = array(
                            'vCategoryName' => $MasterCategoryArr['RentEstate']['vCategoryName'],
                            'vCategoryTitle' => $MasterCategoryArr['RentEstate']['vCategoryName'],
                            'vCategory' => $MasterCategoryArr['RentEstate']['vCategoryName'],
                            'vImage' => $vImageRentEstate,
                            'vTextColor' => $MasterCategoryArr['RentEstate']['vTextColor'],
                            'vBgColor' => $MasterCategoryArr['RentEstate']['vBgColor'],
                            'isClickable' => 'Yes',
                            'PromotionalTagText' => $languageLabelsArr['LBL_PROMOTIONAL_CATEGORY_TAG_1'],
                            'rentestateSection' => 'Yes',
                            'servicesArr' => $RentEstateServicesArrNew
                        );
                        $mServiceCategoryArr['imagesArr'][] = $RentEstateImgArr;

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }

                    if ($isEnableRentItemService || $isEnableRentCarsService) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = $BuySellCount;
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['isOnlyImage'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                        $mServiceCategoryArr['imagesArr'] = array();

                        if ($isEnableRentCarsService) {
                            $vImageRentCar = "";
                            if (!empty($MasterCategoryArr['RentCars']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentCars']['vIconImage1'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentCars']['vIconImage1']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "Yes";

                                $vImageRentCar = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['RentCars']['vIconImage1'];
                            }

                            $msql = " AND iMasterServiceCategoryId = " . $MasterCategoryArr['RentCars']['iMasterServiceCategoryId'];
                            $RentCarsServicesArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                            if(strtoupper($ENABLE_BUY_SELL_DETAIL_VIEW_HOME_SCREEN) == "YES") {
                                $RentCarsServicesArrNew = array();
                                $RentCarsServicesArrNew[] = $RentCarsServicesArr[0];
                                $RentCarsServicesArr = $RentCarsServicesArrNew;
                            }
                            $RentCarImgArr = array(
                                'vCategoryName' => $MasterCategoryArr['RentCars']['vCategoryName'],
                                'vCategoryTitle' => $MasterCategoryArr['RentCars']['vCategoryName'],
                                'vCategory' => $MasterCategoryArr['RentCars']['vCategoryName'],
                                'vImage' => $vImageRentCar,
                                'vTextColor' => $MasterCategoryArr['RentCars']['vTextColor'],
                                'vBgColor' => $MasterCategoryArr['RentCars']['vBgColor'],
                                'isClickable' => 'Yes',
                                'rentcarSection' => 'Yes',
                                'servicesArr' => $RentCarsServicesArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $RentCarImgArr;
                        }

                        if ($isEnableRentItemService) {
                            $vImageRentItem = "";
                            if (!empty($MasterCategoryArr['RentItem']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentItem']['vIconImage1'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentItem']['vIconImage1']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "Yes";

                                $vImageRentItem = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['RentItem']['vIconImage1'];
                            }

                            $msql = " AND iMasterServiceCategoryId = " . $MasterCategoryArr['RentItem']['iMasterServiceCategoryId'];
                            $RentItemServicesArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                            if(strtoupper($ENABLE_BUY_SELL_DETAIL_VIEW_HOME_SCREEN) == "YES") {
                                $RentItemServicesArrNew = array();
                                $RentItemServicesArrNew[] = $RentItemServicesArr[0];
                                $RentItemServicesArr = $RentItemServicesArrNew;
                            }
                            $RentItemImgArr = array(
                                'vCategoryName' => $MasterCategoryArr['RentItem']['vCategoryName'],
                                'vCategoryTitle' => $MasterCategoryArr['RentItem']['vCategoryName'],
                                'vCategory' => $MasterCategoryArr['RentItem']['vCategoryName'],
                                'vImage' => $vImageRentItem,
                                'vTextColor' => $MasterCategoryArr['RentItem']['vTextColor'],
                                'vBgColor' => $MasterCategoryArr['RentItem']['vBgColor'],
                                'isClickable' => 'Yes',
                                'rentitemSection' => 'Yes',
                                'servicesArr' => $RentItemServicesArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $RentItemImgArr;
                        }

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }
                    continue;
                }
                elseif (($View['eServiceType'] == "RideShare" && $isEnableRideShareService) || ($View['eServiceType'] == "TrackService" && $isEnableTrackServiceFeature) || ($View['eServiceType'] == "TrackAnyService" && $isEnableTrackAnyServiceFeature) || ($View['eServiceType'] == "Genie" && $isEnableAnywhereDeliveryFeature && ($isEnableGenieFeature || $isEnableRunnerFeature)) || ($View['eServiceType'] == "VideoConsult" && $isEnableVideoConsultingService)) { 	// || ($View['eServiceType'] == "Bidding" && $isEnableBiddingServices)

                    $ServiceCount = 1;
                  if ($View['eServiceType'] == "VideoConsult") { //if ($View['eServiceType'] == "VideoConsult" || $View['eServiceType'] == "Bidding") {
                        $ServiceCount = 1; //   $ServiceCount = 2;

                        if(!$isEnableVideoConsultingService) {
                            $ServiceCount = 1;                                
                        }
                    }

                    $mServiceCategoryArr = array();
                    $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                    $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                    $mServiceCategoryArr['isScroll'] = "No";
                    $mServiceCategoryArr['displayCount'] = $ServiceCount;
                    $mServiceCategoryArr['isFullView'] = "Yes";
                    $mServiceCategoryArr['isOnlyImage'] = "Yes";
                    $mServiceCategoryArr['AddTopPadding'] = "Yes";
                    $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                    $mServiceCategoryArr['imagesArr'] = array();

                    $languageLabelsArrService = $languageLabelsArr;

                    $vImageService = "";
                    $tCategoryDetails = array();
                    if(isset($MasterCategoryArr[$View['eServiceType']])) {
                        $tCategoryDetails = json_decode($MasterCategoryArr[$View['eServiceType']]['tCategoryDetails'], true);

                        if (!empty($MasterCategoryArr[$View['eServiceType']]['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr[$View['eServiceType']]['vIconImage1'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr[$View['eServiceType']]['vIconImage1']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "Yes";

                            $vImageService = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr[$View['eServiceType']]['vIconImage1'];
                        }

                        $ServiceImgArr = array(
                            'vCategoryName' => '',
                            'vCategoryTitle' => $MasterCategoryArr[$View['eServiceType']]['vCategoryName'],
                            'vCategoryDesc' => '',
                            'vTextColor' => $MasterCategoryArr[$View['eServiceType']]['vTextColor'],
                            'vBgColor' => $MasterCategoryArr[$View['eServiceType']]['vBgColor'],
                            'isClickable' => 'Yes',
                            'vImage' => $vImageService
                        );
                    }

                    if($View['eServiceType'] == "RideShare") {
                        $languageLabelsArrRideShare = $languageLabelsArr;
                        $ServiceImgArr['RideShareSection'] = 'Yes';
                        $ServiceImgArr['servicesArr'] = $RIDE_SHARE_OBJ->getCategories($tCategoryDetails);

                    } elseif ($View['eServiceType'] == "TrackService" || $View['eServiceType'] == "TrackAnyService") {
                        $languageLabelsArrTrackService = $languageLabelsArr;
                        // $TrackServiceArr = $TRACK_SERVICE_OBJ->getCategories($tCategoryDetails);
                        $mServiceCategoryArr['isFullView'] = "No";
                        // $ServiceImgArr['vCategoryTitle'] = $TrackServiceArr[0]['vCategory'];
                        $ServiceImgArr['vCategoryTitle'] = $languageLabelsArr['LBL_TRACK_ANY_SERVICE_CATEGORY_TITLE'];
                        // $ServiceImgArr['TrackServiceSection'] = 'Yes';
                        // $ServiceImgArr['eCatType'] = $TrackServiceArr[0]['eCatType'];
                        $ServiceImgArr['eCatType'] = "TrackAnyService";
                        $ServiceImgArr['servicesArr'] = $TRACK_ANY_SERVICE_OBJ->getServiceCategories($lang, $tCategoryDetails);

                    } elseif ($View['eServiceType'] == "Genie") {
                        $app_banner_runner = $obj->MySQLSelect("SELECT vImage FROM banners WHERE vCode = '$lang' AND eBuyAnyService = 'Genie' AND eType = 'AppHomeScreen'");

                        if (!empty($app_banner_runner) && count($app_banner_runner) > 0) {
                            $ServiceArr = array();
                            foreach ($DatanewArr as $skey => $SubCategories) {
                                $DatanewArr[$skey]['eShowType'] = "Icon";
                                $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                                if ($isEnableAnywhereDeliveryFeature && in_array($SubCategories['eCatType'], ['Genie', 'Runner', 'Anywhere'])) {

                                    $DatanewArr[$skey]['eCatViewType'] = "List";
                                    $ServiceArr[] = $DatanewArr[$skey];
                                }
                            }

                            $GenieBannerArr = array(
                                'vCategoryName' => '',
                                'vCategoryTitle' => $languageLabelsArr['LBL_DELIVERY_SERVICES'],
                                'vImage' => $tconfig['tsite_upload_images'] . $app_banner_runner[0]['vImage'],
                                'eFor' => "",
                                'isClickable' => 'Yes'
                            );

                            $imagedata = getimagesize($tconfig['tsite_upload_images_panel'] . $app_banner_runner[0]['vImage']);
                            $GenieBannerArr['vImageWidth'] = strval($imagedata[0]);
                            $GenieBannerArr['vImageHeight'] = strval($imagedata[1]);
                            $GenieBannerArr['servicesArr'] = $ServiceArr;

                            $mServiceCategoryArr['AddBottomPadding'] = "No";
                            $mServiceCategoryArr['isFullView'] = "No";
                            $mServiceCategoryArr['vImageWidth'] = $GenieBannerArr['vImageWidth'];
                            $mServiceCategoryArr['vImageHeight'] = $GenieBannerArr['vImageHeight'];
                            $mServiceCategoryArr['isClickable'] = "Yes";
                            $ServiceImgArr = $GenieBannerArr;
                        } else {
                            continue;
                        }                            
                        
                    } elseif ($View['eServiceType'] == "VideoConsult") {
                        $mServiceCategoryArr['isFullView'] = "No";

                        $ServiceImgArr['vCategoryTitle'] = $languageLabelsArr['LBL_VIDEO_CONSULT_CATEGORY_TITLE'];
                        $ServiceImgArr['VideoConsultSection'] = 'Yes';
                        $ServiceImgArr['servicesArr'] = array();
                        
                        foreach ($DatanewArr as $skey => $SubCategories) {

                            $DatanewArr[$skey]['eShowType'] = "Icon";
                            $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                            if ($isEnableVideoConsultingService) {
                                $DatanewArr[$skey]['isVideoConsultEnable'] = $VIDEO_CONSULT_OBJ->checkVideoConsultEnable($SubCategories['iVehicleCategoryId']);
                            }
                            if ($isEnableVideoConsultingService && $DatanewArr[$skey]['isVideoConsultEnable'] == "Yes") {
                                $DatanewArr[$skey]['eCatViewType'] = "List";

                                $isAddDataVC = "Yes";
                                if($isEnableMedicalServices && in_array($SubCategories['iVehicleCategoryId'], [3,22,26,158])) {
                                    $isAddDataVC = "No";
                                }

                                if($isAddDataVC == "Yes") {
                                    $ServiceImgArr['servicesArr'][] = $DatanewArr[$skey];
                                }                                
                            }
                        }
						$Datdata = getimagesize(str_replace("https", "http", $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['VideoConsult']['vIconImage1']));
						$NewServiceDataArr = array(
							'vCategoryName' => '',
							'vCategoryTitle' => $languageLabelsArr['LBL_VIDEO_CONSULT_CATEGORY_TITLE'],
						  //  'vIconImage' => $tconfig['tsite_upload_images'] . 'video_consult.png', 
							'vIconImage' => $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['VideoConsult']['vIconImage1'],
							'eFor' => "",
							'VideoConsultSection' => "Yes",
							'isFullView' => "No",
							'vBgColor' => "#FFF0C3",
							'vTextColor' => "#000000",
							'vTextFontSize' => "12",
							'vDecFontSize' => "9.5",
							'vBannerWidth' => "177",
							'vBannerHeight' => "111",
							'vBannerBorderRadius' => "8",
							'ImagePosition' => "Right-Bottom",
							'ImageMargin-Top' => "15",
							'ImageMargin-Left' => "2",
							'ImageMargin-Right' => "0",
							'ImageMargin-Bottom' => "0",
							'vIconImageWidth' =>  '65',
							'vIconImageHeight' =>  '74.71',
						   // 'vIconImageWidth' =>  strval($Datdata[0]),
						  //  'vIconImageHeight' =>  strval($Datdata[1]),
							'isClickable' => 'Yes'
						);
						$NewServiceDataArr['vTitle'] = $MasterCategoryArr[$View['eServiceType']]['vCategoryName'];  // "Online Video Consulting";
						$NewServiceDataArr['vDescription'] = $MasterCategoryArr[$View['eServiceType']]['vCategoryDesc'];
						//"Book & Video Consult with Ttors, Yoga Teachers, Lawyers, Astrologers, etc. via the App.";
						$NewServiceDataArr['servicesArr'] = $ServiceImgArr['servicesArr'];
						$ServiceImgArr= $NewServiceDataArr;

                    } elseif ($View['eServiceType'] == "Bidding") {
                        $mServiceCategoryArr['isFullView'] = "No";

                        $ServiceImgArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICE_BID_CATEGORY_TITLE'];
                        $ServiceImgArr['biddingSection'] = 'Yes';
                        $ServiceImgArr['servicesArr'] = $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang);
                    }

                    if (in_array($View['eServiceType'], ['VideoConsult', 'Bidding', 'RideShare', 'TrackService'])) {
                        $tCatImagesArr = array();
                        if(!empty($MasterCategoryArr[$View['eServiceType']]['vCategoryImage'])) {
                            $tCatImagesArr = json_decode($MasterCategoryArr[$View['eServiceType']]['vCategoryImage'], true);
                            if(!empty($tCatImagesArr['vCategoryImage_' . $lang]) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCatImagesArr['vCategoryImage_' . $lang])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCatImagesArr['vCategoryImage_' . $lang]);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "Yes";

                                $vImageService = $tconfig["tsite_upload_app_home_screen_images"] . $tCatImagesArr['vCategoryImage_' . $lang];
                                $ServiceImgArr['vImage'] = $vImageService;
                            }
                        }
                    }

                    $mServiceCategoryArr['imagesArr'][] = $ServiceImgArr;
					/* 
                    if(($View['eServiceType'] == "VideoConsult" || $View['eServiceType'] == "Bidding") && $isEnableVideoConsultingService && $isEnableBiddingServices) {

                        $vImageService = "";
                        if (!empty($MasterCategoryArr['Bidding']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['Bidding']['vIconImage1'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['Bidding']['vIconImage1']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "Yes";

                            $vImageService = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['Bidding']['vIconImage1'];
                        }

                        $ServiceImgArr = array(
                            'vCategoryName' => '',
                            'vCategoryTitle' => $languageLabelsArr['LBL_SERVICE_BID_CATEGORY_TITLE'],
                            'vCategoryDesc' => '',
                            'vTextColor' => $MasterCategoryArr['Bidding']['vTextColor'],
                            'vBgColor' => $MasterCategoryArr['Bidding']['vBgColor'],
                            'isClickable' => 'Yes',
                            'vImage' => $vImageService,
                            'biddingSection' => 'Yes',
                            'servicesArr' => $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang)
                        );

                        $mServiceCategoryArr['imagesArr'][] = $ServiceImgArr;

                    }
					*/
                } 
            }
            elseif ($View['eViewType'] == "GridView") {
                $tGridServicesArr = explode(",", $View['tGridServices']);
                $GridServicesArr = array();

                foreach ($MasterCategoryArr as $mkey => $mValue) {
                    if (in_array($mValue['eType'], $tGridServicesArr)) {
                        $tGridServiceKey = array_search($mValue['eType'], $tGridServicesArr);

                        $ServiceArr = array();

                        if ($mValue['eType'] == "Ride") {
                            $ServiceArr['vCategoryName'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategoryTitle'] = $languageLabelsArr['LBL_TAXI_CATEGORY_TITLE'];
                        } elseif ($mValue['eType'] == "Deliver") {
                            $ServiceArr['vCategoryName'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategory'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategoryTitle'] = $languageLabelsArr['LBL_DELIVERY_CATEGORY_TITLE'];
                        } elseif ($mValue['eType'] == "DeliverAll") {
                            $ServiceArr['vCategoryName'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategoryTitle'] = $languageLabelsArr['LBL_DELIVERALL_CATEGORY_TITLE'];
                        }
                        $ServiceArr['eType'] = $mValue['eType'];
                        $ServiceArr['vImage'] = "";
                        if (!empty($mValue['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $mValue['vIconImage1'])) {
                            $ServiceArr['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . $mValue['vIconImage1'];
                        }
                        $ServiceArr['vTextColor'] = $mValue['vTextColor'];
                        $ServiceArr['vBgColor'] = $mValue['vBgColor'];
                        $ServiceArr['iDisplayOrder'] = $tGridServiceKey;

                        if ($mValue['eType'] == "VideoConsult") {
                            $ServiceArr['VideoConsultSection'] = 'Yes';
                        } elseif ($mValue['eType'] == "Bidding") {
                            $ServiceArr['biddingSection'] = 'Yes';
                        }

                        $ServiceArr['SubCategories'] = array();
                        foreach ($DatanewArr as $skey => $SubCategories) {

                            $DatanewArr[$skey]['eShowType'] = "Icon";
                            $DatanewArr[$skey]['isVideoConsultEnable'] = "No";

                            if ($mValue['eType'] == "Ride" && $SubCategories['eForMedicalService'] == "No" && (in_array($SubCategories['eCatType'], ['Ride', 'MotoRide', 'Rental', 'MotoRental', 'RidePool']) || ($isAirFlightModuleAvailable && $SubCategories['eCatType'] == 'Fly'))) {
                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                $ServiceArr['SubCategories'][] = $DatanewArr[$skey];
                            } elseif ($mValue['eType'] == "Deliver" && ($isDeliveryFeatureAvailable && in_array($SubCategories['eCatType'], ['Delivery', 'MotoDelivery', 'MultipleDelivery', 'MoreDelivery']))) {

                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                $ServiceArr['eCatType'] = $DatanewArr[$skey]['eCatType'];
                                $ServiceArr['iVehicleCategoryId'] = $DatanewArr[$skey]['iVehicleCategoryId'];
                                unset($ServiceArr['SubCategories']);
                            } elseif ($mValue['eType'] == "DeliverAll" && ($isDeliverAllFeatureAvailable && in_array($SubCategories['eCatType'], ['DeliverAll']) && $SubCategories['iServiceId'] > 0)) {
                                $DatanewArr[$skey]['eCatViewType'] = "List";

                                $isAddDataDeliverAll = "Yes";
                                if($isEnableMedicalServices && in_array($SubCategories['iServiceId'], [5, 11])) {
                                    $isAddDataDeliverAll = "No";
                                }

                                if($isAddDataDeliverAll == "Yes") {
                                    $ServiceArr['SubCategories'][] = $DatanewArr[$skey];    
                                }
                            } 
                        }

                        $GridServicesArr[] = $ServiceArr;
                    }
                }

                $sort_data = array_column($GridServicesArr, 'iDisplayOrder');
                array_multisort($sort_data, SORT_ASC, $GridServicesArr);

                $mServiceCategoryArr['servicesArr'] = $GridServicesArr;
            }
            elseif ($View['eViewType'] == "ServiceBannerView") {
                if ($View['eServiceType'] == "MedicalServices" && $isEnableMedicalServices) {

                    $mServiceCategoryArr['eViewType'] = "TitleView";
                    $mServiceCategoryArr['vTitle'] = $View['vTitle'];

                    $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                    $tServiceDetails = json_decode($View['tServiceDetails'], true);

                    $languageLabelsArrMS = $languageLabelsArr;
                    $medicalServiceSectionArr = getServiceCategoriesMedicalServices($medicalServiceArr, $lang, 'MoreSubCategories');
                    $tCategoryDetails = json_decode($MasterCategoryArr['MedicalServices']['tCategoryDetails'], true);

                    $MSCount = 2;
                    if (!isset($medicalServiceSectionArr['BookService']) || !isset($medicalServiceSectionArr['VideoConsult'])) {
                        $MSCount = 1;
                    }

                    if (isset($medicalServiceSectionArr['BookService']) || isset($medicalServiceSectionArr['VideoConsult'])) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];                        
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = $MSCount;
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                        $mServiceCategoryArr['imagesArr'] = array();

                        if (isset($medicalServiceSectionArr['BookService'])) {
                            $vImageBookService = "";
                            if (!empty($tCategoryDetails['BookService']['vImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['BookService']['vImage'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['BookService']['vImage']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "No";

                                $vImageBookService = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['BookService']['vImage'];
                            }

                            $BookServiceArr = array();
                            if(count($medicalServiceSectionArr['BookService']['Services']) > 3) {
                                $MoreBookServicesArr = array(
                                    'vCategory' => $languageLabelsArr['LBL_MORE'],
                                    'vCategoryTitle' => $medicalServiceSectionArr['BookService']['vTitle'],
                                    'vListLogo' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'vImage' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'moreSection' => "Yes",
                                    'moreCategories' => $medicalServiceSectionArr['BookService']['Services']
                                );
                            }

                            foreach ($medicalServiceSectionArr['BookService']['Services'] as $BookServiceVal) {
                                if(count($BookServiceArr) <= 2) {
                                    if(isset($tServiceDetails['BookService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']])) {
                                        $BookServiceVal['iDisplayOrderHome'] = $tServiceDetails['BookService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['iDisplayOrder'];
                                        $BookServiceVal['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceDetails['BookService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['vImage'];
                                        $BookServiceArr[] = $BookServiceVal;
                                    }    
                                }
                            }

                            $sort_data = array_column($BookServiceArr, 'iDisplayOrderHome');
                            array_multisort($sort_data, SORT_ASC, $BookServiceArr);
                            $BookServiceArr[] = $MoreBookServicesArr;

                            $BookServiceImgArr = array(
                                'vCategoryName' => $medicalServiceSectionArr['BookService']['vTitle'],
                                'vCategoryTitle' => $medicalServiceSectionArr['BookService']['vTitle'],
                                'vCategoryDesc' => $medicalServiceSectionArr['BookService']['vDescription'],
                                'vTextColor' => $tCategoryDetails['BookService']['vTextColor'],
                                'vBgColor' => $tCategoryDetails['BookService']['vBgColor'],
                                'vImage' => $vImageBookService,
                                'MedicalServiceSection' => 'Yes',
                                'servicesArr' => $BookServiceArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $BookServiceImgArr;
                        }

                        if (isset($medicalServiceSectionArr['VideoConsult'])) {
                            $vImageVideoConsult = "";
                            if (!empty($tCategoryDetails['VideoConsult']['vImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['VideoConsult']['vImage'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['VideoConsult']['vImage']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "No";

                                $vImageVideoConsult = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['VideoConsult']['vImage'];
                            }

                            $VideoConsultArr = array();
                            if(count($medicalServiceSectionArr['VideoConsult']['Services']) > 3) {
                                $MoreVideoConsultArr = array(
                                    'vCategory' => $languageLabelsArr['LBL_MORE'],
                                    'vCategoryTitle' => $medicalServiceSectionArr['VideoConsult']['vTitle'],
                                    'vListLogo' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'vImage' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'moreSection' => "Yes",
                                    'moreCategories' => $medicalServiceSectionArr['VideoConsult']['Services']
                                );                                    
                            }

                            foreach ($medicalServiceSectionArr['VideoConsult']['Services'] as $BookServiceVal) {
                                if(count($VideoConsultArr) <= 2) {
                                    if(isset($tServiceDetails['VideoConsult']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']])) {
                                        $BookServiceVal['iDisplayOrderHome'] = $tServiceDetails['VideoConsult']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['iDisplayOrder'];
                                        $BookServiceVal['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceDetails['VideoConsult']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['vImage'];
                                        $VideoConsultArr[] = $BookServiceVal;
                                    }    
                                }
                            }

                            foreach ($VideoConsultArr as $key => $value) {
                                $sort_data[$key] = $value['iDisplayOrderHome'];
                            }
                            array_multisort($sort_data, SORT_ASC, $VideoConsultArr);
                            $VideoConsultArr[] = $MoreVideoConsultArr;

                            $VideoConsultImgArr = array(
                                'vCategoryName' => $medicalServiceSectionArr['VideoConsult']['vTitle'],
                                'vCategoryTitle' => $medicalServiceSectionArr['VideoConsult']['vTitle'],
                                'vCategoryDesc' => $medicalServiceSectionArr['VideoConsult']['vDescription'],
                                'vTextColor' => $tCategoryDetails['VideoConsult']['vTextColor'],
                                'vBgColor' => $tCategoryDetails['VideoConsult']['vBgColor'],
                                'vImage' => $vImageVideoConsult,
                                'MedicalServiceSection' => 'Yes',
                                'servicesArr' => $VideoConsultArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $VideoConsultImgArr;
                        }

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }

                    if (isset($medicalServiceSectionArr['MoreService'])) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = "1";
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                        $mServiceCategoryArr['imagesArr'] = array();

                        $vImageMoreService = "";
                        if (!empty($tCategoryDetails['MoreService']['vImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['MoreService']['vImage'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['MoreService']['vImage']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "No";

                            $vImageMoreService = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['MoreService']['vImage'];
                        }

                        $MoreServiceArr = array();
                        if(count($medicalServiceSectionArr['MoreService']['Services']) > 3) {
                            $mMoreServiceArr = array(
                                'vCategory' => $languageLabelsArr['LBL_MORE'],
                                'vCategoryTitle' => $medicalServiceSectionArr['MoreService']['vTitle'],
                                'vListLogo' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                'vImage' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                'moreSection' => "Yes",
                                'moreCategories' => $medicalServiceSectionArr['MoreService']['Services']
                            );
                        }

                        foreach ($medicalServiceSectionArr['MoreService']['Services'] as $BookServiceVal) {
                            if(count($MoreServiceArr) <= 3) {
                                if(isset($tServiceDetails['MoreService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']])) {
                                    $BookServiceVal['iDisplayOrderHome'] = $tServiceDetails['MoreService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['iDisplayOrder'];
                                    $BookServiceVal['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceDetails['MoreService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['vImage'];
                                    $MoreServiceArr[] = $BookServiceVal;
                                }    
                            }
                        }

                        foreach ($MoreServiceArr as $key => $value) {
                            $sort_data[$key] = $value['iDisplayOrderHome'];
                        }
                        array_multisort($sort_data, SORT_ASC, $MoreServiceArr);
                        // $MoreServiceArr[] = $mMoreServiceArr;

                        $MoreServiceImgArr = array(
                            'vCategoryName' => $medicalServiceSectionArr['MoreService']['vTitle'],
                            'vCategoryTitle' => $medicalServiceSectionArr['MoreService']['vTitle'],
                            'vCategoryDesc' => $medicalServiceSectionArr['MoreService']['vDescription'],
                            'vTextColor' => $tCategoryDetails['MoreService']['vTextColor'],
                            'vBgColor' => $tCategoryDetails['MoreService']['vBgColor'],
                            'vImage' => $vImageMoreService,
                            'MedicalServiceSection' => 'Yes',
                            'servicesArr' => $MoreServiceArr
                        );
                        $mServiceCategoryArr['imagesArr'][] = $MoreServiceImgArr;

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }

                    continue;
                }
            }
            elseif ($View['eViewType'] == "ServiceListView") {
                if($View['eServiceType'] == "NearBy" && $MODULES_OBJ->isEnableNearByService()) {
                    $tServiceDetails = json_decode($View['tServiceDetails'], true);

                    $NearbyArr = $NEARBY_OBJ->getNearByCategory('webservice', '', '', '', $lang);
                    $NearbyArrNew = $NearbyArr;

                    if (count($NearbyArr) > 4) {
                        $arrToInsert_arr['iCategoryId'] = '';
                        $arrToInsert_arr['vTitle'] = $languageLabelsArr['LBL_MORE'];
                        $arrToInsert_arr['vCategory'] = $languageLabelsArr['LBL_MORE'];
                        $arrToInsert_arr['vTextColor'] = "#000000";
                        // $arrToInsert_arr['vBgColor'] = "#ffffff";
                        $arrToInsert_arr['vBgColor'] = getColorFromImage($tconfig["tpanel_path"] . "webimages/icons/DefaultImg/ic_more_near_by.png");
                        $arrToInsert_arr['vImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_near_by.png";
                        $arrToInsert_arr['vListLogo'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_near_by.png";
                        $arrToInsert_arr['eCatType'] = 'NearBy';
                        $arrToInsert_arr['vCategoryTitle'] = $languageLabelsArr['LBL_NEAR_BY_SERVICE'];
                        $arrToInsert_arr['moreSection'] = "Yes";
                        $arrToInsert_arr['moreCategories'] = $NearbyArr;

                        $NearbyArrNew = array();
                        $nCount = 0;
                        foreach($NearbyArr as $nArr) {
                            if($nCount < 3) {
                                if(isset($tServiceDetails['iCategoryId_' . $nArr['iCategoryId']])) {
                                    $tServiceData = $tServiceDetails['iCategoryId_' . $nArr['iCategoryId']];
                                    $tServiceImg = $tServiceData['vImage'];
                                    $iDispOrderService = $tServiceData['iDisplayOrder'];

                                    if($tServiceData['eStatus'] == "Active") {
                                        $nArr['iDispOrderService'] = $iDispOrderService;
                                        if(!empty($tServiceImg)) {
                                            $nArr['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceImg;
                                        }
                                        $nArr['vBgColor'] = getColorFromImage(str_replace($tconfig['tsite_url'], $tconfig['tpanel_path'], $nArr['vImage']));
                                        $NearbyArrNew[] = $nArr;
                                        $nCount++;
                                    }
                                }
                            }
                        }

                        $sort_data = array_column($NearbyArrNew, 'iDispOrderService');
                        array_multisort($sort_data, SORT_ASC, $NearbyArrNew);

                        $NearbyArrNew[] = $arrToInsert_arr;
                    }
                    
                    if (count($NearbyArrNew) > 0) {
                        $mServiceCategoryArr['eViewType'] = "TitleView";
                        $mServiceCategoryArr['vTitle'] = $View['vTitle'];
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['NearbySection'] = 'Yes';
                        $mServiceCategoryArr['servicesArr'] = $NearbyArrNew;
                    }
                } 
				elseif ($View['eServiceType'] == "UberX" && $isUberXFeatureAvailable) {
                    $tServiceDetails = json_decode($View['tServiceDetails'], true);

                    $ServiceArr = array();
                    $ServiceCount = 0;
                    $ServiceCountAdd = 3;
                    if(count($DatanewArr) > 4) {
                        $ServiceCountAdd = 2;
                    }
                    foreach ($DatanewArr as $skey => $SubCategories) {
                        if($ServiceCount <= $ServiceCountAdd) {
                            $DatanewArr[$skey]['eShowType'] = "Icon";
                            $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                            if (in_array($SubCategories['eCatType'], ['ServiceProvider']) && isset($tServiceDetails['iVehicleCategoryId_' . $SubCategories['iVehicleCategoryId']])) {

                                $tServiceData = $tServiceDetails['iVehicleCategoryId_' . $SubCategories['iVehicleCategoryId']];
                                if($tServiceData['eStatus'] == "Active") {
                                    $tServiceImg = $tServiceData['vImage'];
                                    $iDispOrderService = $tServiceData['iDisplayOrder'];

                                    $DataSubCat = array();
                                    if (isset($vehicleCatArr[$SubCategories['iVehicleCategoryId']])) {
                                        $DataSubCat = $vehicleCatArr[$SubCategories['iVehicleCategoryId']];
                                    }
                                    if (count($DataSubCat) > 0) {
                                        for ($sCat = 0; $sCat < count($DataSubCat); $sCat++) {
                                            $DataSubCat1 = array();
                                            if (isset($vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']])) {
                                                $DataSubCat1 = $vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']];
                                            }

                                            $isAddDataUberX = "Yes";
                                            if($isEnableMedicalServices && in_array($SubCategories['iVehicleCategoryId'], [3,22,26,158])) {
                                                $isAddDataUberX = "No";
                                            }
                                            if (count($DataSubCat1) > 0 && $isAddDataUberX == "Yes") {
                                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                                $DataSubCatArr = $DatanewArr[$skey];
                                                $DataSubCatArr['isVideoConsultEnable'] = "No";
                                                $DataSubCatArr['vTitle'] = $DatanewArr[$skey]['vCategory'];
                                                $DataSubCatArr['vImage'] = $DatanewArr[$skey]['vListLogo'];
                                                if(!empty($tServiceImg)) {
                                                    $DataSubCatArr['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceImg;
                                                }
                                                $DataSubCatArr['iDispOrderService'] = $iDispOrderService;
                                                $DataSubCatArr['vTextColor'] = "#000000";
                                                $DataSubCatArr['vBgColor'] = getColorFromImage(str_replace($tconfig['tsite_url'], $tconfig['tpanel_path'], $DataSubCatArr['vImage']));
                                                $ServiceArr[] = $DataSubCatArr;
                                                $ServiceCount++;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if($ServiceCountAdd == 2) {
                        foreach ($ServiceArr as $key => $value) {
                            $sort_data[$key] = $value['iDispOrderService'];
                        }
                        array_multisort($sort_data, SORT_ASC, $ServiceArr);

                        $ufxArr = array();
                        foreach ($DatanewArr as $skey => $SubCategories) {
                            if (in_array($SubCategories['eCatType'], ['ServiceProvider'])) {
                                $DataSubCat = array();
                                if (isset($vehicleCatArr[$SubCategories['iVehicleCategoryId']])) {
                                    $DataSubCat = $vehicleCatArr[$SubCategories['iVehicleCategoryId']];
                                }
                                if (count($DataSubCat) > 0) {
                                    for ($sCat = 0; $sCat < count($DataSubCat); $sCat++) {
                                        $DataSubCat1 = array();
                                        if (isset($vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']])) {
                                            $DataSubCat1 = $vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']];
                                        }

                                        $isAddDataUberX = "Yes";
                                        if($isEnableMedicalServices && in_array($SubCategories['iVehicleCategoryId'], [3,22,26,158])) {
                                            $isAddDataUberX = "No";
                                        }
                                        if (count($DataSubCat1) > 0 && $isAddDataUberX == "Yes") {
                                            $DatanewArr[$skey]['eCatViewType'] = "List";
                                            $DataSubCatArr = $DatanewArr[$skey];
                                            $DataSubCatArr['isVideoConsultEnable'] = "No";
                                            $ufxArr[] = $DataSubCatArr;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        $ServiceArrMore = array();
                        $ServiceArrMore['iCategoryId'] = '';
                        $ServiceArrMore['vTitle'] = $languageLabelsArr['LBL_MORE_ONDEMAND_SERVICES'];
                        $ServiceArrMore['vCategory'] = $languageLabelsArr['LBL_MORE_ONDEMAND_SERVICES'];
                        $ServiceArrMore['vTextColor'] = "#000000";
                        $ServiceArrMore['vBgColor'] = getColorFromImage($tconfig["tpanel_path"] . "webimages/icons/DefaultImg/ic_more_other_services.png");
                        $ServiceArrMore['vImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_other_services.png";
                        $ServiceArrMore['vListLogo'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_other_services.png";
                        $ServiceArrMore['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICES_CATEGORY_TITLE'];
                        $ServiceArrMore['moreSection'] = "Yes";
                        $ServiceArrMore['moreCategories'] = $ufxArr;
                        $ServiceArr[] = $ServiceArrMore;
                        
                    }

                    if (count($ServiceArr) > 0) {
                        $mServiceCategoryArr['eViewType'] = "TitleView";
                        $mServiceCategoryArr['vTitle'] = $View['vTitle'];
                        $mServiceCategoryArr['vSubtitle'] = $View['vSubtitle'];
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['servicesArr'] = $ServiceArr;
                    }
                }
 				elseif($View['eServiceType'] == "Bidding" && $isEnableBiddingServices){
 					$ServiceArr = array();
					$ServiceArr=$BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang);
                    if (count($ServiceArr) > 0) {
                        $mServiceCategoryArr['eViewType'] = "TitleView";
                        $mServiceCategoryArr['vTitle'] = $View['vTitle'];
                        $mServiceCategoryArr['vSubtitle'] = $View['vSubtitle'];
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
						$BidServiceCount=0;
 						foreach ($ServiceArr as $servicekey => $serviceValue) { 
							if($BidServiceCount<= 2) {
 						 	//echo  ($servicekey);		echo"<br>"; 
								 	$serbidValue = array();
									$serbidValue[$skey]['vImage']= $serviceValue['vLogo_image'];
 									$serbidValue[$skey]['vListLogo']= $serviceValue['vListLogo'];
									$serbidValue[$skey]['tListDescription']= $serviceValue['tListDescription'];
									$serbidValue[$skey]['vCategory']= $serviceValue['vCategory'];
									$serbidValue[$skey]['iBiddingId']= $serviceValue['iBiddingId'];
									$serbidValue[$skey]['eCatType']= $serviceValue['eCatType'];
									$serbidValue[$skey]['other']= $serviceValue['other'];
									$serbidValue[$skey]['eCatViewType']= $serviceValue['eCatViewType'];
									$serbidValue[$skey]['iParentId']= $serviceValue['iParentId'];
									$serbidValue[$skey]['vTitle']= $serviceValue['vTitle'];
									$serbidValue[$skey]['vLogo']= $serviceValue['vLogo'];
									$serbidValue[$skey]['vLogo_image']= $serviceValue['vLogo_image']; 
									$DataSubCatArr = $serbidValue[$skey]; 
								 	$bidArr[] = $DataSubCatArr;
 									$BidServiceCount++;
  							}
 						}
                         $bidArr[$BidServiceCount]['iCategoryId'] = '';
                        $bidArr[$BidServiceCount]['vTitle'] = $languageLabelsArr['LBL_MORE_BID_SERVICES'];
                        $bidArr[$BidServiceCount]['vCategory'] = $languageLabelsArr['LBL_MORE_BID_SERVICES'];
                        $bidArr[$BidServiceCount]['vTextColor'] = "#000000";
                        $bidArr[$BidServiceCount]['vBgColor'] = getColorFromImage($tconfig["tpanel_path"] . "webimages/icons/DefaultImg/ic_more_bid.png");
                        $bidArr[$BidServiceCount]['vImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_bid.png";
                        $bidArr[$BidServiceCount]['vListLogo'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_bid.png";
                        $bidArr[$BidServiceCount]['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICES_CATEGORY_TITLE'];
                        $bidArr[$BidServiceCount]['moreSection'] = "Yes";
                        $bidArr[$BidServiceCount]['moreCategories'] = $ServiceArr;
                        $bidArrMain = $bidArr;
						$mServiceCategoryArr = array();
						$mServiceCategoryArr['eViewType'] = $View['eViewType'];
						$mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
						$mServiceCategoryArr['servicesArr'] = $bidArrMain;
                     }
				}
            }
          /*   if($isEnableVideoConsultingService ) { // if($View['eServiceType'] == "Bidding" && $isEnableVideoConsultingService && $isEnableBiddingServices) {
                continue;
            } else */
				{
                if(in_array($View['eViewType'], ['IntroView','IntroViewBuy', 'GridView']) || (in_array($View['eViewType'], ['BannerView', 'ServiceBannerView', 'ServiceListView']) && isset($mServiceCategoryArr['eServiceType']))) {
                    $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    /*if( isset($mServiceCategoryArr['imagesArr']) && !empty($mServiceCategoryArr['imagesArr']) && !empty($mServiceCategoryArr['imagesArr'][0]) ) {
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }else if(isset($mServiceCategoryArr['vTitle']) && !empty($mServiceCategoryArr['vTitle'])){
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }else if(isset($mServiceCategoryArr['servicesArr']) && !empty($mServiceCategoryArr['servicesArr']) && !empty($mServiceCategoryArr['servicesArr'][0]) ) {
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }*/
                }
            }
        }
        $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }
    setDataResponse($returnArr);
}
if ($type == "getServiceCategoriesPro") {
    $parentId = isset($_REQUEST['parentId']) ? clean($_REQUEST['parentId']) : 0;
    $userId = isset($_REQUEST['userId']) ? clean($_REQUEST['userId']) : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';
    $bookingFrom = isset($_REQUEST["bookingFrom"]) ? $_REQUEST["bookingFrom"] : 'App';//added by SP for manual booking for admin side not check user id.
    $eCatType = isset($_REQUEST["eCatType"]) ? $_REQUEST["eCatType"] : '';
     $eForVideoConsultation = isset($_REQUEST["eForVideoConsultation"]) ? $_REQUEST["eForVideoConsultation"] : 'No';
    if(empty($parentId)) {
        $parentId = 0;
    }
    $parentId = rtrim($parentId, ",");
    $parentIdCount = count(explode(",", $parentId));
    $sql_vehicle_category_table_name = getVehicleCategoryTblName();
    if ($userId != "" || $bookingFrom == 'Web') {
        if(strtoupper($APP_TYPE) == "RIDE" || strtoupper($APP_TYPE) == "RIDE-DELIVERY" || strtoupper($THEME_OBJ->isPXCProThemeActive()) == "YES") {
            getServiceCategoriesProApp($userId);
        } elseif (strtoupper($APP_TYPE) == "DELIVERY") {
            getServiceCategoriesProDY($userId);
        }
        $lang = $vGeneralLang;
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query Start
        if (isset($userDetailsArr['register_user_' . $userId])) {
            $row = $userDetailsArr['register_user_' . $userId];
        } else {
            $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$userId'");
            $userDetailsArr['register_user_' . $userId] = $row;
        }
        //Added By HJ On 07-07-2020 For Optimize register_user Table Query End
        $lang = $row[0]['vLang'];
        if ($lang == "" || $lang == NULL) {
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query Start
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            //Added By HJ On 24-06-2020 For Optimize language_master Table Query End
        }
        $vehicle_category_main = get_value($sql_vehicle_category_table_name, 'vCategory_' . $lang, 'iVehicleCategoryId', $parentId, '', 'true');
        $ssql = $ssql1 = $ssql2 = $ssql3 = '';
        //$ufxEnable = $MODULES_OBJ->isUfxFeatureAvailable(); // Commented By HJ On 04-06-2020 For Optimized Query Below Line
        $ufxEnable = $isUfxAvailable; // Added By HJ On 04-06-2020 For Optimized Query
        if ($APP_TYPE == "UberX") {
            $ssql = " AND eCatType='ServiceProvider'";
            if ($parent_ufx_catid > 0 && $parentId == 0) {
                $ssql .= " AND iVehicleCategoryId='" . $parent_ufx_catid . "'";
            }
        }
        $isUberXFeatureAvailable = $MODULES_OBJ->isUberXFeatureAvailable();
        $isDeliveryFeatureAvailable = $MODULES_OBJ->isDeliveryFeatureAvailable();
        $isEnableAnywhereDeliveryFeature = $MODULES_OBJ->isEnableAnywhereDeliveryFeature();
        $isDeliverAllFeatureAvailable = $MODULES_OBJ->isDeliverAllFeatureAvailable();
        $isEnableVideoConsultingServices = $MODULES_OBJ->isEnableVideoConsultingService();
        //$isEnableVideoConsultingService = $MODULES_OBJ->isEnableVideoConsultingService();
        $isEnableBiddingServices = $MODULES_OBJ->isEnableBiddingServices();
        $isEnableRentItemService = $MODULES_OBJ->isEnableRentItemService();
        $isEnableRentCarsService = $MODULES_OBJ->isEnableRentCarsService();
        $isEnableRentEstateService = $MODULES_OBJ->isEnableRentEstateService();
        $isEnableMedicalServices = $MODULES_OBJ->isEnableMedicalServices();
        $isEnableRideShareService = $MODULES_OBJ->isEnableRideShareService();
        $isEnableTrackServiceFeature = $MODULES_OBJ->isEnableTrackServiceFeature();
        $isEnableTrackAnyServiceFeature = $MODULES_OBJ->isEnableTrackAnyServiceFeature();
        $isAirFlightModuleAvailable = $MODULES_OBJ->isAirFlightModuleAvailable();
        $isEnableGenieFeature = $MODULES_OBJ->isEnableGenieFeature();
        $isEnableRunnerFeature = $MODULES_OBJ->isEnableRunnerFeature();
        $isEnableVideoConsultingService = false;
        if($isEnableVideoConsultingServices && $isUberXFeatureAvailable){
            $isEnableVideoConsultingService = true;
        }
        if (!$isUberXFeatureAvailable) {
            if ($ufxEnable != 'Yes') {
                $ssql .= " AND eCatType!='ServiceProvider'";
            }
        }
        if (!$isAirFlightModuleAvailable) {
            $ssql .= " AND eCatType!='Fly'";
        }
        if (!$isEnableAnywhereDeliveryFeature) {
            $ssql .= " AND eCatType!='Genie' AND eCatType!='Runner' AND eCatType!='Anywhere' ";
        }
        if (!$isDeliverAllFeatureAvailable) {
            $ssql .= " AND eCatType != 'DeliverAll' AND (eCatType != 'MoreDelivery' AND eFor != 'DeliverAllCategory') ";
        }
        if ($MODULES_OBJ->isDonationFeatureAvailable()) {
            $sql2 = "SELECT iVehicleCategoryId, vLogo,vLogo2, eShowType,vBannerImage, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText,iServiceId, eDeliveryType,vListLogo,eCatViewType,tListDescription,vListLogo1,vListLogo2,vListLogo3,ePromoteBanner,vPromoteBannerImage,tPromoteBannerTitle,eVideoConsultEnable,eFor,vIconDetails,eForMedicalService,iParentId,tMedicalServiceInfo FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND iParentId IN ($parentId) " . $ssql . " ORDER BY iDisplayOrder,iVehicleCategoryId ASC";
        } else {
            $sql2 = "SELECT iVehicleCategoryId, vLogo,vLogo2, eShowType,vBannerImage, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, eSubCatType, tBannerButtonText,iServiceId, eDeliveryType,vListLogo,eCatViewType,tListDescription,vListLogo1,vListLogo2,vListLogo3,ePromoteBanner,vPromoteBannerImage,tPromoteBannerTitle,eVideoConsultEnable,eFor,vIconDetails,eForMedicalService,iParentId,tMedicalServiceInfo FROM " . $sql_vehicle_category_table_name . " WHERE eStatus='Active' AND eCatType!='Donation' AND iParentId IN ($parentId) " . $ssql . " ORDER BY iDisplayOrder,iVehicleCategoryId ASC";
        }
        $Data = $obj->MySQLSelect($sql2);
        $categoryArr = $Datacategory = array();
        $eShowTerms = "No";
        $eProofUpload = "No";
        $tProofNote = "";
        $deliverAll_serviceArr = array();
        if (strtoupper(DELIVERALL) == "YES") {
            $scsql = "select iServiceId,eShowTerms,eProofUpload,JSON_UNQUOTE(JSON_EXTRACT(tProofNote, '$.tProofNote_" . $lang . "')) as tProofNote from service_categories";
            $scsqlData = $obj->MySQLSelect($scsql);
            foreach ($scsqlData as $scValue) {
                if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                    $eShowTerms = $scValue['eShowTerms'];
                }
                if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                    $eProofUpload = $scValue['eProofUpload'];
                    if (is_null($scValue['tProofNote']) || $scValue['tProofNote'] == "null") {
                        $scValue['tProofNote'] = "";
                    }
                    $tProofNote = $scValue['tProofNote'];
                }
                $deliverAll_serviceArr[$scValue['iServiceId']]['eShowTerms'] = $eShowTerms;
                $deliverAll_serviceArr[$scValue['iServiceId']]['eProofUpload'] = $eProofUpload;
                $deliverAll_serviceArr[$scValue['iServiceId']]['tProofNote'] = (!empty($tProofNote) && $tProofNote != NULL) ? $tProofNote : "";
            }
        }
        //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query Start
        $vehicleCatArr = $vehicleTypeArr = array();
        $vehicleTypeData = $obj->MySQLSelect("SELECT iVehicleTypeId,iVehicleCategoryId FROM vehicle_type WHERE eStatus='Active'");
        for ($g = 0; $g < count($vehicleTypeData); $g++) {
            $vehicleTypeArr[$vehicleTypeData[$g]['iVehicleCategoryId']][] = $vehicleTypeData[$g];
        }
        //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
        if ($parentId == 0) {
            $medicalServiceArr = array();
            if (count($Data) > 0) {
                $k = 0;
                //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query Start
                $Data2 = $obj->MySQLSelect("SELECT vc1.iParentId,vc1.iVehicleCategoryId, vc1.vLogo, vc1.vLogo2, vc1.eShowType,vc1.vBannerImage, vc1.vCategory_" . $lang . " as vCategory, vc1.eCatType, vc1.eSubCatType, vc1.tBannerButtonText, vc1.iServiceId, vc1.eDeliveryType,vc1.vListLogo,vc1.eCatViewType,vc1.tListDescription,vc1.vListLogo1,vc1.vListLogo2,vc1.vListLogo3,vc1.ePromoteBanner,vc1.vPromoteBannerImage,vc1.tPromoteBannerTitle,vc1.eVideoConsultEnable,vc1.eFor,vc1.vIconDetails,vc1.eForMedicalService,vc1.tMedicalServiceInfo,vc2.vCategory_" . $lang . " as vParentCategoryName FROM " . $sql_vehicle_category_table_name . " as vc1  LEFT JOIN " . $sql_vehicle_category_table_name . " as vc2 ON vc2.iVehicleCategoryId = vc1.iParentId WHERE vc1.eStatus='Active' ORDER BY vc1.iDisplayOrder ASC");
                for ($h = 0; $h < count($Data2); $h++) {
                    $vehicleCatArr[$Data2[$h]['iParentId']][] = $Data2[$h];
                }
                //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
                for ($i = 0; $i < count($Data); $i++) {
                    $BannerButtonText = "tBannerButtonText_" . $lang;
                    $tBannerButtonTextArr = json_decode($Data[$i]['tBannerButtonText'], true);
                    $tBannerButtonText = $tBannerButtonTextArr[$BannerButtonText];
                    $listDescText = "tListDescription_" . $lang;
                    $tListDescriptionArr = json_decode($Data[$i]['tListDescription'], true);
                    $tListDescriptionText = $tListDescriptionArr[$listDescText];
                    $PromoteBannerTitle = "tPromoteBannerTitle_" . $lang;
                    $tPromoteBannerTitleArr = json_decode($Data[$i]['tPromoteBannerTitle'], true);
                    $tPromoteBannerTitle = $tPromoteBannerTitleArr[$PromoteBannerTitle];
                    $Data[$i]['vBgColor'] = $Data[$i]['vBorderColor'] = "";
                    if (!empty($Data[$i]['vIconDetails'])) {
                        $vIconDetails = json_decode($Data[$i]['vIconDetails'], true);
                        $Data[$i]['vBgColor'] = $vIconDetails['vBgColor'];
                        $Data[$i]['vBorderColor'] = $vIconDetails['vBorderColor'];
                    }
                    if ($tListDescriptionText == null) {
                        $tListDescriptionText = "";
                    }
                    if ($tPromoteBannerTitle == null) {
                        $tPromoteBannerTitle = "";
                    }
                    if ($Data[$i]['eCatType'] == "ServiceProvider" || $Data[$i]['eCatType'] == "MoreDelivery") {
                        $Data2 = array();
                        if (isset($vehicleCatArr[$Data[$i]['iVehicleCategoryId']])) {
                            $Data2 = $vehicleCatArr[$Data[$i]['iVehicleCategoryId']];
                        }
                        if ($isEnableMedicalServices && $Data[$i]['iVehicleCategoryId'] == "3") {
                            $medicalServiceArr = $Data2;
                        }
                        //Added By HJ On 07-07-2020 For Optimize vehicle_category Table Query End
                        if (count($Data2) > 0) {
                            for ($j = 0; $j < count($Data2); $j++) {
                                if ($Data2[$j]['eCatType'] == "ServiceProvider") {
                                    $Data3 = array();
                                    if (isset($vehicleTypeArr[$Data2[$j]['iVehicleCategoryId']])) {
                                        $Data3 = $vehicleTypeArr[$Data2[$j]['iVehicleCategoryId']];
                                    }
                                    //Added By HJ On 07-07-2020 For Optimize vehicle_type Table Query End
                                    if (count($Data3) > 0 || ($Data2[$j]['eVideoConsultEnable'] == "Yes" && $isEnableVideoConsultingService)) {
                                        $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                                        $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                                        $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                                        $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                                        $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                                        $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                                        $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                                        $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                                        $Datacategory[$k]['eShowTerms'] = "No";
                                        $Datacategory[$k]['eProofUpload'] = "No";
                                        $Datacategory[$k]['tProofNote'] = "";
                                        if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0) {
                                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                                $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                                            }
                                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                                $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                                $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                                            }
                                        }
                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                                        $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;

                                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo3'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo3'] : "";
                                        $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                                        $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                                        $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                                        $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                                        $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];

                                        $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                                        $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                                        $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                                        $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                                        $k++;
                                    }
                                } else {
                                    $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                                    $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                                    $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                                    $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                                    $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                                    $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                                    $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                                    $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                                    $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                                    $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                                    $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                                    $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                                    $Datacategory[$k]['eShowTerms'] = "No";
                                    $Datacategory[$k]['eProofUpload'] = "No";
                                    $Datacategory[$k]['tProofNote'] = "";
                                    if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0) {
                                        if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                            $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                                        }
                                        if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                            $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                            $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                                        }
                                    }
                                    $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                                    $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                                    $Datacategory[$k]['tListDescription'] = $tListDescriptionText;

                                    $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo3'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo3'] : "";
                                    $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                                    $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                                    $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                                    $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                                    $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];

                                    $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                                    $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                                    $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                                    $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                                    $k++;
                                }
                            }
                        }
                    } else {
                        $Datacategory[$k]['eCatType'] = $Data[$i]['eCatType'];
                        $Datacategory[$k]['eSubCatType'] = $Data[$i]['eSubCatType'];
                        $Datacategory[$k]['eDeliveryType'] = $Data[$i]['eDeliveryType'];
                        $Datacategory[$k]['iVehicleCategoryId'] = $Data[$i]['iVehicleCategoryId'];
                        $Datacategory[$k]['vCategory'] = $Data[$i]['vCategory'];
                        $Datacategory[$k]['vCategoryBanner'] = $Data[$i]['vCategory'];
                        $Datacategory[$k]['vLogo'] = $Data[$i]['vLogo'];
                        $Datacategory[$k]['vLogo_image'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/android/' . $Data[$i]['vLogo2'];
                        $Datacategory[$k]['eShowType'] = $Data[$i]['eShowType'];
                        $Datacategory[$k]['iServiceId'] = $Data[$i]['iServiceId'];
                        $Datacategory[$k]['tBannerButtonText'] = $tBannerButtonText;
                        $Datacategory[$k]['vBannerImage'] = ($Data[$i]['vBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vBannerImage'] : "";
                        $Datacategory[$k]['eShowTerms'] = "No";
                        $Datacategory[$k]['eProofUpload'] = "No";
                        $Datacategory[$k]['tProofNote'] = "";
                        if (strtoupper(DELIVERALL) == "YES" && $Data[$i]['iServiceId'] > 0 && $MODULES_OBJ->isEnableTermsServiceCategories()) {
                            if ($MODULES_OBJ->isEnableTermsServiceCategories()) {
                                $Datacategory[$k]['eShowTerms'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eShowTerms'];
                            }
                            if ($MODULES_OBJ->isEnableProofUploadServiceCategories()) {
                                $Datacategory[$k]['eProofUpload'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['eProofUpload'];
                                $Datacategory[$k]['tProofNote'] = $deliverAll_serviceArr[$Data[$i]['iServiceId']]['tProofNote'];
                            }
                        }
                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo'] : "";
                        $Datacategory[$k]['eCatViewType'] = $Data[$i]['eCatViewType'];
                        $Datacategory[$k]['tListDescription'] = $tListDescriptionText;

                        $Datacategory[$k]['vListLogo'] = ($Data[$i]['vListLogo3'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vListLogo3'] : "";
                        $Datacategory[$k]['ePromoteBanner'] = $Data[$i]['ePromoteBanner'];
                        $Datacategory[$k]['vPromoteBannerImage'] = ($Data[$i]['vPromoteBannerImage'] != "") ? $tconfig['tsite_upload_images_vehicle_category'] . '/' . $Data[$i]['iVehicleCategoryId'] . '/' . $Data[$i]['vPromoteBannerImage'] : "";
                        $Datacategory[$k]['tPromoteBannerTitle'] = $tPromoteBannerTitle;
                        $Datacategory[$k]['vBgColor'] = $Data[$i]['vBgColor'];
                        $Datacategory[$k]['vBorderColor'] = $Data[$i]['vBorderColor'];

                        $Datacategory[$k]['eFor'] = $Data[$i]['eFor'];
                        $Datacategory[$k]['eForMedicalService'] = $Data[$i]['eForMedicalService'];
                        $Datacategory[$k]['tMedicalServiceInfo'] = $Data[$i]['tMedicalServiceInfo'];
                        $Datacategory[$k]['iParentId'] = $Data[$i]['iParentId'];
                        $k++;
                    }
                }
            }
        }

        $Datacategory1 = array_unique($Datacategory, SORT_REGULAR);
        $DatanewArr = array();
        foreach ($Datacategory1 as $inner) {
            if ($inner['eCatType'] == "Genie") {
                $inner['eCatType'] = "Anywhere";
            }
            array_push($DatanewArr, $inner);
        }
        $returnArr['Action'] = "1";
        if ($vehicle_category_main != '') {
            $returnArr['vParentCategoryName'] = $vehicle_category_main;
        } else {
            $returnArr['vParentCategoryName'] = '';
        }

        $DatanewArrTmp = array();
        for ($i = 0; $i < count($DatanewArr); $i++) {
            $vLogo_image_tmp = $DatanewArr[$i]['vLogo_image'];
            $vBannerImage_tmp = $DatanewArr[$i]['vBannerImage'];
            $vLogo_image_tmp_orig_name_arr = explode("/", $DatanewArr[$i]['vLogo_image']);
            $vBannerImage_tmp_orig_name_arr = explode("/", $DatanewArr[$i]['vBannerImage']);
            $isFileExist = false;
            if (!empty($vBannerImage_tmp_orig_name_arr) && count($vBannerImage_tmp_orig_name_arr) > 0) {
                $vBannerImage_tmp_orig_name = $vBannerImage_tmp_orig_name_arr[count($vBannerImage_tmp_orig_name_arr) - 1];
                $isFileExist = file_exists($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $DatanewArr[$i]['iVehicleCategoryId'] . '/' . $vBannerImage_tmp_orig_name);
            }
            $isFileExist_1 = false;
            if (!empty($vLogo_image_tmp_orig_name_arr) && count($vLogo_image_tmp_orig_name_arr) > 0) {
                $vLogo_image_tmp_orig_name = $vLogo_image_tmp_orig_name_arr[count($vLogo_image_tmp_orig_name_arr) - 1];
                $isFileExist_1 = file_exists($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $DatanewArr[$i]['iVehicleCategoryId'] . '/android/' . $vLogo_image_tmp_orig_name);
            }
            if (empty($vBannerImage_tmp) || !$isFileExist) {
                $DatanewArr[$i]['vBannerImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/15529086332815.png";
            }
            if (empty($vLogo_image_tmp) || !$isFileExist_1) {
                $DatanewArr[$i]['vLogo_image'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/service_categories.png";
            }
            if ($isEnableMedicalServices && $DatanewArr[$i]['eForMedicalService'] == "Yes") {
                $medicalServiceArr[] = $DatanewArr[$i];
            }
            if ($parentIdCount > 1) {
                $DatanewArrTmp[$DatanewArr[$i]['iParentId']][] = $DatanewArr[$i];
            }
        }

        $returnArr['message'] = $DatanewArr;
        $whereloc = " AND iLocationid IN ('-1')";
        if ($MODULES_OBJ->isEnableLocationwiseBanner()) {
            $vLatitude = isset($_REQUEST["vLatitude"]) ? $_REQUEST["vLatitude"] : '';
            $vLongitude = isset($_REQUEST["vLongitude"]) ? $_REQUEST["vLongitude"] : '';
            $User_Address_Banner = array($vLatitude, $vLongitude);
            if (!empty($User_Address_Banner)) {
                $iLocationIdBanner = GetUserGeoLocationIdBanner($User_Address_Banner);
                $country_str_banner = "'-1'";
                if (count($iLocationIdBanner) > 0) {
                    foreach ($iLocationIdBanner as $key => $value) {
                        $country_str_banner .= ", '" . $value . "'";
                    }
                    $whereloc = " AND iLocationid IN (" . $country_str_banner . ")";
                }
            }
        }
        $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $lang . "' AND vImage != '' AND eStatus = 'Active' AND (iServiceId = '0' OR iServiceId = '') AND eBuyAnyService NOT IN ('Genie', 'Runner') AND eType = 'General' $whereloc ORDER BY iDisplayOrder ASC");
        $dataOfBanners = array();
        $count = 0;
        for ($i = 0; $i < count($Data_banners); $i++) {
            if (isset($Data_banners[$i]['vImage']) && $Data_banners[$i]['vImage'] != "") {
                $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];

                $imagedata = getimagesize($banner_img_path);
                $dataOfBanners[$count]['vImageWidth'] = strval($imagedata[0]);
                $dataOfBanners[$count]['vImageHeight'] = strval($imagedata[1]);
                $dataOfBanners[$count]['isClickable'] = "No";
                $count++;
            }
        }


        $returnArr['message'] = "";
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", $iServiceId);
        
        if ($APP_TYPE == "UberX") {
            $bannerArr = array(
                'eViewType' => 'BannerView',
                'isScroll' => "Yes",
                'displayCount' => "1",
                'isFullView' => "No",
                'vImageWidth' => $dataOfBanners[0]['vImageWidth'],
                'vImageHeight' => $dataOfBanners[0]['vImageHeight'],
                'imagesArr' => $dataOfBanners
            );
            
            $MASTER_SERVICE_CATEGORIES = getServiceCategoriesProSP($DatanewArr, $lang);
            array_unshift($MASTER_SERVICE_CATEGORIES, $bannerArr);
            $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
            setDataResponse($returnArr);

        } elseif ($THEME_OBJ->isProDeliveryKingThemeActive() == "Yes") {
            $bannerArr = array(
                'eViewType' => 'BannerView',
                'isScroll' => "Yes",
                'displayCount' => "1",
                'isFullView' => "No",
                'vImageWidth' => $dataOfBanners[0]['vImageWidth'],
                'vImageHeight' => $dataOfBanners[0]['vImageHeight'],
                'imagesArr' => $dataOfBanners
            );
            
            $MASTER_SERVICE_CATEGORIES = getServiceCategoriesProDK($DatanewArr, $lang);
            array_unshift($MASTER_SERVICE_CATEGORIES, $bannerArr);
            $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
            setDataResponse($returnArr);
        }

        // echo "<pre>"; print_r($DatanewArr); exit;
        $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_EXTRACT(vCategoryName, '$.vCategoryName_" . $lang . "')) as vCategoryName, JSON_UNQUOTE(JSON_EXTRACT(vCategoryDesc, '$.vCategoryDesc_" . $lang . "')) as vCategoryDesc   FROM $master_service_category_tbl WHERE eStatus = 'Active'");

        $MasterCategoryArr = array();
        foreach ($master_service_categories as $mCategory) {
            $MasterCategoryArr[$mCategory['eType']] = $mCategory;
        }	
		
 
        $app_home_screen_view = $obj->MySQLSelect("SELECT eViewType, eServiceType, vTitle, vSubtitle,  tGridServices, tServiceDetails, iDisplayOrder FROM app_home_screen_view ORDER BY iDisplayOrder ASC");

        $ViewArr = array();
        foreach ($app_home_screen_view as $view) {
            $ViewType = !empty($view['eServiceType']) ? $view['eServiceType'] : $view['eViewType'];
            $ViewTitle = $ViewSubTitle = "";
            if (!empty($view['vTitle'])) {
                $ViewTitleArr = json_decode($view['vTitle'], true);
                $ViewTitle = $ViewTitleArr['vTitle_' . $lang];
            }
            if (!empty($view['vSubtitle'])) {
                $ViewSubTitleArr = json_decode($view['vSubtitle'], true);
                $ViewSubTitle = $ViewSubTitleArr['vSubtitle_' . $lang];
            }
 
			
            $view['vTitle'] = $ViewTitle;
            $view['vSubtitle'] = $ViewSubTitle;

            $ViewArr[$ViewType] = $view;
        }

        $MASTER_SERVICE_CATEGORIES = $PromotionalBannerArr = array();
        foreach ($ViewArr as $View) {
            $mServiceCategoryArr = array();
            $mServiceCategoryArr['eViewType'] = $View['eViewType'];

            if ($View['eViewType'] == "IntroView") {
                $mServiceCategoryArr['vTitle'] = str_replace("#USERNAME#", $row[0]['vName'], $View['vTitle']);
                $mServiceCategoryArr['vSubtitle'] = $View['vSubtitle'];
                $mServiceCategoryArr['vImage'] = "";
            } elseif ($View['eViewType'] == "BannerView") {
                if ($View['eServiceType'] == "GeneralBanner") {
                    if(count($dataOfBanners) > 0) {
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "Yes";
                        $mServiceCategoryArr['displayCount'] = "1";
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['vImageWidth'] = $dataOfBanners[0]['vImageWidth'];
                        $mServiceCategoryArr['vImageHeight'] = $dataOfBanners[0]['vImageHeight'];
                        $mServiceCategoryArr['imagesArr'] = $dataOfBanners;
                    } else {
                        continue;
                    }
                }
                elseif ($View['eServiceType'] == "PromotionalBanner") {
                    foreach ($DatanewArr as $SubCategories) {
                        if ($SubCategories['ePromoteBanner'] == "Yes") {
                            $promotional_banner_data = $obj->MySQLSelect("SELECT vImage FROM banners WHERE vCode = '$lang' AND iVehicleCategoryId = '" . $SubCategories['iVehicleCategoryId'] . "' AND eType = 'Promotion'");
                            if (!empty($promotional_banner_data) && count($promotional_banner_data) > 0) {
                                $PromotionalBannerArr = array(
                                    'vCategoryName' => !empty($SubCategories['tPromoteBannerTitle']) ? $SubCategories['tPromoteBannerTitle'] : "",
                                    'vCategory' => !empty($SubCategories['tPromoteBannerTitle']) ? $SubCategories['tPromoteBannerTitle'] : "",
                                    'vImage' => $tconfig['tsite_upload_images'] . $promotional_banner_data[0]['vImage'],
                                    'eCatType' => $SubCategories['eCatType'],
                                    'ePromoteBanner' => 'Yes',
                                    'iVehicleCategoryId' => $SubCategories['iVehicleCategoryId'],
                                    'iParentId' => $SubCategories['iParentId'],
                                    'iServiceId' => $SubCategories['iServiceId'],
                                    'eShowTerms' => $SubCategories['eShowTerms'],
                                    'eProofUpload' => $SubCategories['eProofUpload'],
                                    'tProofNote' => $SubCategories['tProofNote'],
                                    'eFor' => $SubCategories['eFor'],
                                    'isClickable' => 'Yes'
                                );
                                if ($SubCategories['eCatType'] == "DeliverAll") {
                                    $PromotionalBannerArr['iServiceId'] = $SubCategories['iServiceId'];
                                }
                                $imagedata = getimagesize($tconfig['tsite_upload_images_panel'] . $promotional_banner_data[0]['vImage']);
                                $PromotionalBannerArr['vImageWidth'] = strval($imagedata[0]);
                                $PromotionalBannerArr['vImageHeight'] = strval($imagedata[1]);

                                $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                                $mServiceCategoryArr['isScroll'] = "No";
                                $mServiceCategoryArr['displayCount'] = "1";
                                $mServiceCategoryArr['isFullView'] = "Yes";
                                $mServiceCategoryArr['isOnlyImage'] = "Yes";
                                $mServiceCategoryArr['AddTopPadding'] = "Yes";
                                $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                                $mServiceCategoryArr['vImageWidth'] = $PromotionalBannerArr['vImageWidth'];
                                $mServiceCategoryArr['vImageHeight'] = $PromotionalBannerArr['vImageHeight'];
                                $mServiceCategoryArr['isClickable'] = "Yes";
                                $mServiceCategoryArr['imagesArr'][] = $PromotionalBannerArr;
                            } else {
                                continue 2;
                            }
                        }
                    }
                }
                elseif ($View['eServiceType'] == "BuySell" && ($isEnableRentEstateService || $isEnableRentCarsService || $isEnableRentItemService)) {

                    $BuySellCount = 2;
                    if (!$isEnableRentItemService || !$isEnableRentCarsService) {
                        $BuySellCount = 1;
                    }

                    if ($isEnableRentEstateService) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = "1";
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['isOnlyImage'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "No";
                        $mServiceCategoryArr['imagesArr'] = array();

                        $vImageRentEstate = "";
                        if (!empty($MasterCategoryArr['RentEstate']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentEstate']['vIconImage1'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentEstate']['vIconImage1']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "Yes";

                            $vImageRentEstate = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['RentEstate']['vIconImage1'];
                        }

                        $msql = " AND iMasterServiceCategoryId = " . $MasterCategoryArr['RentEstate']['iMasterServiceCategoryId'];
                        $RentEstateServicesArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                        if(strtoupper($ENABLE_BUY_SELL_DETAIL_VIEW_HOME_SCREEN) == "YES") {
                            $RentEstateServicesArrNew = array();
                            $RentEstateServicesArrNew[] = $RentEstateServicesArr[0];
                            $RentEstateServicesArr = $RentEstateServicesArrNew;
                        }
                        $RentEstateImgArr = array(
                            'vCategoryName' => $MasterCategoryArr['RentEstate']['vCategoryName'],
                            'vCategoryTitle' => $MasterCategoryArr['RentEstate']['vCategoryName'],
                            'vCategory' => $MasterCategoryArr['RentEstate']['vCategoryName'],
                            'vImage' => $vImageRentEstate,
                            'vTextColor' => $MasterCategoryArr['RentEstate']['vTextColor'],
                            'vBgColor' => $MasterCategoryArr['RentEstate']['vBgColor'],
                            'isClickable' => 'Yes',
                            'PromotionalTagText' => $languageLabelsArr['LBL_PROMOTIONAL_CATEGORY_TAG_1'],
                            'rentestateSection' => 'Yes',
                            'servicesArr' => $RentEstateServicesArrNew
                        );
                        $mServiceCategoryArr['imagesArr'][] = $RentEstateImgArr;

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }

                    if ($isEnableRentItemService || $isEnableRentCarsService) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = $BuySellCount;
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['isOnlyImage'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                        $mServiceCategoryArr['imagesArr'] = array();

                        if ($isEnableRentCarsService) {
                            $vImageRentCar = "";
                            if (!empty($MasterCategoryArr['RentCars']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentCars']['vIconImage1'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentCars']['vIconImage1']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "Yes";

                                $vImageRentCar = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['RentCars']['vIconImage1'];
                            }

                            $msql = " AND iMasterServiceCategoryId = " . $MasterCategoryArr['RentCars']['iMasterServiceCategoryId'];
                            $RentCarsServicesArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                            if(strtoupper($ENABLE_BUY_SELL_DETAIL_VIEW_HOME_SCREEN) == "YES") {
                                $RentCarsServicesArrNew = array();
                                $RentCarsServicesArrNew[] = $RentCarsServicesArr[0];
                                $RentCarsServicesArr = $RentCarsServicesArrNew;
                            }
                            $RentCarImgArr = array(
                                'vCategoryName' => $MasterCategoryArr['RentCars']['vCategoryName'],
                                'vCategoryTitle' => $MasterCategoryArr['RentCars']['vCategoryName'],
                                'vCategory' => $MasterCategoryArr['RentCars']['vCategoryName'],
                                'vImage' => $vImageRentCar,
                                'vTextColor' => $MasterCategoryArr['RentCars']['vTextColor'],
                                'vBgColor' => $MasterCategoryArr['RentCars']['vBgColor'],
                                'isClickable' => 'Yes',
                                'rentcarSection' => 'Yes',
                                'servicesArr' => $RentCarsServicesArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $RentCarImgArr;
                        }

                        if ($isEnableRentItemService) {
                            $vImageRentItem = "";
                            if (!empty($MasterCategoryArr['RentItem']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentItem']['vIconImage1'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['RentItem']['vIconImage1']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "Yes";

                                $vImageRentItem = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['RentItem']['vIconImage1'];
                            }

                            $msql = " AND iMasterServiceCategoryId = " . $MasterCategoryArr['RentItem']['iMasterServiceCategoryId'];
                            $RentItemServicesArr = $RENTITEM_OBJ->getRentItemMaster('webservice', $msql, '', '', $lang);
                            if(strtoupper($ENABLE_BUY_SELL_DETAIL_VIEW_HOME_SCREEN) == "YES") {
                                $RentItemServicesArrNew = array();
                                $RentItemServicesArrNew[] = $RentItemServicesArr[0];
                                $RentItemServicesArr = $RentItemServicesArrNew;
                            }
                            $RentItemImgArr = array(
                                'vCategoryName' => $MasterCategoryArr['RentItem']['vCategoryName'],
                                'vCategoryTitle' => $MasterCategoryArr['RentItem']['vCategoryName'],
                                'vCategory' => $MasterCategoryArr['RentItem']['vCategoryName'],
                                'vImage' => $vImageRentItem,
                                'vTextColor' => $MasterCategoryArr['RentItem']['vTextColor'],
                                'vBgColor' => $MasterCategoryArr['RentItem']['vBgColor'],
                                'isClickable' => 'Yes',
                                'rentitemSection' => 'Yes',
                                'servicesArr' => $RentItemServicesArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $RentItemImgArr;
                        }

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }
                    continue;
                }
                elseif (($View['eServiceType'] == "RideShare" && $isEnableRideShareService) || ($View['eServiceType'] == "TrackService" && $isEnableTrackServiceFeature) || ($View['eServiceType'] == "TrackAnyService" && $isEnableTrackAnyServiceFeature) || ($View['eServiceType'] == "Genie" && $isEnableAnywhereDeliveryFeature && ($isEnableGenieFeature || $isEnableRunnerFeature)) || ($View['eServiceType'] == "VideoConsult" && $isEnableVideoConsultingService) || ($View['eServiceType'] == "Bidding" && $isEnableBiddingServices)) {

                    $ServiceCount = 1;
                    if ($View['eServiceType'] == "VideoConsult" || $View['eServiceType'] == "Bidding") {
                        $ServiceCount = 2;

                        if(!$isEnableVideoConsultingService || !$isEnableBiddingServices) {
                            $ServiceCount = 1;                                
                        }
                    }

                    $mServiceCategoryArr = array();
                    $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                    $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                    $mServiceCategoryArr['isScroll'] = "No";
                    $mServiceCategoryArr['displayCount'] = $ServiceCount;
                    $mServiceCategoryArr['isFullView'] = "Yes";
                    $mServiceCategoryArr['isOnlyImage'] = "Yes";
                    $mServiceCategoryArr['AddTopPadding'] = "Yes";
                    $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                    $mServiceCategoryArr['imagesArr'] = array();

                    $languageLabelsArrService = $languageLabelsArr;

                    $vImageService = "";
                    $tCategoryDetails = array();
                    if(isset($MasterCategoryArr[$View['eServiceType']])) {
                        $tCategoryDetails = json_decode($MasterCategoryArr[$View['eServiceType']]['tCategoryDetails'], true);

                        if (!empty($MasterCategoryArr[$View['eServiceType']]['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr[$View['eServiceType']]['vIconImage1'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr[$View['eServiceType']]['vIconImage1']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "Yes";

                            $vImageService = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr[$View['eServiceType']]['vIconImage1'];
                        }

                        $ServiceImgArr = array(
                            'vCategoryName' => '',
                            'vCategoryTitle' => $MasterCategoryArr[$View['eServiceType']]['vCategoryName'],
                            'vCategoryDesc' => '',
                            'vTextColor' => $MasterCategoryArr[$View['eServiceType']]['vTextColor'],
                            'vBgColor' => $MasterCategoryArr[$View['eServiceType']]['vBgColor'],
                            'isClickable' => 'Yes',
                            'vImage' => $vImageService
                        );
                    }

                    if($View['eServiceType'] == "RideShare") {
                        $languageLabelsArrRideShare = $languageLabelsArr;
                        $ServiceImgArr['RideShareSection'] = 'Yes';
                        $ServiceImgArr['servicesArr'] = $RIDE_SHARE_OBJ->getCategories($tCategoryDetails);

                    } elseif ($View['eServiceType'] == "TrackService" || $View['eServiceType'] == "TrackAnyService") {
                        $languageLabelsArrTrackService = $languageLabelsArr;
                        // $TrackServiceArr = $TRACK_SERVICE_OBJ->getCategories($tCategoryDetails);
                        $mServiceCategoryArr['isFullView'] = "No";
                        // $ServiceImgArr['vCategoryTitle'] = $TrackServiceArr[0]['vCategory'];
                        $ServiceImgArr['vCategoryTitle'] = $languageLabelsArr['LBL_TRACK_ANY_SERVICE_CATEGORY_TITLE'];
                        // $ServiceImgArr['TrackServiceSection'] = 'Yes';
                        // $ServiceImgArr['eCatType'] = $TrackServiceArr[0]['eCatType'];
                        $ServiceImgArr['eCatType'] = "TrackAnyService";
                        $ServiceImgArr['servicesArr'] = $TRACK_ANY_SERVICE_OBJ->getServiceCategories($lang, $tCategoryDetails);

                    } elseif ($View['eServiceType'] == "Genie") {
                        $app_banner_runner = $obj->MySQLSelect("SELECT vImage FROM banners WHERE vCode = '$lang' AND eBuyAnyService = 'Genie' AND eType = 'AppHomeScreen'");

                        if (!empty($app_banner_runner) && count($app_banner_runner) > 0) {
                            $ServiceArr = array();
                            foreach ($DatanewArr as $skey => $SubCategories) {
                                $DatanewArr[$skey]['eShowType'] = "Icon";
                                $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                                if ($isEnableAnywhereDeliveryFeature && in_array($SubCategories['eCatType'], ['Genie', 'Runner', 'Anywhere'])) {

                                    $DatanewArr[$skey]['eCatViewType'] = "List";
                                    $ServiceArr[] = $DatanewArr[$skey];
                                }
                            }

                            $GenieBannerArr = array(
                                'vCategoryName' => '',
                                'vCategoryTitle' => $languageLabelsArr['LBL_DELIVERY_SERVICES'],
                                'vImage' => $tconfig['tsite_upload_images'] . $app_banner_runner[0]['vImage'],
                                'eFor' => "",
                                'isClickable' => 'Yes'
                            );

                            $imagedata = getimagesize($tconfig['tsite_upload_images_panel'] . $app_banner_runner[0]['vImage']);
                            $GenieBannerArr['vImageWidth'] = strval($imagedata[0]);
                            $GenieBannerArr['vImageHeight'] = strval($imagedata[1]);
                            $GenieBannerArr['servicesArr'] = $ServiceArr;

                            $mServiceCategoryArr['AddBottomPadding'] = "No";
                            $mServiceCategoryArr['isFullView'] = "No";
                            $mServiceCategoryArr['vImageWidth'] = $GenieBannerArr['vImageWidth'];
                            $mServiceCategoryArr['vImageHeight'] = $GenieBannerArr['vImageHeight'];
                            $mServiceCategoryArr['isClickable'] = "Yes";
                            $ServiceImgArr = $GenieBannerArr;
                        } else {
                            continue;
                        }                            
                        
                    } elseif ($View['eServiceType'] == "VideoConsult") {
                        $mServiceCategoryArr['isFullView'] = "No";

                        $ServiceImgArr['vCategoryTitle'] = $languageLabelsArr['LBL_VIDEO_CONSULT_CATEGORY_TITLE'];
                        $ServiceImgArr['VideoConsultSection'] = 'Yes';
                        $ServiceImgArr['servicesArr'] = array();
                        
                        foreach ($DatanewArr as $skey => $SubCategories) {

                            $DatanewArr[$skey]['eShowType'] = "Icon";
                            $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                            if ($isEnableVideoConsultingService) {
                                $DatanewArr[$skey]['isVideoConsultEnable'] = $VIDEO_CONSULT_OBJ->checkVideoConsultEnable($SubCategories['iVehicleCategoryId']);
                            }
                            if ($isEnableVideoConsultingService && $DatanewArr[$skey]['isVideoConsultEnable'] == "Yes") {
                                $DatanewArr[$skey]['eCatViewType'] = "List";

                                $isAddDataVC = "Yes";
                                if($isEnableMedicalServices && in_array($SubCategories['iVehicleCategoryId'], [3,22,26,158])) {
                                    $isAddDataVC = "No";
                                }

                                if($isAddDataVC == "Yes") {
                                    $ServiceImgArr['servicesArr'][] = $DatanewArr[$skey];
                                }                                
                            }
                        }
						
						$Datdata = getimagesize(str_replace("https", "http", $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['VideoConsult']['vIconImage1']));
						$NewServiceDataArr = array(
							'vCategoryName' => '',
							'vCategoryTitle' => $languageLabelsArr['LBL_VIDEO_CONSULT_CATEGORY_TITLE'],
						  //  'vIconImage' => $tconfig['tsite_upload_images'] . 'video_consult.png', 
							'vIconImage' => $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['VideoConsult']['vIconImage1'],
							'eFor' => "",
							'VideoConsultSection' => "Yes",
							'isFullView' => "No",
							'vBgColor' => "#FFF0C3",
							'vTextColor' => "#000000",
							'vTextFontSize' => "12",
							'vDecFontSize' => "9.5",
							'vBannerWidth' => "177",
							'vBannerHeight' => "111",
							'vBannerBorderRadius' => "8",
							'ImagePosition' => "Right-Bottom",
							'ImageMargin-Top' => "15",
							'ImageMargin-Left' => "2",
							'ImageMargin-Right' => "0",
							'ImageMargin-Bottom' => "0",
							'vIconImageWidth' =>  '65',
							'vIconImageHeight' =>  '74.71',
						   // 'vIconImageWidth' =>  strval($Datdata[0]),
						  //  'vIconImageHeight' =>  strval($Datdata[1]),
							'isClickable' => 'Yes'
						);
						$NewServiceDataArr['vTitle'] = $MasterCategoryArr[$View['eServiceType']]['vCategoryName'];  // "Online Video Consulting";
						$NewServiceDataArr['vDescription'] = $MasterCategoryArr[$View['eServiceType']]['vCategoryDesc'];
						//"Book & Video Consult with Ttors, Yoga Teachers, Lawyers, Astrologers, etc. via the App.";
						$NewServiceDataArr['servicesArr'] = $ServiceImgArr['servicesArr'];

						$ServiceImgArr= $NewServiceDataArr;
						

                    } elseif ($View['eServiceType'] == "Bidding") {
                        $mServiceCategoryArr['isFullView'] = "No";

                        $ServiceImgArr['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICE_BID_CATEGORY_TITLE'];
                        $ServiceImgArr['biddingSection'] = 'Yes';
                        $ServiceImgArr['servicesArr'] = $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang);
                    }

                    if (in_array($View['eServiceType'], ['VideoConsult', 'Bidding', 'RideShare', 'TrackService'])) {
                        $tCatImagesArr = array();
                        if(!empty($MasterCategoryArr[$View['eServiceType']]['vCategoryImage'])) {
                            $tCatImagesArr = json_decode($MasterCategoryArr[$View['eServiceType']]['vCategoryImage'], true);
                            if(!empty($tCatImagesArr['vCategoryImage_' . $lang]) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCatImagesArr['vCategoryImage_' . $lang])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCatImagesArr['vCategoryImage_' . $lang]);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "Yes";

                                $vImageService = $tconfig["tsite_upload_app_home_screen_images"] . $tCatImagesArr['vCategoryImage_' . $lang];
                                $ServiceImgArr['vImage'] = $vImageService;
                            }
                        }
                    }

                    $mServiceCategoryArr['imagesArr'][] = $ServiceImgArr;

                    if(($View['eServiceType'] == "VideoConsult" || $View['eServiceType'] == "Bidding") && $isEnableVideoConsultingService && $isEnableBiddingServices) {

                        $vImageService = "";
                        if (!empty($MasterCategoryArr['Bidding']['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['Bidding']['vIconImage1'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $MasterCategoryArr['Bidding']['vIconImage1']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "Yes";

                            $vImageService = $tconfig["tsite_upload_app_home_screen_images"] . $MasterCategoryArr['Bidding']['vIconImage1'];
                        }

                        $ServiceImgArr = array(
                            'vCategoryName' => '',
                            'vCategoryTitle' => $languageLabelsArr['LBL_SERVICE_BID_CATEGORY_TITLE'],
                            'vCategoryDesc' => '',
                            'vTextColor' => $MasterCategoryArr['Bidding']['vTextColor'],
                            'vBgColor' => $MasterCategoryArr['Bidding']['vBgColor'],
                            'isClickable' => 'Yes',
                            'vImage' => $vImageService,
                            'biddingSection' => 'Yes',
                            'servicesArr' => $BIDDING_OBJ->getBiddingMaster('webservice', '', '', '', $lang)
                        );

                        $mServiceCategoryArr['imagesArr'][] = $ServiceImgArr;

                    }
                } 
            }
            elseif ($View['eViewType'] == "GridView") {
                $tGridServicesArr = explode(",", $View['tGridServices']);
                $GridServicesArr = array();

                foreach ($MasterCategoryArr as $mkey => $mValue) {
                    if (in_array($mValue['eType'], $tGridServicesArr)) {
                        $tGridServiceKey = array_search($mValue['eType'], $tGridServicesArr);

                        $ServiceArr = array();

                        if ($mValue['eType'] == "Ride") {
                            $ServiceArr['vCategoryName'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategoryTitle'] = $languageLabelsArr['LBL_TAXI_CATEGORY_TITLE'];
                        } elseif ($mValue['eType'] == "Deliver") {
                            $ServiceArr['vCategoryName'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategory'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategoryTitle'] = $languageLabelsArr['LBL_DELIVERY_CATEGORY_TITLE'];
                        } elseif ($mValue['eType'] == "DeliverAll") {
                            $ServiceArr['vCategoryName'] = $mValue['vCategoryName'];
                            $ServiceArr['vCategoryTitle'] = $languageLabelsArr['LBL_DELIVERALL_CATEGORY_TITLE'];
                        }
                        $ServiceArr['eType'] = $mValue['eType'];
                        $ServiceArr['vImage'] = "";
                        if (!empty($mValue['vIconImage1']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $mValue['vIconImage1'])) {
                            $ServiceArr['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . $mValue['vIconImage1'];
                        }
                        $ServiceArr['vTextColor'] = $mValue['vTextColor'];
                        $ServiceArr['vBgColor'] = $mValue['vBgColor'];
                        $ServiceArr['iDisplayOrder'] = $tGridServiceKey;

                        if ($mValue['eType'] == "VideoConsult") {
                            $ServiceArr['VideoConsultSection'] = 'Yes';
                        } elseif ($mValue['eType'] == "Bidding") {
                            $ServiceArr['biddingSection'] = 'Yes';
                        }

                        $ServiceArr['SubCategories'] = array();
                        foreach ($DatanewArr as $skey => $SubCategories) {

                            $DatanewArr[$skey]['eShowType'] = "Icon";
                            $DatanewArr[$skey]['isVideoConsultEnable'] = "No";

                            if ($mValue['eType'] == "Ride" && $SubCategories['eForMedicalService'] == "No" && (in_array($SubCategories['eCatType'], ['Ride', 'MotoRide', 'Rental', 'MotoRental', 'RidePool']) || ($isAirFlightModuleAvailable && $SubCategories['eCatType'] == 'Fly'))) {
                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                $ServiceArr['SubCategories'][] = $DatanewArr[$skey];
                            } elseif ($mValue['eType'] == "Deliver" && ($isDeliveryFeatureAvailable && in_array($SubCategories['eCatType'], ['Delivery', 'MotoDelivery', 'MultipleDelivery', 'MoreDelivery']))) {

                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                $ServiceArr['eCatType'] = $DatanewArr[$skey]['eCatType'];
                                $ServiceArr['iVehicleCategoryId'] = $DatanewArr[$skey]['iVehicleCategoryId'];
                                unset($ServiceArr['SubCategories']);
                            } elseif ($mValue['eType'] == "DeliverAll" && ($isDeliverAllFeatureAvailable && in_array($SubCategories['eCatType'], ['DeliverAll']) && $SubCategories['iServiceId'] > 0)) {
                                $DatanewArr[$skey]['eCatViewType'] = "List";

                                $isAddDataDeliverAll = "Yes";
                                if($isEnableMedicalServices && in_array($SubCategories['iServiceId'], [5, 11])) {
                                    $isAddDataDeliverAll = "No";
                                }

                                if($isAddDataDeliverAll == "Yes") {
                                    $ServiceArr['SubCategories'][] = $DatanewArr[$skey];    
                                }
                            } 
                        }

                        $GridServicesArr[] = $ServiceArr;
                    }
                }

                $sort_data = array_column($GridServicesArr, 'iDisplayOrder');
                array_multisort($sort_data, SORT_ASC, $GridServicesArr);

                $mServiceCategoryArr['servicesArr'] = $GridServicesArr;
            }
            elseif ($View['eViewType'] == "ServiceBannerView") {
                if ($View['eServiceType'] == "MedicalServices" && $isEnableMedicalServices) {

                    $mServiceCategoryArr['eViewType'] = "TitleView";
                    $mServiceCategoryArr['vTitle'] = $View['vTitle'];

                    $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                    $tServiceDetails = json_decode($View['tServiceDetails'], true);

                    $languageLabelsArrMS = $languageLabelsArr;
                    $medicalServiceSectionArr = getServiceCategoriesMedicalServices($medicalServiceArr, $lang, 'MoreSubCategories');
                    $tCategoryDetails = json_decode($MasterCategoryArr['MedicalServices']['tCategoryDetails'], true);

                    $MSCount = 2;
                    if (!isset($medicalServiceSectionArr['BookService']) || !isset($medicalServiceSectionArr['VideoConsult'])) {
                        $MSCount = 1;
                    }

                    if (isset($medicalServiceSectionArr['BookService']) || isset($medicalServiceSectionArr['VideoConsult'])) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];                        
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = $MSCount;
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                        $mServiceCategoryArr['imagesArr'] = array();

                        if (isset($medicalServiceSectionArr['BookService'])) {
                            $vImageBookService = "";
                            if (!empty($tCategoryDetails['BookService']['vImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['BookService']['vImage'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['BookService']['vImage']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "No";

                                $vImageBookService = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['BookService']['vImage'];
                            }

                            $BookServiceArr = array();
                            if(count($medicalServiceSectionArr['BookService']['Services']) > 3) {
                                $MoreBookServicesArr = array(
                                    'vCategory' => $languageLabelsArr['LBL_MORE'],
                                    'vCategoryTitle' => $medicalServiceSectionArr['BookService']['vTitle'],
                                    'vListLogo' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'vImage' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'moreSection' => "Yes",
                                    'moreCategories' => $medicalServiceSectionArr['BookService']['Services']
                                );
                            }

                            foreach ($medicalServiceSectionArr['BookService']['Services'] as $BookServiceVal) {
                                if(count($BookServiceArr) <= 2) {
                                    if(isset($tServiceDetails['BookService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']])) {
                                        $BookServiceVal['iDisplayOrderHome'] = $tServiceDetails['BookService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['iDisplayOrder'];
                                        $BookServiceVal['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceDetails['BookService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['vImage'];
                                        $BookServiceArr[] = $BookServiceVal;
                                    }    
                                }
                            }

                            $sort_data = array_column($BookServiceArr, 'iDisplayOrderHome');
                            array_multisort($sort_data, SORT_ASC, $BookServiceArr);
                            $BookServiceArr[] = $MoreBookServicesArr;

                            $BookServiceImgArr = array(
                                'vCategoryName' => $medicalServiceSectionArr['BookService']['vTitle'],
                                'vCategoryTitle' => $medicalServiceSectionArr['BookService']['vTitle'],
                                'vCategoryDesc' => $medicalServiceSectionArr['BookService']['vDescription'],
                                'vTextColor' => $tCategoryDetails['BookService']['vTextColor'],
                                'vBgColor' => $tCategoryDetails['BookService']['vBgColor'],
                                'vImage' => $vImageBookService,
                                'MedicalServiceSection' => 'Yes',
                                'servicesArr' => $BookServiceArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $BookServiceImgArr;
                        }

                        if (isset($medicalServiceSectionArr['VideoConsult'])) {
                            $vImageVideoConsult = "";
                            if (!empty($tCategoryDetails['VideoConsult']['vImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['VideoConsult']['vImage'])) {
                                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['VideoConsult']['vImage']);
                                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                                $mServiceCategoryArr['isClickable'] = "No";

                                $vImageVideoConsult = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['VideoConsult']['vImage'];
                            }

                            $VideoConsultArr = array();
                            if(count($medicalServiceSectionArr['VideoConsult']['Services']) > 3) {
                                $MoreVideoConsultArr = array(
                                    'vCategory' => $languageLabelsArr['LBL_MORE'],
                                    'vCategoryTitle' => $medicalServiceSectionArr['VideoConsult']['vTitle'],
                                    'vListLogo' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'vImage' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                    'moreSection' => "Yes",
                                    'moreCategories' => $medicalServiceSectionArr['VideoConsult']['Services']
                                );                                    
                            }

                            foreach ($medicalServiceSectionArr['VideoConsult']['Services'] as $BookServiceVal) {
                                if(count($VideoConsultArr) <= 2) {
                                    if(isset($tServiceDetails['VideoConsult']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']])) {
                                        $BookServiceVal['iDisplayOrderHome'] = $tServiceDetails['VideoConsult']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['iDisplayOrder'];
                                        $BookServiceVal['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceDetails['VideoConsult']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['vImage'];
                                        $VideoConsultArr[] = $BookServiceVal;
                                    }    
                                }
                            }

                            foreach ($VideoConsultArr as $key => $value) {
                                $sort_data[$key] = $value['iDisplayOrderHome'];
                            }
                            array_multisort($sort_data, SORT_ASC, $VideoConsultArr);
                            $VideoConsultArr[] = $MoreVideoConsultArr;

                            $VideoConsultImgArr = array(
                                'vCategoryName' => $medicalServiceSectionArr['VideoConsult']['vTitle'],
                                'vCategoryTitle' => $medicalServiceSectionArr['VideoConsult']['vTitle'],
                                'vCategoryDesc' => $medicalServiceSectionArr['VideoConsult']['vDescription'],
                                'vTextColor' => $tCategoryDetails['VideoConsult']['vTextColor'],
                                'vBgColor' => $tCategoryDetails['VideoConsult']['vBgColor'],
                                'vImage' => $vImageVideoConsult,
                                'MedicalServiceSection' => 'Yes',
                                'servicesArr' => $VideoConsultArr
                            );
                            $mServiceCategoryArr['imagesArr'][] = $VideoConsultImgArr;
                        }

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }

                    if (isset($medicalServiceSectionArr['MoreService'])) {
                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['isScroll'] = "No";
                        $mServiceCategoryArr['displayCount'] = "1";
                        $mServiceCategoryArr['isFullView'] = "No";
                        $mServiceCategoryArr['AddTopPadding'] = "Yes";
                        $mServiceCategoryArr['AddBottomPadding'] = "Yes";
                        $mServiceCategoryArr['imagesArr'] = array();

                        $vImageMoreService = "";
                        if (!empty($tCategoryDetails['MoreService']['vImage']) && file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['MoreService']['vImage'])) {
                            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['MoreService']['vImage']);
                            $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                            $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                            $mServiceCategoryArr['isClickable'] = "No";

                            $vImageMoreService = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['MoreService']['vImage'];
                        }

                        $MoreServiceArr = array();
                        if(count($medicalServiceSectionArr['MoreService']['Services']) > 3) {
                            $mMoreServiceArr = array(
                                'vCategory' => $languageLabelsArr['LBL_MORE'],
                                'vCategoryTitle' => $medicalServiceSectionArr['MoreService']['vTitle'],
                                'vListLogo' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                'vImage' => $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/ic_more_medical_service.png',
                                'moreSection' => "Yes",
                                'moreCategories' => $medicalServiceSectionArr['MoreService']['Services']
                            );
                        }

                        foreach ($medicalServiceSectionArr['MoreService']['Services'] as $BookServiceVal) {
                            if(count($MoreServiceArr) <= 3) {
                                if(isset($tServiceDetails['MoreService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']])) {
                                    $BookServiceVal['iDisplayOrderHome'] = $tServiceDetails['MoreService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['iDisplayOrder'];
                                    $BookServiceVal['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceDetails['MoreService']['iVehicleCategoryId_' . $BookServiceVal['iVehicleCategoryId']]['vImage'];
                                    $MoreServiceArr[] = $BookServiceVal;
                                }    
                            }
                        }

                        foreach ($MoreServiceArr as $key => $value) {
                            $sort_data[$key] = $value['iDisplayOrderHome'];
                        }
                        array_multisort($sort_data, SORT_ASC, $MoreServiceArr);
                        // $MoreServiceArr[] = $mMoreServiceArr;

                        $MoreServiceImgArr = array(
                            'vCategoryName' => $medicalServiceSectionArr['MoreService']['vTitle'],
                            'vCategoryTitle' => $medicalServiceSectionArr['MoreService']['vTitle'],
                            'vCategoryDesc' => $medicalServiceSectionArr['MoreService']['vDescription'],
                            'vTextColor' => $tCategoryDetails['MoreService']['vTextColor'],
                            'vBgColor' => $tCategoryDetails['MoreService']['vBgColor'],
                            'vImage' => $vImageMoreService,
                            'MedicalServiceSection' => 'Yes',
                            'servicesArr' => $MoreServiceArr
                        );
                        $mServiceCategoryArr['imagesArr'][] = $MoreServiceImgArr;

                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }

                    continue;
                }
            }
            elseif ($View['eViewType'] == "ServiceListView") {
                if($View['eServiceType'] == "NearBy" && $MODULES_OBJ->isEnableNearByService()) {
                    $tServiceDetails = json_decode($View['tServiceDetails'], true);

                    $NearbyArr = $NEARBY_OBJ->getNearByCategory('webservice', '', '', '', $lang);
                    $NearbyArrNew = $NearbyArr;

                    if (count($NearbyArr) > 4) {
                        $arrToInsert_arr['iCategoryId'] = '';
                        $arrToInsert_arr['vTitle'] = $languageLabelsArr['LBL_MORE'];
                        $arrToInsert_arr['vCategory'] = $languageLabelsArr['LBL_MORE'];
                        $arrToInsert_arr['vTextColor'] = "#000000";
                        // $arrToInsert_arr['vBgColor'] = "#ffffff";
                        $arrToInsert_arr['vBgColor'] = getColorFromImage($tconfig["tpanel_path"] . "webimages/icons/DefaultImg/ic_more_near_by.png");
                        $arrToInsert_arr['vImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_near_by.png";
                        $arrToInsert_arr['vListLogo'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_near_by.png";
                        $arrToInsert_arr['eCatType'] = 'NearBy';
                        $arrToInsert_arr['vCategoryTitle'] = $languageLabelsArr['LBL_NEAR_BY_SERVICE'];
                        $arrToInsert_arr['moreSection'] = "Yes";
                        $arrToInsert_arr['moreCategories'] = $NearbyArr;

                        $NearbyArrNew = array();
                        $nCount = 0;
                        foreach($NearbyArr as $nArr) {
                            if($nCount < 3) {
                                if(isset($tServiceDetails['iCategoryId_' . $nArr['iCategoryId']])) {
                                    $tServiceData = $tServiceDetails['iCategoryId_' . $nArr['iCategoryId']];
                                    $tServiceImg = $tServiceData['vImage'];
                                    $iDispOrderService = $tServiceData['iDisplayOrder'];

                                    if($tServiceData['eStatus'] == "Active") {
                                        $nArr['iDispOrderService'] = $iDispOrderService;
                                        if(!empty($tServiceImg)) {
                                            $nArr['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceImg;
                                        }
                                        $nArr['vBgColor'] = getColorFromImage(str_replace($tconfig['tsite_url'], $tconfig['tpanel_path'], $nArr['vImage']));
                                        $NearbyArrNew[] = $nArr;
                                        $nCount++;
                                    }
                                }
                            }
                        }

                        $sort_data = array_column($NearbyArrNew, 'iDispOrderService');
                        array_multisort($sort_data, SORT_ASC, $NearbyArrNew);

                        $NearbyArrNew[] = $arrToInsert_arr;
                    }
                    
                    if (count($NearbyArrNew) > 0) {
                        $mServiceCategoryArr['eViewType'] = "TitleView";
                        $mServiceCategoryArr['vTitle'] = $View['vTitle'];
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['NearbySection'] = 'Yes';
                        $mServiceCategoryArr['servicesArr'] = $NearbyArrNew;
                    }
                } elseif ($View['eServiceType'] == "UberX" && $isUberXFeatureAvailable) {
                    $tServiceDetails = json_decode($View['tServiceDetails'], true);

                    $ServiceArr = array();
                    $ServiceCount = 0;
                    $ServiceCountAdd = 3;
                    if(count($DatanewArr) > 4) {
                        $ServiceCountAdd = 2;
                    }
                    foreach ($DatanewArr as $skey => $SubCategories) {
                        if($ServiceCount <= $ServiceCountAdd) {
                            $DatanewArr[$skey]['eShowType'] = "Icon";
                            $DatanewArr[$skey]['isVideoConsultEnable'] = "No";
                            if (in_array($SubCategories['eCatType'], ['ServiceProvider']) && isset($tServiceDetails['iVehicleCategoryId_' . $SubCategories['iVehicleCategoryId']])) {

                                $tServiceData = $tServiceDetails['iVehicleCategoryId_' . $SubCategories['iVehicleCategoryId']];
                                if($tServiceData['eStatus'] == "Active") {
                                    $tServiceImg = $tServiceData['vImage'];
                                    $iDispOrderService = $tServiceData['iDisplayOrder'];

                                    $DataSubCat = array();
                                    if (isset($vehicleCatArr[$SubCategories['iVehicleCategoryId']])) {
                                        $DataSubCat = $vehicleCatArr[$SubCategories['iVehicleCategoryId']];
                                    }
                                    if (count($DataSubCat) > 0) {
                                        for ($sCat = 0; $sCat < count($DataSubCat); $sCat++) {
                                            $DataSubCat1 = array();
                                            if (isset($vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']])) {
                                                $DataSubCat1 = $vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']];
                                            }

                                            $isAddDataUberX = "Yes";
                                            if($isEnableMedicalServices && in_array($SubCategories['iVehicleCategoryId'], [3,22,26,158])) {
                                                $isAddDataUberX = "No";
                                            }
                                            if (count($DataSubCat1) > 0 && $isAddDataUberX == "Yes") {
                                                $DatanewArr[$skey]['eCatViewType'] = "List";
                                                $DataSubCatArr = $DatanewArr[$skey];
                                                $DataSubCatArr['isVideoConsultEnable'] = "No";
                                                $DataSubCatArr['vTitle'] = $DatanewArr[$skey]['vCategory'];
                                                $DataSubCatArr['vImage'] = $DatanewArr[$skey]['vListLogo'];
                                                if(!empty($tServiceImg)) {
                                                    $DataSubCatArr['vImage'] = $tconfig["tsite_upload_app_home_screen_images"] . 'AppHomeScreen/' . $tServiceImg;
                                                }
                                                $DataSubCatArr['iDispOrderService'] = $iDispOrderService;
                                                $DataSubCatArr['vTextColor'] = "#000000";
                                                $DataSubCatArr['vBgColor'] = getColorFromImage(str_replace($tconfig['tsite_url'], $tconfig['tpanel_path'], $DataSubCatArr['vImage']));
                                                $ServiceArr[] = $DataSubCatArr;
                                                $ServiceCount++;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if($ServiceCountAdd == 2) {
                        foreach ($ServiceArr as $key => $value) {
                            $sort_data[$key] = $value['iDispOrderService'];
                        }
                        array_multisort($sort_data, SORT_ASC, $ServiceArr);

                        $ufxArr = array();
                        foreach ($DatanewArr as $skey => $SubCategories) {
                            if (in_array($SubCategories['eCatType'], ['ServiceProvider'])) {
                                $DataSubCat = array();
                                if (isset($vehicleCatArr[$SubCategories['iVehicleCategoryId']])) {
                                    $DataSubCat = $vehicleCatArr[$SubCategories['iVehicleCategoryId']];
                                }
                                if (count($DataSubCat) > 0) {
                                    for ($sCat = 0; $sCat < count($DataSubCat); $sCat++) {
                                        $DataSubCat1 = array();
                                        if (isset($vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']])) {
                                            $DataSubCat1 = $vehicleTypeArr[$DataSubCat[$sCat]['iVehicleCategoryId']];
                                        }

                                        $isAddDataUberX = "Yes";
                                        if($isEnableMedicalServices && in_array($SubCategories['iVehicleCategoryId'], [3,22,26,158])) {
                                            $isAddDataUberX = "No";
                                        }
                                        if (count($DataSubCat1) > 0 && $isAddDataUberX == "Yes") {
                                            $DatanewArr[$skey]['eCatViewType'] = "List";
                                            $DataSubCatArr = $DatanewArr[$skey];
                                            $DataSubCatArr['isVideoConsultEnable'] = "No";
                                            $ufxArr[] = $DataSubCatArr;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        $ServiceArrMore = array();
                        $ServiceArrMore['iCategoryId'] = '';
                        $ServiceArrMore['vTitle'] = $languageLabelsArr['LBL_MORE_ONDEMAND_SERVICES'];
                        $ServiceArrMore['vCategory'] = $languageLabelsArr['LBL_MORE_ONDEMAND_SERVICES'];
                        $ServiceArrMore['vTextColor'] = "#000000";
                        $ServiceArrMore['vBgColor'] = getColorFromImage($tconfig["tpanel_path"] . "webimages/icons/DefaultImg/ic_more_other_services.png");
                        $ServiceArrMore['vImage'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_other_services.png";
                        $ServiceArrMore['vListLogo'] = $tconfig["tsite_url"] . "webimages/icons/DefaultImg/ic_more_other_services.png";
                        $ServiceArrMore['vCategoryTitle'] = $languageLabelsArr['LBL_SERVICES_CATEGORY_TITLE'];
                        $ServiceArrMore['moreSection'] = "Yes";
                        $ServiceArrMore['moreCategories'] = $ufxArr;
                        $ServiceArr[] = $ServiceArrMore;
                        
                    }

                    if (count($ServiceArr) > 0) {
                        $mServiceCategoryArr['eViewType'] = "TitleView";
                        $mServiceCategoryArr['vTitle'] = $View['vTitle'];
                        $mServiceCategoryArr['vSubtitle'] = $View['vSubtitle'];
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                        $mServiceCategoryArr = array();
                        $mServiceCategoryArr['eViewType'] = $View['eViewType'];
                        $mServiceCategoryArr['eServiceType'] = $View['eServiceType'];
                        $mServiceCategoryArr['servicesArr'] = $ServiceArr;
                    }
                }
            }

            if($View['eServiceType'] == "Bidding" && $isEnableVideoConsultingService && $isEnableBiddingServices) {
                continue;
            } else {
                if(in_array($View['eViewType'], ['IntroView', 'GridView']) || (in_array($View['eViewType'], ['BannerView', 'ServiceBannerView', 'ServiceListView']) && isset($mServiceCategoryArr['eServiceType']))) {


                    $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;

                    /*if( isset($mServiceCategoryArr['imagesArr']) && !empty($mServiceCategoryArr['imagesArr']) && !empty($mServiceCategoryArr['imagesArr'][0]) ) {
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }else if(isset($mServiceCategoryArr['vTitle']) && !empty($mServiceCategoryArr['vTitle'])){
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }else if(isset($mServiceCategoryArr['servicesArr']) && !empty($mServiceCategoryArr['servicesArr']) && !empty($mServiceCategoryArr['servicesArr'][0]) ) {
                        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
                    }*/
                }
            }
        }

        

        $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
    } else {
        $returnArr['Action'] = "0";
        $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
    }

    setDataResponse($returnArr);
}

if ($type == "getAllServiceCategories") {
    $GeneralMemberId = isset($_REQUEST['GeneralMemberId']) ? $_REQUEST['GeneralMemberId'] : '';
    $vGeneralLang = isset($_REQUEST["vGeneralLang"]) ? $_REQUEST["vGeneralLang"] : '';

    $lang = $vGeneralLang;

    $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");

    $vehicle_category_table = getVehicleCategoryTblName();
    
    $vehicle_categories_arr = $obj->MySQLSelect("SELECT iVehicleCategoryId, vCategory_$lang as vCategory, eCatType, vListLogo3, vLogo2, iParentId, eDeliveryType, iServiceId, iDisplayOrder FROM $vehicle_category_table WHERE ((iParentId = '0' AND eCatType != 'MoreDelivery') OR iParentId = '178') AND eCatType NOT IN ('ServiceProvider', 'Donation', 'Fly') AND eStatus = 'Active' ORDER BY iDisplayOrder ");

    $SERVICES_SCREEN_DATA = $SERVICES_ARR = array();
    foreach ($vehicle_categories_arr as $vehicle_category) {
        if(in_array($vehicle_category['eCatType'], ['Ride', 'Rental', 'RidePool', 'RideSchedule', 'CorporateRide', 'RideSomeoneElse'])) {
            $SERVICES_ARR['1_TAXI_SERVICES'][] = $vehicle_category;

        } elseif (in_array($vehicle_category['eCatType'], ['MotoRide', 'MotoRental'])) {
            $SERVICES_ARR['2_MOTO_SERVICES'][] = $vehicle_category;

        } elseif (in_array($vehicle_category['eCatType'], ['Delivery', 'MultipleDelivery'])) {
            $SERVICES_ARR['3_DELIVERY_SERVICES'][] = $vehicle_category;

        } elseif (in_array($vehicle_category['eCatType'], ['DeliverAll'])) {
            $SERVICES_ARR['4_STORE_DELIVERY_SERVICES'][] = $vehicle_category;
        }
    }

    ksort($SERVICES_ARR);

    foreach ($SERVICES_ARR as $sKey => $SERVICES) {
        if($sKey == "1_TAXI_SERVICES") {
            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = 'TitleView';
            $mVehicleCategoryArr['vTitle'] = $languageLabelsArr['LBL_TEXI_ADMIN'];
            $mVehicleCategoryArr['AddTopPadding'] = "Yes";

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;

            $TaxiServicesMain = array_slice($SERVICES, 0, 2);
            $TaxiServicesOther = array_slice($SERVICES, 2);
            
            $TaxiCount = 2;
            if(count($TaxiServicesMain) == 1) {
                $TaxiCount = 1;
            }

            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = "BannerView";
            $mVehicleCategoryArr['isScroll'] = "No";
            $mVehicleCategoryArr['displayCount'] = $TaxiCount;
            $mVehicleCategoryArr['isFullView'] = "No";
            $mVehicleCategoryArr['isOnlyImage'] = "No";
            $mVehicleCategoryArr['AddTopPadding'] = "Yes";
            $mVehicleCategoryArr['AddBottomPadding'] = "No";
            $mVehicleCategoryArr['DisplaySize'] = "Big";
            $mVehicleCategoryArr['imagesArr'] = array();

            foreach ($TaxiServicesMain as $MainService) {
                $ServiceImgArr = array(
                    'vCategoryName' => $MainService['vCategory'],
                    'vCategoryTitle' => $MainService['vCategory'],
                    'vCategory' => $MainService['vCategory'],
                    'vTextColor' => '#1C1C1C',
                    'vBgColor' => '#EFEFEF',
                    'isClickable' => 'Yes',                    
                    'vImage' => '',
                    'iServiceId' => $MainService['iServiceId'],
                    'iParentId' => $MainService['iParentId'],
                    'eDeliveryType' => $MainService['eDeliveryType'],
                    'iVehicleCategoryId' => $MainService['iVehicleCategoryId']
                );
                
                $ServiceImgArr['eCatType'] = $MainService['eCatType'];
                if($MainService['eCatType'] == "RideSchedule") {
                    $ServiceImgArr['eCatType'] = "RideReserve";
                } elseif ($MainService['eCatType'] == "CorporateRide" || $MainService['eCatType'] == "RideSomeoneElse") {
                    $ServiceImgArr['eCatType'] = "Ride";
                }

                if(!empty($MainService['vListLogo3'])) {
                    $ServiceImgArr['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $MainService['iVehicleCategoryId'] . '/' . $MainService['vListLogo3'];

                    $imagedata = getimagesize($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $MainService['iVehicleCategoryId'] . '/' . $MainService['vListLogo3']);
                    $ServiceImgArr['vImageWidth'] = strval($imagedata[0]);
                    $ServiceImgArr['vImageHeight'] = strval($imagedata[1]);
                }

                $mVehicleCategoryArr['imagesArr'][] = $ServiceImgArr;               
            }

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;      

            if(count($TaxiServicesOther) > 0) {
                $TaxiServicesOtherArr = array_chunk($TaxiServicesOther, 2);

                foreach ($TaxiServicesOtherArr as $OtherServices) {
                    $TaxiCount = 2;
                    if(count($OtherServices) == 1) {
                        $TaxiCount = 1;
                    }

                    $mVehicleCategoryArr = array();
                    $mVehicleCategoryArr['eViewType'] = "BannerView";
                    $mVehicleCategoryArr['isScroll'] = "No";
                    $mVehicleCategoryArr['displayCount'] = $TaxiCount;
                    $mVehicleCategoryArr['isFullView'] = "No";
                    $mVehicleCategoryArr['isOnlyImage'] = "No";
                    $mVehicleCategoryArr['AddTopPadding'] = "Yes";
                    $mVehicleCategoryArr['AddBottomPadding'] = "No";
                    $mVehicleCategoryArr['DisplaySize'] = "Small";
                    $mVehicleCategoryArr['imagesArr'] = array();

                    foreach ($OtherServices as $OtherService) {
                        $ServiceImgArr = array(
                            'vCategoryName' => $OtherService['vCategory'],
                            'vCategoryTitle' => $OtherService['vCategory'],
                            'vCategory' => $OtherService['vCategory'],
                            'vTextColor' => '#1C1C1C',
                            'vBgColor' => '#EFEFEF',
                            'isClickable' => 'Yes',                    
                            'vImage' => '',
                            'iServiceId' => $OtherService['iServiceId'],
                            'iParentId' => $OtherService['iParentId'],
                            'eDeliveryType' => $OtherService['eDeliveryType'],
                            'iVehicleCategoryId' => $OtherService['iVehicleCategoryId']
                        );

                        $ServiceImgArr['eCatType'] = $OtherService['eCatType'];
                        if($OtherService['eCatType'] == "RideSchedule") {
                            $ServiceImgArr['eCatType'] = "RideReserve";
                        } elseif ($OtherService['eCatType'] == "CorporateRide" || $OtherService['eCatType'] == "RideSomeoneElse") {
                            $ServiceImgArr['eCatType'] = "Ride";
                        }

                        if(!empty($OtherService['vListLogo3'])) {
                            $ServiceImgArr['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $OtherService['iVehicleCategoryId'] . '/' . $OtherService['vListLogo3'];

                            $imagedata = getimagesize($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $OtherService['iVehicleCategoryId'] . '/' . $OtherService['vListLogo3']);
                            $ServiceImgArr['vImageWidth'] = strval($imagedata[0]);
                            $ServiceImgArr['vImageHeight'] = strval($imagedata[1]);
                        }

                        $mVehicleCategoryArr['imagesArr'][] = $ServiceImgArr;               
                    }

                    $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;
                }
            }
        }
        elseif($sKey == "2_MOTO_SERVICES") {
            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = 'TitleView';
            $mVehicleCategoryArr['vTitle'] = $languageLabelsArr['LBL_FOOTER_LINK_MOTO'];
            $mVehicleCategoryArr['AddTopPadding'] = "No";

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;

            $MotoServicesMain = $SERVICES;
            
            $MotoCount = 2;
            if(count($MotoServicesMain) == 1) {
                $MotoCount = 1;
            }

            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = "BannerView";
            $mVehicleCategoryArr['isScroll'] = "No";
            $mVehicleCategoryArr['displayCount'] = $MotoCount;
            $mVehicleCategoryArr['isFullView'] = "No";
            $mVehicleCategoryArr['isOnlyImage'] = "No";
            $mVehicleCategoryArr['AddTopPadding'] = "Yes";
            $mVehicleCategoryArr['AddBottomPadding'] = "No";
            $mVehicleCategoryArr['DisplaySize'] = "Small";
            $mVehicleCategoryArr['imagesArr'] = array();

            foreach ($MotoServicesMain as $MainService) {
                $ServiceImgArr = array(
                    'vCategoryName' => $MainService['vCategory'],
                    'vCategoryTitle' => $MainService['vCategory'],
                    'vCategory' => $MainService['vCategory'],
                    'vTextColor' => '#1C1C1C',
                    'vBgColor' => '#EFEFEF',
                    'isClickable' => 'Yes',                    
                    'vImage' => '',
                    'eCatType' => $MainService['eCatType'],
                    'iServiceId' => $MainService['iServiceId'],
                    'iParentId' => $MainService['iParentId'],
                    'eDeliveryType' => $MainService['eDeliveryType'],
                    'iVehicleCategoryId' => $MainService['iVehicleCategoryId']
                );

                if(!empty($MainService['vListLogo3'])) {
                    $ServiceImgArr['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $MainService['iVehicleCategoryId'] . '/' . $MainService['vListLogo3'];

                    $imagedata = getimagesize($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $MainService['iVehicleCategoryId'] . '/' . $MainService['vListLogo3']);
                    $ServiceImgArr['vImageWidth'] = strval($imagedata[0]);
                    $ServiceImgArr['vImageHeight'] = strval($imagedata[1]);
                }

                $mVehicleCategoryArr['imagesArr'][] = $ServiceImgArr;               
            }

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr; 

        }
        elseif($sKey == "3_DELIVERY_SERVICES") {

            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = 'TitleView';
            $mVehicleCategoryArr['vTitle'] = $languageLabelsArr['LBL_PARCEL_DELIVERY'];
            $mVehicleCategoryArr['AddTopPadding'] = "No";

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;

            $DeliveryServicesMain = $SERVICES;
            
            $DeliveryCount = 2;
            if(count($DeliveryServicesMain) == 1) {
                $DeliveryCount = 1;
            }

            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = "BannerView";
            $mVehicleCategoryArr['isScroll'] = "No";
            $mVehicleCategoryArr['displayCount'] = $DeliveryCount;
            $mVehicleCategoryArr['isFullView'] = "No";
            $mVehicleCategoryArr['isOnlyImage'] = "No";
            $mVehicleCategoryArr['AddTopPadding'] = "No";
            $mVehicleCategoryArr['AddBottomPadding'] = "No";
            $mVehicleCategoryArr['DisplaySize'] = "Small";
            $mVehicleCategoryArr['imagesArr'] = array();

            foreach ($DeliveryServicesMain as $MainService) {
                $subCatDataArr = $obj->MySQLSelect("SELECT iVehicleCategoryId, iServiceId, iDisplayOrder,vCategory_" . $lang . " as vCategory, eCatType, vLogo2, eDeliveryType FROM " . $vehicle_category_table . " WHERE iParentId = '" . $MainService['iVehicleCategoryId'] . "' AND eStatus='Active' ORDER BY iDisplayOrder");

                $serviceDataArr = array();
                foreach ($subCatDataArr as $subKey => $subCatData) {
                    $serviceDataArr[$subKey]['vCategoryName'] = $subCatData['vCategory'];
                    $serviceDataArr[$subKey]['vCategoryTitle'] = $vData['vCategory'];
                    $serviceDataArr[$subKey]['vCategory'] = $subCatData['vCategory'];
                    $serviceDataArr[$subKey]['eDeliveryType'] = $subCatData['eDeliveryType'];
                    $serviceDataArr[$subKey]['iVehicleCategoryId'] = $subCatData['iVehicleCategoryId'];
                    $serviceDataArr[$subKey]['eCatType'] = $subCatData['eCatType'];
                    $serviceDataArr[$subKey]['vListLogo'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $subCatData['iVehicleCategoryId'] . '/android/' . $subCatData['vLogo2'];
                }

                $ServiceImgArr = array(
                    'vCategoryName' => $MainService['vCategory'],
                    'vCategoryTitle' => $MainService['vCategory'],
                    'vCategory' => $MainService['vCategory'],
                    'vTextColor' => '#1C1C1C',
                    'vBgColor' => '#EFEFEF',
                    'isClickable' => 'Yes',                    
                    'vImage' => '',
                    'eCatType' => $MainService['eCatType'],
                    'iServiceId' => $MainService['iServiceId'],
                    'iParentId' => $MainService['iParentId'],
                    'eDeliveryType' => $MainService['eDeliveryType'],
                    'iVehicleCategoryId' => $MainService['iVehicleCategoryId'],
                    'servicesArr' => $serviceDataArr
                );

                if(!empty($MainService['vLogo2'])) {
                    $ServiceImgArr['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $MainService['iVehicleCategoryId'] . '/android/' . $MainService['vLogo2'];

                    $imagedata = getimagesize($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $MainService['iVehicleCategoryId'] . '/android/' . $MainService['vLogo2']);
                    $ServiceImgArr['vImageWidth'] = strval($imagedata[0]);
                    $ServiceImgArr['vImageHeight'] = strval($imagedata[1]);
                }

                $mVehicleCategoryArr['imagesArr'][] = $ServiceImgArr;               
            }

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr; 
        }
        elseif($sKey == "4_STORE_DELIVERY_SERVICES") {
            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = 'TitleView';
            $mVehicleCategoryArr['vTitle'] = $languageLabelsArr['LBL_STORE_DELIVERY'];
            $mVehicleCategoryArr['AddTopPadding'] = "No";

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;


            $StoreServicesMain = array_slice($SERVICES, 0, 1);
            $StoreServicesOther = array_slice($SERVICES, 1);

            $StoreCount = 2;
            if(count($StoreServicesMain) == 1) {
                $StoreCount = 1;
            }

            $mVehicleCategoryArr = array();
            $mVehicleCategoryArr['eViewType'] = "BannerView";
            $mVehicleCategoryArr['isScroll'] = "No";
            $mVehicleCategoryArr['displayCount'] = $StoreCount;
            $mVehicleCategoryArr['isFullView'] = "No";
            $mVehicleCategoryArr['isOnlyImage'] = "No";
            $mVehicleCategoryArr['AddTopPadding'] = "Yes";
            $mVehicleCategoryArr['AddBottomPadding'] = "No";
            $mVehicleCategoryArr['DisplaySize'] = "Big";
            $mVehicleCategoryArr['imagesArr'] = array();

            foreach ($StoreServicesMain as $MainService) {
                $ServiceImgArr = array(
                    'vCategoryName' => $MainService['vCategory'],
                    'vCategoryTitle' => $MainService['vCategory'],
                    'vCategory' => $MainService['vCategory'],
                    'vTextColor' => '#1C1C1C',
                    'vBgColor' => '#EFEFEF',
                    'isClickable' => 'Yes',
                    'vImage' => '',
                    'eCatType' => $MainService['eCatType'],
                    'iServiceId' => $MainService['iServiceId'],
                    'iParentId' => $MainService['iParentId'],
                    'eDeliveryType' => $MainService['eDeliveryType'],
                    'iVehicleCategoryId' => $MainService['iVehicleCategoryId']
                );

                if(!empty($MainService['vListLogo3'])) {
                    $ServiceImgArr['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $MainService['iVehicleCategoryId'] . '/' . $MainService['vListLogo3'];

                    $imagedata = getimagesize($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $MainService['iVehicleCategoryId'] . '/' . $MainService['vListLogo3']);
                    $ServiceImgArr['vImageWidth'] = strval($imagedata[0]);
                    $ServiceImgArr['vImageHeight'] = strval($imagedata[1]);
                }

                $mVehicleCategoryArr['imagesArr'][] = $ServiceImgArr;
            }

            $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;


            if(count($StoreServicesOther) > 0) {
                $StoreServicesOtherArr = array_chunk($StoreServicesOther, 2);

                foreach ($StoreServicesOtherArr as $OtherServices) {
                    $StoreCount = 2;
                    if(count($OtherServices) == 1) {
                        $StoreCount = 1;
                    }

                    $mVehicleCategoryArr = array();
                    $mVehicleCategoryArr['eViewType'] = "BannerView";
                    $mVehicleCategoryArr['isScroll'] = "No";
                    $mVehicleCategoryArr['displayCount'] = $StoreCount;
                    $mVehicleCategoryArr['isFullView'] = "No";
                    $mVehicleCategoryArr['isOnlyImage'] = "No";
                    $mVehicleCategoryArr['AddTopPadding'] = "Yes";
                    $mVehicleCategoryArr['AddBottomPadding'] = "Yes";
                    $mVehicleCategoryArr['DisplaySize'] = "Small";
                    $mVehicleCategoryArr['imagesArr'] = array();

                    foreach ($OtherServices as $OtherService) {
                        $ServiceImgArr = array(
                            'vCategoryName' => $OtherService['vCategory'],
                            'vCategoryTitle' => $OtherService['vCategory'],
                            'vCategory' => $OtherService['vCategory'],
                            'vTextColor' => '#1C1C1C',
                            'vBgColor' => '#EFEFEF',
                            'isClickable' => 'Yes',
                            'vImage' => '',
                            'eCatType' => $OtherService['eCatType'],
                            'iServiceId' => $OtherService['iServiceId'],
                            'iParentId' => $OtherService['iParentId'],
                            'eDeliveryType' => $OtherService['eDeliveryType'],
                            'iVehicleCategoryId' => $OtherService['iVehicleCategoryId']
                        );

                        if(!empty($OtherService['vListLogo3'])) {
                            $ServiceImgArr['vImage'] = $tconfig['tsite_upload_images_vehicle_category'] . '/' . $OtherService['iVehicleCategoryId'] . '/' . $OtherService['vListLogo3'];

                            $imagedata = getimagesize($tconfig['tsite_upload_images_vehicle_category_path'] . '/' . $OtherService['iVehicleCategoryId'] . '/' . $OtherService['vListLogo3']);
                            $ServiceImgArr['vImageWidth'] = strval($imagedata[0]);
                            $ServiceImgArr['vImageHeight'] = strval($imagedata[1]);
                        }

                        $mVehicleCategoryArr['imagesArr'][] = $ServiceImgArr;
                    }

                    $SERVICES_SCREEN_DATA[] = $mVehicleCategoryArr;
                }
            }
        }
    }

    $returnArr['Action'] = "1";
    $returnArr['SERVICES_SCREEN_DATA'] = $SERVICES_SCREEN_DATA;
    setDataResponse($returnArr);
}

/* Home Screen Layout V3 End */



$obj->MySQLClose();
?>